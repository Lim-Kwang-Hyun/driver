cscope 15 /usr/src/dm-src/driver               0000549212
	@alloc.c

23 
	~<löux/buf„r_hód.h
>

24 
	~<löux/dm´ngöe.h
>

25 
	~<löux/øid/x‹.h
>

26 
	~<löux/øid/pq.h
>

27 
	~<löux/dm-kc›yd.h
>

28 
	~<löux/blkdev.h
>

29 
	~<löux/sched.h
>

30 
	~<löux/dñay.h
>

31 
	~<löux/¸c32.h
>

32 
	~<löux/gÂ.h
>

33 
	~<löux/øndom.h
>

34 
	~"èrgë.h
"

35 
	~"Æloc.h
"

36 
	~"mëad©a.h
"

37 
	~"d´m⁄.h
"

40 
	$mu…i_Æloˇt‹_öô
(
dm§c_su≥r
 *
su≥r
){

41 
i
, 
j
;

43 
i
 = 0;ò< 
NBUF
;i++){

44 
j
 = 0;j < 
MAX_CACHE_DEVS
;j++)

45 
	`•ö_lock_öô
(&
su≥r
->
ma
[
i
].
lock
[
j
]);

47 
su≥r
->
ma
[
i
].
row_cou¡
 = 
	`kmÆloc
((
©omic_t
Ë* 
CHUNK_SZ
, 
GFP_KERNEL
 | 
__GFP_ZERO
);

48 if(
su≥r
->
ma
[
i
].
row_cou¡
==
NULL
){

54 
	}
}

56 
	$mu…i_Æloˇt‹_deöô
(
dm§c_su≥r
 *
su≥r
){

57 
i
;

59 
i
 = 0;ò< 
NBUF
;i++){

60 
	`k‰ì
(
su≥r
->
ma
[
i
].
row_cou¡
);

62 
	}
}

64 
	$gë_num_em±y_chunks
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

65 
mu…i_Æloˇt‹
 *
ma
 = &
su≥r
->ma[
ˇche_ty≥
];

66 
cou¡
 = 0;

67 
i
;

69 
i
 = 0;ò< 
NUM_SSD
;i++){

70 if(
ma
->
£g_em±y_chunk_m≠
[
ˇche_ty≥
][
i
])

71 
cou¡
++;

73  
cou¡
;

74 
	}
}

76 
	$group_ª£rve_em±y_chunk
(
dm§c_su≥r
 *
su≥r
, 
u32
 
group_id
, 
ˇche_ty≥
){

77 
mu…i_Æloˇt‹
 *
ma
 = &
su≥r
->ma[
ˇche_ty≥
];

78 
i
;

79 
ª£rved_chunks
;

80 
group_hódî
 *
group
 = &
su≥r
->
group_hódî_¨øy
[
group_id
];

82 
i
 = 0;ò< 
NUM_SSD
;i++){

83 
ma
->
group_em±y_chunk_m≠
[
ˇche_ty≥
][
i
] = 0;

87 if(
	`is_wrôe_°rùe
(
ˇche_ty≥
Ë&& 
	`USE_ERASURE_CODE
(&
su≥r
->
∑øm
)){

88 
ma
->
group_em±y_chunk_m≠
[
ˇche_ty≥
][
	`gë_∑rôy_ssd
(
su≥r
, 
group_id
)] = 1;

92 if(
su≥r
->
∑øm
.
hŸ_idítifiˇti⁄
){

95 (
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_VERT
 ||

96 
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_HORI
)){

97 
ª£rved_chunks
 = 
NUM_SSD
 - 
	`ˇlc_√ed_num_ssds
(
su≥r
);

98 if(
ª£rved_chunks
==
NUM_DATA_SSD
){

100 
ª£rved_chunks
 = 
NUM_DATA_SSD
-1;

104 
ª£rved_chunks
 = 0;

108 (
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_VERT
 ||

109 
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_HORI
))

111 
ª£rved_chunks
 = 
NUM_SSD
 - 
	`ˇlc_√ed_num_ssds
(
su≥r
);

112 if(
ª£rved_chunks
==
NUM_DATA_SSD
){

114 
ª£rved_chunks
 = 
NUM_DATA_SSD
-1;

117 
ª£rved_chunks
 = 0;

131 if(
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_VERT
 ||

132 
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_HORI
){

133 
	`©omic_£t
(&
group
->
num_u£d_ssd
, 
NUM_SSD
 - 
ª£rved_chunks
);

134 
	`©omic_£t
(&
group
->
skewed_£gmít
, 1);

136 
	`BUG_ON
(1);

137 
	`©omic_£t
(&
group
->
num_u£d_ssd
, 
NUM_SSD
);

138 
	`©omic_£t
(&
group
->
skewed_£gmít
, 1);

141 
i
 = 0;ò< 
ª£rved_chunks
;i++){

142 
u32
 
ssdno
;

143 
	`gë_øndom_byãs
((*)&
ssdno
, (
u32
));

144 
ssdno
 = ssdnÿ% 
NUM_SSD
;

146 if(
ssdno
 =
	`gë_∑rôy_ssd
(
su≥r
, 
group_id
) ||

147 
ma
->
group_em±y_chunk_m≠
[
ˇche_ty≥
][
ssdno
] ){

148 
i
--;

151 
ma
->
group_em±y_chunk_m≠
[
ˇche_ty≥
][
ssdno
] = 1;

155 
	}
}

157 
	$ª£rve_em±y_chunk
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
){

158 
mu…i_Æloˇt‹
 *
ma
 = &
su≥r
->ma[
ˇche_ty≥
];

159 
i
;

160 
ª£rved_chunks
;

162 
i
 = 0;ò< 
NUM_SSD
;i++){

163 
ma
->
£g_em±y_chunk_m≠
[
ˇche_ty≥
][
i
] = 0;

170 if(
	`is_wrôe_°rùe
(
ˇche_ty≥
Ë&& 
	`USE_ERASURE_CODE
(&
su≥r
->
∑øm
)){

171 
ma
->
£g_em±y_chunk_m≠
[
ˇche_ty≥
][
	`gë_∑rôy_ssd
(
su≥r
, 
£g_id
)] = 1;

175 if(
su≥r
->
∑øm
.
hŸ_idítifiˇti⁄
){

177 if(
ˇche_ty≥
 =
WHBUF
 &&

178 (
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_VERT
 ||

179 
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_HORI
)){

180 
	`BUG_ON
(1);

181 
ª£rved_chunks
 = 
NUM_SSD
 - 
	`ˇlc_√ed_num_ssds
(
su≥r
);

183 
ª£rved_chunks
 = 0;

186 if((
ˇche_ty≥
 =
WHBUF
||ˇche_ty≥==
WCBUF
||ˇche_ty≥==
GWBUF
) &&

187 (
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_VERT
 ||

188 
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_HORI
)){

189 
	`BUG_ON
(1);

190 
ª£rved_chunks
 = 
NUM_SSD
 - 
	`ˇlc_√ed_num_ssds
(
su≥r
);

192 
ª£rved_chunks
 = 0;

196 
i
 = 0;ò< 
ª£rved_chunks
;i++){

197 
u32
 
ssdno
;

198 
	`gë_øndom_byãs
((*)&
ssdno
, (
u32
));

199 
ssdno
 = ssdnÿ% 
NUM_SSD
;

201 if(
ssdno
 =
	`gë_∑rôy_ssd
(
su≥r
, 
£g_id
) ||

202 
ma
->
£g_em±y_chunk_m≠
[
ˇche_ty≥
][
ssdno
] ){

203 
i
--;

206 
ma
->
£g_em±y_chunk_m≠
[
ˇche_ty≥
][
ssdno
] = 1;

211 
	}
}

213 
	$ma_ª£t
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
){

214 
mu…i_Æloˇt‹
 *
ma
 = &
su≥r
->ma[
ˇche_ty≥
];

215 
curs‹
;

216 
i
;

217 
chunk_off£t
;

218 
Êags
;

219 
∑rôy_ssd
;

220 
°rùe_size
 = 0;

223 
	`©omic_£t
(&
ma
->
tŸÆ_cou¡
, 0);

225 if(
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_VERT
 ||

226 
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_HORI
){

228 
i
 = 0;ò< 
NUM_SSD
;i++){

229 
ma
->
£g_em±y_chunk_m≠
[
ˇche_ty≥
][
i
] =

230 
ma
->
group_em±y_chunk_m≠
[
ˇche_ty≥
][
i
];

232 
∑rôy_ssd
 = 
	`gë_∑rôy_ssd
(
su≥r
, 
£g_id
/
SEGMENT_GROUP_SIZE
);

234 
	`ª£rve_em±y_chunk
(
su≥r
, 
£g_id
, 
ˇche_ty≥
);

235 
∑rôy_ssd
 = 
	`gë_∑rôy_ssd
(
su≥r
, 
£g_id
);

238 if(
∑rôy_ssd
>=0)

239 
	`©omic_£t
(&
ma
->
cur_dev
, 
∑rôy_ssd
);

241 
	`©omic_£t
(&
ma
->
cur_dev
, 0);

243 
chunk_off£t
 = 0;chunk_off£à< 
CHUNK_SZ
;chunk_offset++)

244 
	`©omic_£t
(&
ma
->
row_cou¡
[
chunk_off£t
], 0);

246 
i
 = 0;ò< 
NUM_SSD
;i++){

247 if(
ma
->
£g_em±y_chunk_m≠
[
ˇche_ty≥
][
i
]){

248 
	`©omic_£t
(&
ma
->
cou¡
[
i
], 
CHUNK_SZ
);

249 
	`©omic_add
(
CHUNK_SZ
, &
ma
->
tŸÆ_cou¡
);

251 
chunk_off£t
 = 0;chunk_off£à< 
CHUNK_SZ
;chunk_offset++)

252 
	`©omic_öc
(&
ma
->
row_cou¡
[
chunk_off£t
]);

257 
°rùe_size
 +
CHUNK_SZ
;

258 
	`•ö_lock_úqßve
(&
ma
->
lock
[
i
], 
Êags
);

259 
curs‹
 = 
i
 * 
CHUNK_SZ
 - 1;

260 
ma
->
curs‹
[
i
] = cursor;

261 
	`©omic_£t
(&
ma
->
cou¡
[
i
], 0);

262 
	`•ö_u∆ock_úqª°‹e
(&
ma
->
lock
[
i
], 
Êags
);

265 if(
	`is_wrôe_°rùe
(
ˇche_ty≥
Ë&& 
	`USE_ERASURE_CODE
(&
su≥r
->
∑øm
)){

266 
°rùe_size
 +
CHUNK_SZ
;

271  
°rùe_size
;

272 
	}
}

274 
u32
 
	$ma_£À˘_dev
(
dm§c_su≥r
 *
su≥r
, 
£˘‹_t
 
£˘‹
, 
ˇche_ty≥
){

275 
debug
 = 0;

276 
mu…i_Æloˇt‹
 *
ma
 = &
su≥r
->ma[
ˇche_ty≥
];

277 
cur_dev
 = 
	`©omic_ªad
(&
ma
->cur_dev);

278 
Æloˇti⁄_pﬁicy
 = 
su≥r
->
∑øm
.
d©a_Æloˇti⁄
;

280 if(
Æloˇti⁄_pﬁicy
==
DATA_ALLOC_HORI
 ||

281 
Æloˇti⁄_pﬁicy
==
DATA_ALLOC_FLEX_HORI
){

283 }if(
Æloˇti⁄_pﬁicy
==
DATA_ALLOC_VERT
 ||

284 
Æloˇti⁄_pﬁicy
==
DATA_ALLOC_FLEX_VERT
){

285 if(
	`©omic_ªad
(&
ma
->
cou¡
[
cur_dev
])<
CHUNK_SZ
)

286  
cur_dev
;

288 
	`BUG_ON
(1);

291 
Resˇn
:;

293 
cur_dev
 = (
	`©omic_ªad
(&
ma
->cur_devË+ 1Ë% 
NUM_SSD
;

294 
	`©omic_£t
(&
ma
->
cur_dev
, cur_dev);

296 
debug
++;

297 
	`BUG_ON
(
debug
>
NUM_SSD
);

299 if(
	`©omic_ªad
(&
ma
->
cou¡
[
cur_dev
])>=
CHUNK_SZ
){

301 
Resˇn
;

304  
cur_dev
;

305 
	}
}

307 
u32
 
	$ma_Æloc
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
u64
 
£g_id
, 
ˇche_ty≥
,

308 
devno
, 
u32
 *
cur_cou¡
){

309 
mu…i_Æloˇt‹
 *
ma
 = &
su≥r
->ma[
ˇche_ty≥
];

310 
Êags
;

311 
u32
 
curs‹
;

312 
u32
 
cou¡
;

314 
	`BUG_ON
(
devno
>=
NUM_SSD
);

316 
	`•ö_lock_úqßve
(&
ma
->
lock
[
devno
], 
Êags
);

317 
curs‹
 = ++(
ma
->curs‹[
devno
]);

319 
	`©omic_öc
(&
ma
->
cou¡
[
devno
]);

320 
	`©omic_öc
(&
ma
->
tŸÆ_cou¡
);

321 
	`BUG_ON
(
	`©omic_ªad
(&
ma
->
cou¡
[
devno
]Ë> 
CHUNK_SZ
);

323 
	`©omic_öc
(&
ma
->
row_cou¡
[
curs‹
 % 
CHUNK_SZ
]);

324 
cou¡
 = 
	`©omic_ªad
(&
ma
->
tŸÆ_cou¡
);

325 
	`•ö_u∆ock_úqª°‹e
(&
ma
->
lock
[
devno
], 
Êags
);

327 if(
cur_cou¡
)

328 *
cur_cou¡
 = 
cou¡
;

330 if(
devno
 !
	`©omic_ªad
(&
ma
->
cur_dev
))

331 
	`©omic_£t
(&
ma
->
cur_dev
, 
devno
);

333 if(
	`©omic_ªad
(&
ma
->
row_cou¡
[
curs‹
 % 
CHUNK_SZ
])> 
NUM_SSD
){

334 
	`¥ötk
("Ñow count ... \n");

336 
	`BUG_ON
(
	`©omic_ªad
(&
ma
->
row_cou¡
[
curs‹
 % 
CHUNK_SZ
])> 
NUM_SSD
);

337 if(
	`©omic_ªad
(&
ma
->
tŸÆ_cou¡
Ë> 
STRIPE_SZ
)

338 
	`¥ötk
("Åotal count .. \n");

340 
	`BUG_ON
(
	`©omic_ªad
(&
ma
->
tŸÆ_cou¡
Ë> 
STRIPE_SZ
);

348  
	`SEG_START_IDX
(
£g
Ë+ 
curs‹
;

349 
	}
}

351 
ölöe
 
u32
 
	$ma_gë_cou¡_≥r_dev
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
devno
){

352  
	`©omic_ªad
(&
su≥r
->
ma
[
ˇche_ty≥
].
cou¡
[
devno
]);

353 
	}
}

355 
ölöe
 
u32
 
	$ma_gë_row_cou¡
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
row
){

356  
	`©omic_ªad
(&
su≥r
->
ma
[
ˇche_ty≥
].
row_cou¡
[
row
]);

357 
	}
}

359 
ölöe
 
u32
 
	$ma_gë_‰ì
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

360 
i
;

361 
u32
 
‰ì_blocks
 = 0;

362 
u32
 
row_cou¡
 = 0;

364 
i
 = 0;ò< 
CHUNK_SZ
-
NUM_SUMMARY
;i++){

365 
row_cou¡
 = 
	`ma_gë_row_cou¡
(
su≥r
, 
ˇche_ty≥
, 
i
);

366 
‰ì_blocks
 +(
NUM_SSD
 - 
row_cou¡
);

368  
‰ì_blocks
;

369 
	}
}

371 
ölöe
 
u32
 
	$ma_gë_cou¡
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

372  
	`©omic_ªad
(&
su≥r
->
ma
[
ˇche_ty≥
].
tŸÆ_cou¡
);

373 
	}
}

375 
ölöe
 
	$ma_£t_cou¡
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
cou¡
){

376 
	`©omic_£t
(&
su≥r
->
ma
[
ˇche_ty≥
].
tŸÆ_cou¡
, 
cou¡
);

377 
	}
}

384 
£˘‹_t
 
	$øid5_ˇlc_£˘‹
(
r5c⁄f
 *
c⁄f
, 
£˘‹_t
 
r_£˘‹
,

385 
¥evious
, *
dd_idx
, *
p_disk
, *
q_disk
)

387 
£˘‹_t
 
°rùe
, 
°rùe2
;

388 
£˘‹_t
 
chunk_numbî
;

389 
chunk_off£t
;

390 
pd_idx
, 
qd_idx
;

391 
ddf_œyout
 = 0;

392 
£˘‹_t
 
√w_£˘‹
;

393 
Æg‹ôhm
 = 
¥evious
 ? 
c⁄f
->
¥ev_Ægo


394 : 
c⁄f
->
Æg‹ôhm
;

395 
£˘‹s_≥r_chunk
 = 
¥evious
 ? 
c⁄f
->
¥ev_chunk_£˘‹s


396 : 
c⁄f
->
chunk_£˘‹s
;

397 
øid_disks
 = 
¥evious
 ? 
c⁄f
->
¥evious_øid_disks


398 : 
c⁄f
->
øid_disks
;

399 
d©a_disks
 = 
øid_disks
 - 
c⁄f
->
max_degøded
;

406 
chunk_off£t
 = 
	`£˘‹_div
(
r_£˘‹
, 
£˘‹s_≥r_chunk
);

407 
chunk_numbî
 = 
r_£˘‹
;

412 
°rùe
 = 
chunk_numbî
;

413 *
dd_idx
 = 
	`£˘‹_div
(
°rùe
, 
d©a_disks
);

414 
°rùe2
 = 
°rùe
;

418 
pd_idx
 = 
qd_idx
 = -1;

419 
c⁄f
->
Àvñ
) {

421 
pd_idx
 = 
d©a_disks
;

424 
Æg‹ôhm
) {

425 
ALGORITHM_LEFT_ASYMMETRIC
:

426 
pd_idx
 = 
d©a_disks
 - 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

427 i‡(*
dd_idx
 >
pd_idx
)

428 (*
dd_idx
)++;

430 
ALGORITHM_RIGHT_ASYMMETRIC
:

431 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

432 i‡(*
dd_idx
 >
pd_idx
)

433 (*
dd_idx
)++;

435 
ALGORITHM_LEFT_SYMMETRIC
:

436 
pd_idx
 = 
d©a_disks
 - 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

437 *
dd_idx
 = (
pd_idx
 + 1 + *dd_idxË% 
øid_disks
;

439 
ALGORITHM_RIGHT_SYMMETRIC
:

440 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

441 *
dd_idx
 = (
pd_idx
 + 1 + *dd_idxË% 
øid_disks
;

443 
ALGORITHM_PARITY_0
:

444 
pd_idx
 = 0;

445 (*
dd_idx
)++;

447 
ALGORITHM_PARITY_N
:

448 
pd_idx
 = 
d©a_disks
;

451 
	`BUG
();

456 
Æg‹ôhm
) {

457 
ALGORITHM_LEFT_ASYMMETRIC
:

458 
pd_idx
 = 
øid_disks
 - 1 - 
	`£˘‹_div
(
°rùe2
,Ñaid_disks);

459 
qd_idx
 = 
pd_idx
 + 1;

460 i‡(
pd_idx
 =
øid_disks
-1) {

461 (*
dd_idx
)++;

462 
qd_idx
 = 0;

463 } i‡(*
dd_idx
 >
pd_idx
)

464 (*
dd_idx
) += 2;

466 
ALGORITHM_RIGHT_ASYMMETRIC
:

467 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

468 
qd_idx
 = 
pd_idx
 + 1;

469 i‡(
pd_idx
 =
øid_disks
-1) {

470 (*
dd_idx
)++;

471 
qd_idx
 = 0;

472 } i‡(*
dd_idx
 >
pd_idx
)

473 (*
dd_idx
) += 2;

475 
ALGORITHM_LEFT_SYMMETRIC
:

476 
pd_idx
 = 
øid_disks
 - 1 - 
	`£˘‹_div
(
°rùe2
,Ñaid_disks);

477 
qd_idx
 = (
pd_idx
 + 1Ë% 
øid_disks
;

478 *
dd_idx
 = (
pd_idx
 + 2 + *dd_idxË% 
øid_disks
;

480 
ALGORITHM_RIGHT_SYMMETRIC
:

481 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

482 
qd_idx
 = (
pd_idx
 + 1Ë% 
øid_disks
;

483 *
dd_idx
 = (
pd_idx
 + 2 + *dd_idxË% 
øid_disks
;

486 
ALGORITHM_PARITY_0
:

487 
pd_idx
 = 0;

488 
qd_idx
 = 1;

489 (*
dd_idx
) += 2;

491 
ALGORITHM_PARITY_N
:

492 
pd_idx
 = 
d©a_disks
;

493 
qd_idx
 = 
d©a_disks
 + 1;

496 
ALGORITHM_ROTATING_ZERO_RESTART
:

500 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

501 
qd_idx
 = 
pd_idx
 + 1;

502 i‡(
pd_idx
 =
øid_disks
-1) {

503 (*
dd_idx
)++;

504 
qd_idx
 = 0;

505 } i‡(*
dd_idx
 >
pd_idx
)

506 (*
dd_idx
) += 2;

507 
ddf_œyout
 = 1;

510 
ALGORITHM_ROTATING_N_RESTART
:

515 
°rùe2
 += 1;

516 
pd_idx
 = 
øid_disks
 - 1 - 
	`£˘‹_div
(
°rùe2
,Ñaid_disks);

517 
qd_idx
 = 
pd_idx
 + 1;

518 i‡(
pd_idx
 =
øid_disks
-1) {

519 (*
dd_idx
)++;

520 
qd_idx
 = 0;

521 } i‡(*
dd_idx
 >
pd_idx
)

522 (*
dd_idx
) += 2;

523 
ddf_œyout
 = 1;

526 
ALGORITHM_ROTATING_N_CONTINUE
:

528 
pd_idx
 = 
øid_disks
 - 1 - 
	`£˘‹_div
(
°rùe2
,Ñaid_disks);

529 
qd_idx
 = (
pd_idx
 + 
øid_disks
 - 1) %Ñaid_disks;

530 *
dd_idx
 = (
pd_idx
 + 1 + *dd_idxË% 
øid_disks
;

531 
ddf_œyout
 = 1;

534 
ALGORITHM_LEFT_ASYMMETRIC_6
:

536 
pd_idx
 = 
d©a_disks
 - 
	`£˘‹_div
(
°rùe2
, 
øid_disks
-1);

537 i‡(*
dd_idx
 >
pd_idx
)

538 (*
dd_idx
)++;

539 
qd_idx
 = 
øid_disks
 - 1;

542 
ALGORITHM_RIGHT_ASYMMETRIC_6
:

543 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
-1);

544 i‡(*
dd_idx
 >
pd_idx
)

545 (*
dd_idx
)++;

546 
qd_idx
 = 
øid_disks
 - 1;

549 
ALGORITHM_LEFT_SYMMETRIC_6
:

550 
pd_idx
 = 
d©a_disks
 - 
	`£˘‹_div
(
°rùe2
, 
øid_disks
-1);

551 *
dd_idx
 = (
pd_idx
 + 1 + *dd_idxË% (
øid_disks
-1);

552 
qd_idx
 = 
øid_disks
 - 1;

555 
ALGORITHM_RIGHT_SYMMETRIC_6
:

556 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
-1);

557 *
dd_idx
 = (
pd_idx
 + 1 + *dd_idxË% (
øid_disks
-1);

558 
qd_idx
 = 
øid_disks
 - 1;

561 
ALGORITHM_PARITY_0_6
:

562 
pd_idx
 = 0;

563 (*
dd_idx
)++;

564 
qd_idx
 = 
øid_disks
 - 1;

568 
	`BUG
();

581 if(
p_disk
)

582 *
p_disk
 = 
pd_idx
;

584 if(
q_disk
)

585 *
q_disk
 = 
qd_idx
;

587 
√w_£˘‹
 = (
£˘‹_t
)
°rùe
 * 
£˘‹s_≥r_chunk
 + 
chunk_off£t
;

588  
√w_£˘‹
;

589 
	}
}

592 
	$ß_öô
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
){

593 
sögÀ_Æloˇt‹
 *
ß
 = &
su≥r
->ß[
ˇche_ty≥
];

594 
curs‹
;

595 
Êags
;

597 
	`•ö_lock_úqßve
(&
ß
->
lock
, 
Êags
);

599 if(
su≥r
->
∑øm
->
d©a_Æloˇti⁄
==
DATA_ALLOC_VERT
){

600 
curs‹
 = 
	`curs‹_°¨t
(
su≥r
, 
£g_id
) - 1;

603 if(
su≥r
->
∑øm
->
∑rôy_Æloˇti⁄
==
PARITY_ALLOC_FIXED
)

604 
ß
->
cﬁ
 = 
NR_SSD
-1;

606 
ß
->
cﬁ
 = ((
£g_id
%
NR_SSD
) + (NR_SSD-1)) % NR_SSD;

608 
ß
->
row
 = -1;

610 
curs‹
 = 
	`curs‹_°¨t
(
su≥r
, 
£g_id
) - 1;

613 
ß
->
curs‹
 = cursor;

614 
	`©omic_£t
(&
ß
->
cou¡
, 0);

615 
	`•ö_u∆ock_úqª°‹e
(&
ß
->
lock
, 
Êags
);

618 
	}
}

620 
u32
 
	$ß_Æloc_h‹iz⁄èl
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
){

621 
u32
 
cﬁ
, 
row
;

622 
u32
 
°¨t_ssd
;

623 
u32
 
∑rôy_ssd
;

624 
u32
 
√xt
;

626 
°¨t_ssd
 = 
	`gë_°¨t_ssd
(
su≥r
, 
£g_id
);

628 
cﬁ
 = 
su≥r
->
ß
[
ˇche_ty≥
].col;

629 
row
 = 
su≥r
->
ß
[
ˇche_ty≥
].row;

630 
cﬁ
 = (cﬁ + 1Ë% 
NR_SSD
;

632 if(
	`USE_ERASURE_CODE
(
su≥r
->
∑øm
)){

634 
∑rôy_ssd
 = 
	`gë_∑rôy_ssd
(
su≥r
, 
£g_id
);

636 if(
cﬁ
==
∑rôy_ssd
 ||

637 (
su≥r
->
∑øm
->
îasuª_code
==
ERASURE_CODE_RAID6
 &&

638 
cﬁ
 =(
∑rôy_ssd
+1)%
NR_SSD
)){

639 
cﬁ
!=
°¨t_ssd
){

640 
cﬁ
 = (cﬁ + 1Ë% 
NR_SSD
;

645 if(
cﬁ
==
°¨t_ssd
)

646 
row
++;

648 
√xt
 = 
cﬁ
 * 
CHUNK_SZ
 + 
row
;

649 
√xt
 %
STRIPE_SZ
;

651 
su≥r
->
ß
[
ˇche_ty≥
].
cﬁ
 = col;

652 
su≥r
->
ß
[
ˇche_ty≥
].
row
 =Ñow;

653  
√xt
;

654 
	}
}

657 
u32
 
	$ß_Æloc
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
u64
 
£g_id
, 
ˇche_ty≥
, 
u32
 *
cur_cou¡
){

658 
sögÀ_Æloˇt‹
 *
ß
 = &
su≥r
->ß[
ˇche_ty≥
];

659 
Êags
;

660 
u32
 
√xt
;

661 
u32
 
idx
;

662 
u32
 
cou¡
;

664 
	`•ö_lock_úqßve
(&
ß
->
lock
, 
Êags
);

666 if(
su≥r
->
∑øm
->
d©a_Æloˇti⁄
==
DATA_ALLOC_VERT
)

667 
	`div_u64_ªm
(
su≥r
->
ß
[
ˇche_ty≥
].
curs‹
 + 1, 
NR_CACHES_INSEG
, &
√xt
);

669 
√xt
 = 
	`ß_Æloc_h‹iz⁄èl
(
su≥r
, 
£g_id
, 
ˇche_ty≥
);

671 
su≥r
->
ß
[
ˇche_ty≥
].
curs‹
 = 
√xt
;

673 
	`©omic_öc
(&
su≥r
->
ß
[
ˇche_ty≥
].
cou¡
);

674 
cou¡
 = 
	`©omic_ªad
(&
su≥r
->
ß
[
ˇche_ty≥
].count);

675 if(
cur_cou¡
)

676 *
cur_cou¡
 = 
cou¡
;

677 
	`BUG_ON
(
cou¡
 > 
NR_CACHES_INSEG
);

679 
idx
 = 
	`SEG_START_IDX
(
£g
Ë+ 
su≥r
->
ß
[
ˇche_ty≥
].
curs‹
;

680 
	`•ö_u∆ock_úqª°‹e
(&
ß
->
lock
, 
Êags
);

687  
idx
;

688 
	}
}

690 
ölöe
 
u32
 
	$ß_gë_cou¡
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

691  
	`©omic_ªad
(&
su≥r
->
ß
[
ˇche_ty≥
].
cou¡
);

692 
	}
}

	@alloc.h

23 #i‚de‡
DM_ALLOC_H


24 
	#DM_ALLOC_H


	)

32 
	#ALGORITHM_LEFT_ASYMMETRIC
 0

	)

33 
	#ALGORITHM_RIGHT_ASYMMETRIC
 1

	)

34 
	#ALGORITHM_LEFT_SYMMETRIC
 2

	)

35 
	#ALGORITHM_RIGHT_SYMMETRIC
 3

	)

40 
	#ALGORITHM_PARITY_0
 4

	)

41 
	#ALGORITHM_PARITY_N
 5

	)

55 
	#ALGORITHM_ROTATING_ZERO_RESTART
 8

	)

56 
	#ALGORITHM_ROTATING_N_RESTART
 9

	)

57 
	#ALGORITHM_ROTATING_N_CONTINUE
 10

	)

65 
	#ALGORITHM_LEFT_ASYMMETRIC_6
 16

	)

66 
	#ALGORITHM_RIGHT_ASYMMETRIC_6
 17

	)

67 
	#ALGORITHM_LEFT_SYMMETRIC_6
 18

	)

68 
	#ALGORITHM_RIGHT_SYMMETRIC_6
 19

	)

69 
	#ALGORITHM_PARITY_0_6
 20

	)

70 
	#ALGORITHM_PARITY_N_6
 
ALGORITHM_PARITY_N


	)

74 
mu…i_Æloˇt‹_öô
(
dm§c_su≥r
 *
su≥r
);

75 
ma_ª£t
(
dm§c_su≥r
 *
wb
, 
u64
 
£g_id
, 
ˇche_ty≥
);

76 
u32
 
ma_Æloc
(
dm§c_su≥r
 *
wb
, 
£gmít_hódî
 *
£g
, 
u64
 
£g_id
, 
ˇche_ty≥
,

77 
devno
, 
u32
 *
cur_cou¡
);

78 
u32
 
ma_£À˘_dev
(
dm§c_su≥r
 *
wb
, 
£˘‹_t
 
£˘‹
, 
ˇche_ty≥
);

79 
u32
 
ma_gë_cou¡
(
dm§c_su≥r
 *
wb
, 
ˇche_ty≥
);

80 
ma_£t_cou¡
(
dm§c_su≥r
 *
wb
, 
ˇche_ty≥
, 
cou¡
);

82 
curs‹_°¨t
(
dm§c_su≥r
 *
wb
, 
u64
 
£g_id
);

83 
£˘‹_t
 
øid5_ˇlc_£˘‹
(
r5c⁄f
 *
c⁄f
, se˘‹_à
r_£˘‹
,

84 
¥evious
, *
dd_idx
, *
p_disk
, *
q_disk
);

85 
ölöe
 
u32
 
ma_gë_≥r_log_cou¡
(
dm§c_su≥r
 *
wb
, 
£˘‹_t
 
£˘‹
, 
ˇche_ty≥
);

86 
dev_°¨t
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
);

87 
gë_num_em±y_chunks
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
);

88 
ölöe
 
u32
 
ma_gë_cou¡_≥r_dev
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
devno
);

89 
mu…i_Æloˇt‹_deöô
(
dm§c_su≥r
 *
su≥r
);

90 
ölöe
 
u32
 
ma_gë_row_cou¡
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
row
);

91 
group_ª£rve_em±y_chunk
(
dm§c_su≥r
 *
su≥r
, 
u32
 
group_id
, 
ˇche_ty≥
);

92 
ölöe
 
u32
 
ma_gë_‰ì
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
);

	@daemon.c

23 
	~<löux/dm-kc›yd.h
>

24 
	~<löux/øid/x‹.h
>

25 
	~<löux/li°_s‹t.h
>

26 
	~<löux/¸c32.h
>

27 
	~"èrgë.h
"

28 
	~"mëad©a.h
"

29 
	~"d´m⁄.h
"

30 
	~"Æloc.h
"

31 
	~"Ãu.h
"

33 
	$upd©e_∂ug_dódlöe
(
dm§c_su≥r
 *
su≥r
)

35 
	`mod_timî
(&
su≥r
->
∂uggî
.
timî
,

36 
jiffõs
 + 
	`u£cs_to_jiffõs
(
	`ACCESS_ONCE
(
su≥r
->
∂uggî
.
dódlöe_us
)));

37 
	}
}

40 
	$Êush_∂ug_¥oc
(
dm§c_su≥r
 *
su≥r
,

41 
£gmít_hódî
 *
£g
,

42 
ømbuf„r
 *
ømbuf
,

43 
©omic_t
 *
bios_°¨t
,

44 
©omic_t
 *
bios_cou¡
,

45 
f‹˚
,

46 
devno
,

47 
Êush_comm™d
){

49 
wb_job
 *
job
;

50 
cou¡
 = 0;

51 
i
;

52 
u32
 
°¨t_idx
;

55 
i
 = ()
	`©omic_ªad
(&
bios_°¨t
[
devno
]);

56 
i
 < ()
	`©omic_ªad
(&
bios_cou¡
[
devno
]);

57 
i
++)

59 
u32
 
idx
 = (u32)
£g
->
£g_id
 * 
STRIPE_SZ
 + 
devno
 * 
CHUNK_SZ
 + 
i
;

60 
bio
 *biÿ
ømbuf
->
bios
[
idx
 % 
STRIPE_SZ
];

61 
mëablock
 *
mb
 = 
	`mb_©
(
su≥r
, 
idx
);

63 if(
bio
){

64 
	`©omic_öc
(&
su≥r
->
ˇche_°©
.
tŸÆ_bios2
);

65 
	`©omic_öc
(&
£g
->
bios_cou¡
);

67 if(!
	`ã°_bô
(
MB_SKIP
, &
mb
->
mb_Êags
)){

71 
	`¥ötk
(" mb skipÇot support ...\n");

72 
	`BUG_ON
(1);

73 if(
	`©omic_dec_™d_ã°
(&
ømbuf
->
ªf_cou¡
)){

74 
	`¥ötk
(" >>>Ö¨tü»wrôebackÉnd seg id %d \n", ()
£g
->
£g_id
);

75 
	`ªÀa£_ømbuf„r
(
su≥r
, 
ømbuf
, 
£g
->
£g_ty≥
);

81 
°¨t_idx
 = (
u32
)
£g
->
£g_id
 * 
STRIPE_SZ
 + 
devno
 * 
CHUNK_SZ
 + 
	`©omic_ªad
(&
bios_°¨t
[devno]);

82 
cou¡
 = 
	`©omic_ªad
(&
bios_cou¡
[
devno
]Ë-átomic_ªad(&
bios_°¨t
[devno]);

85 #i‡(
USE_SEG_WRITER
 == 0)

86 if(
cou¡
){

87 
job
 = 
	`wrôeback_make_job_exã¡
(
su≥r
, 
£g
, 
ømbuf
, 
°¨t_idx
, 
cou¡
);

88 
job
->
Êush_comm™d
 = flush_command;

89 
	`wrôeback_issue_job_exã¡
(
su≥r
, 
job
, 
Êush_comm™d
);

92 if(
cou¡
){

93 
£g_wrôe_m™agî
 *
£g_wrôe_mgr
 = &
su≥r
->£g_wrôe_mgr[
devno
];

94 
Êags
;

96 
job
 = 
	`wrôeback_make_job_exã¡
(
su≥r
, 
£g
, 
ømbuf
, 
°¨t_idx
, 
cou¡
);

97 
job
->
Êush_comm™d
 = flush_command;

99 
	`•ö_lock_úqßve
(&
£g_wrôe_mgr
->
•ölock
, 
Êags
);

100 
	`li°_add_èû
(&
job
->
li°
, &
£g_wrôe_mgr
->
hód
);

101 
	`©omic_öc
(&
£g_wrôe_mgr
->
cou¡
);

102 
	`•ö_u∆ock_úqª°‹e
(&
£g_wrôe_mgr
->
•ölock
, 
Êags
);

104 
	`queue_w‹k
(
£g_wrôe_mgr
->
wq
, &£g_wrôe_mgr->
w‹k
);

109  
cou¡
;

110 
	}
}

113 
	$∂ug_dódlöe_¥oc
(
d©a
)

117 
	}
}

119 
	$queue_b¨rõr_io
(
dm§c_su≥r
 *
su≥r
, 
bio
 *bio)

121 
f
;

123 
	`•ö_lock_úqßve
(&
su≥r
->
≥ndög_mgr
.
b¨rõr_lock
, 
f
);

124 
	`bio_li°_add
(&
su≥r
->
≥ndög_mgr
.
b¨rõr_ios
, 
bio
);

125 
	`©omic_öc
(&
su≥r
->
≥ndög_mgr
.
b¨rõr_cou¡
);

126 
	`•ö_u∆ock_úqª°‹e
(&
su≥r
->
≥ndög_mgr
.
b¨rõr_lock
, 
f
);

128 
	}
}

130 
	$ªad_ˇŒback
(
îr‹
, *
c⁄ãxt
)

132 
ªad_ˇchög_job
 *
gn
 = 
c⁄ãxt
;

133 
dm§c_su≥r
 *
su≥r
 = 
gn
->
gn_su≥r
;

134 
ªad_miss_m™agî
 *
ªad_miss_mgr
 = &
su≥r
->read_miss_mgr;

135 
ªad_ˇchög_job_li°
 *
r_li°
 = &
ªad_miss_mgr
->
queue
;

136 
li°_hód
 *
c›y_hód
 = &
r_li°
->
rm_c›y_hód
;

137 
Êags
;

139 
gn
->
gn_bio_îr‹
 = 
îr‹
;

140 
su≥r
 = 
gn
->
gn_su≥r
;

142 
	`•ö_lock_úqßve
(&
r_li°
->
rm_•ölock
, 
Êags
);

143 
	`li°_add_èû
(&
gn
->
gn_li°
, 
c›y_hód
);

144 
	`©omic_öc
(&
r_li°
->
rm_c›y_cou¡
);

145 
	`•ö_u∆ock_úqª°‹e
(&
r_li°
->
rm_•ölock
, 
Êags
);

147 
	`queue_w‹k
(
ªad_miss_mgr
->
wq
, &ªad_miss_mgr->
w‹k
);

148 
	}
}

150 
	$m≠_ªgi⁄
(
dm_io_ªgi⁄
 *
io
, 
bio
 *bio)

152 
io
->
bdev
 =
bio
->
bi_bdev
;

153 
io
->
£˘‹
 = 
bio
->
bi_£˘‹
;

154 
io
->
cou¡
 = 
	`bio_£˘‹s
(
bio
);

155 
	}
}

157 
ölöe
 
ªad_ˇchög_job
 *
	$Æloc_ªad_ˇchög_job
(
dm§c_su≥r
 *
su≥r
){

158 
ªad_ˇchög_job
 *
gn
;

160 
gn
 = 
	`mempoﬁ_Æloc
(
su≥r
->
ªad_miss_mgr
.
job_poﬁ
, 
GFP_NOIO
);

161 i‡(!
gn
) {

162 
	`WBERR
();

163 
	`BUG_ON
(1);

164  
NULL
;;

167  
gn
;

168 
	}
}

170 
	$ªad_ˇchög_make_job
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
mëablock
 *
mb
, 
bio
 *bio, 
ømbuf„r
 *
ømbuf
)

172 
dm_io_ªgi⁄
 
io
;

173 
dm_io_ªque°
 
io_ªq
;

174 
ªad_ˇchög_job
 *
gn
;

176 
gn
 = 
	`Æloc_ªad_ˇchög_job
(
su≥r
);

177 
gn
->
gn_£˘‹
 = 
bio
->
bi_£˘‹
;

178 
gn
->
gn_bio
 = 
bio
;

179 
gn
->
gn_£g
 = 
£g
;

180 
gn
->
gn_mb
 = 
mb
;

181 
gn
->
gn_ømbuf
 = 
ømbuf
;

182 
gn
->
gn_su≥r
 = 
su≥r
;

184 
io_ªq
.
bi_rw
 = 
READ
,

185 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_BVEC
,

186 
io_ªq
.
mem
.
±r
.
bvec
 = 
bio
->
bi_io_vec
 + bio->
bi_idx
,

187 
io_ªq
.
nŸify
.
‚
 = 
ªad_ˇŒback
,

188 
io_ªq
.
nŸify
.
c⁄ãxt
 = 
gn
,

189 
io_ªq
.
˛õ¡
 = 
su≥r
->
io_˛õ¡
,

190 
	`m≠_ªgi⁄
(&
io
, 
bio
);

192 
	`BUG_ON
(
bio
->
bi_£˘‹
>=
su≥r
->
dev_öfo
.
‹igö_£˘‹s
);

194 
	`dm§c_io
(&
io_ªq
, 1, &
io
, 
NULL
);

195 
	}
}

197 
	$m‹e_w‹k
(
dm§c_su≥r
 *
su≥r
){

198 
ªad_ˇchög_job_li°
 *
r_li°
 = &
su≥r
->
ªad_miss_mgr
.
queue
;

200  
	`©omic_ªad
(&
r_li°
->
rm_c›y_cou¡
);

201 
	}
}

203 
	$c›y_ªad_ˇchög_d©a
(
dm§c_su≥r
 *
su≥r
){

204 
ªad_miss_m™agî
 *
ªad_miss_mgr
 = &
su≥r
->read_miss_mgr;

205 
ªad_ˇchög_job_li°
 *
r_li°
 = &
ªad_miss_mgr
->
queue
;

206 
li°_hód
 *
c›y_hód
 = &
r_li°
->
rm_c›y_hód
;

207 
ªad_ˇchög_job
 *
gn
, *
ãmp
;

208 
li°_hód
 
loˇl_hód
;

210 
Êags
;

212 
cou¡
;

214 
cou¡
 = 
	`©omic_ªad
(&
r_li°
->
rm_c›y_cou¡
);

215 if(!
cou¡
)

218 
	`INIT_LIST_HEAD
(&
loˇl_hód
);

220 
	`•ö_lock_úqßve
(&
r_li°
->
rm_•ölock
, 
Êags
);

221 
	`li°_f‹_óch_íåy_ß„
(
gn
, 
ãmp
, 
c›y_hód
, 
gn_li°
){

222 
	`li°_dñ
(&
gn
->
gn_li°
);

223 
	`li°_add
(&
gn
->
gn_li°
, &
loˇl_hód
);

224 
	`©omic_dec
(&
r_li°
->
rm_c›y_cou¡
);

226 
	`•ö_u∆ock_úqª°‹e
(&
r_li°
->
rm_•ölock
, 
Êags
);

228 
	`li°_f‹_óch_íåy_ß„
(
gn
, 
ãmp
, &
loˇl_hód
, 
gn_li°
){

229 
ˇche_m™agî
 *
˛ón_ˇche
 = 
su≥r
->
˛ón_døm_ˇche_m™agî
;

230 
Ãu_node
 *
 
 = 
NULL
;

231 
Ãu_Êags
;

232 
£˘‹_t
 
key
;

233 
u32
 
¸c32
;

234 *
§c_±r
, *
d°_±r
;

237 
§c_±r
 = 
	`∑ge_addªss
(
	`bio_∑ge
(
gn
->
gn_bio
));

238 
¸c32
 = 
	`¸c32
(17, 
§c_±r
, 
PAGE_SIZE
);

241 
key
 = 
	`ˇlc_ˇche_Æignmít
(
su≥r
, 
gn
->
gn_bio
->
bi_£˘‹
);

245 
	`•ö_lock_úqßve
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

246 
 
 = 
	`CACHE_SEARCH
(
˛ón_ˇche
, 
key
);

247 if(
 
){

248 
	`©omic_£t
(&
 
->
locked
, 1);

249 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

251 
d°_±r
 = 
	`∑ge_addªss
(
 
->
˙_∑ge
);

252 
	`mem˝y
(
d°_±r
, 
§c_±r
, 
SRC_PAGE_SIZE
);

254 
	`•ö_lock_úqßve
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

255 
	`©omic_£t
(&
 
->
locked
, 0);

256 
 
->
¸c32
 = crc32;

257 
	`©omic_£t
(&
 
->
£Æed
, 1);

258 
	`©omic_öc
(&
˛ón_ˇche
->
cm_£Æed_cou¡
);

264 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

266 
	`bio_ídio
(
gn
->
gn_bio
, 0);

267 
	`mempoﬁ_‰ì
(
gn
, 
ªad_miss_mgr
->
job_poﬁ
);

268 
gn
 = 
NULL
;

270 
	}
}

273 
	$£g_wrôe_w‹kî
(
w‹k_°ru˘
 *
w‹k
){

274 
£g_wrôe_m™agî
 *
£g_wrôe_mgr
 =

275 
	`c⁄èöî_of
(
w‹k
, 
£g_wrôe_m™agî
,

276 
w‹k
);

277 
dm§c_su≥r
 *
su≥r
 = 
£g_wrôe_mgr
->super;

278 
Êags
;

279 
wb_job
 *
job
;

281 
	`©omic_ªad
(&
£g_wrôe_mgr
->
cou¡
)){

282 
	`•ö_lock_úqßve
(&
£g_wrôe_mgr
->
•ölock
, 
Êags
);

283 
job
 = (
wb_job
 *)

284 
	`li°_íåy
(
£g_wrôe_mgr
->
hód
.
√xt
, 
wb_job
, 
li°
);

285 
	`li°_dñ
(&
job
->
li°
);

286 
	`©omic_dec
(&
£g_wrôe_mgr
->
cou¡
);

287 
	`•ö_u∆ock_úqª°‹e
(&
£g_wrôe_mgr
->
•ölock
, 
Êags
);

288 
	`wrôeback_issue_job_exã¡
(
su≥r
, 
job
, job->
Êush_comm™d
);

290 
	}
}

292 
	$do_ªad_ˇchög_w‹kî
(
w‹k_°ru˘
 *
w‹k
){

293 
ªad_miss_m™agî
 *
ªad_miss_mgr
 =

294 
	`c⁄èöî_of
(
w‹k
, 
ªad_miss_m™agî
,

295 
w‹k
);

296 
dm§c_su≥r
 *
su≥r
 = 
ªad_miss_mgr
->super;

298 
	`m‹e_w‹k
(
su≥r
)){

299 
	`c›y_ªad_ˇchög_d©a
(
su≥r
);

300 if(
	`√ed_˛ón_£g_wrôe
(
su≥r
)) {

303 
	`≥ndög_w‹kî_scheduÀ
(
su≥r
);

306 
	}
}

308 
	$dm§c_bio_íd_Êush
(
bio
 *bio, 
îr
)

310 i‡(
îr
)

311 
	`˛ór_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

312 i‡(
bio
->
bi_¥iv©e
)

313 
	`com∂ëe
(
bio
->
bi_¥iv©e
);

314 
	`bio_put
(
bio
);

315 
	}
}

329 
bio
 *
	$dm§c_blkdev_issue_Êush
(
block_devi˚
 *
bdev
, 
gÂ_t
 
gÂ_mask
,

330 
£˘‹_t
 *
îr‹_£˘‹
, 
com∂ëi⁄
 *
waô
)

332 
ªque°_queue
 *
q
;

333 
bio
 *bio;

335 i‡(
bdev
->
bd_disk
 =
NULL
)

336  
NULL
;

338 
q
 = 
	`bdev_gë_queue
(
bdev
);

339 i‡(!
q
)

340  
NULL
;

348 i‡(!
q
->
make_ªque°_‚
)

349  
NULL
;

351 
bio
 = 
	`bio_Æloc
(
gÂ_mask
, 0);

352 
bio
->
bi_íd_io
 = 
dm§c_bio_íd_Êush
;

353 
bio
->
bi_bdev
 = 
bdev
;

354 
bio
->
bi_¥iv©e
 = 
waô
;

356 
	`bio_gë
(
bio
);

357 
	`submô_bio
(
WRITE_FLUSH
, 
bio
);

358  
bio
;

360 
	}
}

362 
	$dm§c_blkdev_waô_Êush
(
bio
 *bio)

364 
com∂ëi⁄
 *
waô
 = 
bio
->
bi_¥iv©e
;

365 
ªt
;

367 
	`waô_f‹_com∂ëi⁄_io
(
waô
);

377 i‡(!
	`bio_Êagged
(
bio
, 
BIO_UPTODATE
))

378 
ªt
 = -
EIO
;

380 
	`bio_put
(
bio
);

381  
ªt
;

382 
	}
}

386 
	$issue_de„ºed_bio
(
dm§c_su≥r
 *
su≥r
, 
bio_li°
 *
b¨rõr_ios
){

387 
devi˚_öfo
 *
dev_öfo
 = &
su≥r
->dev_info;

388 
bio
 *bio;

389 
bio
 *
bios
[
MAX_CACHE_DEVS
];

390 
com∂ëi⁄
 
waô
[
MAX_CACHE_DEVS
];

391 
i
;

393 i‡(
	`bio_li°_em±y
(
b¨rõr_ios
)) {

397 (
bio
 = 
	`bio_li°_p›
(
b¨rõr_ios
))) {

398 
i
 = 0;ò< 
dev_öfo
->
num_ˇche_devs
;i++){

399 
	`öô_com∂ëi⁄
(&
waô
[
i
]);

400 
bios
[
i
] = 
	`dm§c_blkdev_issue_Êush
(
dev_öfo
->
ˇche_dev
[i]->
bdev
, 
GFP_KERNEL
, 
NULL
, &
waô
[i]);

401 if(!
bios
[
i
]){

406 
i
 = 0;ò< 
dev_öfo
->
num_ˇche_devs
;i++){

407 if(
bios
[
i
]){

408 
	`dm§c_blkdev_waô_Êush
(
bios
[
i
]);

413 
	`bio_ídio
(
bio
, 0);

416 
	}
}

420 
	$gí_∑πül_summ¨y_io
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

421 
ømbuf„r
 *
ømbuf
,

422 
summ¨y_io_job
 *
c⁄ãxt
){

424 
dm_io_ªque°
 
io_ªq
;

425 
dm_io_ªgi⁄
 
ªgi⁄
;

426 
u32
 
mem_off£t
 = 0;

427 
u32
 
tmp32
;

428 
u32
 
idx
;

431 
idx
 = 
	`curs‹_summ¨y_off£t
(
su≥r
, 
£g
->
£g_id
, seg->
£g_ty≥
);

433 
	`©omic_öc
(&(
c⁄ãxt
->
cou¡
));

435 
	`div_u64_ªm
(
idx
, 
STRIPE_SZ
, &
tmp32
);

436 
mem_off£t
 = 
tmp32
;

438 
ªgi⁄
.
bdev
 = 
	`gë_bdev
(
su≥r
, 
idx
);

439 
ªgi⁄
.
£˘‹
 = 
	`gë_£˘‹
(
su≥r
, 
£g
->
£g_id
, 
idx
);

440 
ªgi⁄
.
cou¡
 = 
SRC_SECTORS_PER_PAGE
;

442 
io_ªq
.
˛õ¡
 = 
su≥r
->
io_˛õ¡
;

443 
io_ªq
.
bi_rw
 = 
WRITE
;

444 
io_ªq
.
nŸify
.
‚
 = 
Êush_£gmd_ídio
;

445 
io_ªq
.
nŸify
.
c⁄ãxt
 = context;

446 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_KMEM
;

447 
io_ªq
.
mem
.
±r
.
addr
 = 
ømbuf
->
∑ges
[
mem_off£t
]->
d©a
;

449 
	`dm§c_io
(&
io_ªq
, 1, &
ªgi⁄
, 
NULL
);

451 
	}
}

457 
	$waô_bufc›y_ios
(
£gmít_hódî
 *
£g
){

458 
u32
 
cou¡
 = 0;

459 
	`©omic_ªad
(&
£g
->
num_bufc›y
)){

460 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(
TIMEOUT_US
));

461 
cou¡
++;

462 if(
cou¡
==100000){

463 
	`¥ötk
(" WARN: wait bufcopy ios ... \n");

464 
cou¡
 = 0;

467 
	}
}

469 
	$waô_fûlög_ios
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

470 
u32
 
cou¡
 = 0;

471 
	`©omic_ªad
(&
£g
->
num_fûlög
)){

472 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(
TIMEOUT_US
));

473 
cou¡
++;

474 if(
cou¡
==100000){

475 
	`¥ötk
(" WARN: wait filling ios ... \n");

476 
cou¡
 = 0;

479 
	}
}

482 
	$Êush_mëa_¥oc
(*
d©a
)

484 
dm§c_su≥r
 *
su≥r
 = 
d©a
;

485 
Êush_m™agî
 *
Êush_mgr
 = &
su≥r
->flush_mgr;

486 
Êush_övoke_job
 *
job
;

487 
Êags
;

489 
åue
) {

491 
	`•ö_lock_úqßve
(&
Êush_mgr
->
lock
, 
Êags
);

492 
	`li°_em±y
(&
Êush_mgr
->
queue
)) {

493 
	`•ö_u∆ock_úqª°‹e
(&
Êush_mgr
->
lock
, 
Êags
);

494 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(10));

496 i‡(
	`kthªad_should_°›
())

499 
	`•ö_lock_úqßve
(&
Êush_mgr
->
lock
, 
Êags
);

502 
job
 = 
	`li°_fú°_íåy
(&
Êush_mgr
->
queue
, 
Êush_övoke_job
, 
li°
);

503 
	`li°_dñ
(&
job
->
li°
);

504 
	`•ö_u∆ock_úqª°‹e
(&
Êush_mgr
->
lock
, 
Êags
);

508 
	`waô_fûlög_ios
(
su≥r
, 
job
->
£g
);

510 
	`waô_bufc›y_ios
(
job
->
£g
);

512 
	`buûd_mëad©a
(
su≥r
,

513 
job
->
£g
,

514 
job
->
£g_Àngth
,

515 
job
->
ømbuf
,

516 
job
->
bios_°¨t
,

517 
job
->
bios_cou¡
,

518 
job
->
f‹˚_£Æ
,

519 
job
->
buûd_summ¨y
,

520 
job
->
Êush_d©a
);

522 
	`issue_de„ºed_bio
(
su≥r
, &
job
->
b¨rõr_ios
);

523 
	`©omic_dec
(&
Êush_mgr
->
övoke_cou¡
);

524 
	`mempoﬁ_‰ì
(
job
, 
Êush_mgr
->
övoke_poﬁ
);

526 
	`≥ndög_w‹kî_scheduÀ
(
su≥r
);

529 
	`¥ötk
(" finish meta flushÅhread ... \n");

531 
	}
}

534 
	$˛ónup_£gmít
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
)

536 
u32
 
i
;

538 
i
 = 0; i < 
STRIPE_SZ
; i++) {

539 
mëablock
 *
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
i
);

540 
	`˛ónup_mb_if_dúty
(
su≥r
, 
£g
, 
mb
);

542 
	}
}

547 
	$föish_mig_w‹k
(
dm§c_su≥r
 *
su≥r
, 
mig_job
 *
job
, 
˛ónup
){

550 if(
	`is_wrôe_°rùe
(
£g
->
£g_ty≥
)){

551 if(
CHUNK_SZ
+
NUM_DATA_SSD
!=
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)){

552 
	`¥ötk
(" Finish: migrating write seg = %d, valid count = %d cleanup = %d \n",

553 ()
£g
->
£g_id
, ()
	`©omic_ªad
(&£g->
vÆid_cou¡
), 
˛ónup
);

554 
	`¥ötk
(" valid count = %d, dirty count = %d \n",

555 
	`check_vÆid_cou¡
(
su≥r
, 
£g
),

556 
	`check_dúty_cou¡
(
su≥r
, 
£g
));

557 
	`¥ötk
(" u£ g¯%d \n", 
job
->
u£_gc
);

560 if(
NUM_SSD
!
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)){

561 
	`¥ötk
(" Finish: migratingÑead seg = %d, valid count = %d cleanup = %d \n",

562 ()
£g
->
£g_id
, ()
	`©omic_ªad
(&£g->
vÆid_cou¡
), 
˛ónup
);

563 
	`¥ötk
(" valid count = %d, dirty count = %d \n",

564 
	`check_vÆid_cou¡
(
su≥r
, 
£g
),

565 
	`check_dúty_cou¡
(
su≥r
, 
£g
));

566 
	`¥ötk
(" u£ g¯%d \n", 
job
->
u£_gc
);

583 
	`BUG_ON
(
	`©omic64_ªad
(&
job
->
cou¡
));

584 
	`mempoﬁ_‰ì
(
job
, 
su≥r
->
migøã_mgr
.
mig_job_poﬁ
);

585 
	`©omic_öc
(&
su≥r
->
migøã_mgr
.
mig_com∂ëes
);

587 
	`≥ndög_w‹kî_scheduÀ
(
su≥r
);

588 
	}
}

591 
	$gë_mëad©a_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£g_ty≥
){

592 
vÆid_cou¡
 = 0;

594 if(
	`is_wrôe_°rùe
(
£g_ty≥
)){

595 
vÆid_cou¡
 +
NUM_SUMMARY
*
NUM_DATA_SSD
;

596 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
))

597 
vÆid_cou¡
 +
CHUNK_SZ
;

599 
vÆid_cou¡
 +(
NUM_SUMMARY
*
NUM_SSD
);

602  
vÆid_cou¡
;

603 
	}
}

605 
	$gë_d©a_max_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£g_ty≥
){

607  
STRIPE_SZ
 - 
	`gë_mëad©a_cou¡
(
su≥r
, 
£g_ty≥
);

608 
	}
}

610 
	$gë_d©a_vÆid_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

611 
vÆid_cou¡
 = 0;

612 
group_hódî
 *
group
 = &
su≥r
->
group_hódî_¨øy
[
£g
->
£g_id
/
SEGMENT_GROUP_SIZE
];

614 if(
	`is_wrôe_°rùe
(
£g
->
£g_ty≥
)){

615 
u32
 
num_d©a_ssd
 = 
	`©omic_ªad
(&
group
->
num_u£d_ssd
)-1;

616 
vÆid_cou¡
 +
NUM_SUMMARY
*
num_d©a_ssd
;

617 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
))

618 
vÆid_cou¡
 +
CHUNK_SZ
;

620 
vÆid_cou¡
 +(
NUM_SUMMARY
*
NUM_SSD
);

623  
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)-valid_count;

624 
	}
}

626 
	$is_em±y_£g
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
u£_gc
){

628 
vÆid_cou¡
 = 0;

629 
group_hódî
 *
group
 = &
su≥r
->
group_hódî_¨øy
[
£g
->
£g_id
/
SEGMENT_GROUP_SIZE
];

630 if(
u£_gc
){

631 if(
	`is_wrôe_°rùe
(
£g
->
£g_ty≥
)){

632 
u32
 
num_d©a_ssd
 = 
	`©omic_ªad
(&
group
->
num_u£d_ssd
)-1;

633 
vÆid_cou¡
 +
NUM_SUMMARY
*
num_d©a_ssd
;

634 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
))

635 
vÆid_cou¡
 +
CHUNK_SZ
;

637 
vÆid_cou¡
 +(
NUM_SUMMARY
*
NUM_SSD
);

640 if(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)<valid_count ||átomic_read(&seg->valid_count)!=valid_count){

642 
	`¥ötk
(" seg id = %dÅy≥ = %d vÆid = %d %d %d\n", ()
£g
->
£g_id
, seg->
£g_ty≥
, 
	`©omic_ªad
(&£g->
vÆid_cou¡
), vÆid_cou¡, 
	`ˇlc_mëa_cou¡
(
su≥r
, seg));

643 
	`BUG_ON
(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)<valid_count);

646 if(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)==valid_count)

649 if(
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
)==0)

653 if(
u£_gc
){

654 #ifde‡
NO_CLEAN_COPY


655 if(!
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
))

658 #ifde‡
HOT_DATA_COPY


659 if(!
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
)&&!©omic_ªad(&£g->
hŸ_˛ón_cou¡
))

662 if(!
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
)&&!©omic_ªad(&£g->
vÆid_˛ón_cou¡
))

667 if(!
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
))

674 
	}
}

677 
	$föish_kc›y_job
(
dm§c_su≥r
 *
su≥r
, 
c›y_job_group
 *
˝_job_group
){

679 
li°_hód
 *
kc›y_li°
 = &
˝_job_group
->
˝_hód
;

680 
ømbuf„r
 *
d°_ømbuf
 = 
˝_job_group
->dst_rambuf;

681 
c›y_job
 *
˝_job
, *
tmp
;

684 
summ¨y_cou¡
 = 0;

687 
	`li°_f‹_óch_íåy_ß„
(
˝_job
, 
tmp
, 
kc›y_li°
, 
˝_li°
){

688 if(
˝_job
->
§c_mb
==
NULL
&&
˝_job_group
->
rw
==
WRITE
){

689 if(
˝_job_group
->
gc
){

690 
	`li°_dñ
(&
˝_job
->
˝_li°
);

691 
	`£t_bô
(
MB_SEAL
, &
˝_job
->
d°_mb
->
mb_Êags
);

692 if(!
˝_job
->
§c_mb
 && 
	`©omic_dec_™d_ã°
(&
d°_ømbuf
->
ªf_cou¡
)){

695 
	`ªÀa£_ømbuf„r
(
su≥r
, 
˝_job_group
->
d°_ømbuf
, cp_job_group->
ˇche_ty≥
);

697 
	`BUG_ON
(
	`©omic_ªad
(&
d°_ømbuf
->
ªf_cou¡
)<0);

698 
	`mempoﬁ_‰ì
(
˝_job
, 
su≥r
->
migøã_mgr
.
c›y_job_poﬁ
);

699 
summ¨y_cou¡
++;

701 
	`¥ötk
(" invalid ... cp_job->gc\n");

702 
	`BUG_ON
(1);

708 
	`li°_f‹_óch_íåy_ß„
(
˝_job
, 
tmp
, 
kc›y_li°
, 
˝_li°
){

709 
£gmít_hódî
 *
d°_£g
 = 
NULL
, *
§c_£g
 = NULL;

711 
	`li°_dñ
(&
˝_job
->
˝_li°
);

712 if(!
˝_job
->
§c_mb
){

713 
	`¥ötk
(" summary data ... \n");

714 
	`BUG_ON
(1);

717 
§c_£g
 = 
	`gë_£g_by_mb
(
su≥r
, 
˝_job
->
§c_mb
);

718 
d°_£g
 = 
˝_job_group
->dst_seg;

720 if(
§c_£g
 && 
	`©omic_dec_™d_ã°
(&§c_£g->
num_migios
)){

721 
	`©omic_dec
(&
su≥r
->
migøã_mgr
.
mig_öÊights
);

723 if(
	`is_em±y_£g
(
su≥r
, 
§c_£g
)){

725 
	`föÆize_˛ón_£g
(
su≥r
, 
§c_£g
, 1);

727 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(10));

728 
	`¥ötk
("Çìd ch™gê°©ê...ÇŸÉm±y seg ... seg %d %d \n", ()
§c_£g
->
£g_id
,

729 
	`©omic_ªad
(&
§c_£g
->
vÆid_cou¡
));

733 if(
˝_job_group
->
gc
){

734 if(
˝_job
->
§c_mb
){

735 
	`upd©e_d©a_ö_mb
(
su≥r
, 
˝_job
->
d°_mb
->
idx
, 
d°_£g
, 
d°_ømbuf
, d°_£g->
£g_ty≥
, 
NULL
);

736 
	`©omic_dec
(&
d°_£g
->
num_fûlög
);

738 
	`£t_bô
(
MB_SEAL
, &
˝_job
->
d°_mb
->
mb_Êags
);

741 if(!
˝_job_group
->
gc
){

742 
	`‰ì_sögÀ_∑ge
(
su≥r
, 
˝_job
->
∑ge
);

746 
	`mempoﬁ_‰ì
(
˝_job
, 
su≥r
->
migøã_mgr
.
c›y_job_poﬁ
);

749 if(
˝_job_group
->
gc
)

750 
	`make_Êush_övoke_job
(
su≥r
, 
˝_job_group
->
d°_£g
, cp_job_group->
d°_ømbuf
, cp_job_group->
ˇche_ty≥
, 0, 0, 1);

752 
	`¥ötk
(" ### finish kcopy job ... \n");

759 
	}
}

763 
	$upd©e_summ¨y_block
(
dm§c_su≥r
 *
su≥r
, 
c›y_job_group
 *
˝_job_group
){

765 
li°_hód
 *
kc›y_li°
 = &
˝_job_group
->
˝_hód
;

766 
c›y_job
 *
˝_job
, *
tmp
;

767 
£gmít_hódî
 *
§c_£g
 = 
NULL
;

768 
f
;

769 
i
;

771 
	`li°_f‹_óch_íåy_ß„
(
˝_job
, 
tmp
, 
kc›y_li°
, 
˝_li°
){

772 if(
˝_job
->
§c_mb
==
NULL
&&
˝_job_group
->
rw
==
WRITE
)

775 
	`LOCK
(
su≥r
, 
f
);

776 
§c_£g
 = 
	`gë_£g_by_mb
(
su≥r
, 
˝_job
->
§c_mb
);

777 
	`övÆid©e_¥evious_ˇche
(
su≥r
, 
§c_£g
, 
˝_job
->
§c_mb
);

778 if(
˝_job_group
->
gc
){

779 
£˘‹_t
 
key
 = 
	`ˇlc_ˇche_Æignmít
(
su≥r
, 
˝_job
->
§c_mb
->
£˘‹
);

780 if(
key
==~0){

781 
	`¥ötk
(" invÆid se˘‹ = %d \n", ()
key
);

782 
	`BUG_ON
(1);

784 
	`ht_ªgi°î
(
su≥r
, 
key
, 
˝_job
->
d°_mb
);

785 
	`BUG_ON
(
˝_job
->
d°_mb
->
£˘‹
!=˝_job->
§c_mb
->sector);

787 
	`UNLOCK
(
su≥r
, 
f
);

790 if(
˝_job_group
->
gc
){

791 
i
 = 0;ò< 
NUM_SSD
;i++){

792 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
) &&

793 
i
 =
	`gë_∑rôy_ssd
(
su≥r
, 
˝_job_group
->
d°_£g
->
£g_id
) &&

794 
	`is_wrôe_°rùe
(
˝_job_group
->
d°_£g
->
£g_ty≥
))

797 
	`¥ï¨e_chunk_summ¨y
(
su≥r
, 
˝_job_group
->
d°_£g
, cp_job_group->
d°_ømbuf
->
∑ges
, 
i
,

798 
˝_job_group
->
d°_£g
->
£g_ty≥
);

801 
	}
}

804 
	$gíî©e_gc_wrôe
(
dm§c_su≥r
 *
su≥r
, 
c›y_job_group
 *
˝_job_group
){

805 
li°_hód
 *
kc›y_li°
 = &
˝_job_group
->
˝_hód
;

806 
c›y_job
 *
˝_job
, *
tmp
;

807 
£gmít_hódî
 *
§c_£g
 = 
NULL
;

808 
mëablock
 *
§c_mb
;

809 
f
;

810 
ˇche_ty≥
;

812 
	`li°_f‹_óch_íåy_ß„
(
˝_job
, 
tmp
, 
kc›y_li°
, 
˝_li°
){

813 
ˇche_ty≥
 = 
WCBUF
;

814 
§c_mb
 = 
˝_job
->src_mb;

816 
	`LOCK
(
su≥r
, 
f
);

818 
§c_£g
 = 
	`gë_£g_by_mb
(
su≥r
, 
§c_mb
);

819 if(
	`ã°_bô
(
MB_DIRTY
, &
§c_mb
->
mb_Êags
)){

820 if(
	`should_√ed_ª‰esh_£g
(
su≥r
, 
ˇche_ty≥
)){

821 
RETRY
:

822 if(
	`ˇn_gë_‰ì_£gmít
(
su≥r
, 
ˇche_ty≥
, 1)){

823 
	`Æloc_√w_£gmít
(
su≥r
, 
ˇche_ty≥
, 
Ál£
);

825 
	`UNLOCK
(
su≥r
, 
f
);

829 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(100));

830 
	`LOCK
(
su≥r
, 
f
);

831 
RETRY
;

836 
	`övÆid©e_¥evious_ˇche
(
su≥r
, 
§c_£g
, 
§c_mb
);

838 
	`wp_upd©e
(
su≥r
, 
WRITE
, 
REQ_CATEGORY_GC
);

840 if(!
	`ã°_bô
(
MB_DIRTY
, &
§c_mb
->
mb_Êags
)){

841 
	`¥ötk
(" WARN: No clean data copy ... \n");

844 
	`¥o˚ss_wrôe_ªque°
(
su≥r
, 
NULL
, 
˝_job
->
∑ge
->
∂
->∑ge, 
§c_mb
->
£˘‹
,

845 
	`ã°_bô
(
MB_DIRTY
, &
§c_mb
->
mb_Êags
), 
f
, 
ˇche_ty≥
, src_mb->
checksum
);

848 
ˇche_m™agî
 *
˛ón_ˇche
 = 
su≥r
->
˛ón_døm_ˇche_m™agî
;

849 
Ãu_node
 *
 
 = 
NULL
;

850 
Ãu_Êags
;

852 
	`•ö_lock_úqßve
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

853 
 
 = 
	`CACHE_SEARCH
(
˛ón_ˇche
, 
§c_mb
->
£˘‹
);

854 if(
 
){

855 
	`©omic_£t
(&
 
->
£Æed
, 1);

856 
	`©omic_£t
(&
 
->
locked
, 0);

857 
	`©omic_öc
(&
˛ón_ˇche
->
cm_£Æed_cou¡
);

859 
	`¥ötk
(" WARN: NÿD©®... %†\n", 
__FUNCTION__
);

861 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

863 
	`UNLOCK
(
su≥r
, 
f
);

866 if(
	`©omic_dec_™d_ã°
(&
§c_£g
->
num_migios
)){

867 if(
	`is_em±y_£g
(
su≥r
, 
§c_£g
, 1)){

868 
	`©omic_dec
(&
su≥r
->
migøã_mgr
.
mig_öÊights
);

869 
	`föÆize_˛ón_£g
(
su≥r
, 
§c_£g
, 1);

871 
	`¥ötk
("Çìd ch™gê°©ê...ÇŸÉm±y seg ... seg %d (vÆid:ÅŸÆ %d, cÀ™ %d, dúty %d, seg_migøtög = %d \n", ()
§c_£g
->
£g_id
,

872 
	`©omic_ªad
(&
§c_£g
->
vÆid_cou¡
),

873 
	`©omic_ªad
(&
§c_£g
->
vÆid_˛ón_cou¡
),

874 
	`©omic_ªad
(&
§c_£g
->
vÆid_dúty_cou¡
),

875 
	`ã°_bô
(
SEG_MIGRATING
, &
§c_£g
->
Êags
));

876 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

880 
	`li°_dñ
(&
˝_job
->
˝_li°
);

881 
	`‰ì_sögÀ_∑ge
(
su≥r
, 
˝_job
->
∑ge
);

882 
	`©omic_dec
(&
su≥r
->
migøã_mgr
.
c›y_job_cou¡
);

883 
	`mempoﬁ_‰ì
(
˝_job
, 
su≥r
->
migøã_mgr
.
c›y_job_poﬁ
);

885 
	}
}

887 
	$gíî©e_de°age_wrôe
(
dm§c_su≥r
 *
su≥r
, 
c›y_job_group
 *
˝_job_group
){

888 
li°_hód
 *
kc›y_li°
 = &
˝_job_group
->
˝_hód
;

889 
c›y_job
 *
˝_job
, *
tmp
;

890 
£gmít_hódî
 *
§c_£g
 = 
NULL
;

891 
f
;

893 
	`li°_f‹_óch_íåy_ß„
(
˝_job
, 
tmp
, 
kc›y_li°
, 
˝_li°
){

895 
	`LOCK
(
su≥r
, 
f
);

896 
§c_£g
 = 
	`gë_£g_by_mb
(
su≥r
, 
˝_job
->
§c_mb
);

897 
	`övÆid©e_¥evious_ˇche
(
su≥r
, 
§c_£g
, 
˝_job
->
§c_mb
);

898 
	`UNLOCK
(
su≥r
, 
f
);

900 if(
	`©omic_dec_™d_ã°
(&
§c_£g
->
num_migios
)){

901 if(
	`is_em±y_£g
(
su≥r
, 
§c_£g
, 0)){

902 
	`©omic_dec
(&
su≥r
->
migøã_mgr
.
mig_öÊights
);

903 
	`föÆize_˛ón_£g
(
su≥r
, 
§c_£g
, 1);

906 
	`¥ötk
(" WARN: gíî©e_deßge_wrôe:Çìd ch™gê°©ê...ÇŸÉm±y seg ... seg %d %d, seg_migøtög = %d \n", ()
§c_£g
->
£g_id
,

907 
	`©omic_ªad
(&
§c_£g
->
vÆid_cou¡
), 
	`ã°_bô
(
SEG_MIGRATING
, &§c_£g->
Êags
));

908 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

912 
	`li°_dñ
(&
˝_job
->
˝_li°
);

913 
	`‰ì_sögÀ_∑ge
(
su≥r
, 
˝_job
->
∑ge
);

914 
	`©omic_dec
(&
su≥r
->
migøã_mgr
.
c›y_job_cou¡
);

915 
	`mempoﬁ_‰ì
(
˝_job
, 
su≥r
->
migøã_mgr
.
c›y_job_poﬁ
);

917 
	}
}

919 
	$do_mig_w‹kî
(
w‹k_°ru˘
 *
w‹k
){

920 
migøti⁄_m™agî
 *
migøã_mgr
 = 
	`c⁄èöî_of
(
w‹k
, migøti⁄_m™agî, 
mig_w‹k
);

921 
dm§c_su≥r
 *
su≥r
 = 
migøã_mgr
->super;

922 
c›y_job_group
 *
˝_job_gΩ
, *
˝_tmp
;

923 
li°_hód
 
loˇl_hód
;

925 
Êags
;

927 
	`INIT_LIST_HEAD
(&
loˇl_hód
);

929 
	`•ö_lock_úqßve
(&
migøã_mgr
->
group_queue_lock
, 
Êags
);

930 
	`li°_f‹_óch_íåy_ß„
(
˝_job_gΩ
, 
˝_tmp
, &
migøã_mgr
->
group_queue
, 
group_li°
) {

931 
	`li°_move_èû
(&
˝_job_gΩ
->
group_li°
, &
loˇl_hód
);

933 
	`•ö_u∆ock_úqª°‹e
(&
migøã_mgr
->
group_queue_lock
, 
Êags
);

935 
	`li°_f‹_óch_íåy_ß„
(
˝_job_gΩ
, 
˝_tmp
, &
loˇl_hód
, 
group_li°
) {

936 
	`li°_dñ
(&
˝_job_gΩ
->
group_li°
);

938 if(
˝_job_gΩ
->
gc
){

939 
	`gíî©e_gc_wrôe
(
su≥r
, 
˝_job_gΩ
);

940 
	`mempoﬁ_‰ì
(
˝_job_gΩ
, 
migøã_mgr
->
group_job_poﬁ
);

941 
	`©omic_dec
(&
migøã_mgr
->
group_job_cou¡
);

943 if(
˝_job_gΩ
->
rw
==
READ
){

944 
˝_job_gΩ
->
rw
 = 
WRITE
;

945 
	`Êush_kc›y_job
(
su≥r
, 
˝_job_gΩ
);

947 
	`gíî©e_de°age_wrôe
(
su≥r
, 
˝_job_gΩ
);

948 
	`mempoﬁ_‰ì
(
˝_job_gΩ
, 
migøã_mgr
->
group_job_poﬁ
);

949 
	`©omic_dec
(&
migøã_mgr
->
group_job_cou¡
);

954 if(
˝_job_gΩ
->
rw
==
READ
){

955 
˝_job_gΩ
->
rw
 = 
WRITE
;

956 
	`upd©e_summ¨y_block
(
su≥r
, 
˝_job_gΩ
);

957 
	`Êush_kc›y_job
(
su≥r
, 
˝_job_gΩ
, cp_job_gΩ->
ˇche_ty≥
, cp_job_gΩ->
cur_kc›yd
);

959 
	`föish_kc›y_job
(
su≥r
, 
˝_job_gΩ
);

960 
	`mempoﬁ_‰ì
(
˝_job_gΩ
, 
migøã_mgr
->
group_job_poﬁ
);

965 
	}
}

968 
	$c›y_com∂ëe
(
ªad_îr
, 
wrôe_îr
, *
__c⁄ãxt
)

970 
c›y_job
 *
˝_job
 = 
__c⁄ãxt
;

971 
mig_job
 *
mg_job
 = 
˝_job
->mg_job;

972 
dm§c_su≥r
 *
su≥r
 = 
mg_job
->
wb
;

973 
Êags
;

975 i‡(
ªad_îr
 || 
wrôe_îr
)

976 
mg_job
->
îr‹
 = 1;

978 
	`•ö_lock_úqßve
(&
su≥r
->
mig_queue_lock
, 
Êags
);

979 
	`li°_add_èû
(&
˝_job
->
˝_li°
, &
su≥r
->
c›y_queue
);

980 
	`•ö_u∆ock_úqª°‹e
(&
su≥r
->
mig_queue_lock
, 
Êags
);

982 
	`queue_w‹k
(
su≥r
->
mig_wq
, &
wb
->
mig_w‹k
);

984 
	}
}

988 
	$ª‰esh_gc_buf
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, *
f
){

989 
£gmít_hódî
 *
d°_£g
;

990 
ømbuf„r
 *
ømbuf
;

993 
d°_£g
 = 
su≥r
->
cuºít_£g
[
ˇche_ty≥
];

994 
ømbuf
 = 
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
ˇche_ty≥
];

996 
	`UNLOCK
(
su≥r
, *
f
);

998 
	`¥ötk
("Ñefresh gc invoke job seg id = %d,Üength = %d \n",

999 ()
d°_£g
->
£g_id
, 
	`©omic_ªad
(&d°_£g->
Àngth
));

1001 
	`make_Êush_övoke_job
(
su≥r
, 
d°_£g
, 
ømbuf
, 
ˇche_ty≥
, 0, 0);

1005 
	`waô_ømbuf_evít
(
su≥r
, 
ˇche_ty≥
);

1007 
	`¥ötk
("Ñambuf gc bufÉxits.. \n");

1009 
	`BUG_ON
(!
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_cou¡
));

1010 
	`BUG_ON
(!
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
ª£rve_cou¡
));

1012 
	`LOCK
(
su≥r
, *
f
);

1014 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_∑ge_cou¡
)<
STRIPE_SZ
){

1015 
	`UNLOCK
(
su≥r
, *
f
);

1016 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(10));

1018 
	`LOCK
(
su≥r
, *
f
);

1021 
	`Æloc_√w_£gmít
(
su≥r
, 
ˇche_ty≥
, 
åue
);

1022 
ømbuf
 = 
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
ˇche_ty≥
];

1023 
	`¥ötk
("Ñe‰esh GCÑe‡cou¡ = %d \n", 
	`©omic_ªad
(&
ømbuf
->
ªf_cou¡
));

1024 
	}
}

1028 
	$gc_job_d⁄e
(
îr‹
, *
c⁄ãxt
)

1030 
c›y_job_group
 *
˝_job_group
 = 
c⁄ãxt
;

1031 
dm§c_su≥r
 *
su≥r
 = 
˝_job_group
->super;

1032 
migøti⁄_m™agî
 *
migøã_mgr
 = &
su≥r
->migrate_mgr;

1033 
Êags
;

1035 if(
	`©omic_dec_™d_ã°
(&
˝_job_group
->
˝_job_cou¡
)){

1036 
	`•ö_lock_úqßve
(&
migøã_mgr
->
group_queue_lock
, 
Êags
);

1037 
	`li°_add_èû
(&
˝_job_group
->
group_li°
, &
migøã_mgr
->
group_queue
);

1038 
	`•ö_u∆ock_úqª°‹e
(&
migøã_mgr
->
group_queue_lock
, 
Êags
);

1039 
	`queue_w‹k
(
migøã_mgr
->
mig_wq
, &migøã_mgr->
mig_w‹k
);

1041 
	}
}

1044 
	$_Êush_kc›y_job
(
dm§c_su≥r
 *
su≥r
, 
c›y_job_group
 *
˝_job_group
, 
c›y_job
 *
˝_job
){

1045 
dm_io_ªque°
 
io_ªq
;

1047 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_PAGE_LIST
;

1048 
io_ªq
.
mem
.
±r
.
∂

˝_job
->
∑ge
->pl;

1049 
io_ªq
.
mem
.
off£t
 = 0;

1050 
io_ªq
.
nŸify
.
‚
 = 
gc_job_d⁄e
;

1051 
io_ªq
.
nŸify
.
c⁄ãxt
 = 
˝_job_group
;

1052 
io_ªq
.
˛õ¡
 = 
su≥r
->
io_˛õ¡
;

1054 if(
˝_job_group
->
rw
==
READ
){

1055 
	`wp_upd©e
(
su≥r
, 
READ
, 
REQ_CATEGORY_GC
);

1056 
io_ªq
.
bi_rw
 = 
READ
;

1057 
	`dm§c_io
(&
io_ªq
, 1, &
˝_job
->
§c_ªgi⁄
, 
NULL
);

1059 
io_ªq
.
bi_rw
 = 
WRITE
;

1060 
	`©omic_öc
(&
su≥r
->
w°©
.
tŸÆ_migøti⁄
);

1061 
	`dm§c_io
(&
io_ªq
, 
˝_job
->
d°_cou¡
, cp_job->
d°_ªgi⁄
, 
NULL
);

1063 
	}
}

1066 
	$Êush_kc›y_job
(
dm§c_su≥r
 *
su≥r
, 
c›y_job_group
 *
˝_job_group
){

1067 
li°_hód
 *
kc›y_li°
 = &
˝_job_group
->
˝_hód
;

1068 
c›y_job
 *
˝_job
, *
tmp
;

1069 
blk_∂ug
 
∂ug
;

1070 
cou¡
 = 0;

1072 
	`li°_f‹_óch_íåy_ß„
(
˝_job
, 
tmp
, 
kc›y_li°
, 
˝_li°
){

1073 
	`©omic_öc
(&
˝_job_group
->
˝_job_cou¡
);

1074 
cou¡
++;

1077 if(!
	`©omic_ªad
(&
˝_job_group
->
˝_job_cou¡
)){

1078 
	`BUG_ON
(1);

1081 
	`blk_°¨t_∂ug
(&
∂ug
);

1082 
	`li°_f‹_óch_íåy_ß„
(
˝_job
, 
tmp
, 
kc›y_li°
, 
˝_li°
){

1083 
	`_Êush_kc›y_job
(
su≥r
, 
˝_job_group
, 
˝_job
);

1085 
	`blk_föish_∂ug
(&
∂ug
);

1086 
	}
}

1088 *
	$Æloc_c›y_job_group
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

1089 
c›y_job_group
 *
˝_job_group
;

1090 
migøti⁄_m™agî
 *
migøã_mgr
 = &
su≥r
->migrate_mgr;

1092 
˝_job_group
 = 
	`mempoﬁ_Æloc
(
migøã_mgr
->
group_job_poﬁ
,
GFP_KERNEL
);

1093 if(!
˝_job_group
){

1094 
	`¥ötk
(" cannotálloc memory via kmalloc \n");

1095 
	`BUG_ON
(!
˝_job_group
);

1098 
	`©omic_öc
(&
migøã_mgr
->
group_job_cou¡
);

1100 
	`INIT_LIST_HEAD
(&
˝_job_group
->
˝_hód
);

1101 
	`©omic_£t
(&
˝_job_group
->
˝_job_cou¡
, 0);

1102 
˝_job_group
->
rw
 = 
READ
;

1103 
˝_job_group
->
ˇche_ty≥
 = cache_type;

1104 
˝_job_group
->
su≥r
 = super;

1105 
˝_job_group
->
£q
 = 
	`©omic_ªad
(&
migøã_mgr
->
group_job_£q
);

1106 
	`©omic_öc
(&
migøã_mgr
->
group_job_£q
);

1108  
˝_job_group
;

1109 
	}
}

1111 
	$check_vÆid√ss
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
mëablock
 *
vi˘im_mb
, 
u£_gc
){

1112 
u8
 
dúty_bôs
 = 0;

1114 if(
u£_gc
){

1115 #ifde‡
NO_CLEAN_COPY


1116 if(
	`©omic_ªad_mb_vÆid√ss
(
£g
, 
vi˘im_mb
Ë&& 
	`©omic_ªad_mb_dútöess
(seg, victim_mb))

1117 
dúty_bôs
 = 1;

1119 #ifde‡
HOT_DATA_COPY


1120 if(
	`©omic_ªad_mb_dútöess
(
£g
, 
vi˘im_mb
)){

1121 if(
	`©omic_ªad_mb_vÆid√ss
(
£g
, 
vi˘im_mb
))

1122 
dúty_bôs
 = 1;

1124 if(
	`©omic_ªad_mb_vÆid√ss
(
£g
, 
vi˘im_mb
)&&
	`ã°_bô
(
MB_HIT
, &vi˘im_mb->
mb_Êags
))

1125 
dúty_bôs
 = 1;

1128 
dúty_bôs
 = 
	`©omic_ªad_mb_vÆid√ss
(
£g
, 
vi˘im_mb
);

1132 if(
	`©omic_ªad_mb_vÆid√ss
(
£g
, 
vi˘im_mb
Ë&& 
	`©omic_ªad_mb_dútöess
(seg, victim_mb))

1133 
dúty_bôs
 = 1;

1136  
dúty_bôs
;

1137 
	}
}

1139 
	$ˇlc_mëa_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

1140 
mëablock
 *
mb
;

1141 
vÆid_cou¡
 = 0;

1142 
summ¨y_cou¡
 = 0;

1143 
∑rôy_cou¡
 = 0;

1144 
i
;

1146 
i
 = 0; i < 
STRIPE_SZ
; i++) {

1147 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
i
);

1148 if(
	`ã°_bô
(
MB_PARITY
, &
mb
->
mb_Êags
)){

1149 
vÆid_cou¡
++;

1150 
∑rôy_cou¡
++;

1152 if(
	`ã°_bô
(
MB_SUMMARY
, &
mb
->
mb_Êags
)){

1153 
vÆid_cou¡
++;

1154 
summ¨y_cou¡
++;

1158 if(
vÆid_cou¡
!=
	`gë_mëad©a_cou¡
(
su≥r
, 
£g
->
£g_ty≥
)){

1159 
	`¥ötk
(" invalid meta count: seg = %dÅotal = %d,Öarity = %d, summary = %d \n",

1160 ()
£g
->
£g_id
, 
vÆid_cou¡
, 
∑rôy_cou¡
, 
summ¨y_cou¡
);

1163  
vÆid_cou¡
;

1164 
	}
}

1166 
	$ˇlc_vÆid_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
u£_gc
){

1167 
mëablock
 *
mb
;

1168 
vÆid_cou¡
 = 0;

1169 
i
;

1170 
hŸ_gc
;

1171 
u8
 
dúty_bôs
;

1173 
i
 = 0; i < 
STRIPE_SZ
; i++) {

1175 
hŸ_gc
 = 0;

1177 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
i
);

1178 
dúty_bôs
 = 
	`check_vÆid√ss
(
su≥r
, 
£g
, 
mb
, 
u£_gc
) ;

1179 if(
mb
->
£˘‹
==~0)

1182 if(
dúty_bôs
)

1183 
vÆid_cou¡
++;

1186 if(
u£_gc
){

1187 #ifde‡
NO_CLEAN_COPY


1188 if(
vÆid_cou¡
!
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
)){

1189 
	`¥ötk
(" calc valid count: gc Invalid valid count .. %d %d \n",

1190 
vÆid_cou¡
, 
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
));

1193 #ifde‡
HOT_DATA_COPY


1194 if(
vÆid_cou¡
!
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
)+©omic_ªad(&£g->
hŸ_˛ón_cou¡
)){

1195 
	`¥ötk
(" calc valid count: gc Invalid valid count .. %d %d \n",

1196 
vÆid_cou¡
, 
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
)+©omic_ªad(&£g->
hŸ_˛ón_cou¡
));

1199 if(
vÆid_cou¡
!
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
)+©omic_ªad(&£g->
vÆid_˛ón_cou¡
)){

1200 
	`¥ötk
(" calc valid count: gc Invalid valid count .. %d %d \n",

1201 
vÆid_cou¡
, 
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
)+©omic_ªad(&£g->
vÆid_˛ón_cou¡
));

1206 if(
vÆid_cou¡
!=
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
)){

1207 
	`¥ötk
(" calc valid count: destage Invalid valid count .. %d %d \n",

1208 
vÆid_cou¡
, 
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
));

1212  
vÆid_cou¡
;

1213 
	}
}

1216 
	$make_de°age_job
(
dm§c_su≥r
 *
su≥r
, 
c›y_job
 *
˝_job
, 
mëablock
 *
vi˘im_mb
, 
d°_cou¡
){

1218 
˝_job
->
d°_mb
 = 
NULL
;

1219 
˝_job
->
d°_ªgi⁄
[
d°_cou¡
].
bdev
 = 
su≥r
->
dev_öfo
.
‹igö_dev
->bdev;

1220 
˝_job
->
d°_ªgi⁄
[
d°_cou¡
].
£˘‹
 = 
vi˘im_mb
->sector;

1221 
˝_job
->
d°_ªgi⁄
[
d°_cou¡
].
cou¡
 = 
SRC_SECTORS_PER_PAGE
;

1222 
˝_job
->
∑ge
 = 
	`Æloc_sögÀ_∑ge
(
su≥r
);

1224 
˝_job
->
d°_cou¡
 = dst_count;

1225 
d°_cou¡
++;

1227 
	`©omic64_öc
(&
su≥r
->
w°©
.
de°age_io_cou¡
);

1229 
	`BUG_ON
(
vi˘im_mb
->
£˘‹
>=
su≥r
->
dev_öfo
.
‹igö_£˘‹s
);

1230 
	}
}

1234 
mëablock
 *
	$Æloc_mb_gc
(
dm§c_su≥r
 *
su≥r
, 
mëablock
 *
vi˘im_mb
, 
ˇche_ty≥
){

1235 
£gmít_hódî
 *
d°_£g
;

1236 
mëablock
 *
d°_mb
;

1237 
f
;

1238 
£˘‹_t
 
key
;

1239 
u32
 
upd©e_mb_idx
;

1240 
u32
 
cou¡
;

1241 
u32
 
tŸÆ_cou¡
 = 0;

1242 
boﬁ
 
chunk_summ¨y
 = 
Ál£
;

1244 
key
 = 
vi˘im_mb
->
£˘‹
;

1246 
cou¡
 = 
	`ma_gë_cou¡
(
su≥r
, 
ˇche_ty≥
);

1247 if(
	`√ed_ª‰esh_£gmít
(
su≥r
, 
ˇche_ty≥
, 
cou¡
)){

1248 
	`¥ötk
("ÇeedÑefresh seg gc .. \n");

1249 
	`BUG_ON
(1);

1251 if(!
	`li°_em±y
(&
˝_job_group
->
˝_hód
)){

1252 
	`Êush_kc›y_job
(
su≥r
, 
˝_job_group
, 
ˇche_ty≥
, 
cur_kc›yd
);

1253 
˝_job_group
 = 
	`Æloc_c›y_job_group
(
su≥r
, 
ˇche_ty≥
, 
cur_kc›yd
 );

1259 
	`LOCK
(
su≥r
, 
f
);

1261 
cou¡
 = 
	`ma_gë_cou¡
(
su≥r
, 
ˇche_ty≥
);

1262 i‡(
	`√ed_ª‰esh_£gmít
(
su≥r
, 
ˇche_ty≥
, 
cou¡
)){

1263 
	`¥ötk
("ÇeedÑefresh seg gc .. \n");

1264 
	`BUG_ON
(1);

1266 
	`ª‰esh_gc_buf
(
su≥r
, 
ˇche_ty≥
, &
f
);

1269 if(
su≥r
->
∑øm
.
gc_wôh_dútysync
)

1270 
d°_mb
 = 
	`Æloc_mb_d©a
(
su≥r
, 
key
, 
ˇche_ty≥
, 
åue
, &
tŸÆ_cou¡
);

1272 
d°_mb
 = 
	`Æloc_mb_d©a
(
su≥r
, 
key
, 
ˇche_ty≥
, !
	`ã°_bô
(
MB_DIRTY
, &
vi˘im_mb
->
mb_Êags
), &
tŸÆ_cou¡
);

1274 
d°_£g
 = 
su≥r
->
cuºít_£g
[
ˇche_ty≥
];

1275 
d°_£g
->
£g_ty≥
 = 
ˇche_ty≥
;

1277 
upd©e_mb_idx
 = 
d°_mb
->
idx
;

1279 if(
	`√ed_chunk_summ¨y
(
su≥r
, 
upd©e_mb_idx
+
NUM_SUMMARY
)){

1280 
u32
 
summ¨y_idx
 = 
	`d©a_to_summ¨y_idx
(
su≥r
, 
upd©e_mb_idx
);

1281 
	`Æloc_mb_summ¨y
(
su≥r
, 
d°_£g
, 
ˇche_ty≥
, 
summ¨y_idx
, &
tŸÆ_cou¡
);

1282 
	`öôülize_mb_summ¨y
(
su≥r
, 
d°_£g
, 
ˇche_ty≥
, 
summ¨y_idx
);

1283 
chunk_summ¨y
 = 
åue
;

1286 
	`UNLOCK
(
su≥r
, 
f
);

1288 
	`˛ór_bô
(
MB_SEAL
, &
d°_mb
->
mb_Êags
);

1290  
d°_mb
;

1291 
	}
}

1295 
c›y_job_group
 *
	$make_gc_job
(
dm§c_su≥r
 *
su≥r
,

1296 
c›y_job_group
 *
˝_job_group
,

1297 
c›y_job
 *
˝_job
,

1298 
mëablock
 *
vi˘im_mb
,

1299 
mëablock
 *
d°_mb
,

1300 *
d°_cou¡
,

1301 
ˇche_ty≥
)

1303 
£gmít_hódî
 *
d°_£g
 = 
	`gë_£g_by_mb
(
su≥r
, 
d°_mb
);

1304 
u32
 
upd©e_mb_idx
 = 
d°_mb
->
idx
;

1306 
˝_job
->
d°_mb
 = dst_mb;

1308 
˝_job
->
d°_ªgi⁄
[*
d°_cou¡
].
bdev
 = 
	`gë_bdev
(
su≥r
, 
upd©e_mb_idx
);

1309 
˝_job
->
d°_ªgi⁄
[*
d°_cou¡
].
£˘‹
 = 
	`gë_£˘‹
(
su≥r
, 
d°_£g
->
£g_id
, 
upd©e_mb_idx
);

1310 
˝_job
->
d°_ªgi⁄
[*
d°_cou¡
].
cou¡
 = 
SRC_SECTORS_PER_PAGE
;

1312 
˝_job
->
∑ge
 = 
˝_job_group
->
d°_ømbuf
->
∑ges
[(
upd©e_mb_idx
%
STRIPE_SZ
)];

1313 (*
d°_cou¡
)++;

1315 if(
vi˘im_mb
 && 
su≥r
->
∑øm
.
gc_wôh_dútysync
 && 
	`ã°_bô
(
MB_DIRTY
, &vi˘im_mb->
mb_Êags
)){

1316 
˝_job
->
d°_ªgi⁄
[*
d°_cou¡
].
bdev
 = 
su≥r
->
dev_öfo
.
‹igö_dev
->bdev;

1317 
˝_job
->
d°_ªgi⁄
[*
d°_cou¡
].
£˘‹
 = 
vi˘im_mb
->sector;

1318 
˝_job
->
d°_ªgi⁄
[*
d°_cou¡
].
cou¡
 = 
SRC_SECTORS_PER_PAGE
;

1319 (*
d°_cou¡
)++;

1322 
˝_job
->
d°_cou¡
 = *dst_count;

1324 
	`©omic64_öc
(&
su≥r
->
w°©
.
gc_io_cou¡
);

1327  
NULL
;

1328 
	}
}

1332 
	$make_gc_summ¨y_job
(
dm§c_su≥r
 *
su≥r
,

1333 
c›y_job_group
 *
˝_job_group
,

1334 
mëablock
 *
d°_mb
,

1335 
ˇche_ty≥
)

1337 
migøti⁄_m™agî
 *
migøã_mgr
 = &
su≥r
->migrate_mgr;

1338 
d°_cou¡
 = 0;

1339 
i
 = 0;

1341 if(
	`√ed_chunk_summ¨y
(
su≥r
, 
d°_mb
->
idx
+
NUM_SUMMARY
)){

1343 
i
 = 0;ò< 
NUM_SUMMARY
;i++){

1344 
mëablock
 *
summ¨y_mb
;

1345 
c›y_job
 *
summ¨y_job
;

1346 
u32
 
idx
 = 
d°_mb
->idx + 1 + 
i
;

1348 
summ¨y_mb
 = 
	`mb_©
(
su≥r
, 
idx
);

1350 
summ¨y_job
 = 
	`mempoﬁ_Æloc
(
migøã_mgr
->
c›y_job_poﬁ
, 
GFP_NOIO
);

1351 
	`BUG_ON
(!
summ¨y_job
);

1352 
summ¨y_job
->
§c_mb
 = 
NULL
;

1353 
d°_cou¡
 = 0;

1354 
	`make_gc_job
(
su≥r
, 
˝_job_group
, 
summ¨y_job
, 
NULL
, 
summ¨y_mb
, &
d°_cou¡
, 
ˇche_ty≥
);

1356 
summ¨y_job
->
d°_cou¡
 = dst_count;

1358 
	`li°_add_èû
(&
summ¨y_job
->
˝_li°
, &
˝_job_group
->
˝_hód
);

1362  
i
;

1363 
	}
}

1367 
	$ªÀa£_vi˘im_£g
(
dm§c_su≥r
 *
su≥r
, 
migøti⁄_m™agî
 *
migøã_mgr
){

1368 
£gmít_hódî
 *
£g
, *
tmp
;

1369 
f
;

1371 if(
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_queue_cou¡
))

1372 
	`¥ötk
(" Rñó£ vi˘im seg = %d \n", 
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_queue_cou¡
));

1374 
	`li°_f‹_óch_íåy_ß„
(
£g
, 
tmp
, &
migøã_mgr
->
migøã_queue
, 
migøã_li°
) {

1375 if(
migøã_mgr
->
gc_cur_£g
 !
£g
){

1376 
	`li°_dñ
(&
£g
->
migøã_li°
);

1377 
	`©omic_dec
(&
su≥r
->
migøã_mgr
.
migøã_queue_cou¡
);

1378 
	`©omic_dec
(&
migøã_mgr
->
mig_öÊights
);

1380 
	`¥ötk
("Ññó£ vi˘im seg, mig inÊighà%d\n", 
	`©omic_ªad
(&
migøã_mgr
->
mig_öÊights
));

1382 
	`move_£g_migøã_to_£Æed_queue
(
su≥r
, 
£g
);

1383 
	`LOCK
(
su≥r
, 
f
);

1384 
	`˛ór_bô
(
SEG_MIGRATING
, &
£g
->
Êags
);

1385 
	`UNLOCK
(
su≥r
, 
f
);

1387 
	`¥ötk
(" same .. \n");

1388 
	`BUG_ON
(1);

1392 if(
migøã_mgr
->
gc_cur_£g
){

1393 
£g
 = 
migøã_mgr
->
gc_cur_£g
;

1395 
	`©omic_ªad
(&
£g
->
num_migios
)){

1396 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(2000));

1397 
	`¥ötk
(" waitÇum migios ... \n");

1405 if(!
	`ã°_bô
(
SEG_MIGRATING
, &
£g
->
Êags
)){

1406 
	`¥ötk
(" invalid state .. \n");

1407 
	`BUG_ON
(1);

1410 
	`¥ötk
("Ñña£ g¯cu∏£g = %d \n", ()
£g
->
£g_id
);

1411 
	`BUG_ON
(1);

1412 
	`move_£g_migøã_to_£Æed_queue
(
su≥r
, 
£g
);

1413 
	`LOCK
(
su≥r
, 
f
);

1414 
	`˛ór_bô
(
SEG_MIGRATING
, &
£g
->
Êags
);

1415 
	`UNLOCK
(
su≥r
, 
f
);

1417 
migøã_mgr
->
gc_cur_£g
 = 
NULL
;

1418 
migøã_mgr
->
gc_cur_off£t
 = 0;

1422 
	}
}

1424 
	$gë_√xt_vi˘im_£g
(
dm§c_su≥r
 *
su≥r
, 
migøti⁄_m™agî
 *
migøã_mgr
){

1425 if(
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_queue_cou¡
))

1426 
migøã_mgr
->
gc_cur_£g
 = 
	`li°_fú°_íåy
(&migøã_mgr->
migøã_queue
, 
£gmít_hódî
, 
migøã_li°
);

1428 
migøã_mgr
->
gc_cur_£g
 = 
NULL
;

1430 
migøã_mgr
->
gc_cur_off£t
 = 0;

1431 
migøã_mgr
->
gc_Æloc_cou¡
 = 0;

1432 if(
migøã_mgr
->
gc_cur_£g
){

1433 
u32
 
vÆid_cou¡
;

1434 
	`li°_dñ
(&
migøã_mgr
->
gc_cur_£g
->
migøã_li°
);

1435 
	`©omic_dec
(&
su≥r
->
migøã_mgr
.
migøã_queue_cou¡
);

1436 
	`©omic_£t
(&
migøã_mgr
->
gc_cur_£g
->
num_migios
, 0);

1438 
vÆid_cou¡
 = 
	`ˇlc_vÆid_cou¡
(
su≥r
, 
migøã_mgr
->
gc_cur_£g
, 1);

1439 
	`©omic64_add
(
vÆid_cou¡
*100/
STRIPE_SZ
, &
su≥r
->
w°©
.
vi˘im_utû
);

1440 
	`©omic64_öc
(&
su≥r
->
w°©
.
vi˘im_cou¡
);

1445 
	}
}

1447 
mëablock
 *
	$gë_√xt_vi˘im_mb
(
dm§c_su≥r
 *
su≥r
,

1448 
migøti⁄_m™agî
 *
migøã_mgr
,

1449 
u£_gc
){

1450 
£gmít_hódî
 *
£g
 = 
migøã_mgr
->
gc_cur_£g
;

1451 
mëablock
 *
vi˘im_mb
 = 
NULL
;

1452 
i
;

1454 if(
migøã_mgr
->
gc_cur_£g
==
NULL
)

1455  
NULL
;

1457 if(
migøã_mgr
->
gc_cur_off£t
 >
STRIPE_SZ
){

1458 
migøã_mgr
->
gc_cur_£g
 = 
NULL
;

1459 if(
	`©omic_ªad
(&
£g
->
num_migios
)==0){

1460 if(!
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
)){

1461 
	`föÆize_˛ón_£g
(
su≥r
, 
£g
, 1);

1463 
	`¥ötk
(" WARN: cleanÉmpty seg .. \n");

1466  
NULL
;

1469 
i
 = 
migøã_mgr
->
gc_cur_off£t
;ò< 
STRIPE_SZ
;i++){

1471 
vi˘im_mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
i
);

1473 if(!
	`check_vÆid√ss
(
su≥r
, 
£g
, 
vi˘im_mb
, 
u£_gc
))

1476 if(
vi˘im_mb
->
£˘‹
==~0)

1479 
migøã_mgr
->
gc_cur_off£t
 = 
i
 + 1;

1480 
migøã_mgr
->
gc_Æloc_cou¡
++;

1481  
vi˘im_mb
;

1483 if(
	`©omic_ªad
(&
£g
->
num_migios
)==0){

1484 if(!
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
)){

1485 
	`föÆize_˛ón_£g
(
su≥r
, 
£g
, 1);

1487 
	`¥ötk
(" WARN: cleanÉmpty seg .. \n");

1491  
NULL
;

1493 
	}
}

1496 
	$make_kc›yd_job
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
mig_job
 *
mg_job
, 
u£_gc
){

1497 
c›y_job_group
 *
˝_job_group
;

1498 
c›y_job
 *
˝_job
;

1499 
i
, 
issue_cou¡
 = 0;

1500 
ˇche_ty≥
;

1501 
migøti⁄_m™agî
 *
migøã_mgr
 = &
su≥r
->migrate_mgr;

1503 if(
£g
->
£g_ty≥
==
WCBUF
 || seg->£g_ty≥==
WHBUF
)

1504 
ˇche_ty≥
 = 
GWBUF
;

1506 
ˇche_ty≥
 = 
GRBUF
;

1508 if(
su≥r
->
∑øm
.
gc_wôh_dútysync
)

1509 
ˇche_ty≥
 = 
GRBUF
;

1511 
issue_cou¡
 = 
	`ˇlc_vÆid_cou¡
(
su≥r
, 
£g
, 
u£_gc
);

1512 if(!
issue_cou¡
){

1513 
	`¥ötk
(" InvÆid issuêcou¡ = %d \n", 
issue_cou¡
);

1514 
	`BUG_ON
(1);

1515  
issue_cou¡
;

1518 
	`©omic64_add
(
issue_cou¡
, &(
mg_job
->
cou¡
));

1520 
˝_job_group
 = 
mg_job
->cp_job_group;

1522 
i
 = 0; i < 
STRIPE_SZ
; i++) {

1523 
mëablock
 *
vi˘im_mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
i
);

1524 
d°_cou¡
 = 0;

1525 
hŸ_gc
 = 0;

1527 if(!
	`check_vÆid√ss
(
su≥r
, 
£g
, 
vi˘im_mb
, 
u£_gc
, &
hŸ_gc
))

1530 if(
vi˘im_mb
->
£˘‹
==~0)

1533 
cou¡
 = 
	`ma_gë_cou¡
(
su≥r
, 
ˇche_ty≥
);

1534 if(
	`√ed_ª‰esh_£gmít
(
su≥r
, 
ˇche_ty≥
, 
cou¡
)){

1535 
	`¥ötk
("Ço block in gc buf .. \n");

1536 
	`BUG_ON
(0);

1538 
	`©omic_öc
(&
£g
->
num_migios
);

1540 
˝_job
 = 
	`mempoﬁ_Æloc
(
migøã_mgr
->
c›y_job_poﬁ
, 
GFP_NOIO
);

1541 !
˝_job
){

1542 
	`¥ötk
(" copy jobÖoolÉrror \n");

1543 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1));

1544 
˝_job
 = 
	`mempoﬁ_Æloc
(
migøã_mgr
->
c›y_job_poﬁ
, 
GFP_NOIO
);

1547 
˝_job
->
mg_job
 = mg_job;

1548 
˝_job
->
gc
 = 
hŸ_gc
;

1549 
˝_job
->
§c_mb
 = 
vi˘im_mb
;

1550 
˝_job
->
§c_ªgi⁄
.
bdev
 = 
	`gë_bdev
(
su≥r
, 
i
);

1551 
˝_job
->
§c_ªgi⁄
.
£˘‹
 = 
	`gë_£˘‹
(
su≥r
, 
£g
->
£g_id
, 
i
);

1552 
˝_job
->
§c_ªgi⁄
.
cou¡
 = 
SRC_SECTORS_PER_PAGE
;

1554 
d°_cou¡
 = 0;

1555 if(!
hŸ_gc
){

1556 
	`make_de°age_job
(
su≥r
, 
˝_job
, 
vi˘im_mb
, 
d°_cou¡
);

1557 
d°_cou¡
++;

1559 
mëablock
 *
d°_mb
 = 
	`Æloc_mb_gc
(
su≥r
, 
vi˘im_mb
, 
ˇche_ty≥
);

1560 
	`make_gc_job
(
su≥r
, 
˝_job
, 
vi˘im_mb
, 
d°_mb
, &
d°_cou¡
, 
ˇche_ty≥
);

1563 
˝_job
->
d°_cou¡
 = dst_count;

1564 
	`li°_add_èû
(&
˝_job
->
˝_li°
, &
˝_job_group
->
˝_hód
);

1570  
issue_cou¡
;

1571 
	}
}

1575 
	$åy_ª£rve_£gmít_f‹_gc
(
dm§c_su≥r
 *
su≥r
){

1576 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

1577 
	`ªÀa£_ª£rve_£gs
(
su≥r
);

1579 
ª£rve_d⁄e
;

1580 
	`©omic_ªad
(&
£g_Æloˇt‹
->
Æloc_cou¡
)<
MIN_FREE
)

1581 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(10));

1583 
	`BUG_ON
(
	`©omic_ªad
(&
£g_Æloˇt‹
->
Æloc_cou¡
)<
MIN_FREE
);

1585 if(
	`©omic_ªad
(&
£g_Æloˇt‹
->
Æloc_cou¡
)<5)

1586 
ª£rve_d⁄e
 = 
	`ª£rve_ª£rve_£gs
(
su≥r
, 
	`©omic_ªad
(&
£g_Æloˇt‹
->
Æloc_cou¡
));

1588 
ª£rve_d⁄e
 = 
	`ª£rve_ª£rve_£gs
(
su≥r
, 5);

1590 if(
ª£rve_d⁄e
){

1593 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(10));

1594 
	`¥ötk
(" Iàˇ¬ŸÑe£rvê£gmít†f‹ GC fªê%d \n", ()
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
Æloc_cou¡
));

1596 
	}
}

1600 
	$£À˘_em±y_£gs
(
dm§c_su≥r
 *
su≥r
){

1601 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

1602 
li°_hód
 *
£Æed_queue
 = &
£g_Æloˇt‹
->
£g_£Æed_queue
;

1603 
£gmít_hódî
 *
£g
;

1604 
Êags
;

1605 
ªcou¡
 = 0;

1606 
lo›
 = 0;

1608 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

1610 !
	`li°_em±y
(
£Æed_queue
)){

1611 
£g
 = (
£gmít_hódî
 *)

1612 
	`li°_íåy
(
£Æed_queue
->
¥ev
, 
£gmít_hódî
, 
Æloc_li°
);

1614 if(
	`is_em±y_£g
(
su≥r
, 
£g
)){

1615 
	`li°_add_èû
(&
£g
->
migøã_li°
, &
su≥r
->
migøã_mgr
.
migøã_queue
);

1616 
	`©omic_öc
(&
su≥r
->
migøã_mgr
.
migøã_queue_cou¡
);

1617 
	`move_£g_£Æed_to_migøã_queue
(
su≥r
, 
£g
, 0);

1618 
ªcou¡
++;

1621 if(
ªcou¡
>=
MIGRATE_HIGHWATER
)

1624 if(++
lo›
>=
£g_Æloˇt‹
->
£g_£Æed_cou¡
)

1628 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

1632  
ªcou¡
;

1633 
	}
}

1635 
	$˛ón_em±y_£g
(
dm§c_su≥r
 *
su≥r
, 
u£_gc
){

1636 
migøti⁄_m™agî
 *
migøã_mgr
 = &
su≥r
->migrate_mgr;

1637 
£gmít_hódî
 *
£g
, *
tmp
;

1638 
issue_cou¡
 = 0;

1639 
bug_cou¡
 = 0;

1641 if(!
	`£À˘_em±y_£gs
(
su≥r
))

1644 
	`li°_f‹_óch_íåy_ß„
(
£g
, 
tmp
, &
migøã_mgr
->
migøã_queue
, 
migøã_li°
) {

1645 
f
;

1647 if(
	`ã°_bô
(
SEG_MIGRATING
, &
£g
->
Êags
)){

1648 
	`¥ötk
(" seg i†migøtög ... seg %d \n", ()
£g
->
£g_id
);

1649 
	`BUG_ON
(1);

1651 
	`LOCK
(
su≥r
, 
f
);

1652 
	`£t_bô
(
SEG_MIGRATING
, &
£g
->
Êags
);

1653 
	`©omic_£t
(&
£g
->
num_migios
, 0);

1654 
	`UNLOCK
(
su≥r
, 
f
);

1656 
	`©omic_ªad
(&
£g
->
num_ªad_öÊight
) ||

1657 
	`©omic_ªad
(&
£g
->
num_fûlög
) )

1659 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(500000));

1660 
	`¥ötk
(" seg = %d inflight %d filling = %d\n",

1661 ()
£g
->
£g_id
,

1662 
	`©omic_ªad
(&
£g
->
num_ªad_öÊight
)

1663 ,
	`©omic_ªad
(&
£g
->
num_fûlög
));

1665 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(100));

1668 
issue_cou¡
 = 
	`ˇlc_vÆid_cou¡
(
su≥r
, 
£g
, 
u£_gc
);

1669 if(!
issue_cou¡
){

1670 if(
	`is_em±y_£g
(
su≥r
, 
£g
)){

1671 
	`©omic_öc
(&
su≥r
->
w°©
.
gc_em±y_cou¡
);

1673 
	`föÆize_˛ón_£g
(
su≥r
, 
£g
, 1);

1674 
	`li°_dñ
(&
£g
->
migøã_li°
);

1675 
	`©omic_dec
(&
migøã_mgr
->
migøã_queue_cou¡
);

1677 
	`¥ötk
("Ço issue count butÇotÉmpty seg ... \n");

1678 
	`BUG_ON
(1);

1681 
	`¥ötk
(" seg isÇotÉmpty \n");

1682 
	`BUG_ON
(1);

1683 
	`©omic_öc
(&
migøã_mgr
->
mig_öÊights
);

1689 
	`BUG_ON
(++
bug_cou¡
==100000000);

1692 
	}
}

1695 
	$__issue_mig_kc›yd
(
dm§c_su≥r
 *
su≥r
, 
c›y_job_group
 *
˝_job_group
, 
ˇche_ty≥
, 
u£_gc
, 
num_c›y_block
){

1696 
migøti⁄_m™agî
 *
migøã_mgr
 = &
su≥r
->migrate_mgr;

1697 
tŸÆ_cou¡
 = 0;

1701 
mëablock
 *
vi˘im_mb
 = 
NULL
;

1702 
£gmít_hódî
 *
vi˘im_£g
 = 
NULL
;

1703 
c›y_job
 *
˝_job
;

1705 !
vi˘im_mb
){

1706 
vi˘im_mb
 = 
	`gë_√xt_vi˘im_mb
(
su≥r
, &su≥r->
migøã_mgr
, 
u£_gc
);

1707 if(!
vi˘im_mb
){

1708 
	`gë_√xt_vi˘im_£g
(
su≥r
, &su≥r->
migøã_mgr
);

1709 if(!
migøã_mgr
->
gc_cur_£g
){

1711 
NO_VICTIM
;

1716 
vi˘im_£g
 = 
	`gë_£g_by_mb
(
su≥r
, 
vi˘im_mb
);

1717 if(!
	`check_vÆid√ss
(
su≥r
, 
vi˘im_£g
, 
vi˘im_mb
, 
u£_gc
Ë|| vi˘im_mb->
£˘‹
==~0){

1718 
	`¥ötk
(" invalid victim ... \n");

1719 
	`BUG_ON
(1);

1723 if(!
	`ã°_bô
(
MB_DIRTY
, &
vi˘im_mb
->
mb_Êags
)){

1726 
ˇche_m™agî
 *
˛ón_ˇche
 = 
su≥r
->
˛ón_døm_ˇche_m™agî
;

1727 
Ãu_node
 *
 
 = 
NULL
;

1728 
Ãu_Êags
;

1729 
f
;

1730 
£Æed
 = 0, 
locked
 = 0, 
˙_Æloc_by_gc
 = 0;

1731 
Æloc
 = 0;

1734 
	`LOCK
(
su≥r
, 
f
);

1735 
	`•ö_lock_úqßve
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

1736 
 
 = 
	`CACHE_SEARCH
(
˛ón_ˇche
, 
vi˘im_mb
->
£˘‹
);

1738 if(
 
){

1739 
	`¥ötk
(" WARN: clean data hitÇ cleanÑam during GC \n");

1742 #ifde‡
HOT_DATA_COPY


1743 if(!
 
 && 
	`ã°_bô
(
MB_HIT
, &
vi˘im_mb
->
mb_Êags
)){

1745 if(!
 
){

1747 if(
˛ón_ˇche
->
cm_‰ì
){

1748 
 
 = 
	`CACHE_ALLOC
(
˛ón_ˇche
,Ün, 
vi˘im_mb
->
£˘‹
);

1749 
	`CACHE_INSERT
(
˛ón_ˇche
, 
 
);

1750 
	`©omic_£t
(&
 
->
£Æed
, 0);

1751 
	`©omic_£t
(&
 
->
locked
, 0);

1752 
 
->
˙_Æloc_by_gc
 = 1;

1753 
Æloc
 = 1;

1757 
	`övÆid©e_¥evious_ˇche
(
su≥r
, 
vi˘im_£g
, 
vi˘im_mb
);

1759 if(
 
){

1760 
£Æed
 = 
	`©omic_ªad
(&
 
->sealed);

1761 
locked
 = 
	`©omic_ªad
(&
 
->locked);

1762 
˙_Æloc_by_gc
 = 
 
->cn_alloc_by_gc;

1765 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

1766 
	`UNLOCK
(
su≥r
, 
f
);

1768 if(!
 
){

1774 if(!
Æloc
){

1775 
	`¥ötk
(" WARN: dram hit ... during GC sector = %d sealed = %dÜocked = %d,álloc by gc = %d \n",

1776 ()
vi˘im_mb
->
£˘‹
, 
£Æed
, 
locked
, 
˙_Æloc_by_gc
);

1781 
	`©omic_öc
(&
vi˘im_£g
->
num_migios
);

1783 
˝_job
 = 
	`mempoﬁ_Æloc
(
migøã_mgr
->
c›y_job_poﬁ
, 
GFP_NOIO
);

1784 !
˝_job
){

1785 
	`¥ötk
(" copy jobÖoolÉrror \n");

1786 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1));

1787 
˝_job
 = 
	`mempoﬁ_Æloc
(
migøã_mgr
->
c›y_job_poﬁ
, 
GFP_NOIO
);

1789 
	`©omic_öc
(&
migøã_mgr
->
c›y_job_cou¡
);

1791 
˝_job
->
§c_mb
 = 
vi˘im_mb
;

1792 
˝_job
->
§c_ªgi⁄
.
bdev
 = 
	`gë_bdev
(
su≥r
, 
vi˘im_mb
->
idx
);

1793 
˝_job
->
§c_ªgi⁄
.
£˘‹
 = 
	`gë_£˘‹
(
su≥r
, 
vi˘im_£g
->
£g_id
, 
vi˘im_mb
->
idx
);

1794 
˝_job
->
§c_ªgi⁄
.
cou¡
 = 
SRC_SECTORS_PER_PAGE
;

1796 
	`li°_add_èû
(&
˝_job
->
˝_li°
, &
˝_job_group
->
˝_hód
);

1798 
˝_job
->
∑ge
 = 
	`Æloc_sögÀ_∑ge
(
su≥r
);

1799 if(
˝_job
->
∑ge
==
NULL
){

1800 
	`¥ötk
(" WARN:ÇoÑambuffer isállocated ... \n");

1801 
	`BUG_ON
(1);

1804 if(
u£_gc
){

1805 
˝_job
->
d°_mb
 = 
NULL
;

1806 
˝_job
->
d°_ªgi⁄
[0].
bdev
 = 
NULL
;

1807 
˝_job
->
d°_cou¡
 = 0;

1809 
˝_job
->
d°_ªgi⁄
[0].
bdev
 = 
su≥r
->
dev_öfo
.
‹igö_dev
->bdev;

1810 
˝_job
->
d°_ªgi⁄
[0].
£˘‹
 = 
vi˘im_mb
->sector;

1811 
˝_job
->
d°_ªgi⁄
[0].
cou¡
 = 
SRC_SECTORS_PER_PAGE
;

1812 
˝_job
->
d°_cou¡
 = 1;

1815 
tŸÆ_cou¡
++;

1816 if(
tŸÆ_cou¡
>=
num_c›y_block
)

1820 
NO_VICTIM
:

1826  
tŸÆ_cou¡
;

1827 
	}
}

1830 
	$issue_mig_kc›yd
(
dm§c_su≥r
 *
su≥r
, 
u£_gc
){

1831 
migøti⁄_m™agî
 *
migøã_mgr
 = &
su≥r
->migrate_mgr;

1832 
£gmít_hódî
 *
£g
, *
tmp
;

1833 
c›y_job_group
 *
˝_job_group
;

1834 
f
;

1835 
issue_cou¡
 = 0;

1836 
tŸÆ_cou¡
 = 0;

1837 
tŸÆ_cou¡2
 = 0;

1838 
bug_cou¡
 = 0;

1839 
ˇche_ty≥
;

1841 
tŸÆ_cou¡
 = 0;

1843 if(!
	`©omic_ªad
(&
migøã_mgr
->
migøã_queue_cou¡
)){

1844 
	`¥ötk
(" invalid victim count ... \n");

1845 
	`BUG_ON
(1);

1849 
	`li°_f‹_óch_íåy_ß„
(
£g
, 
tmp
, &
migøã_mgr
->
migøã_queue
, 
migøã_li°
) {

1850 
f
;

1856 
	`BUG_ON
(!
	`ã°_bô
(
SEG_MIGRATING
, &
£g
->
Êags
));

1858 
	`LOCK
(
su≥r
, 
f
);

1859 
	`£t_bô
(
SEG_MIGRATING
, &
£g
->
Êags
);

1860 
	`©omic_£t
(&
£g
->
num_migios
, 0);

1862 
	`©omic_ªad
(&
£g
->
num_ªad_öÊight
Ë||átomic_ªad(&£g->
num_fûlög
)){

1863 
	`UNLOCK
(
su≥r
, 
f
);

1864 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

1865 
	`¥ötk
(" seg = %d inflight %d filling = %d \n",

1866 ()
£g
->
£g_id
, 
	`©omic_ªad
(&£g->
num_ªad_öÊight
)

1867 ,
	`©omic_ªad
(&
£g
->
num_fûlög
));

1868 
	`LOCK
(
su≥r
, 
f
);

1870 
	`UNLOCK
(
su≥r
, 
f
);

1873 
issue_cou¡
 = 
	`ˇlc_vÆid_cou¡
(
su≥r
, 
£g
, 
u£_gc
);

1878 if(!
issue_cou¡
){

1879 if(
	`is_em±y_£g
(
su≥r
, 
£g
, 
u£_gc
)){

1881 
	`föÆize_˛ón_£g
(
su≥r
, 
£g
, 1);

1882 
	`li°_dñ
(&
£g
->
migøã_li°
);

1883 
	`©omic_dec
(&
migøã_mgr
->
migøã_queue_cou¡
);

1885 
	`¥ötk
(" VÆid = %d\n", 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
));

1886 
	`¥ötk
(" VÆid dúty = %d\n", 
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
));

1887 
	`¥ötk
(" VÆid cÀ™ = %d\n", 
	`©omic_ªad
(&
£g
->
vÆid_˛ón_cou¡
));

1888 
	`¥ötk
("Ço issue count butÇotÉmpty seg ... \n");

1889 
	`BUG_ON
(1);

1892 
	`©omic_öc
(&
migøã_mgr
->
mig_öÊights
);

1894 
tŸÆ_cou¡
 +
issue_cou¡
;

1899 
	`BUG_ON
(++
bug_cou¡
==100000000);

1902 
ˇche_ty≥
 = 
WCBUF
;

1905 if(!
tŸÆ_cou¡
 ||

1906 (
tŸÆ_cou¡
 < 
STRIPE_SZ
-
	`gë_mëad©a_cou¡
(
su≥r
, 
ˇche_ty≥
)

1907 && 
	`gë_Æloc_cou¡
(
su≥r
Ë> 
MIGRATE_LOWWATER
) ){

1916 if(!
tŸÆ_cou¡
){

1929 if(!
	`©omic_ªad
(&
migøã_mgr
->
migøã_queue_cou¡
)){

1930 
	`ªÀa£_vi˘im_£g
(
su≥r
, 
migøã_mgr
);

1931 
	`¥ötk
(" invalid victim count 3... \n");

1949 
tŸÆ_cou¡
){

1950 
˝_job_group
 = 
	`Æloc_c›y_job_group
(
su≥r
, 
ˇche_ty≥
);

1951 
˝_job_group
->
gc
 = 
u£_gc
;

1953 
	`LOCK
(
su≥r
, 
f
);

1954 
˝_job_group
->
d°_£g
 = 
su≥r
->
cuºít_£g
[
ˇche_ty≥
];

1955 
˝_job_group
->
d°_ømbuf
 = 
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
ˇche_ty≥
];

1956 
˝_job_group
->
rw
 = 
READ
;

1957 
	`UNLOCK
(
su≥r
, 
f
);

1959 
tŸÆ_cou¡2
 = 
	`__issue_mig_kc›yd
(
su≥r
, 
˝_job_group
, 
ˇche_ty≥
, 
u£_gc
,

1960 
	`gë_d©a_max_cou¡
(
su≥r
, 
ˇche_ty≥
));

1961 
tŸÆ_cou¡
 -
tŸÆ_cou¡2
;

1963 if(
tŸÆ_cou¡2
){

1964 
	`Êush_kc›y_job
(
su≥r
, 
˝_job_group
);

1966 
	`¥ötk
("Çÿvi˘im cou¡ = %d,ÅŸÆ = %d \n",
tŸÆ_cou¡2
, 
tŸÆ_cou¡
);

1967 
	`mempoﬁ_‰ì
(
˝_job_group
, 
migøã_mgr
->
group_job_poﬁ
);

1968 
	`©omic_dec
(&
migøã_mgr
->
group_job_cou¡
);

1970 if(
tŸÆ_cou¡2
==0){

1971 
	`¥ötk
("ÅŸÆ cou¡ = %d \n",
tŸÆ_cou¡
);

1984 
	`gë_√xt_vi˘im_£g
(
su≥r
, &su≥r->
migøã_mgr
);

1985 if(
migøã_mgr
->
gc_cur_£g
){

1986 
	`¥ötk
("Ço victim segs 2... \n");

1987 
	`BUG_ON
(1);

1989 
	`ªÀa£_vi˘im_£g
(
su≥r
, 
migøã_mgr
);

1991 
	}
}

1993 
	$föÆize_˛ón_£g
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
˛ónup
){

1994 
size_t
 
n1
 = 1;

1995 
f
;

1996 
u32
 
‰ì_£g_cou¡
;

1998 
	`©omic_ªad
(&
£g
->
num_ªad_öÊight
)) {

1999 
	`WBWARN
("Finalize clean seg: inflight iosÑemained for current seg");

2000 
	`BUG_ON
(1);

2001 
n1
++;

2002 i‡(
n1
%10000==0){

2003 
	`WBWARN
("Finalize clean seg: inflight iosÑemained for current seg");

2004 
n1
 = 0;

2006 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(1));

2009 
	`LOCK
(
su≥r
, 
f
);

2015 if(
˛ónup
)

2016 
	`˛ónup_£gmít
(
su≥r
, 
£g
);

2017 
	`disˇrd_ˇches_ö£g
(
su≥r
, 
£g
);

2019 
	`UNLOCK
(
su≥r
, 
f
);

2021 
	`£t_bô
(
SEG_CLEAN
, &
£g
->
Êags
);

2022 
	`˛ór_bô
(
SEG_MIGRATING
, &
£g
->
Êags
);

2023 
	`˛ór_bô
(
SEG_SEALED
, &
£g
->
Êags
);

2030 
	`move_£g_migøã_to_Æloc_queue
(
su≥r
, 
£g
);

2031 
‰ì_£g_cou¡
 = 
	`£gmít_group_öc_‰ì_£gs
(
su≥r
, 
£g
);

2032 if(
‰ì_£g_cou¡
 =
SEGMENT_GROUP_SIZE
){

2034 
	`move_group_migøã_to_Æloc_queue
(
su≥r
, 
£g
->
group
);

2037 if(!
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
background_gc_⁄
)){

2038 if(
	`gë_Æloc_cou¡
(
su≥r
Ë>
MIGRATE_HIGHWATER
 &&

2039 
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
group_Æloc_cou¡
)>=1){

2041 if(
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
)){

2042 
	`©omic_£t
(&
su≥r
->
migøã_mgr
.
background_gc_⁄
, 0);

2043 
	`©omic_£t
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
, 0);

2047 if(
	`gë_Æloc_cou¡
(
su≥r
Ë>
MIGRATE_HIGHWATER
*4){

2048 
	`¥ötk
(" >>>> Back GC: fªê£g cou¡ = %d \n", 
	`gë_Æloc_cou¡
(
su≥r
));

2049 if(
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
)){

2050 
	`©omic_£t
(&
su≥r
->
migøã_mgr
.
background_gc_⁄
, 0);

2051 
	`©omic_£t
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
, 0);

2057 
	`≥ndög_w‹kî_scheduÀ
(
su≥r
);

2058 
	}
}

2060 
	$£g_˛ór_hô_bôs
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

2061 
mëablock
 *
mb
;

2062 
i
;

2064 
i
 = 0;ò< 
STRIPE_SZ
;i++){

2065 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
i
);

2066 if(
	`ã°_bô
(
MB_HIT
, &
mb
->
mb_Êags
)){

2067 
	`˛ór_bô
(
MB_HIT
, &
mb
->
mb_Êags
);

2068 
	`©omic_dec
(&
£g
->
hŸ_cou¡
);

2071 
	}
}

2074 
	$gë_d©a_size_ö_°rùe
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

2075 
mö
;

2077 if(
SUMMARY_SCHEME
==
SUMMARY_PER_CHUNK
){

2078 if(
ˇche_ty≥
==
WCBUF
 || cache_ty≥==
WHBUF
)

2079 
mö
 = 
STRIPE_SZ
;

2081 
mö
 = 
STRIPE_SZ
;

2083 if(
ˇche_ty≥
==
WCBUF
 || cache_ty≥==
WHBUF
)

2084 
mö
 = 
STRIPE_SZ
;

2086 
mö
 = 
STRIPE_SZ
;

2089  
mö
;

2091 
	}
}

2095 
£gmít_hódî
 *
	$£À˘_vi˘im_gªedy_cﬁd
(
dm§c_su≥r
 *
su≥r
, 
u£_gc
){

2096 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

2097 
£gmít_hódî
 *
£g
, *
mö_£g
 = 
NULL
;

2098 
u32
 
mö
 = 0;

2101 
	`li°_f‹_óch_íåy
(
£g
, &
£g_Æloˇt‹
->
£Æed_queue
, 
Æloc_li°
){

2102 if(
u£_gc
 && 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)>=
	`gë_d©a_size_ö_°rùe
(
su≥r
, seg->
£g_ty≥
))

2105 if(!
	`is_cﬁd_°rùe
(
£g
->
£g_ty≥
))

2108 if(
mö_£g
){

2109 if(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)<
mö
 &&

2110 !
	`ã°_bô
(
SEG_MIGRATING
, &
£g
->
Êags
))

2112 
mö_£g
 = 
£g
;

2113 
mö
 = 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
);

2116 
mö_£g
 = 
£g
;

2117 
mö
 = 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
);

2123  
mö_£g
;

2124 
	}
}

2127 
	$¥öt_vÆid_cou¡
(
dm§c_su≥r
 *
su≥r
){

2128 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

2129 
£gmít_hódî
 *
£g
;

2132 
	`li°_f‹_óch_íåy
(
£g
, &
£g_Æloˇt‹
->
£g_£Æed_queue
, 
Æloc_li°
){

2133 if(!
	`ã°_bô
(
SEG_MIGRATING
, &
£g
->
Êags
))

2134 
	`¥ötk
("Ç‹mÆ seg = %d v¯%d \n", ()
£g
->
£g_id
, 
	`©omic_ªad
(&£g->
vÆid_cou¡
));

2136 
	`¥ötk
(" migøtög seg = %d v¯%d \n", ()
£g
->
£g_id
, 
	`©omic_ªad
(&£g->
vÆid_cou¡
));

2139 
	}
}

2142 
£gmít_hódî
 *
	$£À˘_vi˘im_gªedy
(
dm§c_su≥r
 *
su≥r
, 
u£_gc
){

2143 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

2144 
£gmít_hódî
 *
£g
, *
mö_£g
 = 
NULL
;

2145 
u32
 
mö
 = 0;

2147 
	`li°_f‹_óch_íåy
(
£g
, &
£g_Æloˇt‹
->
£Æed_queue
, 
Æloc_li°
){

2148 if(
u£_gc
 && 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)>=
	`gë_d©a_size_ö_°rùe
(
su≥r
, seg->
£g_ty≥
))

2151 if(
	`ã°_bô
(
SEG_MIGRATING
, &
£g
->
Êags
))

2154 if(
mö_£g
){

2155 if(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)<
mö
 &&

2156 !
	`ã°_bô
(
SEG_MIGRATING
, &
£g
->
Êags
))

2158 
mö_£g
 = 
£g
;

2159 
mö
 = 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
);

2162 
mö_£g
 = 
£g
;

2163 
mö
 = 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
);

2169  
mö_£g
;

2170 
	}
}

2173 
group_hódî
 *
	$£À˘_vi˘im_fifo
(
dm§c_su≥r
 *
su≥r
, 
u£_gc
){

2174 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

2175 
group_hódî
 *
group
, *
mö_group
 = 
NULL
;

2176 
u32
 
mö
 = 0;

2178 
	`li°_f‹_óch_íåy
(
group
, &
£g_Æloˇt‹
->
group_£Æed_queue
, 
Æloc_li°
){

2182 
mö_group
 = 
group
;

2183 
mö
 = 
	`©omic_ªad
(&
group
->
vÆid_cou¡
);

2190  
mö_group
;

2191 
	}
}

2193 
group_hódî
 *
	$£À˘_vi˘im_gªedy
(
dm§c_su≥r
 *
su≥r
, 
u£_gc
){

2194 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

2195 
group_hódî
 *
group
, *
mö_group
 = 
NULL
;

2196 
u32
 
mö
 = 0;

2198 
	`li°_f‹_óch_íåy
(
group
, &
£g_Æloˇt‹
->
group_£Æed_queue
, 
Æloc_li°
){

2199 if(
u£_gc
 && 
	`©omic_ªad
(&
group
->
vÆid_cou¡
)>=
STRIPE_SZ
 * 
SEGMENT_GROUP_SIZE
)

2203 if(
mö_group
){

2204 if(
	`©omic_ªad
(&
group
->
vÆid_cou¡
)<
mö
){

2205 
mö_group
 = 
group
;

2206 
mö
 = 
	`©omic_ªad
(&
group
->
vÆid_cou¡
);

2209 
mö_group
 = 
group
;

2210 
mö
 = 
	`©omic_ªad
(&
group
->
vÆid_cou¡
);

2217  
mö_group
;

2218 
	}
}

2225 
	$_£À˘_vi˘im_f‹_£À˘ive_gc
(
dm§c_su≥r
 *
su≥r
, 
num_mig
, *
u£_gc
){

2226 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

2227 
li°_hód
 *
£Æed_queue
 = &
£g_Æloˇt‹
->sealed_queue;

2228 
£gmít_hódî
 *
£g
;

2229 
Êags
;

2230 
ªcou¡
 = 0;

2231 
lo›
 = 0;

2233 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

2235 !
	`li°_em±y
(
£Æed_queue
)){

2236 
u32
 
mö
;

2237 
boﬁ
 
hô
 = 
Ál£
;

2238 
boﬁ
 
c⁄dôi⁄
 = 
Ál£
;

2240 
£g
 = (
£gmít_hódî
 *)

2241 
	`li°_íåy
(
£Æed_queue
->
¥ev
, 
£gmít_hódî
, 
Æloc_li°
);

2243 
mö
 = 
	`gë_d©a_size_ö_°rùe
(
su≥r
, 
£g
->
£g_ty≥
);

2245 
hô
 = 
	`ã°_bô
(
SEG_HIT
, &
£g
->
Êags
);

2246 if(
su≥r
->
∑øm
.
hô_bôm≠_ty≥
==
HIT_BITMAP_PER_STRIPE
){

2247 if(
hô
 && 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
Ë< 
mö
){

2248 
c⁄dôi⁄
 = 
åue
;

2251 if(
hô
 && 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
Ë< 
mö
 &&

2252 
	`©omic_ªad
(&
£g
->
hŸ_cou¡
Ë< 
STRIPE_SZ
/2){

2253 
c⁄dôi⁄
 = 
åue
;

2257 if(
c⁄dôi⁄
){

2258 
	`˛ór_bô
(
SEG_HIT
, &
£g
->
Êags
);

2259 
	`li°_add_èû
(&
£g
->
migøã_li°
, &
su≥r
->
migøã_mgr
.
migøã_queue
);

2260 
	`©omic_öc
(&
su≥r
->
migøã_mgr
.
migøã_queue_cou¡
);

2262 
	`move_£g_£Æed_to_migøã_queue
(
su≥r
, 
£g
, 0);

2263 
ªcou¡
++;

2265 if(
ªcou¡
>=
num_mig
)

2268 if(
hô
){

2269 
	`li°_move
(&
£g
->
Æloc_li°
, 
£Æed_queue
);

2270 
	`˛ór_bô
(
SEG_HIT
, &
£g
->
Êags
);

2271 
	`£g_˛ór_hô_bôs
(
su≥r
, 
£g
);

2277 
lo›
++;

2278 if(
lo›
>=
£g_Æloˇt‹
->
£Æed_cou¡
)

2282 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

2289  
ªcou¡
;

2290 
	}
}

2293 
	$_£À˘_vi˘im_f‹_gc
(
dm§c_su≥r
 *
su≥r
, 
num_mig
, 
£gmít_hódî
 *
£g
){

2294 
tŸÆ_vÆid_cou¡
 = 0;

2296 
	`£t_bô
(
SEG_MIGRATING
, &
£g
->
Êags
);

2298 
	`li°_add_èû
(&
£g
->
migøã_li°
, &
su≥r
->
migøã_mgr
.
migøã_queue
);

2299 
	`©omic_öc
(&
su≥r
->
migøã_mgr
.
migøã_queue_cou¡
);

2300 
	`move_£g_£Æed_to_migøã_queue
(
su≥r
, 
£g
, 0);

2301 
tŸÆ_vÆid_cou¡
 +
	`gë_d©a_vÆid_cou¡
(
su≥r
, 
£g
);

2303  
tŸÆ_vÆid_cou¡
;

2304 
	}
}

2307 
	$£À˘_vi˘im_f‹_gc
(
dm§c_su≥r
 *
su≥r
, 
num_mig
){

2308 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

2309 
li°_hód
 *
£Æed_queue
 = &
£g_Æloˇt‹
->
£g_£Æed_queue
;

2310 
group_hódî
 *
group
 = 
NULL
;

2311 
£gmít_hódî
 *
£g
 = 
NULL
;

2312 
Êags
;

2313 
lo›
 = 0;

2314 
ªcou¡
 = 0;

2315 
tŸÆ_vÆid_cou¡
 = 0;

2316 
u32
 
£g_off£t
 = 0;

2318 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

2320 !
	`li°_em±y
(
£Æed_queue
)){

2323 if(
su≥r
->
∑øm
.
vi˘im_pﬁicy
==
VICTIM_GREEDY
)

2324 
group
 = 
	`£À˘_vi˘im_gªedy
(
su≥r
, 1);

2326 
group
 = 
	`£À˘_vi˘im_fifo
(
su≥r
, 1);

2328 if(
group
==
NULL
){

2329 
	`¥öt_vÆid_cou¡
(
su≥r
);

2330 
	`¥ötk
(" Gªedy: Nÿvi˘im, sñe˘ed vi˘im†%d \n", 
tŸÆ_vÆid_cou¡
);

2331 
NO_VICTIM
;

2333 
	`move_group_£Æed_to_migøã_queue
(
su≥r
, 
group
, 0);

2335 
£g_off£t
 = 0;£g_off£à< 
SEGMENT_GROUP_SIZE
;seg_offset++){

2336 
£g
 = 
	`gë_£gmít_hódî_by_id
(
su≥r
, 
group
->
group_id
 * 
SEGMENT_GROUP_SIZE
 + 
£g_off£t
);

2337 
tŸÆ_vÆid_cou¡
 +
	`_£À˘_vi˘im_f‹_gc
(
su≥r
, 
num_mig
, 
£g
);

2338 
	`BUG_ON
(
£g
->
group
!=group);

2341 
ªcou¡
 +
SEGMENT_GROUP_SIZE
;

2345 if(
tŸÆ_vÆid_cou¡
 >
num_mig
 * 
	`gë_d©a_max_cou¡
(
su≥r
, 
WCBUF
))

2348 
lo›
++;

2349 if(
lo›
>=
£g_Æloˇt‹
->
£g_£Æed_cou¡
)

2352 if(
ªcou¡
 >
num_mig
*2)

2356 
NO_VICTIM
:

2358 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

2363  
ªcou¡
;

2364 
	}
}

2366 
	$£À˘_vi˘im_f‹_gc
(
dm§c_su≥r
 *
su≥r
, 
num_mig
, *
u£_gc
){

2367 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

2368 
li°_hód
 *
£Æed_queue
 = &
£g_Æloˇt‹
->sealed_queue;

2369 
£gmít_hódî
 *
£g
 = 
NULL
;

2370 
Êags
;

2371 
lo›
 = 0;

2372 
tŸÆ_vÆid_cou¡
 = 0;

2373 
ªcou¡
 = 0;

2375 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

2377 !
	`li°_em±y
(
£Æed_queue
)){

2378 
debug_cou¡
 = 0;

2380 
£g
 = 
NULL
;

2381 if(
su≥r
->
∑øm
.
vi˘im_pﬁicy
==
VICTIM_GREEDY
){

2382 
£g
 = 
	`£À˘_vi˘im_gªedy
(
su≥r
, 1);

2383 if(
£g
==
NULL
){

2384 
	`¥öt_vÆid_cou¡
(
su≥r
);

2385 
	`¥ötk
(" Gªedy: Nÿvi˘im, sñe˘ed vi˘im†%d \n", 
ªcou¡
);

2386 
NO_VICTIM
;

2390 if(
£g
==
NULL
)

2391 
£g
 = (
£gmít_hódî
 *)

2392 
	`li°_íåy
(
£Æed_queue
->
¥ev
, 
£gmít_hódî
, 
Æloc_li°
);

2394 
	`£t_bô
(
SEG_MIGRATING
, &
£g
->
Êags
);

2397 
	`©omic_ªad
(&
£g
->
num_ªad_öÊight
Ë||átomic_ªad(&£g->
num_fûlög
)) {

2398 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(100));

2399 
debug_cou¡
++;

2400 if(
debug_cou¡
>10000){

2401 
	`¥ötk
(" wait ... \n");

2402 
debug_cou¡
 = 0;

2407 if(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
Ë< 
	`gë_d©a_size_ö_°rùe
(
su≥r
, seg->
£g_ty≥
)){

2409 
	`li°_add_èû
(&
£g
->
migøã_li°
, &
su≥r
->
migøã_mgr
.
migøã_queue
);

2410 
	`©omic_öc
(&
su≥r
->
migøã_mgr
.
migøã_queue_cou¡
);

2412 
	`move_£g_£Æed_to_migøã_queue
(
su≥r
, 
£g
, 0);

2414 
tŸÆ_vÆid_cou¡
 +
	`gë_d©a_vÆid_cou¡
(
su≥r
, 
£g
);

2416 
	`¥ötk
(" GC %d select victim seg = %dÜength = %d, valid count = %d \n",

2417 
ªcou¡
,

2418 ()
£g
->
£g_id
,

2419 ()
	`©omic_ªad
(&
£g
->
Àngth
),

2420 ()
	`©omic_ªad
(&
£g
->
vÆid_cou¡
));

2422 
	`BUG_ON
(!
	`ã°_bô
(
SEG_MIGRATING
, &
£g
->
Êags
));

2424 
ªcou¡
++;

2426 if(
tŸÆ_vÆid_cou¡
 > 
	`gë_d©a_max_cou¡
(
su≥r
, 
WCBUF
Ë* 
num_mig
){

2431 
	`˛ór_bô
(
SEG_MIGRATING
, &
£g
->
Êags
);

2434 
	`li°_move
(&
£g
->
Æloc_li°
, 
£Æed_queue
);

2437 
lo›
++;

2438 if(
lo›
>=
£g_Æloˇt‹
->
£g_£Æed_cou¡
)

2442 
NO_VICTIM
:

2444 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

2451 
	`¥ötk
(" GC:ÅŸÆ vÆid cou¡ = %d,Çum seg†%d \n", 
tŸÆ_vÆid_cou¡
, 
ªcou¡
);

2453  
ªcou¡
;

2454 
	}
}

2458 
	$£À˘_vi˘im_f‹_de°age
(
dm§c_su≥r
 *
su≥r
, 
num_mig
){

2459 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

2460 
li°_hód
 *
£Æed_queue
 = &
£g_Æloˇt‹
->sealed_queue;

2461 
£gmít_hódî
 *
£g
;

2462 
Êags
;

2463 
ªcou¡
 = 0;

2464 
lo›
 = 0;

2465 
tŸÆ_vÆid_cou¡
 = 0;

2467 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

2469 !
	`li°_em±y
(
£Æed_queue
)){

2471 
£g
 = 
	`£À˘_vi˘im_gªedy_cﬁd
(
su≥r
, 0);

2472 if(!
£g
)

2473 
£g
 = 
	`£À˘_vi˘im_gªedy
(
su≥r
, 0);

2475 if(!
£g
)

2476 
£g
 = (
£gmít_hódî
 *)

2477 
	`li°_íåy
(
£Æed_queue
->
¥ev
, 
£gmít_hódî
, 
Æloc_li°
);

2479 
	`˛ór_bô
(
SEG_HIT
, &
£g
->
Êags
);

2480 
	`£g_˛ór_hô_bôs
(
su≥r
, 
£g
);

2483 
	`£t_bô
(
SEG_MIGRATING
, &
£g
->
Êags
);

2486 
	`©omic_ªad
(&
£g
->
num_ªad_öÊight
Ë||átomic_ªad(&£g->
num_fûlög
)) {

2487 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(100));

2490 
	`¥ötk
(" >>>*** Destage seg = %d valid count = %d \n",

2491 ()
£g
->
£g_id
, ()
	`©omic_ªad
(&£g->
vÆid_cou¡
));

2493 
	`move_£g_£Æed_to_migøã_queue
(
su≥r
, 
£g
, 0);

2494 
	`li°_add_èû
(&
£g
->
migøã_li°
, &
su≥r
->
migøã_mgr
.
migøã_queue
);

2495 
	`©omic_öc
(&
su≥r
->
migøã_mgr
.
migøã_queue_cou¡
);

2497 
tŸÆ_vÆid_cou¡
 +
	`gë_d©a_vÆid_cou¡
(
su≥r
, 
£g
);

2499 
ªcou¡
++;

2501 if((
tŸÆ_vÆid_cou¡
+
	`gë_mëad©a_cou¡
(
su≥r
, 
£g
->
£g_ty≥
))*2 > 
STRIPE_SZ
*2){

2509 if(
ªcou¡
>=
num_mig
)

2514 if(++
lo›
>=
£g_Æloˇt‹
->
£Æed_cou¡
)

2518 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

2522  
ªcou¡
;

2523 
	}
}

2526 
	$£À˘_vi˘im_£gs
(
dm§c_su≥r
 *
su≥r
, 
num_mig
, *
u£_gc
){

2527 
ªcou¡
 = 0;

2529 if(
su≥r
->
∑øm
.
ª˛aim_pﬁicy
==
RECLAIM_SELECTIVE
 || su≥r->∑øm.ª˛aim_pﬁicy==
RECLAIM_GC
){

2531 if(
	`gë_cuº_utû
(
su≥r
Ë>su≥r->
∑øm
.
u_max
)

2532 *
u£_gc
 = 0;

2534 *
u£_gc
 = 1;

2542 }if(
su≥r
->
∑øm
.
ª˛aim_pﬁicy
==
RECLAIM_DESTAGE
){

2543 *
u£_gc
 = 0;

2546 
ªcou¡
 = 
	`£À˘_vi˘im_f‹_gc
(
su≥r
, 
num_mig
);

2548 if(
ªcou¡
){

2549 if(*
u£_gc
){

2550 
	`©omic_add
(
num_mig
, &
su≥r
->
w°©
.
gc_cou¡
);

2552 
	`©omic_add
(
num_mig
, &
su≥r
->
w°©
.
de°age_cou¡
);

2555  
ªcou¡
;

2556 
	}
}

2558 
	$migøã_¥oc
(*
d©a
)

2560 
dm§c_su≥r
 *
su≥r
 = 
d©a
;

2561 
migøti⁄_m™agî
 *
migøã_mgr
 = &
su≥r
->migrate_mgr;

2562 
u32
 
num_mig
 = 0;

2563 
u£_gc
 = 0;

2564 
u32
 
high_w©î
;

2565 
u32
 
gc_buf_max_cou¡
 = 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
tŸÆ_∑ge_cou¡
)/10*5;

2567 
	`¥ötk
(" Migrate daemon has been started .. \n");

2571 if(
	`kthªad_should_°›
())

2574 i‡(!
	`©omic_ªad
(&
migøã_mgr
->
migøã_åiggîed
)||

2575 
	`©omic_ªad
(&
su≥r
->
degøded_mode
) ||

2576 
	`©omic_ªad
(&
su≥r
->
ªsize_mode
))

2578 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(1000));

2582 if(!
	`©omic_ªad
(&
migøã_mgr
->
background_gc_⁄
))

2583 
high_w©î
 = 
MIGRATE_HIGHWATER
;

2585 
high_w©î
 = 
MIGRATE_HIGHWATER
 * 10;

2597 #ifde‡
FORCE_UMAX


2598 if((
	`gë_Æloc_cou¡
(
su≥r
Ë>
high_w©î
 &&

2599 
	`gë_cuº_utû
(
su≥r
Ë<su≥r->
∑øm
.
u_max
) &&

2600 
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
group_Æloc_cou¡
)>1

2603 if(
	`gë_Æloc_cou¡
(
su≥r
Ë>
high_w©î
 &&

2604 
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
group_Æloc_cou¡
)>1

2607 
	`©omic_£t
(&
migøã_mgr
->
background_gc_⁄
, 0);

2608 
	`©omic_£t
(&
migøã_mgr
->
migøã_åiggîed
, 0);

2609 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(50));

2610 
	`¥ötk
(" GC Finished ... 1\n");

2611 
	`≥ndög_w‹kî_scheduÀ
(
su≥r
);

2628 
num_mig
 = 0;

2629 !
num_mig
){

2630 
num_mig
 =

2631 (
gc_buf_max_cou¡
 -

2632 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
gc_a˘ive_∑ge_cou¡
))

2633 / 
	`gë_d©a_max_cou¡
(
su≥r
, 
WCBUF
);

2635 if(!
num_mig
)

2636 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(50));

2639 if(
num_mig
>
	`gë_Æloc_cou¡
(
su≥r
))

2640 
num_mig
 = 
	`gë_Æloc_cou¡
(
su≥r
)-1;

2642 if(!
num_mig
){

2643 
	`¥ötk
("Çum mig = %d \n", 
num_mig
);

2644 
num_mig
 = 1;

2647 
	`¥ötk
(" Sèπ:Çum mig = %d, job cou¡ = %d,á˘ivê%d,ÅŸÆ = %d (%d%%Ë‰ì = %d\n", 
num_mig
, 
	`©omic_ªad
(&
migøã_mgr
->
c›y_job_cou¡
),

2648 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
a˘ive_∑ge_cou¡
),átomic_ªad(&su≥r->£gbuf_mgr.
tŸÆ_∑ge_cou¡
),

2649 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
a˘ive_∑ge_cou¡
)*100/©omic_ªad(&su≥r->£gbuf_mgr.
tŸÆ_∑ge_cou¡
),

2650 
	`gë_Æloc_cou¡
(
su≥r
)

2653 
num_mig
 = 
	`£À˘_vi˘im_£gs
(
su≥r
,Çum_mig, &
u£_gc
);

2654 if(
num_mig
==0){

2655 
	`¥ötk
("Çÿvi˘im block ... u£ g¯%d, fªê%d,Çum vi˘im seg†%d\n", 
u£_gc
,

2656 
	`gë_Æloc_cou¡
(
su≥r
), 
num_mig
);

2657 
	`©omic_£t
(&
migøã_mgr
->
background_gc_⁄
, 0);

2658 
	`©omic_£t
(&
migøã_mgr
->
migøã_åiggîed
, 0);

2659 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(1000));

2663 
	`¥ötk
(" sñe˘ed vi˘im block ... u£ g¯%d, fªê%d,Çum vi˘im seg†%d\n", 
u£_gc
,

2664 
	`gë_Æloc_cou¡
(
su≥r
), 
num_mig
);

2666 
	`issue_mig_kc›yd
(
su≥r
, 
u£_gc
);

2680 
	`©omic_ªad
(&
migøã_mgr
->
c›y_job_cou¡
) &&

2681 (
gc_buf_max_cou¡
 - 
	`gë_d©a_max_cou¡
(
su≥r
, 
WCBUF
)) <

2682 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
gc_a˘ive_∑ge_cou¡
)){

2685 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(10));

2688 
	`gë_Æloc_cou¡
(
su≥r
)<1){

2689 
	`¥ötk
("Çÿ‰ì seg†f‹ GC fªê%d \n", 
	`gë_Æloc_cou¡
(
su≥r
));

2690 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(5000));

2698 
	}
}

2701 
	$chunk_io_com∂ëe
(
îr‹
, *
__c⁄ãxt
)

2703 
ªcovîy_job
 *
job
 = 
__c⁄ãxt
;

2704 
dm§c_su≥r
 *
su≥r
 = 
job
->super;

2705 
ªcovîy_m™agî
 *
ªcovîy_mgr
 = &
su≥r
->recovery_mgr;

2706 
Êags
;

2708 i‡(
îr‹
)

2709 
job
->
îr‹
 = 1;

2711 if(!
	`©omic_dec_™d_ã°
(&
job
->
num_ªmaöög_ios
)){

2715 
	`•ö_lock_úqßve
(&
ªcovîy_mgr
->
lock
, 
Êags
);

2716 
	`li°_add_èû
(&
job
->
ªcovîy_li°
, &
ªcovîy_mgr
->
queue
);

2717 
	`•ö_u∆ock_úqª°‹e
(&
ªcovîy_mgr
->
lock
, 
Êags
);

2718 
	`queue_w‹k
(
ªcovîy_mgr
->
wq
, &ªcovîy_mgr->
w‹k
);

2719 
	}
}

2721 
	$m¨k_ªcovî
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
)

2723 
mëablock
 *
mb
;

2724 
i
;

2726 
i
 = 0;ò< 
CHUNK_SZ
;i++){

2727 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, su≥r->
ªcovîy_mgr
.
Áûuª_ssd
*
CHUNK_SZ
 + 
i
);

2728 if(
	`ã°_bô
(
MB_BROKEN
, &
mb
->
mb_Êags
)){

2729 
	`˛ór_bô
(
MB_BROKEN
, &
mb
->
mb_Êags
);

2730 
	`©omic_dec
(&
su≥r
->
ªcovîy_mgr
.
brokí_block_cou¡
);

2734 
	`£t_bô
(
SEG_SEALED
, &
£g
->
Êags
);

2735 
	`˛ór_bô
(
SEG_RECOVERY
, &
£g
->
Êags
);

2736 
	}
}

2738 
	$_chunk_io_async
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
mëablock
 *
mb
,

2739 
ªcovîy_job
 *
c⁄ãxt
, *
±r
, 
rw
){

2740 
dm_io_ªgi⁄
 
io
;

2741 
dm_io_ªque°
 
io_ªq
;

2743 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_KMEM
;

2744 
io_ªq
.
mem
.
±r
.
addr
 =Ötr;

2746 
io_ªq
.
bi_rw
 = 
rw
;

2747 
io_ªq
.
nŸify
.
‚
 = 
chunk_io_com∂ëe
;

2748 
io_ªq
.
nŸify
.
c⁄ãxt
 = context;

2749 
io_ªq
.
˛õ¡
 = 
su≥r
->
io_˛õ¡
;

2751 
io
.
bdev
 = 
	`gë_bdev
(
su≥r
, 
mb
->
idx
);

2752 
io
.
£˘‹
 = 
	`gë_£˘‹
(
su≥r
, 
£g
->
£g_id
, 
mb
->
idx
);

2753 
io
.
cou¡
 = 
SRC_SECTORS_PER_PAGE
;

2756 
	`dm§c_io
(&
io_ªq
, 1, &
io
, 
NULL
);

2757 
	}
}

2759 
	$row_is_brokí
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
Áûuª_ssd
, 
row
){

2760 
mëablock
 *
mb
;

2761 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
Áûuª_ssd
*
CHUNK_SZ
 + 
row
);

2762  
	`ã°_bô
(
MB_BROKEN
, &
mb
->
mb_Êags
);

2764 
	}
}

2766 
	$chunk_io_async
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
ªcovîy_job
 *
c⁄ãxt
,

2767 
ømbuf„r
 *
ømbuf
)

2769 
mëablock
 *
mb
;

2770 
u32
 
off£t
;

2771 
u32
 
mem_off£t
;

2772 
i
, 
j
;

2773 
cou¡
=0, 
cou¡2
=0;

2774 
ªcovîy_m™agî
 *
ªcovîy_mgr
 = &
su≥r
->recovery_mgr;

2776 
	`©omic_£t
(&
c⁄ãxt
->
num_ªmaöög_ios
, 0);

2778 
i
 = 0;ò< 
NUM_SSD
;i++){

2779 if(
c⁄ãxt
->
is_ªad
){

2780 if(
i
==
ªcovîy_mgr
->
Áûuª_ssd
)

2783 if(
i
!=
ªcovîy_mgr
->
Áûuª_ssd
)

2787 
j
 = 0;j < 
CHUNK_SZ
;j++){

2788 if(
	`row_is_brokí
(
su≥r
, 
£g
, 
ªcovîy_mgr
->
Áûuª_ssd
, 
j
)){

2789 
	`©omic_öc
(&
c⁄ãxt
->
num_ªmaöög_ios
);

2790 
cou¡
++;

2795 
i
 = 0;ò< 
NUM_SSD
;i++){

2796 if(
c⁄ãxt
->
is_ªad
){

2797 if(
i
==
ªcovîy_mgr
->
Áûuª_ssd
)

2800 if(
i
!=
ªcovîy_mgr
->
Áûuª_ssd
)

2804 
j
 = 0;j < 
CHUNK_SZ
;j++){

2806 if(!
	`row_is_brokí
(
su≥r
, 
£g
, 
ªcovîy_mgr
->
Áûuª_ssd
, 
j
))

2809 
cou¡2
++;

2810 
off£t
 = 
i
*
CHUNK_SZ
+
j
;

2811 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
off£t
);

2812 
mem_off£t
 = 
off£t
;

2813 if(
c⁄ãxt
->
is_ªad
){

2814 
	`_chunk_io_async
–
su≥r
, 
£g
, 
mb
, 
c⁄ãxt
, 
	`∑ge_addªss
(
ømbuf
->
∑ges
[
mem_off£t
]->
∂
->
∑ge
), 
READ
);

2816 
	`_chunk_io_async
–
su≥r
, 
£g
, 
mb
, 
c⁄ãxt
, 
	`∑ge_addªss
(
ømbuf
->
∑ges
[
mem_off£t
]->
∂
->
∑ge
), 
WRITE
);

2820 
	`BUG_ON
(
cou¡
!=
cou¡2
);

2822 if(
cou¡
==0){

2824 
	`m¨k_ªcovî
(
su≥r
, 
c⁄ãxt
->
£g
);

2825 
	`ªÀa£_ømbuf„r
(
su≥r
, 
c⁄ãxt
->
ømbuf
, 
£g
->
£g_ty≥
);

2826 
	`mempoﬁ_‰ì
(
c⁄ãxt
, 
ªcovîy_mgr
->
job_poﬁ
);

2828 
	}
}

2831 
	$ªcovîy_£gmít
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

2832 
ªcovîy_job
 *
c⁄ãxt
, 
is_ªad
){

2833 
ømbuf„r
 *
ømbuf
;

2835 if(
is_ªad
){

2836 
ømbuf
 = 
	`Æloc_ømbuf„r
(
su≥r
, 
RCVBUF
, 
STRIPE_SZ
);

2837 
c⁄ãxt
->
ømbuf
 =Ñambuf;

2838 
c⁄ãxt
->
su≥r
 = super;

2839 
c⁄ãxt
->
£g
 = seg;

2841 
ømbuf
 = 
c⁄ãxt
->rambuf;

2844 
c⁄ãxt
->
is_ªad
 = is_read;

2846 
	`chunk_io_async
(
su≥r
, 
£g
, 
c⁄ãxt
, 
ømbuf
);

2847 
	}
}

2849 
	$do_x‹ög
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

2850 
ømbuf„r
 *
ømbuf
){

2851 
i
, 
j
;

2852 
§c_cou¡
 = 0;

2853 *
d°
=
NULL
;

2854 *
§cs
[
MAX_CACHE_DEVS
];

2856 
i
 = 0;ò<
CHUNK_SZ
;i++){

2857 if(!
	`row_is_brokí
(
su≥r
, 
£g
, su≥r->
ªcovîy_mgr
.
Áûuª_ssd
, 
i
))

2860 
§c_cou¡
 = 0;

2861 
j
 = 0;j < 
NUM_SSD
;j++){

2862 if(
j
==
su≥r
->
ªcovîy_mgr
.
Áûuª_ssd
)

2863 
d°
 = 
	`∑ge_addªss
(
ømbuf
->
∑ges
[
i
 + (
j
 * 
CHUNK_SZ
)]->
∂
->
∑ge
);

2865 
§cs
[
§c_cou¡
++] = 
	`∑ge_addªss
(
ømbuf
->
∑ges
[
i
 + (
j
 * 
CHUNK_SZ
)]->
∂
->
∑ge
);

2867 
	`mem£t
(
d°
, 0xFF, 
SRC_PAGE_SIZE
);

2869 
	`run_x‹
(
§cs
, 
d°
, 
§c_cou¡
, 
SRC_PAGE_SIZE
);

2871 
	}
}

2873 
	$do_ªcovîy_w‹kî
(
w‹k_°ru˘
 *
w‹k
){

2874 
ªcovîy_m™agî
 *
ªcovîy_mgr
 = 
	`c⁄èöî_of
(
w‹k
, recovery_manager, work);

2875 
dm§c_su≥r
 *
su≥r
 = 
ªcovîy_mgr
->super;

2876 
li°_hód
 
ªcovîy_loˇl_hód
;

2877 
ªcovîy_job
 *
job
, *
job_tmp
;

2878 
Êags
;

2880 
	`INIT_LIST_HEAD
(&
ªcovîy_loˇl_hód
);

2882 
	`•ö_lock_úqßve
(&
ªcovîy_mgr
->
lock
, 
Êags
);

2883 
	`li°_f‹_óch_íåy_ß„
(
job
, 
job_tmp
, &
ªcovîy_mgr
->
queue
, 
ªcovîy_li°
) {

2884 
	`li°_move_èû
(&
job
->
ªcovîy_li°
, &
ªcovîy_loˇl_hód
);

2886 
	`•ö_u∆ock_úqª°‹e
(&
ªcovîy_mgr
->
lock
, 
Êags
);

2888 
	`li°_f‹_óch_íåy_ß„
(
job
, 
job_tmp
, &
ªcovîy_loˇl_hód
, 
ªcovîy_li°
) {

2889 
	`li°_dñ
(&
job
->
ªcovîy_li°
);

2891 if(
job
->
is_ªad
){

2893 
	`do_x‹ög
(
su≥r
, 
job
->
£g
, job->
ømbuf
);

2894 
	`ªcovîy_£gmít
(
su≥r
, 
job
->
£g
, job, 0);

2897 
	`m¨k_ªcovî
(
su≥r
, 
job
->
£g
);

2898 
	`ªÀa£_ømbuf„r
(
su≥r
, 
job
->
ømbuf
, 
RCVBUF
);

2899 
	`mempoﬁ_‰ì
(
job
, 
ªcovîy_mgr
->
job_poﬁ
);

2905 
	}
}

2908 
	$ªcovîy_¥oc
(*
d©a
)

2910 
dm§c_su≥r
 *
su≥r
 = 
d©a
;

2911 
ªcovîy_m™agî
 *
ªcovîy_mgr
 = &
su≥r
->recovery_mgr;

2912 
£gmít_hódî
 *
£g
;

2913 
ªcovîy_job
 *
c⁄ãxt
;

2914 
i
;

2915 
≥r˚¡
 = -10;

2916 
ãmp
 = 0;

2917 
tŸÆ
 = 0;

2919 !
	`kthªad_should_°›
()) {

2920 if(!
	`©omic_ªad
(&
su≥r
->
degøded_mode
)){

2921 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

2925 
ªcovîy_mgr
->
°¨t_jiffõs
 = 
jiffõs
;

2926 
tŸÆ
 = 
	`©omic_ªad
(&
ªcovîy_mgr
->
brokí_block_cou¡
);

2927 
≥r˚¡
 = -10;

2929 
i
 = 0;ò< 
su≥r
->
ˇche_°©
.
num_£gmíts
 && 
	`©omic_ªad
(&
ªcovîy_mgr
->
brokí_block_cou¡
);i++){

2930 
£g
 = 
	`gë_£gmít_hódî_by_id
(
su≥r
, (
u64
)
i
);

2932 if(!
	`ã°_bô
(
SEG_RECOVERY
, &
£g
->
Êags
)){

2936 
	`waô_ømbuf_evít
(
su≥r
, 
RCVBUF
);

2938 
ªåy
:;

2939 
c⁄ãxt
 = 
	`mempoﬁ_Æloc
(
ªcovîy_mgr
->
job_poﬁ
, 
GFP_NOIO
);

2940 if(!
c⁄ãxt
){

2941 
	`¥ötk
(" mempoolÉrror \n");

2942 
ªåy
;

2948 if(!
	`ã°_bô
(
SEG_SEALED
, &
£g
->
Êags
)){

2949 
	`¥ötk
(" segment isÇot sealed ... \n");

2950 
	`BUG_ON
(1);

2957 
	`ªcovîy_£gmít
(
su≥r
, 
£g
, 
c⁄ãxt
, 1);

2959 
ãmp
 = 
	`©omic_ªad
(&
ªcovîy_mgr
->
brokí_block_cou¡
Ë* 100 / (
tŸÆ
+1);

2960 if(
ãmp
%10 =0 &&Åem∞!
≥r˚¡
){

2961 
	`¥ötk
(" %dÖî˚¡ block†¨êªcovîed \n", 100-
ãmp
);

2962 
≥r˚¡
 = 
ãmp
;

2966  
	`©omic_ªad
(&
ªcovîy_mgr
->
brokí_block_cou¡
)){

2967 
	`¥ötk
(" WatingÑecoveryÖroc... broken block = %d\n",

2968 ()
	`©omic_ªad
(&
ªcovîy_mgr
->
brokí_block_cou¡
));

2969 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

2972 
ãmp
 = 
	`©omic_ªad
(&
ªcovîy_mgr
->
brokí_block_cou¡
Ë* 100 / (
tŸÆ
+1);

2973 if(
ãmp
%10 =0 &&Åem∞!
≥r˚¡
){

2974 
	`¥ötk
(" %dÖî˚¡ block†¨êªcovîed \n", 100-
ãmp
);

2975 
≥r˚¡
 = 
ãmp
;

2978 
ªcovîy_mgr
->
íd_jiffõs
 = 
jiffõs
;

2979 
	`¥ötk
(" Recovîy Timê = %d m†\n", 
	`jiffõs_to_m£cs
(
ªcovîy_mgr
->
íd_jiffõs


2980 - 
ªcovîy_mgr
->
°¨t_jiffõs
));

2981 
	`¥ötk
(" ENDÑecoveryÖroc... broken block = %d\n",

2982 ()
	`©omic_ªad
(&
ªcovîy_mgr
->
brokí_block_cou¡
));

2984 
	`©omic_£t
(&
su≥r
->
degøded_mode
, 0);

2985 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

2988 
	}
}

2992 
	$checkî_¥oc
(*
d©a
)

2994 
dm§c_su≥r
 *
su≥r
 = 
d©a
;

2995 
ötvl
;

2997 
j
;

2998 
f
;

3000 !
	`kthªad_should_°›
()) {

3003 
ötvl
 = 
	`ACCESS_ONCE
(
su≥r
->
∑øm
.
checkî_öãrvÆ
) * 1000;

3004 i‡(!
ötvl
) {

3005 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

3008 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(
ötvl
));

3011 
	`¥ötk
("---------------------------------\n");

3017 
	`¥ötk
(" CheckîÜivêöÊighàio†%d \n", 
	`©omic_ªad
(&
su≥r
->
ˇche_°©
.
öÊight_ios
));

3018 
	`¥ötk
(" CheckîÜivêöÊighàbio†%d \n", 
	`©omic_ªad
(&
su≥r
->
ˇche_°©
.
öÊight_bios
));

3028 
	`¥ötk
(" cuºíàutûiz©i⁄ = %d%%(%d/%dË\n", 
	`gë_cuº_utû
(
su≥r
),

3029 ()
NUM_USED_BLOCKS
, ()
NUM_BLOCKS
);

3035 
	`¥öt_Æloc_queue
(
su≥r
);

3037 
	`LOCK
(
su≥r
, 
f
);

3038 if(
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
WCBUF
]){

3039 
	`¥ötk
(" biosÅotal start = %d, count = %d,Ñefcount = %d \n",

3040 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
WCBUF
]->
bios_tŸÆ_°¨t
),

3041 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
WCBUF
]->
bios_tŸÆ_cou¡
),

3042 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
WCBUF
]->
ªf_cou¡
)

3058 
	`UNLOCK
(
su≥r
, 
f
);

3061 if(
su≥r
->
w°©
.
ªad_cou¡
 && su≥r->w°©.
wrôe_cou¡
){

3062 
	`¥ötk
(" hitÑatio = %dÑhit = %d, whit = %d\n",

3063 
su≥r
->
w°©
.
hô
 * 100 / su≥r->w°©.
cou¡
,

3064 
su≥r
->
w°©
.
ªad_hô
 * 100 / su≥r->w°©.
ªad_cou¡
,

3065 
su≥r
->
w°©
.
wrôe_hô
 * 100 / su≥r->w°©.
wrôe_cou¡


3067 
	`¥ötk
(" cold bypass = %dMB, seq bypass = %dMB \n",

3068 
	`©omic_ªad
(&
su≥r
->
w°©
.
cﬁd_by∑ss_cou¡
)/256,

3069 
	`©omic_ªad
(&
su≥r
->
w°©
.
£q_by∑ss_cou¡
)/256);

3071 
	`¥ötk
(" u£d = %u,ÅŸÆ = %u \n", 
	`©omic_ªad
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
), 
NUM_BLOCKS
);

3072 
	`¥ötk
(" g¯em±y cou¡ = %u\n", 
	`©omic_ªad
(&
su≥r
->
w°©
.
gc_em±y_cou¡
));

3073 
	`¥ötk
(" g¯job cou¡ = %u, de°agêjob cou¡ = %d \n", 
	`©omic_ªad
(&
su≥r
->
w°©
.
gc_cou¡
),átomic_ªad(&su≥r->w°©.
de°age_cou¡
));

3074 
	`¥ötk
(" g¯iÿcou¡ = %lu, de°agêiÿcou¡ = %lu \n", 
	`©omic64_ªad
(&
su≥r
->
w°©
.
gc_io_cou¡
),átomic64_ªad(&su≥r->w°©.
de°age_io_cou¡
));

3075 
	`¥ötk
("Öídög iÿcou¡ = %d\n", ()
	`©omic64_ªad
(&
su≥r
->
≥ndög_mgr
.
io_cou¡
));

3076 if(
	`©omic64_ªad
(&
su≥r
->
w°©
.
vi˘im_cou¡
)){

3077 
	`¥ötk
(" Average Victim Util = %d\n",

3078 ()(
	`©omic64_ªad
(&
su≥r
->
w°©
.
vi˘im_utû
)/

3079 
	`©omic64_ªad
(&
su≥r
->
w°©
.
vi˘im_cou¡
)));

3082 
	`¥ötk
("Ö¨tü»£g wrôe†%d \n", 
	`©omic_ªad
(&
su≥r
->
w°©
.
∑πül_wrôe_cou¡
));

3083 
	`¥ötk
(" by∑s†wrôe†%dMB/†\n", 
	`©omic_ªad
(&
su≥r
->
w°©
.
by∑ss_wrôe_cou¡
)/256);

3084 if(
	`©omic64_ªad
(&
su≥r
->
w°©
.
avîage_¨rivÆ_time
))

3085 
	`¥ötk
(" Average Arrival Time = %luus \n",

3086 
	`©omic64_ªad
(&
su≥r
->
w°©
.
avîage_¨rivÆ_time
)/

3087 
	`©omic64_ªad
(&
su≥r
->
w°©
.
avîage_¨rivÆ_time
));

3100 
	`queue_w‹k
(
su≥r
->
migøã_mgr
.
mig_wq
, &su≥r->migøã_mgr.
mig_w‹k
);

3102 
	`≥ndög_w‹kî_scheduÀ
(
su≥r
);

3108 
	`¥ötk
(" mig seg inflights = %d, complete = %d \n",

3109 
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
mig_öÊights
),

3110 
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
mig_com∂ëes
)

3114 
	`¥ötk
("Ñambu‡∑gêA˘ivêcou¡ = %d (%d MBË\n", ()
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
a˘ive_∑ge_cou¡
),

3115 ()
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
a˘ive_∑ge_cou¡
)/256);

3116 
	`¥ötk
("Ñambu‡∑gêI«˘ivêcou¡ = %d (%d MBË\n", ()
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_∑ge_cou¡
),

3117 ()
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_∑ge_cou¡
)/256);

3118 
	`¥ötk
("Ölug queuê%d \n", ()
	`©omic_ªad
(&
su≥r
->
∂uggî
.
tŸÆ_Àngth
));

3120 
j
 = 0;j < 
NBUF
;j++){

3121 
	`¥ötk
(" [%d]%d ", 
j
, 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
a˘ive_cou¡
[j]));

3123 
	`¥ötk
("\n");

3126 if(
su≥r
->
∑øm
.
íabÀ_ªad_ˇche
){

3127 
	`¥ötk
(" clean dram buffer: free = %d, count = %d, sealed = %dMB\n",

3128 
su≥r
->
˛ón_døm_ˇche_m™agî
->
cm_‰ì
/256,

3129 
su≥r
->
˛ón_døm_ˇche_m™agî
->
cm_cou¡
/256,

3130 
	`©omic_ªad
(&
su≥r
->
˛ón_døm_ˇche_m™agî
->
cm_£Æed_cou¡
)/256);

3132 
	`¥ötk
("\n");

3133 
	`¥ötk
("---------------------------------\n");

3137 
	}
}

3141 
	$scheduÀ_sync_¥oc
(
d©a
)

3143 
dm§c_su≥r
 *
su≥r
 = (dm§c_su≥∏*Ë
d©a
;

3145 
	`scheduÀ_w‹k
(&
su≥r
->
sync_mgr
.
w‹k
);

3163 if(!
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
)){

3164 
	`Êush_∑πül_mëa
(
su≥r
, 
WHBUF
);

3165 
	`Êush_∑πül_mëa
(
su≥r
, 
WCBUF
);

3169 
	}
}

3172 
	$sync_¥oc
(
w‹k_°ru˘
 *
w‹k
)

3174 
sync_m™agî
 *
sync_mgr
 = 
	`c⁄èöî_of
(
w‹k
, sync_manager, work);

3175 
dm§c_su≥r
 *
su≥r
 = 
sync_mgr
->super;

3191 if(!
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
)){

3193 
	`Êush_∑πül_mëa
(
su≥r
, 
WCBUF
);

3204 
	}
}

	@daemon.h

23 #i‚de‡
DM_SRC_DAEMON_H


24 
	#DM_SRC_DAEMON_H


	)

27 
	#HOT_DATA_COPY


	)

31 
	smîge_ªq_t
{

32 
dm_io_ªgi⁄
 
	mo_ªgi⁄
;

33 
dm_io_ªgi⁄
 
	mc_ªgi⁄
;

34 
li°_hód
 
	mli°
;

39 
Êush_mëa_¥oc
(*);

43 
queue_b¨rõr_io
(
dm§c_su≥r
 *, 
bio
 *);

44 
b¨rõr_dódlöe_¥oc
(
d©a
);

45 
Êush_b¨rõr_ios
(
w‹k_°ru˘
 *);

46 
do_ªad_ˇchög_w‹kî
(
w‹k_°ru˘
 *
ws
);

50 
migøã_¥oc
(*);

51 
waô_f‹_migøti⁄
(
dm§c_su≥r
 *, 
u64
 
id
);

55 
moduœt‹_¥oc
(*);

59 
scheduÀ_sync_¥oc
(
d©a
);

60 
sync_¥oc
(
w‹k_°ru˘
 *
w‹k
);

64 
ªc‹dî_¥oc
(*);

68 
checkî_¥oc
(*);

70 
≥ndög_w‹kî
(
w‹k_°ru˘
 *
w‹k
);

71 
do_mig_w‹kî
(
w‹k_°ru˘
 *
w‹k
);

72 
issue_de„ºed_bio
(
dm§c_su≥r
 *
su≥r
, 
bio_li°
 *);

73 
ªad_ˇchög_make_job
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
mëablock
 *
mb
, 
bio
 *bio, 
ømbuf„r
 *
ømbuf
);

74 
ªad_ˇŒback
(
îr‹
, *
c⁄ãxt
);

75 
°¨t_ªcovîy
(
dm§c_su≥r
 *
su≥r
);

76 
ªcovîy_¥oc
(*
d©a
);

77 
do_ªcovîy_w‹kî
(
w‹k_°ru˘
 *
w‹k
);

78 
gí_summ¨y_io
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

79 
ømbuf„r
 *
ømbuf
,

80 
u32
 
idx
,

81 
u32
 
mem_idx
);

83 
gí_∑πül_summ¨y_io
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

84 
ømbuf„r
 *
ømbuf
);

86 
∂ug_dódlöe_¥oc
(
d©a
);

87 
upd©e_∂ug_dódlöe
(
dm§c_su≥r
 *
su≥r
);

88 
∂ug_¥oc
(
w‹k_°ru˘
 *
w‹k
);

89 
Êush_∂ug_¥oc
(
dm§c_su≥r
 *
su≥r
,

90 
£gmít_hódî
 *
£g
,

91 
ømbuf„r
 *
ømbuf
,

92 
©omic_t
 *
bios_°¨t
,

93 
©omic_t
 *
bios_cou¡
,

94 
f‹˚
,

95 
devno
,

96 
group_£Æed
);

97 
Êush_kc›y_job
(
dm§c_su≥r
 *
su≥r
, 
c›y_job_group
 *
˝_job_group
);

98 
Êush_£gmd_ídio
(
îr‹
, *
c⁄ãxt
);

99 
£gmít_hódî
 *
£À˘_vi˘im_gªedy_cﬁd
(
dm§c_su≥r
 *
su≥r
, 
u£_gc
);

100 
group_hódî
 *
£À˘_vi˘im_gªedy
(
dm§c_su≥r
 *
su≥r
, 
u£_gc
);

101 
föÆize_˛ón_£g
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
˛ónup
);

102 
gë_mëad©a_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£g_ty≥
);

103 
check_∂ug_¥oc
(
dm§c_su≥r
 *
su≥r
,

104 
£gmít_hódî
 *
£g
,

105 
ømbuf„r
 *
ømbuf
,

106 
f‹˚
,

107 
devno
);

108 
˛ón_em±y_£g
(
dm§c_su≥r
 *
su≥r
, 
u£_gc
);

109 
gë_d©a_max_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£g_ty≥
);

110 
gë_d©a_vÆid_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
);

111 
ˇlc_mëa_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
);

112 
ˇlc_vÆid_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
u£_gc
);

113 
£g_wrôe_w‹kî
(
w‹k_°ru˘
 *
w‹k
);

	@dm-src.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

18 
__u£d


19 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

20 { 0x79833446, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

21 { 0x8487a2b6, 
__VMLINUX_SYMBOL_STR
(
Êush_w‹k
) },

22 { 0x7Øabf54, 
__VMLINUX_SYMBOL_STR
(
Æloc_∑ges_cuºít
) },

23 { 0x2d3385d3, 
__VMLINUX_SYMBOL_STR
(
sy°em_wq
) },

24 { 0x47df7f70, 
__VMLINUX_SYMBOL_STR
(
fs_bio_£t
) },

25 { 0xó645b46, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

26 { 0x65e75cb6, 
__VMLINUX_SYMBOL_STR
(
__li°_dñ_íåy
) },

27 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

28 { 0x9b388444, 
__VMLINUX_SYMBOL_STR
(
gë_zî€d_∑ge
) },

29 { 0x4c4„f19, 
__VMLINUX_SYMBOL_STR
(
kî√l_°ack
) },

30 { 0xf4f1923c, 
__VMLINUX_SYMBOL_STR
(
bio_Æloc_bio£t
) },

31 { 0xd6ì688f, 
__VMLINUX_SYMBOL_STR
(
vmÆloc
) },

32 { 0xc996d097, 
__VMLINUX_SYMBOL_STR
(
dñ_timî
) },

33 { 0xa21de278, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

34 { 0x5769fbcc, 
__VMLINUX_SYMBOL_STR
(
dm_io
) },

35 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

36 { 0xe7f3608a, 
__VMLINUX_SYMBOL_STR
(
hπimî_f‹w¨d
) },

37 { 0xc8b57c27, 
__VMLINUX_SYMBOL_STR
(
aut‹emove_wake_fun˘i⁄
) },

38 { 0x79Ø04a2, 
__VMLINUX_SYMBOL_STR
(
gë_øndom_byãs
) },

39 { 0x46608Á0, 
__VMLINUX_SYMBOL_STR
(
gën°imeofday
) },

40 { 0x94313d7, 
__VMLINUX_SYMBOL_STR
(
hπimî_ˇn˚l
) },

41 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

42 { 0xb54533f7, 
__VMLINUX_SYMBOL_STR
(
u£cs_to_jiffõs
) },

43 { 0x88bÁ7e, 
__VMLINUX_SYMBOL_STR
(
ˇn˚l_w‹k_sync
) },

44 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

45 { 0x593a99b, 
__VMLINUX_SYMBOL_STR
(
öô_timî_key
) },

46 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
v‰ì
) },

47 { 0xe979bb8c, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

48 { 0x236437f6, 
__VMLINUX_SYMBOL_STR
(
kthªad_¸óã_⁄_node
) },

49 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

50 { 0x343a1a8, 
__VMLINUX_SYMBOL_STR
(
__li°_add
) },

51 { 0x9e4Áìf, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_de°roy
) },

52 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__öô_waôqueue_hód
) },

53 { 0xfdfcb8cb, 
__VMLINUX_SYMBOL_STR
(
øid6_ˇŒ
) },

54 { 0xfb578fc5, 
__VMLINUX_SYMBOL_STR
(
mem£t
) },

55 { 0xe988104b, 
__VMLINUX_SYMBOL_STR
(
dm_£t_èrgë_max_io_Àn
) },

56 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

57 { 0xcff55457, 
__VMLINUX_SYMBOL_STR
(
cuºít_èsk
) },

58 { 0x5b6c00e6, 
__VMLINUX_SYMBOL_STR
(
x‹_blocks
) },

59 { 0x37befc70, 
__VMLINUX_SYMBOL_STR
(
jiffõs_to_m£cs
) },

60 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

61 { 0xØ35286, 
__VMLINUX_SYMBOL_STR
(
kthªad_°›
) },

62 { 0x449ad0a7, 
__VMLINUX_SYMBOL_STR
(
memcmp
) },

63 { 0xd4b08e54, 
__VMLINUX_SYMBOL_STR
(
waô_f‹_com∂ëi⁄_io
) },

64 { 0xa9668691, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

65 { 0xØfdc258, 
__VMLINUX_SYMBOL_STR
(
°rˇ£cmp
) },

66 { 0x5eb24829, 
__VMLINUX_SYMBOL_STR
(
dm_shi·_¨g
) },

67 { 0x802d0e93, 
__VMLINUX_SYMBOL_STR
(
¸c32_À
) },

68 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

69 { 0x521445b, 
__VMLINUX_SYMBOL_STR
(
li°_dñ
) },

70 { 0x46„b099, 
__VMLINUX_SYMBOL_STR
(
dm_ªad_¨g
) },

71 { 0x8834396c, 
__VMLINUX_SYMBOL_STR
(
mod_timî
) },

72 { 0xd0c50de0, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

73 { 0x4Áì48d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

74 { 0x68e5292c, 
__VMLINUX_SYMBOL_STR
(
bio_put
) },

75 { 0x1a996ab6, 
__VMLINUX_SYMBOL_STR
(
submô_bio
) },

76 { 0x13b715e2, 
__VMLINUX_SYMBOL_STR
(
blk_föish_∂ug
) },

77 { 0x5190a966, 
__VMLINUX_SYMBOL_STR
(
__‰ì_∑ges
) },

78 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

79 { 0x93fˇ811, 
__VMLINUX_SYMBOL_STR
(
__gë_‰ì_∑ges
) },

80 { 0x3bd1b1f6, 
__VMLINUX_SYMBOL_STR
(
m£cs_to_jiffõs
) },

81 { 0xd62c833f, 
__VMLINUX_SYMBOL_STR
(
scheduÀ_timeout
) },

82 { 0xa202a8e5, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_‹dî_åa˚
) },

83 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

84 { 0x6e8bf789, 
__VMLINUX_SYMBOL_STR
(
hπimî_°¨t
) },

85 { 0xe4b051cf, 
__VMLINUX_SYMBOL_STR
(
øid6_d©≠_ªcov
) },

86 { 0x6a037cf1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_k‰ì
) },

87 { 0x2c925659, 
__VMLINUX_SYMBOL_STR
(
wake_up_¥o˚ss
) },

88 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

89 { 0xc497f84c, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

90 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

91 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

92 { 0x4302d0eb, 
__VMLINUX_SYMBOL_STR
(
‰ì_∑ges
) },

93 { 0xcf21d241, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

94 { 0xb3f7646e, 
__VMLINUX_SYMBOL_STR
(
kthªad_should_°›
) },

95 { 0x601f665f, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_¸óã
) },

96 { 0xa05c03df, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_kmÆloc
) },

97 { 0x9c55˚c, 
__VMLINUX_SYMBOL_STR
(
scheduÀ_timeout_öãºu±ibÀ
) },

98 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

99 { 0x5c8b5˚8, 
__VMLINUX_SYMBOL_STR
(
¥ï¨e_to_waô
) },

100 { 0x25a97010, 
__VMLINUX_SYMBOL_STR
(
hπimî_öô
) },

101 { 0xÁ66f77c, 
__VMLINUX_SYMBOL_STR
(
föish_waô
) },

102 { 0x1803a6ed, 
__VMLINUX_SYMBOL_STR
(
øid6_2d©a_ªcov
) },

103 { 0x90b0da35, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

104 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

105 { 0x4b06d2e7, 
__VMLINUX_SYMBOL_STR
(
com∂ëe
) },

106 { 0x65d67a20, 
__VMLINUX_SYMBOL_STR
(
blk_°¨t_∂ug
) },

107 { 0xe914e41e, 
__VMLINUX_SYMBOL_STR
(
°r˝y
) },

110 c⁄° 
	g__moduÀ_dïíds
[]

111 
__u£d


112 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

116 
MODULE_INFO
(
§cvîsi⁄
, "1B8DE8C19687085BCBDABC2");

	@header.h

23 #i‚de‡
DM_SRC_HEADER_H


24 
	#DM_SRC_HEADER_H


	)

38 
	#RESERVED_START
 0

	)

39 
	#RESERVED_LENGTH
 
GROUP_SZ_SECTOR


40 

	)

41 
	#MAX_CACHE_DEVS
 8

	)

43 #i‚de‡
__KERNEL__


44 
u_öt64_t
 
	t£˘‹_t
;

55 
	#SRC_MAGIC
 0x57427374

	)

56 
	ssu≥rblock_devi˚
 {

58 
__u32
 
	mmagic
;

59 
__u32
 
	muuid
;

60 
__u32
 
	m¸óã_time
;

61 
£˘‹_t
 
	mssd_devsize
;

62 
£˘‹_t
 
	mhdd_devsize
;

63 
__u32
 
	mblock_size
;

64 
__u32
 
	mchunk_size
;

65 
__u32
 
	mchunk_group_size
;

66 
__u32
 
	mchunks_≥r_group
;

67 
__u32
 
	m∑rôy_Æloˇti⁄
;

68 
__u32
 
	m°rùög_pﬁicy
;

69 
__u32
 
	md©a_Æloˇti⁄
;

70 
__u32
 
	mîasuª_code
;

71 
__u32
 
	mhŸ_idítifiˇti⁄
;

72 
__u32
 
	mª˛aim_pﬁicy
;

73 
__u32
 
	mvi˘im_pﬁicy
;

74 
__u32
 
	mømbuf_poﬁ_amou¡
;

75 
__u32
 
	mÊush_comm™d
;

77 
__u32
 
	mÆig√d_io_dummy
;

79 
__u32
 
	mnum_chunks
;

80 
__u32
 
	mnum_blocks_≥r_chunk
;

81 
__u32
 
	mnum_blocks_≥r_ssd
;

83 
__u32
 
	mnum_groups
;

85 
__u32
 
	mnum_summ¨y_≥r_chunk
;

86 
__u32
 
	mnum_íåy_≥r_∑ge
;

87 } 
__©åibuã__
((
∑cked
));

89 
	#MB_SEAL
 0

	)

90 
	#MB_DIRTY
 1

	)

91 
	#MB_VALID
 2

	)

92 
	#MB_PARITY
 3

	)

93 
	#MB_DUMMY
 4

	)

94 
	#MB_SKIP
 5

	)

95 
	#MB_SUMMARY
 6

	)

96 
	#MB_BROKEN
 7

	)

97 
	#MB_PARITY_NEED
 8

	)

98 
	#MB_PARITY_WRITTEN
 9

	)

99 
	#MB_HIT
 10

	)

107 
	smëablock
 {

108 #ifde‡
__KERNEL__


109 
hli°_node
 
	mht_li°
;

111 
__u64
 
	mht_li°
;

113 
	mmb_Êags
;

114 
£˘‹_t
 
	m£˘‹
;

115 
__u32
 
	midx
;

116 
__u16
 
	mchecksum
;

117 } 
__©åibuã__
((
∑cked
));

126 
	smëablock_devi˚
 {

127 
__u32
 
	m£˘‹
;

128 
__u8
 
	mdúty_bôs
;

129 
__u8
 
	mchecksum
;

130 
__u8
 
	m∑ddög
[8 - (4 + 1 + 1)];

131 } 
__©åibuã__
((
∑cked
));

134 
	#SEGMENT_HEADER_SIZE
 4096

	)

139 
	#FLUSH_NONE
 0

	)

140 
	#FLUSH_FINE
 1

	)

141 
	#FLUSH_COARSE
 2

	)

144 
	#ERASURE_CODE_NONE
 0

	)

145 
	#ERASURE_CODE_PARITY
 1

	)

146 
	#ERASURE_CODE_RAID6
 2

	)

149 
	#PARITY_ALLOC_FIXED
 0

	)

150 
	#PARITY_ALLOC_ROTAT
 1

	)

153 
	#ALIGNED_IO_DUMMY
 0

	)

154 
	#ALIGNED_IO_SKIP
 1

	)

157 
	#DATA_ALLOC_VERT
 0

	)

158 
	#DATA_ALLOC_HORI
 1

	)

159 
	#DATA_ALLOC_FLEX_VERT
 2

	)

160 
	#DATA_ALLOC_FLEX_HORI
 3

	)

163 
	#SEPAR_STRIPING
 0

164 
	#MIXED_STRIPING
 1

165 

	)

167 
	#VICTIM_CLOCK
 0

	)

168 
	#VICTIM_LRU
 1

	)

169 
	#VICTIM_GREEDY
 2

	)

172 
	#RECLAIM_SELECTIVE
 0

173 
	#RECLAIM_DESTAGE
 1

174 
	#RECLAIM_GC
 2

175 

	)

177 
	#GC_WITHOUT_DIRTY_SYNC
 0

	)

178 
	#GC_WITH_DIRTY_SYNC
 1

	)

180 
	#DEFAULT_U_MAX
 90

	)

181 
	#MIN_FREE
 10

182 

	)

183 
	#NUM_GC_THREAD
 8

	)

185 
	#MAX_MIGRATE_INFLIGHT_NUM
 10

	)

187 
	#DEFAULT_MIGRATE_LOWWATER
 20

	)

188 
	#DEFAULT_MIGRATE_HIGHWATER
 40

	)

191 
	#HIT_BITMAP_PER_STRIPE
 0

	)

192 
	#HIT_BITMAP_PER_BLOCK
 1

	)

195 
	#SUMMARY_PER_CHUNK
 1

	)

196 
	#SUMMARY_PER_STRIPE
 2

197 
	#SUMMARY_SCHEME
 
SUMMARY_PER_CHUNK


	)

200 
	#WCBUF
 0

201 
	#WHBUF
 1

202 
	#RCBUF
 2

203 
	#RHBUF
 3

204 
	#GWBUF
 4

205 
	#GRBUF
 5

206 
	#RCVBUF
 6

207 
	#NBUF
 7

	)

209 
	#is_wrôe_°rùe
(
x
Ë(x==
WCBUF
||x==
WHBUF
||x==
GWBUF
)

	)

210 
	#is_ªad_°rùe
(
x
Ë(x==
RCBUF
||x==
RHBUF
||x==
GRBUF
)

	)

211 
	#is_n‹mÆ_°rùe
(
x
Ë(x==
RCBUF
 || x==
RHBUF
 || x==
WCBUF
|| x==
WHBUF
)

	)

212 
	#is_gc_°rùe
(
x
Ë(x==
GRBUF
 || x==
GWBUF
)

	)

213 
	#is_cﬁd_°rùe
(
x
Ë(x==
WCBUF
 || x==
RCBUF
)

	)

216 
	#SECTOR_SHIFT
 9

	)

217 
	#SECTOR_SIZE
 (1 << 
SECTOR_SHIFT
)

	)

218 
	#SECTORS_PER_PAGE_SHIFT
 (
PAGE_SHIFT
 - 
SECTOR_SHIFT
)

	)

219 
	#SECTORS_PER_PAGE
 (1 << 
SECTORS_PER_PAGE_SHIFT
)

	)

222 
	#SRC_SIZE_SHIFT
 0

226 

	)

227 
	#SRC_PAGE_SIZE
 ((
SECTOR_SIZE
 * 
SECTORS_PER_PAGE
)<<
SRC_SIZE_SHIFT
)

	)

228 
	#SRC_SECTORS_PER_PAGE
 (
SRC_PAGE_SIZE
/
SECTOR_SIZE
)

	)

229 
	#SRC_SECTORS_PER_PAGE_SHIFT
 (
SECTORS_PER_PAGE_SHIFT
+
SRC_SIZE_SHIFT
)

	)

234 
	#USE_GHOST_BUFFER


	)

235 
	#USE_PENDING_WORKER


	)

237 
	#USE_LAST_SUMMARY
 0

	)

238 
	#USE_FIRST_SUMMARY
 1

	)

239 
	#SUMMARY_LOCATION
 
USE_LAST_SUMMARY


	)

241 #ifde‡
USE_CHECKSUM


242 
	#NUM_SUMMARY
 2

	)

245 
	#NUM_SUMMARY
 (
su≥r
->
∑øm
.
num_summ¨y_≥r_chunk
)

	)

246 
	#NUM_ENTRY_PER_PAGE
 (
su≥r
->
∑øm
.
num_íåy_≥r_∑ge
)

	)

249 
	#USE_SEG_WRITER
 0

	)

	@lru.c

23 
	~"èrgë.h
"

24 
	~"mëad©a.h
"

25 
	~"Ãu.h
"

26 
	~<löux/°rög.h
>

27 
	~<löux/li°.h
>

29 
	#ASSERT
 
as£π


	)

31 
	$Ãu_›í
(
ˇche_m™agî
 *
c
,
ˇche_size
){

32 
i
;

34 
	`INIT_LIST_HEAD
 ( &
c
->
cm_hód
 );

35 
	`INIT_LIST_HEAD
 ( &
c
->
cm_‰ì_hód
 );

37 
c
->
cm_ªf
 = 0;

38 
c
->
cm_hô
 = 0;

39 
c
->
cm_miss
 = 0;

40 
c
->
cm_size
 = 
ˇche_size
;

41 
c
->
cm_‰ì
 = 
ˇche_size
;

42 
c
->
cm_cou¡
 = 0;

43 
	`©omic_£t
(&
c
->
cm_£Æed_cou¡
, 0);

45 
c
->
cm_hash
 = 
	`œrge_¨øy_Æloc
((
hli°_hód
), 
ˇche_size
);

46 if(
c
->
cm_hash
 =
NULL
){

47 
	`¥ötk
(" MÆlo¯Eº‹ %†%d \n",
__FUNCTION__
,
__LINE__
);

48 
	`BUG_ON
(1);

51 
i
 = 0;ò< 
ˇche_size
;i++){

52 
hli°_hód
 *
hash
;

53 
hash
 = (
hli°_hód
 *)
	`œrge_¨øy_©
(
c
->
cm_hash
, (
u64
)
i
);

54 
	`INIT_HLIST_HEAD
 ( 
hash
 );

57 
c
->
cm_ˇche
 = 
	`œrge_¨øy_Æloc
((
Ãu_node
), 
ˇche_size
);

58 if(
c
->
cm_ˇche
 =
NULL
){

59 
	`¥ötk
(" MÆlo¯Eº‹ %†%d \n",
__FUNCTION__
,
__LINE__
);

60 
	`BUG_ON
(1);

63 
i
=0;i<
ˇche_size
;i++){

64 
Ãu_node
 *
 
;

65 
 
 = 
	`œrge_¨øy_©
(
c
->
cm_ˇche
, 
i
);

66 if(!
 
)

69 
	`mem£t
((*)
 
, 0x00, (
Ãu_node
));

70 
	`li°_add
–&
 
->
˙_li°
, &
c
->
cm_‰ì_hód
 );

72 
 
->
˙_∑ge
 = 
	`Æloc_∑ge
(
__GFP_NOWARN
 | 
__GFP_NORETRY
);

73 if(!
 
->
˙_∑ge
){

74 
	`¥ötk
("áŒo¯∑gêEº‹ %†%d \n",
__FUNCTION__
,
__LINE__
);

75 
	`BUG_ON
(1);

78 
	}
}

82 
	$Ãu_˛o£
(
ˇche_m™agî
 *
c
){

83 
Ãu_node
 *
 
, *
ãmp
;

85 
	`li°_f‹_óch_íåy_ß„
(
 
, 
ãmp
, &
c
->
cm_hód
, 
˙_li°
){

86 
	`__‰ì_∑ge
(
 
->
˙_∑ge
);

87 
	`li°_dñ
 ( & 
 
->
˙_li°
 );

88 
	`hli°_dñ
 ( & 
 
->
˙_hash
 );

91 
	`li°_f‹_óch_íåy_ß„
(
 
, 
ãmp
, &
c
->
cm_‰ì_hód
, 
˙_li°
){

92 
	`__‰ì_∑ge
(
 
->
˙_∑ge
);

93 
	`li°_dñ
 ( & 
 
->
˙_li°
 );

96 
	`BUG_ON
 ( !
	`li°_em±y
 ( &
c
->
cm_hód
 ) );

97 
	`BUG_ON
 ( !
	`li°_em±y
 ( &
c
->
cm_‰ì_hód
 ) );

99 
	`œrge_¨øy_‰ì
(
c
->
cm_hash
);

100 
	`œrge_¨øy_‰ì
(
c
->
cm_ˇche
);

101 
	}
}

103 
Ãu_node
 *
	$Ãu_¥e£¨ch
(
ˇche_m™agî
 *
c
, 
£˘‹_t
 
blkno
){

104 
hli°_node
 *
node
;

105 
hli°_hód
 *
hód
;

106 
Ãu_node
 *
 
;

108 
hód
 = (
hli°_hód
 *)
	`œrge_¨øy_©
(
c
->
cm_hash
, 
blkno
%c->
cm_size
);

109 
	`hli°_f‹_óch
 ( 
node
, 
hód
 ) {

110 
 
 = 
	`hli°_íåy
–
node
, 
Ãu_node
, 
˙_hash
 );

111 i‡–
 
->
˙_blkno
 =
blkno
 )

112  
 
;

115  
NULL
;

116 
	}
}

119 
Ãu_node
 *
	$Ãu_£¨ch
(
ˇche_m™agî
 *
c
, 
£˘‹_t
 
blkno
){

120 
Ãu_node
 *
 
;

122 
c
->
cm_ªf
++;

123 
 
 = 
	`Ãu_¥e£¨ch
 ( 
c
, 
blkno
 );

124 if(
 
){

125 
c
->
cm_hô
++;

126  
 
;

128 
c
->
cm_miss
++;

131  
NULL
;

132 
	}
}

135 
	$Ãu_movemru
(
ˇche_m™agî
 *
c
, 
Ãu_node
 *
 
 ) {

136 
	`li°_dñ
 ( &
 
->
˙_li°
 );

137 
	`li°_add
–&
 
->
˙_li°
, &
c
->
cm_hód
 );

138 
	}
}

140 *
	$Ãu_ªmove
(
ˇche_m™agî
 *
c
, 
Ãu_node
 *
 
 ) {

141 
	`li°_dñ
 ( &
 
->
˙_li°
 );

142 
	`hli°_dñ
 ( &
 
->
˙_hash
 );

144 
c
->
cm_‰ì
++;

145 
c
->
cm_cou¡
--;

146  (*)
 
;

147 
	}
}

150 *
	$Ãu_Æloc
(
ˇche_m™agî
 *
c
, 
Ãu_node
 *
 
, 
£˘‹_t
 
blkno
){

151 *
±r
;

152 if(
 
 =
NULL
){

153 
 
 = 
	`li°_fú°_íåy
–&
c
->
cm_‰ì_hód
, 
Ãu_node
, 
˙_li°
);

154 
	`li°_dñ
(&
 
->
˙_li°
);

157 
±r
 = 
 
->
˙_∑ge
;

158 
	`mem£t
((*)
 
, 0x00, (
Ãu_node
));

159 
 
->
˙_∑ge
 = 
±r
;

161 
 
->
˙_blkno
 = 
blkno
;

162  
 
;

163 
	}
}

165 
	$Ãu_ö£π
(
ˇche_m™agî
 *
c
,
Ãu_node
 *
 
){

166 
hli°_hód
 *
hash
;

168 
	`li°_add
–&
 
->
˙_li°
, &
c
->
cm_hód
 );

170 
hash
 = 
	`œrge_¨øy_©
(
c
->
cm_hash
, (
 
->
˙_blkno
Ë% c->
cm_size
);

171 
	`hli°_add_hód
–&
 
->
˙_hash
, 
hash
 ) ;

173 
c
->
cm_‰ì
--;

174 
c
->
cm_cou¡
++;

175 
	}
}

178 *
	$Ãu_ª∂a˚
(
ˇche_m™agî
 *
c
, 
w©îm¨k
){

179 
li°_hód
 *
ªmove_±r
;

180 
Ãu_node
 *
vi˘im
 = 
NULL
;

182 i‡–
c
->
cm_‰ì
 < 
w©îm¨k
 + 1 ) {

183 
ªmove_±r
 = (
li°_hód
 *)(&
c
->
cm_hód
)->
¥ev
;

184 
vi˘im
 = 
	`li°_íåy
 ( 
ªmove_±r
, 
Ãu_node
, 
˙_li°
 );

185 
vi˘im
 = 
	`CACHE_REMOVE
(
c
, victim);

188  
vi˘im
;

189 
	}
}

191 
	$Ãu_öô
(
ˇche_m™agî
 **
c
,*
«me
, 
size
,
high
,
low
){

192 *
c
 = (
ˇche_m™agî
 *)
	`kmÆloc
((ˇche_m™agî), 
GFP_KERNEL
);

193 if(*
c
 =
NULL
){

194 
	`¥ötk
(" MÆlo¯Eº‹ %†%d \n",
__FUNCTION__
,
__LINE__
);

195 
	`BUG_ON
(1);

199 
	`mem£t
(*
c
, 0x00, (
ˇche_m™agî
));

201 
	`•ö_lock_öô
(&((*
c
)->
lock
));

203 (*
c
)->
ˇche_›í
 = 
Ãu_›í
;

204 (*
c
)->
ˇche_˛o£
 = 
Ãu_˛o£
;

205 (*
c
)->
ˇche_¥e£¨ch
 = 
Ãu_¥e£¨ch
;

206 (*
c
)->
ˇche_£¨ch
 = 
Ãu_£¨ch
;

207 (*
c
)->
ˇche_ª∂a˚
 = 
Ãu_ª∂a˚
;

208 (*
c
)->
ˇche_ªmove
 = 
Ãu_ªmove
;

209 (*
c
)->
ˇche_move_mru
 = 
Ãu_movemru
;

210 (*
c
)->
ˇche_ö£π
 = 
Ãu_ö£π
;

211 (*
c
)->
ˇche_Æloc
 = 
Ãu_Æloc
;

213 
	`CACHE_OPEN
((*
c
), 
size
);

215 (*
c
)->
cm_loww©î
 = 
low
;

216 (*
c
)->
cm_highw©î
 = 
high
;

217 
	}
}

219 
	$Ãu_deöô
(
ˇche_m™agî
 *
Ãu_m™agî
){

220 
	`CACHE_CLOSE
(
Ãu_m™agî
);

221 
	`k‰ì
(
Ãu_m™agî
);

222 
	}
}

225 
Ãu_node
 *
	$m_Ãu_ö£π
(
ˇche_m™agî
 **
Ãu_m™agî
, 
k
, 
blkno
){

226 
Ãu_node
 *
 
;

227 
j
;

229 
j
 = 
k
;j > 0;j--){

230 
Ãu_node
 *
vi˘im_ 
;

231 
vi˘im_ 
 = 
	`CACHE_REPLACE
(
Ãu_m™agî
[
j
], 0);

232 if(
vi˘im_ 
){

233 
	`k‰ì
(
vi˘im_ 
);

236 
vi˘im_ 
 = 
	`CACHE_REPLACE
(
Ãu_m™agî
[
j
-1], 0);

237 if(
vi˘im_ 
){

238 
	`CACHE_INSERT
(
Ãu_m™agî
[
j
], 
vi˘im_ 
);

242 
 
 = 
	`CACHE_ALLOC
(
Ãu_m™agî
[0], 
NULL
, 
blkno
);

244 
	`CACHE_INSERT
(
Ãu_m™agî
[0], 
 
);

246  
 
;

247 
	}
}

250 
ˇche_m™agî
 **
	$mÃu_öô
(*
«me
,
Ãu_num
, 
tŸÆ_size
){

251 
ˇche_m™agî
 **
Ãu_m™agî
;

252 
°r
[128];

253 
i
;

256 
Ãu_m™agî
 = (
ˇche_m™agî
 **)
	`kmÆloc
((ˇche_m™agî *Ë* 
Ãu_num
, 
GFP_KERNEL
);

257 if(
Ãu_m™agî
 =
NULL
){

258 
	`¥ötk
(" MÆlo¯Eº‹ %†%d \n",
__FUNCTION__
,
__LINE__
);

259 
	`BUG_ON
(1);

262 
	`mem£t
(
Ãu_m™agî
, 0x00, (
ˇche_m™agî
 *Ë* 
Ãu_num
);

265 if(
tŸÆ_size
%
Ãu_num
){

268 
i
 = 0;ò< 
Ãu_num
;i++){

270 
	`Ãu_öô
(&
Ãu_m™agî
[
i
],
°r
, 
tŸÆ_size
/
Ãu_num
, 1, 0);

273  
Ãu_m™agî
;

274 
	}
}

276 
	$mÃu_exô
(
ˇche_m™agî
 **
Ãu_m™agî
,
Ãu_num
){

277 
i
;

279 
mÃu_hô
 = 0;

281 
i
 = 0;ò< 
Ãu_num
;i++){

283 
mÃu_hô
 +
Ãu_m™agî
[
i
]->
cm_hô
;

284 
	`CACHE_CLOSE
(
Ãu_m™agî
[
i
]);

289 
	}
}

293 
	$mÃu_ªmove
(
ˇche_m™agî
 **
Ãu_m™agî
,
Ãu_num
, 
blkno
){

295 
Ãu_node
 *
 
=
NULL
;

296 
j
;

298 
j
 = 0;j < 
Ãu_num
;j++){

299 
 
 = 
	`CACHE_SEARCH
(
Ãu_m™agî
[
j
], 
blkno
);

300 if(
 
){

305 if(
 
){

306 
 
 = 
	`CACHE_REMOVE
(
Ãu_m™agî
[
j
],Ün);

307 
	`k‰ì
(
 
);

310 
	}
}

312 
Ãu_node
 *
	$mÃu_£¨ch
(
ˇche_m™agî
 **
Ãu_m™agî
,
Ãu_num
, 
blkno
, 
ö£π
,
hô
, *
hô_posôi⁄
){

313 
Ãu_node
 *
 
=
NULL
;

314 
j
;

316 
j
 = 0;j < 
Ãu_num
;j++){

317 
 
 = 
	`CACHE_SEARCH
(
Ãu_m™agî
[
j
], 
blkno
);

319 i‡–
hô_posôi⁄
 )

320 *
hô_posôi⁄
 = 
j
;

322 if(
 
){

336 if(!
hô
){

337 
Ãu_m™agî
[0]->
cm_ªf
--;

338 if(
 
){

339 
Ãu_m™agî
[
j
]->
cm_hô
--;

343 if(!
ö£π
){

344  
 
;

347 if(!
 
){

348 
 
 = 
	`m_Ãu_ö£π
(
Ãu_m™agî
, 
Ãu_num
 - 1, 
blkno
);

350 
 
 = 
	`CACHE_REMOVE
(
Ãu_m™agî
[
j
],Ün);

351 
	`k‰ì
(
 
);

352 
 
 = 
	`m_Ãu_ö£π
(
Ãu_m™agî
, 
j
, 
blkno
);

355  
 
;

356 
	}
}

	@lru.h

23 
	~<löux/li°.h
>

24 
	~"mëad©a.h
"

26 #i‚de‡
_CACHE_H


27 
	#_CACHE_H


	)

29 
	sÃu_node
{

30 
li°_hód
 
	m˙_li°
;

31 
li°_hód
 
	m˙_wrôe_li°
;

32 
hli°_node
 
	m˙_hash
;

33 
∑ge
 *
	m˙_∑ge
;

35 
£˘‹_t
 
	m˙_blkno
;

36 
u32
 
	m¸c32
;

37 
	m˙_ªad_hô
;

38 
	m˙_wrôe_hô
;

39 
	m˙_ªad_ªf
;

40 
	m˙_wrôe_ªf
;

41 
	m˙_Æloc_by_gc
;

42 
©omic_t
 
	m£Æed
;

43 
©omic_t
 
	mlocked
;

46 
	sˇche_m™agî
{

47 
•ölock_t
 
	mlock
;

48 
li°_hód
 
	mcm_hód
;

49 
li°_hód
 
	mcm_‰ì_hód
;

50 
œrge_¨øy
 *
	mcm_hash
;

51 
œrge_¨øy
 *
	mcm_ˇche
;

53 
	mcm_hô
;

54 
	mcm_miss
;

55 
	mcm_ªf
;

56 
	mcm_ªad_hô
;

57 
	mcm_ªad_ªf
;

59 
©omic_t
 
	mcm_£Æed_cou¡
;

61 
	mcm_size
;

62 
	mcm_‰ì
;

63 
	mcm_cou¡
;

64 
	mcm_mö
;

65 *
	mcm_«me
;

67 
	mcm_loww©î
;

68 
	mcm_highw©î
;

70 (*
	mˇche_›í
)(
ˇche_m™agî
 *
	mˇche
,
	mˇche_size
);

71 (*
	mˇche_˛o£
)(
ˇche_m™agî
 *
	mˇche
);

72 
	mÃu_node
 *(*
	mˇche_¥e£¨ch
)(
ˇche_m™agî
 *
	mˇche
, 
£˘‹_t
 
	mblkno
);

73 
	mÃu_node
 *(*
	mˇche_£¨ch
)(
ˇche_m™agî
 *
	mˇche
, 
£˘‹_t
 
	mblkno
);

74 *(*
	mˇche_ª∂a˚
)(
ˇche_m™agî
 *
	mˇche
, 
	mw
);

75 *(*
	mˇche_ªmove
)(
ˇche_m™agî
 *
	mˇche
, 
Ãu_node
 *
	m 
);

76 (*
	mˇche_move_mru
)(
ˇche_m™agî
 *
	mˇche
, 
Ãu_node
 *
	m 
);

77 (*
	mˇche_ö£π
)(
ˇche_m™agî
 *
	mˇche
, 
Ãu_node
 *
	mnode
);

78 *(*
	mˇche_Æloc
)(
ˇche_m™agî
 *
	mˇche
, 
Ãu_node
 *
	mnode
, 
£˘‹_t
 
	mblkno
);

79 (*
	mˇche_öc
)(
ˇche_m™agî
 *
	mˇche
, 
	mi
);

80 (*
	mˇche_dec
)(
ˇche_m™agî
 *
	mˇche
, 
	mi
);

83 
	#CACHE_OPEN
(
c
, 
sz
Ëc->
	`ˇche_›í
((
ˇche_m™agî
 *)c, sz)

	)

84 
	#CACHE_CLOSE
(
c
 ) c->
	`ˇche_˛o£
((
ˇche_m™agî
 *)c)

	)

85 
	#CACHE_PRESEARCH
(
c
, 
p
Ëc->
	`ˇche_¥e£¨ch
((
ˇche_m™agî
 *)c,Ö)

	)

86 
	#CACHE_SEARCH
(
c
, 
p
Ëc->
	`ˇche_£¨ch
((
ˇche_m™agî
 *)c,Ö)

	)

87 
	#CACHE_REPLACE
(
c
, 
w
Ëc->
	`ˇche_ª∂a˚
((
ˇche_m™agî
 *)c, w)

	)

88 
	#CACHE_MOVEMRU
(
c
, 
w
Ëc->
	`ˇche_move_mru
((
ˇche_m™agî
 *)c, w)

	)

89 
	#CACHE_REMOVE
(
c
, 
p
Ëc->
	`ˇche_ªmove
((
ˇche_m™agî
 *)c,Ö)

	)

90 
	#CACHE_INSERT
(
c
, 
p
Ëc->
	`ˇche_ö£π
((
ˇche_m™agî
 *)c,Ö)

	)

91 
	#CACHE_ALLOC
(
c
, 
n
, 
p
Ëc->
	`ˇche_Æloc
(c,Ç,Ö)

	)

92 
	#CACHE_PRINT
(
c
, 
p
Ëc->
	`ˇche_¥öt
((
ˇche_m™agî
 *)c,Ö)

	)

95 
Ãu_›í
(
ˇche_m™agî
 *
c
,
ˇche_size
);

96 
Ãu_˛o£
(
ˇche_m™agî
 *
c
);

97 
Ãu_node
 *
Ãu_¥e£¨ch
(
ˇche_m™agî
 *
c
, 
£˘‹_t
 
blkno
);

98 
Ãu_node
 *
Ãu_£¨ch
(
ˇche_m™agî
 *
c
, 
£˘‹_t
 
blkno
);

99 *
Ãu_ªmove
(
ˇche_m™agî
 *
c
, 
Ãu_node
 *
 
);

100 *
Ãu_Æloc
(
ˇche_m™agî
 *
c
, 
Ãu_node
 *
 
, 
£˘‹_t
 
blkno
);

101 
Ãu_ö£π
(
ˇche_m™agî
 *
c
,
Ãu_node
 *
 
);

102 *
Ãu_ª∂a˚
(
ˇche_m™agî
 *
c
, 
w©îm¨k
);

103 
Ãu_öô
(
ˇche_m™agî
 **
c
,*
«me
, 
size
,
high
,
low
);

104 
Ãu_deöô
(
ˇche_m™agî
 *
Ãu_m™agî
);

105 
Ãu_move_˛ón_li°
 ( 
ˇche_m™agî
 *
c
, 
Ãu_node
 *
 
 );

108 
Ãu_node
 *
mÃu_£¨ch
(
ˇche_m™agî
 **
Ãu_m™agî
,
Ãu_num
, 
blkno
, 
ö£π
,
hô
, *
hô_posôi⁄
);

109 
mÃu_ªmove
(
ˇche_m™agî
 **
Ãu_m™agî
,
Ãu_num
, 
blkno
);

110 
ˇche_m™agî
 **
mÃu_öô
(*
«me
,
Ãu_num
, 
tŸÆ_size
);

111 
mÃu_exô
(
ˇche_m™agî
 **
Ãu_m™agî
,
Ãu_num
);

	@metadata.c

23 
	~<löux/vmÆloc.h
>

24 
	~<löux/¸c32.h
>

25 
	~"èrgë.h
"

26 
	~"mëad©a.h
"

27 
	~"d´m⁄.h
"

28 
	~"Æloc.h
"

29 
	~"hódî.h
"

30 
	~<löux/li°.h
>

31 
	~<löux/log2.h
>

32 
	~<löux/øndom.h
>

34 
u32
 
	$gë_cuº_utû
(
dm§c_su≥r
 *
su≥r
){

35 
u32
 
utû
=0;

37 if(
	`©omic_ªad
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
)){

38 
utû
 = (
u32
)((
u64
)
	`©omic_ªad
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
)*100/
NUM_BLOCKS
);

40 if(
utû
>=100)

41 
utû
 = 0;

44  
utû
;

45 
	}
}

47 #ifde‡
KMALLOC


48 
u32
 
	$num_ñems_ö_∑π
(
œrge_¨øy
 *
¨r
)

50  
	`div_u64
(
ALLOC_SIZE
, 
¨r
->
ñemsize
);

51 
	}
}

54 
u64
 
	$num_∑πs
(
œrge_¨øy
 *
¨r
)

56 
u64
 
a
 = 
¨r
->
num_ñems
;

57 
u32
 
b
 = 
	`num_ñems_ö_∑π
(
¨r
);

58  
	`div_u64
(
a
 + 
b
 - 1, b);

59 
	}
}

62 
œrge_¨øy
 *
	$œrge_¨øy_Æloc
(
u32
 
ñemsize
, 
u64
 
num_ñems
)

64 
∑π
 *part;

65 
u64
 
Æloc_size
 = 0;

67 #ifde‡
VMALLOC


68 
œrge_¨øy
 *
¨r
 = 
	`kmÆloc
((*¨r), 
GFP_KERNEL
);

69 i‡(!
¨r
) {

70 
	`WBERR
("failedÅoállocárr");

71  
NULL
;

74 
¨r
->
ñemsize
 =Élemsize;

75 
¨r
->
num_ñems
 =Çum_elems;

76 
¨r
->
∑πs
 = 
	`kmÆloc
((
∑π
), 
GFP_KERNEL
);

77 i‡(!
¨r
->
∑πs
) {

78 
	`WBERR
("failedÅoállocÖarts");

79 
bad_Æloc_∑πs
;

81 
∑π
 = 
¨r
->
∑πs
 + 0;

82 
∑π
->
mem‹y
 = 
	`vmÆloc
(
ñemsize
 * 
num_ñems
);

83 i‡(!
∑π
->
mem‹y
) {

84 
	`WBERR
("failedÅoállocÖart memory");

85 
	`v‰ì
(
∑π
->
mem‹y
);

86 
bad_Æloc_∑πs_mem‹y
;

89 
Æloc_size
 = 
ñemsize
 * 
num_ñems
;

90 
	`¥ötk
(" Mëad©®AŒoˇti⁄: %ŒuMB (%Œu)\n", 
Æloc_size
/1024/1024,álloc_size);

92 
u64
 
i
, 
j
;

93 
œrge_¨øy
 *
¨r
 = 
	`kmÆloc
((*¨r), 
GFP_KERNEL
);

94 i‡(!
¨r
) {

95 
	`WBERR
("failedÅoállocárr");

96  
NULL
;

99 
¨r
->
ñemsize
 =Élemsize;

100 
¨r
->
num_ñems
 =Çum_elems;

101 
¨r
->
∑πs
 = 
	`kmÆloc
((
∑π
Ë* 
	`num_∑πs
◊º), 
GFP_KERNEL
);

102 i‡(!
¨r
->
∑πs
) {

103 
	`WBERR
("failedÅoállocÖarts");

104 
bad_Æloc_∑πs
;

107 
i
 = 0; i < 
	`num_∑πs
(
¨r
); i++) {

108 
∑π
 = 
¨r
->
∑πs
 + 
i
;

109 
∑π
->
mem‹y
 = 
	`kmÆloc
(
ALLOC_SIZE
, 
GFP_KERNEL
);

111 
Æloc_size
 +
ALLOC_SIZE
;

112 i‡(!
∑π
->
mem‹y
) {

113 
	`WBERR
("failedÅoállocÖart memory");

114 
j
 = 0; j < 
i
; j++) {

115 
∑π
 = 
¨r
->
∑πs
 + 
j
;

116 
	`k‰ì
(
∑π
->
mem‹y
);

118 
bad_Æloc_∑πs_mem‹y
;

121 
	`¥ötk
(" Mëad©®AŒoˇti⁄: %ŒuMB (%Œu)\n", 
Æloc_size
/1024/1024,álloc_size);

124  
¨r
;

126 
bad_Æloc_∑πs_mem‹y
:

127 
	`k‰ì
(
¨r
->
∑πs
);

128 
bad_Æloc_∑πs
:

129 
	`k‰ì
(
¨r
);

131  
NULL
;

132 
	}
}

134 
	$œrge_¨øy_‰ì
(
œrge_¨øy
 *
¨r
)

137 #ifde‡
VMALLOC


138 
∑π
 *∑π = 
¨r
->
∑πs
 + 0;

139 
	`v‰ì
(
∑π
->
mem‹y
);

141 
size_t
 
i
;

142 
i
 = 0; i < 
	`num_∑πs
(
¨r
); i++) {

143 
∑π
 *∑π = 
¨r
->
∑πs
 + 
i
;

145 
	`k‰ì
(
∑π
->
mem‹y
);

147 
	`k‰ì
(
¨r
->
∑πs
);

148 
	`k‰ì
(
¨r
);

150 
	}
}

151 #ifde‡
KMALLOC


152 *
	$œrge_¨øy_©
(
œrge_¨øy
 *
¨r
, 
u64
 
i
)

154 
u32
 
n
 = 
	`num_ñems_ö_∑π
(
¨r
);

155 
u32
 
k
;

156 
u64
 
j
 = 
	`div_u64_ªm
(
i
, 
n
, &
k
);

157 
∑π
 *∑π = 
¨r
->
∑πs
 + 
j
;

158  
∑π
->
mem‹y
 + (
¨r
->
ñemsize
 * 
k
);

159 
	}
}

161 *
	$œrge_¨øy_©
(
œrge_¨øy
 *
¨r
, 
u32
 
i
)

163 
∑π
 *∑π = 
¨r
->
∑πs
 + 0;

164 
	`BUG_ON
(
i
>=
¨r
->
num_ñems
);

165  
∑π
->
mem‹y
 + (
¨r
->
ñemsize
 * 
i
);

166 
	}
}

174 
mëablock
 *
	$mb_©
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
)

176 
mëablock
 *
mb
;

177 
u32
 
devno
 = (
idx
 / 
CHUNK_SZ
Ë% 
NUM_SSD
;

178 
u32
 
off£t
 = 
idx
 / 
STRIPE_SZ
 * 
CHUNK_SZ
 + (idx % CHUNK_SZ);

180 if(
off£t
>=
NUM_BLOCKS_PER_SSD
){

181 
	`¥ötk
(" idx = %u\n", 
idx
);

182 
	`¥ötk
(" devnÿ%u, off£à%u \n", 
devno
, 
off£t
);

183 
	`¥ötk
("Çum block†≥∏ssd = %u \n", 
NUM_BLOCKS_PER_SSD
);

184 
	`¥ötk
("Çum block†%u \n", 
NUM_BLOCKS
);

185 
	`BUG_ON
(1);

188 
mb
 = (
mëablock
 *)
	`œrge_¨øy_©
(
su≥r
->
mëablock_¨øy
[
devno
], 
off£t
);

190  
mb
;

191 
	}
}

193 
ölöe
 
mëablock
 *
	$gë_mb
(
dm§c_su≥r
 *
su≥r
, 
u32
 
£g_id
, u32 
idx
){

194  
	`mb_©
(
su≥r
, 
£g_id
 * 
STRIPE_SZ
 + 
idx
);

195 
	}
}

197 
	$mb_¨øy_em±y_öô
(
dm§c_su≥r
 *
su≥r
)

199 
u32
 
i
;

200 
i
 = 0; i < 
NUM_BLOCKS
; i++) {

201 
mëablock
 *
mb
 = 
	`mb_©
(
su≥r
, 
i
);

203 
	`INIT_HLIST_NODE
(&
mb
->
ht_li°
);

205 
mb
->
idx
 = 
i
;

206 
mb
->
£˘‹
 = ~0;

207 
mb
->
mb_Êags
 = 0;

210 
	`˛ór_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
);

211 
	`˛ór_bô
(
MB_VALID
, &
mb
->
mb_Êags
);

212 
	`˛ór_bô
(
MB_SEAL
, &
mb
->
mb_Êags
);

213 
	`˛ór_bô
(
MB_META
, &
mb
->
mb_Êags
);

214 
	`˛ór_bô
(
MB_SUMMARY
, &
mb
->
mb_Êags
);

215 
	`˛ór_bô
(
MB_BROKEN
, &
mb
->
mb_Êags
);

216 
	`˛ór_bô
(
MB_PARITY_NEED
, &
mb
->
mb_Êags
);

217 
	`˛ór_bô
(
MB_PARITY_WRITTEN
, &
mb
->
mb_Êags
);

220 
	}
}

222 
	$check_dúty_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
cur_£g
){

223 
i
;

224 
dúty_cou¡
 = 0;

226 
i
 = 0; i < 
STRIPE_SZ
; i++) {

227 
mëablock
 *
mb
 = 
	`gë_mb
(
su≥r
, 
cur_£g
->
£g_id
, 
i
);

228 if(
	`ã°_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
)||

229 
	`ã°_bô
(
MB_PARITY
, &
mb
->
mb_Êags
)||

230 
	`ã°_bô
(
MB_SUMMARY
, &
mb
->
mb_Êags
)){

231 
dúty_cou¡
++;

235 if(
	`is_wrôe_°rùe
(
cur_£g
->
£g_ty≥
)){

236 
dúty_cou¡
 +
NUM_SUMMARY
*
NUM_DATA_SSD
;

237 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
))

238 
dúty_cou¡
 +
CHUNK_SZ
;

240 
dúty_cou¡
 +(
NUM_SUMMARY
*
NUM_SSD
);

243  
dúty_cou¡
;

244 
	}
}

246 
	$check_vÆid_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
cur_£g
){

247 
i
;

248 
vÆid_cou¡
 = 0;

250 
i
 = 0; i < 
STRIPE_SZ
; i++) {

251 
mëablock
 *
mb
 = 
	`gë_mb
(
su≥r
, 
cur_£g
->
£g_id
, 
i
);

252 if(
	`ã°_bô
(
MB_VALID
, &
mb
->
mb_Êags
)||

253 
	`ã°_bô
(
MB_PARITY
, &
mb
->
mb_Êags
)||

254 
	`ã°_bô
(
MB_SUMMARY
, &
mb
->
mb_Êags
)){

255 
vÆid_cou¡
++;

258 if(
	`is_wrôe_°rùe
(
cur_£g
->
£g_ty≥
)){

259 if(
	`ã°_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
Ë!ã°_bô(
MB_VALID
, &mb->mb_flags)){

260 
	`¥ötk
(" seg id = %d offset = %d Invalid mb dirty mb valid = %d %d \n",

261 ()
cur_£g
->
£g_id
,

262 
i
,

263 ()
	`ã°_bô
(
MB_VALID
, &
mb
->
mb_Êags
),

264 ()
	`ã°_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
));

271 if(
	`is_wrôe_°rùe
(
cur_£g
->
£g_ty≥
)){

272 
vÆid_cou¡
 +
NUM_SUMMARY
*
NUM_DATA_SSD
;

273 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
))

274 
vÆid_cou¡
 +
CHUNK_SZ
;

276 
vÆid_cou¡
 +(
NUM_SUMMARY
*
NUM_SSD
);

279  
vÆid_cou¡
;

280 
	}
}

282 
	$mb_¨øy_ßnôy_check
(
dm§c_su≥r
 *
su≥r
)

284 
u32
 
i
;

285 
u32
 
£g_id
;

286 
£gmít_hódî
 *
cur_£g
;

288 
£g_id
 = 0; seg_id < 
su≥r
->
ˇche_°©
.
num_£gmíts
; seg_id++) {

289 
vÆid_cou¡
 = 0;

290 
dúty_cou¡
 = 0;

291 
cur_£g
 = 
	`gë_£gmít_hódî_by_id
(
su≥r
, 
£g_id
);

293 if(
	`ã°_bô
(
SEG_CLEAN
, &
cur_£g
->
Êags
))

296 
vÆid_cou¡
 = 
	`check_vÆid_cou¡
(
su≥r
, 
cur_£g
);

297 
dúty_cou¡
 = 
	`check_dúty_cou¡
(
su≥r
, 
cur_£g
);

306 if(
vÆid_cou¡
!=
	`©omic_ªad
(&
cur_£g
->valid_count)){

307 
	`¥ötk
(" InvÆid seg id = %d, vÆid = %d %d \n", 
£g_id
, 
vÆid_cou¡
,

308 ()
	`©omic_ªad
(&
cur_£g
->
vÆid_cou¡
));

310 if(
dúty_cou¡
!=
	`©omic_ªad
(&
cur_£g
->dirty_count)){

311 
	`¥ötk
(" InvÆid seg id = %d, dúty = %d %d \n", 
£g_id
, 
dúty_cou¡
,

312 ()
	`©omic_ªad
(&
cur_£g
->
dúty_cou¡
));

317 
i
 = 0; i < 
NUM_BLOCKS
; i++) {

318 
mëablock
 *
mb
 = 
	`mb_©
(
su≥r
, 
i
);

320 if(
mb
->
£˘‹
=~0 && (
	`ã°_bô
(
MB_DIRTY
, &mb->
mb_Êags
) ||

321 
	`ã°_bô
(
MB_VALID
, &
mb
->
mb_Êags
)))

323 
	`¥ötk
(" %d: sector = %d, dirty = %d, valid = %d \n",

324 
i
, ()
mb
->
£˘‹
, 
	`ã°_bô
(
MB_DIRTY
, &mb->
mb_Êags
),

325 
	`ã°_bô
(
MB_VALID
, &
mb
->
mb_Êags
));

328 
	}
}

330 
	$£g_°©
(
£gmít_hódî
 *
£g
){

331 
ªs
 = 0;

332 
cou¡
 = 0;

334 if(
	`ã°_bô
(
SEG_CLEAN
, &
£g
->
Êags
)){

335 
ªs
 +
SEG_CLEAN
;

336 
cou¡
++;

339 if(
	`ã°_bô
(
SEG_USED
, &
£g
->
Êags
)){

340 
ªs
 +
SEG_USED
;

341 
cou¡
++;

343 if(
	`ã°_bô
(
SEG_SEALED
, &
£g
->
Êags
)){

344 
ªs
 +
SEG_SEALED
;

345 
cou¡
++;

348 if(
	`ã°_bô
(
SEG_MIGRATING
, &
£g
->
Êags
)){

349 
ªs
 +
SEG_MIGRATING
;

350 
cou¡
++;

352 if(
	`ã°_bô
(
SEG_PARTIAL
, &
£g
->
Êags
)){

353 
ªs
 +
SEG_PARTIAL
;

354 
cou¡
++;

356 if(
	`ã°_bô
(
SEG_RECOVERY
, &
£g
->
Êags
)){

357 
ªs
 +
SEG_RECOVERY
;

358 
cou¡
++;

360 if(
	`ã°_bô
(
SEG_HIT
, &
£g
->
Êags
)){

361 
ªs
 +
SEG_HIT
;

362 
cou¡
++;

365 if(
cou¡
 == 1){

366  
ªs
;

368 
	`¥ötk
(" sèà%d cou¡ = %d \n", 
ªs
, 
cou¡
);

371 
	}
}

373 
	$¥öt_Æloc_queue
(
dm§c_su≥r
 *
su≥r
){

374 
Êags
;

375 
£gmít_hódî
 *
£g
;

376 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

378 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

379 
	`¥ötk
(" seg:álloc = %d, used = %d, sealed = %d, migrate = %d\n",

380 ()
	`©omic_ªad
(&
£g_Æloˇt‹
->
£g_Æloc_cou¡
), ()£g_Æloˇt‹->
£g_u£d_cou¡
,

381 ()
£g_Æloˇt‹
->
£g_£Æed_cou¡
,

382 ()
	`©omic_ªad
(&
£g_Æloˇt‹
->
£g_migøã_cou¡
));

386 
	`li°_f‹_óch_íåy
(
£g
, &
£g_Æloˇt‹
->
£g_u£d_queue
, 
Æloc_li°
){

387 
	`¥ötk
("áŒoc_queue: seg id = %d inu£ = %dÜígth = %dÅy≥ = %d, bufc›y = %d, bio†%d \n", ()
£g
->
£g_id
,

388 
	`£g_°©
(
£g
), ()
	`©omic_ªad
(&£g->
Àngth
), ()£g->
£g_ty≥
,

389 ()
	`©omic_ªad
(&
£g
->
num_bufc›y
), (Ôtomic_ªad(&£g->
bios_cou¡
));

392 
	`¥ötk
(" group:álloc = %d, used = %d, sealed = %d, migrate = %d\n",

393 ()
	`©omic_ªad
(&
£g_Æloˇt‹
->
group_Æloc_cou¡
), ()£g_Æloˇt‹->
group_u£d_cou¡
,

394 ()
£g_Æloˇt‹
->
group_£Æed_cou¡
,

395 ()
	`©omic_ªad
(&
£g_Æloˇt‹
->
group_migøã_cou¡
));

397 
	`¥ötk
("\n");

401 
cou¡
 = 0;

402 
	`li°_f‹_óch_íåy
(
£g
, &
£g_Æloˇt‹
->
migøã_queue
, 
Æloc_li°
){

403 
	`¥ötk
(" migøã_queue: seg id = %d inu£ = %dÜígth = %d vÆid = %dÅy≥ = %d, bufc›y = %d \n", ()
£g
->
£g_id
,

404 
	`£g_°©
(
£g
), ()
	`©omic_ªad
(&£g->
Àngth
),

405 ()
	`©omic_ªad
(&
£g
->
vÆid_cou¡
),

406 ()
£g
->
£g_ty≥
,

407 ()
	`©omic_ªad
(&
£g
->
num_bufc›y
));

408 
cou¡
++;

409 if(
cou¡
>100)

414 
	`¥ötk
("\n");

417 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

418 
	}
}

420 
	$ö£π_group_to_Æloc_queue
(
dm§c_su≥r
 *
su≥r
, 
group_hódî
 *
group
){

421 
Êags
;

422 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

423 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
group_Æloc_queue
;

425 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

426 
	`li°_add
(&
group
->
Æloc_li°
, 
queue
);

427 
	`©omic_öc
(&
£g_Æloˇt‹
->
group_Æloc_cou¡
);

428 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

432 
	}
}

434 
	$ö£π_£g_to_Æloc_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

435 
Êags
;

436 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

437 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
£g_Æloc_queue
;

439 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

440 
	`li°_add
(&
£g
->
Æloc_li°
, 
queue
);

441 
	`©omic_öc
(&
£g_Æloˇt‹
->
£g_Æloc_cou¡
);

442 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

444 if(
	`©omic_ªad
(&
£g_Æloˇt‹
->
£g_Æloc_cou¡
)>=
MIGRATE_LOWWATER
)

445 
	`wake_up_öãºu±ibÀ
(&
£g_Æloˇt‹
->
Æloc_waô_queue
);

446 
	}
}

448 
	$em±y_Æloc_queue
(
dm§c_su≥r
 *
su≥r
){

449 
Êags
;

450 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

451 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
£g_Æloc_queue
;

452 
em±y
;

454 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

455 
em±y
 = 
	`li°_em±y
(
queue
);

456 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

457  
em±y
;

458 
	}
}

461 
	$ªÀa£_ª£rve_£gs
(
dm§c_su≥r
 *
su≥r
){

462 
Êags
;

463 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

464 
li°_hód
 *
Æloc_queue
 = &
£g_Æloˇt‹
->alloc_queue;

465 
li°_hód
 *
ª£rve_queue
 = &
£g_Æloˇt‹
->reserve_queue;

466 
£gmít_hódî
 *
£g
, *
ãmp
;

467 
cou¡
 = 0;

469 if(!
	`©omic_ªad
(&
£g_Æloˇt‹
->
ª£rve_cou¡
))

472 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

474 
	`li°_f‹_óch_íåy_ß„
(
£g
, 
ãmp
, 
ª£rve_queue
, 
Æloc_li°
){

475 
	`li°_dñ
(&
£g
->
Æloc_li°
);

476 
	`©omic_dec
(&
£g_Æloˇt‹
->
ª£rve_cou¡
);

478 
	`li°_add
(&
£g
->
Æloc_li°
, 
Æloc_queue
);

479 
	`©omic_öc
(&
£g_Æloˇt‹
->
Æloc_cou¡
);

480 
cou¡
 = 0;

487 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

489 if(
	`©omic_ªad
(&
£g_Æloˇt‹
->
Æloc_cou¡
)>=
MIGRATE_LOWWATER
)

490 
	`wake_up_öãºu±ibÀ
(&
£g_Æloˇt‹
->
Æloc_waô_queue
);

491 
	}
}

493 
	$ª£rve_ª£rve_£gs
(
dm§c_su≥r
 *
su≥r
, 
√ed_£gs
){

494 
Êags
;

495 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

496 
li°_hód
 *
Æloc_queue
 = &
£g_Æloˇt‹
->alloc_queue;

497 
li°_hód
 *
ª£rve_queue
 = &
£g_Æloˇt‹
->reserve_queue;

498 
li°_hód
 *
±r
;

499 
£gmít_hódî
 *
£g
;

500 
ªs
 = 1;

501 
i
;

503 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

509 if(
	`©omic_ªad
(&
£g_Æloˇt‹
->
Æloc_cou¡
Ë< 
√ed_£gs
){

510 
ªs
 = 0;

511 
föish
;

516 
i
 = 0;ò< 
√ed_£gs
;i++){

517 
±r
 = 
Æloc_queue
->
¥ev
;

518 
£g
 = (
£gmít_hódî
 *)

519 
	`li°_íåy
(
±r
, 
£gmít_hódî
, 
Æloc_li°
);

520 
	`li°_dñ
(&
£g
->
Æloc_li°
);

521 
	`©omic_dec
(&
£g_Æloˇt‹
->
Æloc_cou¡
);

523 
	`li°_add
(&
£g
->
Æloc_li°
, 
ª£rve_queue
);

524 
	`©omic_öc
(&
£g_Æloˇt‹
->
ª£rve_cou¡
);

529 
föish
:;

530 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

531  
ªs
;

532 
	}
}

536 
£gmít_hódî
 *
	$ªmove_ª£rve_queue
(
dm§c_su≥r
 *
su≥r
){

537 
Êags
;

538 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

539 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
ª£rve_queue
;

540 
li°_hód
 *
±r
;

541 
£gmít_hódî
 *
£g
;

543 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

544 
±r
 = 
queue
->
¥ev
;

545 if(!
	`li°_em±y
(
queue
)){

546 
£g
 = (
£gmít_hódî
 *)

547 
	`li°_íåy
(
±r
, 
£gmít_hódî
, 
Æloc_li°
);

548 
	`li°_dñ
(&
£g
->
Æloc_li°
);

549 
	`©omic_dec
(&
£g_Æloˇt‹
->
ª£rve_cou¡
);

552 
	`BUG_ON
(1);

553 
£g
 = 
NULL
;

555 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

556  
£g
;

557 
	}
}

560 
group_hódî
 *
	$ªmove_Æloc_group_queue
(
dm§c_su≥r
 *
su≥r
){

561 
Êags
;

562 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

563 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
group_Æloc_queue
;

564 
li°_hód
 *
±r
;

565 
group_hódî
 *
group
;

567 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

568 
±r
 = 
queue
->
¥ev
;

569 if(!
	`li°_em±y
(
queue
)){

570 
group
 = (
group_hódî
 *)

571 
	`li°_íåy
(
±r
, 
group_hódî
, 
Æloc_li°
);

572 
	`li°_dñ
(&
group
->
Æloc_li°
);

573 
	`©omic_dec
(&
£g_Æloˇt‹
->
group_Æloc_cou¡
);

575 
group
 = 
NULL
;

577 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

578  
group
;

579 
	}
}

581 
£gmít_hódî
 *
	$ªmove_Æloc_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

582 
Êags
;

583 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

584 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
£g_Æloc_queue
;

585 
li°_hód
 *
±r
;

588 
	`BUG_ON
(
£g
==
NULL
);

589 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

590 
±r
 = 
queue
->
¥ev
;

591 if(!
	`li°_em±y
(
queue
)){

594 
	`li°_dñ
(&
£g
->
Æloc_li°
);

595 
	`©omic_dec
(&
£g_Æloˇt‹
->
£g_Æloc_cou¡
);

597 
£g
 = 
NULL
;

599 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

600  
£g
;

601 
	}
}

603 
	$ö£π_group_to_u£d_queue
(
dm§c_su≥r
 *
su≥r
, 
group_hódî
 *
group
){

604 
Êags
;

605 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

606 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
group_u£d_queue
;

608 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

609 
	`li°_add
(&
group
->
Æloc_li°
, 
queue
);

610 
£g_Æloˇt‹
->
group_u£d_cou¡
++;

611 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

612 
	}
}

614 
	$ö£π_£g_to_u£d_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

615 
Êags
;

616 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

617 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
£g_u£d_queue
;

619 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

620 
	`li°_add
(&
£g
->
Æloc_li°
, 
queue
);

621 
£g_Æloˇt‹
->
£g_u£d_cou¡
++;

622 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

623 
	}
}

625 
	$em±y_£Æed_queue
(
dm§c_su≥r
 *
su≥r
){

626 
Êags
;

627 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

628 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
£g_£Æed_queue
;

629 
em±y
;

631 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

632 
em±y
 = 
	`li°_em±y
(
queue
);

633 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

634  
em±y
;

635 
	}
}

637 
	$gë_group_Æloc_cou¡
(
dm§c_su≥r
 *
su≥r
){

638 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

639 
Êags
;

640 
cou¡
;

642 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

643 
cou¡
 = 
	`©omic_ªad
(&
£g_Æloˇt‹
->
group_Æloc_cou¡
);

644 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

645  
cou¡
;

646 
	}
}

648 
	$gë_Æloc_cou¡
(
dm§c_su≥r
 *
su≥r
){

649 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

650 
Êags
;

651 
cou¡
;

653 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

654 
cou¡
 = 
	`©omic_ªad
(&
£g_Æloˇt‹
->
£g_Æloc_cou¡
);

655 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

656  
cou¡
;

657 
	}
}

660 
	$move_group_u£d_to_£Æed_queue
(
dm§c_su≥r
 *
su≥r
, 
group_hódî
 *
group
){

661 
Êags
;

662 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

663 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
group_£Æed_queue
;

665 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

666 
	`li°_dñ
(&
group
->
Æloc_li°
);

667 
	`li°_add_èû
(&
group
->
Æloc_li°
, 
queue
);

668 
	`BUG_ON
(
£g_Æloˇt‹
->
group_u£d_cou¡
==0);

669 
£g_Æloˇt‹
->
group_u£d_cou¡
--;

670 
£g_Æloˇt‹
->
group_£Æed_cou¡
++;

671 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

672 
	}
}

674 
	$move_£g_u£d_to_£Æed_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

675 
Êags
;

676 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

677 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
£g_£Æed_queue
;

679 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

680 
	`li°_dñ
(&
£g
->
Æloc_li°
);

681 
	`li°_add
(&
£g
->
Æloc_li°
, 
queue
);

682 
	`BUG_ON
(
£g_Æloˇt‹
->
£g_u£d_cou¡
==0);

683 
£g_Æloˇt‹
->
£g_u£d_cou¡
--;

684 
£g_Æloˇt‹
->
£g_£Æed_cou¡
++;

685 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

686 
	}
}

688 
	$move_£g_mru_£Æed
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

689 
Êags
;

690 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

691 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
£g_£Æed_queue
;

693 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

694 
	`li°_dñ
(&
£g
->
Æloc_li°
);

695 
	`li°_add
(&
£g
->
Æloc_li°
, 
queue
);

696 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

697 
	}
}

699 
	$move_group_£Æed_to_migøã_queue
(
dm§c_su≥r
 *
su≥r
, 
group_hódî
 *
group
, 
lock
){

700 
Êags
;

701 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

702 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
group_migøã_queue
;

704 if(
lock
)

705 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

707 
	`li°_dñ
(&
group
->
Æloc_li°
);

708 
	`li°_add
(&
group
->
Æloc_li°
, 
queue
);

709 
£g_Æloˇt‹
->
group_£Æed_cou¡
--;

710 
	`©omic_öc
(&
£g_Æloˇt‹
->
group_migøã_cou¡
);

712 if(
lock
)

713 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

714 
	}
}

717 
	$move_£g_£Æed_to_migøã_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
lock
){

718 
Êags
;

719 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

720 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
£g_migøã_queue
;

722 if(
lock
)

723 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

725 
	`li°_dñ
(&
£g
->
Æloc_li°
);

726 
	`li°_add
(&
£g
->
Æloc_li°
, 
queue
);

727 
£g_Æloˇt‹
->
£g_£Æed_cou¡
--;

728 
	`©omic_öc
(&
£g_Æloˇt‹
->
£g_migøã_cou¡
);

730 if(
lock
)

731 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

732 
	}
}

734 
	$move_£g_migøã_to_£Æed_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

735 
Êags
;

736 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

737 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
£g_£Æed_queue
;

739 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

740 
	`li°_dñ
(&
£g
->
Æloc_li°
);

741 
	`li°_add
(&
£g
->
Æloc_li°
, 
queue
);

742 
	`©omic_dec
(&
£g_Æloˇt‹
->
£g_migøã_cou¡
);

743 
£g_Æloˇt‹
->
£g_£Æed_cou¡
--;

744 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

745 
	}
}

747 
	$move_group_migøã_to_Æloc_queue
(
dm§c_su≥r
 *
su≥r
, 
group_hódî
 *
group
){

748 
Êags
;

749 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

750 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
group_Æloc_queue
;

752 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

753 
	`li°_dñ
(&
group
->
Æloc_li°
);

754 
	`li°_add
(&
group
->
Æloc_li°
, 
queue
);

755 
	`©omic_dec
(&
£g_Æloˇt‹
->
group_migøã_cou¡
);

756 
	`©omic_öc
(&
£g_Æloˇt‹
->
group_Æloc_cou¡
);

757 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

758 
	}
}

760 
	$move_£g_migøã_to_Æloc_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

761 
Êags
;

762 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

763 
li°_hód
 *
queue
 = &
£g_Æloˇt‹
->
£g_Æloc_queue
;

765 
	`•ö_lock_úqßve
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

766 
	`li°_dñ
(&
£g
->
Æloc_li°
);

767 
	`li°_add
(&
£g
->
Æloc_li°
, 
queue
);

768 
	`©omic_dec
(&
£g_Æloˇt‹
->
£g_migøã_cou¡
);

769 
	`©omic_öc
(&
£g_Æloˇt‹
->
£g_Æloc_cou¡
);

770 
	`•ö_u∆ock_úqª°‹e
(&
£g_Æloˇt‹
->
Æloc_lock
, 
Êags
);

771 
	}
}

773 
£˘‹_t
 
	$ˇlc_£gmít_hódî_°¨t
(
dm§c_su≥r
 *
su≥r
,

774 
u32
 
£gmít_idx
)

776  (
su≥r
->
∑øm
.
chunk_size
Ë* 
NUM_SSD
 * (
£gmít_idx
);

777 
	}
}

780 
u32
 
	$ˇlc_£gmít_œp
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£gmít_id
)

782 
u64
 
a
 = 
	`div_u64
(
£gmít_id
 - 1, 
su≥r
->
ƒ_£gmíts
);

783  
a
 + 1;

784 
	}
};

787 
u32
 
	$ˇlc_num_chunks
(
dm_dev
 *
dev
, 
dm§c_su≥r
 *
su≥r
)

789 
£˘‹_t
 
devsize
 = 
	`dm§c_devsize_£˘‹s
(
dev
);

790  
	`div_u64
(
devsize
, 
su≥r
->
∑øm
.
chunk_size
) - 1;

791 
	}
}

793 
£˘‹_t
 
	$ˇlc_mb_°¨t_£˘‹
(
dm§c_su≥r
 *
su≥r
,

794 
£gmít_hódî
 *
£g
,

795 
u32
 
mb_idx
)

797 
u32
 
idx
;

798 
£˘‹_t
 
°¨t_£˘‹
;

800 
	`div_u64_ªm
(
mb_idx
, 
STRIPE_SZ
, &
idx
);

801 
°¨t_£˘‹
 = 
	`ˇlc_£gmít_hódî_°¨t
(
su≥r
, 
£g
->
£g_id
);

803  
°¨t_£˘‹
 + ((
idx
Ë* 
SRC_SECTORS_PER_PAGE
);

804 
	}
}

811 
ölöe
 
£gmít_hódî
 *
	$gë_£gmít_hódî_by_id
(
dm§c_su≥r
 *
su≥r
,

812 
u64
 
£gmít_id
)

814 
u32
 
idx
;

815 
	`div_u64_ªm
(
£gmít_id
, 
su≥r
->
ˇche_°©
.
num_£gmíts
, &
idx
);

816  
	`œrge_¨øy_©
(
su≥r
->
£gmít_hódî_¨øy
, 
idx
);

817 
	}
}

819 
£gmít_hódî
 *
	$gë_£gmít_hódî_by_mb_idx
(
dm§c_su≥r
 *
su≥r
,

820 
u32
 
mb_idx
)

822 
u32
 
idx
;

823 
u32
 
£g_id
;

824 
£g_id
 = 
	`div_u64_ªm
(
mb_idx
, 
STRIPE_SZ
, &
idx
);

825  
	`œrge_¨øy_©
(
su≥r
->
£gmít_hódî_¨øy
, 
£g_id
);

826 
	}
}

828 
£gmít_hódî
 *
	$gë_£g_by_mb
(
dm§c_su≥r
 *
su≥r
,

829 
mëablock
 *
mb
)

831  
	`gë_£gmít_hódî_by_mb_idx
(
su≥r
, 
mb
->
idx
);

832 
	}
}

834 
__mu°_check
 
	$öô_£gmít_hódî_¨øy
(
dm§c_su≥r
 *
su≥r
)

836 
u32
 
£gmít_idx
, 
group_idx
;

837 
u32
 
num_£gmíts
 = 
su≥r
->
ˇche_°©
.num_segments;

838 
u32
 
num_groups
 = 
su≥r
->
ˇche_°©
.num_groups;

839 
i
;

841 
su≥r
->
group_hódî_¨øy
 = 
	`vmÆloc
((
group_hódî
)*
num_groups
);

842 i‡(!
su≥r
->
group_hódî_¨øy
) {

843 
	`WBERR
();

844  -
ENOMEM
;

847 
group_idx
 = 0;group_idx < 
num_groups
;group_idx++){

848 
group_hódî
 *group_hódî = &
su≥r
->
group_hódî_¨øy
[
group_idx
];

849 
group_hódî
->
group_id
 = 
group_idx
;

850 
	`©omic_£t
(&
group_hódî
->
‰ì_£g_cou¡
, 0);

851 
	`©omic_£t
(&
group_hódî
->
vÆid_cou¡
, 0);

852 
	`INIT_LIST_HEAD
(&
group_hódî
->
group_hód
);

853 
	`•ö_lock_öô
(&
group_hódî
->
lock
);

855 
su≥r
->
cuºít_group
 = 
NULL
;

857 
	`¥ötk
(" segment headállocation\n");

858 
su≥r
->
£gmít_hódî_¨øy
 =

859 
	`œrge_¨øy_Æloc
((
£gmít_hódî
), 
num_£gmíts
);

860 i‡(!
su≥r
->
£gmít_hódî_¨øy
) {

861 
	`WBERR
();

862  -
ENOMEM
;

865 
i
 = 0;ò< 
MAX_CACHE_DEVS
;i++){

866 if(
i
<
NUM_SSD
){

867 
	`¥ötk
(" mëablockáŒoˇti⁄ %d\n", 
i
);

868 
su≥r
->
mëablock_¨øy
[
i
] =

869 
	`œrge_¨øy_Æloc
((
mëablock
), 
NUM_BLOCKS_PER_SSD
);

870 i‡(!
su≥r
->
mëablock_¨øy
[
i
]) {

871 
	`WBERR
();

872  -
ENOMEM
;

880 
su≥r
->
mëablock_¨øy
[
i
] = 
NULL
;

884 
£gmít_idx
 = 0; segmít_idx < 
num_£gmíts
; segment_idx++) {

885 
£gmít_hódî
 *
£g
 =

886 
	`œrge_¨øy_©
(
su≥r
->
£gmít_hódî_¨øy
, 
£gmít_idx
);

887 
group_hódî
 *group_header;

889 
group_idx
 = 
£gmít_idx
 / 
SEGMENT_GROUP_SIZE
;

891 
group_hódî
 = &
su≥r
->
group_hódî_¨øy
[
group_idx
];

892 
	`li°_add_èû
(&
£g
->
group_li°
, &
group_hódî
->
group_hód
);

894 
£g
->
group
 = 
group_hódî
;

896 
	`©omic_£t
(&
£g
->
Àngth
, 0);

897 
	`©omic_£t
(&
£g
->
vÆid_cou¡
, 0);

898 
	`©omic_£t
(&
£g
->
dúty_cou¡
, 0);

899 
	`©omic_£t
(&
£g
->
hŸ_cou¡
, 0);

900 
	`©omic_£t
(&
£g
->
∑π_°¨t
, 0);

901 
	`©omic_£t
(&
£g
->
∑π_Àngth
, 0);

902 
	`©omic_£t
(&
£g
->
bios_cou¡
, 0);

904 
£g
->
£g_id
 = (
u64
)
£gmít_idx
;

905 
£g
->
group_id
 = (
u64
)
£gmít_idx
/
SEGMENT_GROUP_SIZE
;

906 
£g
->
Êags
 = 0;

907 
£g
->
£g_lﬂd
 = 0;

908 
£g
->
£quí˚
 = 0;

912 
	`©omic_£t
(&
£g
->
num_ªad_öÊight
, 0);

913 
	`©omic_£t
(&
£g
->
num_fûlög
, 0);

914 
	`©omic_£t
(&
£g
->
num_bufc›y
, 0);

916 
i
 = 0;ò< 
MAX_CACHE_DEVS
;i++)

917 
	`©omic_£t
(&
£g
->
summ¨y_°¨t
[
i
], 0);

919 
	`•ö_lock_öô
(&
£g
->
lock
);

921 
	`INIT_LIST_HEAD
(&
£g
->
migøã_li°
);

924 
	`mb_¨øy_em±y_öô
(
su≥r
);

926 
su≥r
->
mëa_öôülized
 = 1;

929 
	}
}

931 
	$‰ì_£gmít_hódî_¨øy
(
dm§c_su≥r
 *
su≥r
)

933 
i
;

935 if(!
su≥r
->
mëa_öôülized
)

938 
	`v‰ì
(
su≥r
->
group_hódî_¨øy
);

939 
	`œrge_¨øy_‰ì
(
su≥r
->
£gmít_hódî_¨øy
);

941 
i
 = 0;ò< 
MAX_CACHE_DEVS
;i++){

942 if(
su≥r
->
mëablock_¨øy
[
i
]){

943 
	`œrge_¨øy_‰ì
(
su≥r
->
mëablock_¨øy
[
i
]);

946 
	}
}

953 
__mu°_check
 
	$ht_em±y_öô
(
dm§c_su≥r
 *
su≥r
)

955 
u32
 
idx
;

956 
size_t
 
i
, 
num_hóds
;

957 
œrge_¨øy
 *
¨r
;

959 
su≥r
->
htsize
 = 
NUM_BLOCKS
;

960 
num_hóds
 = 
su≥r
->
htsize
 + 1;

962 
	`¥ötk
(" hashÅableállocation\n");

963 
¨r
 = 
	`œrge_¨øy_Æloc
((
ht_hód
), 
num_hóds
);

964 i‡(!
¨r
) {

965 
	`WBERR
();

966  -
ENOMEM
;

969 
su≥r
->
hèbÀ
 = 
¨r
;

971 
i
 = 0; i < 
num_hóds
; i++) {

972 
ht_hód
 *
hd
 = 
	`œrge_¨øy_©
(
¨r
, 
i
);

973 
	`INIT_HLIST_HEAD
(&
hd
->
ht_li°
);

980 
su≥r
->
nuŒ_hód
 = 
	`œrge_¨øy_©
(su≥r->
hèbÀ
, su≥r->
htsize
);

982 
idx
 = 0; idx < 
NUM_BLOCKS
; idx++) {

983 
mëablock
 *
mb
 = 
	`mb_©
(
su≥r
, 
idx
);

984 
	`hli°_add_hód
(&
mb
->
ht_li°
, &
su≥r
->
nuŒ_hód
->ht_list);

987 
su≥r
->
ht_öôülized
 = 1;

990 
	}
}

992 
	$‰ì_ht
(
dm§c_su≥r
 *
su≥r
)

994 if(!
su≥r
->
ht_öôülized
)

997 
	`œrge_¨øy_‰ì
(
su≥r
->
hèbÀ
);

998 
	}
}

1000 
ht_hód
 *
	$ht_gë_hód
(
dm§c_su≥r
 *
su≥r
, 
£˘‹_t
 
key
)

1002 
u32
 
idx
;

1003 
	`div_u64_ªm
(
key
, 
su≥r
->
htsize
, &
idx
);

1004  
	`œrge_¨øy_©
(
su≥r
->
hèbÀ
, 
idx
);

1005 
	}
}

1007 
boﬁ
 
	$mb_hô
(
mëablock
 *
mb
, 
£˘‹_t
 
key
)

1009  
mb
->
£˘‹
 =
key
;

1010 
	}
}

1012 
	$ht_dñ
(
dm§c_su≥r
 *
su≥r
, 
mëablock
 *
mb
)

1014 
ht_hód
 *
nuŒ_hód
;

1016 
	`hli°_dñ
(&
mb
->
ht_li°
);

1018 
nuŒ_hód
 = 
su≥r
->null_head;

1019 
	`hli°_add_hód
(&
mb
->
ht_li°
, &
nuŒ_hód
->ht_list);

1022 
	}
}

1024 
	$ht_ªgi°î
(
dm§c_su≥r
 *
su≥r
,
£˘‹_t
 
key
, 
mëablock
 *
mb
)

1026 
ht_hód
 *
hód
;

1027 
hód
 = 
	`ht_gë_hód
(
su≥r
, 
key
);

1029 
	`hli°_dñ
(&
mb
->
ht_li°
);

1030 
	`hli°_add_hód
(&
mb
->
ht_li°
, &
hód
->ht_list);

1034 
mb
->
£˘‹
 = 
key
;

1035 
	}
};

1037 
mëablock
 *
	$ht_lookup
(
dm§c_su≥r
 *
su≥r
,
£˘‹_t
 
key
)

1039 
mëablock
 *
mb
, *
found
 = 
NULL
;

1040 
ht_hód
 *
hód
;

1041 
hód
 = 
	`ht_gë_hód
(
su≥r
, 
key
);

1043 
	`hli°_f‹_óch_íåy
(
mb
, &
hód
->
ht_li°
, ht_list) {

1044 i‡(
	`mb_hô
(
mb
, 
key
)) {

1045 
found
 = 
mb
;

1050  
found
;

1051 
	}
}

1056 
	$disˇrd_ˇches_ö£g
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
)

1058 
Êags
;

1059 
u32
 
i
;

1061 
i
 = 0; i < 
STRIPE_SZ
; i++) {

1062 
mëablock
 *
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
i
);

1063 
	`ht_dñ
(
su≥r
, 
mb
);

1064 
	`lock£g
(
£g
, 
Êags
);

1065 if(
	`ã°_bô
(
MB_VALID
, &
mb
->
mb_Êags
)||

1066 
	`ã°_bô
(
MB_PARITY
, &
mb
->
mb_Êags
)||

1067 
	`ã°_bô
(
MB_SUMMARY
, &
mb
->
mb_Êags
)){

1069 
	`©omic_dec
(&
£g
->
vÆid_cou¡
);

1070 
	`©omic_dec
(&
£g
->
group
->
vÆid_cou¡
);

1072 
	`˛ór_bô
(
MB_VALID
, &
mb
->
mb_Êags
);

1073 
	`˛ór_bô
(
MB_PARITY
, &
mb
->
mb_Êags
);

1074 
	`˛ór_bô
(
MB_SUMMARY
, &
mb
->
mb_Êags
);

1076 if(
	`ã°_bô
(
MB_HIT
, &
mb
->
mb_Êags
)){

1077 
	`˛ór_bô
(
MB_HIT
, &
mb
->
mb_Êags
);

1078 
	`©omic_dec
(&
£g
->
hŸ_cou¡
);

1081 
	`©omic_dec
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
);

1083 
	`u∆ock£g
(
£g
, 
Êags
);

1085 
	}
}

1089 
	$ªad_su≥rblock_hódî
(
su≥rblock_devi˚
 *
sup
,

1090 
dm§c_su≥r
 *
su≥r
, 
dm_dev
 *
dev
)

1092 
r
 = 0;

1093 
dm_io_ªque°
 
io_ªq_sup
;

1094 
dm_io_ªgi⁄
 
ªgi⁄_sup
;

1095 
£˘‹_t
 
£˘‹
 = 0;

1097 *
buf
 = 
	`kmÆloc
((1 << 
SECTOR_SHIFT
), 
GFP_KERNEL
);

1098 i‡(!
buf
) {

1099 
	`WBERR
("failedÅoálloc buffer");

1100  -
ENOMEM
;

1105 
io_ªq_sup
 = (
dm_io_ªque°
) {

1106 .
˛õ¡
 = 
su≥r
->
io_˛õ¡
,

1107 .
bi_rw
 = 
READ
,

1108 .
nŸify
.
‚
 = 
NULL
,

1109 .
mem
.
ty≥
 = 
DM_IO_KMEM
,

1110 .
mem
.
±r
.
addr
 = 
buf
,

1112 
ªgi⁄_sup
 = (
dm_io_ªgi⁄
) {

1113 .
bdev
 = 
dev
->bdev,

1114 .
£˘‹
 = sector,

1115 .
cou¡
 = 1,

1117 
r
 = 
	`dm§c_io
(&
io_ªq_sup
, 1, &
ªgi⁄_sup
, 
NULL
);

1118 i‡(
r
) {

1119 
	`WBERR
("io failed inÑeading superblock header");

1120 
bad_io
;

1123 
	`mem˝y
(
sup
, 
buf
, (*sup));

1125 
bad_io
:

1126 
	`k‰ì
(
buf
);

1128  
r
;

1129 
	}
}

1137 
__mu°_check
 
	$sˇn_su≥rblock
(
dm§c_su≥r
 *
su≥r
)

1139 
su≥rblock_devi˚
 *
sup
 = 
NULL
;

1140 
num_ˇche_devs
;

1141 
r
 = 0;

1142 
i
;

1143 
u32
 
uuid
;

1145 
num_ˇche_devs
 = 
su≥r
->
dev_öfo
.num_cache_devs;

1147 
i
 = 0;ò< 
num_ˇche_devs
;i++){

1148 
sup
 = &
su≥r
->
dev_öfo
.
sb_devi˚
[
i
];

1149 
r
 = 
	`ªad_su≥rblock_hódî
(
sup
, 
su≥r
, su≥r->
dev_öfo
.
ˇche_dev
[
i
]);

1150 i‡(
r
) {

1151 
	`WBERR
("failedÅoÑead superblock header");

1152  
r
;

1155 
	`¥ötk
(" magi¯%x\n", 
sup
->
magic
);

1156 
	`¥ötk
(" uuid = %d \n", 
sup
->
uuid
);

1157 
	`¥ötk
(" chunk sizê%d se˘‹s\n", 
sup
->
chunk_size
);

1158 
	`¥ötk
("Çum chunk†%d \n", 
sup
->
num_chunks
);

1160 i‡(
	`À32_to_˝u
(
sup
->
magic
Ë!
SRC_MAGIC
) {

1161 
	`WBERR
("superblock header: magicÇumber invalid");

1166 
i
 = 0;ò< 
num_ˇche_devs
;i++){

1167 
sup
 = &
su≥r
->
dev_öfo
.
sb_devi˚
[
i
];

1169 if(
i
==0)

1170 
uuid
 = 
sup
->uuid;

1172 if(
sup
->
uuid
 != uuid){

1173 
	`WBERR
("superblock heaer: invalid uuid");

1182 
su≥r
->
ˇche_°©
.
uuid
 = 
sup
->uuid;

1183 
su≥r
->
ˇche_°©
.
num_chunks_≥r_ssd
 = 
sup
->
num_chunks
;

1184 
su≥r
->
ˇche_°©
.
num_chunks_≥r_group
 = 
sup
->
chunks_≥r_group
;

1185 
su≥r
->
ˇche_°©
.
num_£gmíts
 = 
sup
->
num_chunks
;

1186 
su≥r
->
ˇche_°©
.
num_groups
 = 
sup
->num_groups;

1187 
su≥r
->
ˇche_°©
.
num_blocks_≥r_chunk
 = 
sup
->num_blocks_per_chunk;

1188 
su≥r
->
ˇche_°©
.
num_blocks_≥r_ssd
 = 
sup
->num_blocks_per_ssd;

1190 
	`©omic64_£t
(&
su≥r
->
ˇche_°©
.
Æloc_£quí˚
, 0);

1191 
	`©omic64_£t
(&
su≥r
->
ˇche_°©
.
num_dúty_blocks
, 0);

1192 
	`©omic_£t
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
, 1) ;

1193 
	`©omic_£t
(&
su≥r
->
ˇche_°©
.
öÊight_ios
, 0);

1194 
	`©omic_£t
(&
su≥r
->
ˇche_°©
.
öÊight_bios
, 0);

1195 
	`©omic_£t
(&
su≥r
->
ˇche_°©
.
tŸÆ_ios
, 0);

1196 
	`©omic_£t
(&
su≥r
->
ˇche_°©
.
tŸÆ_bios
, 0);

1197 
	`©omic_£t
(&
su≥r
->
ˇche_°©
.
num_‰ì_£gmíts
, su≥r->ˇche_°©.
num_£gmíts
);

1199 
su≥r
->
dev_öfo
.
‹igö_£˘‹s
 = 
sup
->
hdd_devsize
;

1200 
su≥r
->
dev_öfo
.
≥r_ssd_£˘‹s
 = 
sup
->
ssd_devsize
;

1202 
su≥r
->
∑øm
.
chunk_size
 = 
sup
->chunk_size;

1203 
su≥r
->
∑øm
.
chunk_group_size
 = 
sup
->chunk_group_size;

1204 
su≥r
->
∑øm
.
∑rôy_Æloˇti⁄
 = 
sup
->parity_allocation;

1205 
su≥r
->
∑øm
.
°rùög_pﬁicy
 = 
sup
->striping_policy;

1206 
su≥r
->
∑øm
.
d©a_Æloˇti⁄
 = 
sup
->data_allocation;

1207 
su≥r
->
∑øm
.
îasuª_code
 = 
sup
->erasure_code;

1208 
su≥r
->
∑øm
.
hŸ_idítifiˇti⁄
 = 
sup
->hot_identification;

1209 
su≥r
->
∑øm
.
ª˛aim_pﬁicy
 = 
sup
->reclaim_policy;

1210 
su≥r
->
∑øm
.
vi˘im_pﬁicy

sup
->victim_policy;

1211 
su≥r
->
∑øm
.
ømbuf_poﬁ_amou¡
 = 
sup
->rambuf_pool_amount;

1212 
su≥r
->
∑øm
.
num_summ¨y_≥r_chunk
 = 
sup
->num_summary_per_chunk;

1213 
su≥r
->
∑øm
.
num_íåy_≥r_∑ge
 = 
sup
->num_entry_per_page;

1214 
su≥r
->
∑øm
.
Êush_comm™d
 = 
sup
->flush_command;

1216  
r
;

1217 
	}
}

1219 
u8
 
	$ˇlc_checksum
(
u8
 *
±r
, 
size
){

1220  
	`¸c32_À
(17, 
±r
, 
size
);

1221 
	}
}

1224 
	$c›y_summ¨y
(
dm§c_su≥r
 *
su≥r
, *
buf
, 
u32
 
£g_id
, u32 
ssd_id
){

1225 
£gmít_hódî
 *
√w_£g
;

1226 
£gmít_hódî_devi˚
 *
hódî
;

1227 
u64
 
£quí˚
;

1228 
u64
 
uuid
;

1229 
u32
 
magic
;

1230 
u32
 
ty≥
;

1231 
u32
 
off£t
;

1233 
hódî
 = (
£gmít_hódî_devi˚
 *)
buf
;

1234 
£quí˚
 = 
	`À64_to_˝u
(
hódî
->sequence);

1235 
uuid
 = 
	`À64_to_˝u
(
hódî
->uuid);

1236 
magic
 = 
	`À32_to_˝u
(
hódî
->magic);

1237 
ty≥
 = 
	`À32_to_˝u
(
hódî
->type);

1239 if(
magic
!=
SRC_MAGIC
)

1241 if(
uuid
!=
su≥r
->
ˇche_°©
.uuid)

1244 if(
	`USE_ERASURE_CODE
(&
su≥r
->
∑øm
Ë&& 
ssd_id
==
	`gë_∑rôy_ssd
(su≥r, 
£g_id
)){

1245 
	`¥ötk
("Ö¨ôy SSD id = %d segid %d \n", 
ssd_id
, 
£g_id
);

1249 
√w_£g
 = 
	`gë_£gmít_hódî_by_id
(
su≥r
, 
£g_id
);

1250 
√w_£g
->
£quí˚
 = sequence;

1251 
√w_£g
->
£g_ty≥
 = 
ty≥
;

1252 
√w_£g
->
£g_lﬂd
 = 1;

1254 
off£t
=0;off£t<
CHUNK_SZ
;offset++){

1255 
mëablock_devi˚
 *
mbdev
;

1256 
mëablock
 *
√w_mb
;

1257 
u32
 
mëa_∑ge
 = 
off£t
 / 
NUM_ENTRY_PER_PAGE
;

1258 
u32
 
mëa_off£t
 = 
off£t
 % 
NUM_ENTRY_PER_PAGE
;

1259 
u32
 
√w_idx
;

1261 
mbdev
 = (
mëablock_devi˚
 *)(
buf
 + 
PAGE_SIZE
 + 
mëa_∑ge
 * PAGE_SIZE);

1262 
mbdev
 +
mëa_off£t
;

1264 
√w_idx
 = 
ssd_id
 * 
CHUNK_SZ
 + 
off£t
;

1265 
√w_mb
 = 
	`gë_mb
(
su≥r
, 
£g_id
, 
√w_idx
);

1266 if(
mbdev
->
£˘‹
==(
u32
)~0)

1267 
√w_mb
->
£˘‹
 = ~0;

1269 
√w_mb
->
£˘‹
 = 
mbdev
->sector;

1271 if(
£g_id
==0)

1272 
	`¥ötk
(" më®∑gê%d, off£à%d, se˘‹ = %d\n", 
mëa_∑ge
, 
mëa_off£t
, ()
√w_mb
->
£˘‹
);

1275 if(
mbdev
->
dúty_bôs
)

1276 
	`£t_bô
(
MB_DIRTY
, &
√w_mb
->
mb_Êags
);

1278 
	`˛ór_bô
(
MB_DIRTY
, &
√w_mb
->
mb_Êags
);

1280 
	}
}

1282 
	$sˇn_mëad©a_com∂ëe_to_öa˘ive
(
dm§c_su≥r
 *
su≥r
,
sˇn_mëad©a_m™agî
 *
sˇn_m™agî
){

1283 
sˇn_mëad©a_job
 *
job
;

1284 
Êags
;

1285 
cou¡
;

1287 
cou¡
 = 
	`©omic_ªad
(&
sˇn_m™agî
->
com∂ëe_cou¡
);

1288 
cou¡
--){

1290 
	`•ö_lock_úqßve
(&
sˇn_m™agî
->
lock
, 
Êags
);

1291 
job
 = 
	`li°_fú°_íåy
(&
sˇn_m™agî
->
com∂ëe_queue
, 
sˇn_mëad©a_job
, 
li°
);

1292 
	`li°_dñ
(&
job
->
li°
);

1293 
	`©omic_dec
(&
sˇn_m™agî
->
com∂ëe_cou¡
);

1294 
	`•ö_u∆ock_úqª°‹e
(&
sˇn_m™agî
->
lock
, 
Êags
);

1296 
	`c›y_summ¨y
(
su≥r
, 
job
->
d©a
, job->
£g_id
, job->
ssd_id
);

1298 
	`•ö_lock_úqßve
(&
sˇn_m™agî
->
lock
, 
Êags
);

1299 
	`li°_add_èû
(&
job
->
li°
, &
sˇn_m™agî
->
öa˘ive_queue
);

1300 
	`©omic_öc
(&
sˇn_m™agî
->
öa˘ive_cou¡
);

1301 
	`•ö_u∆ock_úqª°‹e
(&
sˇn_m™agî
->
lock
, 
Êags
);

1304 
	}
}

1305 
sˇn_mëad©a_job
 *
	$sˇn_m™agî_Æloc
(
dm§c_su≥r
 *
su≥r
){

1306 
sˇn_mëad©a_m™agî
 *
sˇn_m™agî
;

1307 
sˇn_mëad©a_job
 *
job
;

1308 
Êags
;

1310 
sˇn_m™agî
 = 
su≥r
->scan_manager;

1316 
	`•ö_lock_úqßve
(&
sˇn_m™agî
->
lock
, 
Êags
);

1317 
job
 = 
	`li°_fú°_íåy
(&
sˇn_m™agî
->
öa˘ive_queue
, 
sˇn_mëad©a_job
, 
li°
);

1318 
	`li°_dñ
(&
job
->
li°
);

1319 
	`©omic_dec
(&
sˇn_m™agî
->
öa˘ive_cou¡
);

1320 
	`©omic_öc
(&
sˇn_m™agî
->
a˘ive_cou¡
);

1321 
	`•ö_u∆ock_úqª°‹e
(&
sˇn_m™agî
->
lock
, 
Êags
);

1323  
job
;

1324 
	}
}

1326 
	$sˇn_m™agî_öô
(
dm§c_su≥r
 *
su≥r
){

1327 
sˇn_mëad©a_m™agî
 *
sˇn_m™agî
;

1328 
r
 = 0;

1329 
i
;

1331 
sˇn_m™agî
 = 
	`kmÆloc
((
sˇn_mëad©a_m™agî
), 
GFP_KERNEL
);

1332 if(!
sˇn_m™agî
){

1333 
	`WBERR
();

1334 
r
 = -
ENOMEM
;

1335  
r
;

1337 
su≥r
->
sˇn_m™agî
 = scan_manager;

1338 
	`•ö_lock_öô
(&
sˇn_m™agî
->
lock
);

1340 
	`©omic_£t
(&
sˇn_m™agî
->
öa˘ive_cou¡
, 0);

1341 
	`©omic_£t
(&
sˇn_m™agî
->
a˘ive_cou¡
, 0);

1342 
	`©omic_£t
(&
sˇn_m™agî
->
com∂ëe_cou¡
, 0);

1344 
	`INIT_LIST_HEAD
(&
sˇn_m™agî
->
öa˘ive_queue
);

1346 
	`INIT_LIST_HEAD
(&
sˇn_m™agî
->
com∂ëe_queue
);

1349 
sˇn_m™agî
->
qdïth
 = 256;

1355 
i
 = 0;ò< 
sˇn_m™agî
->
qdïth
;i++){

1356 
sˇn_mëad©a_job
 *
job
;

1358 
job
 = 
	`kmÆloc
((
sˇn_mëad©a_job
), 
GFP_KERNEL
);

1359 if(!
job
){

1360 
	`BUG_ON
(1);

1361 
	`WBERR
();

1362  -
ENOMEM
;

1364 
	`mem£t
(
job
, 0x00, (
sˇn_mëad©a_job
));

1366 
job
->
ödex
 = 
i
;

1368 
	`li°_add
(&
job
->
li°
, &
sˇn_m™agî
->
öa˘ive_queue
);

1369 
	`©omic_öc
(&
sˇn_m™agî
->
öa˘ive_cou¡
);

1370 
job
->
su≥r
 = super;

1372 
job
->
d©a
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
	`ûog2
(
	`roundup_pow_of_two
(
NUM_SUMMARY
)));

1373 i‡(!
job
->
d©a
) {

1374 
	`BUG_ON
(1);

1375 
	`WBERR
();

1376  -
ENOMEM
;

1380  
r
;

1381 
	}
}

1383 
	$sˇn_m™agî_deöô
(
dm§c_su≥r
 *
su≥r
){

1384 
sˇn_mëad©a_m™agî
 *
sˇn_m™agî
;

1385 
sˇn_mëad©a_job
 *
job
, *
ãmp
;

1387 
sˇn_m™agî
 = 
su≥r
->scan_manager;

1389 
	`li°_f‹_óch_íåy_ß„
(
job
, 
ãmp
, &
sˇn_m™agî
->
öa˘ive_queue
, 
li°
){

1391 
	`li°_dñ
(&
job
->
li°
);

1392 
	`‰ì_∑ges
(()
job
->
d©a
, 
	`ûog2
(
	`roundup_pow_of_two
(
NUM_SUMMARY
)));

1393 
	`k‰ì
(
job
);

1394 
	`©omic_dec
(&
sˇn_m™agî
->
öa˘ive_cou¡
);

1397 
	`BUG_ON
(
	`©omic_ªad
(&
sˇn_m™agî
->
öa˘ive_cou¡
));

1399 
	`k‰ì
(
sˇn_m™agî
);

1400 
su≥r
->
sˇn_m™agî
 = 
NULL
;

1401 
	}
}

1404 
	$sˇn_mëad©a_ídio
(
îr‹
, *
c⁄ãxt
)

1406 
sˇn_mëad©a_job
 *
job
 = 
c⁄ãxt
;

1407 
dm§c_su≥r
 *
su≥r
 = 
job
->super;

1408 
sˇn_mëad©a_m™agî
 *
sˇn_m™agî
 = 
su≥r
->scan_manager;

1409 
Êags
;

1411 if(
îr‹
){

1412 
	`¥ötk
(" End ioÉrror \n");

1417 
	`•ö_lock_úqßve
(&
sˇn_m™agî
->
lock
, 
Êags
);

1418 
	`li°_add_èû
(&
job
->
li°
, &
sˇn_m™agî
->
com∂ëe_queue
);

1419 
	`•ö_u∆ock_úqª°‹e
(&
sˇn_m™agî
->
lock
, 
Êags
);

1421 
	`©omic_dec
(&
sˇn_m™agî
->
a˘ive_cou¡
);

1422 
	`©omic_öc
(&
sˇn_m™agî
->
com∂ëe_cou¡
);

1424 
	}
}

1426 
__mu°_check


1427 
	$ªad_£gmít_hódî_devi˚
(
dm§c_su≥r
 *
su≥r
, 
u32
 
£gmít_idx
, u32 
off£t
, 
sˇn_mëad©a_job
 *
job
)

1429 
dm_io_ªque°
 
io_ªq
;

1430 
dm_io_ªgi⁄
 
ªgi⁄
;

1431 
r
 = 0;

1433 
io_ªq
 = (
dm_io_ªque°
) {

1434 .
˛õ¡
 = 
su≥r
->
io_˛õ¡
,

1435 .
bi_rw
 = 
READ
,

1436 .
nŸify
.
‚
 = 
sˇn_mëad©a_ídio
,

1437 .
nŸify
.
c⁄ãxt
 = 
job
,

1438 .
mem
.
ty≥
 = 
DM_IO_KMEM
,

1439 .
mem
.
±r
.
addr
 = 
job
->
d©a
,

1441 
ªgi⁄
 = (
dm_io_ªgi⁄
) {

1442 .
bdev
 = 
	`gë_bdev
(
su≥r
, 
off£t
),

1443 .
£˘‹
 = 
	`gë_£˘‹
(
su≥r
, 
£gmít_idx
, 
off£t
),

1444 .
cou¡
 = 
SRC_SECTORS_PER_PAGE
 * 
NUM_SUMMARY
,

1446 
r
 = 
	`dm§c_io
(&
io_ªq
, 1, &
ªgi⁄
, 
NULL
);

1447 i‡(
r
) {

1448 
	`WBERR
();

1454  
r
;

1455 
	}
}

1458 
	$lﬂd_summ¨y_‰om_ssd
(
dm§c_su≥r
 *
su≥r
){

1459 
sˇn_mëad©a_m™agî
 *
sˇn_m™agî
;

1460 
sˇn_mëad©a_job
 *
job
;

1461 
u32
 
summ¨y_idx
;

1462 
u32
 
num_£gmíts
 = 
su≥r
->
ˇche_°©
.num_segments;

1463 
u32
 
£g_id
, 
ssd_id
;

1464 
r
 = 0;

1466 
r
 = 
	`sˇn_m™agî_öô
(
su≥r
);

1467 if(
r
<0)

1468  
r
;

1470 
sˇn_m™agî
 = 
su≥r
->scan_manager;

1472 
£g_id
 = 0; seg_id < 
num_£gmíts
; seg_id++) {

1473 
ssd_id
 = 0;ssd_id < 
NUM_SSD
;ssd_id++){

1475 !
	`©omic_ªad
(&
sˇn_m™agî
->
öa˘ive_cou¡
)){

1476 !
	`©omic_ªad
(&
sˇn_m™agî
->
com∂ëe_cou¡
)){

1477 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(1000));

1479 
	`sˇn_mëad©a_com∂ëe_to_öa˘ive
(
su≥r
, 
sˇn_m™agî
);

1482 
job
 = (
sˇn_mëad©a_job
 *)
	`sˇn_m™agî_Æloc
(
su≥r
);

1483 
job
->
su≥r
 = super;

1484 
job
->
£g_id
 = seg_id;

1485 
job
->
ssd_id
 = ssd_id;

1488 
summ¨y_idx
 = 
	`gë_summ¨y_off£t
(
su≥r
, 
ssd_id
);

1492 
r
 = 
	`ªad_£gmít_hódî_devi˚
(
su≥r
, 
£g_id
, 
summ¨y_idx
, 
job
);

1493 i‡(
r
) {

1494 
	`WBERR
();

1495 
r
 = -1;

1496 
bad_su≥r
;

1500 
	`©omic_ªad
(&
sˇn_m™agî
->
a˘ive_cou¡
)){

1502 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(1000));

1505 
sˇn_m™agî
->
qdïth
 !
	`©omic_ªad
(&sˇn_m™agî->
öa˘ive_cou¡
)){

1506 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(1000));

1507 
	`sˇn_mëad©a_com∂ëe_to_öa˘ive
(
su≥r
, 
sˇn_m™agî
);

1512 
bad_su≥r
:;

1514  
r
;

1515 
	}
}

1517 
	$_c⁄°ru˘_mëad©a_ö_øm
(
dm§c_su≥r
 *
su≥r
, 
u32
 
£g_id
){

1518 
£gmít_hódî
 *
cur_£g
, *
ﬁd_£g
;

1519 
u32
 
ssd_id
, 
off£t
;

1520 
u32
 
cur_idx
;

1521 
cur_is_√w
 = 0;

1522 
mëablock
 *
ﬁd_mb
, *
cur_mb
;

1523 
£˘‹_t
 
key
;

1525 
cur_£g
 = 
	`gë_£gmít_hódî_by_id
(
su≥r
, 
£g_id
);

1527 
ssd_id
 = 0;ssd_id < 
NUM_SSD
;ssd_id++){

1528 
off£t
 = 0;off£à< 
CHUNK_SZ
;offset++){

1530 
cur_idx
 = 
ssd_id
 * 
CHUNK_SZ
 + 
off£t
;

1531 
cur_mb
 = 
	`gë_mb
(
su≥r
, 
£g_id
, 
cur_idx
);

1534 if(
	`USE_ERASURE_CODE
(&
su≥r
->
∑øm
)){

1535 if(
ssd_id
!=
	`gë_∑rôy_ssd
(
su≥r
, 
£g_id
Ë&& 
off£t
==
CHUNK_SZ
-1)

1536 
	`£t_bô
(
MB_SUMMARY
, &
cur_mb
->
mb_Êags
);

1538 if(
off£t
==
CHUNK_SZ
-1)

1539 
	`£t_bô
(
MB_SUMMARY
, &
cur_mb
->
mb_Êags
);

1543 
key
 = 
cur_mb
->
£˘‹
;

1544 if(
cur_mb
->
£˘‹
==~0 || cur_mb->£˘‹>=
su≥r
->
dev_öfo
.
‹igö_£˘‹s
){

1546 if(
	`ã°_bô
(
MB_DIRTY
, &
cur_mb
->
mb_Êags
)){

1547 
	`©omic_öc
(&
cur_£g
->
dúty_cou¡
);

1549 
	`˛ór_bô
(
MB_VALID
, &
cur_mb
->
mb_Êags
);

1553 
ﬁd_mb
 = 
	`ht_lookup
(
su≥r
, 
key
);

1560 if(
ﬁd_mb
 && old_mb->
£˘‹
 != ~0){

1562 
ﬁd_£g
 = 
	`gë_£gmít_hódî_by_mb_idx
(
su≥r
, 
ﬁd_mb
->
idx
);

1563 if(
cur_£g
->
£quí˚
 > 
ﬁd_£g
->sequence){

1564 
cur_is_√w
 = 1;

1566 if(
cur_£g
->
£quí˚
 =
ﬁd_£g
->£quí˚ && 
cur_idx
 > 
ﬁd_mb
->
idx
){

1567 
cur_is_√w
= 1;

1570 if(
cur_is_√w
){

1571 
	`övÆid©e_¥evious_ˇche
(
su≥r
, 
ﬁd_£g
, 
ﬁd_mb
);

1575 
cur_is_√w
= 1;

1578 if(
	`USE_ERASURE_CODE
(&
su≥r
->
∑øm
)){

1579 if(
ssd_id
==
	`gë_∑rôy_ssd
(
su≥r
, 
£g_id
)){

1580 
	`¥ötk
("Ö¨ôy SSD id = %d segid %d se˘‹ = %d \n", 
ssd_id
, 
£g_id
, ()
key
);

1581 
	`BUG_ON
(1);

1585 if(
cur_is_√w
){

1586 
boﬁ
 
˛ón
;

1594 
	`ht_ªgi°î
(
su≥r
, 
key
, 
cur_mb
);

1595 
˛ón
 = !
	`ã°_bô
(
MB_DIRTY
, &
cur_mb
->
mb_Êags
);

1596 
	`öôülize_mb
(
su≥r
, 
cur_mb
, 
cur_£g
->
£g_ty≥
, 
˛ón
);

1597 
	`£g_Àngth_öc
(
su≥r
, 
cur_£g
, 
cur_mb
, 
Ál£
);

1598 
	`£t_bô
(
MB_SEAL
, &
cur_mb
->
mb_Êags
);

1599 
	`©omic_öc
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
);

1601 if(
	`ã°_bô
(
MB_DIRTY
, &
cur_mb
->
mb_Êags
)){

1602 
	`©omic_öc
(&
cur_£g
->
dúty_cou¡
);

1604 
	`˛ór_bô
(
MB_VALID
, &
cur_mb
->
mb_Êags
);

1607 #ifde‡
USE_LAST_SUMMARY


1608 if(
off£t
==
CHUNK_SZ
-1)

1610 
	`¥ötk
(" invalid offset ... \n");

1611 
	`BUG_ON
(1);

1614 if(
off£t
 < 
NUM_SUMMARY
)

1616 
	`¥ötk
(" invÆid off£à... %d\n", ()
off£t
);

1617 
	`BUG_ON
(1);

1623 if(
£g_id
<10){

1624 
	`¥ötk
(" seg id = %d, vÆid = %d, dúty = %d \n", 
£g_id
, 
	`©omic_ªad
(&
cur_£g
->
vÆid_cou¡
),

1625 
	`©omic_ªad
(&
cur_£g
->
dúty_cou¡
));

1628 
	}
}

1630 
	$£gmít_group_¥öt_°©
(
dm§c_su≥r
 *
su≥r
){

1631 
u32
 
group_idx
;

1632 
u32
 
num_groups
 = 
su≥r
->
ˇche_°©
.num_groups;

1634 
	`¥ötk
("\n");

1635 
group_idx
 = 0;group_idx < 
num_groups
;group_idx++){

1636 
group_hódî
 *
group
 = &
su≥r
->
group_hódî_¨øy
[
group_idx
];

1638 if(
group_idx
<10)

1639 
	`¥ötk
(" gid = %d, fªê%d \n", ()
group
->
group_id
, ()
	`©omic_ªad
(&group->
‰ì_£g_cou¡
));

1641 
	`¥ötk
("\n");

1643 
	}
}

1645 
	$£gmít_group_dec_‰ì_£gs
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

1646 
u32
 
group_idx
 = 
£g
->
£g_id
/
SEGMENT_GROUP_SIZE
;

1647 
group_hódî
 *
group
 = &
su≥r
->
group_hódî_¨øy
[
group_idx
];

1649 
	`©omic_dec
(&
group
->
‰ì_£g_cou¡
);

1650 
	`BUG_ON
(()
	`©omic_ªad
(&
group
->
‰ì_£g_cou¡
)<0);

1651 
	}
}

1653 
u32
 
	$£gmít_group_öc_‰ì_£gs
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
){

1654 
u32
 
group_idx
 = 
£g
->
£g_id
/
SEGMENT_GROUP_SIZE
;

1655 
u32
 
‰ì_£g_cou¡
;

1656 
group_hódî
 *
group
 = &
su≥r
->
group_hódî_¨øy
[
group_idx
];

1658 
‰ì_£g_cou¡
 = 
	`©omic_öc_ªtu∫
(&
group
->free_seg_count);

1659 
	`BUG_ON
(
	`©omic_ªad
(&
group
->
‰ì_£g_cou¡
)>
SEGMENT_GROUP_SIZE
);

1660  
‰ì_£g_cou¡
;

1661 
	}
}

1663 
	$c⁄°ru˘_mëad©a_ö_øm
(
dm§c_su≥r
 *
su≥r
){

1664 
£gmít_hódî
 *
cur_£g
;

1665 
u64
 
œ°_£quí˚
 = 0;

1666 
u32
 
£g_id
;

1667 
u32
 
group_id
;

1668 
u32
 
num_£gmíts
;

1669 
u32
 
num_groups
;

1670 
u32
 *
ønd_èbÀ
;

1672 
num_£gmíts
 = 
su≥r
->
ˇche_°©
.num_segments;

1673 
num_groups
 = 
su≥r
->
ˇche_°©
.num_groups;

1675 
£g_id
 = 0; seg_id < 
num_£gmíts
; seg_id++) {

1677 
cur_£g
 = 
	`gë_£gmít_hódî_by_id
(
su≥r
, 
£g_id
);

1679 if(
cur_£g
->
£g_lﬂd
){

1681 if(
cur_£g
->
£quí˚
 > 
œ°_£quí˚
)

1682 
œ°_£quí˚
 = 
cur_£g
->
£quí˚
;

1685 
	`_c⁄°ru˘_mëad©a_ö_øm
(
su≥r
, 
£g_id
);

1696 
ønd_èbÀ
 = (
u32
 *)
	`kmÆloc
((u32)*
num_£gmíts
, 
GFP_KERNEL
);

1697 if(
ønd_èbÀ
==
NULL
){

1700 
£g_id
 = 0; seg_id < 
num_£gmíts
; seg_id++) {

1701 
ønd_èbÀ
[
£g_id
] = seg_id;

1705 
£g_id
 = 0; seg_id < 
num_£gmíts
; seg_id++) {

1706 
u32
 
ønd_num
;

1707 
u32
 
ãmp
;

1709 
	`gë_øndom_byãs
(&
ønd_num
, (
u32
));

1710 
ønd_num
 %
num_£gmíts
;

1712 
ãmp
 = 
ønd_èbÀ
[
£g_id
];

1713 
ønd_èbÀ
[
£g_id
] =Ñ™d_èbÀ[
ønd_num
];

1714 
ønd_èbÀ
[
ønd_num
] = 
ãmp
;

1718 
£g_id
 = 0; seg_id < 
num_£gmíts
; seg_id++) {

1719 
u32
 
ønd_£g_id
 = 
ønd_èbÀ
[
£g_id
];

1722 
cur_£g
 = 
	`gë_£gmít_hódî_by_id
(
su≥r
, 
ønd_£g_id
);

1724 if(
	`©omic_ªad
(&
cur_£g
->
vÆid_cou¡
)){

1726 
	`©omic_öc
(&
su≥r
->
w°©
.
£g_cou¡
[
cur_£g
->
£g_ty≥
]);

1729 if(
	`is_wrôe_°rùe
(
cur_£g
->
£g_ty≥
)){

1730 
	`©omic_add
(
NUM_SUMMARY
*
NUM_DATA_SSD
, &
cur_£g
->
vÆid_cou¡
);

1731 
	`©omic_add
(
NUM_SUMMARY
*
NUM_DATA_SSD
, &
cur_£g
->
group
->
vÆid_cou¡
);

1732 
	`©omic_add
(
NUM_SUMMARY
*
NUM_DATA_SSD
, &
cur_£g
->
dúty_cou¡
);

1733 
	`©omic_add
(
NUM_SUMMARY
*
NUM_DATA_SSD
, &
su≥r
->
ˇche_°©
.
num_u£d_blocks
);

1735 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
)){

1736 
	`©omic_add
(
CHUNK_SZ
, &
cur_£g
->
vÆid_cou¡
);

1737 
	`©omic_add
(
CHUNK_SZ
, &
cur_£g
->
group
->
vÆid_cou¡
);

1738 
	`©omic_add
(
CHUNK_SZ
, &
cur_£g
->
dúty_cou¡
);

1739 
	`©omic_add
(
CHUNK_SZ
, &
su≥r
->
ˇche_°©
.
num_u£d_blocks
);

1741 
	`BUG_ON
(
	`USE_ERASURE_RAID6
(&
su≥r
->
∑øm
));

1744 
	`©omic_add
(
NUM_SUMMARY
*
NUM_SSD
, &
cur_£g
->
group
->
vÆid_cou¡
);

1745 
	`©omic_add
(
NUM_SUMMARY
*
NUM_SSD
, &
cur_£g
->
dúty_cou¡
);

1746 
	`©omic_add
(
NUM_SUMMARY
*
NUM_SSD
, &
su≥r
->
ˇche_°©
.
num_u£d_blocks
);

1748 
	`BUG_ON
(
	`©omic_ªad
(&
cur_£g
->
vÆid_cou¡
Ë> 
STRIPE_SZ
);

1749 
	`BUG_ON
(
	`©omic_ªad
(&
cur_£g
->
dúty_cou¡
Ë> 
STRIPE_SZ
);

1751 
	`ö£π_£g_to_u£d_queue
(
su≥r
, 
cur_£g
);

1753 
	`£t_bô
(
SEG_SEALED
, &
cur_£g
->
Êags
);

1754 
	`˛ór_bô
(
SEG_USED
, &
cur_£g
->
Êags
);

1755 
	`˛ór_bô
(
SEG_PARTIAL
, &
cur_£g
->
Êags
);

1757 
	`move_£g_u£d_to_£Æed_queue
(
su≥r
, 
cur_£g
);

1759 
	`ö£π_£g_to_Æloc_queue
(
su≥r
, 
cur_£g
);

1760 
	`£t_bô
(
SEG_CLEAN
, &
cur_£g
->
Êags
);

1761 
	`˛ór_bô
(
SEG_RECOVERY
, &
cur_£g
->
Êags
);

1762 
	`˛ór_bô
(
SEG_HIT
, &
cur_£g
->
Êags
);

1764 
	`£gmít_group_öc_‰ì_£gs
(
su≥r
, 
cur_£g
);

1768 
group_id
 = 0; group_id < 
num_groups
; group_id++) {

1769 
group_hódî
 *
group
 = &
su≥r
->
group_hódî_¨øy
[
group_id
];

1771 if(
	`©omic_ªad
(&
group
->
‰ì_£g_cou¡
)==
SEGMENT_GROUP_SIZE
){

1772 
	`ö£π_group_to_Æloc_queue
(
su≥r
, 
group
);

1774 
	`ö£π_group_to_u£d_queue
(
su≥r
, 
group
);

1775 
	`move_group_u£d_to_£Æed_queue
(
su≥r
, 
group
);

1779 
	`¥ötk
("Üa° sequí˚ = %Œu\n", 
œ°_£quí˚
+1);

1780 
	`©omic64_£t
(&
su≥r
->
ˇche_°©
.
Æloc_£quí˚
, 
œ°_£quí˚
+1);

1782 
	`k‰ì
(
ønd_èbÀ
);

1785 
	}
}

1788 
	$assign_√w_£gmít
(
dm§c_su≥r
 *
su≥r
){

1789 
ty≥
;

1792 
ty≥
 = 0;ty≥ <
RHBUF
;type++){

1794 if(
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
£g_Æloc_cou¡
)<1){

1795 
	`¥ötk
("Çÿm‹ê‰ì segmít†%d \n", 
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
£g_Æloc_cou¡
));

1799 
£g_id
 = 
	`Æloc_√w_£gmít
(
su≥r
, 
ty≥
, 
Ál£
);

1800 
	`¥ötk
("ássig¿√w seg = %d \n", ()
£g_id
);

1802 
	`ma_£t_cou¡
(
su≥r
, 
ty≥
, 
STRIPE_SZ
);

1803 if(
	`should_√ed_ª‰esh_£g
(
su≥r
, 
ty≥
)){

1804 
	`¥ötk
("ássig¿√w seg = %d %d \n", ()
ty≥
,

1805 
	`ma_gë_cou¡
(
su≥r
, 
ty≥
) );

1811 
	}
}

1813 
__mu°_check
 
	$sˇn_mëad©a
(
dm§c_su≥r
 *
su≥r
)

1815 
r
 = 0;

1816 
°¨t_jiffõs
;

1817 
íd_jiffõs
;

1819 
°¨t_jiffõs
 = 
jiffõs
;

1821 
r
 = 
	`lﬂd_summ¨y_‰om_ssd
(
su≥r
);

1822 if(
r
)

1823  
r
;

1825 
r
 = 
	`c⁄°ru˘_mëad©a_ö_øm
(
su≥r
);

1826 if(
r
)

1827  
r
;

1831 
u32
 
£g_id
;

1832 
£gmít_hódî
 *
cur_£g
;

1833 
£g_id
 = 0; seg_id < 
su≥r
->
ˇche_°©
.
num_£gmíts
; seg_id++) {

1834 
cur_£g
 = 
	`gë_£gmít_hódî_by_id
(
su≥r
, 
£g_id
);

1836 if(
£g_id
 < 200){

1837 if(
	`ã°_bô
(
SEG_SEALED
, &
cur_£g
->
Êags
)){

1838 
	`¥ötk
(" scan sealed segment = %u (type%d),Üength = %d, valid = %d, dirty = %d, %d %d \n",

1839 
£g_id
,

1840 (
u32
)
cur_£g
->
£g_ty≥
,

1841 
	`©omic_ªad
(&
cur_£g
->
Àngth
),

1842 
	`©omic_ªad
(&
cur_£g
->
vÆid_cou¡
),

1843 
	`©omic_ªad
(&
cur_£g
->
dúty_cou¡
),

1844 ()
	`©omic_ªad
(&
cur_£g
->
num_fûlög
),

1845 ()
	`©omic_ªad
(&
cur_£g
->
num_ªad_öÊight
));

1847 
	`¥ötk
(" scan clean segment = %u (type%d),Üength = %d, valid = %d, dirty = %d, %d %d \n",

1848 
£g_id
,

1849 (
u32
)
cur_£g
->
£g_ty≥
,

1850 
	`©omic_ªad
(&
cur_£g
->
Àngth
),

1851 
	`©omic_ªad
(&
cur_£g
->
vÆid_cou¡
),

1852 
	`©omic_ªad
(&
cur_£g
->
dúty_cou¡
),

1853 ()
	`©omic_ªad
(&
cur_£g
->
num_fûlög
),

1854 ()
	`©omic_ªad
(&
cur_£g
->
num_ªad_öÊight
));

1863 
	`mb_¨øy_ßnôy_check
(
su≥r
);

1866 
	`¥ötk
(" cuºíàutû = %d \n", 
	`gë_cuº_utû
(
su≥r
));

1868 
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
£g_Æloc_cou¡
) < 20){

1869 
	`do_background_gc
(
su≥r
);

1870 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

1871 
	`¥ötk
(" fªê£gmíà%d \n", 
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
£g_Æloc_cou¡
));

1873 
	`©omic_£t
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
, 0);

1874 
	`©omic_£t
(&
su≥r
->
migøã_mgr
.
background_gc_⁄
, 0);

1875 
su≥r
->
migøã_mgr
.
Ælow_migøã
 = 0;

1877 
r
 = 
	`assign_√w_£gmít
(
su≥r
);

1878 if(
r
)

1879  
r
;

1881 
íd_jiffõs
 = 
jiffõs
;

1883 
	`¥ötk
(" cuºíàutû = %d \n", 
	`gë_cuº_utû
(
su≥r
));

1884 
	`¥ötk
(" fªê£gmíà%d \n", 
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
£g_Æloc_cou¡
));

1885 
	`¥ötk
(" Sˇ¬ög Mëad©®Timê = %d m†\n", 
	`jiffõs_to_m£cs
(
íd_jiffõs
 - 
°¨t_jiffõs
));

1889 
	}
}

1891 
ømbuf_∑ge
 *
	$Æloc_sögÀ_∑ge
(
dm§c_su≥r
 *
su≥r
){

1892 
Êags
;

1893 
ømbuf_∑ge
 *
∑ge
;

1894 
£gbuf_m™agî
 *
£gbuf_mgr
 = &
su≥r
->segbuf_mgr;

1895 
check
 = 0;

1897 
	`•ö_lock_úqßve
(&
£gbuf_mgr
->
lock
, 
Êags
);

1898 
	`©omic_ªad
(&
£gbuf_mgr
->
öa˘ive_∑ge_cou¡
)<=
STRIPE_SZ
){

1899 
	`•ö_u∆ock_úqª°‹e
(&
£gbuf_mgr
->
lock
, 
Êags
);

1901 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(50));

1902 
	`•ö_lock_úqßve
(&
£gbuf_mgr
->
lock
, 
Êags
);

1903 
check
 = 1;

1905 if(
check
)

1906 
	`¥ötk
(" delayedÑamállocated .. \n");

1908 
	`©omic_öc
(&
£gbuf_mgr
->
gc_a˘ive_∑ge_cou¡
);

1909 
∑ge
 = 
	`_Æloc_ømbuf_∑ge
(
su≥r
);

1910 
∑ge
->
∂
->
√xt
 = 
NULL
;

1911 
	`•ö_u∆ock_úqª°‹e
(&
£gbuf_mgr
->
lock
, 
Êags
);

1912  
∑ge
;

1913 
	}
}

1915 
	$‰ì_sögÀ_∑ge
(
dm§c_su≥r
 *
su≥r
, 
ømbuf_∑ge
 *
∑ge
){

1916 
Êags
;

1917 
£gbuf_m™agî
 *
£gbuf_mgr
 = &
su≥r
->segbuf_mgr;

1919 
	`•ö_lock_úqßve
(&
£gbuf_mgr
->
lock
, 
Êags
);

1920 
	`_‰ì_ømbuf_∑ge
(
su≥r
, 
∑ge
);

1921 
	`©omic_dec
(&
£gbuf_mgr
->
gc_a˘ive_∑ge_cou¡
);

1922 
	`•ö_u∆ock_úqª°‹e
(&
£gbuf_mgr
->
lock
, 
Êags
);

1923 
	}
}

1925 
ømbuf_∑ge
 *
	$_Æloc_ømbuf_∑ge
(
dm§c_su≥r
 *
su≥r
){

1926 
ømbuf_∑ge
 *
∑ge
;

1927 
£gbuf_m™agî
 *
£gbuf_mgr
 = &
su≥r
->segbuf_mgr;

1929 if(
	`©omic_ªad
(&
£gbuf_mgr
->
öa˘ive_∑ge_cou¡
)==0){

1930 
	`¥ötk
("ÇoÑambuf ... \n");

1932 
	`BUG_ON
(
	`©omic_ªad
(&
£gbuf_mgr
->
öa˘ive_∑ge_cou¡
)==0);

1933 
∑ge
 = 
	`li°_fú°_íåy
(

1934 &
£gbuf_mgr
->
öa˘ive_∑ge_li°
, 
ømbuf_∑ge
, 
li°
);

1936 
	`li°_move_èû
(&
∑ge
->
li°
, &
£gbuf_mgr
->
a˘ive_∑ge_li°
);

1937 
	`©omic_dec
(&
£gbuf_mgr
->
öa˘ive_∑ge_cou¡
);

1938 
	`©omic_öc
(&
£gbuf_mgr
->
a˘ive_∑ge_cou¡
);

1940  
∑ge
;

1941 
	}
}

1943 
ømbuf_∑ge
 *
	$_‰ì_ømbuf_∑ge
(
dm§c_su≥r
 *
su≥r
, 
ømbuf_∑ge
 *
∑ge
){

1944 
£gbuf_m™agî
 *
£gbuf_mgr
 = &
su≥r
->segbuf_mgr;

1946 if(!
∑ge
)

1947  
NULL
;

1949 
	`li°_move_èû
(&
∑ge
->
li°
, &
£gbuf_mgr
->
öa˘ive_∑ge_li°
);

1950 
	`©omic_dec
(&
£gbuf_mgr
->
a˘ive_∑ge_cou¡
);

1951 
	`©omic_öc
(&
£gbuf_mgr
->
öa˘ive_∑ge_cou¡
);

1953  
∑ge
;

1954 
	}
}

1956 
	$Æloc_summ¨y_ømbuf
(
dm§c_su≥r
 *
su≥r
, 
ømbuf„r
 *
ømbuf
){

1957 
i
;

1958 if(
SUMMARY_SCHEME
==
SUMMARY_PER_CHUNK
){

1959 
i
=0;i<
STRIPE_SZ
;i++){

1960 if(!
ømbuf
->
∑ges
[
i
] && 
	`chunk_summ¨y_ønge
(
su≥r
, i)){

1961 
ømbuf
->
∑ges
[
i
] = 
	`_Æloc_ømbuf_∑ge
(
su≥r
);

1965 if(!
ømbuf
->
∑ges
[
STRIPE_SZ
-1])

1966 
ømbuf
->
∑ges
[
STRIPE_SZ
-1] = 
	`_Æloc_ømbuf_∑ge
(
su≥r
);

1968 
	}
}

1970 
	$Æloc_ømbuf_∑ge
(
dm§c_su≥r
 *
su≥r
, 
ømbuf„r
 *
ømbuf
, 
ˇche_ty≥
){

1971 
i
;

1972 
summ¨y_⁄ly
;

1974 if(
ømbuf
==
NULL
)

1977 
ømbuf
->
Æloc_cou¡
 = 0;

1979 if(
	`is_gc_°rùe
(
ˇche_ty≥
)){

1980 
summ¨y_⁄ly
 = 0;

1982 if(
ˇche_ty≥
 =
RHBUF
 || cache_ty≥ =
RCBUF
){

1983 
summ¨y_⁄ly
 = 0;

1985 if(
su≥r
->
∑øm
.
îasuª_code
!=
ERASURE_CODE_NONE
){

1986 
summ¨y_⁄ly
 = 0;

1988 
summ¨y_⁄ly
 = 0;

1993 if(
summ¨y_⁄ly
){

1994 
	`Æloc_summ¨y_ømbuf
(
su≥r
, 
ømbuf
);

1996 
i
=0;i<
STRIPE_SZ
;i++){

1997 if(!
ømbuf
->
∑ges
[
i
])

1998 
ømbuf
->
∑ges
[
i
] = 
	`_Æloc_ømbuf_∑ge
(
su≥r
);

2002 
i
=0;i<
STRIPE_SZ
;i++){

2003 if(
ømbuf
->
∑ges
[
i
])

2004 
ømbuf
->
Æloc_cou¡
++;

2006 
	`BUG_ON
(!
ømbuf
->
Æloc_cou¡
);

2007 
	}
}

2009 
	$‰ì_ømbuf_∑ge
(
dm§c_su≥r
 *
su≥r
, 
ømbuf„r
 *
ømbuf
){

2010 
i
;

2012 
i
=0;i<
STRIPE_SZ
;i++){

2013 if(
ømbuf
->
∑ges
[
i
]){

2014 
	`_‰ì_ømbuf_∑ge
(
su≥r
, 
ømbuf
->
∑ges
[
i
]);

2015 
ømbuf
->
Æloc_cou¡
--;

2017 
ømbuf
->
∑ges
[
i
] = 
NULL
;

2019 
	`BUG_ON
(
ømbuf
->
Æloc_cou¡
);

2020 
	}
}

2022 
ømbuf„r
 *
	$Æloc_ømbuf„r
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
°rùe_size
){

2023 
ømbuf„r
 *
√xt_ømbuf
;

2024 
£gbuf_m™agî
 *
£gbuf_mgr
 = &
su≥r
->segbuf_mgr;

2025 
li°_hód
 *
öa˘ive_hód
 = &
£gbuf_mgr
->
öa˘ive_li°
;

2026 
li°_hód
 *
a˘ive_hód
 = &
£gbuf_mgr
->
a˘ive_li°
;

2027 
Êags
;

2028 
i
;

2030 
	`•ö_lock_úqßve
(&
£gbuf_mgr
->
lock
, 
Êags
);

2032 
öa˘ive_hód
 = &
£gbuf_mgr
->
öa˘ive_li°
;

2033 
a˘ive_hód
 = &
£gbuf_mgr
->
a˘ive_li°
;

2035 if(
	`©omic_ªad
(&
£gbuf_mgr
->
öa˘ive_cou¡
)){

2037 
√xt_ømbuf
 = (
ømbuf„r
 *)

2038 
	`li°_íåy
(
öa˘ive_hód
->
√xt
, 
ømbuf„r
, 
li°
);

2040 
	`li°_dñ
(&
√xt_ømbuf
->
li°
);

2041 
	`©omic_dec
(&
£gbuf_mgr
->
öa˘ive_cou¡
);

2043 
	`li°_add_èû
(&
√xt_ømbuf
->
li°
, 
a˘ive_hód
);

2044 
	`©omic_öc
(&
£gbuf_mgr
->
a˘ive_cou¡
[
ˇche_ty≥
]);

2045 
	`©omic_öc
(&
£gbuf_mgr
->
a˘ive_tŸÆ_cou¡
);

2046 
	`Æloc_ømbuf_∑ge
(
su≥r
, 
√xt_ømbuf
, 
ˇche_ty≥
);

2047 
	`©omic_£t
(&
√xt_ømbuf
->
ªf_cou¡
, 
°rùe_size
);

2049 
i
 = 0;ò< 
NUM_SSD
;i++){

2050 
	`©omic_£t
(&
√xt_ømbuf
->
bios_cou¡
[
i
], 0);

2051 
	`©omic_£t
(&
√xt_ømbuf
->
bios_°¨t
[
i
], 0);

2053 
	`©omic_£t
(&
√xt_ømbuf
->
bios_tŸÆ_cou¡
, 0);

2054 
	`©omic_£t
(&
√xt_ømbuf
->
bios_tŸÆ_°¨t
, 0);

2055 
i
 = 0;ò< 
STRIPE_SZ
;i++){

2056 
√xt_ømbuf
->
bios
[
i
] = 
NULL
;

2058 
	`•ö_lock_öô
(&
√xt_ømbuf
->
lock
);

2067 if(
	`is_wrôe_°rùe
(
ˇche_ty≥
)){

2068 
	`©omic_add
(
NUM_SUMMARY
*
NUM_DATA_SSD
, &
√xt_ømbuf
->
ªf_cou¡
);

2069 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
))

2070 
	`©omic_add
(
CHUNK_SZ
, &
√xt_ømbuf
->
ªf_cou¡
);

2072 
	`©omic_add
(
NUM_SUMMARY
*
NUM_SSD
, &
√xt_ømbuf
->
ªf_cou¡
);

2075 
	`BUG_ON
(
	`USE_ERASURE_RAID6
(&
su≥r
->
∑øm
));

2077 
	`¥ötk
 ("álloc:áctive = %d, inactve = %d \n",

2078 ()
	`©omic_ªad
(&
£gbuf_mgr
->
a˘ive_tŸÆ_cou¡
),

2079 ()
	`©omic_ªad
(&
£gbuf_mgr
->
öa˘ive_cou¡
));

2080 
	`BUG_ON
(1);

2083 
	`•ö_u∆ock_úqª°‹e
(&
£gbuf_mgr
->
lock
, 
Êags
);

2086 
	`¥ötk
 ("álloc:áctive = %d, inactve = %d \n",

2087 ()
	`©omic_ªad
(&
£gbuf_mgr
->
a˘ive_cou¡
),

2088 ()
	`©omic_ªad
(&
£gbuf_mgr
->
öa˘ive_cou¡
));

2089 
	`¥ötk
("Ñambu‡∑gêöa˘ivêcou¡ = %d (%d MBË\n", ()
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_∑ge_cou¡
),

2090 ()
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_∑ge_cou¡
)/256);

2095 
	`BUG_ON
(
√xt_ømbuf
==
NULL
);

2096  
√xt_ømbuf
;

2097 
	}
}

2099 
	$ªÀa£_ømbuf„r
(
dm§c_su≥r
 *
su≥r
, 
ømbuf„r
 *
ømbuf
, 
ˇche_ty≥
){

2100 
£gbuf_m™agî
 *
£gbuf_mgr
 = &
su≥r
->segbuf_mgr;

2101 
li°_hód
 *
öa˘ive_hód
 = &
£gbuf_mgr
->
öa˘ive_li°
;

2102 
Êags
;

2107 
	`•ö_lock_úqßve
(&
£gbuf_mgr
->
lock
, 
Êags
);

2109 
	`‰ì_ømbuf_∑ge
(
su≥r
, 
ømbuf
);

2111 
	`li°_dñ
(&
ømbuf
->
li°
);

2112 
	`©omic_dec
(&
£gbuf_mgr
->
a˘ive_cou¡
[
ˇche_ty≥
]);

2113 
	`©omic_dec
(&
£gbuf_mgr
->
a˘ive_tŸÆ_cou¡
);

2115 
	`li°_add_èû
(&
ømbuf
->
li°
, 
öa˘ive_hód
);

2116 
	`©omic_öc
(&
£gbuf_mgr
->
öa˘ive_cou¡
);

2118 
	`•ö_u∆ock_úqª°‹e
(&
£gbuf_mgr
->
lock
, 
Êags
);

2120 
	`≥ndög_w‹kî_scheduÀ
(
su≥r
);

2121 
	}
}

2124 
	$check_ømbuf_poﬁ
(
dm§c_su≥r
 *
su≥r
){

2125 
i
;

2126 
ømbuf„r
 *
ømbuf
;

2127 
£gbuf_m™agî
 *
£gbuf_mgr
 = &
su≥r
->segbuf_mgr;

2129 
i
 = 0; i < 
£gbuf_mgr
->
num_ømbuf_poﬁ
; i++) {

2130 
ømbuf
 = 
£gbuf_mgr
->
ømbuf_poﬁ
 + 
i
;

2131 if(
ømbuf
==
NULL
)

2134 
	`¥ötk
("Ñambuf %d, start %dÜength = %d \n",

2135 
i
, 
	`©omic_ªad
(&
ømbuf
->
bios_tŸÆ_°¨t
),

2136 
	`©omic_ªad
(&
ømbuf
->
bios_tŸÆ_cou¡
));

2140 
	}
}

2145 
∑ge_li°
 *
	$Æloc_∂
(
gÂ_t
 
gÂ
)

2147 
∑ge_li°
 *
∂
;

2149 
∂
 = 
	`kmÆloc
((*∂), 
gÂ
);

2150 i‡(!
∂
)

2151  
NULL
;

2153 
∂
->
∑ge
 = 
	`Æloc_∑ge
(
gÂ
);

2154 i‡(!
∂
->
∑ge
) {

2155 
	`k‰ì
(
∂
);

2156  
NULL
;

2159  
∂
;

2160 
	}
}

2162 
	$‰ì_∂
(
∑ge_li°
 *
∂
)

2164 
	`__‰ì_∑ge
(
∂
->
∑ge
);

2165 
	`k‰ì
(
∂
);

2166 
	}
}

2169 
	$öô_óch_ømbuf_poﬁ
(
dm§c_su≥r
 *
su≥r
){

2170 
i
, 
j
;

2171 
ømbuf„r
 *
ømbuf
;

2172 
£gbuf_m™agî
 *
£gbuf_mgr
 = &
su≥r
->segbuf_mgr;

2173 
li°_hód
 *
a˘ive_hód
 = &
£gbuf_mgr
->
a˘ive_li°
;

2174 
li°_hód
 *
öa˘ive_hód
 = &
£gbuf_mgr
->
öa˘ive_li°
;

2176 
i
=0;i<()
	`©omic_ªad
(&
£gbuf_mgr
->
öa˘ive_∑ge_cou¡
);i++){

2177 
ømbuf_∑ge
 *
∑ge
;

2178 
∑ge
 = 
	`kmÆloc
((
ømbuf_∑ge
), 
GFP_KERNEL
);

2179 if(!
∑ge
){

2180 
	`WBERR
();

2181  -
ENOMEM
;

2184 
	`li°_add_èû
(&
∑ge
->
li°
, &
£gbuf_mgr
->
öa˘ive_∑ge_li°
);

2187 
∑ge
->
d©a
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
SRC_SIZE_SHIFT
);

2188 i‡(!
∑ge
->
d©a
) {

2189 
	`WBERR
();

2190  -
ENOMEM
;

2193 
∑ge
->
∂
 = 
	`Æloc_∂
(
__GFP_NOWARN
 | 
__GFP_NORETRY
);

2194 i‡(!
∑ge
->
∂
) {

2195 
	`WBERR
();

2196  -
ENOMEM
;

2199 
∑ge
->∑gê
	`Æloc_∑ges
(
GFP_KERNEL
, 
SRC_SIZE_SHIFT
);

2200 i‡(!
∑ge
->page) {

2201 
	`WBERR
();

2202  -
ENOMEM
;

2207 
	`INIT_LIST_HEAD
(
a˘ive_hód
);

2208 
	`INIT_LIST_HEAD
(
öa˘ive_hód
);

2210 
£gbuf_mgr
->
∑ges
 = 
	`vmÆloc
(£gbuf_mgr->
num_ømbuf_poﬁ
 * (*Ë* 
CHUNK_SZ
 * 
MAX_CACHE_DEVS
);

2211 
	`¥ötk
(" Allocate memory segbuf_mgr->pages = %dbytes \n",

2212 ()(
£gbuf_mgr
->
num_ømbuf_poﬁ
 * (*Ë* 
CHUNK_SZ
 * 
MAX_CACHE_DEVS
));

2213 if(
£gbuf_mgr
->
∑ges
==
NULL
){

2214 
	`¥ötk
(" Cannotállocate memory segbuf_mgr->pages = %dbytes \n",

2215 ()(
£gbuf_mgr
->
num_ømbuf_poﬁ
 * (*Ë* 
CHUNK_SZ
 * 
MAX_CACHE_DEVS
));

2216  -
ENOMEM
;

2218 
£gbuf_mgr
->
bios
 = 
	`vmÆloc
(£gbuf_mgr->
num_ømbuf_poﬁ
 * (*Ë* 
CHUNK_SZ
 * 
MAX_CACHE_DEVS
);

2220 
	`¥ötk
(" Allocate memory segbuf_mgr->bios = %dbytes \n",

2221 ()(
£gbuf_mgr
->
num_ømbuf_poﬁ
 * (*Ë* 
CHUNK_SZ
 * 
MAX_CACHE_DEVS
));

2222 if(
£gbuf_mgr
->
bios
==
NULL
){

2223 
	`¥ötk
(" Cannotállocate memory segbuf_mgr->bios = %dbytes \n",

2224 ()(
£gbuf_mgr
->
num_ømbuf_poﬁ
 * (*Ë* 
CHUNK_SZ
 * 
MAX_CACHE_DEVS
));

2225  -
ENOMEM
;

2228 
i
 = 0; i < 
£gbuf_mgr
->
num_ømbuf_poﬁ
; i++) {

2229 
num_∑ges
 = 
CHUNK_SZ
 * 
MAX_CACHE_DEVS
;

2231 
ømbuf
 = 
£gbuf_mgr
->
ømbuf_poﬁ
 + 
i
;

2232 
ømbuf
->
ømbuf_id
 = 
i
;

2233 
ømbuf
->
Æloc_cou¡
 = 0;

2246 
ømbuf
->
∑ges
 = (
ømbuf_∑ge
 **)
£gbuf_mgr
->∑ge†+ 
i
 * 
num_∑ges
;

2247 i‡(!
ømbuf
->
∑ges
) {

2248 
	`BUG_ON
(1);

2249  -
ENOMEM
;

2254 
ømbuf
->
bios
 = (
bio
 **)
£gbuf_mgr
->bio†+ 
i
 * 
num_∑ges
;

2255 i‡(!
ømbuf
->
bios
) {

2256 
	`BUG_ON
(1);

2257  -
ENOMEM
;

2260 
j
=0;j<
num_∑ges
;j++){

2261 
ømbuf
->
∑ges
[
j
] = 
NULL
;

2264 
j
=0;j<
num_∑ges
;j++){

2265 
ømbuf
->
bios
[
j
] = 
NULL
;

2268 
j
 = 0;j < 
NUM_SSD
;j++){

2269 
	`©omic_£t
(&
ømbuf
->
bios_cou¡
[
j
], 0);

2270 
	`©omic_£t
(&
ømbuf
->
bios_°¨t
[
j
], 0);

2272 
	`©omic_£t
(&
ømbuf
->
bios_tŸÆ_cou¡
, 0);

2273 
	`©omic_£t
(&
ømbuf
->
bios_tŸÆ_°¨t
, 0);

2275 
	`li°_add_èû
(&
ømbuf
->
li°
, 
öa˘ive_hód
);

2276 
	`©omic_öc
(&
£gbuf_mgr
->
öa˘ive_cou¡
);

2280 
	}
}

2282 
__mu°_check
 
	$öô_ømbuf_poﬁ
(
dm§c_su≥r
 *
su≥r
)

2284 
ªs
;

2285 
u32
 
ƒ
;

2286 
£gbuf_m™agî
 *
£gbuf_mgr
 = &
su≥r
->segbuf_mgr;

2287 
i
;

2293 
ƒ
 = 
su≥r
->
∑øm
.
ømbuf_poﬁ_amou¡
/
STRIPE_SZ
;

2295 i‡(!
ƒ
) {

2296 
	`WBERR
("rambuf must beállocatedátÜeast one");

2297  -
EINVAL
;

2305 
£gbuf_mgr
->
num_ømbuf_poﬁ
 = 
ƒ
;

2307 
£gbuf_mgr
->
ømbuf_poﬁ
 = 
	`vmÆloc
((
ømbuf„r
Ë* segbuf_mgr->
num_ømbuf_poﬁ
);

2308 i‡(!
£gbuf_mgr
->
ømbuf_poﬁ
) {

2309 
	`WBERR
();

2310  -
ENOMEM
;

2313 
	`©omic_£t
(&
£gbuf_mgr
->
a˘ive_tŸÆ_cou¡
, 0);

2314 
i
 = 0;ò< 
NBUF
;i++)

2315 
	`©omic_£t
(&
£gbuf_mgr
->
a˘ive_cou¡
[
i
], 0);

2316 
	`©omic_£t
(&
£gbuf_mgr
->
öa˘ive_cou¡
, 0);

2318 
	`INIT_LIST_HEAD
(&
£gbuf_mgr
->
a˘ive_∑ge_li°
);

2319 
	`INIT_LIST_HEAD
(&
£gbuf_mgr
->
öa˘ive_∑ge_li°
);

2321 
	`©omic_£t
(&
£gbuf_mgr
->
a˘ive_∑ge_cou¡
, 0);

2322 
	`©omic_£t
(&
£gbuf_mgr
->
gc_a˘ive_∑ge_cou¡
, 0);

2323 
	`©omic_£t
(&
£gbuf_mgr
->
öa˘ive_∑ge_cou¡
, 
su≥r
->
∑øm
.
ømbuf_poﬁ_amou¡
);

2324 
	`©omic_£t
(&
£gbuf_mgr
->
tŸÆ_∑ge_cou¡
, 
su≥r
->
∑øm
.
ømbuf_poﬁ_amou¡
);

2325 
	`¥ötk
(" Rambu‡Sizê%d MB,ÇumÑmabu‡hód = %d\n", 
su≥r
->
∑øm
.
ømbuf_poﬁ_amou¡
/256, 
ƒ
);

2327 
ªs
 = 
	`öô_óch_ømbuf_poﬁ
(
su≥r
);

2328 if(
ªs
)

2329  
ªs
;

2331 
	`¥ötk
 ("á˘ivê%d, i«˘vê%d \n", ()
	`©omic_ªad
(&
£gbuf_mgr
->
a˘ive_tŸÆ_cou¡
),

2332 ()
	`©omic_ªad
(&
£gbuf_mgr
->
öa˘ive_cou¡
));

2334 
	`•ö_lock_öô
(&
£gbuf_mgr
->
lock
);

2336 
	`öô_waôqueue_hód
(&
£gbuf_mgr
->
waô_queue
);

2338 
£gbuf_mgr
->
öôülized
 = 1;

2341 
	}
}

2343 
	$‰ì_ømbuf_poﬁ
(
dm§c_su≥r
 *
su≥r
)

2346 
ømbuf_∑ge
 *
∑ge
, *
ãmp
;

2347 
£gbuf_m™agî
 *
£gbuf_mgr
 = &
su≥r
->segbuf_mgr;

2350 if(!
£gbuf_mgr
->
öôülized
)

2360 
	`v‰ì
(
£gbuf_mgr
->
∑ges
);

2361 
	`v‰ì
(
£gbuf_mgr
->
bios
);

2362 
	`v‰ì
(
£gbuf_mgr
->
ømbuf_poﬁ
);

2364 
	`li°_f‹_óch_íåy_ß„
(
∑ge
, 
ãmp
, &
£gbuf_mgr
->
a˘ive_∑ge_li°
, 
li°
){

2365 
	`li°_dñ
(&
∑ge
->
li°
);

2369 
	`‰ì_∂
(
∑ge
->
∂
);

2370 
	`k‰ì
(
∑ge
);

2371 
	`©omic_dec
(&
£gbuf_mgr
->
a˘ive_∑ge_cou¡
);

2373 
	`BUG_ON
(
	`©omic_ªad
(&
£gbuf_mgr
->
a˘ive_∑ge_cou¡
));

2375 
	`li°_f‹_óch_íåy_ß„
(
∑ge
, 
ãmp
, &
£gbuf_mgr
->
öa˘ive_∑ge_li°
, 
li°
){

2376 
	`li°_dñ
(&
∑ge
->
li°
);

2380 
	`‰ì_∂
(
∑ge
->
∂
);

2381 
	`k‰ì
(
∑ge
);

2382 
	`©omic_dec
(&
£gbuf_mgr
->
öa˘ive_∑ge_cou¡
);

2384 
	`BUG_ON
(
	`©omic_ªad
(&
£gbuf_mgr
->
öa˘ive_∑ge_cou¡
));

2385 
	}
}

2387 
¸óã_d´m⁄
(
dm§c_su≥r
 *
su≥r
,

2388 
èsk_°ru˘
 **
èskp
,

2389 (*
thªad‚
)(*
d©a
),

2390 *
«me
){

2391 
èsk_°ru˘
 *
èsk
;

2392 
r
 = 0;

2394 
èsk
 = 
	`kthªad_¸óã
(
thªad‚
, 
su≥r
, 
«me
);

2395 i‡(
	`IS_ERR
(
«me
)) {

2396 
r
 = 
	`PTR_ERR
(
èsk
);

2397 
èsk
 = 
NULL
;

2399 
	`¥ötk
(" %†d´m⁄ c™nŸ bê¸óãd \n", 
«me
);

2401 
	`wake_up_¥o˚ss
(
èsk
);

2403 *
èskp
 = 
èsk
;

2405  
r
;

2406 
	}
}

2410 
	#CREATE_DAEMON
(
«me
) \

2412 
su≥r
->
«me
##
_d´m⁄
 = 
	`kthªad_¸óã
“ame##
_¥oc
, super, \

2414 i‡(
	`IS_ERR
(
su≥r
->
«me
##
_d´m⁄
)) { \

2415 
r
 = 
	`PTR_ERR
(
su≥r
->
«me
##
_d´m⁄
); \

2416 
su≥r
->
«me
##
_d´m⁄
 = 
NULL
; \

2417 
	`WBERR
("couldn't spawn" #name "daemon"); \

2418 
bad_
##
«me
##
_d´m⁄
; \

2420 
	`wake_up_¥o˚ss
(
su≥r
->
«me
##
_d´m⁄
); \

2421 } 0)

	)

2426 
	$‰ì_ˇche
(
dm§c_su≥r
 *
su≥r
)

2428 
i
;

2430 
	`ªad_miss_mgr_deöô
(
su≥r
);

2432 
	`ªcovîy_mgr_deöô
(
su≥r
);

2434 
	`sync_mgr_deöô
(
su≥r
);

2436 
	`Êush_mgr_deöô
(
su≥r
);

2438 
	`‰ì_ht
(
su≥r
);

2439 
	`‰ì_£gmít_hódî_¨øy
(
su≥r
);

2441 
	`‰ì_ømbuf_poﬁ
(
su≥r
);

2443 
i
 = 0;ò< 
MAX_CACHE_DEVS
;i++){

2444 if(
su≥r
->
mëablock_¨øy
[
i
]){

2445 
	`œrge_¨øy_‰ì
(
su≥r
->
mëablock_¨øy
[
i
]);

2449 
	`∂uggî_deöô
(
su≥r
);

2450 
	`degøded_mgr_deöô
(
su≥r
);

2451 
	}
}

	@metadata.h

23 #i‚de‡
DM_SRC_METADATA_H


24 
	#DM_SRC_METADATA_H


	)

26 
	#VMALLOC


	)

29 
	s∑π
 {

30 *
	mmem‹y
;

33 
	sœrge_¨øy
 {

34 
∑π
 *
	m∑πs
;

35 
u64
 
	mnum_ñems
;

36 
u32
 
	mñemsize
;

38 
	#ALLOC_SIZE
 (1 << 16)

	)

43 
mëablock
 *
mb_©
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
);

44 
£gmít_hódî
 *
gë_£gmít_hódî_by_id
(
dm§c_su≥r
 *,

45 
u64
 
£gmít_id
);

46 
£gmít_hódî
 *
gë_£gmít_hódî_by_mb_idx
(
dm§c_su≥r
 *
su≥r
,

47 
u32
 
mb_idx
);

48 
£˘‹_t
 
ˇlc_mb_°¨t_£˘‹
(
dm§c_su≥r
 *,

49 
£gmít_hódî
 *, 
u32
 
mb_idx
);

50 
boﬁ
 
is_⁄_buf„r
(
dm§c_su≥r
 *, 
u32
 
mb_idx
);

52 
u32
 
gë_cuº_utû
(
dm§c_su≥r
 *);

56 
ht_hód
 *
ht_gë_hód
(
dm§c_su≥r
 *, 
£˘‹_t
);

57 
mëablock
 *
ht_lookup
(
dm§c_su≥r
 *, 
£˘‹_t
);

58 
ht_ªgi°î
(
dm§c_su≥r
 *, 
£˘‹_t
, 
mëablock
 *);

59 
ht_dñ
(
dm§c_su≥r
 *, 
mëablock
 *);

60 
disˇrd_ˇches_ö£g
(
dm§c_su≥r
 *, 
£gmít_hódî
 *);

64 
__mu°_check
 
sˇn_su≥rblock
(
dm§c_su≥r
 *);

65 
__mu°_check
 
f‹m©_ˇche_devi˚
(
dm§c_su≥r
 *);

69 
¥ï¨e_£gmít_hódî_devi˚
(
£gmít_hódî_devi˚
 *
de°
,

70 
dm§c_su≥r
 *,

71 
£gmít_hódî
 *
§c
, 
ˇche_ty≥
, 
ømbuf_∑ge
 **
ømbuf
);

73 
u8
 
ˇlc_checksum
(u8 *
±r
, 
size
);

76 
Æloc_migøti⁄_buf„r
(
dm§c_su≥r
 *, 
size_t
 
num_b©ch
);

77 
‰ì_migøti⁄_buf„r
(
dm§c_su≥r
 *);

81 
__mu°_check
 
ªsume_ˇche
(
dm§c_su≥r
 *);

82 
‰ì_ˇche
(
dm§c_su≥r
 *);

86 
ö£π_£g_to_Æloc_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
);

87 
ö£π_£g_to_u£d_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
);

88 
move_£g_u£d_to_£Æed_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
);

89 
move_£g_£Æed_to_migøã_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
lock
);

90 
move_£g_migøã_to_Æloc_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
);

91 
£gmít_hódî
 *
ªmove_Æloc_queue
(
dm§c_su≥r
 *
su≥r
, £gmít_hódî *
£g
);

92 
em±y_£Æed_queue
(
dm§c_su≥r
 *
su≥r
);

93 
em±y_Æloc_queue
(
dm§c_su≥r
 *
su≥r
);

94 
gë_Æloc_cou¡
(
dm§c_su≥r
 *
su≥r
);

95 
¥öt_Æloc_queue
(
dm§c_su≥r
 *
su≥r
);

96 
move_£g_mru_£Æed
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
);

97 
ªÀa£_ª£rve_£gs
(
dm§c_su≥r
 *
su≥r
);

98 
ª£rve_ª£rve_£gs
(
dm§c_su≥r
 *
su≥r
, 
√ed_£gs
);

99 
£gmít_hódî
 *
ªmove_ª£rve_queue
(
dm§c_su≥r
 *
su≥r
);

100 
ømbuf„r
 *
Æloc_ømbuf„r
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
°rùe_size
);

101 
Æloc_ømbuf_∑ge
(
dm§c_su≥r
 *
su≥r
, 
ømbuf„r
 *
ømbuf
, 
ˇche_ty≥
);

102 
ªÀa£_ømbuf„r
(
dm§c_su≥r
 *
su≥r
, 
ømbuf„r
 *, 
ˇche_ty≥
);

103 
£g_°©
(
£gmít_hódî
 *
£g
);

104 
mëablock
 *
gë_mb
(
dm§c_su≥r
 *
su≥r
, 
u32
 
£g_id
, u32 
idx
);

105 
œrge_¨øy
 *
œrge_¨øy_Æloc
(
u32
 
ñemsize
, 
u64
 
num_ñems
);

106 
ømbuf_∑ge
 *
_Æloc_ømbuf_∑ge
(
dm§c_su≥r
 *
su≥r
);

107 
ømbuf_∑ge
 *
_‰ì_ømbuf_∑ge
(
dm§c_su≥r
 *
su≥r
, ømbuf_∑gê*
∑ge
);

108 
‰ì_sögÀ_∑ge
(
dm§c_su≥r
 *
su≥r
, 
ømbuf_∑ge
 *
∑ge
);

109 
ømbuf_∑ge
 *
Æloc_sögÀ_∑ge
(
dm§c_su≥r
 *
su≥r
);

111 *
œrge_¨øy_©
(
œrge_¨øy
 *
¨r
, 
u32
 
i
);

112 
œrge_¨øy_‰ì
(
œrge_¨øy
 *
¨r
);

113 
œrge_¨øy
 *
œrge_¨øy_Æloc
(
u32
 
ñemsize
, 
u64
 
num_ñems
);

114 
¸óã_d´m⁄
(
dm§c_su≥r
 *
su≥r
, 
èsk_°ru˘
 **
èskp
, (*
thªad‚
)(*
d©a
), *
«me
);

115 
u32
 
	`ˇlc_num_chunks
(
dm_dev
 *
dev
, 
dm§c_su≥r
 *
su≥r
);

116 
__mu°_check
 
	`sˇn_mëad©a
(
dm§c_su≥r
 *
su≥r
);

117 
__mu°_check
 
	`ªsume_m™agîs
(
dm§c_su≥r
 *
su≥r
);

118 
__mu°_check
 
	`öô_ømbuf_poﬁ
(
dm§c_su≥r
 *
su≥r
);

119 
__mu°_check
 
	`öô_£gmít_hódî_¨øy
(
dm§c_su≥r
 *
su≥r
);

120 
__mu°_check
 
	`ht_em±y_öô
(
dm§c_su≥r
 *
su≥r
);

121 
	`‰ì_ht
(
dm§c_su≥r
 *
su≥r
);

122 
	`‰ì_£gmít_hódî_¨øy
(
dm§c_su≥r
 *
su≥r
);

123 
	`‰ì_ømbuf_poﬁ
(
dm§c_su≥r
 *
su≥r
);

124 
	`check_dúty_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
cur_£g
);

125 
	`check_vÆid_cou¡
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
cur_£g
);

126 
	`move_£g_migøã_to_£Æed_queue
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
);

127 
	`check_ømbuf_poﬁ
(
dm§c_su≥r
 *
su≥r
);

129 
u32
 
	`£gmít_group_öc_‰ì_£gs
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
);

130 
	`£gmít_group_dec_‰ì_£gs
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
);

131 
	`£gmít_group_¥öt_°©
(
dm§c_su≥r
 *
su≥r
);

132 
group_hódî
 *
	`ªmove_Æloc_group_queue
(
dm§c_su≥r
 *
su≥r
);

133 
	`ö£π_group_to_u£d_queue
(
dm§c_su≥r
 *
su≥r
, 
group_hódî
 *
group
);

134 
	`move_group_u£d_to_£Æed_queue
(
dm§c_su≥r
 *
su≥r
, 
group_hódî
 *
group
);

135 
	`move_group_£Æed_to_migøã_queue
(
dm§c_su≥r
 *
su≥r
, 
group_hódî
 *
group
, 
lock
);

136 
	`move_group_migøã_to_Æloc_queue
(
dm§c_su≥r
 *
su≥r
, 
group_hódî
 *
group
);

137 
	`gë_group_Æloc_cou¡
(
dm§c_su≥r
 *
su≥r
);

138 
	`assign_√w_£gmít
(
dm§c_su≥r
 *
su≥r
);

	@raid.h

24 #i‚de‡
_RAID_CONF_H


25 
	#_RAID_CONF_H


	)

29 
	#NR_STRIPE_HASH_LOCKS
 8

	)

30 
	#STRIPE_HASH_LOCKS_MASK
 (
NR_STRIPE_HASH_LOCKS
 - 1)

	)

32 
	sr5c⁄f
 {

33 
hli°_hód
 *
	m°rùe_hashtbl
;

35 
•ölock_t
 
	mhash_locks
[
NR_STRIPE_HASH_LOCKS
];

36 
mddev
 *
	mmddev
;

37 
	mchunk_£˘‹s
;

38 
	mÀvñ
, 
	mÆg‹ôhm
;

39 
	mmax_degøded
;

40 
	møid_disks
;

41 
	mmax_ƒ_°rùes
;

48 
£˘‹_t
 
	mªsh≠e_¥ogªss
;

52 
£˘‹_t
 
	mªsh≠e_ß„
;

53 
	m¥evious_øid_disks
;

54 
	m¥ev_chunk_£˘‹s
;

55 
	m¥ev_Ægo
;

56 
	mgíî©i⁄
;

57 
£qcou¡_t
 
	mgí_lock
;

58 
	mªsh≠e_checkpoöt
;

60 
	mmö_off£t_diff
;

67 
li°_hód
 
	mh™dÀ_li°
;

68 
li°_hód
 
	mhﬁd_li°
;

69 
li°_hód
 
	mdñayed_li°
;

70 
li°_hód
 
	mbôm≠_li°
;

71 
bio
 *
	mªåy_ªad_Æig√d
;

72 
bio
 *
	mªåy_ªad_Æig√d_li°
;

73 
©omic_t
 
	m¥îód_a˘ive_°rùes
;

74 
©omic_t
 
	ma˘ive_Æig√d_ªads
;

75 
©omic_t
 
	m≥ndög_fuŒ_wrôes
;

76 
	mby∑ss_cou¡
;

77 
	mby∑ss_thªshﬁd
;

78 
li°_hód
 *
	mœ°_hﬁd
;

80 
©omic_t
 
	mªsh≠e_°rùes
;

84 
	ma˘ive_«me
;

85 
	mˇche_«me
[2][32];

86 
kmem_ˇche
 *
	m¶ab_ˇche
;

88 
	m£q_Êush
, 
	m£q_wrôe
;

89 
	mquõs˚
;

91 
	mfuŒsync
;

95 
	mªcovîy_dißbÀd
;

97 
	søid5_≥r˝u
 {

98 
∑ge
 *
	m•¨e_∑ge
;

99 *
	ms¸ibbÀ
;

103 } 
__≥r˝u
 *
	m≥r˝u
;

104 
size_t
 
	ms¸ibbÀ_Àn
;

108 #ifde‡
CONFIG_HOTPLUG_CPU


109 
nŸifõr_block
 
	m˝u_nŸify
;

115 
©omic_t
 
	ma˘ive_°rùes
;

116 
li°_hód
 
	möa˘ive_li°
[
NR_STRIPE_HASH_LOCKS
];

117 
©omic_t
 
	mem±y_öa˘ive_li°_ƒ
;

118 
Œi°_hód
 
	mªÀa£d_°rùes
;

119 
waô_queue_hód_t
 
	mwaô_f‹_°rùe
;

120 
waô_queue_hód_t
 
	mwaô_f‹_ovîœp
;

121 
	möa˘ive_blocked
;

124 
	mpoﬁ_size
;

125 
•ölock_t
 
	mdevi˚_lock
;

126 
disk_öfo
 *
	mdisks
;

131 
md_thªad
 *
	mthªad
;

132 
li°_hód
 
	mãmp_öa˘ive_li°
[
NR_STRIPE_HASH_LOCKS
];

133 
r5w‹kî_group
 *
	mw‹kî_groups
;

134 
	mgroup_˙t
;

135 
	mw‹kî_˙t_≥r_group
;

	@target.c

24 
	~<löux/buf„r_hód.h
>

25 
	~<löux/dm´ngöe.h
>

26 
	~<löux/øid/x‹.h
>

27 
	~<löux/øid/pq.h
>

28 
	~<löux/dm-kc›yd.h
>

29 
	~<löux/blkdev.h
>

30 
	~<löux/sched.h
>

31 
	~<löux/dñay.h
>

32 
	~<löux/¸c32.h
>

33 
	~<löux/gÂ.h
>

34 
	~<löux/w‹kqueue.h
>

35 
	~<löux/hπimî.h
>

36 
	~<löux/ktime.h
>

37 
	~<löux/jhash.h
>

38 
	~"èrgë.h
"

39 
	~"mëad©a.h
"

40 
	~"d´m⁄.h
"

41 
	~"Ãu.h
"

42 
	~"Æloc.h
"

47 
	$dm§c_io
(
dm_io_ªque°
 *
io_ªq
, 
num_ªgi⁄s
,

48 
dm_io_ªgi⁄
 *
whîe
, *
sync_îr‹_bôs
)

50  
	`dm_io
(
io_ªq
, 
num_ªgi⁄s
, 
whîe
, 
sync_îr‹_bôs
);

51 
	}
}

54 
£˘‹_t
 
	$dm§c_devsize_£˘‹s
(
dm_dev
 *
dev
)

56  
	`i_size_ªad
(
dev
->
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
;

57 
	}
}

60 
	$¥ï¨e_chunk_summ¨y
(

61 
dm§c_su≥r
 *
su≥r
,

62 
£gmít_hódî
 *
£g
,

63 
ømbuf_∑ge
 **
∑ges
,

64 
ssd_id
,

65 
ˇche_ty≥


68 
£gmít_hódî_devi˚
 *
de°
;

69 
u32
 
chunk_°¨t
;

70 
u32
 
i
;

71 
u64
 
£quí˚
;

72 
u32
 
summ¨y_off£t
;

74 
summ¨y_off£t
 = 
	`gë_summ¨y_off£t
(
su≥r
, 
ssd_id
);

75 
chunk_°¨t
 = 
ssd_id
 * 
CHUNK_SZ
;

77 
£quí˚
 = 
	`©omic64_öc_ªtu∫
(&
su≥r
->
ˇche_°©
.
Æloc_£quí˚
);

78 
£g
->
£quí˚
 = sequence;

81 
de°
 = (
£gmít_hódî_devi˚
 *)
	`∑ge_addªss
(
∑ges
[
summ¨y_off£t
]->
∂
->
∑ge
);

82 
de°
->
£quí˚
 = 
	`˝u_to_À64
(
£g
->sequence);

83 
de°
->
uuid
 = 
su≥r
->
ˇche_°©
.uuid;

84 
de°
->
magic
 = 
SRC_MAGIC
;

85 
de°
->
ty≥
 = 
ˇche_ty≥
;

87 if(
ˇche_ty≥
==
GWBUF
)

88 
de°
->
ty≥
 = 
WCBUF
;

89 if(
ˇche_ty≥
==
GRBUF
)

90 
de°
->
ty≥
 = 
RCBUF
;

92 
i
 = 0; i < 
CHUNK_SZ
; i++) {

93 
mëablock
 *
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
chunk_°¨t
 + 
i
);

94 
mëablock_devi˚
 *
mbdev
;

95 
u32
 
mëa_∑ge
 = 
summ¨y_off£t
 + 1 + 
i
/
NUM_ENTRY_PER_PAGE
;

96 
u32
 
mëa_off£t
 = 
i
 % 
NUM_ENTRY_PER_PAGE
;

98 
mbdev
 = (
mëablock_devi˚
 *)
	`∑ge_addªss
(
∑ges
[
mëa_∑ge
]->
∂
->
∑ge
);

100 if(!
	`chunk_summ¨y_ønge
(
su≥r
, 
i
)){

101 if(
ˇche_ty≥
==
GWBUF
){

102 if(
mb
->
£˘‹
==~0){

103 
	`¥ötk
(" seg = %d, ssd = %d, off£à%d se˘‹ = %d \n", ()
£g
->
£g_id
, 
ssd_id
, 
i
, ()
mb
->
£˘‹
);

104 
	`¥ötk
(" check .. \n");

108 
mbdev
[
mëa_off£t
].
£˘‹
 = 
mb
->sector;

109 
mbdev
[
mëa_off£t
].
dúty_bôs
 = 
	`ã°_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
);

111 
mbdev
[
mëa_off£t
].
£˘‹
 = ~0;

112 
mbdev
[
mëa_off£t
].
dúty_bôs
 = 0;

116 #ifde‡
USE_CHECKSUM


117 
i
 = 0; i < 
CHUNK_SZ
; i++) {

118 
mëablock
 *
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
chunk_°¨t
 + 
i
);

119 
mëablock_devi˚
 *
mbdev
 = &
de°
->
mb¨r
[
i
];

120 
mbdev
->
checksum
 = 
mb
->checksum;

123 
	}
}

128 
	$gíî©e_fuŒ_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

129 
ømbuf„r
 *
ømbuf
, 
ssd_id
, 
fuŒ
){

130 
blk_∂ug
 
∂ug
;

131 
i
;

133 
	`¥ï¨e_chunk_summ¨y
(
su≥r
, 
£g
, 
ømbuf
->
∑ges
, 
ssd_id
, seg->
£g_ty≥
);

135 
	`blk_°¨t_∂ug
(&
∂ug
);

136 
i
 = 0;ò< 
NUM_SUMMARY
;i++){

137 
wb_job
 *
job
;

139 
u32
 
summ¨y_mb_idx
 = 
	`gë_summ¨y_off£t
(
su≥r
, 
ssd_id
Ë+ 
i
;

140 
job
 = 
	`wrôeback_make_job
(
su≥r
, 
£g
, 
summ¨y_mb_idx
, 
NULL
, 
ømbuf
, 
fuŒ
);

141 
	`wrôeback_issue_job
(
su≥r
, 
job
);

143 
	`blk_föish_∂ug
(&
∂ug
);

144 
	}
}

148 
	$ch™ge_£g_°©us
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
£g_Àngth
, 
f‹˚_£Æ
){

149 
group_hódî
 *
group
;

150 
Êags
;

151 
group_£Æed
 = 0;

155 
	`LOCK
(
su≥r
, 
f
);

156 
	`©omic_add
(
	`©omic_ªad
(&
£g
->
∑π_Àngth
), &£g->
∑π_°¨t
);

157 
	`©omic_£t
(&
£g
->
∑π_Àngth
, 0);

158 
	`UNLOCK
(
su≥r
, 
f
);

161 if(
f‹˚_£Æ
 || 
£g_Àngth
>=
STRIPE_SZ
){

163 if(
	`ã°_bô
(
SEG_PARTIAL
, &
£g
->
Êags
)){

164 
	`¥ötk
(" f‹˚ só»... seg .. = %d \n", ()
£g
->
£g_id
);

168 if(
	`ˇlc_mëa_cou¡
(
su≥r
, 
£g
)!=
	`gë_mëad©a_cou¡
(su≥r, seg->
£g_ty≥
)){

169 
	`¥ötk
(" *£Æed: seg = %d vÆid = %d, mëacou¡ = %d \n", ()
£g
->
£g_id
, 
	`©omic_ªad
(&£g->
vÆid_cou¡
),

170 
	`ˇlc_mëa_cou¡
(
su≥r
, 
£g
));

173 
	`LOCK
(
su≥r
, 
f
);

174 if(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)-
	`gë_mëad©a_cou¡
(
su≥r
, seg->
£g_ty≥
)!=

175 
	`ˇlc_vÆid_cou¡
(
su≥r
, 
£g
, 1)){

176 
	`¥ötk
(" invalid valid count = %d %d, dummy = %d \n",

177 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)-
	`gë_mëad©a_cou¡
(
su≥r
, seg->
£g_ty≥
),

178 
	`ˇlc_vÆid_cou¡
(
su≥r
, 
£g
, 1),

179 
	`©omic_ªad
(&
£g
->
dummy_cou¡
));

181 
	`UNLOCK
(
su≥r
, 
f
);

191 
	`lock£g
(
£g
, 
Êags
);

192 if(
£g
->
£g_ty≥
==
GWBUF
){

193 
	`©omic_dec
(&
su≥r
->
w°©
.
£g_cou¡
[
GWBUF
]);

194 
	`©omic_öc
(&
su≥r
->
w°©
.
£g_cou¡
[
WCBUF
]);

195 
£g
->
£g_ty≥
 = 
WCBUF
;

196 }if(
£g
->
£g_ty≥
==
GRBUF
){

197 
	`©omic_dec
(&
su≥r
->
w°©
.
£g_cou¡
[
GRBUF
]);

198 
	`©omic_öc
(&
su≥r
->
w°©
.
£g_cou¡
[
RCBUF
]);

199 
£g
->
£g_ty≥
 = 
RCBUF
;

201 
	`u∆ock£g
(
£g
, 
Êags
);

203 if(
	`ã°_bô
(
SEG_USED
, &
£g
->
Êags
)||ã°_bô(
SEG_PARTIAL
, &seg->flags)){

204 
	`£t_bô
(
SEG_SEALED
, &
£g
->
Êags
);

205 
	`˛ór_bô
(
SEG_USED
, &
£g
->
Êags
);

206 
	`˛ór_bô
(
SEG_PARTIAL
, &
£g
->
Êags
);

207 
	`move_£g_u£d_to_£Æed_queue
(
su≥r
, 
£g
);

209 
group
 = &
su≥r
->
group_hódî_¨øy
[
£g
->
£g_id
/
SEGMENT_GROUP_SIZE
];

210 if(
	`©omic_öc_ªtu∫
(&
group
->
£Æed_£g_cou¡
)==
SEGMENT_GROUP_SIZE
){

212 
	`move_group_u£d_to_£Æed_queue
(
su≥r
, 
group
);

213 
group_£Æed
 = 1;

217 if(
	`ã°_bô
(
SEG_PARTIAL
, &
£g
->
Êags
)){

218 
	`£t_bô
(
SEG_USED
, &
£g
->
Êags
);

219 
	`˛ór_bô
(
SEG_PARTIAL
, &
£g
->
Êags
);

223 
	`BUG_ON
(
	`©omic_ªad
(&
£g
->
Àngth
)>
STRIPE_SZ
);

224  
group_£Æed
;

226 
	}
}

229 
	$buûd_summ¨y_job
(
dm§c_su≥r
 *
su≥r
,

230 
£gmít_hódî
 *
£g
,

231 
ømbuf„r
 *
ømbuf
,

232 
f‹˚_£Æ
){

233 
i
;

235 if(
	`©omic_ªad
(&
£g
->
∑π_Àngth
) ||

236 (
f‹˚_£Æ
 && 
	`©omic_ªad
(&
£g
->
Àngth
)))

238 
fuŒ
 = 0;

240 if(
f‹˚_£Æ
 || 
	`√ed_ª‰esh_£gmít
(
su≥r
, 
£g
->
£g_ty≥
, 
	`©omic_ªad
(&£g->
Àngth
)))

241 
fuŒ
 = 1;

243 
fuŒ
 = 0;

245 
i
 = 0;ò< 
NUM_SSD
;i++){

246 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
Ë&& 
	`is_wrôe_°rùe
(
£g
->
£g_ty≥
)){

247 if(
i
==
	`gë_∑rôy_ssd
(
su≥r
, 
£g
->
£g_id
))

251 
	`gíî©e_fuŒ_summ¨y
(
su≥r
, 
£g
, 
ømbuf
, 
i
, 
fuŒ
);

253 
	`BUG_ON
(
	`©omic_ªad
(&
£g
->
Àngth
)>
STRIPE_SZ
);

255 
	}
}

261 
	$gíî©e_∑rôy_io
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

262 
ømbuf„r
 *
ømbuf
,

263 
fuŒ
){

265 
dm_io_ªque°
 
io_ªq
;

266 
dm_io_ªgi⁄
 
ªgi⁄
;

267 
u32
 
mem_off£t
 = 0;

268 
u32
 
tmp32
;

269 
∑rôy_size
 = 
CHUNK_SZ
;

270 
∑rôy_°¨t
;

271 
i
;

273 if(
	`NO_USE_ERASURE_CODE
(&
su≥r
->
∑øm
))

276 
∑rôy_°¨t
 = 
	`curs‹_∑rôy_°¨t
(
su≥r
, 
£g
->
£g_id
, seg->
£g_ty≥
);

277 
i
 = 0;ò<
∑rôy_size
;i++){

278 
u32
 
off£t
 = 
∑rôy_°¨t
 + 
i
;

279 
mëablock
 *
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
off£t
);

280 
wb_job
 *
job
;

282 if(!
	`ã°_bô
(
MB_PARITY_NEED
, &
mb
->
mb_Êags
)){

283 if(
i
 < 5)

284 
	`¥ötk
("ÖartialÖarity (unsupported) data seg = %d, idx = %d,Ñefcount = %d, %d\n",

285 ()
£g
->
£g_id
, ()
mb
->
idx
%
STRIPE_SZ
, ()
	`©omic_ªad
(&
ømbuf
->
ªf_cou¡
), 
fuŒ
);

292 
job
 = 
	`wrôeback_make_job
(
su≥r
, 
£g
, 
mb
->
idx
, 
NULL
, 
ømbuf
, 
fuŒ
);

293 
	`wrôeback_issue_job
(
su≥r
, 
job
);

296 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
))

299 
i
 = 0;ò<
∑rôy_size
;i++){

300 
u32
 
off£t
 = (
∑rôy_°¨t
 + 
CHUNK_SZ
 + 
i
Ë% 
STRIPE_SZ
;

301 
mëablock
 *
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
off£t
);

303 
	`¥ötk
(" RAID6 isÇot supported. \n");

304 
	`BUG_ON
(1);

305 if(!
	`ã°_bô
(
MB_PARITY_NEED
, &
mb
->
mb_Êags
))

310 
	`div_u64_ªm
(
mb
->
idx
, 
STRIPE_SZ
, &
tmp32
);

311 
mem_off£t
 = 
tmp32
;

313 
ªgi⁄
.
bdev
 = 
	`gë_bdev
(
su≥r
, 
off£t
);

314 
ªgi⁄
.
£˘‹
 = 
	`gë_£˘‹
(
su≥r
, 
£g
->
£g_id
, 
off£t
);

315 
ªgi⁄
.
cou¡
 = 
SRC_SECTORS_PER_PAGE
;

317 
io_ªq
.
˛õ¡
 = 
su≥r
->
io_˛õ¡
;

318 
io_ªq
.
bi_rw
 = 
WRITE
;

319 
io_ªq
.
nŸify
.
‚
 = 
Êush_£gmd_ídio
;

321 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_KMEM
;

322 
io_ªq
.
mem
.
±r
.
addr
 = 
ømbuf
->
∑ges
[
mem_off£t
]->
d©a
;

324 
	`dm§c_io
(&
io_ªq
, 1, &
ªgi⁄
, 
NULL
);

326 
	}
}

330 
	$buûd_∑rôy_job
(
dm§c_su≥r
 *
su≥r
,

331 
£gmít_hódî
 *
£g
,

332 
ømbuf„r
 *
ømbuf
,

333 
u32
 
£g_Àngth
,

334 
ˇche_ty≥
,

335 
f‹˚_£Æ
)

337 
fuŒ_£g
 = 0;

339 if(
	`is_ªad_°rùe
(
£g
->
£g_ty≥
))

342 if(
f‹˚_£Æ
 || 
	`√ed_ª‰esh_£gmít
(
su≥r
, 
ˇche_ty≥
, 
£g_Àngth
))

343 
fuŒ_£g
 = 1;

345 
	`gíî©e_∑rôy_d©a
(
su≥r
, 
£g
, 
ømbuf
->
∑ges
, 
fuŒ_£g
, 
ˇche_ty≥
);

346 
	`gíî©e_∑rôy_io
(
su≥r
, 
£g
, 
ømbuf
, 
fuŒ_£g
);

348 if(
f‹˚_£Æ
 || 
£g_Àngth
==
STRIPE_SZ
){

349 
	`ª£t_∑rôy
(
su≥r
, 
£g
, seg->
£g_ty≥
, 1);

351 
	`ª£t_∑rôy
(
su≥r
, 
£g
, seg->
£g_ty≥
, 0);

353 
	}
}

356 
	$Æloc_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

357 
ømbuf„r
 *
ømbuf
, 
u32
 
summ¨y_idx
, 
ˇche_ty≥
, 
fuŒ
){

358 
u32
 
j
;

360 
	`Æloc_mb_summ¨y
(
su≥r
, 
£g
, 
ˇche_ty≥
, 
summ¨y_idx
, 
NULL
);

361 
	`öôülize_mb_summ¨y
(
su≥r
, 
£g
, 
ˇche_ty≥
, 
summ¨y_idx
, 
fuŒ
);

362 
j
 = 0;j < 
NUM_SUMMARY
;j++)

363 
	`bio_∂uggög
(
su≥r
, 
£g
, 
ømbuf
, 
NULL
, 
summ¨y_idx
 + 
j
);

364 
	}
}

366 
u32
 
	$Æloc_skù
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

367 
ømbuf„r
 *
ømbuf
, 
ˇche_ty≥
){

368 
u32
 
dummy_idx
;

375 
dummy_idx
 = 
	`Æloc_√xt_mb
(
su≥r
, 
£g
, 0, 
ˇche_ty≥
, 
NULL
);

376 
	`_Æloc_mb_summ¨y
(
su≥r
, 
£g
, 
ˇche_ty≥
, 
dummy_idx
, 0, 1);

377 
	`bio_∂uggög
(
su≥r
, 
£g
, 
ømbuf
, 
NULL
, 
dummy_idx
);

378  
dummy_idx
;

379 
	}
}

382 
u32
 
	$Æloc_dummy
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

383 
ømbuf„r
 *
ømbuf
, 
ˇche_ty≥
){

384 
u32
 
dummy_idx
;

385 
dummy_idx
 = 
	`Æloc_√xt_mb
(
su≥r
, 
£g
, 0, 
ˇche_ty≥
, 
NULL
);

386 
	`_Æloc_mb_summ¨y
(
su≥r
, 
£g
, 
ˇche_ty≥
, 
dummy_idx
, 0, 1);

387 
	`bio_∂uggög
(
su≥r
, 
£g
, 
ømbuf
, 
NULL
, 
dummy_idx
);

388  
dummy_idx
;

389 
	}
}

391 
	$Æloc_∑πül_summ¨y
(
dm§c_su≥r
 *
su≥r
,

392 
£gmít_hódî
 *
£g
,

393 
ømbuf„r
 *
ømbuf
, 
ˇche_ty≥
){

394 
group_hódî
 *
group
 = 
£g
->group;

395 
i
;

396 
√ed_fuŒ_summ¨y
 = 0;

397 
s32
 
‰ì_blocks
 = 0;

398 
s32
 
summ¨y_blocks
 = 0;

400 
s32
 
num_∑πül_summ¨y
;

401 
s32
 
num_upd©ed_blocks
;

402 
s32
 
summ¨y_byãs
;

403 
u32
 
row_cou¡
 = 0, 
œ°_row_‰ì_cou¡
 = 0;

404 
num_a˘ive_ssd
;

406 
i
 = 0;ò< 
CHUNK_SZ
-
NUM_SUMMARY
;i++){

407 
row_cou¡
 = 
	`ma_gë_row_cou¡
(
su≥r
, 
£g
->
£g_ty≥
, 
i
);

408 
‰ì_blocks
 +(
NUM_SSD
 - 
row_cou¡
);

409 if(
i
==
CHUNK_SZ
-
NUM_SUMMARY
-1)

410 
œ°_row_‰ì_cou¡
 = (
NUM_SSD
 - 
row_cou¡
);

413 
num_upd©ed_blocks
 = 
	`©omic_ªad
(&
ømbuf
->
bios_tŸÆ_cou¡
Ë-átomic_ªad(&ømbuf->
bios_tŸÆ_°¨t
);

414 
summ¨y_byãs
 = (
mëablock_devi˚
)*
num_upd©ed_blocks
+1;

415 
num_∑πül_summ¨y
 = 
summ¨y_byãs
/
SRC_PAGE_SIZE
;

416 if(
summ¨y_byãs
%
SRC_PAGE_SIZE
)

417 
num_∑πül_summ¨y
++;

422 if(
‰ì_blocks
==0){

423 
summ¨y_blocks
 = 0;

424 
√ed_fuŒ_summ¨y
 = 1;

426 if(
‰ì_blocks
-
num_∑πül_summ¨y
<
œ°_row_‰ì_cou¡
){

429 
summ¨y_blocks
 = 
‰ì_blocks
;

430 
√ed_fuŒ_summ¨y
 = 1;

431 }if(
‰ì_blocks
-
num_∑πül_summ¨y
>=
œ°_row_‰ì_cou¡
){

433 
summ¨y_blocks
 = 
num_∑πül_summ¨y
;

434 
√ed_fuŒ_summ¨y
 = 0;

438 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
))

439 
num_a˘ive_ssd
 = 
	`©omic_ªad
(&
group
->
num_u£d_ssd
)-1;

441 
num_a˘ive_ssd
 = 
	`©omic_ªad
(&
group
->
num_u£d_ssd
);

443 if(
‰ì_blocks
<=
œ°_row_‰ì_cou¡
){

445 
summ¨y_blocks
 = 
œ°_row_‰ì_cou¡
;

446 
√ed_fuŒ_summ¨y
 = 1;

448 
u32
 
ªmaöög_‰ì_blocks
 = 
‰ì_blocks
 - 
num_∑πül_summ¨y
;

450 if(
‰ì_blocks
<
num_∑πül_summ¨y
){

451 
summ¨y_blocks
 = 
‰ì_blocks
;

452 
√ed_fuŒ_summ¨y
 = 1;

453 }if(
ªmaöög_‰ì_blocks
>=
œ°_row_‰ì_cou¡
 &&

454 
œ°_row_‰ì_cou¡
 =
num_a˘ive_ssd


457 
summ¨y_blocks
 = 
num_∑πül_summ¨y
;

458 
√ed_fuŒ_summ¨y
 = 0;

459 }if(
ªmaöög_‰ì_blocks
<
œ°_row_‰ì_cou¡
){

462 
summ¨y_blocks
 = 
‰ì_blocks
;

463 
√ed_fuŒ_summ¨y
 = 1;

465 
summ¨y_blocks
 = 
‰ì_blocks
;

466 
√ed_fuŒ_summ¨y
 = 1;

467 
	`¥ötk
("Ö¨tü»summ¨y s≥cü»ˇ£ = %dÜa° fªê%dÇumá˘ivêssd %d \n", 
‰ì_blocks
, 
œ°_row_‰ì_cou¡
, 
num_a˘ive_ssd
);

473 
i
 = 0;ò< 
summ¨y_blocks
;i++){

474 
mëablock
 *
mb
;

475 
u32
 
dummy_idx
;

478 
dummy_idx
 = 
	`Æloc_√xt_mb
(
su≥r
, 
£g
, 0, seg->
£g_ty≥
, 
NULL
);

479 
	`_Æloc_mb_summ¨y
(
su≥r
, 
£g
, 
ˇche_ty≥
, 
dummy_idx
, 0, 1);

480 
	`bio_∂uggög
(
su≥r
, 
£g
, 
ømbuf
, 
NULL
, 
dummy_idx
);

482 
dummy_idx
 = 
	`Æloc_dummy
(
su≥r
, 
£g
, 
ømbuf
, seg->
£g_ty≥
);

484 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
dummy_idx
%
STRIPE_SZ
);

485 
	`£t_bô
(
MB_DUMMY
, &
mb
->
mb_Êags
);

492 if(!
√ed_fuŒ_summ¨y
)

495 
i
 = 0;ò< 
NUM_SSD
;i++){

496 
u32
 
summ¨y_idx
 = 
i
 * 
CHUNK_SZ
;

497 
u32
 
dev_cou¡
;

499 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
Ë&& 
	`is_wrôe_°rùe
(
£g
->
£g_ty≥
)){

500 if(
i
==
	`gë_∑rôy_ssd
(
su≥r
, 
£g
->
£g_id
))

504 
dev_cou¡
 = 
	`ma_gë_cou¡_≥r_dev
(
su≥r
, 
ˇche_ty≥
, 
i
);

505 if(
dev_cou¡
 =
CHUNK_SZ
)

508 
summ¨y_idx
 = 
i
 * 
CHUNK_SZ
 + 
dev_cou¡
;

510 
	`Æloc_summ¨y
(
su≥r
, 
£g
, 
ømbuf
, 
summ¨y_idx
, 
ˇche_ty≥
, 1);

511 
	`©omic_£t
(&
£g
->
summ¨y_°¨t
[
i
], 
dev_cou¡
+
NUM_SUMMARY
);

514 if(
	`ma_gë_cou¡
(
su≥r
, 
£g
->
£g_ty≥
)!
STRIPE_SZ
)

515 
	`¥ötk
(" Nìd **fuŒ summ¨y wrôã¿summ¨y m©ŸÆ = %d, vÆid %d \n", 
	`ma_gë_cou¡
(
su≥r
, 
£g
->
£g_ty≥
), 
STRIPE_SZ
);

518 
	}
}

520 
	$buûd_mëad©a
(
dm§c_su≥r
 *
su≥r
,

521 
£gmít_hódî
 *
£g
,

522 
£g_Àngth
,

523 
ømbuf„r
 *
ømbuf
,

524 
©omic_t
 *
bios_°¨t
,

525 
©omic_t
 *
bios_cou¡
,

526 
f‹˚_£Æ
,

527 
buûd_summ¨y
,

528 
Êush_d©a
)

530 
group_£Æed
;

531 
Êush_comm™d
 = 0;

533 #i‡
SUMMARY_LOCATION
 =
USE_FIRST_SUMMARY


534 if(
	`ã°_bô
(
SEG_PARTIAL
, &
£g
->
Êags
))

535 
	`Æloc_∑πül_summ¨y
(
su≥r
, 
£g
, 
ømbuf
, 
ˇche_ty≥
);

538 
group_£Æed
 = 
	`ch™ge_£g_°©us
(
su≥r
, 
£g
, 
£g_Àngth
, 
f‹˚_£Æ
);

539 if(
buûd_summ¨y
){

540 
	`¥ötk
(" build summary ... \n");

541 
	`BUG_ON
(1);

545 if(
su≥r
->
∑øm
.
Êush_comm™d
==
FLUSH_NONE
){

546 
Êush_comm™d
 = 0;

547 }if(
su≥r
->
∑øm
.
Êush_comm™d
==
FLUSH_FINE
){

548 
Êush_comm™d
 = 1;

549 }if(
su≥r
->
∑øm
.
Êush_comm™d
==
FLUSH_COARSE
){

550 if(
group_£Æed
)

551 
Êush_comm™d
 = 1;

553 
Êush_comm™d
 = 0;

559 if(
Êush_d©a
){

560 
cou¡
;

561 
i
;

563 if(
	`ã°_bô
(
SEG_PARTIAL
, &
£g
->
Êags
))

564 
	`¥ötk
(" P¨tü»Êush d©®...£g = %dÜígth = %d(biÿÀngth = %dË\n", ()
£g
->
£g_id
,

565 ()
	`©omic_ªad
(&
£g
->
Àngth
),

566 ()
	`©omic_ªad
(&
ømbuf
->
bios_tŸÆ_cou¡
));

568 
i
 = 0;ò< 
NUM_SSD
;i++){

569 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
Ë&& 
	`is_wrôe_°rùe
(
£g
->
£g_ty≥
)){

570 if(
i
==
	`gë_∑rôy_ssd
(
su≥r
, 
£g
->
£g_id
))

573 
	`¥ï¨e_chunk_summ¨y
(
su≥r
, 
£g
, 
ømbuf
->
∑ges
, 
i
, seg->
£g_ty≥
);

576 
cou¡
 = 0;

577 
i
 = 0;ò< 
NUM_SSD
;i++){

578 
cou¡
 +
	`Êush_∂ug_¥oc
(
su≥r
, 
£g
, 
ømbuf
, 
bios_°¨t
, 
bios_cou¡
, 1, 
i
, 
Êush_comm™d
);

581 
	}
}

584 
	$öô_√w_£gmít
(
dm§c_su≥r
 *
su≥r
, 
u64
 
√xt_id
, 
ˇche_ty≥
){

585 
£gmít_hódî
 *
√w_£g
;

586 
i
;

588 
√w_£g
 = 
	`gë_£gmít_hódî_by_id
(
su≥r
, 
√xt_id
);

589 
√w_£g
->
£g_ty≥
 = 
ˇche_ty≥
;

590 
√w_£g
->
Êags
 = 0;

592 
	`©omic_£t
(&
√w_£g
->
Àngth
, 0);

593 
	`©omic_£t
(&
√w_£g
->
vÆid_cou¡
, 0);

594 
	`©omic_£t
(&
√w_£g
->
vÆid_˛ón_cou¡
, 0);

595 
	`©omic_£t
(&
√w_£g
->
vÆid_dúty_cou¡
, 0);

596 
	`©omic_£t
(&
√w_£g
->
dummy_cou¡
, 0);

597 
	`©omic_£t
(&
√w_£g
->
dúty_cou¡
, 0);

598 
	`©omic_£t
(&
√w_£g
->
hŸ_cou¡
, 0);

599 
	`©omic_£t
(&
√w_£g
->
hŸ_˛ón_cou¡
, 0);

600 
	`©omic_£t
(&
√w_£g
->
∑π_°¨t
, 0);

601 
	`©omic_£t
(&
√w_£g
->
∑π_Àngth
, 0);

602 
	`©omic_£t
(&
√w_£g
->
bios_cou¡
, 0);

603 
	`©omic_£t
(&
√w_£g
->
num_bufc›y
, 0);

604 
	`©omic_£t
(&
√w_£g
->
num_fûlög
, 0);

605 
	`©omic_£t
(&
√w_£g
->
num_ªad_öÊight
, 0);

606 
	`©omic_£t
(&
√w_£g
->
num_migios
, 0);

607 
i
 = 0;ò< 
MAX_CACHE_DEVS
;i++)

608 
	`©omic_£t
(&
√w_£g
->
summ¨y_°¨t
[
i
], 0);

610 
	`˛ór_bô
(
SEG_CLEAN
, &
√w_£g
->
Êags
);

611 
	`˛ór_bô
(
SEG_USED
, &
√w_£g
->
Êags
);

612 
	`˛ór_bô
(
SEG_SEALED
, &
√w_£g
->
Êags
);

613 
	`˛ór_bô
(
SEG_MIGRATING
, &
√w_£g
->
Êags
);

614 
	`˛ór_bô
(
SEG_PARTIAL
, &
√w_£g
->
Êags
);

615 
	`˛ór_bô
(
SEG_RECOVERY
, &
√w_£g
->
Êags
);

616 
	`˛ór_bô
(
SEG_HIT
, &
√w_£g
->
Êags
);

617 
	`˛ór_bô
(
SEG_LOCK
, &
√w_£g
->
Êags
);

619 
	}
}

621 
ölöe
 
	$√ed_ømbuf_size
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

622 
√ed_size
;

624 if(
	`is_gc_°rùe
(
ˇche_ty≥
)){

625 
√ed_size
 = 
STRIPE_SZ
;

626 }if(
	`is_ªad_°rùe
(
ˇche_ty≥
Ë|| 
	`NO_USE_ERASURE_CODE
(&
su≥r
->
∑øm
)){

627 
√ed_size
 = 
STRIPE_SZ
;

629 
√ed_size
 = 
STRIPE_SZ
;

632  
√ed_size
;

633 
	}
}

635 
ölöe
 
	$ˇn_gë_‰ì_£gmít
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
gc
){

636 
√ed_size
;

637 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

639 
√ed_size
 = 
	`√ed_ømbuf_size
(
su≥r
, 
ˇche_ty≥
);

641 if(!
gc
){

642 if(
	`©omic_ªad
(&
£g_Æloˇt‹
->
£g_Æloc_cou¡
)>=
MIGRATE_LOWWATER
 &&

643 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_cou¡
) &&

644 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_∑ge_cou¡
)>=
√ed_size
)

649 if(
	`©omic_ªad
(&
£g_Æloˇt‹
->
£g_Æloc_cou¡
)>=2&&

650 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_cou¡
) &&

651 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_∑ge_cou¡
)>=
√ed_size
)

661 
	}
}

663 
£gmít_hódî
 *
	$_Æloc_√w_£g
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

664 
group_hódî
 *
group
;

665 
£gmít_hódî
 *
√w_£g
 = 
NULL
;

677 
group
 = 
su≥r
->
cuºít_group
;

678 if(
su≥r
->
cuºít_group
==
NULL
 || (su≥r->cuºít_grou∞&& 
	`©omic_ªad
(&su≥r->cuºít_group->
‰ì_£g_cou¡
)==0)){

680 
group
 = 
	`ªmove_Æloc_group_queue
(
su≥r
);

681 if(
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
group_Æloc_cou¡
)<=1){

682 
	`¥ötk
("WARN: AŒo¯£g fªê%d \n", ()
	`gë_Æloc_cou¡
(
su≥r
));

683 
	`¥ötk
("WARN: AŒo¯grou∞‰ì = %d \n", ()
	`gë_group_Æloc_cou¡
(
su≥r
));

686 if(
group
==
NULL
){

687 
	`¥ötk
("AŒo¯cu∏grou∞‰ì = %d \n", ()
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
group_Æloc_cou¡
));

688 
	`¥ötk
("AŒo¯£g fªê%d \n", ()
	`gë_Æloc_cou¡
(
su≥r
));

689 
	`¥ötk
("AŒo¯grou∞‰ì = %d \n", ()
	`gë_group_Æloc_cou¡
(
su≥r
));

690 
	`BUG_ON
(1);

692 
	`ö£π_group_to_u£d_queue
(
su≥r
, 
group
);

693 
su≥r
->
cuºít_group
 = 
group
;

694 
group
->
cuºít_£g_id
 = group->
group_id
 * 
SEGMENT_GROUP_SIZE
-1;

695 
	`©omic_£t
(&
group
->
£Æed_£g_cou¡
, 0);

696 
	`©omic_£t
(&
group
->
vÆid_cou¡
, 0);

698 if((
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_VERT
 ||

699 
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_HORI
)){

700 
	`group_ª£rve_em±y_chunk
(
su≥r
, 
group
->
group_id
, 
ˇche_ty≥
);

703 if(
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_VERT
 ||

704 
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_HORI
){

708 
	`©omic_£t
(&
group
->
num_u£d_ssd
, 
NUM_SSD
);

709 
	`©omic_£t
(&
group
->
skewed_£gmít
, 1);

712 
group
->
cuºít_£g_id
++;

716 
√w_£g
 = 
	`gë_£gmít_hódî_by_id
(
su≥r
, 
group
->
cuºít_£g_id
);

717 
	`ªmove_Æloc_queue
(
su≥r
, 
√w_£g
);

719 
	`£gmít_group_dec_‰ì_£gs
(
su≥r
, 
√w_£g
);

721  
√w_£g
;

722 
	}
}

724 
u64
 
	$Æloc_√w_£gmít
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
boﬁ
 
u£_migøã
)

726 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

727 
£gmít_hódî
 *
√w_£g
;

728 
ømbuf„r
 *
ømbuf
;

729 
mëablock
 *
mb
;

730 
ª£rved_em±y_blocks
;

731 
i
;

732 
°rùe_size
;

734 
	`BUG_ON
(
	`©omic_ªad
(&
£g_Æloˇt‹
->
£g_Æloc_cou¡
)<1);

736 
√w_£g
 = 
	`_Æloc_√w_£g
(
su≥r
, 
ˇche_ty≥
);

737 
	`ö£π_£g_to_u£d_queue
(
su≥r
, 
√w_£g
);

739 
	`öô_√w_£gmít
(
su≥r
, 
√w_£g
->
£g_id
, 
ˇche_ty≥
);

741 
	`£t_bô
(
SEG_USED
, &
√w_£g
->
Êags
);

742 
su≥r
->
cuºít_£g
[
ˇche_ty≥
] = 
√w_£g
;

744 
°rùe_size
 = 
	`ma_ª£t
(
su≥r
, 
√w_£g
->
£g_id
, 
ˇche_ty≥
);

747 
ømbuf
 = 
	`Æloc_ømbuf„r
(
su≥r
, 
ˇche_ty≥
, 
°rùe_size
);

748 
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
ˇche_ty≥
] = 
ømbuf
;

750 
ª£rved_em±y_blocks
 = 
	`gë_num_em±y_chunks
(
su≥r
, 
ˇche_ty≥
Ë* 
CHUNK_SZ
;

751 
	`©omic_£t
(&
√w_£g
->
Àngth
, 
ª£rved_em±y_blocks
);

752 
	`©omic_£t
(&
√w_£g
->
∑π_Àngth
, 
ª£rved_em±y_blocks
);

754 
i
 = 0;ò< 
STRIPE_SZ
;i++){

755 
mb
 = 
	`gë_mb
(
su≥r
, 
√w_£g
->
£g_id
, 
i
);

756 
mb
->
£˘‹
 = ~0;

757 
mb
->
mb_Êags
 = 0;

760 
	`©omic_öc
(&
su≥r
->
w°©
.
£g_cou¡
[
ˇche_ty≥
]);

762 #i‡
SUMMARY_LOCATION
 =
USE_FIRST_SUMMARY


763 
i
 = 0;ò< 
NUM_SSD
;i++){

764 
u32
 
summ¨y_idx
 = 
i
 * 
CHUNK_SZ
;

766 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
Ë&& 
	`is_wrôe_°rùe
(
√w_£g
->
£g_ty≥
)){

767 if(
i
==
	`gë_∑rôy_ssd
(
su≥r
, 
√w_£g
->
£g_id
))

770 
	`Æloc_summ¨y
(
su≥r
, 
√w_£g
, 
ømbuf
, 
summ¨y_idx
, 
ˇche_ty≥
, 1);

776 
	`©omic_add
(
	`©omic_ªad
(&
√w_£g
->
∑π_Àngth
), &√w_£g->
∑π_°¨t
);

777 
	`©omic_£t
(&
√w_£g
->
∑π_Àngth
, 0);

783  
√w_£g
->
£g_id
;

784 
	}
}

787 
	$waô_Æloc_evít
(
dm§c_su≥r
 *
su≥r
, 
mö
){

788 
	`©omic_ªad
(&
su≥r
->
Æloc_cou¡
)<
mö
){

789 
	`waô_evít_öãºu±ibÀ_timeout
(
su≥r
->
Æloc_waô_queue
,

790 
	`©omic_ªad
(&
su≥r
->
Æloc_cou¡
)>=
mö
, 
	`u£cs_to_jiffõs
(
TIMEOUT_US
));

792 
	}
}

795 
	$waô_ømbuf_evít
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

796 
√ed_size
 = 
	`√ed_ømbuf_size
(
su≥r
, 
ˇche_ty≥
);

798  !
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_cou¡
) ||

799 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_∑ge_cou¡
)<
√ed_size
){

801 
	`waô_evít_öãºu±ibÀ_timeout
(
su≥r
->
£gbuf_mgr
.
waô_queue
,

802 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_cou¡
) &&

803 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_∑ge_cou¡
)>=
√ed_size
,

804 
	`u£cs_to_jiffõs
(
TIMEOUT_US
));

806 
	}
}

808 
	$make_bios_∑rôy
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
ømbuf„r
 *
ømbuf
, 
∑πül
){

809 
u32
 
chunk_off£t
;

810 
mëablock
 *
∑rôy_mb
;

811 
mëablock
 *
dummy_mb
;

812 
Êags
;

815 if(!(
	`is_wrôe_°rùe
(
£g
->
£g_ty≥
Ë&& 
	`USE_ERASURE_CODE
(&
su≥r
->
∑øm
)))

820 
chunk_off£t
 = 0;chunk_off£à< 
CHUNK_SZ
;chunk_offset++){

821 
u32
 
∑rôy_idx
 = 
	`curs‹_∑rôy_°¨t
(
su≥r
, 
£g
->
£g_id
, seg->
£g_ty≥
Ë+ 
chunk_off£t
;

823 
u32
 
row_cou¡
 = 
	`ma_gë_row_cou¡
(
su≥r
, 
£g
->
£g_ty≥
, 
∑rôy_idx
 % 
CHUNK_SZ
);

825 
∑rôy_mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
∑rôy_idx
);

827 if(!
	`ã°_bô
(
MB_PARITY_NEED
, &
∑rôy_mb
->
mb_Êags
))

829 if(
	`ã°_bô
(
MB_PARITY_WRITTEN
, &
∑rôy_mb
->
mb_Êags
))

831 if(
row_cou¡
==1)

835 if(
row_cou¡
 < 
NUM_SSD
){

836 
u32
 
dummy_idx
;

838 if(
chunk_off£t
 >
CHUNK_SZ
-
NUM_SUMMARY
)

839 
	`¥ötk
(" ** Partial segment, Invalid ... seg = %dÖarity offset = %d....row count = %d,Öartial = %d \n",

840 ()
£g
->
£g_id
,

841 
chunk_off£t
, 
row_cou¡
, 
∑πül
);

843 if(
row_cou¡
 + 1 >
NUM_SSD
){

844 if(
su≥r
->
∑øm
.
Æig√d_io_dummy
==
ALIGNED_IO_DUMMY
){

846 
dummy_idx
 = 
	`Æloc_dummy
(
su≥r
, 
£g
, 
ømbuf
, seg->
£g_ty≥
);

847 
dummy_mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
dummy_idx
%
STRIPE_SZ
);

848 
	`£t_bô
(
MB_DUMMY
, &
dummy_mb
->
mb_Êags
);

851 
dummy_idx
 = 
	`Æloc_skù
(
su≥r
, 
£g
, 
ømbuf
, seg->
£g_ty≥
);

852 
dummy_mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
dummy_idx
%
STRIPE_SZ
);

853 
	`£t_bô
(
MB_SKIP
, &
dummy_mb
->
mb_Êags
);

857 
dummy_idx
 = 
	`Æloc_dummy
(
su≥r
, 
£g
, 
ømbuf
, seg->
£g_ty≥
);

858 
	`˛ór_bô
(
MB_PARITY_NEED
, &
∑rôy_mb
->
mb_Êags
);

859 
dummy_mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
dummy_idx
%
STRIPE_SZ
);

860 
	`£t_bô
(
MB_DUMMY
, &
dummy_mb
->
mb_Êags
);

862 
row_cou¡
 = 
	`ma_gë_row_cou¡
(
su≥r
, 
£g
->
£g_ty≥
, 
∑rôy_idx
 % 
CHUNK_SZ
);

867 if(
row_cou¡
 =
NUM_SSD
){

869 
	`bio_∂uggög
(
su≥r
, 
£g
, 
ømbuf
, 
NULL
, 
∑rôy_idx
);

871 
	`lock£g
(
£g
, 
Êags
);

872 
	`˛ór_bô
(
MB_DIRTY
, &
∑rôy_mb
->
mb_Êags
);

873 
	`˛ór_bô
(
MB_VALID
, &
∑rôy_mb
->
mb_Êags
);

874 
	`£t_bô
(
MB_PARITY
, &
∑rôy_mb
->
mb_Êags
);

876 if(
	`ã°_bô
(
MB_PARITY_NEED
, &
∑rôy_mb
->
mb_Êags
)){

877 
	`£t_bô
(
MB_PARITY_WRITTEN
, &
∑rôy_mb
->
mb_Êags
);

879 
	`u∆ock£g
(
£g
, 
Êags
);

881 if(
	`ã°_bô
(
MB_PARITY_WRITTEN
, &
∑rôy_mb
->
mb_Êags
)){

882 
	`©omic_öc
(&
£g
->
vÆid_cou¡
);

883 
	`©omic_öc
(&
£g
->
group
->
vÆid_cou¡
);

884 
	`©omic_öc
(&
£g
->
dúty_cou¡
);

885 
	`©omic_öc
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
);

886 if(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
Ë> 
STRIPE_SZ
){

887 
	`¥ötk
("WARN: segid = %d,Ö¨ôy x‹ d©®vÆid cou¡ = %d \n", ()
£g
->
£g_id
, 
	`©omic_ªad
(&£g->
vÆid_cou¡
));

896 
§c_cou¡
 = 0;

897 *
§cs
[
MAX_CACHE_DEVS
];

898 *
d°
 = 
NULL
;

899 
cur_ssd
 = 
	`curs‹_d©a_°¨t_ssd
(
su≥r
, 
£g
->
£g_id
, 
WCBUF
);

900 
u32
 
øm_off£t
;

902 
§c_cou¡
 = 0;§c_cou¡ < 
row_cou¡
-1; src_count++){

903 
øm_off£t
 = 
chunk_off£t
 + (
cur_ssd
 * 
CHUNK_SZ
);

904 
§cs
[
§c_cou¡
] = 
	`∑ge_addªss
(
ømbuf
->
∑ges
[
øm_off£t
]->
∂
->
∑ge
);

905 
cur_ssd
 = (cur_ssd + 1Ë% 
NUM_SSD
;

907 
øm_off£t
 = 
chunk_off£t
 + (
cur_ssd
 * 
CHUNK_SZ
);

908 
d°
 = 
	`∑ge_addªss
(
ømbuf
->
∑ges
[
øm_off£t
]->
∂
->
∑ge
);

911 
	`mem£t
(
d°
, 0xFF, 
SRC_PAGE_SIZE
);

912 
	`run_x‹
(
§cs
, 
d°
, 
§c_cou¡
, 
SRC_PAGE_SIZE
);

915 
	}
}

917 
	$make_bios_ve˘‹
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
ømbuf„r
 *
ømbuf
,

918 
©omic_t
 *
bios_°¨t
,átomic_à*
bios_cou¡
){

919 
u32
 
devno
;

921 
devno
 = 0;devnÿ< 
NUM_SSD
;devno++){

922 
u32
 
cou¡
 = 
	`©omic_ªad
(&
ømbuf
->
bios_cou¡
[
devno
])

923 - 
	`©omic_ªad
(&
ømbuf
->
bios_°¨t
[
devno
]);

926 
	`©omic_£t
(&
bios_cou¡
[
devno
], 
	`©omic_ªad
(&
ømbuf
->bios_count[devno]));

927 
	`©omic_£t
(&
bios_°¨t
[
devno
], 
	`©omic_ªad
(&
ømbuf
->bios_start[devno]));

929 
	`©omic_£t
(&
ømbuf
->
bios_°¨t
[
devno
], 
	`©omic_ªad
(&ømbuf->
bios_cou¡
[devno]));

930 
	`©omic_add
(
cou¡
, &
ømbuf
->
bios_tŸÆ_°¨t
);

932 
	}
}

934 
	$Êush_∑πül_mëa
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
)

936 
£gmít_hódî
 *
£g
;

937 
ømbuf„r
 *
ømbuf
;

938 
boﬁ
 
√ed_Êush
 = 
Ál£
;

939 
f
;

940 
u32
 
Àngth
;

941 
u32
 
£g_Àngth
;

942 
©omic_t
 
bios_°¨t
[
MAX_CACHE_DEVS
];

943 
©omic_t
 
bios_cou¡
[
MAX_CACHE_DEVS
];

944 
u64
 
globÆ_£g_£quí˚
;

946 
ªt
 = 0;

948 
	`LOCK
(
su≥r
, 
f
);

950 
£g
 = 
su≥r
->
cuºít_£g
[
ˇche_ty≥
];

952 
ømbuf
 = 
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
ˇche_ty≥
];

953 if(!
ømbuf
)

954 
No_Rambuf
;

965 
Àngth
 = 
	`©omic_ªad
(&
ømbuf
->
bios_tŸÆ_cou¡
Ë-átomic_ªad(&ømbuf->
bios_tŸÆ_°¨t
);

967 if(
Àngth
 || ((
	`©omic_ªad
(&
£g
->
∑π_Àngth
)) &&

968 
	`©omic_ªad
(&
£g
->
Àngth
)<
STRIPE_SZ
 &&

969 !
	`ã°_bô
(
SEG_SEALED
, &
£g
->
Êags
)))

974 
√ed_Êush
 = 
åue
;

975 
globÆ_£g_£quí˚
 = 
	`©omic64_öc_ªtu∫
(&
su≥r
->
Êush_mgr
.global_seg_sequence);

977 
ªt
 = 
	`Æloc_∑πül_summ¨y
(
su≥r
, 
£g
, 
ømbuf
, 
ˇche_ty≥
);

978 if(
ªt
 < 0)

979 
No_Rambuf
;

981 
	`make_bios_∑rôy
(
su≥r
, 
£g
, 
ømbuf
, 1);

987 
	`©omic_öc
(&
su≥r
->
w°©
.
∑πül_wrôe_cou¡
);

990 
	`make_bios_ve˘‹
(
su≥r
, 
£g
, 
ømbuf
, 
bios_°¨t
, 
bios_cou¡
);

991 
£g_Àngth
 = 
	`©omic_ªad
(&
£g
->
Àngth
);

993 
No_Rambuf
:

994 
	`UNLOCK
(
su≥r
, 
f
);

996 if(
ªt
<0){

997 
	`¥ötk
("áŒo¯∑πü»summ¨yÉº‹ = %d \n", 
ªt
);

998 
	`BUG_ON
(1);

1001 if(
√ed_Êush
){

1003 if(
su≥r
->
∑øm
.
bio_∂uggög
){

1004 
	`make_Êush_övoke_job
(
su≥r
, 
£g
, 
ømbuf
, 
£g_Àngth
, 
bios_°¨t
, 
bios_cou¡
,

1005 
ˇche_ty≥
, 0, 0, 1, 
globÆ_£g_£quí˚
);

1007 
	`make_Êush_övoke_job
(
su≥r
, 
£g
, 
ømbuf
, 
£g_Àngth
, 
bios_°¨t
, 
bios_cou¡
,

1008 
ˇche_ty≥
, 0, 1, 0, 
globÆ_£g_£quí˚
);

1011 
≥ndög_m™agî
 *
≥ndög_mgr
 = &
su≥r
->pending_mgr;

1012 
bio_li°
 
loˇl_li°
;

1013 
	`bio_li°_öô
(&
loˇl_li°
);

1014 
	`•ö_lock_úqßve
(&
≥ndög_mgr
->
b¨rõr_lock
, 
f
);

1015 
	`bio_li°_mîge
(&
loˇl_li°
, &
≥ndög_mgr
->
b¨rõr_ios
);

1016 
	`bio_li°_öô
(&
≥ndög_mgr
->
b¨rõr_ios
);

1017 
	`©omic_£t
(&
≥ndög_mgr
->
b¨rõr_cou¡
, 0);

1018 
	`•ö_u∆ock_úqª°‹e
(&
≥ndög_mgr
->
b¨rõr_lock
, 
f
);

1020 
	`issue_de„ºed_bio
(
su≥r
, &
loˇl_li°
);

1022 
	}
}

1026 
ölöe
 
	$öc_num_dúty_blocks
(
dm§c_su≥r
 *
su≥r
)

1028 
	`©omic64_öc
(&
su≥r
->
ˇche_°©
.
num_dúty_blocks
);

1029 
	}
}

1031 
ölöe
 
	$dec_num_dúty_blocks
(
dm§c_su≥r
 *
su≥r
)

1033 
	`©omic64_dec
(&
su≥r
->
ˇche_°©
.
num_dúty_blocks
);

1034 
	}
}

1036 
	$˛ónup_mb_if_dúty
(
dm§c_su≥r
 *
su≥r
,

1037 
£gmít_hódî
 *
£g
,

1038 
mëablock
 *
mb
)

1040 
Êags
;

1041 
boﬁ
 
b
 = 
Ál£
;

1043 
	`lock£g
(
£g
, 
Êags
);

1044 i‡(
	`ã°_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
)) {

1046 
b
 = 
åue
;

1049 if(
	`is_ªad_°rùe
(
£g
->
£g_ty≥
))

1050 
b
 = 
åue
;

1052 
	`u∆ock£g
(
£g
, 
Êags
);

1054 i‡(
b
)

1055 
	`dec_num_dúty_blocks
(
su≥r
);

1056 
	}
}

1058 
u8
 
	$©omic_ªad_mb_vÆid√ss
(
£gmít_hódî
 *
£g
, 
mëablock
 *
mb
)

1060  
	`ã°_bô
(
MB_VALID
, &
mb
->
mb_Êags
);

1061 
	}
}

1063 
u8
 
	$©omic_ªad_mb_dútöess
(
£gmít_hódî
 *
£g
, 
mëablock
 *
mb
)

1065  
	`ã°_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
);

1066 
	}
}

1069 
ölöe
 
	$bio_ªm≠
(
bio
 *bio, 
dm_dev
 *
dev
, 
£˘‹_t
 
£˘‹
)

1071 
bio
->
bi_bdev
 = 
dev
->
bdev
;

1072 
bio
->
bi_£˘‹
 = 
£˘‹
;

1073 
	}
}

1075 
ölöe
 
£˘‹_t
 
	$ˇlc_ˇche_Æignmít
(
dm§c_su≥r
 *
su≥r
,

1076 
£˘‹_t
 
bio_£˘‹
)

1078  
	`div_u64
(
bio_£˘‹
, 
SRC_SECTORS_PER_PAGE
) * (SRC_SECTORS_PER_PAGE);

1079 
	}
}

1081 
	$övÆid©e_¥evious_ˇche
(
dm§c_su≥r
 *
su≥r
,

1082 
£gmít_hódî
 *
£g
,

1083 
mëablock
 *
ﬁd_mb
)

1086 
	`˛ónup_mb_if_dúty
(
su≥r
, 
£g
, 
ﬁd_mb
);

1088 
	`ht_dñ
(
su≥r
, 
ﬁd_mb
);

1090 
	`©omic_dec
(&
£g
->
vÆid_cou¡
);

1091 
	`©omic_dec
(&
£g
->
group
->
vÆid_cou¡
);

1093 if(
	`ã°_bô
(
MB_DIRTY
, &
ﬁd_mb
->
mb_Êags
))

1094 
	`©omic_dec
(&
£g
->
vÆid_dúty_cou¡
);

1096 
	`©omic_dec
(&
£g
->
vÆid_˛ón_cou¡
);

1098 
	`©omic_dec
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
);

1099 
	`˛ór_bô
(
MB_VALID
, &
ﬁd_mb
->
mb_Êags
);

1102 if(
	`ã°_bô
(
MB_BROKEN
, &
ﬁd_mb
->
mb_Êags
)){

1103 
	`˛ór_bô
(
MB_BROKEN
, &
ﬁd_mb
->
mb_Êags
);

1104 
	`©omic_dec
(&
su≥r
->
ªcovîy_mgr
.
brokí_block_cou¡
);

1107 if(
	`ã°_bô
(
MB_HIT
, &
ﬁd_mb
->
mb_Êags
)){

1108 
	`˛ór_bô
(
MB_HIT
, &
ﬁd_mb
->
mb_Êags
);

1109 
	`©omic_dec
(&
£g
->
hŸ_cou¡
);

1111 if(!
	`ã°_bô
(
MB_DIRTY
, &
ﬁd_mb
->
mb_Êags
))

1112 
	`©omic_dec
(&
£g
->
hŸ_˛ón_cou¡
);

1116 if(
	`ã°_bô
(
SEG_SEALED
, &
£g
->
Êags
)){

1117 if(
	`gë_d©a_vÆid_cou¡
(
su≥r
, 
£g
)<0){

1118 
	`¥ötk
(" ** InvÆid vÆid cou¡ seg = %d vÆid = %d \n", ()
£g
->
£g_id
,

1119 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
));

1122 if(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)-
	`gë_mëad©a_cou¡
(
su≥r
, seg->
£g_ty≥
)!=

1123 
	`ˇlc_vÆid_cou¡
(
su≥r
, 
£g
, 1)){

1124 
	`¥ötk
(" invalid valid count = %d %d, dummy = %d \n",

1125 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
)-
	`gë_mëad©a_cou¡
(
su≥r
, seg->
£g_ty≥
),

1126 
	`ˇlc_vÆid_cou¡
(
su≥r
, 
£g
, 1),

1127 
	`©omic_ªad
(&
£g
->
dummy_cou¡
));

1131 
	}
}

1134 
ölöe
 
	$wake_ªad_ˇchög_w‹kî
(
dm§c_su≥r
 *
su≥r
){

1135 
	`queue_w‹k
(
su≥r
->
ªad_miss_mgr
.
wq
, &su≥r->ªad_miss_mgr.
w‹k
);

1136 
	}
}

1138 
	$öô_ªad_ˇchög_job_li°
(
dm§c_su≥r
 *
su≥r
){

1139 
ªad_ˇchög_job_li°
 *
li°
;

1141 
li°
 = &
su≥r
->
ªad_miss_mgr
.
queue
;

1142 
	`©omic_£t
(&
li°
->
rm_c›y_cou¡
, 0);

1143 
	`•ö_lock_öô
(&
li°
->
rm_•ölock
);

1144 
	`INIT_LIST_HEAD
(&
li°
->
rm_c›y_hód
);

1145 
	}
}

1148 
	$m¨k_∑rôy_dúty
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
,

1149 
£gmít_hódî
 *
£g
, 
u32
 
idx
){

1151 
mëablock
 *
mb
;

1152 
∑rôy_°¨t
;

1153 
∑rôy_off£t
;

1154 
u32
 
∑rôy_idx
;

1156 if(
	`is_ªad_°rùe
(
ˇche_ty≥
))

1159 if(
	`NO_USE_ERASURE_CODE
(&
su≥r
->
∑øm
))

1162 
∑rôy_°¨t
 = 
	`curs‹_∑rôy_°¨t
(
su≥r
, 
£g
->
£g_id
, 
ˇche_ty≥
);

1163 
∑rôy_off£t
 = 
idx
%(
CHUNK_SZ
);

1165 
∑rôy_idx
 = 
∑rôy_°¨t
 + 
∑rôy_off£t
;

1166 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
∑rôy_idx
);

1167 
	`£t_bô
(
MB_PARITY_NEED
, &
mb
->
mb_Êags
);

1168 
	`˛ór_bô
(
MB_VALID
, &
mb
->
mb_Êags
);

1169 
	`˛ór_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
);

1172 if(
	`USE_ERASURE_RAID6
(&
su≥r
->
∑øm
)){

1173 
∑rôy_idx
 +
CHUNK_SZ
;

1174 
∑rôy_idx
 %
STRIPE_SZ
;

1175 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
∑rôy_idx
);

1176 
	`£t_bô
(
MB_PARITY_NEED
, &
mb
->
mb_Êags
);

1178 
	}
}

1180 
	$ª£t_∑rôy
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
ˇche_ty≥
, 
˛ór_wrôãn
){

1181 
Êags
;

1182 
∑rôy_size
;

1183 
∑rôy_°¨t
;

1184 
i
;

1186 if(
	`is_ªad_°rùe
(
ˇche_ty≥
))

1189 if(
	`NO_USE_ERASURE_CODE
(&
su≥r
->
∑øm
))

1192 
∑rôy_size
 = 
CHUNK_SZ
;

1193 
∑rôy_°¨t
 = 
	`curs‹_∑rôy_°¨t
(
su≥r
, 
£g
->
£g_id
, 
ˇche_ty≥
);

1195 
	`lock£g
(
£g
, 
Êags
);

1197 
i
 = 0;ò<
∑rôy_size
;i++){

1198 
u32
 
off£t
 = 
∑rôy_°¨t
 + 
i
;

1199 
mëablock
 *
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
off£t
);

1201 
	`˛ór_bô
(
MB_PARITY_NEED
, &
mb
->
mb_Êags
);

1203 if(
˛ór_wrôãn
 && 
	`ã°_bô
(
MB_PARITY_WRITTEN
, &
mb
->
mb_Êags
)){

1204 
	`˛ór_bô
(
MB_PARITY_WRITTEN
, &
mb
->
mb_Êags
);

1208 if(
	`USE_ERASURE_RAID6
(&
su≥r
->
∑øm
)){

1209 
i
 = 0;ò<
∑rôy_size
;i++){

1210 
u32
 
off£t
 = (
∑rôy_°¨t
 + 
CHUNK_SZ
 + 
i
Ë% 
STRIPE_SZ
;

1211 
mëablock
 *
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
off£t
);

1213 
	`˛ór_bô
(
MB_PARITY_NEED
, &
mb
->
mb_Êags
);

1215 if(
˛ór_wrôãn
 && 
	`ã°_bô
(
MB_PARITY_WRITTEN
, &
mb
->
mb_Êags
)){

1216 
	`˛ór_bô
(
MB_PARITY_WRITTEN
, &
mb
->
mb_Êags
);

1221 
	`u∆ock£g
(
£g
, 
Êags
);

1223 
	}
}

1231 
	$run_x‹
(**
∑ges
, *
de°
, 
§c_˙t
, 
ssize_t
 
Àn
)

1233 
§c_off
 = 0;

1234 
x‹_§c_˙t
 = 0;

1236 
§c_˙t
 > 0) {

1237 
x‹_§c_˙t
 = 
	`mö
(
§c_˙t
, 
MAX_XOR_BLOCKS
);

1238 
	`x‹_blocks
(
x‹_§c_˙t
, 
Àn
, 
de°
, 
∑ges
 + 
§c_off
);

1240 
§c_˙t
 -
x‹_§c_˙t
;

1241 
§c_off
 +
x‹_§c_˙t
;

1243 
	}
}

1246 
	$vîify_x‹
(
dm§c_su≥r
 *
su≥r
, 
ømbuf_∑ge
 **
∑ges
, 
i
, *
ãmp
){

1247 *
§cs
[
MAX_CACHE_DEVS
];

1248 *
d°
 = 
NULL
;

1249 
§c_cou¡
;

1250 
∑rôy_size
;

1251 
j
;

1253 
∑rôy_size
 = 
CHUNK_SZ
;

1255 
§c_cou¡
 = 0;

1256 
j
 = 0;j < 
NUM_SSD
;j++){

1257 if(
j
==0)

1258 
d°
 = 
∑ges
[
i
 + (
j
 * 
∑rôy_size
)]->
d©a
;

1260 
§cs
[
§c_cou¡
++] = 
∑ges
[
i
 + (
j
 * 
∑rôy_size
)]->
d©a
;

1263 
	`mem£t
(
ãmp
, 0xFF, 
PAGE_SIZE
);

1265 
	`run_x‹
(
§cs
, 
ãmp
, 
§c_cou¡
, 
PAGE_SIZE
);

1266 if(
	`memcmp
(
ãmp
, 
d°
, 
PAGE_SIZE
)){

1267 
	`¥ötk
(" %dÖarity mismatchÑecovered %u original %u\n",

1268 
i
,

1269 
	`¸c32_À
(17, 
ãmp
, 
PAGE_SIZE
),

1270 
	`¸c32_À
(17, 
d°
, 
PAGE_SIZE
)

1273 
	}
}

1277 
	$gíî©e_∑rôy_x‹
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
ømbuf_∑ge
 **
∑ges
, 
fuŒ_£g
, 
ˇche_ty≥
){

1278 
mëablock
 *
mb
;

1279 *
§cs
[
MAX_CACHE_DEVS
];

1281 
Êags
;

1282 *
ãmp
;

1283 *
d°
 = 
NULL
;

1285 
∑rôy_size
;

1286 
∑rôy_°¨t
;

1288 
i
, 
j
;

1290 
§c_cou¡
 = 0;

1291 
∑rôy_ssd
;

1293 
∑rôy_size
 = 
CHUNK_SZ
;

1294 
∑rôy_°¨t
 = 
	`curs‹_∑rôy_°¨t
(
su≥r
, 
£g
->
£g_id
, 
ˇche_ty≥
);

1295 
ãmp
 = (*)
	`gë_zî€d_∑ge
(
GFP_KERNEL
);

1299 
i
 = 0;ò<
∑rôy_size
;i++){

1300 
∑rôy_ssd
 = 
	`gë_∑rôy_ssd
(
su≥r
, 
£g
->
£g_id
);

1301 
§c_cou¡
 = 0;

1302 
d°
 = 
NULL
;

1304 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
∑rôy_°¨t
 + 
i
);

1306 
	`lock£g
(
£g
, 
Êags
);

1307 
	`˛ór_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
);

1308 
	`˛ór_bô
(
MB_VALID
, &
mb
->
mb_Êags
);

1309 
	`£t_bô
(
MB_PARITY
, &
mb
->
mb_Êags
);

1312 if(
	`ã°_bô
(
MB_PARITY_NEED
, &
mb
->
mb_Êags
)){

1313 
	`£t_bô
(
MB_PARITY_WRITTEN
, &
mb
->
mb_Êags
);

1315 
	`u∆ock£g
(
£g
, 
Êags
);

1317 if(
	`ã°_bô
(
MB_PARITY_NEED
, &
mb
->
mb_Êags
)){

1318 
j
 = 0;j < 
NUM_SSD
;j++){

1319 if(
j
 !
∑rôy_ssd
){

1320 
§cs
[
§c_cou¡
++] = 
∑ges
[
i
 + (
j
 * 
∑rôy_size
)]->
d©a
;

1322 
d°
 = 
∑ges
[
i
 + (
j
 * 
∑rôy_size
)]->
d©a
;

1326 
	`mem£t
(
d°
, 0xFF, 
SRC_PAGE_SIZE
);

1327 
	`run_x‹
(
§cs
, 
d°
, 
§c_cou¡
, 
SRC_PAGE_SIZE
);

1329 
	`vîify_x‹
(
su≥r
, 
∑ges
, 
i
 
d°
);

1334 if(
fuŒ_£g
 && 
	`ã°_bô
(
MB_PARITY_WRITTEN
, &
mb
->
mb_Êags
)){

1335 
	`©omic_öc
(&
£g
->
vÆid_cou¡
);

1336 
	`©omic_öc
(&
£g
->
group
->
vÆid_cou¡
);

1337 
	`©omic_öc
(&
£g
->
dúty_cou¡
);

1338 
	`©omic_öc
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
);

1339 
cou¡
 ++;

1340 if(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
Ë> 
STRIPE_SZ
){

1341 
	`¥ötk
(" segid = %d,Ö¨ôy x‹ d©®vÆid cou¡ = %d \n", ()
£g
->
£g_id
, 
	`©omic_ªad
(&£g->
vÆid_cou¡
));

1347 
	`‰ì_∑ge
(()
ãmp
);

1354 
	`BUG_ON
(
	`©omic_ªad
(&
£g
->
Àngth
)>
STRIPE_SZ
);

1355 
	}
}

1357 
	$gíî©e_∑rôy_pq
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
ømbuf_∑ge
 **
∑ges
, 
fuŒ_£g
, 
ˇche_ty≥
){

1358 
∑rôy_size
;

1359 
∑rôy_°¨t
;

1360 
Êags
;

1361 
cou¡
 = 0;

1362 
i
;

1364 
∑rôy_size
 = 
CHUNK_SZ
;

1365 
∑rôy_°¨t
 = 
	`curs‹_∑rôy_°¨t
(
su≥r
, 
£g
->
£g_id
, 
ˇche_ty≥
);

1367 
i
 = 0;ò<
∑rôy_size
;i++){

1368 
u32
 
∑rôy_idx
 = 
∑rôy_°¨t
 + 
i
;

1369 
mëablock
 *
mb
[2];

1370 *
§cs
[
MAX_CACHE_DEVS
];

1371 
§c_cou¡
 = 0;

1372 
∑rôy_ssd
 = 
	`gë_∑rôy_ssd
(
su≥r
, 
£g
->
£g_id
);

1373 
j
;

1375 
mb
[0] = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
∑rôy_idx
);

1376 
mb
[1] = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, (
∑rôy_idx
 + 
CHUNK_SZ
)%
STRIPE_SZ
);

1378 
	`lock£g
(
£g
, 
Êags
);

1379 
j
 =0;j < 2;j++){

1380 
	`˛ór_bô
(
MB_DIRTY
, &
mb
[
j
]->
mb_Êags
);

1381 
	`˛ór_bô
(
MB_VALID
, &
mb
[
j
]->
mb_Êags
);

1382 
	`£t_bô
(
MB_PARITY
, &
mb
[
j
]->
mb_Êags
);

1384 if(
	`ã°_bô
(
MB_PARITY_NEED
, &
mb
[
j
]->
mb_Êags
)){

1385 
	`£t_bô
(
MB_PARITY_WRITTEN
, &
mb
[
j
]->
mb_Êags
);

1388 
	`u∆ock£g
(
£g
, 
Êags
);

1390 if(
	`ã°_bô
(
MB_PARITY_NEED
, &
mb
[0]->
mb_Êags
)){

1391 
j
 = 0;j < 
NUM_SSD
;j++){

1392 
u32
 
off£t
 = 
i
 + (
j
 * 
∑rôy_size
);

1393 if(!
∑ges
[
off£t
]){

1394 
	`¥ötk
("Öage†i†nuŒ ... %d \n", 
off£t
);

1395 
	`BUG_ON
(1);

1398 if(
j
==
∑rôy_ssd
){

1399 
§cs
[
NUM_SSD
-2] = 
∑ges
[
off£t
]->
d©a
;

1400 
	`mem£t
(
§cs
[
NUM_SSD
-2], 0xEE, 
SRC_PAGE_SIZE
);

1401 }if(
j
==(
∑rôy_ssd
+1)%
NUM_SSD
){

1402 
§cs
[
NUM_SSD
-1] = 
∑ges
[
off£t
]->
d©a
;

1403 
	`mem£t
(
§cs
[
NUM_SSD
-1], 0xEE, 
SRC_PAGE_SIZE
);

1405 
§cs
[
§c_cou¡
++] = 
∑ges
[
off£t
]->
d©a
;

1409 
øid6_ˇŒ
.
	`gí_syndrome
(
NUM_SSD
, 
SRC_PAGE_SIZE
, 
§cs
);

1412 if(
fuŒ_£g
 && 
	`ã°_bô
(
MB_PARITY_WRITTEN
, &
mb
[0]->
mb_Êags
)){

1413 
j
 =0;j < 2;j++){

1414 
	`©omic_öc
(&
£g
->
Àngth
);

1415 
	`©omic_öc
(&
£g
->
∑π_Àngth
);

1416 
	`©omic_öc
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
);

1417 
cou¡
 ++;

1422 
	`BUG_ON
(
	`©omic_ªad
(&
£g
->
Àngth
)>
STRIPE_SZ
);

1427 
	}
}

1431 
	$gíî©e_∑rôy_d©a
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

1432 
ømbuf_∑ge
 **
∑ges
, 
fuŒ_£g
, 
ˇche_ty≥
){

1434 if(
	`is_ªad_°rùe
(
ˇche_ty≥
))

1437 if(
	`NO_USE_ERASURE_CODE
(&
su≥r
->
∑øm
))

1440 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
)){

1441 
	`gíî©e_∑rôy_x‹
(
su≥r
, 
£g
, 
∑ges
, 
fuŒ_£g
, 
ˇche_ty≥
);

1443 
	`gíî©e_∑rôy_pq
(
su≥r
, 
£g
, 
∑ges
, 
fuŒ_£g
, 
ˇche_ty≥
);

1445 
	}
}

1449 #i‡
SUMMARY_LOCATION
 =
USE_FIRST_SUMMARY


1450 
ölöe
 
u32
 
	$gë_summ¨y_off£t
(
dm§c_su≥r
 *
su≥r
, 
u32
 
ssd_id
){

1451  (
ssd_id
Ë* 
CHUNK_SZ
;

1452 
	}
}

1454 
ölöe
 
boﬁ
 
	$chunk_summ¨y_ønge
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
){

1455 
u32
 
off£t
 = (
idx
Ë% 
CHUNK_SZ
;

1456 if(
off£t
 >0 && (off£tË< 
NUM_SUMMARY
){

1457  
åue
;

1459  
Ál£
;

1460 
	}
}

1462 
ölöe
 
boﬁ
 
	$√ed_chunk_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
){

1463 
u32
 
off£t
 = (
idx
Ë% 
CHUNK_SZ
;

1464 if((
off£t
Ë=(
NUM_SUMMARY
)){

1465  
åue
;

1467  
Ál£
;

1468 
	}
}

1470 
ölöe
 
u32
 
	$d©a_to_summ¨y_idx
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
){

1471  (
idx
%
STRIPE_SZ
)/
CHUNK_SZ
*CHUNK_SZ;

1472 
	}
}

1476 #i‡
SUMMARY_LOCATION
 =
USE_LAST_SUMMARY


1477 
ölöe
 
u32
 
	$gë_summ¨y_off£t
(
dm§c_su≥r
 *
su≥r
, 
u32
 
ssd_id
){

1478  (
ssd_id
 + 1Ë* 
CHUNK_SZ
 - 
NUM_SUMMARY
;

1479 
	}
}

1481 
ölöe
 
boﬁ
 
	$chunk_summ¨y_ønge
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
){

1482 
u32
 
off£t
 = (
idx
Ë% 
CHUNK_SZ
;

1483 if((
off£t
+1Ë>
CHUNK_SZ
-(
NUM_SUMMARY
-1) && (offset+1) <= CHUNK_SZ){

1484  
åue
;

1486  
Ál£
;

1487 
	}
}

1489 
ölöe
 
boﬁ
 
	$√ed_chunk_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
){

1490 
u32
 
off£t
 = (
idx
Ë% 
CHUNK_SZ
;

1491 if((
off£t
+1Ë=(
CHUNK_SZ
)){

1492  
åue
;

1494  
Ál£
;

1495 
	}
}

1496 
ölöe
 
u32
 
	$d©a_to_summ¨y_idx
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
){

1497  (
idx
%
STRIPE_SZ
Ë- (idx%
CHUNK_SZ
Ë+ (CHUNK_SZ-
NUM_SUMMARY
);

1498 
	}
}

1503 
ölöe
 
	$gë_∑rôy_size
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

1505 if(
	`NO_USE_ERASURE_CODE
(&
su≥r
->
∑øm
))

1507 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
))

1508  
CHUNK_SZ
;

1510  
CHUNK_SZ
 * 2;

1511 
	}
}

1514 
ölöe
 
	$£t_max_Àngth
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

1515 
u32
 
thªshﬁd
;

1517 
£gmít_hódî
 *
£g
 = 
su≥r
->
cuºít_£g
[
ˇche_ty≥
];

1519 if(
SUMMARY_SCHEME
==
SUMMARY_PER_CHUNK
)

1520 
thªshﬁd
 = 
STRIPE_SZ
;

1522 
thªshﬁd
 = 
STRIPE_SZ
 - 
NUM_SUMMARY
;

1524 if(
	`is_ªad_°rùe
(
ˇche_ty≥
)){

1525 
	`©omic_£t
(&
£g
->
Àngth
, 
thªshﬁd
);

1526 
	`©omic_£t
(&
£g
->
∑π_Àngth
, 
thªshﬁd
);

1530 
	`©omic_£t
(&
£g
->
Àngth
, 
thªshﬁd
);

1531 
	`©omic_£t
(&
£g
->
∑π_Àngth
, 
thªshﬁd
);

1533 
	}
}

1535 
ölöe
 
	$£t_max_cou¡
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

1536 
u32
 
thªshﬁd
;

1539 if(
SUMMARY_SCHEME
==
SUMMARY_PER_CHUNK
)

1540 
thªshﬁd
 = 
STRIPE_SZ
;

1542 
thªshﬁd
 = 
STRIPE_SZ
-
NUM_SUMMARY
;

1544 if(
	`is_ªad_°rùe
(
ˇche_ty≥
)){

1545 
	`ma_£t_cou¡
(
su≥r
, 
ˇche_ty≥
, 
thªshﬁd
);

1547 
	`ma_£t_cou¡
(
su≥r
, 
ˇche_ty≥
, 
thªshﬁd
);

1550 
	}
}

1553 
ölöe
 
boﬁ
 
	$√ed_ª‰esh_£gmít
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
cou¡
){

1554 
boﬁ
 
ª‰esh
 = 
Ál£
;

1555 
u32
 
thªshﬁd
 = 
STRIPE_SZ
;

1557 if(
	`is_ªad_°rùe
(
ˇche_ty≥
)){

1558 if(
cou¡
>=
thªshﬁd
)

1559 
ª‰esh
 = 
åue
;

1561 if(
cou¡
>=
thªshﬁd
)

1562 
ª‰esh
 = 
åue
;

1565  
ª‰esh
;

1566 
	}
}

1569 
ölöe
 
	$gë_°¨t_ssd
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
){

1570 
ssd
;

1571 if(
su≥r
->
∑øm
->
∑rôy_Æloˇti⁄
==
PARITY_ALLOC_FIXED
){

1572 
ssd
 = 0;

1574 
ssd
 = 
£g_id
 % 
NR_SSD
;

1577  
ssd
;

1578 
	}
}

1582 
ölöe
 
	$gë_∑rôy_ssd
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
){

1583 
£˘‹_t
 
£˘‹
;

1584 
∑rôy_ssd
;

1585 
ãmp
;

1587 if(
	`NO_USE_ERASURE_CODE
(&
su≥r
->
∑øm
))

1590 if(
su≥r
->
∑øm
.
∑rôy_Æloˇti⁄
==
PARITY_ALLOC_FIXED
)

1591 
£˘‹
 = (
£g_id
 * 
STRIPE_SZ
 - 
CHUNK_SZ
Ë<< 
SRC_SECTORS_PER_PAGE_SHIFT
;

1593 
£˘‹
 = (
£g_id
 * 
STRIPE_SZ
Ë<< 
SRC_SECTORS_PER_PAGE_SHIFT
;

1595 
	`øid5_ˇlc_£˘‹
(&
su≥r
->
øid_c⁄f
, 
£˘‹
, 0, &
ãmp
, &
∑rôy_ssd
, 
NULL
);

1597  
∑rôy_ssd
 % 
NUM_SSD
;

1598 
	}
}

1600 
ölöe
 
	$gë_∑rôyq_ssd
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
){

1601 
£˘‹_t
 
£˘‹
;

1602 
∑rôy_ssd
;

1603 
ãmp
;

1605 if(!
	`USE_ERASURE_RAID6
(&
su≥r
->
∑øm
))

1608 
£˘‹
 = (
£g_id
 * 
STRIPE_SZ
Ë<< 
SRC_SECTORS_PER_PAGE_SHIFT
;

1609 
	`øid5_ˇlc_£˘‹
(&
su≥r
->
øid_c⁄f
, 
£˘‹
, 0, &
ãmp
, 
NULL
, &
∑rôy_ssd
);

1611  
∑rôy_ssd
 % 
NUM_SSD
;

1612 
	}
}

1614 
ölöe
 
	$curs‹_∑rôy_°¨t
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
){

1615 
∑rôy_ssd
 = 
	`gë_∑rôy_ssd
(
su≥r
, 
£g_id
);

1616  (
∑rôy_ssd
 * 
CHUNK_SZ
Ë% 
STRIPE_SZ
;

1617 
	}
}

1619 
ölöe
 
	$curs‹_d©a_°¨t_ssd
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
){

1620 
∑rôy_ssd
 = 
	`gë_∑rôy_ssd
(
su≥r
, 
£g_id
);

1621  (
∑rôy_ssd
 + 1 ) % 
NUM_SSD
;

1622 
	}
}

1625 
ölöe
 
	$curs‹_summ¨y_off£t
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
){

1626 
d©a_°¨t
 = 
	`curs‹_°¨t
(
su≥r
, 
£g_id
);

1628 if(
	`is_ªad_°rùe
(
ˇche_ty≥
Ë|| 
	`NO_USE_ERASURE_CODE
(&
su≥r
->
∑øm
)){

1629  (
d©a_°¨t
 + 
CHUNK_SZ
 * 
NUM_SSD
 - 
NUM_SUMMARY
Ë% 
STRIPE_SZ
;

1631  (
d©a_°¨t
 + 
CHUNK_SZ
 * 
NUM_DATA_SSD
 - 
NUM_SUMMARY
Ë% 
STRIPE_SZ
;

1633 
	}
}

1637 
ölöe
 
	$curs‹_öô
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
){

1638 if(
su≥r
->
∑øm
->
d©a_Æloˇti⁄
==
DATA_ALLOC_VERT
){

1639  
	`curs‹_°¨t
(
su≥r
, 
£g_id
) - 1;

1642 if(
su≥r
->
∑øm
->
∑rôy_Æloˇti⁄
==
PARITY_ALLOC_FIXED
)

1643 
su≥r
->
cﬁ
[
ˇche_ty≥
] = 
NR_SSD
-1;

1645 
su≥r
->
cﬁ
[
ˇche_ty≥
] = ((
£g_id
%
NR_SSD
) + (NR_SSD-1)) % NR_SSD;

1647 
su≥r
->
row
[
ˇche_ty≥
] = -1;

1649  
	`curs‹_°¨t
(
su≥r
, 
£g_id
) - 1;

1651 
	}
}

1654 
	$_Æloc_mb_summ¨y
(
dm§c_su≥r
 *
su≥r
,
£gmít_hódî
 *
£g
, 
ˇche_ty≥
, 
u32
 
mb_idx
, 
fuŒ
, 
dummy
){

1655 
mëablock
 *
√w_mb
;

1656 
u32
 
tmp32
;

1658 
tmp32
 = 
mb_idx
%
STRIPE_SZ
;

1659 
√w_mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
tmp32
);

1660 
√w_mb
->
£˘‹
 = ~0;

1662 if(
	`ã°_bô
(
MB_VALID
, &
√w_mb
->
mb_Êags
))

1663 
	`¥ötk
(" summ¨y block i†d©®block ..Åy≥ = %d\n", 
£g
->
£g_ty≥
);

1665 
	`©omic_öc
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
);

1667 
	`˛ór_bô
(
MB_SEAL
, &
√w_mb
->
mb_Êags
);

1668 
	`˛ór_bô
(
MB_DIRTY
, &
√w_mb
->
mb_Êags
);

1669 
	`˛ór_bô
(
MB_VALID
, &
√w_mb
->
mb_Êags
);

1670 
	`˛ór_bô
(
MB_SKIP
, &
√w_mb
->
mb_Êags
);

1672 if(!
fuŒ
){

1673 
	`˛ór_bô
(
MB_SUMMARY
, &
√w_mb
->
mb_Êags
);

1674 if(
dummy
)

1675 
	`£t_bô
(
MB_DUMMY
, &
√w_mb
->
mb_Êags
);

1677 
	`˛ór_bô
(
MB_DUMMY
, &
√w_mb
->
mb_Êags
);

1678 
	`©omic_öc
(&
£g
->
dummy_cou¡
);

1682 if(
fuŒ
){

1683 
	`£t_bô
(
MB_SUMMARY
, &
√w_mb
->
mb_Êags
);

1684 
	`©omic_öc
(&
£g
->
vÆid_cou¡
);

1685 
	`©omic_öc
(&
£g
->
group
->
vÆid_cou¡
);

1688 
	`©omic_öc
(&
£g
->
dúty_cou¡
);

1689 
	`©omic_öc
(&
£g
->
Àngth
);

1690 
	`©omic_öc
(&
£g
->
∑π_Àngth
);

1691 
	`m¨k_∑rôy_dúty
(
su≥r
, 
ˇche_ty≥
, 
£g
, 
tmp32
);

1693 
	`BUG_ON
(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
Ë> 
STRIPE_SZ
);

1694 
	`BUG_ON
(
	`©omic_ªad
(&
£g
->
Àngth
Ë> 
STRIPE_SZ
);

1695 
	}
}

1698 
	$_Æloc_mb_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
u32
 
idx
){

1699 
£gmít_hódî
 *
£g
;

1700 
mëablock
 *
√w_mb
;

1701 
u32
 
upd©e_mb_idx
;

1702 
u32
 
tmp32
;

1704 
£g
 = 
su≥r
->
cuºít_£g
[
ˇche_ty≥
];

1706 
	`©omic_öc
(&
su≥r
->
cou¡
[
ˇche_ty≥
]);

1708 
upd©e_mb_idx
 = 
	`SEG_START_IDX
(
£g
Ë+ 
su≥r
->
curs‹
[
ˇche_ty≥
];

1709 
upd©e_mb_idx
 = 
idx
;

1711 
	`div_u64_ªm
(
upd©e_mb_idx
, 
NR_CACHES_INSEG
, &
tmp32
);

1712 
√w_mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
tmp32
);

1714 if(
	`ã°_bô
(
MB_VALID
, &
√w_mb
->
mb_Êags
))

1715 
	`¥ötk
(" block i†ÆªadyáŒoˇãdá†®d©®block ..Åy≥ = %d\n", 
£g
->
£g_ty≥
);

1718 
	`©omic_öc
(&
su≥r
->
ƒ_u£d_ˇches
);

1720 
	`˛ór_bô
(
MB_SEAL
, &
√w_mb
->
mb_Êags
);

1721 
	`˛ór_bô
(
MB_DIRTY
, &
√w_mb
->
mb_Êags
);

1722 
	`˛ór_bô
(
MB_VALID
, &
√w_mb
->
mb_Êags
);

1723 
	`£t_bô
(
MB_SUMMARY
, &
√w_mb
->
mb_Êags
);

1725 
	`©omic_öc
(&
£g
->
vÆid_cou¡
);

1726 
	`©omic_öc
(&
£g
->
Àngth
);

1727 
	`©omic_öc
(&
£g
->
∑π_Àngth
);

1729 
	`m¨k_∑rôy_dúty
(
su≥r
, 
ˇche_ty≥
, 
£g
, 
tmp32
);

1734 
	`BUG_ON
(
	`©omic_ªad
(&
£g
->
Àngth
Ë> 
NR_CACHES_INSEG
);

1736 
	}
}

1739 
	$öôülize_mb_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

1740 
ˇche_ty≥
, 
u32
 
idx
, 
fuŒ
)

1742 
i
;

1744 
i
 = 0;ò< 
NUM_SUMMARY
;i++){

1745 
	`_Æloc_mb_summ¨y
(
su≥r
, 
£g
, 
ˇche_ty≥
, 
idx
+
i
, 
fuŒ
, 0);

1747 
	}
}

1750 
	$Æloc_mb_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

1751 
ˇche_ty≥
, 
u32
 
idx
, u32 *
tŸÆ_cou¡
 ){

1752 
i
;

1754 
i
 = 0;ò< 
NUM_SUMMARY
;i++){

1755 
	`ma_Æloc
(
su≥r
, 
£g
, seg->
£g_id
, 
ˇche_ty≥
, (
idx
+
i
)/
CHUNK_SZ
, 
tŸÆ_cou¡
);

1757 
	}
}

1760 
	$Æloc_mb_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

1761 
ˇche_ty≥
, 
u32
 
idx
, u32 *
tŸÆ_cou¡
 )

1763 
i
;

1765 if(
su≥r
->
∑øm
->
d©a_Æloˇti⁄
==
DATA_ALLOC_VERT
){

1766 
i
 = 0;ò< 
NR_SUMMARY
;i++){

1767 
u32
 
Æloc_idx
 = 
	`ß_Æloc
(
su≥r
, 
£g
, seg->
£g_id
, 
ˇche_ty≥
, 
tŸÆ_cou¡
);

1768 
	`BUG_ON
(
idx
+
i
!=
Æloc_idx
%
STRIPE_SZ
);

1770 }if(
su≥r
->
∑øm
->
d©a_Æloˇti⁄
==
DATA_ALLOC_HORI
){

1771 
i
 = 0;ò< 
NR_SUMMARY
;i++){

1773 
u32
 
Æloc_idx
 = 
	`ß_Æloc
(
su≥r
, 
£g
, seg->
£g_id
, 
ˇche_ty≥
, 
tŸÆ_cou¡
);

1776 
	`©omic_öc
(&
su≥r
->
ß
[
ˇche_ty≥
].
cou¡
);

1777 if(
tŸÆ_cou¡
)

1778 *
tŸÆ_cou¡
 = 
	`©omic_ªad
(&
su≥r
->
ß
[
ˇche_ty≥
].
cou¡
);

1784 
i
 = 0;ò< 
NR_SUMMARY
;i++){

1786 
	`ma_Æloc
(
su≥r
, 
£g
, seg->
£g_id
, 
ˇche_ty≥
, (
idx
+
i
)/
CHUNK_SZ
, 
tŸÆ_cou¡
);

1790 
	}
}

1794 
	$Æloc_mb_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

1795 
ˇche_ty≥
, 
u32
 
idx
 )

1797 
i
;

1799 if(
su≥r
->
∑øm
->
d©a_Æloˇti⁄
==
DATA_ALLOC_VERT
){

1800 
i
 = 0;ò< 
NR_SUMMARY
;i++){

1801 
	`curs‹_öc
(
su≥r
, 
£g
->
£g_id
, 
ˇche_ty≥
);

1802 
	`_Æloc_mb_summ¨y
(
su≥r
, 
ˇche_ty≥
, 
idx
+
i
);

1805 
i
 = 0;ò< 
NR_SUMMARY
;i++){

1808 
	`_Æloc_mb_summ¨y
(
su≥r
, 
ˇche_ty≥
, 
idx
+
i
);

1811 
	}
}

1814 
	$£g_Àngth_öc
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
mëablock
 *
mb
, 
boﬁ
 
öÊight
){

1816 
	`©omic_öc
(&
£g
->
vÆid_cou¡
);

1817 
	`©omic_öc
(&
£g
->
group
->
vÆid_cou¡
);

1819 if(
	`ã°_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
)){

1820 
	`©omic_öc
(&
£g
->
dúty_cou¡
);

1821 
	`©omic_öc
(&
£g
->
vÆid_dúty_cou¡
);

1823 
	`©omic_öc
(&
£g
->
vÆid_˛ón_cou¡
);

1827 if(
öÊight
){

1828 
	`©omic_öc
(&
£g
->
Àngth
);

1829 
	`©omic_öc
(&
£g
->
∑π_Àngth
);

1830 
	`©omic_öc
(&
£g
->
num_fûlög
);

1831 
	`©omic_öc
(&
£g
->
num_bufc›y
);

1833 
	`BUG_ON
(
	`©omic_ªad
(&
£g
->
vÆid_cou¡
Ë> 
STRIPE_SZ
);

1834 
	`BUG_ON
(
	`©omic_ªad
(&
£g
->
Àngth
Ë> 
STRIPE_SZ
);

1835 
	}
}

1837 
	$öôülize_mb
(
dm§c_su≥r
 *
su≥r
, 
mëablock
 *
√w_mb
, 
ˇche_ty≥
, 
boﬁ
 
˛ón
){

1839 
	`˛ór_bô
(
MB_SEAL
, &
√w_mb
->
mb_Êags
);

1840 
	`£t_bô
(
MB_VALID
, &
√w_mb
->
mb_Êags
);

1841 
	`˛ór_bô
(
MB_PARITY
, &
√w_mb
->
mb_Êags
);

1842 
	`˛ór_bô
(
MB_SUMMARY
, &
√w_mb
->
mb_Êags
);

1843 
	`˛ór_bô
(
MB_HIT
, &
√w_mb
->
mb_Êags
);

1844 
	`˛ór_bô
(
MB_SKIP
, &
√w_mb
->
mb_Êags
);

1845 
	`˛ór_bô
(
MB_DUMMY
, &
√w_mb
->
mb_Êags
);

1847 if(
	`is_ªad_°rùe
(
ˇche_ty≥
)){

1848 
	`˛ór_bô
(
MB_DIRTY
, &
√w_mb
->
mb_Êags
);

1850 
	`£t_bô
(
MB_DIRTY
, &
√w_mb
->
mb_Êags
);

1853 if(
˛ón
){

1854 
	`˛ór_bô
(
MB_DIRTY
, &
√w_mb
->
mb_Êags
);

1856 
	}
}

1858 
u32
 
	$Æloc_√xt_mb
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
£˘‹_t
 
key
,

1859 
ˇche_ty≥
, 
u32
 *
tŸÆ_cou¡
){

1860 
s32
 
devno
;

1861 
u32
 
mb_idx
;

1863 
devno
 = 
	`ma_£À˘_dev
(
su≥r
, 
key
, 
ˇche_ty≥
);

1864 
	`BUG_ON
(!
£g
);

1865 
mb_idx
 = 
	`ma_Æloc
(
su≥r
, 
£g
, seg->
£g_id
, 
ˇche_ty≥
, 
devno
, 
tŸÆ_cou¡
);

1866  
mb_idx
;

1867 
	}
}

1869 
mëablock
 *
	$Æloc_mb_d©a
(
dm§c_su≥r
 *
su≥r
,

1870 
£˘‹_t
 
key
,

1871 
ˇche_ty≥
,

1872 
boﬁ
 
˛ón
,

1873 
u32
 *
tŸÆ_cou¡
)

1875 
£gmít_hódî
 *
£g
;

1876 
mëablock
 *
√w_mb
;

1877 
u32
 
upd©e_mb_idx
;

1879 
£g
 = 
su≥r
->
cuºít_£g
[
ˇche_ty≥
];

1880 
upd©e_mb_idx
 = 
	`Æloc_√xt_mb
(
su≥r
, 
£g
, 
key
, 
ˇche_ty≥
, 
tŸÆ_cou¡
);

1881 
√w_mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
upd©e_mb_idx
%
STRIPE_SZ
);

1883 
	`©omic_öc
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
);

1885 if(
	`is_n‹mÆ_°rùe
(
ˇche_ty≥
)){

1886 
	`ht_ªgi°î
(
su≥r
, 
key
, 
√w_mb
);

1889 
	`öôülize_mb
(
su≥r
, 
√w_mb
, 
ˇche_ty≥
, 
˛ón
);

1890 
	`£g_Àngth_öc
(
su≥r
, 
£g
, 
√w_mb
, 
åue
);

1892 
	`m¨k_∑rôy_dúty
(
su≥r
, 
£g
->
£g_ty≥
, seg, 
√w_mb
->
idx
%
STRIPE_SZ
);

1894  
√w_mb
;

1895 
	}
}

1897 
	$upd©e_d©a_ö_mb
(
dm§c_su≥r
 *
su≥r
,

1898 
u32
 
upd©e_mb_idx
,

1899 
£gmít_hódî
 *
£g
,

1900 
ømbuf„r
 *
ømbuf
,

1901 
ˇche_ty≥
,

1902 *
d©a
,

1903 
u32
 
¸c32
)

1905 
mëablock
 *
mb
;

1906 
u32
 
tmp32
;

1908 
	`div_u64_ªm
(
upd©e_mb_idx
, 
STRIPE_SZ
, &
tmp32
);

1909 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
tmp32
);;

1911 
	`öc_num_dúty_blocks
(
su≥r
);

1913 if(
ømbuf
 && 
d©a
 && 
	`is_wrôe_°rùe
(
ˇche_ty≥
) &&

1914 
	`USE_ERASURE_CODE
(&
su≥r
->
∑øm
)){

1916 if(
ømbuf
->
∑ges
[
tmp32
]){

1917 
	`BUG_ON
(!
ømbuf
->
∑ges
[
tmp32
]);

1918 
	`mem˝y
(
ømbuf
->
∑ges
[
tmp32
]->
d©a
, d©a, 
SRC_PAGE_SIZE
);

1921 *
±r
;

1922 
±r
 = 
	`∑ge_addªss
(
ømbuf
->
∑ges
[
tmp32
]->
∂
->
∑ge
);

1923 
	`mem˝y
(
±r
, 
d©a
, 
SRC_PAGE_SIZE
);

1928 #ifde‡
USE_CHECKSUM


1931 
mb
->
checksum
 = 
¸c32
;

1934 if(
	`©omic_dec_ªtu∫
(&
£g
->
num_bufc›y
)<0){

1935 
	`¥ötk
(" invalidÇum bufcopy ... \n");

1936 
	`BUG_ON
(1);

1938 
	}
}

1940 
	$wrôeback_ídio_exã¡
(
îr‹
, *
c⁄ãxt
)

1942 
wb_job
 *
job
 = 
c⁄ãxt
;

1943 
dm§c_su≥r
 *
su≥r
 = 
job
->super;

1944 
£gmít_hódî
 *
£g
 = 
job
->seg;

1945 
ømbuf„r
 *
ømbuf
 = 
job
->rambuf;

1946 
u32
 
idx
;

1948 if(
îr‹
){

1949 
	`¥ötk
(" Writeback:Énd ioÉrror \n");

1955 
idx
 = 
job
->
°¨t_idx
;idx < job->°¨t_idx + job->
cou¡
;idx++){

1956 
bio
 *biÿ
ømbuf
->
bios
[
idx
 % 
STRIPE_SZ
];

1957 
mëablock
 *
mb
 = 
	`mb_©
(
su≥r
, 
idx
);

1959 if(
bio
){

1960 
	`©omic_dec
(&
su≥r
->
ˇche_°©
.
öÊight_bios
);

1961 
	`bio_ídio
(
bio
, 0);

1964 if(
job
->
ømbuf
 && 
	`©omic_ªad
(&job->
ømbuf_ªÀa£
)){

1966 if(
	`©omic_dec_™d_ã°
(&
job
->
ømbuf
->
ªf_cou¡
)){

1968 
	`ªÀa£_ømbuf„r
(
su≥r
, 
job
->
ømbuf
, 
£g
->
£g_ty≥
);

1970 if(
	`©omic_ªad
(&
job
->
ømbuf
->
ªf_cou¡
)<0){

1971 
	`¥ötk
(" Invalid!!ÖarityÉnd ioÑamÑefcount = %d, id = %d \n",

1972 
	`©omic_ªad
(&
job
->
ømbuf
->
ªf_cou¡
),

1973 
job
->
ømbuf
->
ømbuf_id
);

1976 
	`£t_bô
(
MB_SEAL
, &
mb
->
mb_Êags
);

1980 
	`mempoﬁ_‰ì
(
job
, 
su≥r
->
≥ndög_mgr
.
wb_job_poﬁ
);

1983 
	}
}

1986 
	$wrôeback_ídio
(
îr‹
, *
c⁄ãxt
)

1988 
wb_job
 *
job
 = 
c⁄ãxt
;

1989 
dm§c_su≥r
 *
su≥r
 = 
job
->super;

1990 
£gmít_hódî
 *
£g
 = 
job
->seg;

1991 
mëablock
 *
mb
 = 
job
->mb;

1992 
bio
 *biÿ
job
->bio;

1994 if(
îr‹
){

1995 
	`¥ötk
(" Writeback:Énd ioÉrror \n");

1998 if(
job
->
bio
){

1999 
	`©omic_dec
(&
su≥r
->
ˇche_°©
.
öÊight_bios
);

2000 
	`bio_ídio
(
bio
, 0);

2001 
job
->
bio
 = 
NULL
;

2004 if(
job
->
ømbuf
 && 
	`©omic_ªad
(&job->
ømbuf_ªÀa£
)){

2006 if(
	`©omic_dec_™d_ã°
(&
job
->
ømbuf
->
ªf_cou¡
)){

2008 
	`ªÀa£_ømbuf„r
(
su≥r
, 
job
->
ømbuf
, 
£g
->
£g_ty≥
);

2010 if(
	`©omic_ªad
(&
job
->
ømbuf
->
ªf_cou¡
)<0){

2011 
	`¥ötk
(" Invalid!!ÖarityÉnd ioÑamÑefcount = %d, id = %d \n",

2012 
	`©omic_ªad
(&
job
->
ømbuf
->
ªf_cou¡
),

2013 
job
->
ømbuf
->
ømbuf_id
);

2017 
	`£t_bô
(
MB_SEAL
, &
mb
->
mb_Êags
);

2018 
	`mempoﬁ_‰ì
(
job
, 
su≥r
->
≥ndög_mgr
.
wb_job_poﬁ
);

2021 
	}
}

2024 
ölöe
 
dm_dev
 *
	$gë_dmdev
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
){

2025 
dev_no
;

2026 
dev_no
 = 
idx
 / 
CHUNK_SZ
 % 
NUM_SSD
;

2027  
su≥r
->
dev_öfo
.
ˇche_dev
[
dev_no
];

2028 
	}
}

2030 
ölöe
 
	$gë_devno
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
){

2031  
idx
 / 
CHUNK_SZ
 % 
NUM_SSD
;

2032 
	}
}

2034 
ölöe
 
block_devi˚
 *
	$gë_bdev
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
){

2035 
dev_no
;

2036 
dev_no
 = 
idx
 / 
CHUNK_SZ
 % 
NUM_SSD
;

2037  
su≥r
->
dev_öfo
.
ˇche_dev
[
dev_no
]->
bdev
;

2038 
	}
}

2041 
ölöe
 
£˘‹_t
 
	$gë_£˘‹
(
dm§c_su≥r
 *
su≥r
, 
u32
 
£g_id
, u32 
idx
){

2042 
u32
 
ba£
;

2043 
u32
 
off£t
;

2045 
ba£
 = 
£g_id
 * 
CHUNK_SZ
;

2046 
off£t
 = 
idx
 % 
CHUNK_SZ
;

2048 
	`BUG_ON
((
ba£
+
off£t
)*
SRC_SECTORS_PER_PAGE
>=
su≥r
->
dev_öfo
.
≥r_ssd_£˘‹s
);

2049  (
RESERVED_START
+
RESERVED_LENGTH
) +

2050 (
ba£
 + 
off£t
Ë* 
SRC_SECTORS_PER_PAGE
;

2051 
	}
}

2053 
wb_job
 *
	$wrôeback_make_job_exã¡
(
dm§c_su≥r
 *
su≥r
,

2054 
£gmít_hódî
 *
£g
,

2055 
ømbuf„r
 *
ømbuf
,

2056 
u32
 
°¨t_idx
,

2057 
u32
 
cou¡
)

2059 
wb_job
 *
job
;

2061 
job
 = 
	`mempoﬁ_Æloc
(
su≥r
->
≥ndög_mgr
.
wb_job_poﬁ
, 
GFP_NOIO
);

2062 if(!
job
){

2063 
	`¥ötk
(" mempoolÉrror \n");

2064 
	`BUG_ON
(1);

2067 
job
->
su≥r
 = super;

2068 
job
->
£g
 = seg;

2069 
job
->
ømbuf
 =Ñambuf;

2070 
job
->
°¨t_idx
 = start_idx;

2071 
job
->
cou¡
 = count;

2072 
	`©omic_£t
(&
job
->
ømbuf_ªÀa£
, 1);

2074  
job
;

2075 
	}
}

2077 
	$wrôeback_issue_job_exã¡
(
dm§c_su≥r
 *
su≥r
, 
wb_job
 *
job
, 
Êush_comm™d
)

2079 
dm_io_ªgi⁄
 
io
;

2080 
dm_io_ªque°
 
io_ªq
;

2081 
ømbuf„r
 *
ømbuf
 = 
job
->rambuf;

2082 
£gmít_hódî
 *
£g
 = 
job
->seg;

2083 
u32
 
°¨t_idx
 = 
job
->start_idx;

2084 
u32
 
ømbuf_idx
 = 
job
->
°¨t_idx
 % 
STRIPE_SZ
;

2085 
u32
 
cur_idx
;

2086 
∑ge_li°
 *
∂s
;

2087 
u32
 
cou¡
 = 0;

2089 
∂s
 = 
NULL
;

2090 
cur_idx
 = 
ømbuf_idx
 + 
job
->
cou¡
 - 1;cur_idx >ømbuf_idx && cur_idx < 
STRIPE_SZ
;cur_idx--){

2091 
∑ge_li°
 *
∂
;

2092 
∂
 = 
ømbuf
->
∑ges
[
cur_idx
]->pl;

2093 
	`BUG_ON
(!
∂
);

2094 
∂
->
√xt
 = 
∂s
;

2095 
∂s
 = 
∂
;

2096 
cou¡
++;

2099 if(
cou¡
==0 || cou¡ > 
CHUNK_SZ
){

2100 
	`BUG_ON
(
cou¡
==0);

2103 
io_ªq
.
mem
.
off£t
 = 0;

2104 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_PAGE_LIST
;

2105 
io_ªq
.
mem
.
±r
.
∂
 = 
∂s
;

2107 if(
Êush_comm™d
){

2108 
io_ªq
.
bi_rw
 = 
WRITE_FLUSH
;

2111 
io_ªq
.
bi_rw
 = 
WRITE_SYNC
;

2115 
io_ªq
.
nŸify
.
‚
 = 
wrôeback_ídio_exã¡
;

2116 
io_ªq
.
nŸify
.
c⁄ãxt
 = 
job
;

2117 
io_ªq
.
˛õ¡
 = 
su≥r
->
io_˛õ¡
;

2119 
io
.
bdev
 = 
	`gë_bdev
(
su≥r
, 
°¨t_idx
);

2120 
io
.
£˘‹
 = 
	`gë_£˘‹
(
su≥r
, 
£g
->
£g_id
, 
°¨t_idx
);

2121 
io
.
cou¡
 = 
SRC_SECTORS_PER_PAGE
 * 
job
->count;

2123 
	`dm§c_io
(&
io_ªq
, 1, &
io
, 
NULL
);

2124 
	}
}

2127 
wb_job
 *
	$wrôeback_make_job
(
dm§c_su≥r
 *
su≥r
,

2128 
£gmít_hódî
 *
£g
,

2129 
u32
 
idx
,

2130 
bio
 *bio,

2131 
ømbuf„r
 *
ømbuf
,

2132 
ømbuf_ªÀa£
)

2134 
wb_job
 *
job
;

2135 
u32
 
ømbuf_idx
 = 
idx
 % 
STRIPE_SZ
;

2137 
job
 = 
	`mempoﬁ_Æloc
(
su≥r
->
≥ndög_mgr
.
wb_job_poﬁ
, 
GFP_NOIO
);

2138 if(!
job
){

2139 
	`¥ötk
(" mempoolÉrror \n");

2140 
	`BUG_ON
(1);

2143 
job
->
su≥r
 = super;

2144 
job
->
£g
 = seg;

2145 
job
->
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
ømbuf_idx
);

2146 
job
->
bio
 = bio;

2147 
job
->
ømbuf
 =Ñambuf;

2148 
	`©omic_£t
(&
job
->
ømbuf_ªÀa£
,Ñambuf_release);

2150  
job
;

2151 
	}
}

2153 
	$wrôeback_issue_job
(
dm§c_su≥r
 *
su≥r
, 
wb_job
 *
job
)

2155 
u32
 
idx
 = 
job
->
mb
->idx;

2156 
u32
 
ømbuf_idx
 = 
job
->
mb
->
idx
 % 
STRIPE_SZ
;

2157 
dm_io_ªgi⁄
 
io
;

2158 
dm_io_ªque°
 
io_ªq
;

2159 
bio
 *biÿ
job
->bio;

2160 
ømbuf„r
 *
ømbuf
 = 
job
->rambuf;

2161 
£gmít_hódî
 *
£g
 = 
job
->seg;

2164 if(
job
->
bio
){

2165 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_BVEC
;

2166 
io_ªq
.
mem
.
±r
.
bvec
 = 
bio
->
bi_io_vec
 + bio->
bi_idx
;

2168 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_KMEM
;

2169 if(
ømbuf
->
∑ges
[
ømbuf_idx
]==
NULL
){

2170 
	`¥ötk
(" invÆidÑambu‡idx %d \n", 
ømbuf_idx
);

2171 
	`BUG_ON
(1);

2173 
io_ªq
.
mem
.
±r
.
addr
 = 
ømbuf
->
∑ges
[
ømbuf_idx
]->
d©a
;

2176 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_KMEM
;

2177 if(
ømbuf
->
∑ges
[
ømbuf_idx
]==
NULL
){

2178 
	`¥ötk
(" invÆidÑambu‡idx %d \n", 
ømbuf_idx
);

2179 
	`BUG_ON
(1);

2181 
io_ªq
.
mem
.
±r
.
addr
 = 
ømbuf
->
∑ges
[
ømbuf_idx
]->
d©a
;

2184 
io_ªq
.
bi_rw
 = 
WRITE
;

2186 
io_ªq
.
nŸify
.
‚
 = 
wrôeback_ídio
;

2187 
io_ªq
.
nŸify
.
c⁄ãxt
 = 
job
;

2188 
io_ªq
.
˛õ¡
 = 
su≥r
->
io_˛õ¡
;

2190 
io
.
bdev
 = 
	`gë_bdev
(
su≥r
, 
idx
);

2191 
io
.
£˘‹
 = 
	`gë_£˘‹
(
su≥r
, 
£g
->
£g_id
, 
idx
);

2192 if(
bio
)

2193 
io
.
cou¡
 = 
	`bio_£˘‹s
(
bio
);

2195 
io
.
cou¡
 = 
SRC_SECTORS_PER_PAGE
;

2197 
	`dm§c_io
(&
io_ªq
, 1, &
io
, 
NULL
);

2198 
	}
}

2203 
	$wrôe_async_bio
(
dm§c_su≥r
 *
su≥r
,

2204 
£gmít_hódî
 *
£g
,

2205 
u32
 
idx
,

2206 
bio
 *bio,

2207 
ømbuf„r
 *
ømbuf
,

2208 
ømbuf_ªÀa£
)

2210 
u32
 
ømbuf_idx
 = 
idx
 % 
STRIPE_SZ
;

2211 
dm_io_ªgi⁄
 
io
;

2212 
dm_io_ªque°
 
io_ªq
;

2213 
wb_job
 *
job
;

2215 
job
 = 
	`mempoﬁ_Æloc
(
su≥r
->
≥ndög_mgr
.
wb_job_poﬁ
, 
GFP_NOIO
);

2216 if(!
job
){

2217 
	`¥ötk
(" mempoolÉrror \n");

2218 
	`BUG_ON
(1);

2221 
job
->
su≥r
 = super;

2222 
job
->
£g
 = seg;

2223 
job
->
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
ømbuf_idx
);

2225 if(
bio
){

2226 
job
->
bio
 = bio;

2227 
job
->
ømbuf
 =Ñambuf;

2228 
	`©omic_£t
(&
job
->
ømbuf_ªÀa£
,Ñambuf_release);

2229 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_BVEC
;

2230 
io_ªq
.
mem
.
±r
.
bvec
 = 
bio
->
bi_io_vec
 + bio->
bi_idx
;

2232 
job
->
bio
 = 
NULL
;

2233 
job
->
ømbuf
 =Ñambuf;

2234 
	`©omic_£t
(&
job
->
ømbuf_ªÀa£
,Ñambuf_release);

2236 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_KMEM
;

2238 if(
ømbuf
->
∑ges
[
ømbuf_idx
]==
NULL
){

2239 
	`¥ötk
(" invÆidÑambu‡idx %d \n", 
ømbuf_idx
);

2240 
	`BUG_ON
(1);

2242 
io_ªq
.
mem
.
±r
.
addr
 = 
ømbuf
->
∑ges
[
ømbuf_idx
]->
d©a
;

2245 
io_ªq
.
bi_rw
 = 
WRITE
;

2246 
io_ªq
.
nŸify
.
‚
 = 
wrôeback_ídio
;

2247 
io_ªq
.
nŸify
.
c⁄ãxt
 = 
job
;

2248 
io_ªq
.
˛õ¡
 = 
su≥r
->
io_˛õ¡
;

2250 
io
.
bdev
 = 
	`gë_bdev
(
su≥r
, 
idx
);

2251 
io
.
£˘‹
 = 
	`gë_£˘‹
(
su≥r
, 
£g
->
£g_id
, 
idx
);

2252 if(
bio
)

2253 
io
.
cou¡
 = 
	`bio_£˘‹s
(
bio
);

2255 
io
.
cou¡
 = 
SRC_SECTORS_PER_PAGE
;

2257 
	`dm§c_io
(&
io_ªq
, 1, &
io
, 
NULL
);

2258 
	}
}

2261 
	$make_Êush_övoke_job
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

2262 
ømbuf„r
 *
ømbuf
, 
£g_Àngth
,

2263 
©omic_t
 *
bios_°¨t
,átomic_à*
bios_cou¡
,

2264 
ˇche_ty≥
, 
f‹˚_£Æ
, 
summ¨y
, 
Êush_d©a
, 
u64
 
globÆ_£g_£quí˚
){

2265 
Êush_m™agî
 *
Êush_mgr
 = &
su≥r
->flush_mgr;

2266 
Êush_övoke_job
 *
job
, *
¥ev_job
;

2267 
Êags
;

2268 
boﬁ
 
found
 = 0;

2269 
u32
 
devno
;

2271 
job
 = 
	`mempoﬁ_Æloc
(
Êush_mgr
->
övoke_poﬁ
, 
GFP_NOIO
);

2273 
	`bio_li°_öô
(&
job
->
b¨rõr_ios
);

2274 if(
	`is_n‹mÆ_°rùe
(
ˇche_ty≥
)){

2275 
f
;

2276 
	`•ö_lock_úqßve
(&
su≥r
->
≥ndög_mgr
.
b¨rõr_lock
, 
f
);

2281 
	`bio_li°_mîge
(&
job
->
b¨rõr_ios
, &
su≥r
->
≥ndög_mgr
.barrier_ios);

2282 
	`bio_li°_öô
(&
su≥r
->
≥ndög_mgr
.
b¨rõr_ios
);

2283 
	`©omic_£t
(&
su≥r
->
≥ndög_mgr
.
b¨rõr_cou¡
, 0);

2284 
	`•ö_u∆ock_úqª°‹e
(&
su≥r
->
≥ndög_mgr
.
b¨rõr_lock
, 
f
);

2287 
job
->
ˇche_ty≥
 = cache_type;

2288 
job
->
£g
 = seg;

2289 
job
->
ømbuf
 =Ñambuf;

2290 
job
->
f‹˚_£Æ
 = force_seal;

2291 
job
->
buûd_summ¨y
 = 
summ¨y
;

2292 
job
->
Êush_d©a
 = flush_data;

2293 
job
->
£g_Àngth
 =seg_length;

2294 
job
->
globÆ_£g_£quí˚
 = global_seg_sequence;

2296 
devno
 = 0;devnÿ< 
NUM_SSD
;devno++){

2297 
	`©omic_£t
(&
job
->
bios_°¨t
[
devno
], 
	`©omic_ªad
(&bios_start[devno]));

2298 
	`©omic_£t
(&
job
->
bios_cou¡
[
devno
], 
	`©omic_ªad
(&bios_count[devno]));

2304 
	`•ö_lock_úqßve
(&
Êush_mgr
->
lock
, 
Êags
);

2305 
	`li°_f‹_óch_íåy_ªvî£
(
¥ev_job
, &
Êush_mgr
->
queue
, 
li°
){

2306 if(
¥ev_job
->
globÆ_£g_£quí˚
 < global_seg_sequence){

2309 
found
 = 
åue
;

2316 if(!
found
){

2317 
	`li°_add_èû
(&
job
->
li°
, &
Êush_mgr
->
queue
);

2319 
	`li°_add
(&
job
->
li°
, &
¥ev_job
->list);

2323 
	`©omic_öc
(&
Êush_mgr
->
övoke_cou¡
);

2324 
	`•ö_u∆ock_úqª°‹e
(&
Êush_mgr
->
lock
, 
Êags
);

2326 
	`wake_up_¥o˚ss
(
Êush_mgr
->
d´m⁄
);

2327 
	}
}

2330 
	$bio_∂uggög
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
ømbuf„r
 *
ømbuf
,

2331 
bio
 *bio, 
u32
 
upd©e_mb_idx
){

2332 
devno
 = 
	`gë_devno
(
su≥r
, 
upd©e_mb_idx
);

2333 
Êags
, 
f
;

2335 
	`•ö_lock_úqßve
(&
su≥r
->
£gbuf_mgr
.
lock
, 
Êags
);

2336 
	`•ö_lock_úqßve
(&
ømbuf
->
lock
, 
f
);

2337 
ømbuf
->
bios
[
upd©e_mb_idx
%
STRIPE_SZ
] = 
bio
;

2338 
	`BUG_ON
(
	`©omic_öc_ªtu∫
(&
ømbuf
->
bios_cou¡
[
devno
])>
CHUNK_SZ
);

2339 
	`BUG_ON
(
	`©omic_öc_ªtu∫
(&
ømbuf
->
bios_tŸÆ_cou¡
)>
STRIPE_SZ
);

2348 
	`•ö_u∆ock_úqª°‹e
(&
ømbuf
->
lock
, 
f
);

2349 
	`•ö_u∆ock_úqª°‹e
(&
su≥r
->
£gbuf_mgr
.
lock
, 
Êags
);

2351 
	`upd©e_∂ug_dódlöe
(
su≥r
);

2352 
	}
}

2354 
	$gë_desúed_size
(
dm§c_su≥r
 *
su≥r
, 
£g_id
){

2355 
size
 = 
CHUNK_SZ
 * ((
£g_id
 % (
NUM_SSD
-1)) + 1);

2357 
size
 = 
CHUNK_SZ
 * 1;

2358  
size
;

2359 
	}
}

2361 
	$¥o˚ss_wrôe_ªque°
(
dm§c_su≥r
 *
su≥r
,

2362 
bio
 *bio,

2363 
∑ge
 *page,

2364 
£˘‹_t
 
key
,

2365 
is_dúty
,

2366 
f
,

2367 
ˇche_ty≥
,

2368 
u32
 
¸c32


2371 
£gmít_hódî
 *
£g
;

2372 
mëablock
 *
√w_mb
;

2373 
ømbuf„r
 *
ømbuf
;

2374 
boﬁ
 
√ed_ª‰esh
 = 
Ál£
;

2375 
boﬁ
 
√ed_summ¨y
 = 
Ál£
;

2376 *
±r
;

2377 
u32
 
tŸÆ_cou¡
 = 0;

2378 
u32
 
mb_idx
;

2379 
u32
 
£g_Àngth
;

2380 
©omic_t
 
bios_°¨t
[
MAX_CACHE_DEVS
];

2381 
©omic_t
 
bios_cou¡
[
MAX_CACHE_DEVS
];

2382 
u32
 
∑πül_ã°
 = 0;

2383 
u64
 
globÆ_£g_£quí˚
;

2385 
√w_mb
 = 
	`Æloc_mb_d©a
(
su≥r
, 
key
, 
ˇche_ty≥
, !
is_dúty
, &
tŸÆ_cou¡
);

2386 if(
	`ã°_bô
(
MB_DIRTY
, &
√w_mb
->
mb_Êags
)!=
is_dúty
){

2387 
	`¥ötk
(" invÆid dúty fœg = %d %dÅŸÆ_cou¡ = %d \n", 
	`ã°_bô
(
MB_DIRTY
, &
√w_mb
->
mb_Êags
), 
is_dúty
, 
tŸÆ_cou¡
);

2388 
	`¥ötk
(" cachêty≥ = %d \n", 
ˇche_ty≥
);

2391 
mb_idx
 = 
√w_mb
->
idx
;

2392 
£g
 = 
su≥r
->
cuºít_£g
[
ˇche_ty≥
];

2393 
ømbuf
 = 
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
ˇche_ty≥
];

2395 #i‡
SUMMARY_LOCATION
 =
USE_LAST_SUMMARY


2396 if(
	`√ed_chunk_summ¨y
(
su≥r
, 
mb_idx
+
NUM_SUMMARY
)){

2397 
u32
 
summ¨y_idx
 = 
	`d©a_to_summ¨y_idx
(
su≥r
, 
mb_idx
);

2398 
	`Æloc_mb_summ¨y
(
su≥r
, 
£g
, 
ˇche_ty≥
, 
summ¨y_idx
, &
tŸÆ_cou¡
);

2399 
	`öôülize_mb_summ¨y
(
su≥r
, 
£g
, 
ˇche_ty≥
, 
summ¨y_idx
, 1);

2400 
√ed_summ¨y
 = 
åue
;

2405 if(
su≥r
->
∑øm
.
bio_∂uggög
){

2406 
	`bio_∂uggög
(
su≥r
, 
£g
, 
ømbuf
, 
bio
, 
mb_idx
);

2407 #i‡
SUMMARY_LOCATION
 =
USE_LAST_SUMMARY


2408 if(
√ed_summ¨y
){

2409 
j
;

2410 
j
 = 0;j < 
NUM_SUMMARY
;j++)

2411 
	`bio_∂uggög
(
su≥r
, 
£g
, 
ømbuf
, 
NULL
, 
mb_idx
 + 1 + 
j
);

2420 if(
∑πül_ã°
 || 
	`√ed_ª‰esh_£gmít
(
su≥r
, 
ˇche_ty≥
, 
tŸÆ_cou¡
)){

2421 if(!
∑πül_ã°
)

2422 
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
ˇche_ty≥
] = 
NULL
;

2424 
√ed_ª‰esh
 = 
åue
;

2425 
globÆ_£g_£quí˚
 = 
	`©omic64_öc_ªtu∫
(&
su≥r
->
Êush_mgr
.global_seg_sequence);

2427 if(
∑πül_ã°
){

2429 
	`Æloc_∑πül_summ¨y
(
su≥r
, 
£g
, 
ømbuf
, 
ˇche_ty≥
);

2432 
	`make_bios_∑rôy
(
su≥r
, 
£g
, 
ømbuf
, 0);

2433 
	`make_bios_ve˘‹
(
su≥r
, 
£g
, 
ømbuf
, 
bios_°¨t
, 
bios_cou¡
);

2434 
£g_Àngth
 = 
	`©omic_ªad
(&
£g
->
Àngth
);

2436 
	`¥ötk
(" seg id = %d, segÜígth = %d vÆid cou¡ = %d(dúty = %d, cÀ™ = %d), dummy = %d \n", ()
£g
->
£g_id
, 
£g_Àngth
,

2437 
	`©omic_ªad
(&
£g
->
vÆid_cou¡
),

2438 
	`©omic_ªad
(&
£g
->
vÆid_dúty_cou¡
),

2439 
	`©omic_ªad
(&
£g
->
vÆid_˛ón_cou¡
),

2440 
	`©omic_ªad
(&
£g
->
dummy_cou¡
));

2443 
	`UNLOCK
(
su≥r
, 
f
);

2450 if(
∑ge
){

2451 
±r
 = 
	`∑ge_addªss
(
∑ge
);

2452 
	`upd©e_d©a_ö_mb
(
su≥r
, 
mb_idx
, 
£g
, 
ømbuf
, 
ˇche_ty≥
, 
±r
, 
¸c32
);

2454 
±r
 = 
NULL
;

2455 
	`upd©e_d©a_ö_mb
(
su≥r
, 
mb_idx
, 
£g
, 
ømbuf
, 
ˇche_ty≥
, 
±r
, 0);

2458 
	`BUG_ON
(
ˇche_ty≥
!=
£g
->
£g_ty≥
);

2459 if(
√ed_ª‰esh
){

2460 
	`BUG_ON
(
	`ã°_bô
(
SEG_SEALED
, &
£g
->
Êags
));

2463 if(
su≥r
->
∑øm
.
bio_∂uggög
){

2464 
	`©omic_dec
(&
£g
->
num_fûlög
);

2465 if(
bio
)

2466 
	`©omic_öc
(&
su≥r
->
ˇche_°©
.
öÊight_bios
);

2467 
	`©omic_öc
(&
su≥r
->
ˇche_°©
.
tŸÆ_bios
);

2469 if(
√ed_ª‰esh
 && !
	`ã°_bô
(
SEG_SEALED
, &
£g
->
Êags
)){

2472 
	`make_Êush_övoke_job
(
su≥r
, 
£g
, 
ømbuf
, 
£g_Àngth
, 
bios_°¨t
, 
bios_cou¡
,

2473 
ˇche_ty≥
, 0, 0, 1, 
globÆ_£g_£quí˚
);

2483 
	`¥ötk
("Ço queueÇot supported ... \n");

2484 
	`BUG_ON
(1);

2487  
DM_MAPIO_SUBMITTED
;

2488 
	}
}

2491 
	$¥o˚ss_ªad_miss_ªque°
(
dm§c_su≥r
 *
su≥r
, 
bio
 *bio, 
f
){

2492 
dm_dev
 *
‹igö_dev
 = 
su≥r
->
dev_öfo
.origin_dev;

2494 
	`UNLOCK
(
su≥r
, 
f
);

2496 
	`bio_ªm≠
(
bio
, 
‹igö_dev
, bio->
bi_£˘‹
);

2497 
	`ªad_ˇchög_make_job
(
su≥r
, 
NULL
, NULL, 
bio
, NULL);

2499  
DM_MAPIO_SUBMITTED
;

2501 
	}
}

2503 
	$¥o˚ss_ªad_hô_ªque°
(
dm§c_su≥r
 *
su≥r
, 
bio
 *bio,

2504 
£gmít_hódî
 *
£g
,

2505 
mëablock
 *
mb
,

2506 
f
){

2508 
bio_˘x
 *
m≠_c⁄ãxt
;

2509 
dm_èrgë
 *
ti
 = 
su≥r
->ti;

2510 
u32
 
tmp32
;

2512 
m≠_c⁄ãxt
 = 
	`dm_≥r_bio_d©a
(
bio
, 
ti
->
≥r_bio_d©a_size
);

2514 if(
	`ã°_bô
(
SEG_SEALED
, &
£g
->
Êags
)){

2515 
	`£t_bô
(
SEG_HIT
, &
£g
->
Êags
);

2517 if(!
	`ã°_bô
(
MB_HIT
, &
mb
->
mb_Êags
)){

2518 
	`£t_bô
(
MB_HIT
, &
mb
->
mb_Êags
);

2519 
	`©omic_öc
(&
£g
->
hŸ_cou¡
);

2520 if(!
	`ã°_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
))

2521 
	`©omic_öc
(&
£g
->
hŸ_˛ón_cou¡
);

2525 
	`©omic_öc
(&
£g
->
num_ªad_öÊight
);

2526 
	`UNLOCK
(
su≥r
, 
f
);

2528 
m≠_c⁄ãxt
->
±r
 = 
£g
;

2530 
	`div_u64_ªm
(
bio
->
bi_£˘‹
, 1 << 3, &
tmp32
);

2531 if(
tmp32
){

2532 
	`¥ötk
("Ñód hô:Ö¨tü»ªad: se˘‹ %d off£à%d, sizê%d \n", ()
bio
->
bi_£˘‹
, 
tmp32
,

2533 
bio
->
bi_size
);

2534 
	`¥ötk
("Ñód hô:Ö¨tü»ªad: mb->idx %d \n", 
mb
->
idx
);

2537 
	`bio_ªm≠
(
bio
,

2538 
	`gë_dmdev
(
su≥r
, 
mb
->
idx
),

2539 
	`gë_£˘‹
(
su≥r
, 
£g
->
£g_id
, 
mb
->
idx
)

2540 + 
tmp32
);

2542 
	`gíîic_make_ªque°
(
bio
);

2544  
DM_MAPIO_SUBMITTED
;

2545 
	}
}

2548 #i‡
deföed
(
CONFIG_BCACHE
Ë|| deföed(
CONFIG_BCACHE_MODULE
)

2549 
	#ewma_add
(
ewma
, 
vÆ
, 
weight
, 
Á˘‹
) \

2551 (
ewma
Ë*(
weight
) - 1; \

2552 (
ewma
Ë+(
vÆ
Ë<< 
Á˘‹
; \

2553 (
ewma
Ë/(
weight
); \

2554 (
ewma
Ë>> 
Á˘‹
; \

2555 })

	)

2558 
hli°_hód
 *
	$iohash
(
£q_io_dëe˘‹
 *
dc
, 
uöt64_t
 
k
)

2560  &
dc
->
io_hash
[
	`hash_64
(
k
, 
RECENT_IO_BITS
)];

2561 
	}
}

2563 
	$add_£quítül
(
èsk_°ru˘
 *
t
)

2565 
	`ewma_add
(
t
->
£quítül_io_avg
,

2566 
t
->
£quítül_io
, 8, 0);

2568 
t
->
£quítül_io
 = 0;

2569 
	}
}

2575 
boﬁ
 
	$dëe˘_£quítül_io
(
dm§c_su≥r
 *
su≥r
, 
bio
 *bio){

2576 
io
 *
i
;

2577 
£˘‹s
;

2578 
u£_mîge
 = 1;

2579 #i‡
	`deföed
(
CONFIG_BCACHE
Ë|| deföed(
CONFIG_BCACHE_MODULE
)

2580 
Êags
;

2582 
£q_io_dëe˘‹
 *
£q_dëe˘‹
 = &
su≥r
->seq_detector;

2583 
boﬁ
 
r
 = 
Ál£
;

2585 if(!
su≥r
->
∑øm
.
£quítül_íabÀ
){

2586  
Ál£
;

2588 i‡(
bio
->
bi_rw
 & 
REQ_DISCARD
) {

2589  
Ál£
;

2592 
	`•ö_lock_úqßve
(&
£q_dëe˘‹
->
£q_lock
, 
Êags
);

2593 i‡(
u£_mîge
) {

2595 
	`hli°_f‹_óch_íåy
(
i
, 
	`iohash
(
£q_dëe˘‹
, 
bio
->
bi_£˘‹
), 
hash
)

2596 i‡(
i
->
œ°
 =
bio
->
bi_£˘‹
 &&

2597 
	`time_bef‹e
(
jiffõs
, 
i
->jiffies))

2598 
found
;

2600 
i
 = 
	`li°_fú°_íåy
(&
£q_dëe˘‹
->
io_Ãu
, 
io
, 
Ãu
);

2602 
	`add_£quítül
(
cuºít
);

2603 
i
->
£quítül
 = 0;

2604 
found
:

2605 i‡(
i
->
£quítül
 + 
bio
->
bi_size
 > i->sequential)

2606 
i
->
£quítül
 +
bio
->
bi_size
;

2608 
i
->
œ°
 = 
	`bio_íd_£˘‹
(
bio
);

2609 
i
->
jiffõs
 = jiffõ†+ 
	`m£cs_to_jiffõs
(5000);

2610 
cuºít
->
£quítül_io
 = 
i
->
£quítül
;

2612 
	`hli°_dñ
(&
i
->
hash
);

2613 
	`hli°_add_hód
(&
i
->
hash
, 
	`iohash
(
£q_dëe˘‹
, i->
œ°
));

2614 
	`li°_move_èû
(&
i
->
Ãu
, &
£q_dëe˘‹
->
io_Ãu
);

2617 
cuºít
->
£quítül_io
 = 
bio
->
bi_size
;

2618 
	`add_£quítül
(
cuºít
);

2620 
	`•ö_u∆ock_úqª°‹e
(&
£q_dëe˘‹
->
£q_lock
, 
Êags
);

2622 
£˘‹s
 = 
	`max
(
cuºít
->
£quítül_io
,

2623 
cuºít
->
£quítül_io_avg
) >> 9;

2625 i‡(
su≥r
->
∑øm
.
£quítül_cutoff
 &&

2626 
£˘‹s
 >
su≥r
->
∑øm
.
£quítül_cutoff
 >> 9) {

2627 
r
 = 
åue
;

2631  
r
;

2632 
	}
}

2635 
ölöe
 
boﬁ
 
	$should_√ed_ª‰esh_£g
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

2636 
boﬁ
 
√ed_ª‰esh
 = 
Ál£
;

2637 
cou¡
;

2639 
cou¡
 = 
	`ma_gë_cou¡
(
su≥r
, 
ˇche_ty≥
);

2640 if(
	`√ed_ª‰esh_£gmít
(
su≥r
, 
ˇche_ty≥
, 
cou¡
))

2641 
√ed_ª‰esh
 = 
åue
;

2642  
√ed_ª‰esh
;

2643 
	}
}

2646 
	$åy_waô_‰ì_£g
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

2648 if((
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
£g_Æloc_cou¡
)<=

2649 
MIGRATE_HIGHWATER
 - (MIGRATE_HIGHWATER - 
MIGRATE_LOWWATER
)/2

2650 ||
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
group_Æloc_cou¡
)<=1)

2651 && 
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
)){

2655 if(
	`should_√ed_ª‰esh_£g
(
su≥r
, 
ˇche_ty≥
)){

2656 #ifde‡
FORCE_UMAX


2657 if(
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
£g_Æloc_cou¡
)<
MIGRATE_LOWWATER
 ||

2658 
	`gë_cuº_utû
(
su≥r
Ë> su≥r->
∑øm
.
u_max
 ||

2659 
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
group_Æloc_cou¡
)<=1){

2661 if(
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
£g_Æloc_cou¡
)<
MIGRATE_LOWWATER
 ||

2662 
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
group_Æloc_cou¡
)<=1){

2664 if(!
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
)){

2665 
	`©omic_£t
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
, 1);

2666 
su≥r
->
migøã_mgr
.
Ælow_migøã
 = 
åue
;

2667 
	`wake_up_¥o˚ss
(
su≥r
->
migøã_mgr
.
d´m⁄
);

2673 if(
	`ˇn_gë_‰ì_£gmít
(
su≥r
, 
ˇche_ty≥
, 0)){

2674 
	`Æloc_√w_£gmít
(
su≥r
, 
ˇche_ty≥
, 
Ál£
);

2681 
	}
}

2684 
	$should_by∑ss_bio
(
dm§c_su≥r
 *
su≥r
,

2685 
£gmít_hódî
 *
£g
,

2686 
mëablock
 *
mb
,

2687 
bio
 *bio,

2688 
is_wrôe
){

2690 
bio_˘x
 *
m≠_c⁄ãxt
 =

2691 
	`dm_≥r_bio_d©a
(
bio
, 
su≥r
->
ti
->
≥r_bio_d©a_size
);

2692 
boﬁ
 
ˇn_by∑ss
 = 
Ál£
;

2693 
boﬁ
 
£q_io
;

2694 
boﬁ
 
cﬁd_io
 = 
Ál£
;

2696 if(
is_wrôe
){

2697 if(!
m≠_c⁄ãxt
->
hŸ_io
 && 
	`gë_cuº_utû
(
su≥r
Ë> su≥r->
∑øm
.
u_max
){

2698 
cﬁd_io
 = 
åue
;

2701 if(!
m≠_c⁄ãxt
->
hŸ_io
 && 
	`gë_cuº_utû
(
su≥r
Ë> su≥r->
∑øm
.
u_max
){

2702 
cﬁd_io
 = 
åue
;

2706 
£q_io
 = (
boﬁ
)
m≠_c⁄ãxt
->seq_io;

2707 if(
£q_io
 || 
cﬁd_io
){

2708 
boﬁ
 
ªm≠≥d
 = 
Ál£
;

2710 if(!
mb
){

2711 
ªm≠≥d
 = 
åue
;

2713 if(
is_wrôe
){

2714 
	`BUG_ON
–!
	`ã°_bô
(
MB_SEAL
, &
mb
->
mb_Êags
Ë&& 
	`is_gc_°rùe
(
£g
->
£g_ty≥
));

2715 
	`övÆid©e_¥evious_ˇche
(
su≥r
, 
£g
, 
mb
);

2716 
ªm≠≥d
 = 
åue
;

2720 if(
ªm≠≥d
){

2721 if(
cﬁd_io
)

2722 
	`©omic_öc
(&
su≥r
->
w°©
.
cﬁd_by∑ss_cou¡
);

2723 if(
£q_io
)

2724 
	`©omic_öc
(&
su≥r
->
w°©
.
£q_by∑ss_cou¡
);

2726 
ˇn_by∑ss
 = 
åue
;

2727 
do_by∑ss
;

2731 if(
	`©omic_ªad
(&
su≥r
->
ªsize_mode
)){

2732 if(!
mb
){

2733 
ˇn_by∑ss
 = 
åue
;

2735 
	`¥ötk
(" data is found\n");

2736 
	`BUG_ON
(1);

2740 if(
	`©omic_ªad
(&
su≥r
->
degøded_mode
)){

2741 if(!
mb
){

2742 
ˇn_by∑ss
 = 
åue
;

2744 if(
is_wrôe
){

2745 
	`övÆid©e_¥evious_ˇche
(
su≥r
, 
£g
, 
mb
);

2746 
ˇn_by∑ss
 = 
åue
;

2748 if(
	`ã°_bô
(
MB_BROKEN
, &
mb
->
mb_Êags
)){

2749 
	`¥ötk
("ÇeedÑeconstructÑead \n");

2755 
do_by∑ss
:

2757 if(
ˇn_by∑ss
){

2762 
	}
}

2765 
	$åy_gë_‰ì_£gmít
(
dm§c_su≥r
 *
su≥r
, 
boﬁ
 
found
, 
rw
){

2766 
ˇche_ty≥
;

2768 if(
su≥r
->
∑øm
->
°rùög_pﬁicy
==
MIXED_STRIPING
)

2769 
rw
 = 1;

2771 if(
rw
){

2772 
ˇche_ty≥
 = 
su≥rUF
;

2774 
ˇche_ty≥
 =
RBUF
;

2777 if(
	`should_√ed_ª‰esh_£g
(
su≥r
, 
rw
)){

2778 if(
	`ˇn_gë_‰ì_£gmít
(
su≥r
, 
ˇche_ty≥
)){

2779 
	`BUG_ON
(
	`©omic_ªad
(&
su≥r
->
ømbuf_öa˘ive_cou¡
)==0);

2780 
	`Æloc_√w_£gmít
(
su≥r
, 
ˇche_ty≥
, 
Ál£
);

2787 
	}
}

2792 
	$upd©e_gho°_buf„r
(
dm§c_su≥r
 *
su≥r
, 
£˘‹_t
 
£˘‹
, 
is_wrôe
, *
is_hŸ
){

2793 
ˇche_m™agî
 *
Ãu_m™agî
 = 
su≥r
->lru_manager;

2794 
Ãu_node
 *
 
 = 
NULL
;

2796 
 
 = 
	`CACHE_SEARCH
(
Ãu_m™agî
, 
£˘‹
);

2797 if(!
 
){

2798 
 
 = 
	`CACHE_REPLACE
(
Ãu_m™agî
, 0);

2799 
 
 = 
	`CACHE_ALLOC
(
Ãu_m™agî
,Ün, 
£˘‹
);

2800 
	`CACHE_INSERT
(
Ãu_m™agî
, 
 
);

2801 *
is_hŸ
 = 0;

2803 *
is_hŸ
 = 1;

2804 
 
 = 
	`CACHE_REMOVE
(
Ãu_m™agî
,Ün);

2805 
	`CACHE_INSERT
(
Ãu_m™agî
, 
 
);

2806 if(
is_wrôe
)

2807 
 
->
˙_wrôe_hô
++;

2809 
 
->
˙_ªad_hô
++;

2811 if(
is_wrôe
)

2812 
 
->
˙_wrôe_ªf
++;

2814 
 
->
˙_ªad_ªf
++;

2816 if(
is_wrôe
){

2817 if(*
is_hŸ
)

2820 if(
 
->
˙_wrôe_ªf
==0&& ->
˙_ªad_ªf
>1)

2825 
	}
}

2828 
	$upd©e_°©
(
dm§c_su≥r
 *
su≥r
, 
mëablock
 *
mb
, 
is_wrôe
){

2829 
su≥r
->
w°©
.
cou¡
++;

2830 if(
is_wrôe
)

2831 
su≥r
->
w°©
.
wrôe_cou¡
++;

2833 
su≥r
->
w°©
.
ªad_cou¡
++;

2835 i‡(
mb
) {

2836 
su≥r
->
w°©
.
hô
++;

2837 if(
is_wrôe
)

2838 
su≥r
->
w°©
.
wrôe_hô
++;

2840 
su≥r
->
w°©
.
ªad_hô
++;

2842 
	}
}

2844 
	$¥ïro˚ss_≥ndög_bio
(
dm§c_su≥r
 *
su≥r
,

2845 
£gmít_hódî
 *
£g
,

2846 
bio
 *bio,

2847 
mëablock
 *
mb
,

2848 
is_wrôe
)

2850 
ªs
 = 0;

2852 if(
mb
){

2854 if(
	`u∆ikñy
(
	`ã°_bô
(
SEG_MIGRATING
, &
£g
->
Êags
))){

2855 
ªs
 = 
RES_MIG
;

2856 
≥ndög_¥o˚ss
;

2859 if(
	`u∆ikñy
(
	`ã°_bô
(
SEG_PARTIAL
, &
£g
->
Êags
) ||

2860 
	`ã°_bô
(
SEG_RECOVERY
, &
£g
->
Êags
) ))

2862 
ªs
 = 
RES_PARTIAL
;

2863 
≥ndög_¥o˚ss
;

2866 if(
	`u∆ikñy
(!
	`ã°_bô
(
MB_SEAL
, &
mb
->
mb_Êags
))){

2867 if(!
is_wrôe
){

2868 
ªs
 = 
RES_SEAL
;

2869 
≥ndög_¥o˚ss
;

2875 if(
	`u∆ikñy
(
	`©omic_ªad
(&
su≥r
->
ªsize_mode
))){

2876 
≥ndög_¥o˚ss
;

2880 if(
	`u∆ikñy
(
	`should_by∑ss_bio
(
su≥r
, 
£g
, 
mb
, 
bio
, 
is_wrôe
) &&

2881 !(
bio
->
bi_rw
 & 
REQ_DISCARD
))){

2882 
ªs
 = 
RES_BYPASS
;

2883 
by∑ss_¥o˚ss
;

2887 if(
is_wrôe
){

2888 if(
su≥r
->
cuºít_group
 && 
	`©omic_ªad
(&su≥r->cuºít_group->
‰ì_£g_cou¡
)==0){

2889 if(
	`should_√ed_ª‰esh_£g
(
su≥r
, 
WCBUF
) &&

2890 !
	`should_√ed_ª‰esh_£g
(
su≥r
, 
RCBUF
)){

2891 
	`¥ötk
(" * dirty seg write:Çeed fill RCBUF with dummy ... \n");

2895 if(
	`åy_waô_‰ì_£g
(
su≥r
, 
WCBUF
)){

2896 
ªs
 = 
RES_NOFREE1
;

2897 
≥ndög_¥o˚ss
;

2903 
≥ndög_¥o˚ss
:

2904  
ªs
;

2906 
by∑ss_¥o˚ss
:

2907  
ªs
;

2909 
	}
}

2912 
	$lookup_døm_ˇche
(
dm§c_su≥r
 *
su≥r
, 
£˘‹_t
 
£˘‹
){

2913 
ˇche_m™agî
 *
Ãu_m™agî
 = 
su≥r
->
˛ón_døm_ˇche_m™agî
;

2914 
Ãu_node
 *
 
 = 
NULL
;

2916 
 
 = 
	`CACHE_SEARCH
(
Ãu_m™agî
, 
£˘‹
);

2917 if(!
 
){

2918 
 
 = 
	`CACHE_REPLACE
(
Ãu_m™agî
, 0);

2919 
 
 = 
	`CACHE_ALLOC
(
Ãu_m™agî
,Ün, 
£˘‹
);

2920 
	`CACHE_INSERT
(
Ãu_m™agî
, 
 
);

2921 
	`©omic_£t
(&
 
->
£Æed
, 0);

2923 
 
 = 
	`CACHE_REMOVE
(
Ãu_m™agî
,Ün);

2924 
	`CACHE_INSERT
(
Ãu_m™agî
, 
 
);

2925 
 
->
˙_ªad_hô
++;

2928 
 
->
˙_ªad_ªf
++;

2931 
	}
}

2934 
	$¥o˚ss_ªad_ªque°
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

2935 
mëablock
 *
mb
, 
bio
 *bio, 
£˘‹_t
 
key
, 
f
){

2936 
ˇche_m™agî
 *
˛ón_ˇche
 = 
su≥r
->
˛ón_døm_ˇche_m™agî
;

2937 
Ãu_node
 *
 
 = 
NULL
;

2938 
Ãu_Êags
;

2939 
døm_hô
 = 0;

2940 
£Æed
 = 0;

2941 
ªs
;

2943 if(!
mb
 && 
su≥r
->
∑øm
.
íabÀ_ªad_ˇche
){

2944 
	`•ö_lock_úqßve
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

2945 
 
 = 
	`CACHE_SEARCH
(
˛ón_ˇche
, 
key
);

2946 if(!
 
){

2947 
døm_hô
 = 0;

2949 if(
˛ón_ˇche
->
cm_‰ì
){

2950 
 
 = 
	`CACHE_ALLOC
(
˛ón_ˇche
,Ün, 
key
);

2951 
	`CACHE_INSERT
(
˛ón_ˇche
, 
 
);

2952 
	`©omic_£t
(&
 
->
£Æed
, 0);

2953 
	`©omic_£t
(&
 
->
locked
, 0);

2957 
	`¥ötk
(" hit in dram ... \n");

2958 
døm_hô
 = 1;

2959 
 
 = 
	`CACHE_REMOVE
(
˛ón_ˇche
,Ün);

2960 
	`CACHE_INSERT
(
˛ón_ˇche
, 
 
);

2961 
 
->
˙_ªad_hô
++;

2964 if(
 
){

2965 if(
	`©omic_ªad
(&
 
->
£Æed
))

2966 
£Æed
 = 1;

2968 
£Æed
 = 0;

2970 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

2972 if(!
 
){

2973 
	`UNLOCK
(
su≥r
, 
f
);

2975 
	`bio_ªm≠
(
bio
, 
su≥r
->
dev_öfo
.
‹igö_dev
, bio->
bi_£˘‹
);

2976 
	`gíîic_make_ªque°
(
bio
);

2977  
DM_MAPIO_SUBMITTED
;

2981 if(
døm_hô
){

2982 
	`BUG_ON
(
mb
);

2983 if(
£Æed
){

2984 
	`UNLOCK
(
su≥r
, 
f
);

2985 
	`BUG_ON
(1);

2986 
	`¥ötk
(" døm hô sóÀd %d .. \n", ()
key
);

2987 
	`bio_ídio
(
bio
, 0);

2988  
DM_MAPIO_SUBMITTED
;

2990 
	`UNLOCK
(
su≥r
, 
f
);

2991 
	`¥ötk
(" døm hô buànŸ sóÀd..≥ndög queuê%d \n", ()
key
);

2992 
	`BUG_ON
(1);

2993 
ªs
 = 
RES_DRAM
;

2997 i‡(!
mb
) {

2999  
	`¥o˚ss_ªad_miss_ªque°
(
su≥r
, 
bio
, 
f
);

3002  
	`¥o˚ss_ªad_hô_ªque°
(
su≥r
, 
bio
, 
£g
, 
mb
, 
f
);

3006 
	}
}

3008 
	$m≠_≥ndög_bio
(
dm§c_su≥r
 *
su≥r
, 
bio
 *bio)

3010 
dm_èrgë
 *
ti
 = 
su≥r
->ti;

3011 
£gmít_hódî
 *
£g
 = 
NULL
;

3012 
mëablock
 *
mb
 = 
NULL
;

3013 
bio_˘x
 *
m≠_c⁄ãxt
 = 
NULL
;

3015 
ˇche_m™agî
 *
˛ón_ˇche
 = 
su≥r
->
˛ón_døm_ˇche_m™agî
;

3016 
Ãu_node
 *
 
 = 
NULL
;

3017 
Ãu_Êags
;

3019 
£˘‹_t
 
key
;

3020 
ªs
 = 0;

3021 
is_wrôe
;

3022 
f
;

3024 
m≠_c⁄ãxt
 = 
	`dm_≥r_bio_d©a
(
bio
, 
ti
->
≥r_bio_d©a_size
);

3026 if(
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
background_gc_⁄
)){

3027 
	`©omic_£t
(&
su≥r
->
migøã_mgr
.
background_gc_⁄
, 0);

3030 
is_wrôe
 = 
	`bio_d©a_dú
(
bio
);

3031 
key
 = 
	`ˇlc_ˇche_Æignmít
(
su≥r
, 
bio
->
bi_£˘‹
);

3034 if(
bio
){

3035 if(
is_wrôe
){

3036 
	`¥ötk
(" wrôe: m≠ biÿ£˘‹ = %d cou¡ = %d \n", ()
bio
->
bi_£˘‹
, ()bio->
bi_size
);

3038 
	`¥ötk
("Ñód: m≠ biÿ£˘‹ = %d cou¡ = %d \n", ()
bio
->
bi_£˘‹
, ()bio->
bi_size
);

3043 
	`LOCK
(
su≥r
, 
f
);

3044 
mb
 = 
	`ht_lookup
(
su≥r
, 
key
);

3045 i‡(
mb
) {

3046 
£g
 = 
	`gë_£gmít_hódî_by_mb_idx
(
su≥r
, 
mb
->
idx
);

3049 
	`upd©e_°©
(
su≥r
, 
mb
, 
is_wrôe
);

3053 
ªs
 = 
	`¥ïro˚ss_≥ndög_bio
(
su≥r
, 
£g
, 
bio
, 
mb
, 
is_wrôe
);

3054 if(
ªs
 &&Ñe†< 
RES_BYPASS
)

3055 
≥ndög_¥o˚ss
;

3056 if(
ªs
 =
RES_BYPASS
)

3057 
by∑ss_¥o˚ss
;

3059 if(
su≥r
->
∑øm
.
íabÀ_ªad_ˇche
){

3060 
	`•ö_lock_úqßve
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3061 
 
 = 
	`CACHE_SEARCH
(
˛ón_ˇche
, 
key
);

3062 if(
 
){

3063 if(
mb
)

3064 
	`¥ötk
(" WARN: hit in both SSDánd DRAM \n");

3066 if(
is_wrôe
){

3067 if(
	`©omic_ªad
(&
 
->
locked
)){

3069 
ªs
 = 
RES_DRAM
;

3071 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3072 
≥ndög_¥o˚ss
;

3076 
 
 = 
	`CACHE_REMOVE
(
˛ón_ˇche
,Ün);

3077 if(
	`©omic_ªad
(&
 
->
£Æed
)){

3078 
	`©omic_dec
(&
˛ón_ˇche
->
cm_£Æed_cou¡
);

3080 
	`li°_add
(&
 
->
˙_li°
, &
˛ón_ˇche
->
cm_‰ì_hód
);

3082 if(!
	`©omic_ªad
(&
 
->
£Æed
)||©omic_ªad(& ->
locked
)){

3083 
ªs
 = 
RES_DRAM
;

3084 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3085 
≥ndög_¥o˚ss
;

3088 
 
 = 
	`CACHE_REMOVE
(
˛ón_ˇche
,Ün);

3089 
	`CACHE_INSERT
(
˛ón_ˇche
, 
 
);

3090 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3091 
	`UNLOCK
(
su≥r
, 
f
);

3093 
	`bio_ídio
(
bio
, 0);

3094  
DM_MAPIO_SUBMITTED
;

3098 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3101 i‡(!
is_wrôe
) {

3103  
	`¥o˚ss_ªad_ªque°
(
su≥r
, 
£g
, 
mb
, 
bio
, 
key
, 
f
);

3116 
m≠_c⁄ãxt
->
öÊight
 = 1;

3117 
	`©omic_öc
(&
su≥r
->
ˇche_°©
.
öÊight_ios
);

3118 
	`©omic_öc
(&
su≥r
->
ˇche_°©
.
tŸÆ_ios
);

3121 i‡(
mb
) {

3122 
	`BUG_ON
(
£g
->
£g_ty≥
==
GRBUF
&&!
	`ã°_bô
(
MB_SEAL
, &
mb
->
mb_Êags
));

3123 
	`övÆid©e_¥evious_ˇche
(
su≥r
, 
£g
, 
mb
);

3135  
	`¥o˚ss_wrôe_ªque°
(
su≥r
, 
bio
, 
	`bio_∑ge
(bio), 
key
, 1, 
f
, 
WCBUF
, 
m≠_c⁄ãxt
->
¸c32
);

3137 
	`bio_ídio
(
bio
, 0);

3141 
≥ndög_¥o˚ss
:

3142 
	`UNLOCK
(
su≥r
, 
f
);

3143  -
ªs
;

3145 
by∑ss_¥o˚ss
:

3146 
	`UNLOCK
(
su≥r
, 
f
);

3147 
	`bio_ªm≠
(
bio
, 
su≥r
->
dev_öfo
.
‹igö_dev
, bio->
bi_£˘‹
);

3148 
	`gíîic_make_ªque°
(
bio
);

3149  
DM_MAPIO_SUBMITTED
;

3150 
	}
}

3152 
	$≥ndög_bio_add
(
dm§c_su≥r
 *
su≥r
, 
bio
 *bio){

3153 
≥ndög_m™agî
 *
≥ndög_mgr
 = &
su≥r
->pending_mgr;

3154 
f
;

3156 
time•ec
 
ts
;

3159 
	`•ö_lock_úqßve
(&
≥ndög_mgr
->
lock
, 
f
);

3161 
	`bio_li°_add
(&
≥ndög_mgr
->
bios
, 
bio
);

3162 
	`©omic64_öc
(&
≥ndög_mgr
->
io_cou¡
);

3164 if(
	`bio_d©a_dú
(
bio
)){

3166 
	`gën°imeofday
(&
ts
);

3167 
≥ndög_mgr
->
¨rivÆ_times
[
	`©omic_ªad
(&≥ndög_mgr->
¨rivÆ_cur
)].
tv_£c
 = 
ts
.tv_sec;

3168 
≥ndög_mgr
->
¨rivÆ_times
[
	`©omic_ªad
(&≥ndög_mgr->
¨rivÆ_cur
)].
tv_n£c
 = 
ts
.tv_nsec;

3170 
	`©omic_öc
(&
≥ndög_mgr
->
¨rivÆ_cou¡
);

3172 if(
	`©omic_öc_ªtu∫
(&
≥ndög_mgr
->
¨rivÆ_cur
)==
STRIPE_SZ
){

3173 
	`©omic_£t
(&
≥ndög_mgr
->
¨rivÆ_cur
, 0);

3176 if(
	`©omic_ªad
(&
≥ndög_mgr
->
¨rivÆ_cur
)=˜tomic_ªad(&≥ndög_mgr->
¨rivÆ_°¨t
)){

3177 if(
	`©omic_öc_ªtu∫
(&
≥ndög_mgr
->
¨rivÆ_°¨t
)==
STRIPE_SZ
){

3178 
	`©omic_£t
(&
≥ndög_mgr
->
¨rivÆ_°¨t
, 0);

3186 
	`•ö_u∆ock_úqª°‹e
(&
≥ndög_mgr
->
lock
, 
f
);

3187 
	}
}

3189 
boﬁ
 
	$≥ndög_bio_em±y
(
dm§c_su≥r
 *
su≥r
){

3190 
≥ndög_m™agî
 *
≥ndög_mgr
 = &
su≥r
->pending_mgr;

3191 
em±y
 = 0;

3192 
f
;

3194 
	`•ö_lock_úqßve
(&
≥ndög_mgr
->
lock
, 
f
);

3195 if(
	`bio_li°_em±y
(&
≥ndög_mgr
->
bios
))

3196 
em±y
 = 1;

3197 
	`•ö_u∆ock_úqª°‹e
(&
≥ndög_mgr
->
lock
, 
f
);

3199 
	`•ö_lock_úqßve
(&
≥ndög_mgr
->
b¨rõr_lock
, 
f
);

3200 if(
	`bio_li°_em±y
(&
≥ndög_mgr
->
b¨rõr_ios
))

3201 
em±y
 += 1;

3203 
	`•ö_u∆ock_úqª°‹e
(&
≥ndög_mgr
->
b¨rõr_lock
, 
f
);

3206 if(
em±y
==2)

3210 
	}
}

3212 
	$≥ndög_w‹kî_scheduÀ
(
dm§c_su≥r
 *
su≥r
){

3213 if(
	`©omic64_ªad
(&
su≥r
->
≥ndög_mgr
.
io_cou¡
) ||

3214 
	`©omic_ªad
(&
su≥r
->
˛ón_døm_ˇche_m™agî
->
cm_£Æed_cou¡
)){

3215 
	`queue_w‹k
(
su≥r
->
≥ndög_mgr
.
wq
, &su≥r->≥ndög_mgr.
w‹k
);

3217 
	}
}

3219 
	$√ed_˛ón_£g_wrôe
(
dm§c_su≥r
 *
su≥r
){

3220 
ˇche_m™agî
 *
˛ón_ˇche
 = 
su≥r
->
˛ón_døm_ˇche_m™agî
;

3222 if(!
su≥r
->
∑øm
.
íabÀ_ªad_ˇche
)

3225 if((
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
£g_Æloc_cou¡
)<=

3226 
MIGRATE_HIGHWATER
 - (MIGRATE_HIGHWATER - 
MIGRATE_LOWWATER
)/2

3227 ||
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
group_Æloc_cou¡
)<=2)

3228 && 
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
)){

3234 if(
	`©omic_ªad
(&
˛ón_ˇche
->
cm_£Æed_cou¡
)>=
STRIPE_SZ
){

3239 
	}
}

3241 
	$˛ón_£g_wrôe
(
dm§c_su≥r
 *
su≥r
, 
√ed_cou¡
, 
ˇche_ty≥
){

3242 
ˇche_m™agî
 *
˛ón_ˇche
 = 
su≥r
->
˛ón_døm_ˇche_m™agî
;

3243 
Ãu_node
 *
 
, *
ãmp
;

3244 
li°_hód
 
˛ón_£g_hód
;

3245 
£gmít_hódî
 *
£g
;

3246 
mëablock
 *
mb
;

3247 
Êags
;

3248 
Ãu_Êags
;

3249 
cou¡
 = 0;

3252 if(
STRIPING_POLICY
==
MIXED_STRIPING
){

3253 
ˇche_ty≥
 = 
WCBUF
;

3254 
√ed_cou¡
 = 
	`gë_d©a_max_cou¡
(
su≥r
, 
WCBUF
);

3256 
ˇche_ty≥
 = 
RCBUF
;

3257 
√ed_cou¡
 = 
	`gë_d©a_max_cou¡
(
su≥r
, 
RCBUF
);

3259 if(
su≥r
->
cuºít_group
 && 
	`©omic_ªad
(&su≥r->cuºít_group->
‰ì_£g_cou¡
)==0){

3260 if(!
	`should_√ed_ª‰esh_£g
(
su≥r
, 
WCBUF
) &&

3261 
	`should_√ed_ª‰esh_£g
(
su≥r
, 
RCBUF
)){

3262 
ˇche_ty≥
 = 
WCBUF
;

3263 
√ed_cou¡
 = 
	`ma_gë_‰ì
(
su≥r
, 
WCBUF
);

3264 
	`¥ötk
(" * cÀ™ seg wrôe:Çìd fû»WCBUF wôh dummy ... cou¡ = %d \n", 
√ed_cou¡
);

3270 
	`INIT_LIST_HEAD
(&
˛ón_£g_hód
);

3272 
	`LOCK
(
su≥r
, 
Êags
);

3273 
	`•ö_lock_úqßve
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3274 
	`li°_f‹_óch_íåy_ß„
(
 
, 
ãmp
, &
˛ón_ˇche
->
cm_hód
, 
˙_li°
){

3275 if(
	`©omic_ªad
(&
 
->
£Æed
)){

3277 
	`©omic_£t
(&
 
->
locked
, 1);

3278 
	`li°_add_èû
(&
 
->
˙_wrôe_li°
, &
˛ón_£g_hód
);

3280 if(++
cou¡
==
√ed_cou¡
)

3283 
cou¡
++;

3288 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3289 
	`UNLOCK
(
su≥r
, 
Êags
);

3291 if(
cou¡
!=
√ed_cou¡
)

3292 
	`¥ötk
("˛ó¿d©®cou¡ = %d,Çìd cou¡ = %d \n", 
cou¡
, 
√ed_cou¡
 );

3296 
	`li°_f‹_óch_íåy_ß„
(
 
, 
ãmp
, &
˛ón_£g_hód
, 
˙_wrôe_li°
){

3297 
	`LOCK
(
su≥r
, 
Êags
);

3298 if(
	`should_√ed_ª‰esh_£g
(
su≥r
, 
ˇche_ty≥
)){

3299 
RETRY
:

3301 if(
	`åy_waô_‰ì_£g
(
su≥r
, 
ˇche_ty≥
)){

3302 
	`UNLOCK
(
su≥r
, 
Êags
);

3304 
	`¥ötk
(" clean_seg_write:Ço more free group = %d segs %d, migrate = %dÑam buf ...%d \n",

3305 
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
group_Æloc_cou¡
),

3306 
	`©omic_ªad
(&
su≥r
->
£g_Æloˇt‹
.
£g_Æloc_cou¡
),

3307 
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
),

3308 
	`©omic_ªad
(&
su≥r
->
£gbuf_mgr
.
öa˘ive_∑ge_cou¡
));

3309 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

3310 
	`LOCK
(
su≥r
, 
Êags
);

3311 
RETRY
;

3316 
mb
 = 
	`ht_lookup
(
su≥r
, 
 
->
˙_blkno
);

3317 i‡(
mb
) {

3318 
£g
 = 
	`gë_£gmít_hódî_by_mb_idx
(
su≥r
, 
mb
->
idx
);

3320 
	`¥ötk
(" WARN: clean write data hit in seg = %d idx = %d(dirty=%d, valid= %d,Åype = %d \n",

3321 ()
£g
->
£g_id
, 
mb
->
idx
,

3322 
	`ã°_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
),

3323 
	`ã°_bô
(
MB_VALID
, &
mb
->
mb_Êags
),

3324 
£g
->
£g_ty≥
);

3326 
	`övÆid©e_¥evious_ˇche
(
su≥r
, 
£g
, 
mb
);

3329 
	`¥o˚ss_wrôe_ªque°
(
su≥r
, 
NULL
, 
 
->
˙_∑ge
,Ün->
˙_blkno
, 0, 
Êags
, 
ˇche_ty≥
,Ün->
¸c32
);

3335 if(
STRIPING_POLICY
!=
MIXED_STRIPING
 && !
	`should_√ed_ª‰esh_£g
(
su≥r
, 
ˇche_ty≥
)){

3336 
	`¥ötk
(" WARN: cÀ™ såùêi†nŸ fuŒy fûÀd wôh cÀ™ d©®%d \n", 
	`ma_gë_cou¡
(
su≥r
, 
ˇche_ty≥
));

3340 
	`LOCK
(
su≥r
, 
Êags
);

3341 
	`•ö_lock_úqßve
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3342 
	`li°_f‹_óch_íåy_ß„
(
 
, 
ãmp
, &
˛ón_£g_hód
, 
˙_wrôe_li°
){

3343 
	`CACHE_REMOVE
(
˛ón_ˇche
, 
 
);

3344 
	`©omic_dec
(&
˛ón_ˇche
->
cm_£Æed_cou¡
);

3345 
	`li°_add
(&
 
->
˙_li°
, &
˛ón_ˇche
->
cm_‰ì_hód
);

3346 
	`li°_dñ
(&
 
->
˙_wrôe_li°
);

3347 
	`©omic_£t
(&
 
->
locked
, 0);

3351 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3352 
	`UNLOCK
(
su≥r
, 
Êags
);

3354  
cou¡
;

3355 
	}
}

3357 
	$åy_˛ón_£g_wrôe
(
dm§c_su≥r
 *
su≥r
){

3359 
˛ón_wrôe_cou¡
;

3360 
tŸÆ_wrôe_cou¡
 = 0;

3361 
ˇche_ty≥
;

3363 if(
	`√ed_˛ón_£g_wrôe
(
su≥r
Ë&& su≥r->
∑øm
.
íabÀ_ªad_ˇche
){

3364 
¥o˚ss_cou¡
;

3368 if(
STRIPING_POLICY
==
MIXED_STRIPING
)

3369 
ˇche_ty≥
 = 
WCBUF
;

3371 
ˇche_ty≥
 = 
RCBUF
;

3373 
˛ón_wrôe_cou¡
 = 
	`gë_d©a_max_cou¡
(
su≥r
, 
ˇche_ty≥
);

3375 if(
su≥r
->
cuºít_group
 && 
	`©omic_ªad
(&su≥r->cuºít_group->
‰ì_£g_cou¡
)==0){

3376 if(!
	`should_√ed_ª‰esh_£g
(
su≥r
, 
WCBUF
) &&

3377 
	`should_√ed_ª‰esh_£g
(
su≥r
, 
RCBUF
)){

3378 
ˇche_ty≥
 = 
WCBUF
;

3379 
˛ón_wrôe_cou¡
 = 
	`ma_gë_‰ì
(
su≥r
, 
WCBUF
);

3384 
¥o˚ss_cou¡
 = 
	`˛ón_£g_wrôe
(
su≥r
, 
˛ón_wrôe_cou¡
, 
ˇche_ty≥
);

3385 if(
¥o˚ss_cou¡
 !
˛ón_wrôe_cou¡
){

3388 
tŸÆ_wrôe_cou¡
 +
˛ón_wrôe_cou¡
;

3395  
tŸÆ_wrôe_cou¡
;

3396 
	}
}

3398 
	$gë_∑πül_£g_Àngth
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
){

3399 
f
;

3400 
ømbuf„r
 *
ømbuf
;

3401 
Àngth
;

3403 
	`LOCK
(
su≥r
, 
f
);

3404 
ømbuf
 = 
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[
ˇche_ty≥
];

3405 if(!
ømbuf
)

3406 
Àngth
 = 0;

3408 
Àngth
 = 
	`©omic_ªad
(&
ømbuf
->
bios_tŸÆ_cou¡
Ë-átomic_ªad(&ømbuf->
bios_tŸÆ_°¨t
);

3409 
	`UNLOCK
(
su≥r
, 
f
);

3411  
Àngth
;

3412 
	}
}

3414 
	$≥ndög_w‹kî
(
w‹k_°ru˘
 *
w‹k
){

3415 
≥ndög_m™agî
 *
≥ndög_mgr
 =

3416 
	`c⁄èöî_of
(
w‹k
, 
≥ndög_m™agî
,

3417 
w‹k
);

3418 
dm§c_su≥r
 *
su≥r
 = 
≥ndög_mgr
->super;

3419 
bio_li°
 
loˇl_li°
;

3420 
bio
 *bio;

3421 
f
;

3422 
ªåy_ªas⁄s
[
RES_COUNT
];

3423 
loˇl_cou¡
 = 0;

3424 
i
;

3425 
is_wrôe
 = 0;

3426 
˛ón_wrôe_cou¡
 = 0;

3428 
i
=0;i<
RES_COUNT
;i++){

3429 
ªåy_ªas⁄s
[
i
] = 0;

3432 
	`bio_li°_öô
(&
loˇl_li°
);

3435 
ªas⁄
;

3437 
	`•ö_lock_úqßve
(&
≥ndög_mgr
->
lock
, 
f
);

3438 
bio
 = 
	`bio_li°_p›
(&
≥ndög_mgr
->
bios
);

3439 if(
bio
)

3440 
	`©omic64_dec
(&
≥ndög_mgr
->
io_cou¡
);

3441 
	`•ö_u∆ock_úqª°‹e
(&
≥ndög_mgr
->
lock
, 
f
);

3443 if(!
bio
)

3446 if(
	`bio_d©a_dú
(
bio
))

3447 
is_wrôe
 = 1;

3449 
ªas⁄
 = 
	`m≠_≥ndög_bio
(
su≥r
, 
bio
);

3450 if(
ªas⁄
<0){

3451 
	`bio_li°_add
(&
loˇl_li°
, 
bio
);

3452 
loˇl_cou¡
++;

3453 
ªåy_ªas⁄s
[
ªas⁄
*-1]++;

3456 
	`bio_ídio
(
bio
, 0);

3459 
˛ón_wrôe_cou¡
 +
	`åy_˛ón_£g_wrôe
(
su≥r
);

3462 
˛ón_wrôe_cou¡
 +
	`åy_˛ón_£g_wrôe
(
su≥r
);

3464 if(
loˇl_cou¡
){

3470 
	`•ö_lock_úqßve
(&
≥ndög_mgr
->
lock
, 
f
);

3471 
	`bio_li°_mîge
(&
≥ndög_mgr
->
bios
, &
loˇl_li°
);

3472 
i
=0;i<
loˇl_cou¡
;i++){

3473 
	`©omic64_öc
(&
≥ndög_mgr
->
io_cou¡
);

3475 
	`•ö_u∆ock_úqª°‹e
(&
≥ndög_mgr
->
lock
, 
f
);

3480 if(
˛ón_wrôe_cou¡
 || (!
loˇl_cou¡
 && 
is_wrôe
) ||

3481 (
ªåy_ªas⁄s
[
RES_SEAL
] && 
	`gë_∑πül_£g_Àngth
(
su≥r
, 
WCBUF
))){

3483 
	`upd©e_sync_dódlöe
(
su≥r
);

3493 
	}
}

3496 
	$dm§c_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

3498 
£gmít_hódî
 *
	`unöôülized_v¨
(
£g
);

3499 
bio_˘x
 *
m≠_c⁄ãxt
;

3500 
£˘‹_t
 
bio_cou¡
;

3501 
boﬁ
 
bio_fuŒsize
;

3502 
dm§c_su≥r
 *
su≥r
 = 
ti
->
¥iv©e
;

3503 
≥ndög_m™agî
 *
≥ndög_mgr
 = &
su≥r
->pending_mgr;

3504 #i‚de‡
USE_PENDING_WORKER


3505 
ªt
 = 0;

3508 
m≠_c⁄ãxt
 = 
	`dm_≥r_bio_d©a
(
bio
, 
ti
->
≥r_bio_d©a_size
);

3509 
m≠_c⁄ãxt
->
±r
 = 
NULL
;

3510 
m≠_c⁄ãxt
->
öÊight
 = 0;

3512 i‡(
bio
->
bi_rw
 & 
REQ_DISCARD
) {

3513 
dm_dev
 *
‹igö_dev
 = 
su≥r
->
dev_öfo
.origin_dev;

3514 
	`bio_ªm≠
(
bio
, 
‹igö_dev
, bio->
bi_£˘‹
);

3515 
	`¥ötk
(" WARN: discard command ... \n");

3516  
DM_MAPIO_REMAPPED
;

3520 i‡(
bio
->
bi_rw
 & 
REQ_FLUSH
) {

3522 
	`BUG_ON
(
bio
->
bi_size
);

3523 
	`bio_ídio
(
bio
, 0);

3524  
DM_MAPIO_SUBMITTED
;

3526 
	`queue_b¨rõr_io
(
su≥r
, 
bio
);

3527 
	`upd©e_sync_dódlöe
(
su≥r
);

3528  
DM_MAPIO_SUBMITTED
;

3534 
bio
->
bi_rw
 &~
REQ_SYNC
;

3535 
bio_cou¡
 = 
bio
->
bi_size
 >> 
SECTOR_SHIFT
;

3536 
bio_fuŒsize
 = (
bio_cou¡
 == (1 << 3));

3538 if(!
bio_fuŒsize
)

3539 
	`¥ötk
(" biÿcou¡ = %d se˘‹†\n", ()
bio_cou¡
);

3541 
	`wp_upd©e
(
su≥r
, 
	`bio_d©a_dú
(
bio
), 
REQ_CATEGORY_NORMAL
);

3543 
m≠_c⁄ãxt
->
£q_io
 = 
Ál£
;

3544 #i‡
	`deföed
(
CONFIG_BCACHE
Ë|| deföed(
CONFIG_BCACHE_MODULE
)

3545 
m≠_c⁄ãxt
->
£q_io
 = 
	`dëe˘_£quítül_io
(
su≥r
, 
bio
);

3549 if((
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_VERT
 ||

3550 
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_HORI
)){

3551 if(
	`bio_d©a_dú
(
bio
)){

3558 if(
m≠_c⁄ãxt
->
£q_io
){

3559 
	`©omic_öc
(&
su≥r
->
w°©
.
by∑ss_wrôe_cou¡
);

3562 if(
	`bio_d©a_dú
(
bio
)){

3563 *
±r
 = 
	`km≠_©omic
(
	`bio_∑ge
(
bio
));

3564 
m≠_c⁄ãxt
->
¸c32
 = 
	`¸c32
(17, 
±r
, 
PAGE_SIZE
);

3565 
	`kunm≠_©omic
(
±r
);

3568 
m≠_c⁄ãxt
->
hŸ_io
 = 0;

3570 if(
su≥r
->
∑øm
.
hŸ_idítifiˇti⁄
){

3571 if(!
m≠_c⁄ãxt
->
£q_io
){

3572 
∑gío
 = 
	`ˇlc_ˇche_Æignmít
(
su≥r
, 
bio
->
bi_£˘‹
);

3573 
	`hŸ_fûãr_upd©e
(
su≥r
, 
bio
->
bi_£˘‹
);

3574 
m≠_c⁄ãxt
->
hŸ_io
 = 
	`hŸ_fûãr_check
(
su≥r
, 
∑gío
);

3577 
m≠_c⁄ãxt
->
hŸ_io
 = 1;

3581 if(!
	`bio_d©a_dú
(
bio
)){

3582 
mëablock
 *
mb
 = 
NULL
;

3583 
£gmít_hódî
 *
£g
 = 
NULL
;

3584 
f
;

3585 
ªt
;

3587 
£˘‹_t
 
key
 = 
	`ˇlc_ˇche_Æignmít
(
su≥r
, 
bio
->
bi_£˘‹
);

3589 
	`LOCK
(
su≥r
, 
f
);

3590 
mb
 = 
	`ht_lookup
(
su≥r
, 
key
);

3591 i‡(!
mb
) {

3592 if(
su≥r
->
∑øm
.
íabÀ_ªad_ˇche
){

3593 
ˇche_m™agî
 *
˛ón_ˇche
 = 
su≥r
->
˛ón_døm_ˇche_m™agî
;

3594 
Ãu_Êags
;

3595 
Ãu_node
 *
 
 = 
NULL
;

3597 
	`•ö_lock_úqßve
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3598 
 
 = 
	`CACHE_SEARCH
(
˛ón_ˇche
, 
key
);

3599 if(
 
 && 
	`©omic_ªad
(& ->
£Æed
Ë&& !©omic_ªad(& ->
locked
)){

3600 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3601 
	`UNLOCK
(
su≥r
, 
f
);

3602 
	`bio_ídio
(
bio
, 0);

3603  
DM_MAPIO_SUBMITTED
;

3604 }if(!
 
){

3605 if(
˛ón_ˇche
->
cm_‰ì
){

3606 
 
 = 
	`CACHE_ALLOC
(
˛ón_ˇche
,Ün, 
key
);

3607 
	`CACHE_INSERT
(
˛ón_ˇche
, 
 
);

3608 
	`©omic_£t
(&
 
->
£Æed
, 0);

3609 
	`©omic_£t
(&
 
->
locked
, 0);

3610 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3611  
	`¥o˚ss_ªad_miss_ªque°
(
su≥r
, 
bio
, 
f
);

3614 
	`•ö_u∆ock_úqª°‹e
(&
˛ón_ˇche
->
lock
, 
Ãu_Êags
);

3618 
£g
 = 
	`gë_£gmít_hódî_by_mb_idx
(
su≥r
, 
mb
->
idx
);

3619 
ªt
 = 
	`¥ïro˚ss_≥ndög_bio
(
su≥r
, 
£g
, 
bio
, 
mb
, 0);

3620 if(
ªt
==0){

3621 
	`upd©e_°©
(
su≥r
, 
mb
, 0);

3622 
	`¥o˚ss_ªad_hô_ªque°
(
su≥r
, 
bio
, 
£g
, 
mb
, 
f
);

3623  
DM_MAPIO_SUBMITTED
;

3627 
	`UNLOCK
(
su≥r
, 
f
);

3631 #ifde‡
USE_PENDING_WORKER


3633 
	`≥ndög_bio_add
(
su≥r
, 
bio
);

3634 
	`queue_w‹k
(
≥ndög_mgr
->
wq
, &≥ndög_mgr->
w‹k
);

3637 if(!
	`©omic64_ªad
(&
≥ndög_mgr
->
io_cou¡
)){

3638 
ªt
 = 
	`m≠_≥ndög_bio
(
su≥r
, 
bio
);

3639 if(
ªt
<0){

3640 
	`≥ndög_bio_add
(
su≥r
, 
bio
);

3641 
	`queue_w‹k
(
≥ndög_mgr
->
wq
, &≥ndög_mgr->
w‹k
);

3644 
	`≥ndög_bio_add
(
su≥r
, 
bio
);

3645 
	`queue_w‹k
(
≥ndög_mgr
->
wq
, &≥ndög_mgr->
w‹k
);

3649  
DM_MAPIO_SUBMITTED
;

3650 
	}
}

3653 
	$do_background_gc
(
dm§c_su≥r
 *
su≥r
){

3654 
migøti⁄_m™agî
 *
migøã_mgr
 = &
su≥r
->migrate_mgr;

3656 
migøã_mgr
->
Ælow_migøã
 = 1;

3657 
	`©omic_£t
(&
migøã_mgr
->
background_gc_⁄
, 1);

3658 if(!
	`©omic_ªad
(&
migøã_mgr
->
migøã_åiggîed
)){

3659 
	`©omic_£t
(&
migøã_mgr
->
migøã_åiggîed
, 1);

3660 
	`wake_up_¥o˚ss
(
migøã_mgr
->
d´m⁄
);

3662 
	}
}

3664 
	$do_grow
(
dm§c_su≥r
 *
su≥r
){

3666 
i
;

3667 
‹g_ˇches
 = 
NUM_SSD
;

3668 
‹g_°rùe_sz
 = 
STRIPE_SZ
;

3669 
ømbuf„r
 *
ømbuf
[
NBUF
];

3670 
£gmít_hódî
 *
£gs
[
NBUF
];

3671 
£gmít_hódî
 *
£g
;

3672 
group_hódî
 *
group
;

3673 
f
;

3674 
œrge_¨øy
 *
mëablock_¨øy
;

3676 if(!
su≥r
->
dev_öfo
.
num_•¨e_ˇche_devs
){

3677 
	`¥ötk
(" No more drive for growing \n");

3680 
	`©omic_£t
(&
su≥r
->
ªsize_mode
, 1);

3682 
	`©omic_ªad
(&
su≥r
->
ˇche_°©
.
öÊight_ios
)){

3683 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

3686 
su≥r
->
migøã_mgr
.
Ælow_migøã
 = 0;

3688 
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
mig_öÊights
)){

3689 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

3692 
	`©omic_ªad
(&
su≥r
->
Êush_mgr
.
övoke_cou¡
)){

3693 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

3696 
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
))

3697 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

3699 
	`©omic64_ªad
(&
su≥r
->
≥ndög_mgr
.
io_cou¡
))

3700 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

3702 
	`LOCK
(
su≥r
, 
f
);

3703 
i
 = 0;ò< 
NBUF
-1;i++){

3704 if(
su≥r
->
cuºít_£g
[
i
] && 
	`©omic_ªad
(&su≥r->cuºít_£g[i]->
Àngth
)){

3705 
£gs
[
i
] = 
su≥r
->
cuºít_£g
[i];

3706 
ømbuf
[
i
] = 
su≥r
->
£gbuf_mgr
.
cuºít_ømbuf
[i];

3708 
£gs
[
i
] = 
NULL
;

3709 
ømbuf
[
i
] = 
NULL
;

3712 
	`UNLOCK
(
su≥r
, 
f
);

3714 
i
 = 0;ò< 
NBUF
-1;i++){

3715 if(
£gs
[
i
]){

3716 
	`¥ötk
(" makêÊush job segÅy≥ = %d, seg id %dÜígth = %d \n", 
i
, ()
£gs
[i]->
£g_id
, ()
	`©omic_ªad
(&£gs[i]->
Àngth
));

3721 
	`©omic_ªad
(&
su≥r
->
Êush_mgr
.
övoke_cou¡
)){

3722 
Êush_övoke_job
 *
job
;

3723 
£gmít_hódî
 *
£g
;

3724 
Êags
;

3725 
	`•ö_lock_úqßve
(&
su≥r
->
Êush_mgr
.
lock
, 
Êags
);

3726 
	`li°_f‹_óch_íåy
(
job
, &
su≥r
->
Êush_mgr
.
queue
, 
li°
){

3727 
£g
 = 
job
->seg;

3728 
	`¥ötk
(" makêÊush job segÅy≥ = %d, seg id %dÜígth = %d \n", 
£g
->
£g_ty≥
, ()£g->
£g_id
, ()
	`©omic_ªad
(&£g->
Àngth
));

3730 
	`•ö_u∆ock_úqª°‹e
(&
su≥r
->
Êush_mgr
.
lock
, 
Êags
);

3732 
	`¥ötk
(" flush queuêcou¡ = %d \n", ()
	`©omic_ªad
(&
su≥r
->
Êush_mgr
.
övoke_cou¡
));

3733 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

3736 
	`¥ötk
(" Resizing metadata ... \n");

3738 
i
 = 0;ò< 
NBUF
-1;i++){

3739 if(
£gs
[
i
]){

3740 
	`¥ötk
(" ch™gê°©u†£gÅy≥ = %d, seg id %dÜígth = %d \n", 
i
, ()
£gs
[i]->
£g_id
, ()
	`©omic_ªad
(&£gs[i]->
Àngth
));

3742 
£g
 = 
£gs
[
i
];

3743 
	`ch™ge_£g_°©us
(
su≥r
, 
£g
, 
	`©omic_ªad
(&£g->
Àngth
), 1);

3747 
	`¥ötk
(" metablockálloc \n");

3748 
mëablock_¨øy
 =

3749 
	`œrge_¨øy_Æloc
((
mëablock
), 
NUM_BLOCKS_PER_SSD
);

3750 i‡(!
mëablock_¨øy
) {

3751 
	`WBERR
();

3755 
	`LOCK
(
su≥r
, 
f
);

3757 
su≥r
->
dev_öfo
.
ˇche_dev
[
NUM_SSD
] = su≥r->dev_öfo.
•¨e_ˇche_dev
[0];

3758 
NUM_SSD
++;

3760 
group
 = 
su≥r
->
cuºít_group
;

3761 if(
group
){

3762 
	`©omic_£t
(&
group
->
num_u£d_ssd
, 
NUM_SSD
);

3765 
i
 = 0;ò< 
su≥r
->
dev_öfo
.
num_•¨e_ˇche_devs
-1;i++){

3766 
su≥r
->
dev_öfo
.
•¨e_ˇche_dev
[
i
] = super->dev_info.spare_cache_dev[i+1];

3768 
su≥r
->
dev_öfo
.
•¨e_ˇche_dev
[
i
] = 
NULL
;

3769 
su≥r
->
dev_öfo
.
num_•¨e_ˇche_devs
--;

3770 
	`¥ötk
(" Num S∑ª SSD†%d \n", 
su≥r
->
dev_öfo
.
num_•¨e_ˇche_devs
);

3773 
su≥r
->
mëablock_¨øy
[
NUM_SSD
-1] =

3774 
	`œrge_¨øy_Æloc
((
mëablock
), 
NUM_BLOCKS_PER_SSD
);

3775 i‡(!
su≥r
->
mëablock_¨øy
[
NUM_SSD
-1]) {

3776 
	`WBERR
();

3780 
su≥r
->
mëablock_¨øy
[
NUM_SSD
-1] = metablock_array;

3783 
	`¥ötk
(" init meta block ... \n");

3784 
i
 = 0; i < 
NUM_BLOCKS
; i++) {

3785 
mëablock
 *
mb
 = 
	`mb_©
(
su≥r
, 
i
);

3786 
ssdno
 = 
	`gë_devno
(
su≥r
, 
i
);

3788 
mb
->
idx
 = 
i
;

3790 if(
ssdno
 =
NUM_SSD
-1){

3791 
	`INIT_HLIST_NODE
(&
mb
->
ht_li°
);

3792 
	`˛ór_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
);

3793 
	`˛ór_bô
(
MB_VALID
, &
mb
->
mb_Êags
);

3794 
	`˛ór_bô
(
MB_SEAL
, &
mb
->
mb_Êags
);

3795 
	`˛ór_bô
(
MB_PARITY
, &
mb
->
mb_Êags
);

3796 
	`˛ór_bô
(
MB_BROKEN
, &
mb
->
mb_Êags
);

3797 
	`˛ór_bô
(
MB_SUMMARY
, &
mb
->
mb_Êags
);

3798 
	`˛ór_bô
(
MB_PARITY_NEED
, &
mb
->
mb_Êags
);

3799 
	`˛ór_bô
(
MB_PARITY_WRITTEN
, &
mb
->
mb_Êags
);

3800 
	`˛ór_bô
(
MB_HIT
, &
mb
->
mb_Êags
);

3801 
	`˛ór_bô
(
MB_SKIP
, &
mb
->
mb_Êags
);

3802 
	`˛ór_bô
(
MB_DUMMY
, &
mb
->
mb_Êags
);

3803 
	`hli°_add_hód
(&
mb
->
ht_li°
, &
su≥r
->
nuŒ_hód
->ht_list);

3807 if(
	`USE_ERASURE_CODE
(&
su≥r
->
∑øm
))

3808 
	`øid_c⁄f_öô
(
su≥r
, &su≥r->
øid_c⁄f
);

3810 
i
 = 0;ò< 
NBUF
;i++){

3811 
	`Æloc_ømbuf_∑ge
(
su≥r
, su≥r->
£gbuf_mgr
.
cuºít_ømbuf
[
i
], i);

3815 
i
 = 0;ò< 
NBUF
-1;i++){

3816 if(
£gs
[
i
]){

3817 
	`¥ötk
("áŒo¯√w segmíà... %d \n", 
i
);

3818 
	`Æloc_√w_£gmít
(
su≥r
, 
i
, 
Ál£
);

3820 
	`¥ötk
(" m®öô ... %d \n", 
i
);

3821 if(
su≥r
->
cuºít_£g
[
i
]) {

3822 
	`¥ötk
(" maÑeset .. \n");

3823 
	`ma_ª£t
(
su≥r
, su≥r->
cuºít_£g
[
i
]->
£g_id
, i);

3825 
	`¥ötk
(" m®öô ... %d \n", 
i
);

3829 
	`¥ötk
("ássigneÇew segment .. \n");

3830 
	`assign_√w_£gmít
(
su≥r
);

3833 
	`UNLOCK
(
su≥r
, 
f
);

3835 
	`©omic_£t
(&
su≥r
->
ªsize_mode
, 0);

3836 
	`¥ötk
(" Growing drives is complete\n");

3837 
	`¥ötk
(" Nÿo‡ˇches: (%d->%d)\n", 
‹g_ˇches
, 
NUM_SSD
);

3838 
	`¥ötk
(" Såùêsiz : (%d->%d)\n", 
‹g_°rùe_sz
, 
STRIPE_SZ
);

3839 
	`¥öt_Æloc_queue
(
su≥r
);

3841 
	}
}

3844 
	$do_ªcovîy
(
dm§c_su≥r
 *
su≥r
){

3845 
£gmít_hódî
 *
£g
;

3846 
mëablock
 *
mb
;

3847 
Êags
;

3848 
Áûuª_ssd
 = 0;

3849 
£gno
;

3850 
off£t
;

3851 
brokí_cou¡
 = 0;

3852 
u8
 
dúty_bôs
;

3853 
u8
 
vÆid_bôs
;

3854 
u8
 
mëa_bôs
;

3855 
f
;

3857 
	`LOCK
(
su≥r
, 
f
);

3858 
su≥r
->
ªcovîy_mgr
.
Áûuª_ssd
 = failure_ssd;

3859 
	`©omic_£t
(&
su≥r
->
ªcovîy_mgr
.
brokí_block_cou¡
, 0);

3861 
£gno
 = 0;£gnÿ< 
su≥r
->
ˇche_°©
.
num_£gmíts
;segno++){

3862 
£g
 = 
	`gë_£gmít_hódî_by_id
(
su≥r
, (
u64
)
£gno
);

3864 if(!
	`ã°_bô
(
SEG_SEALED
, &
£g
->
Êags
))

3868 
off£t
=0;off£t<
CHUNK_SZ
;offset++){

3869 
u32
 
idx
 = 
Áûuª_ssd
 * 
CHUNK_SZ
 + 
off£t
;

3870 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
idx
);

3872 
	`lock£g
(
£g
, 
Êags
);

3873 
vÆid_bôs
 = 
	`ã°_bô
(
MB_VALID
, &
mb
->
mb_Êags
);

3874 
dúty_bôs
 = 
	`ã°_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
);

3875 
mëa_bôs
 = 
	`ã°_bô
(
MB_PARITY
, &
mb
->
mb_Êags
);

3876 
mëa_bôs
 = 
	`ã°_bô
(
MB_SUMMARY
, &
mb
->
mb_Êags
);

3877 
	`u∆ock£g
(
£g
, 
Êags
);

3879 if(
£g
->
£g_ty≥
==
WCBUF
){

3880 
	`£t_bô
(
SEG_RECOVERY
, &
£g
->
Êags
);

3881 
	`BUG_ON
(!
	`ã°_bô
(
SEG_SEALED
, &
£g
->
Êags
));

3882 
	`BUG_ON
(
	`ã°_bô
(
MB_BROKEN
, &
mb
->
mb_Êags
));

3883 
	`£t_bô
(
MB_BROKEN
, &
mb
->
mb_Êags
);

3884 
brokí_cou¡
++;

3885 
	`©omic_öc
(&
su≥r
->
ªcovîy_mgr
.
brokí_block_cou¡
);

3887 if(
off£t
>=
CHUNK_SZ
-
NUM_SUMMARY
)

3890 if(
	`ã°_bô
(
MB_SUMMARY
, &
mb
->
mb_Êags
))

3893 
	`övÆid©e_¥evious_ˇche
(
su≥r
, 
£g
, 
mb
);

3897 
j
 = 0;j < 
STRIPE_SZ
;j++){

3898 
mb
 = 
	`gë_mb
(
su≥r
, 
£g
->
£g_id
, 
j
);

3901 
devno
 = 
j
 / 
CHUNK_SZ
;

3903 if(
devno
!=
Áûuª_ssd
)

3906 
	`lock£g
(
£g
, 
Êags
);

3907 
vÆid_bôs
 = 
	`ã°_bô
(
MB_VALID
, &
mb
->
mb_Êags
);

3908 
dúty_bôs
 = 
	`ã°_bô
(
MB_DIRTY
, &
mb
->
mb_Êags
);

3909 
mëa_bôs
 = 
	`ã°_bô
(
MB_PARITY
, &
mb
->
mb_Êags
);

3910 
mëa_bôs
 = 
	`ã°_bô
(
MB_SUMMARY
, &
mb
->
mb_Êags
);

3911 
	`u∆ock£g
(
£g
, 
Êags
);

3917 if(
vÆid_bôs
 || 
mëa_bôs
){

3918 if(
dúty_bôs
 || 
mëa_bôs
){

3921 
	`£t_bô
(
SEG_RECOVERY
, &
£g
->
Êags
);

3922 
	`BUG_ON
(!
	`ã°_bô
(
SEG_SEALED
, &
£g
->
Êags
));

3925 
	`BUG_ON
(
	`ã°_bô
(
MB_BROKEN
, &
mb
->
mb_Êags
));

3926 
	`£t_bô
(
MB_BROKEN
, &
mb
->
mb_Êags
);

3927 
brokí_cou¡
++;

3928 
	`©omic_öc
(&
su≥r
->
ªcovîy_mgr
.
brokí_block_cou¡
);

3931 
	`övÆid©e_¥evious_ˇche
(
su≥r
, 
£g
, 
mb
);

3938 
	`UNLOCK
(
su≥r
, 
f
);

3941 if(
brokí_cou¡
){

3942 
	`©omic_£t
(&
su≥r
->
degøded_mode
, 1);

3943 
	`wake_up_¥o˚ss
(
su≥r
->
ªcovîy_mgr
.
d´m⁄
);

3947 
	`¥ötk
(" brokíÖage†%d \n", 
brokí_cou¡
);

3948 
	}
}

3950 
	$dm§c_íd_io
(
dm_èrgë
 *
ti
, 
bio
 *bio, 
îr‹
)

3952 
dm§c_su≥r
 *
su≥r
 = 
ti
->
¥iv©e
;

3953 
£gmít_hódî
 *
£g
;

3954 
bio_˘x
 *
m≠_c⁄ãxt
 =

3955 
	`dm_≥r_bio_d©a
(
bio
, 
ti
->
≥r_bio_d©a_size
);

3957 if(
m≠_c⁄ãxt
->
öÊight
){

3958 
	`©omic_dec
(&
su≥r
->
ˇche_°©
.
öÊight_ios
);

3961 i‡(!
m≠_c⁄ãxt
->
±r
)

3964 
£g
 = 
m≠_c⁄ãxt
->
±r
;

3965 
	`©omic_dec
(&
£g
->
num_ªad_öÊight
);

3969 
	}
}

3971 
	$c⁄sume_es£¡ül_¨gv
(
dm§c_su≥r
 *
su≥r
, 
¨gc
, **
¨gv
)

3973 
dm_¨g
 
_¨gs
[] = {

3975 {1, 
MAX_CACHE_DEVS
, "invalidÇum caches devs"},

3978 
dm_èrgë
 *
ti
 = 
su≥r
->ti;

3979 
dm_¨g_£t
 
as
;

3980 c⁄° *
°r
;

3981 
tmp
;

3982 
r
 = 0, 
i
 = 0;

3984 
as
.
¨gc
 =árgc;

3985 
as
.
¨gv
 =árgv;

3987 
r
 = 
	`dm_ªad_¨g
(
_¨gs
, &
as
, &
tmp
, &
ti
->
îr‹
);

3988 i‡(
r
)

3989  
r
;

3991 
°r
 = 
	`dm_shi·_¨g
(&
as
);

3992 
	`°r˝y
(
su≥r
->
dev_öfo
.
‹igö_«me
, 
°r
);

3994 
r
 = 
	`dm_ªad_¨g
(&
_¨gs
[1], &
as
, &
tmp
, &
ti
->
îr‹
);

3995 i‡(
r
)

3996  
r
;

3998 
su≥r
->
dev_öfo
.
num_ˇche_devs
 = 
tmp
;

3999 
i
 = 0;ò< 
tmp
;i++){

4000 
	`°r˝y
(
su≥r
->
dev_öfo
.
ˇche_«me
[
i
], 
	`dm_shi·_¨g
(&
as
));

4003  
r
;

4004 
	}
}

4006 
	#c⁄sume_kv
(
«me
, 
ƒ
) \

4007 i‡(!
	`°rˇ£cmp
(
key
, #name)) { \

4008 i‡(!
¨gc
) \

4010 
r
 = 
	`dm_ªad_¨g
(
_¨gs
 + (
ƒ
), 
as
, &
tmp
, &
ti
->
îr‹
); \

4011 i‡(
r
) \

4013 
su≥r
->
∑øm
.
«me
 = 
tmp
; \

4014 
	`¥ötk
(" %†%u \n", #«me, 
tmp
);\

4015 }

	)

4017 
	#c⁄sume_kv_°r
(
«me
, 
ƒ
) \

4018 i‡(!
	`°rˇ£cmp
(
key
, #name)) { \

4019 *
°r
; \

4020 i‡(!
¨gc
) \

4022 
°r
 = 
	`dm_shi·_¨g
(
as
);\

4023 
	`¥ötk
(" %†%†\n", #«me, 
°r
);\

4024 }

	)

4028 
	$do_add_•¨e
(
dm§c_su≥r
 *
su≥r
, 
dm_¨g_£t
 *
as
, 
¨gc
){

4029 
dm_èrgë
 *
ti
 = 
su≥r
->ti;

4030 
dm_dev
 *
dev
;

4031 *
°r
;

4032 
r
 = 0;

4034 i‡(!
¨gc
)

4037 
°r
 = (*)
	`dm_shi·_¨g
(
as
);

4038 
	`¥ötk
("ádd_•¨ê%†[%d] \n", 
°r
, ()
su≥r
->
dev_öfo
.
num_•¨e_ˇche_devs
);

4039 
r
 = 
	`dm_gë_devi˚
(
ti
, 
°r
, 
	`dm_èbÀ_gë_mode
—i->
èbÀ
),

4040 &
su≥r
->
dev_öfo
.
•¨e_ˇche_dev
[su≥r->dev_öfo.
num_•¨e_ˇche_devs
]);

4041 i‡(
r
) {

4042 
ti
->
îr‹
 = "couldn't get spare dev";

4043 
	`¥ötk
(" couldn'àgë s∑ª dev %s\n", 
°r
);

4044  
r
;

4047 
dev
 = 
su≥r
->
dev_öfo
.
•¨e_ˇche_dev
[su≥r->dev_öfo.
num_•¨e_ˇche_devs
];

4048 if(
	`dm§c_devsize_£˘‹s
(
dev
)<
su≥r
->
dev_öfo
.
≥r_ssd_£˘‹s
){

4049 
	`dm_put_devi˚
(
ti
, 
dev
);

4050 
ti
->
îr‹
 = "spare drv is smallerÅhan current drv!";

4051 
	`¥ötk
(" s∑ª drivêi†smÆÀ∏th™ cuºíàdrivê%s\n", 
°r
);

4052  
r
;

4056 
su≥r
->
dev_öfo
.
num_•¨e_ˇche_devs
++;

4059 
	}
}

4061 
	$do_c⁄sume_tu«bÀ_¨gv
(
dm_èrgë
 *
ti
,

4062 
dm_¨g_£t
 *
as
, 
¨gc
)

4064 
dm_¨g
 
_¨gs
[] = {

4073 {
SEQ_CUTOFF_MIN
, 
SEQ_CUTOFF_MAX
, "invalid sequential_cutoff size (bytes)"},

4087 
dm§c_su≥r
 *
su≥r
 = 
ti
->
¥iv©e
;

4088 
r
 = 0;

4089 
tmp
;

4091 
¨gc
) {

4092 c⁄° *
key
 = 
	`dm_shi·_¨g
(
as
);

4093 
¨gc
--;

4095 
r
 = -
EINVAL
;

4097 
	`c⁄sume_kv
(
sync_öãrvÆ
, 6);

4098 
	`c⁄sume_kv
(
£quítül_íabÀ
, 7);

4099 
	`c⁄sume_kv
(
£quítül_cutoff
, 8);

4100 
	`c⁄sume_kv
(
vi˘im_pﬁicy
, 9);

4101 
	`c⁄sume_kv
(
ª˛aim_pﬁicy
, 10);

4102 
	`c⁄sume_kv
(
u_max
, 11);

4103 
	`c⁄sume_kv
(
gc_wôh_dútysync
, 12);

4104 
	`c⁄sume_kv
(
max_migøã_öÊights
, 13);

4105 
	`c⁄sume_kv
(
migøã_loww©î
, 14);

4106 
	`c⁄sume_kv
(
migøã_highw©î
, 15);

4107 
	`c⁄sume_kv
(
hô_bôm≠_ty≥
, 16);

4108 
	`c⁄sume_kv
(
bio_∂uggög
, 17);

4109 
	`c⁄sume_kv
(
íabÀ_ªad_ˇche
, 18);

4110 
	`c⁄sume_kv
(
hŸ_idítifiˇti⁄
, 19);

4112 if(
su≥r
->
∑øm
.
migøã_loww©î
>=su≥r->∑øm.
migøã_highw©î
){

4113 
su≥r
->
∑øm
.
migøã_loww©î
 = su≥r->∑øm.
migøã_highw©î
;

4114 
su≥r
->
∑øm
.
migøã_highw©î
++;

4117 i‡(!
	`°rˇ£cmp
(
key
, "add_spare")) {

4118 
r
 = 
	`do_add_•¨e
(
su≥r
, 
as
, 
¨gc
);

4119 if(
r
)

4120  
r
;

4123 i‡(!
	`°rˇ£cmp
(
key
, "recovery")) {

4124 
r
 = 0;

4125 
	`¥ötk
(" doÑecovery \n");

4126 
	`do_ªcovîy
(
su≥r
);

4129 i‡(!
	`°rˇ£cmp
(
key
, "grow")) {

4130 
r
 = 0;

4131 
	`¥ötk
(" growing # of drives \n");

4132 
	`do_grow
(
su≥r
);

4135 i‡(!
	`°rˇ£cmp
(
key
, "gc")) {

4136 
r
 = 0;

4137 
	`¥ötk
(" background GC \n");

4138 
	`do_background_gc
(
su≥r
);

4141 i‡(!
r
) {

4142 
¨gc
--;

4144 
ti
->
îr‹
 = "invalid optional key";

4149  
r
;

4150 
	}
}

4155 
	$x‹_8ªgs_4_2
(
byãs
, *
p1
, *
p2
,

4156 *
p3
, *
p4
)

4158 
löes
 = 
byãs
 / ( ()) / 8;

4161 
p1
[0] ^
p2
[0] ^ 
p3
[0] ^ 
p4
[0];

4162 
p1
[1] ^
p2
[1] ^ 
p3
[1] ^ 
p4
[1];

4163 
p1
[2] ^
p2
[2] ^ 
p3
[2] ^ 
p4
[2];

4164 
p1
[3] ^
p2
[3] ^ 
p3
[3] ^ 
p4
[3];

4165 
p1
[4] ^
p2
[4] ^ 
p3
[4] ^ 
p4
[4];

4166 
p1
[5] ^
p2
[5] ^ 
p3
[5] ^ 
p4
[5];

4167 
p1
[6] ^
p2
[6] ^ 
p3
[6] ^ 
p4
[6];

4168 
p1
[7] ^
p2
[7] ^ 
p3
[7] ^ 
p4
[7];

4170 
p1
 += 8;

4171 
p2
 += 8;

4172 
p3
 += 8;

4173 
p4
 += 8;

4174 } --
löes
 > 0);

4175 
	}
}

4178 
	$x‹_blocks2
(
§c_cou¡
, 
byãs
, *
de°
, **
§cs
)

4180 *
p1
, *
p2
, *
p3
;

4181 
p1
 = (*Ë
§cs
[0];

4182 
p2
 = (*Ë
§cs
[1];

4183 
p3
 = (*Ë
§cs
[2];

4184 
	`x‹_8ªgs_4_2
(
byãs
, 
de°
, 
p1
, 
p2
, 
p3
);

4185 
	}
}

4187 
	$øid6_duÆ_ªcov
(
disks
, 
size_t
 
byãs
, 
Áûa
, 
Áûb
, **
±rs
)

4189 i‡–
Áûa
 > 
Áûb
 ) {

4190 
tmp
 = 
Áûa
;

4191 
Áûa
 = 
Áûb
;

4192 
Áûb
 = 
tmp
;

4195 i‡–
Áûb
 =
disks
-1 ) {

4196 i‡–
Áûa
 =
disks
-2 ) {

4198 
øid6_ˇŒ
.
	`gí_syndrome
(
disks
, 
byãs
, 
±rs
);

4205 i‡–
Áûb
 =
disks
-2 ) {

4207 
	`øid6_d©≠_ªcov
(
disks
, 
byãs
, 
Áûa
, 
±rs
);

4210 
	`øid6_2d©a_ªcov
(
disks
, 
byãs
, 
Áûa
, 
Áûb
, 
±rs
);

4213 
	}
}

4215 
	$pq_ã°
(
dm§c_su≥r
 *
su≥r
){

4216 
	#NUM_DISKS
 5

	)

4217 *
§c
[
NUM_DISKS
];

4218 *
d°
;

4219 
i
;

4220 *
öç
;

4222 
	`¥ötk
(" PQÅest ... \n");

4224 
i
 = 0;ò< 
NUM_DISKS
;i++){

4225 
§c
[
i
] = (*Ë
	`gë_zî€d_∑ge
(
GFP_KERNEL
 | 
__GFP_NOTRACK
);

4226 
öç
 = (*)
§c
[
i
];

4227 *
öç
 = 
i
*80 + 20;

4230 
i
 = 0;ò< 
NUM_DISKS
-2;i++){

4231 
öç
 = (*)
§c
[
i
];

4232 
	`¥ötk
(" %d: %d \n", 
i
, *
öç
);

4235 
d°
 = 
§c
[
NUM_DISKS
-1];

4236 
	`mem£t
(
d°
, 0xì, 
SRC_PAGE_SIZE
);

4238 
d°
 = 
§c
[
NUM_DISKS
-2];

4239 
	`mem£t
(
d°
, 0xì, 
SRC_PAGE_SIZE
);

4241 
øid6_ˇŒ
.
	`gí_syndrome
(
NUM_DISKS
, 
SRC_PAGE_SIZE
, 
§c
);

4243 
öç
 = (*)
§c
[0];

4244 *
öç
 = 0;

4245 
öç
 = (*)
§c
[1];

4246 *
öç
 = 0;

4248 
i
 = 0;ò< 
NUM_DISKS
-2;i++){

4249 
öç
 = (*)
§c
[
i
];

4250 
	`¥ötk
(" %d: %d \n", 
i
, *
öç
);

4253 
	`øid6_duÆ_ªcov
(
NUM_DISKS
, 
SRC_PAGE_SIZE
, 0, 1, (**Ë&
§c
);

4255 
i
 = 0;ò< 
NUM_DISKS
-2;i++){

4256 
öç
 = (*)
§c
[
i
];

4257 
	`¥ötk
(" %d: %d \n", 
i
, *
öç
);

4260 
i
 = 0;ò< 
NUM_DISKS
;i++)

4261 
	`‰ì_∑ge
(()
§c
[
i
]);

4263 
	}
}

4265 
	$x‹_ã°
(
dm§c_su≥r
 *
su≥r
){

4266 
	#SRC_LEN
 3

	)

4267 *
§c
[
SRC_LEN
+1];

4268 *
§c2
[
SRC_LEN
+1];

4269 *
d°
;

4270 *
ãmp
;

4271 
i
;

4272 *
öç
;

4275 
i
 = 0;ò< 
SRC_LEN
+1;i++){

4276 
§c
[
i
] = (*Ë
	`gë_zî€d_∑ge
(
GFP_KERNEL
 | 
__GFP_NOTRACK
);

4277 
öç
 = (*)
§c
[
i
];

4278 *
öç
 = 
i
*80 + 20;

4281 
d°
 = 
§c
[
SRC_LEN
];

4282 
öç
 = (*)
d°
;

4283 *
öç
 = 0;

4284 
	`mem£t
(
d°
, 0xFF, 
SRC_PAGE_SIZE
);

4286 
ãmp
 = (*Ë
	`gë_zî€d_∑ge
(
GFP_KERNEL
 | 
__GFP_NOTRACK
);

4287 
öç
 = (*)
ãmp
;

4288 *
öç
 = 0;

4289 
	`mem£t
(
ãmp
, 0xFF, 
SRC_PAGE_SIZE
);

4292 
	`x‹_blocks
(
SRC_LEN
, 
SRC_PAGE_SIZE
, 
d°
, 
§c
);

4293 
	`x‹_blocks
(
SRC_LEN
, 
SRC_PAGE_SIZE
, 
ãmp
, 
§c
);

4295 
i
 = 0;ò< 
SRC_LEN
+1;i++){

4296 
öç
 = (*)
§c
[
i
];

4297 
	`¥ötk
(" %d d©®%u %d \n", 
i
,

4298 
	`¸c32_À
(
CRC_SEED
, 
§c
[
i
], 
SRC_PAGE_SIZE
), *
öç
);

4301 
öç
 = (*)
d°
;

4302 
	`¥ötk
(" dst data %u %d \n",

4303 
	`¸c32_À
(
CRC_SEED
, 
d°
, 
SRC_PAGE_SIZE
), *
öç
);

4304 
öç
 = (*)
ãmp
;

4305 
	`¥ötk
("Åemp data %u %d \n",

4306 
	`¸c32_À
(
CRC_SEED
, 
ãmp
, 
SRC_PAGE_SIZE
), *
öç
);

4308 
i
 = 0;ò< 
SRC_LEN
;i++){

4309 
§c2
[
i
] = 
§c
[i+1];

4312 
	`mem£t
(
ãmp
, 0xFF, 
SRC_PAGE_SIZE
);

4313 
	`x‹_blocks
(
SRC_LEN
, 
SRC_PAGE_SIZE
, 
ãmp
, 
§c2
);

4315 
öç
 = (*)
ãmp
;

4316 
	`¥ötk
("Ñecovered data %u %d \n",

4317 
	`¸c32_À
(
CRC_SEED
, 
ãmp
, 
SRC_PAGE_SIZE
), *
öç
);

4319 if(
	`memcmp
(
ãmp
, 
§c
[0], 
SRC_PAGE_SIZE
)){

4320 
	`¥ötk
(" ***Öarity mismatch ******\n");

4323 
i
 = 0;ò< 
SRC_LEN
+1;i++)

4324 
	`‰ì_∑ge
(()
§c
[
i
]);

4326 
	`‰ì_∑ge
(()
ãmp
);

4327 
	}
}

4329 
	$£t_deÁu…_∑øm
(
dm§c_su≥r
 *
su≥r
, 
dm§c_∑øm
 *
∑øm
){

4331 
∑øm
->
íabÀ_ªad_ˇche
 = 1;

4333 
∑øm
->
îasuª_code
 = 
ERASURE_CODE_NONE
;

4336 
∑øm
->
∑rôy_Æloˇti⁄
 = 
PARITY_ALLOC_FIXED
;

4340 
∑øm
->
d©a_Æloˇti⁄
 = 
DATA_ALLOC_HORI
;

4341 
∑øm
->
Æig√d_io_dummy
 = 
ALIGNED_IO_DUMMY
;

4346 
∑øm
->
°rùög_pﬁicy
 = 
SEPAR_STRIPING
;

4349 
∑øm
->
hô_bôm≠_ty≥
 = 
HIT_BITMAP_PER_STRIPE
;

4351 
∑øm
->
gc_wôh_dútysync
 = 
GC_WITHOUT_DIRTY_SYNC
;

4352 
∑øm
->
£quítül_íabÀ
 = 1;

4353 
∑øm
->
u_max
 = 
DEFAULT_U_MAX
;

4355 
∑øm
->
chunk_size
 = 2048;

4356 
∑øm
->
ømbuf_poﬁ_amou¡
 = 2048;

4357 
∑øm
->
ª˛aim_pﬁicy
 = 
RECLAIM_DESTAGE
;

4358 
∑øm
->
bio_∂uggög
 = 0;

4359 
∑øm
->
hŸ_idítifiˇti⁄
 = 1;

4360 
∑øm
->
£quítül_cutoff

SEQ_CUTOFF
;

4362 
∑øm
->
max_migøã_öÊights
 = 
MAX_MIGRATE_INFLIGHT_NUM
;

4366 
su≥r
->
∑øm
.
checkî_öãrvÆ
 = 20;

4371 
	}
}

4373 
	$øid_c⁄f_öô
(
dm§c_su≥r
 *
su≥r
, 
r5c⁄f
 *
c⁄f
){

4375 
	`mem£t
(
c⁄f
, 0x00, (
r5c⁄f
));

4377 
c⁄f
->
Æg‹ôhm
 = 
ALGORITHM_LEFT_SYMMETRIC
;

4378 
c⁄f
->
chunk_£˘‹s
 = 
CHUNK_SZ_SECTOR
;

4380 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
)){

4381 if(
su≥r
->
∑øm
.
∑rôy_Æloˇti⁄
==
PARITY_ALLOC_FIXED
){

4382 
c⁄f
->
Àvñ
 = 4;

4383 
c⁄f
->
øid_disks
 = 
NUM_SSD
-1;

4385 
c⁄f
->
Àvñ
 = 5;

4386 
c⁄f
->
øid_disks
 = 
NUM_SSD
;

4390 if(
	`USE_ERASURE_RAID6
(&
su≥r
->
∑øm
)){

4391 
c⁄f
->
Àvñ
 = 6;

4392 
c⁄f
->
øid_disks
 = 
NUM_SSD
;

4395 
	}
}

4397 
	$ª£t_¨rivÆ_time
(
dm§c_su≥r
 *
su≥r
){

4398 
≥ndög_m™agî
 *
≥ndög_mgr
 = &
su≥r
->pending_mgr;

4399 
i
;

4401 
i
 = 0;ò< 
MAX_ARRIVAL_TIME
;i++){

4402 
≥ndög_mgr
->
¨rivÆ_times
[
i
].
tv_£c
 = 0;

4403 
≥ndög_mgr
->
¨rivÆ_times
[
i
].
tv_n£c
 = 0;

4406 
	`©omic_£t
(&
≥ndög_mgr
->
¨rivÆ_°¨t
, 0);

4407 
	`©omic_£t
(&
≥ndög_mgr
->
¨rivÆ_cou¡
, 0);

4408 
	`©omic_£t
(&
≥ndög_mgr
->
¨rivÆ_cur
, 0);

4409 
	}
}

4411 
	$≥ndög_mgr_öô
(
dm§c_su≥r
 *
su≥r
){

4412 
≥ndög_m™agî
 *
≥ndög_mgr
 = &
su≥r
->pending_mgr;

4413 
r
 = 0;

4415 
≥ndög_mgr
->
su≥r
 = super;

4416 
	`•ö_lock_öô
(&
≥ndög_mgr
->
b¨rõr_lock
);

4417 
	`bio_li°_öô
(&
≥ndög_mgr
->
b¨rõr_ios
);

4418 
	`©omic_£t
(&
≥ndög_mgr
->
b¨rõr_cou¡
, 0);

4420 
	`•ö_lock_öô
(&
≥ndög_mgr
->
lock
);

4421 
	`©omic64_£t
(&
≥ndög_mgr
->
io_cou¡
, 0);

4422 
	`bio_li°_öô
(&
≥ndög_mgr
->
bios
);

4424 
	`ª£t_¨rivÆ_time
(
su≥r
);

4428 
≥ndög_mgr
->
wq
 = 
	`¸óã_sögÀthªad_w‹kqueue
("pending_wq");

4429 i‡(!
≥ndög_mgr
->
wq
) {

4430 
	`WBERR
("failedÅoállocÑead caching wq");

4431 
r
 = -1;

4432 
bad_öô
;

4435 
	`INIT_WORK
(&
≥ndög_mgr
->
w‹k
, 
≥ndög_w‹kî
);

4437 
≥ndög_mgr
->
wb_job_poﬁ
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(
STRIPE_SZ
,

4438 (
wb_job
));

4439 i‡(!
≥ndög_mgr
->
wb_job_poﬁ
) {

4440 
r
 = -
ENOMEM
;

4441 
	`WBERR
("couldn'tálloc flush jobÖool");

4442 
bad_öô
;

4445 
≥ndög_mgr
->
öôülized
 = 1;

4446 
bad_öô
:

4447  
r
;

4448 
	}
}

4450 
	$≥ndög_mgr_exô
(
dm§c_su≥r
 *
su≥r
){

4451 if(!
su≥r
->
≥ndög_mgr
.
öôülized
)

4454 
	`de°roy_w‹kqueue
(
su≥r
->
≥ndög_mgr
.
wq
);

4455 
	`mempoﬁ_de°roy
(
su≥r
->
≥ndög_mgr
.
wb_job_poﬁ
);

4456 
	}
}

4458 
	$£q_dëe˘‹_öô
(
dm§c_su≥r
 *
su≥r
){

4459 
£q_io_dëe˘‹
 *
£q_dëe˘‹
 = &
su≥r
->seq_detector;

4460 
io
 *io;

4462 
	`INIT_LIST_HEAD
(&
£q_dëe˘‹
->
io_Ãu
);

4464 
	`•ö_lock_öô
(&
£q_dëe˘‹
->
£q_lock
);

4465 
io
 = 
£q_dëe˘‹
->io; iÿ< seq_dëe˘‹->iÿ+ 
RECENT_IO
; io++) {

4466 
	`li°_add
(&
io
->
Ãu
, &
£q_dëe˘‹
->
io_Ãu
);

4467 
	`hli°_add_hód
(&
io
->
hash
, 
£q_dëe˘‹
->
io_hash
 + 
RECENT_IO
);

4469 
	}
}

4471 
	$°©_öô
(
dm§c_su≥r
 *
su≥r
){

4472 
su≥r
->
w°©
.
cou¡
=0;

4473 
su≥r
->
w°©
.
hô
=0;

4474 
su≥r
->
w°©
.
ªad_cou¡
=0;

4475 
su≥r
->
w°©
.
ªad_hô
=0;

4476 
su≥r
->
w°©
.
wrôe_cou¡
=0;

4477 
su≥r
->
w°©
.
wrôe_hô
=0;

4478 
	`©omic_£t
(&
su≥r
->
w°©
.
de°age_cou¡
, 0);

4479 
	`©omic_£t
(&
su≥r
->
w°©
.
gc_cou¡
, 0);

4480 
	`©omic_£t
(&
su≥r
->
w°©
.
tŸÆ_migøti⁄
, 0);

4481 
	`©omic_£t
(&
su≥r
->
w°©
.
cﬁd_by∑ss_cou¡
, 0);

4482 
	`©omic_£t
(&
su≥r
->
w°©
.
£q_by∑ss_cou¡
, 0);

4484 
	`©omic64_£t
(&
su≥r
->
w°©
.
avîage_¨rivÆ_time
, 0);

4485 
	`©omic64_£t
(&
su≥r
->
w°©
.
avîage_¨rivÆ_cou¡
, 0);

4486 
	}
}

4488 
	$£g_Æloˇt‹_öô
(
dm§c_su≥r
 *
su≥r
){

4489 
£gmít_Æloˇt‹
 *
£g_Æloˇt‹
 = &
su≥r
->seg_allocator;

4491 
	`öô_waôqueue_hód
(&
£g_Æloˇt‹
->
Æloc_waô_queue
);

4493 
	`INIT_LIST_HEAD
(&
£g_Æloˇt‹
->
group_Æloc_queue
);

4494 
	`INIT_LIST_HEAD
(&
£g_Æloˇt‹
->
group_migøã_queue
);

4495 
	`INIT_LIST_HEAD
(&
£g_Æloˇt‹
->
group_u£d_queue
);

4496 
	`INIT_LIST_HEAD
(&
£g_Æloˇt‹
->
group_£Æed_queue
);

4498 
	`©omic_£t
(&
£g_Æloˇt‹
->
group_Æloc_cou¡
, 0);

4499 
	`©omic_£t
(&
£g_Æloˇt‹
->
group_migøã_cou¡
, 0);

4500 
£g_Æloˇt‹
->
group_u£d_cou¡
 = 0;

4501 
£g_Æloˇt‹
->
group_£Æed_cou¡
 = 0;

4503 
	`INIT_LIST_HEAD
(&
£g_Æloˇt‹
->
£g_Æloc_queue
);

4504 
	`INIT_LIST_HEAD
(&
£g_Æloˇt‹
->
£g_migøã_queue
);

4505 
	`INIT_LIST_HEAD
(&
£g_Æloˇt‹
->
£g_u£d_queue
);

4506 
	`INIT_LIST_HEAD
(&
£g_Æloˇt‹
->
£g_£Æed_queue
);

4508 
	`©omic_£t
(&
£g_Æloˇt‹
->
£g_Æloc_cou¡
, 0);

4509 
	`©omic_£t
(&
£g_Æloˇt‹
->
£g_migøã_cou¡
, 0);

4510 
£g_Æloˇt‹
->
£g_u£d_cou¡
 = 0;

4511 
£g_Æloˇt‹
->
£g_£Æed_cou¡
 = 0;

4512 
	}
}

4515 
	$ªcovîy_mgr_öô
(
dm§c_su≥r
 *
su≥r
){

4516 
r
 = 0;

4517 
ªcovîy_m™agî
 *
ªcovîy_mgr
 = &
su≥r
->recovery_mgr;

4519 
ªcovîy_mgr
->
su≥r
 = super;

4521 
	`•ö_lock_öô
(&
ªcovîy_mgr
->
lock
);

4522 
	`INIT_LIST_HEAD
(&
ªcovîy_mgr
->
queue
);

4523 
ªcovîy_mgr
->
wq
 = 
	`Æloc_w‹kqueue
("recovery_wq",

4524 
WQ_NON_REENTRANT
 | 
WQ_MEM_RECLAIM
, 1);

4525 i‡(!
ªcovîy_mgr
->
wq
) {

4526 
	`WBERR
("failedÅoállocÑecovery wq");

4527 
r
 = -1;

4528 
îr‹_föish
;

4530 
	`INIT_WORK
(&
ªcovîy_mgr
->
w‹k
, 
do_ªcovîy_w‹kî
);

4532 
ªcovîy_mgr
->
°¨t_jiffõs
 = 
jiffõs
;

4533 
ªcovîy_mgr
->
íd_jiffõs
 = 
jiffõs
;

4535 
ªcovîy_mgr
->
job_poﬁ
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(
STRIPE_SZ
,

4536 (
ªcovîy_job
));

4537 i‡(!
ªcovîy_mgr
->
job_poﬁ
) {

4538 
r
 = -
ENOMEM
;

4539 
	`WBERR
("couldn'tálloc flush jobÖool");

4540 
îr‹_föish
;

4543 
r
 = 
	`¸óã_d´m⁄
(
su≥r
, &
ªcovîy_mgr
->
d´m⁄
, 
ªcovîy_¥oc
, "recovery_daemon");

4544 if(
r
)

4545 
îr‹_föish
;

4547 
ªcovîy_mgr
->
öôülized
 = 1;

4549 
îr‹_föish
:

4551  
r
;

4552 
	}
}

4554 
	$ªcovîy_mgr_deöô
(
dm§c_su≥r
 *
su≥r
){

4555 
ªcovîy_m™agî
 *
ªcovîy_mgr
 = &
su≥r
->recovery_mgr;

4557 if(!
ªcovîy_mgr
->
öôülized
)

4560  
	`©omic_ªad
(&
su≥r
->
ªcovîy_mgr
.
brokí_block_cou¡
)){

4563 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

4566 
	`Êush_w‹k
(&
ªcovîy_mgr
->
w‹k
);

4567 
	`ˇn˚l_w‹k_sync
(&
ªcovîy_mgr
->
w‹k
);

4568 
	`de°roy_w‹kqueue
(
ªcovîy_mgr
->
wq
);

4569 
	`kthªad_°›
(
ªcovîy_mgr
->
d´m⁄
);

4570 
	`mempoﬁ_de°roy
(
ªcovîy_mgr
->
job_poﬁ
);

4571 
	}
}

4573 
	$Êush_mgr_öô
(
dm§c_su≥r
 *
su≥r
){

4574 
Êush_m™agî
 *
Êush_mgr
 = &
su≥r
->flush_mgr;

4575 
r
 = 0;

4577 
	`•ö_lock_öô
(&
Êush_mgr
->
lock
);

4578 
	`©omic_£t
(&
Êush_mgr
->
övoke_cou¡
, 0);

4579 
	`©omic_£t
(&
Êush_mgr
->
io_cou¡
, 0);

4580 
	`©omic64_£t
(&
Êush_mgr
->
globÆ_£g_£quí˚
, 0);

4581 
	`INIT_LIST_HEAD
(&
Êush_mgr
->
queue
);

4583 
r
 = 
	`¸óã_d´m⁄
(
su≥r
, &
Êush_mgr
->
d´m⁄
, 
Êush_mëa_¥oc
, "flush_meta_daemon");

4584 if(
r
)

4585 
bad_öô
;

4587 
Êush_mgr
->
övoke_poﬁ
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(100,

4588 (
Êush_övoke_job
));

4589 i‡(!
Êush_mgr
->
övoke_poﬁ
) {

4590 
r
 = -
ENOMEM
;

4591 
	`WBERR
("couldn'tálloc flush jobÖool");

4592 
bad_öô
;

4603 
Êush_mgr
->
öôülized
 = 1;

4605  
r
;

4607 
bad_öô
:

4608  
r
;

4610 
	}
}

4612 
	$Êush_mgr_deöô
(
dm§c_su≥r
 *
su≥r
){

4613 if(!
su≥r
->
Êush_mgr
.
öôülized
)

4616 
	`¥ötk
(" flushÖartial meta .. \n");

4617 
	`Êush_∑πül_mëa
(
su≥r
, 
WHBUF
);

4618 
	`¥ötk
(" flushÖartial meta .. \n");

4619 
	`Êush_∑πül_mëa
(
su≥r
, 
WCBUF
);

4620 
	`¥ötk
("Énd flushÖartial meta .. \n");

4622 
	`©omic_ªad
(&
su≥r
->
Êush_mgr
.
övoke_cou¡
)){

4623 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

4626 
	`©omic_ªad
(&
su≥r
->
Êush_mgr
.
io_cou¡
)){

4627 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`m£cs_to_jiffõs
(1000));

4630 
	`kthªad_°›
(
su≥r
->
Êush_mgr
.
d´m⁄
);

4631 
	`mempoﬁ_de°roy
(
su≥r
->
Êush_mgr
.
övoke_poﬁ
);

4633 
	}
}

4635 
	$migøã_mgr_öô
(
dm§c_su≥r
 *
su≥r
){

4636 
migøti⁄_m™agî
 *
migøã_mgr
 = &
su≥r
->migrate_mgr;

4637 
r
;

4639 
migøã_mgr
->
su≥r
 = super;

4640 
migøã_mgr
->
Ælow_migøã
 = 
Ál£
;

4642 
	`•ö_lock_öô
(&
migøã_mgr
->
mig_queue_lock
);

4643 
	`•ö_lock_öô
(&
migøã_mgr
->
group_queue_lock
);

4645 
	`INIT_LIST_HEAD
(&
migøã_mgr
->
migøã_queue
);

4646 
	`INIT_LIST_HEAD
(&
migøã_mgr
->
mig_queue
);

4647 
	`INIT_LIST_HEAD
(&
migøã_mgr
->
c›y_queue
);

4648 
	`INIT_LIST_HEAD
(&
migøã_mgr
->
group_queue
);

4650 
	`¸óã_d´m⁄
(
su≥r
, &
migøã_mgr
->
d´m⁄
, 
migøã_¥oc
, "migrate_daemon");

4652 
migøã_mgr
->
mig_wq
 = 
	`Æloc_w‹kqueue
("mig_wq",

4653 
WQ_NON_REENTRANT
 | 
WQ_MEM_RECLAIM
, 1);

4654 i‡(!
migøã_mgr
->
mig_wq
) {

4655 
	`WBERR
("failedÅoálloc mig wq");

4656 
r
 = -1;

4657 
bad_wq
;

4659 
	`INIT_WORK
(&
migøã_mgr
->
mig_w‹k
, 
do_mig_w‹kî
);

4661 
	`©omic_£t
(&
migøã_mgr
->
migøã_queue_cou¡
, 0);

4662 
	`©omic_£t
(&
migøã_mgr
->
mig_öÊights
, 0);

4664 
	`©omic_£t
(&
migøã_mgr
->
migøã_åiggîed
, 0);

4665 
	`©omic_£t
(&
migøã_mgr
->
background_gc_⁄
, 0);

4667 
migøã_mgr
->
gc_cur_£g
 = 
NULL
;

4668 
migøã_mgr
->
gc_cur_off£t
 = 0;

4669 
migøã_mgr
->
gc_Æloc_cou¡
= 0;

4671 
migøã_mgr
->
c›y_job_poﬁ
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(100,

4672 (
c›y_job
));

4673 i‡(!
migøã_mgr
->
c›y_job_poﬁ
) {

4674 
r
 = -
ENOMEM
;

4675 
	`WBERR
("couldn'tálloc copy jobÖool");

4676 
bad_c›y_job_poﬁ
;

4679 
migøã_mgr
->
group_job_poﬁ
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(1024,

4680 (
c›y_job_group
));

4681 i‡(!
migøã_mgr
->
group_job_poﬁ
) {

4682 
r
 = -
ENOMEM
;

4683 
	`WBERR
("couldn'tálloc copy jobÖool");

4684 
bad_group_job_poﬁ
;

4695 
	`©omic_£t
(&
migøã_mgr
->
c›y_job_cou¡
, 0);

4696 
	`©omic_£t
(&
migøã_mgr
->
group_job_cou¡
, 0);

4697 
	`©omic_£t
(&
migøã_mgr
->
group_job_£q
, 0);

4699 
su≥r
->
∑øm
.
migøã_loww©î
 = 
	`©omic_ªad
(&su≥r->
£gbuf_mgr
.
tŸÆ_∑ge_cou¡
)/
STRIPE_SZ
;

4700 if(
su≥r
->
∑øm
.
migøã_loww©î
<2)

4701 
su≥r
->
∑øm
.
migøã_loww©î
 = 2;

4702 
su≥r
->
∑øm
.
migøã_highw©î
 = 
	`©omic_ªad
(&su≥r->
£gbuf_mgr
.
tŸÆ_∑ge_cou¡
)/
STRIPE_SZ
/4*6;

4704 
migøã_mgr
->
öôülized
 = 1;

4710 
bad_group_job_poﬁ
:

4711 
	`mempoﬁ_de°roy
(
migøã_mgr
->
c›y_job_poﬁ
);

4712 
bad_c›y_job_poﬁ
:

4713 
	`de°roy_w‹kqueue
(
migøã_mgr
->
mig_wq
);

4714 
bad_wq
:

4717 
	}
}

4719 
	$migøã_mgr_deöô
(
dm§c_su≥r
 *
su≥r
){

4720 
migøti⁄_m™agî
 *
migøã_mgr
 = &
su≥r
->migrate_mgr;

4722 if(!
migøã_mgr
->
öôülized
)

4725 
	`wake_up_¥o˚ss
(
migøã_mgr
->
d´m⁄
);

4727 
	`¥ötk
(" wait forÅriggered off\n");

4728 
	`©omic_ªad
(&
migøã_mgr
->
migøã_åiggîed
))

4729 
	`scheduÀ_timeout_öãºu±ibÀ
(
	`u£cs_to_jiffõs
(1000));

4731 
	`¥ötk
(" wait for inflights \n");

4735 
migøã_mgr
->
Ælow_migøã
 = 
Ál£
;

4736 
	`©omic_£t
(&
migøã_mgr
->
migøã_åiggîed
, 0);

4737 
	`©omic_£t
(&
su≥r
->
migøã_mgr
.
background_gc_⁄
, 0);

4739 
	`¥ötk
(" wait for inflights \n");

4743 
	`kthªad_°›
(
migøã_mgr
->
d´m⁄
);

4744 
	`Êush_w‹k
(&
migøã_mgr
->
mig_w‹k
);

4745 
	`ˇn˚l_w‹k_sync
(&
migøã_mgr
->
mig_w‹k
);

4746 
	`mempoﬁ_de°roy
(
migøã_mgr
->
c›y_job_poﬁ
);

4749 
migøã_mgr
->
öôülized
 = 0;

4750 
	}
}

4752 
	$∂uggî_öô
(
dm§c_su≥r
 *
su≥r
){

4753 
∂uggög_m™agî
 *
∂uggî
 = &
su≥r
->plugger;

4754 
i
;

4755 
r
 = 0;

4757 
∂uggî
->
su≥r
 = super;

4758 
∂uggî
->
dódlöe_us
 = 1000000;

4760 
	`£tup_timî
(&
∂uggî
->
timî
,

4761 
∂ug_dódlöe_¥oc
, (Ë
su≥r
);

4763 
i
 = 0;ò< 
MAX_CACHE_DEVS
;i++){

4764 
	`INIT_LIST_HEAD
(&
∂uggî
->
queue
[
i
]);

4765 
	`©omic_£t
(&
∂uggî
->
queue_Àngth
[
i
], 0);

4766 
	`•ö_lock_öô
(&
∂uggî
->
lock
[
i
]);

4768 
	`©omic_£t
(&
∂uggî
->
tŸÆ_Àngth
, 0);

4770 
∂uggî
->
öôülized
 = 1;

4772  
r
;

4773 
	}
}

4775 
	$∂uggî_deöô
(
dm§c_su≥r
 *
su≥r
){

4776 
∂uggög_m™agî
 *
∂uggî
 = &
su≥r
->plugger;

4778 if(!
∂uggî
->
öôülized
)

4781 
	`dñ_timî
(&
∂uggî
->
timî
);

4782 
	}
}

4784 #i‡(
USE_SEG_WRITER
 == 1)

4785 
	$£g_wrôe_mgr_öô
(
dm§c_su≥r
 *
su≥r
){

4786 
£g_wrôe_m™agî
 *
£g_wrôe_mgr
;

4787 
r
 = 0;

4788 
i
 = 0;

4790 
i
 = 0;ò< 
MAX_CACHE_DEVS
;i++){

4791 
£g_wrôe_mgr
 = &
su≥r
->£g_wrôe_mgr[
i
];

4792 
£g_wrôe_mgr
->
su≥r
 = super;

4794 
	`©omic_£t
(&
£g_wrôe_mgr
->
cou¡
, 0);

4795 
	`•ö_lock_öô
(&
£g_wrôe_mgr
->
•ölock
);

4796 
	`INIT_LIST_HEAD
(&
£g_wrôe_mgr
->
hód
);

4798 
£g_wrôe_mgr
->
wq

	`Æloc_w‹kqueue
("reacaching_wq",

4799 
WQ_NON_REENTRANT
 | 
WQ_MEM_RECLAIM
, 1);

4800 i‡(!
£g_wrôe_mgr
->
wq
) {

4801 
	`WBERR
("failedÅoállocÑead caching wq");

4802 
r
 = -1;

4803 
bad_öô
;

4805 
	`INIT_WORK
(&
£g_wrôe_mgr
->
w‹k
, 
£g_wrôe_w‹kî
);

4807 
£g_wrôe_mgr
->
öôülized
 = 1;

4810  
r
;

4812 
bad_öô
:

4813  
r
;

4814 
	}
}

4816 
	$£g_wrôe_mgr_deöô
(
dm§c_su≥r
 *
su≥r
){

4817 
£g_wrôe_m™agî
 *
£g_wrôe_mgr
;

4818 
i
;

4820 
i
 = 0;ò< 
MAX_CACHE_DEVS
;i++){

4821 
£g_wrôe_mgr
 = &
su≥r
->£g_wrôe_mgr[
i
];

4822 if(!
£g_wrôe_mgr
->
öôülized
)

4825 
	`de°roy_w‹kqueue
(
£g_wrôe_mgr
->
wq
);

4827 
	}
}

4830 
	$ªad_miss_mgr_öô
(
dm§c_su≥r
 *
su≥r
){

4831 
ªad_miss_m™agî
 *
ªad_miss_mgr
 = &
su≥r
->read_miss_mgr;

4832 
r
 = 0;

4834 
ªad_miss_mgr
->
su≥r
 = super;

4836 
	`öô_ªad_ˇchög_job_li°
(
su≥r
);

4837 
ªad_miss_mgr
->
wq

	`Æloc_w‹kqueue
("reacaching_wq",

4838 
WQ_NON_REENTRANT
 | 
WQ_MEM_RECLAIM
, 1);

4839 i‡(!
ªad_miss_mgr
->
wq
) {

4840 
	`WBERR
("failedÅoállocÑead caching wq");

4841 
r
 = -1;

4842 
bad_öô
;

4844 
	`INIT_WORK
(&
ªad_miss_mgr
->
w‹k
, 
do_ªad_ˇchög_w‹kî
);

4846 
ªad_miss_mgr
->
job_poﬁ
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(
STRIPE_SZ
,

4847 (
ªad_ˇchög_job
));

4848 i‡(!
ªad_miss_mgr
->
job_poﬁ
) {

4849 
r
 = -
ENOMEM
;

4850 
	`WBERR
("couldn'tálloc flush jobÖool");

4851 
bad_öô
;

4854 
ªad_miss_mgr
->
öôülized
 = 1;

4855  
r
;

4857 
bad_öô
:

4858  
r
;

4859 
	}
}

4861 
	$ªad_miss_mgr_deöô
(
dm§c_su≥r
 *
su≥r
){

4862 
ªad_miss_m™agî
 *
ªad_miss_mgr
 = &
su≥r
->read_miss_mgr;

4864 if(!
ªad_miss_mgr
->
öôülized
)

4869 
	`de°roy_w‹kqueue
(
ªad_miss_mgr
->
wq
);

4871 
	`mempoﬁ_de°roy
(
ªad_miss_mgr
->
job_poﬁ
);

4872 
	}
}

4874 
hπimî_ª°¨t
 
	$sync_timî_ˇŒback
–
hπimî
 *
timî
 )

4876 
sync_m™agî
 *
sync_mgr
 = 
	`c⁄èöî_of
(
timî
, sync_m™agî, 
hr_timî
);

4877 
dm§c_su≥r
 *
su≥r
 = 
sync_mgr
->super;

4881 if(!
	`©omic_ªad
(&
su≥r
->
migøã_mgr
.
migøã_åiggîed
)){

4882 if(!
	`©omic64_ªad
(&
su≥r
->
≥ndög_mgr
.
io_cou¡
)){

4883 
	`Êush_∑πül_mëa
(
su≥r
, 
WHBUF
);

4884 
	`Êush_∑πül_mëa
(
su≥r
, 
WCBUF
);

4888 
	`scheduÀ_w‹k
(&
su≥r
->
sync_mgr
.
w‹k
);

4891  
HRTIMER_NORESTART
;

4892 
	}
}

4894 
	$sync_mgr_öô
(
dm§c_su≥r
 *
su≥r
){

4895 
sync_m™agî
 *
sync_mgr
 = &
su≥r
->sync_mgr;

4897 
	`•ö_lock_öô
(&
sync_mgr
->
lock
);

4898 
sync_mgr
->
su≥r
 = super;

4899 
su≥r
->
∑øm
.
sync_öãrvÆ
 = 
DEFAULT_ARRIVAL_US
;

4901 
	`hπimî_öô
–&
sync_mgr
->
hr_timî
, 
CLOCK_MONOTONIC
, 
HRTIMER_MODE_REL
 );

4902 
sync_mgr
->
hr_timî
.
fun˘i⁄
 = &
sync_timî_ˇŒback
;

4906 
	`INIT_WORK
(&
sync_mgr
->
w‹k
, 
sync_¥oc
);

4908 
sync_mgr
->
öôülized
 = 1;

4911 
	}
}

4913 
	$sync_mgr_deöô
(
dm§c_su≥r
 *
su≥r
){

4914 
sync_m™agî
 *
sync_mgr
 = &
su≥r
->sync_mgr;

4916 if(!
sync_mgr
->
öôülized
)

4920 
	`Êush_w‹k
(&
sync_mgr
->
w‹k
);

4921 
	`ˇn˚l_w‹k_sync
(&
sync_mgr
->
w‹k
);

4922 
	}
}

4924 
	$gë_avg_¨rivÆ_time
(
dm§c_su≥r
 *
su≥r
){

4925 
≥ndög_m™agî
 *
≥ndög_mgr
 = &
su≥r
->pending_mgr;

4926 
f
;

4927 
cou¡
;

4928 
i
;

4929 
°¨t
;

4930 
√xt
;

4932 
time•ec
 *
°¨t_ts
, *
√xt_ts
, 
diff_ts
;

4933 
ns
 = 0;

4934 
avg_us
 = 
DEFAULT_ARRIVAL_US
;

4936 
	`•ö_lock_úqßve
(&
≥ndög_mgr
->
lock
, 
f
);

4937 
cou¡
 = 
	`©omic_ªad
(&
≥ndög_mgr
->
¨rivÆ_cou¡
);

4938 if(
cou¡
<=1){

4940 
avg_us
 = 
su≥r
->
∑øm
.
sync_öãrvÆ
;

4941 
RESET
;

4944 
avg_us
 = 
su≥r
->
∑øm
.
sync_öãrvÆ
;

4945 
RESET
;

4947 
°¨t
 = 
	`©omic_ªad
(&
≥ndög_mgr
->
¨rivÆ_°¨t
);

4949 
i
 = 0;ò< 
cou¡
-1;i++){

4950 
√xt
 = (
°¨t
 + 1Ë% 
STRIPE_SZ
;

4951 
°¨t_ts
 = &
≥ndög_mgr
->
¨rivÆ_times
[
°¨t
];

4952 
√xt_ts
 = &
≥ndög_mgr
->
¨rivÆ_times
[
√xt
];

4954 
diff_ts
.
tv_£c
 = 
√xt_ts
->tv_£¯- 
°¨t_ts
->tv_sec;

4955 
diff_ts
.
tv_n£c
 = 
√xt_ts
->tv_n£¯- 
°¨t_ts
->tv_nsec;

4956 
ns
 +
diff_ts
.
tv_£c
 * 
NSEC_PER_SEC
 + diff_ts.
tv_n£c
;

4958 
°¨t
 = (°¨à+ 1)% 
STRIPE_SZ
;

4961 
avg_us
 = 
ns
/(
cou¡
-1)/1000;

4962 
RESET
:

4963 
	`ª£t_¨rivÆ_time
(
su≥r
);

4964 
	`•ö_u∆ock_úqª°‹e
(&
≥ndög_mgr
->
lock
, 
f
);

4966 
	`©omic64_add
(
avg_us
, &
su≥r
->
w°©
.
avîage_¨rivÆ_time
);

4967 
	`©omic64_öc
–&
su≥r
->
w°©
.
avîage_¨rivÆ_cou¡
);

4970  
avg_us
;

4971 
	}
}

4973 
	$upd©e_sync_dódlöe
(
dm§c_su≥r
 *
su≥r
)

4975 
sync_m™agî
 *
sync_mgr
 = &
su≥r
->sync_mgr;

4976 
u£c
;

4979 
u£c
 = 
	`gë_avg_¨rivÆ_time
(
su≥r
);

4984 
sync_mgr
->
≥riod
 = 
	`ktime_£t
(0, 
u£c
*1000);

4985 
	`hπimî_°¨t
–&
sync_mgr
->
hr_timî
, sync_mgr->
≥riod
, 
HRTIMER_MODE_REL
 );

4986 
	}
}

4988 
	$wp_¥öt_i›s
(
dm§c_su≥r
 *
su≥r
){

4989 
w‹klﬂd_¥edi˘‹
 *
wp
 = &
su≥r
->wp;

4990 
i
;

4992 
i
 = 0;ò< 
wp
->
num_wödow
;i++){

4993 
io_°©_t
 *
io°©
 = &
wp
->io°©[
i
];

4995 
	`¥ötk
(" [*%d:%d:%dMB/s]\n", 
i
, ()
	`©omic64_ªad
(&
io°©
->
i›s
[
REQ_CATEGORY_TOTAL
][
REQ_TYPE_TOTAL
]),

4996 ()
	`©omic64_ªad
(&
io°©
->
i›s
[
REQ_CATEGORY_TOTAL
][
REQ_TYPE_TOTAL
])/256);

5001 
	`¥ötk
("\n");

5003 
	}
}

5005 
u32
 
	$wp_gë_i›s
(
dm§c_su≥r
 *
su≥r
, 
u32
 *
bw_mb
, 
ˇãg‹y
, 
ty≥
){

5006 
w‹klﬂd_¥edi˘‹
 *
wp
 = &
su≥r
->wp;

5007 
u32
 
°¨t_wödow
;

5008 
u32
 
cur_wödow
;

5009 
u32
 
cur_i›s
;

5010 
io_°©_t
 *
io°©
;

5011 
Êags
;

5012 
i
;

5014 
cur_i›s
 = 0;

5016 
	`•ö_lock_úqßve
(&
wp
->
lock
, 
Êags
);

5018 
cur_wödow
 = 
	`©omic_ªad
(&
wp
->cur_window);

5019 
°¨t_wödow
 = 
	`©omic_ªad
(&
wp
->start_window);

5021 
i
 = 0;ò< 
wp
->
num_wödow
;i++){

5022 if(
°¨t_wödow
==
cur_wödow
)

5024 
io°©
 = &
wp
->io°©[
°¨t_wödow
];

5025 
cur_i›s
 +(
u32
)
	`©omic64_ªad
(&
io°©
->
i›s
[
ˇãg‹y
][
ty≥
]);

5026 
°¨t_wödow
 = (°¨t_wödow + 1Ë% 
wp
->
num_wödow
;

5029 
	`•ö_u∆ock_úqª°‹e
(&
wp
->
lock
, 
Êags
);

5030 
cur_i›s
 /(
wp
->
num_wödow
/wp->
wödow_≥r_£c
);

5032 if(
bw_mb
)

5033 *
bw_mb
 = 
cur_i›s
/256;

5035  
cur_i›s
;

5036 
	}
}

5038 
hπimî_ª°¨t
 
	$wp_di•œy
–
hπimî
 *
timî
 )

5040 
w‹klﬂd_¥edi˘‹
 *
wp
 = 
	`c⁄èöî_of
(
timî
, w‹klﬂd_¥edi˘‹, 
hr_timî_mëî
);

5042 if(
wp
->
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_HORI
){

5043 
	`¥ötk
(" CurBW: Total=%d, Write=%d, GCWrite=%d GCRead=%d MB/s\n",

5044 
	`wp_gë_i›s
(
wp
->
su≥r
, 
NULL
, 
REQ_CATEGORY_TOTAL
, 
REQ_TYPE_WRITE
)/256,

5045 
	`wp_gë_i›s
(
wp
->
su≥r
, 
NULL
, 
REQ_CATEGORY_NORMAL
, 
REQ_TYPE_WRITE
)/256,

5046 
	`wp_gë_i›s
(
wp
->
su≥r
, 
NULL
, 
REQ_CATEGORY_GC
, 
REQ_TYPE_WRITE
)/256,

5047 
	`wp_gë_i›s
(
wp
->
su≥r
, 
NULL
, 
REQ_CATEGORY_GC
, 
REQ_TYPE_READ
)/256);

5050 
	`hπimî_f‹w¨d_now
(
timî
, 
wp
->
di•œy_≥riod
);

5052  
HRTIMER_RESTART
;

5053 
	}
}

5055 
hπimî_ª°¨t
 
	$wp_ˇŒback
–
hπimî
 *
timî
 )

5057 
w‹klﬂd_¥edi˘‹
 *
wp
 = 
	`c⁄èöî_of
(
timî
, w‹klﬂd_¥edi˘‹, 
hr_timî_åack
);

5058 
io_°©_t
 *
io°©
;

5059 
i
, 
j
;

5060 
Êags
;

5064 
	`•ö_lock_úqßve
(&
wp
->
lock
, 
Êags
);

5065 
	`©omic_£t
(&
wp
->
cur_wödow
, ((
	`©omic_ªad
(&wp->cur_wödowË+ 1Ë% wp->
num_wödow
));

5066 if(
	`©omic_ªad
(&
wp
->
cur_wödow
)=˜tomic_ªad(&wp->
°¨t_wödow
)){

5067 
	`©omic_£t
(&
wp
->
°¨t_wödow
, ((
	`©omic_ªad
(&wp->°¨t_wödowË+ 1Ë% wp->
num_wödow
));

5070 
io°©
 = &
wp
->io°©[
	`©omic_ªad
(&wp->
cur_wödow
)];

5071 
i
 = 0;ò< 
REQ_CATEGORY_NUM
;i++){

5072 
j
 = 0;j < 
REQ_TYPE_NUM
;j++){

5073 
	`©omic64_£t
(&
io°©
->
i›s
[
i
][
j
], 0);

5076 
	`•ö_u∆ock_úqª°‹e
(&
wp
->
lock
, 
Êags
);

5078 
	`hπimî_f‹w¨d_now
(
timî
, 
wp
->
åack_≥riod
);

5080  
HRTIMER_RESTART
;

5081 
	}
}

5083 
	$wp_upd©e
(
dm§c_su≥r
 *
su≥r
, 
is_wrôe
, 
ˇãg‹y
){

5084 
w‹klﬂd_¥edi˘‹
 *
wp
 = &
su≥r
->wp;

5085 
io_°©_t
 *
io°©
 = &
wp
->io°©[
	`©omic_ªad
(&wp->
cur_wödow
)];

5087 
	`©omic64_öc
(&
io°©
->
i›s
[
ˇãg‹y
][
is_wrôe
]);

5088 
	`©omic64_öc
(&
io°©
->
i›s
[
ˇãg‹y
][
REQ_TYPE_TOTAL
]);

5090 
	`©omic64_öc
(&
io°©
->
i›s
[
REQ_CATEGORY_TOTAL
][
is_wrôe
]);

5091 
	`©omic64_öc
(&
io°©
->
i›s
[
REQ_CATEGORY_TOTAL
][
REQ_TYPE_TOTAL
]);

5092 
	}
}

5094 
	$wp_öô
(
dm§c_su≥r
 *
su≥r
)

5096 
w‹klﬂd_¥edi˘‹
 *
wp
 = &
su≥r
->wp;

5097 
i
, 
j
;

5098 
u32
 
åack_ms
;

5100 
wp
->
su≥r
 = super;

5101 
åack_ms
 = 100;

5102 
wp
->
wödow_≥r_£c
 = (
MSEC_PER_SEC
/
åack_ms
);

5103 
wp
->
num_wödow
 = wp->
wödow_≥r_£c
*2;

5104 if(
wp
->
num_wödow
>
MAX_WINDOW_NUM
)

5105 
wp
->
num_wödow
 = 
MAX_WINDOW_NUM
;

5107 
wp
->
åack_≥riod
 = 
	`ktime_£t
(0, 
åack_ms
*
NSEC_PER_MSEC
);

5108 
	`¥ötk
(" W‹klﬂd Pîdi˘‹:ÅøckögÖîiod = %dms\n", 
åack_ms
);

5110 
	`•ö_lock_öô
(&
wp
->
lock
);

5112 
	`hπimî_öô
–&
wp
->
hr_timî_åack
, 
CLOCK_MONOTONIC
, 
HRTIMER_MODE_REL
 );

5113 
wp
->
hr_timî_åack
.
fun˘i⁄
 = &
wp_ˇŒback
;

5114 
	`hπimî_°¨t
–&
wp
->
hr_timî_åack
, wp->
åack_≥riod
, 
HRTIMER_MODE_REL
 );

5116 
	`hπimî_öô
–&
wp
->
hr_timî_mëî
, 
CLOCK_MONOTONIC
, 
HRTIMER_MODE_REL
 );

5117 
wp
->
hr_timî_mëî
.
fun˘i⁄
 = &
wp_di•œy
;

5118 
wp
->
di•œy_≥riod
 = 
	`ktime_£t
(1, 0);

5119 
	`hπimî_°¨t
–&
wp
->
hr_timî_mëî
, wp->
di•œy_≥riod
, 
HRTIMER_MODE_REL
 );

5121 
i
 = 0;ò< 
wp
->
num_wödow
;i++){

5122 
io_°©_t
 *
io°©
 = &
wp
->io°©[
i
];

5123 
j
 = 0;j < 
REQ_TYPE_NUM
;j++){

5124 
	`©omic64_£t
(&
io°©
->
i›s
[
i
][
j
], 0);

5128 
	`©omic_£t
(&
wp
->
cur_wödow
,0);

5129 
	`©omic_£t
(&
wp
->
°¨t_wödow
,0);

5132 
wp
->
öôülized
 = 1;

5135 
	}
}

5137 
	$wp_˛ónup
(
dm§c_su≥r
 *
su≥r
)

5139 
w‹klﬂd_¥edi˘‹
 *
wp
 = &
su≥r
->wp;

5140 
ªt
;

5142 if(
wp
->
öôülized
==0)

5145 
ªåy
:

5146 
ªt
 = 
	`hπimî_ˇn˚l
–&
wp
->
hr_timî_åack
 );

5147 i‡(
ªt
) {

5148 
ªåy
;

5151 
ªt
 = 
	`hπimî_ˇn˚l
–&
wp
->
hr_timî_mëî
 );

5152 i‡(
ªt
) {

5153 
ªåy
;

5156 
wp
->
öôülized
 = 0;

5159 
	}
}

5163 
	$put_devi˚s
(
dm§c_su≥r
 *
su≥r
){

5164 
dm_èrgë
 *
ti
 = 
su≥r
->ti;

5165 
devi˚_öfo
 *
dev_öfo
 = &
su≥r
->dev_info;

5166 
dm_dev
 *
dev
;

5167 
i
;

5169 
dev
 = 
dev_öfo
->
‹igö_dev
;

5170 if(
dev
){

5171 
	`dm_put_devi˚
(
ti
, 
dev
);

5173 
dev_öfo
->
‹igö_dev
 = 
NULL
;;

5175 
i
 = 0;ò< 
dev_öfo
->
num_ˇche_devs
;i++){

5176 
dev
 = 
dev_öfo
->
ˇche_dev
[
i
];

5177 if(
dev
)

5178 
	`dm_put_devi˚
(
ti
, 
dev
);

5179 
dev_öfo
->
ˇche_dev
[
i
] = 
NULL
;

5182 
i
 = 0;ò< 
su≥r
->
dev_öfo
.
num_•¨e_ˇche_devs
;i++){

5183 
dev
 = 
dev_öfo
->
•¨e_ˇche_dev
[
i
];

5184 if(
dev
)

5185 
	`dm_put_devi˚
(
ti
, 
dev
);

5186 
dev_öfo
->
•¨e_ˇche_dev
[
i
] = 
NULL
;

5188 
	}
}

5190 
	$gë_devi˚s
(
dm§c_su≥r
 *
su≥r
){

5191 
dm_èrgë
 *
ti
 = 
su≥r
->ti;

5192 
devi˚_öfo
 *
dev_öfo
 = &
su≥r
->dev_info;

5193 
i
;

5194 
r
;

5195 *
°r
;

5197 
°r
 = 
dev_öfo
->
‹igö_«me
;

5198 
r
 = 
	`dm_gë_devi˚
(
ti
, 
°r
, 
	`dm_èbÀ_gë_mode
—i->
èbÀ
),

5199 &
su≥r
->
dev_öfo
.
‹igö_dev
);

5200 if(
r
){

5201 
ti
->
îr‹
 = "couldn't get origin dev";

5202  
r
;

5205 
i
 = 0;ò< 
dev_öfo
->
num_ˇche_devs
;i++){

5206 
°r
 = 
dev_öfo
->
ˇche_«me
[
i
];

5207 
r
 = 
	`dm_gë_devi˚
(
ti
, 
°r
, 
	`dm_èbÀ_gë_mode
—i->
èbÀ
),

5208 &
su≥r
->
dev_öfo
.
ˇche_dev
[
i
]);

5209 i‡(
r
) {

5210 
ti
->
îr‹
 = "couldn't get cache dev";

5211 
	`¥ötk
–"couldn'àgë cachêdev %†\n", 
°r
);

5212 
bad
;

5218 
bad
:

5219 
	`put_devi˚s
(
su≥r
);

5221  
r
;

5222 
	}
}

5224 
	$ˇlc_√ed_num_ssds
(
dm§c_su≥r
 *
su≥r
){

5225 
u32
 
cur_bw_mb
;

5226 
u32
 
ªmaö_bw
;

5227 
u32
 
√ed_ssds
;

5229 
	`wp_gë_i›s
(
su≥r
, &
cur_bw_mb
, 
REQ_CATEGORY_TOTAL
, 
REQ_TYPE_WRITE
);

5231 
√ed_ssds
 = 
cur_bw_mb
 / 
su≥r
->
dev_öfo
.
≥r_ˇche_bw
 + 1;

5232 
ªmaö_bw
 = 
cur_bw_mb
 % 
su≥r
->
dev_öfo
.
≥r_ˇche_bw
;

5233 if(
ªmaö_bw
 > 
cur_bw_mb
 / 
su≥r
->
dev_öfo
.
≥r_ˇche_bw
)

5234 
√ed_ssds
++;

5236 if(
√ed_ssds
> 
NUM_SSD
)

5237 
√ed_ssds
 = 
NUM_SSD
;

5239 if(
√ed_ssds
<2)

5240 
√ed_ssds
 = 2;

5242 
	`¥ötk
(" bw_mb = %d, NUM SSD†%d \n", 
cur_bw_mb
, 
√ed_ssds
);

5244  
√ed_ssds
;

5245 
	}
}

5247 
	$devöfo_öô
(
dm§c_su≥r
 *
su≥r
, 
num_ssd
){

5248 
i
;

5249 
r
 = 0;

5251 
su≥r
->
dev_öfo
.
num_•¨e_ˇche_devs
 = 0;

5252 
i
 = 0;ò< 
MAX_CACHE_DEVS
;i++){

5253 
su≥r
->
dev_öfo
.
•¨e_ˇche_dev
[
i
] = 
NULL
;

5256 if(
	`USE_ERASURE_RAID6
(&
su≥r
->
∑øm
)){

5257 if(
NUM_SSD
<4){

5258 
	`¥ötk
(" NUM SSD i†toÿsmÆ»%d \n", 
NUM_SSD
);

5259 
r
 = -1;

5261 }if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
)){

5262 if(
NUM_SSD
<2){

5263 
	`¥ötk
(" NUM SSD i†toÿsmÆ»%d \n", 
NUM_SSD
);

5264 
r
 = -1;

5268 if(
	`NO_USE_ERASURE_CODE
(&
su≥r
->
∑øm
))

5269 
NUM_DATA_SSD
 = 
NUM_SSD
;

5270 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
))

5271 
NUM_DATA_SSD
 = 
NUM_SSD
-1;

5273 
NUM_DATA_SSD
 = 
NUM_SSD
-2;

5275 
su≥r
->
dev_öfo
.
≥r_ˇche_bw
 = 200;

5276  
r
;

5277 
	}
}

5279 
	$hŸ_fûãr_check
(
dm§c_su≥r
 *
su≥r
, 
∑gío
){

5280 
hŸ_d©a_fûãr
 *
hŸ_fûãr
 = &
su≥r
->hot_filter;

5281 
Êags
;

5282 *
cur_bôm≠_±r
;

5283 
off£t
[8];

5284 
hŸ_cou¡
 = 0;

5285 
i
;

5288 
off£t
[0] = 
	`¸c32
(17, (*)&
∑gío
, ()Ë% 
hŸ_fûãr
->
num_bôs_≥r_èbÀ
;

5289 
off£t
[1] = 
	`jhash_1w‹d
(
∑gío
, 0xbìfË% 
hŸ_fûãr
->
num_bôs_≥r_èbÀ
;

5290 
off£t
[2] = 
	`hash_32
(
∑gío
, 32Ë% 
hŸ_fûãr
->
num_bôs_≥r_èbÀ
;

5292 
	`•ö_lock_úqßve
(&
hŸ_fûãr
->
lock
, 
Êags
);

5293 
i
 = 0;ò< 
hŸ_fûãr
->
bôm≠_èbÀ_num
;i++){

5294 
cur_bôm≠_±r
 = 
hŸ_fûãr
->
bôm≠
[
i
];

5295 if(
	`ã°_bô
(
off£t
[0], 
cur_bôm≠_±r
) &&

5296 
	`ã°_bô
(
off£t
[1], 
cur_bôm≠_±r
) &&

5297 
	`ã°_bô
(
off£t
[2], 
cur_bôm≠_±r
))

5299 
hŸ_cou¡
++;

5302 
	`•ö_u∆ock_úqª°‹e
(&
hŸ_fûãr
->
lock
, 
Êags
);

5304 if(
hŸ_cou¡
>=
hŸ_fûãr
->
hŸ_thªshﬁd
)

5309 
	}
}

5311 
	$hŸ_fûãr_upd©e
(
dm§c_su≥r
 *
su≥r
, 
∑gío
){

5312 
hŸ_d©a_fûãr
 *
hŸ_fûãr
 = &
su≥r
->hot_filter;

5313 
Êags
;

5314 *
cur_bôm≠
;

5315 
off£t
[8];

5318 
off£t
[0] = 
	`¸c32
(17, (*)&
∑gío
, ()Ë% 
hŸ_fûãr
->
num_bôs_≥r_èbÀ
;

5319 
off£t
[1] = 
	`jhash_1w‹d
(
∑gío
, 0xbìfË% 
hŸ_fûãr
->
num_bôs_≥r_èbÀ
;

5320 
off£t
[2] = 
	`hash_32
(
∑gío
, 32Ë% 
hŸ_fûãr
->
num_bôs_≥r_èbÀ
;

5322 
	`•ö_lock_úqßve
(&
hŸ_fûãr
->
lock
, 
Êags
);

5323 
cur_bôm≠
 = 
hŸ_fûãr
->
bôm≠
[hŸ_fûãr->
cur_èbÀ
];

5324 
	`£t_bô
(
off£t
[0], 
cur_bôm≠
);

5325 
	`£t_bô
(
off£t
[1], 
cur_bôm≠
);

5326 
	`£t_bô
(
off£t
[2], 
cur_bôm≠
);

5328 
hŸ_fûãr
->
io_cou¡
++;

5329 if(
hŸ_fûãr
->
io_cou¡
 =hŸ_fûãr->
deˇy_≥riod
){

5330 
hŸ_fûãr
->
io_cou¡
 = 0;

5331 
hŸ_fûãr
->
cur_èbÀ
 = (hŸ_fûãr->cur_èbÀ + 1Ë% hŸ_fûãr->
bôm≠_èbÀ_num
;

5332 if(
hŸ_fûãr
->
cur_èbÀ
 =hŸ_fûãr->
œ°_èbÀ
){

5333 
hŸ_fûãr
->
œ°_èbÀ
 = (hŸ_fûãr->œ°_èbÀ + 1Ë% hŸ_fûãr->
bôm≠_èbÀ_num
;

5335 
	`mem£t
(
hŸ_fûãr
->
bôm≠
[hŸ_fûãr->
cur_èbÀ
], 0x00, hŸ_fûãr->
num_byãs_≥r_èbÀ
);

5337 
	`•ö_u∆ock_úqª°‹e
(&
hŸ_fûãr
->
lock
, 
Êags
);

5339 
	}
}

5341 
	#˚û
(
n
, 
d
Ë((“Ë< 0Ë? (-((-“))/(d))Ë: (n)/(dË+ (“)%(dË!0))

	)

5343 
	$hŸ_fûãr_öô
(
dm§c_su≥r
 *
su≥r
){

5344 
hŸ_d©a_fûãr
 *
hŸ_fûãr
 = &
su≥r
->hot_filter;

5345 
i
;

5347 
	`•ö_lock_öô
(&
hŸ_fûãr
->
lock
);

5349 
hŸ_fûãr
->
cur_èbÀ
 = 0;

5350 
hŸ_fûãr
->
œ°_èbÀ
 = 0;

5351 
hŸ_fûãr
->
hash_num
 = 3;

5352 
hŸ_fûãr
->
hŸ_thªshﬁd
 = 2;

5353 
hŸ_fûãr
->
deˇy_≥riod
 = 
NUM_BLOCKS
/2;

5355 
hŸ_fûãr
->
bôm≠_èbÀ_num
 = 
MAX_BITMAP_TABLE
;

5356 
hŸ_fûãr
->
num_bôs_≥r_èbÀ
 = 
NUM_BLOCKS
 * hŸ_fûãr->
hash_num
;

5357 
hŸ_fûãr
->
num_byãs_≥r_èbÀ
 = 
	`˚û
(hŸ_fûãr->
num_bôs_≥r_èbÀ
, 8);

5358 
	`¥ötk
("Çum bô†≥∏èbÀ = %d \n", 
hŸ_fûãr
->
num_bôs_≥r_èbÀ
);

5360 
i
 = 0;ò<
hŸ_fûãr
->
bôm≠_èbÀ_num
;i++){

5361 
	`¥ötk
(" HŸ Fûãr[%d]: byã†≥∏èbÀ = %dKB \n", 
i
, 
hŸ_fûãr
->
num_byãs_≥r_èbÀ
/1024);

5362 
hŸ_fûãr
->
bôm≠
[
i
] = 
	`vmÆloc
(hŸ_fûãr->
num_byãs_≥r_èbÀ
);

5363 if(!
hŸ_fûãr
->
bôm≠
[
i
]){

5364 
	`¥ötk
(" vmallocÉrror \n");

5367 
	`mem£t
(
hŸ_fûãr
->
bôm≠
[
i
], 0x00, hŸ_fûãr->
num_byãs_≥r_èbÀ
);

5371 
	}
}

5373 
	$hŸ_fûãr_deöô
(
dm§c_su≥r
 *
su≥r
){

5374 
hŸ_d©a_fûãr
 *
hŸ_fûãr
 = &
su≥r
->hot_filter;

5375 
i
;

5377 
i
 = 0;ò<
hŸ_fûãr
->
bôm≠_èbÀ_num
;i++){

5378 if(
hŸ_fûãr
->
bôm≠
[
i
])

5379 
	`v‰ì
(
hŸ_fûãr
->
bôm≠
[
i
]);

5381 
	}
}

5383 
	#CREATE_DAEMON
(
«me
) \

5385 
su≥r
->
«me
##
_d´m⁄
 = 
	`kthªad_¸óã
“ame##
_¥oc
, super, \

5387 i‡(
	`IS_ERR
(
su≥r
->
«me
##
_d´m⁄
)) { \

5388 
r
 = 
	`PTR_ERR
(
su≥r
->
«me
##
_d´m⁄
); \

5389 
su≥r
->
«me
##
_d´m⁄
 = 
NULL
; \

5390 
	`WBERR
("couldn't spawn" #name "daemon"); \

5391 
bad_
##
«me
##
_d´m⁄
; \

5393 
	`wake_up_¥o˚ss
(
su≥r
->
«me
##
_d´m⁄
); \

5394 } 0)

	)

5399 
	$¥öt_∑øm
(
dm§c_su≥r
 *
su≥r
){

5401 
	`¥ötk
(" SRC PagêSizê%d \n", 
SRC_PAGE_SIZE
);

5402 
	`¥ötk
(" SRC Se˘‹†≥∏Pagê%d \n", 
SRC_SECTORS_PER_PAGE
);

5403 
	`¥ötk
(" SRC Se˘‹†≥∏PagêShi· = %d \n", 
SRC_SECTORS_PER_PAGE_SHIFT
);

5405 if(
SUMMARY_SCHEME
==
SUMMARY_PER_CHUNK
)

5406 
	`¥ötk
(" Summary Scheme: Per Chunk\n");

5408 
	`¥ötk
(" Summary Scheme: Per Stripe (Unsupported)\n");

5409 
	`BUG_ON
(1);

5412 if(
	`NO_USE_ERASURE_CODE
(&
su≥r
->
∑øm
))

5413 
	`¥ötk
(" Erasure Code: None\n");

5414 if(
	`USE_ERASURE_PARITY
(&
su≥r
->
∑øm
))

5415 
	`¥ötk
(" Erasure Code: Parity\n");

5417 
	`¥ötk
(" Erasure Code: RAID-6\n");

5420 if(
su≥r
->
∑øm
.
∑rôy_Æloˇti⁄
==
PARITY_ALLOC_FIXED
)

5421 
	`¥ötk
(" Parity Allocation: Fixed\n");

5423 
	`¥ötk
(" Parity Allocation: Rotated\n");

5425 if(
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_HORI
)

5426 
	`¥ötk
(" Data Allocation: Horizontal\n");

5427 if(
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_VERT
)

5428 
	`¥ötk
(" Data Allocation: Vertical\n");

5429 if(
su≥r
->
∑øm
.
d©a_Æloˇti⁄
==
DATA_ALLOC_FLEX_VERT
)

5430 
	`¥ötk
(" Data Allocation: Flexible Vertical \n");

5432 
	`¥ötk
(" Data Allocation: Flexible Horizontal\n");

5434 if(
su≥r
->
∑øm
.
°rùög_pﬁicy
==
SEPAR_STRIPING
)

5435 
	`¥ötk
(" Striping Policy: Separated\n");

5437 
	`¥ötk
(" Striping Policy: Mixed\n");

5439 if(
su≥r
->
∑øm
.
hô_bôm≠_ty≥
==
HIT_BITMAP_PER_STRIPE
)

5440 
	`¥ötk
(" Hit Bitmap Type: Per Stripe\n");

5442 
	`¥ötk
(" Hit Bitmap Type: Per Block\n");

5444 if(
su≥r
->
∑øm
.
ª˛aim_pﬁicy
==
RECLAIM_SELECTIVE
)

5445 
	`¥ötk
(" Reclaim Policy: Selective \n");

5446 if(
su≥r
->
∑øm
.
ª˛aim_pﬁicy
==
RECLAIM_GC
)

5447 
	`¥ötk
(" Reclaim Policy: GC\n");

5449 
	`¥ötk
(" Reclaim Policy: Destage\n");

5451 if(
su≥r
->
∑øm
.
vi˘im_pﬁicy
==
VICTIM_GREEDY
)

5452 
	`¥ötk
(" Victim Policy: Greedy\n");

5453 if(
su≥r
->
∑øm
.
vi˘im_pﬁicy
==
VICTIM_CLOCK
)

5454 
	`¥ötk
(" Victim Policy: Clock\n");

5456 
	`¥ötk
(" Victim Policy: LRU\n");

5458 
	`¥ötk
(" Chunk sizê%d,(%dKBË\n", 
su≥r
->
∑øm
.
chunk_size
, 
SECTOR_SIZE
 * super->param.chunk_size/1024);

5459 
	`¥ötk
(" Num Summ¨y = %d\n", 
su≥r
->
∑øm
.
num_summ¨y_≥r_chunk
);

5460 
	`¥ötk
(" Mëablock sizê%d \n", ()(
mëablock
));

5461 
	`¥ötk
(" GC Low W©î = %d Segmít†\n", 
MIGRATE_LOWWATER
);

5462 
	`¥ötk
(" GC HIGH W©î = %d Segmít†\n", 
MIGRATE_HIGHWATER
);

5463 
	`¥ötk
(" Dúty Seg Buf„∏Timeout%d u†\n", 
su≥r
->
∑øm
.
sync_öãrvÆ
);

5464 
	}
}

5466 
__mu°_check
 
	$ªsume_m™agîs
(
dm§c_su≥r
 *
su≥r
)

5468 
r
 = 0;

5470 
r
 = 
	`öô_ømbuf_poﬁ
(
su≥r
);

5471 if(
r
)

5472  
r
;

5474 
r
 = 
	`öô_£gmít_hódî_¨øy
(
su≥r
);

5475 if(
r
)

5476  
r
;

5478 
r
 = 
	`ht_em±y_öô
(
su≥r
);

5479 if(
r
)

5480  
r
;

5483 
r
 = 
	`migøã_mgr_öô
(
su≥r
);

5484 if(
r
)

5485  
r
;

5488 
r
 = 
	`Êush_mgr_öô
(
su≥r
);

5489 if(
r
)

5490  
r
;

5492 
r
 = 
	`ªcovîy_mgr_öô
(
su≥r
);

5493 if(
r
)

5494  
r
;

5496 
r
 = 
	`∂uggî_öô
(
su≥r
);

5497 if(
r
)

5498  
r
;

5500 
r
 = 
	`sync_mgr_öô
(
su≥r
);

5501 if(
r
)

5502  
r
;

5504 
r
 = 
	`ªad_miss_mgr_öô
(
su≥r
);

5505 if(
r
)

5506  
r
;

5508 
r
 = 
	`≥ndög_mgr_öô
(
su≥r
);

5509 if(
r
)

5510  
r
;

5512 #i‡(
USE_SEG_WRITER
 == 1)

5513 
r
 = 
	`£g_wrôe_mgr_öô
(
su≥r
);

5514 if(
r
)

5515  
r
;

5518 
r
 = 
	`¸óã_d´m⁄
(
su≥r
, &su≥r->
checkî_d´m⁄
, 
checkî_¥oc
, "checker_daemon");

5519 if(
r
)

5520  
r
;

5522 
r
 = 
	`wp_öô
(
su≥r
);

5523 if(
r
)

5524  
r
;

5526 if(
su≥r
->
∑øm
.
íabÀ_ªad_ˇche
){

5527 
	`¥ötk
(" cÀ™ døm buf„∏sizê%dMB \n", 
su≥r
->
∑øm
.
ømbuf_poﬁ_amou¡
/256);

5528 
	`Ãu_öô
(&
su≥r
->
˛ón_døm_ˇche_m™agî
, "LRU", su≥r->
∑øm
.
ømbuf_poﬁ_amou¡
, 1, 0);

5531 #ifde‡
USE_GHOST_BUFFER


5532 if(
su≥r
->
∑øm
.
hŸ_idítifiˇti⁄
){

5534 
r
 = 
	`hŸ_fûãr_öô
(
su≥r
);

5535 if(
r
)

5536  
r
;

5540 
	`£g_Æloˇt‹_öô
(
su≥r
);

5541 
	`£q_dëe˘‹_öô
(
su≥r
);

5542 
r
 = 
	`mu…i_Æloˇt‹_öô
(
su≥r
);

5544  
r
;

5545 
	}
}

5547 
	$°›_m™agîs
(
dm§c_su≥r
 *
su≥r
){

5549 
	`¥ötk
(" Stopping check mgr \n");

5550 if(
su≥r
->
checkî_d´m⁄
){

5551 
	`wake_up_¥o˚ss
(
su≥r
->
checkî_d´m⁄
);

5552 
	`kthªad_°›
(
su≥r
->
checkî_d´m⁄
);

5555 
	`wp_˛ónup
(
su≥r
);

5557 
	`¥ötk
(" Stopping sync damone \n");

5558 
	`sync_mgr_deöô
(
su≥r
);

5560 
	`¥ötk
(" Stopping migrate damone \n");

5561 
	`migøã_mgr_deöô
(
su≥r
);

5563 
	`¥ötk
(" Stopping flush mgr \n");

5564 
	`Êush_mgr_deöô
(
su≥r
);

5566 
	`ªcovîy_mgr_deöô
(
su≥r
);

5568 
	`∂uggî_deöô
(
su≥r
);

5569 
	`¥ötk
(" StoppingÑead miss damone \n");

5570 
	`ªad_miss_mgr_deöô
(
su≥r
);

5571 #i‡(
USE_SEG_WRITER
 == 1)

5572 
	`£g_wrôe_mgr_deöô
(
su≥r
);

5574 
	`¥ötk
(" StoppingÖending damone \n");

5575 
	`≥ndög_mgr_exô
(
su≥r
);

5577 
	`‰ì_ømbuf_poﬁ
(
su≥r
);

5578 
	`‰ì_£gmít_hódî_¨øy
(
su≥r
);

5579 
	`‰ì_ht
(
su≥r
);

5581 
	`mu…i_Æloˇt‹_deöô
(
su≥r
);

5583 if(
su≥r
->
∑øm
.
íabÀ_ªad_ˇche
){

5584 if(
su≥r
->
˛ón_døm_ˇche_m™agî
)

5585 
	`Ãu_deöô
(
su≥r
->
˛ón_døm_ˇche_m™agî
);

5588 #ifde‡
USE_GHOST_BUFFER


5589 if(
su≥r
->
∑øm
.
hŸ_idítifiˇti⁄
){

5592 
	`hŸ_fûãr_deöô
(
su≥r
);

5595 
	`¥ötk
(" Stoppingáll manages \n");

5596 
	}
}

5603 
	$dm§c_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

5605 
dm§c_su≥r
 *
su≥r
;

5606 
r
 = 0;

5608 
r
 = 
	`dm_£t_èrgë_max_io_Àn
(
ti
, (
SRC_SECTORS_PER_PAGE
));

5609 i‡(
r
) {

5610 
ti
->
îr‹
 = "failedÅo set max_io_len";

5611  
r
;

5614 
su≥r
 = 
	`kzÆloc
((*su≥r), 
GFP_KERNEL
);

5615 i‡(!
su≥r
) {

5616 
ti
->
îr‹
 = "couldn'tállocate super";

5617  -
ENOMEM
;

5620 
ti
->
Êush_suµ‹ãd
 = 
åue
;

5621 
ti
->
disˇrds_suµ‹ãd
 = 
Ál£
;

5622 
ti
->
num_Êush_bios
 = 1;

5623 
ti
->
num_disˇrd_bios
 = 1;

5624 
ti
->
disˇrd_zî€s_d©a_unsuµ‹ãd
 = 
åue
;

5625 
ti
->
≥r_bio_d©a_size
 = (
bio_˘x
);

5626 
ti
->
¥iv©e
 = 
su≥r
;

5628 
su≥r
->
ti
 =Åi;

5629 
	`•ö_lock_öô
(&
su≥r
->
io_lock
);

5631 
su≥r
->
io_˛õ¡
 = 
	`dm_io_˛õ¡_¸óã
();

5632 i‡(
	`IS_ERR
(
su≥r
->
io_˛õ¡
)) {

5633 
	`WBERR
("failedÅoálloc io_client");

5634 
r
 = 
	`PTR_ERR
(
su≥r
->
io_˛õ¡
);

5635 
bad_öô
;

5638 
	`£t_deÁu…_∑øm
(
su≥r
, &su≥r->
∑øm
);

5640 
r
 = 
	`c⁄sume_es£¡ül_¨gv
(
su≥r
, 
¨gc
, 
¨gv
);

5641 if(
r
){

5642 
bad_öô
;

5645 
r
 = 
	`gë_devi˚s
(
su≥r
);

5646 if(
r
){

5647 
bad_öô
;

5650 
r
 = 
	`sˇn_su≥rblock
(
su≥r
);

5651 i‡(
r
) {

5652 
ti
->
îr‹
 = "failedÅoáudit cache device";

5653 
bad_öô
;

5656 
r
 = 
	`devöfo_öô
(
su≥r
, su≥r->
dev_öfo
.
num_ˇche_devs
);

5657 i‡(
r
) {

5658 
ti
->
îr‹
 = "failedÅo init devinfo";

5659 
bad_öô
;

5662 if(
	`USE_ERASURE_CODE
(&
su≥r
->
∑øm
))

5663 
	`øid_c⁄f_öô
(
su≥r
, &su≥r->
øid_c⁄f
);

5665 
r
 = 
	`ªsume_m™agîs
(
su≥r
);

5666 i‡(
r
) {

5667 
ti
->
îr‹
 = "failedÅoÑesume managers";

5668 
bad_öô
;

5671 
r
 = 
	`sˇn_mëad©a
(
su≥r
);

5672 i‡(
r
) {

5673 
ti
->
îr‹
 = " failedÅoÑecovery metadata in SSDs";

5674 
bad_öô
;

5677 
	`°©_öô
(
su≥r
);

5678 
	`¥öt_∑øm
(
su≥r
);

5680 
	`¥ötk
(" DM-SRC has been successfuly started. \n");

5681  
r
;

5683 
bad_öô
:

5685 
	`dm§c_då
(
ti
);

5687  
r
;

5688 
	}
}

5691 
	$dm§c_då
(
dm_èrgë
 *
ti
)

5693 
dm§c_su≥r
 *
su≥r
 = 
ti
->
¥iv©e
;

5695 
	`°›_m™agîs
(
su≥r
);

5696 
	`put_devi˚s
(
su≥r
);

5697 if(
su≥r
->
io_˛õ¡
)

5698 
	`dm_io_˛õ¡_de°roy
(
su≥r
->
io_˛õ¡
);

5699 
	`k‰ì
(
su≥r
);

5700 
ti
->
¥iv©e
 = 
NULL
;

5702 
	`¥ötk
(" DM-SRC has beenÑemoved.\n");

5703 
	}
}

5706 
	$dm§c_ªsume
(
dm_èrgë
 *
ti
Ë{
	}
}

5708 
	$dm§c_mesßge
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

5710 
dm_¨g_£t
 
as
;

5711 
as
.
¨gc
 =árgc;

5712 
as
.
¨gv
 =árgv;

5714  
	`do_c⁄sume_tu«bÀ_¨gv
(
ti
, &
as
, 2);

5715 
	}
}

5717 
	$dm§c_mîge
(
dm_èrgë
 *
ti
, 
bvec_mîge_d©a
 *
bvm
,

5718 
bio_vec
 *
biovec
, 
max_size
)

5720 
dm§c_su≥r
 *
su≥r
 = 
ti
->
¥iv©e
;

5721 
dm_dev
 *
devi˚
 = 
su≥r
->
dev_öfo
.
‹igö_dev
;

5722 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
devi˚
->
bdev
);

5724 i‡(!
q
->
mîge_bvec_‚
)

5725  
max_size
;

5727 
bvm
->
bi_bdev
 = 
devi˚
->
bdev
;

5728  
	`mö
(
max_size
, 
q
->
	`mîge_bvec_‚
(q, 
bvm
, 
biovec
));

5729 
	}
}

5731 
	$dm§c_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

5732 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

5734 
dm§c_su≥r
 *
su≥r
;

5735 
dm_dev
 *
‹ig
;

5736 
£˘‹_t
 
°¨t
 = 0;

5737 
£˘‹_t
 
Àn
;

5739 
su≥r
 = 
ti
->
¥iv©e
;

5740 
‹ig
 = 
su≥r
->
dev_öfo
.
‹igö_dev
;

5741 if(
‹ig
){

5742 
Àn
 = 
su≥r
->
dev_öfo
.
‹igö_£˘‹s
;

5743  
	`‚
(
ti
, 
‹ig
, 
°¨t
, 
Àn
, 
d©a
);

5746 
	}
}

5748 
èrgë_ty≥
 
	gdm§c_èrgë
 = {

5749 .
«me
 = "dmsrc",

5750 .
	gvîsi⁄
 = {0, 1, 0},

5751 .
	gmoduÀ
 = 
THIS_MODULE
,

5752 .
	gm≠
 = 
dm§c_m≠
,

5753 .
	gíd_io
 = 
dm§c_íd_io
,

5754 .
	g˘r
 = 
dm§c_˘r
,

5755 .
	gdå
 = 
dm§c_då
,

5756 .
	gªsume
 = 
dm§c_ªsume
,

5757 .
	gmîge
 = 
dm§c_mîge
,

5758 .
	gmesßge
 = 
dm§c_mesßge
,

5759 .
	gôî©e_devi˚s
 = 
dm§c_ôî©e_devi˚s
,

5762 
__öô
 
	$dm§c_moduÀ_öô
()

5764 
r
 = 0;

5766 
r
 = 
	`dm_ªgi°î_èrgë
(&
dm§c_èrgë
);

5767 i‡(
r
 < 0) {

5768 
	`WBERR
("ÁûedÅÿªgi°îÅ¨gëÉº(%d)", 
r
);

5769  
r
;

5773 
	}
}

5775 
__exô
 
	$dm§c_moduÀ_exô
()

5777 
	`dm_uƒegi°î_èrgë
(&
dm§c_èrgë
);

5778 
	}
}

5780 
moduÀ_öô
(
dm§c_moduÀ_öô
);

5781 
moduÀ_exô
(
dm§c_moduÀ_exô
);

5783 
MODULE_AUTHOR
("Yongseok Oh <ysoh@uos.ac.kr>");

5784 
MODULE_DESCRIPTION
(
DM_NAME
 " dmsrcÅarget");

5785 
MODULE_LICENSE
("GPL");

	@target.h

23 #i‚de‡
DM_SRC_H


24 
	#DM_SRC_H


	)

26 
	#DM_MSG_PREFIX
 "dm-§c"

	)

28 
	~<löux/moduÀ.h
>

29 
	~<löux/vîsi⁄.h
>

30 
	~<löux/li°.h
>

31 
	~<löux/¶ab.h
>

32 
	~<löux/vmÆloc.h
>

33 
	~<löux/muãx.h
>

34 
	~<löux/kthªad.h
>

35 
	~<löux/sched.h
>

36 
	~<löux/timî.h
>

37 
	~<löux/w‹kqueue.h
>

38 
	~<löux/devi˚-m≠≥r.h
>

39 
	~<löux/dm-io.h
>

40 
	~<löux/ty≥s.h
>

41 
	~"øid.h
"

42 
	~"hódî.h
"

45 
	#CRC_SEED
 17

	)

47 
	#NUM_SSD
 (
su≥r
->
dev_öfo
.
num_ˇche_devs
)

	)

48 
	#NUM_DATA_SSD
 (
su≥r
->
dev_öfo
.
num_d©a_ˇche_devs
)

49 

	)

50 
	#NUM_BLOCKS
 (
su≥r
->
ˇche_°©
.
num_blocks_≥r_ssd
 * 
NUM_SSD
)

	)

51 
	#NUM_USED_BLOCKS
 (
	`©omic_ªad
(&
su≥r
->
ˇche_°©
.
num_u£d_blocks
))

	)

52 
	#NUM_BLOCKS_PER_SSD
 (
su≥r
->
ˇche_°©
.
num_blocks_≥r_ssd
)

	)

54 
	#CHUNK_SZ
 (
su≥r
->
ˇche_°©
.
num_blocks_≥r_chunk
)

	)

55 
	#CHUNK_SZ_SECTOR
 (
su≥r
->
ˇche_°©
.
num_blocks_≥r_chunk
<<3)

	)

57 
	#SEGMENT_GROUP_SIZE
 (
su≥r
->
ˇche_°©
.
num_chunks_≥r_group
)

	)

58 
	#GROUP_SZ
 (
SEGMENT_GROUP_SIZE
*
su≥r
->
ˇche_°©
.
num_blocks_≥r_chunk
)

	)

59 
	#GROUP_SZ_SECTOR
 (
SEGMENT_GROUP_SIZE
*(
su≥r
->
ˇche_°©
.
num_blocks_≥r_chunk
<<3))

	)

61 
	#STRIPE_SZ
 (
CHUNK_SZ
 * 
NUM_SSD
)

	)

62 
	#STRIPE_SZ_SECTOR
 (
CHUNK_SZ_SECTOR
 * 
NUM_SSD
)

	)

64 
	#SEG_START_IDX
(
s
Ë(s->
£g_id
 * 
STRIPE_SZ
)

	)

67 
	#NO_USE_ERASURE_CODE
(
∑øm
Ë(’¨am)->
îasuª_code
==
ERASURE_CODE_NONE
)

	)

68 
	#USE_ERASURE_CODE
(
∑øm
Ë(’¨am)->
îasuª_code
!=
ERASURE_CODE_NONE
)

	)

69 
	#USE_ERASURE_PARITY
(
∑øm
Ë(’¨am)->
îasuª_code
==
ERASURE_CODE_PARITY
)

	)

70 
	#USE_ERASURE_RAID6
(
∑øm
Ë(’¨am)->
îasuª_code
==
ERASURE_CODE_RAID6
)

	)

72 
	#STRIPING_POLICY
 (
su≥r
->
∑øm
.
°rùög_pﬁicy
)

	)

74 
	#MIGRATE_LOWWATER
 (
su≥r
->
∑øm
.
migøã_loww©î
)

	)

75 
	#MIGRATE_HIGHWATER
 (
su≥r
->
∑øm
.
migøã_highw©î
)

	)

78 
	#SEQ_CUTOFF
 (8192*512)

79 
	#SEQ_CUTOFF_MIN
 (256*512)

80 
	#SEQ_CUTOFF_MAX
 (
SEQ_CUTOFF
*4)

81 

	)

83 
	#TIMEOUT_US
 10

	)

86 
	#RES_MIG
 1

	)

87 
	#RES_PARTIAL
 2

	)

88 
	#RES_SEAL
 3

	)

89 
	#RES_NOFREE1
 4

	)

90 
	#RES_NOFREE2
 5

	)

91 
	#RES_FLUSH
 6

	)

92 
	#RES_BYPASS
 7

	)

93 
	#RES_ACTIVE
 8

	)

94 
	#RES_DRAM
 9

	)

95 
	#RES_COUNT
 10

	)

99 
	#SEG_CLEAN
 0

	)

100 
	#SEG_USED
 1

	)

101 
	#SEG_SEALED
 2

	)

102 
	#SEG_MIGRATING
 3

	)

103 
	#SEG_PARTIAL
 4

	)

104 
	#SEG_RECOVERY
 5

	)

105 
	#SEG_HIT
 6

	)

106 
	#SEG_LOCK
 7

	)

108 
	sgroup_hódî
 {

109 
•ölock_t
 
	mlock
;

110 
u32
 
	mgroup_id
;

111 
u32
 
	mcuºít_£g_id
;

112 
©omic_t
 
	m‰ì_£g_cou¡
;

113 
©omic_t
 
	m£Æed_£g_cou¡
;

114 
©omic_t
 
	mvÆid_cou¡
;

116 
©omic_t
 
	mnum_u£d_ssd
;

117 
©omic_t
 
	mskewed_£gmít
;

119 
li°_hód
 
	mÆloc_li°
;

120 
li°_hód
 
	mgroup_hód
;

124 
	s£gmít_hódî
 {

125 
•ölock_t
 
	mlock
;

126 
li°_hód
 
	mÆloc_li°
;

127 
li°_hód
 
	mgroup_li°
;

128 
li°_hód
 
	mmigøã_li°
;

130 
group_hódî
 *
	mgroup
;

132 
u64
 
	m£g_id
;

133 
u64
 
	mgroup_id
;

134 
u64
 
	m£quí˚
;

135 
u32
 
	m£g_ty≥
;

136 
u32
 
	m£g_lﬂd
;

137 
	mÊags
;

139 
©omic_t
 
	mvÆid_cou¡
;

140 
©omic_t
 
	mvÆid_˛ón_cou¡
;

141 
©omic_t
 
	mvÆid_dúty_cou¡
;

142 
©omic_t
 
	mdummy_cou¡
;

143 
©omic_t
 
	mdúty_cou¡
;

144 
©omic_t
 
	mhŸ_cou¡
;

145 
©omic_t
 
	mhŸ_˛ón_cou¡
;

147 
©omic_t
 
	m∑π_°¨t
;

148 
©omic_t
 
	m∑π_Àngth
;

149 
©omic_t
 
	mÀngth
;

151 
©omic_t
 
	mbios_cou¡
;

153 
©omic_t
 
	mnum_ªad_öÊight
;

154 
©omic_t
 
	mnum_fûlög
;

155 
©omic_t
 
	mnum_wrôeback
;

156 
©omic_t
 
	mnum_bufc›y
;

157 
©omic_t
 
	mnum_migios
;

159 
©omic_t
 
	msumm¨y_°¨t
[
MAX_CACHE_DEVS
];

169 
	#lock£g
(
£g
, 
Êags
Ë
	`•ö_lock_úqßve
(&(£g)->
lock
, fœgs)

	)

170 
	#u∆ock£g
(
£g
, 
Êags
Ë
	`•ö_u∆ock_úqª°‹e
(&(£g)->
lock
, fœgs)

	)

177 
	s£gmít_hódî_devi˚
 {

179 
__À64
 
	m£quí˚
;

180 
__À64
 
	muuid
;

181 
__À32
 
	mmagic
;

182 
__À32
 
	mty≥
;

188 
__À32
 
	mœp
;

189 
u8
 
	m∑ddög
[
SEGMENT_HEADER_SIZE
 - (8 + 8 + 4 + 4 + 4)];

192 } 
	g__∑cked
;

194 
	sømbuf„r
 {

195 
li°_hód
 
	mli°
;

196 
ømbuf_∑ge
 **
	m∑ges
;

197 
	mømbuf_id
;

198 
	mÆloc_cou¡
;

199 
©omic_t
 
	mªf_cou¡
;

201 *
	m£g_buf
[
MAX_CACHE_DEVS
];

203 
bio
 **
	mbios
;

204 
©omic_t
 
	mbios_cou¡
[
MAX_CACHE_DEVS
];

205 
©omic_t
 
	mbios_°¨t
[
MAX_CACHE_DEVS
];

206 
©omic_t
 
	mbios_tŸÆ_cou¡
;

207 
©omic_t
 
	mbios_tŸÆ_°¨t
;

208 
•ölock_t
 
	mlock
;

212 
	sht_hód
 {

213 
hli°_hód
 
	mht_li°
;

216 
	sio
 {

218 
hli°_node
 
	mhash
;

219 
li°_hód
 
	mÃu
;

221 
	mjiffõs
;

222 
	m£quítül
;

223 
£˘‹_t
 
	mœ°
;

226 
	sªad_ˇchög_job_li°
{

227 
•ölock_t
 
	mrm_•ölock
;

228 
©omic_t
 
	mrm_c›y_cou¡
;

229 
li°_hód
 
	mrm_c›y_hód
;

232 
	sªad_ˇchög_job
{

233 
li°_hód
 
	mgn_li°
;

235 
bio
 *
	mgn_bio
;

236 
dm§c_su≥r
 *
	mgn_su≥r
;

237 
	mgn_bio_îr‹
;

239 
mëablock
 *
	mgn_mb
;

240 
£gmít_hódî
 *
	mgn_£g
;

241 
ømbuf„r
 *
	mgn_ømbuf
;

243 
£˘‹_t
 
	mgn_£˘‹
;

246 
	ssu≥r_°©
{

247 
u32
 
	mhô
;

248 
u32
 
	mcou¡
;

249 
u32
 
	mªad_hô
;

250 
u32
 
	mªad_cou¡
;

251 
u32
 
	mwrôe_hô
;

252 
u32
 
	mwrôe_cou¡
;

254 
©omic64_t
 
	mavîage_¨rivÆ_time
;

255 
©omic64_t
 
	mavîage_¨rivÆ_cou¡
;

257 
©omic_t
 
	m£q_by∑ss_cou¡
;

258 
©omic_t
 
	mcﬁd_by∑ss_cou¡
;

260 
©omic_t
 
	mde°age_cou¡
;

261 
©omic_t
 
	mgc_cou¡
;

262 
©omic_t
 
	mgc_em±y_cou¡
;

263 
©omic_t
 
	mtŸÆ_migøti⁄
;

264 
©omic64_t
 
	mvi˘im_utû
;

265 
©omic64_t
 
	mvi˘im_cou¡
;

267 
©omic64_t
 
	mgc_io_cou¡
;

269 
©omic64_t
 
	mde°age_io_cou¡
;

271 
©omic64_t
 
	mssd_wrôe_hô_cou¡
;

272 
©omic64_t
 
	mssd_wrôe_miss_cou¡
;

274 
©omic64_t
 
	mssd_ªad_hô_cou¡
;

275 
©omic64_t
 
	mssd_ªad_miss_cou¡
;

277 
©omic_t
 
	m£g_cou¡
[
NBUF
];

279 
©omic_t
 
	m∑πül_wrôe_cou¡
;;

280 
©omic_t
 
	mby∑ss_wrôe_cou¡
;;

288 
	ssumm¨y_io_job
{

289 
	m£g_Àngth
;

290 
	mˇche_ty≥
;

291 
£gmít_hódî
 *
	m£g
;

292 
ømbuf„r
 *
	mømbuf
;

293 
bio_li°
 
	mb¨rõr_ios
;

294 *
	msu≥r
;

295 
©omic_t
 
	mcou¡
;

296 
©omic_t
 
	mªÀa£
;

303 
	sÊush_övoke_job
 {

304 
li°_hód
 
	mli°
;

305 
£gmít_hódî
 *
	m£g
;

306 
ømbuf„r
 *
	mømbuf
;

307 
bio_li°
 
	mb¨rõr_ios
;

309 
	m£g_Àngth
;

310 
	mÊush_d©a
;

311 
	mbuûd_summ¨y
;

312 
	mˇche_ty≥
;

313 
	mf‹˚_£Æ
;

314 
u64
 
	mglobÆ_£g_£quí˚
;

315 
©omic_t
 
	mbios_°¨t
[
MAX_CACHE_DEVS
];

316 
©omic_t
 
	mbios_cou¡
[
MAX_CACHE_DEVS
];

320 
	swb_job
{

321 
dm§c_su≥r
 *
	msu≥r
;

322 
£gmít_hódî
 *
	m£g
;

323 
mëablock
 *
	mmb
;

324 
bio
 *
	mbio
;

325 
ømbuf„r
 *
	mømbuf
;

327 
©omic_t
 
	mømbuf_ªÀa£
;

328 
u32
 
	m°¨t_idx
;

329 
u32
 
	mcou¡
;

330 
	mÊush_comm™d
;

331 
	mîr‹
;

332 
li°_hód
 
	mli°
;

335 
	sªcovîy_job
{

336 
dm§c_su≥r
 *
	msu≥r
;

337 
£gmít_hódî
 *
	m£g
;

338 
ømbuf„r
 *
	mømbuf
;

339 
mëablock
 *
	mmb
;

340 
li°_hód
 
	mªcovîy_li°
;

341 
©omic_t
 
	mnum_ªmaöög_ios
;

342 
	mis_ªad
;

343 
	mîr‹
;

346 
	sdegøded_job
{

347 
dm§c_su≥r
 *
	msu≥r
;

348 
£gmít_hódî
 *
	m£g
;

349 
mëablock
 *
	mmb
;

350 
li°_hód
 
	mdegøded_li°
;

351 
bio
 *
	m‹g_bio
;

352 
©omic_t
 
	mnum_ªmaöög_ios
;

353 *
	mbuf
;

354 
	mîr‹
;

358 
	s∂ug_job
{

359 
li°_hód
 
	m∂ug_li°
;

360 
£gmít_hódî
 *
	m£g
;

361 
ømbuf„r
 *
	mømbuf
;

362 
bio
 *
	mbio
;

363 
u32
 
	midx
;

368 
	sømbuf_∑ge
{

369 
li°_hód
 
	mli°
;

371 
∑ge_li°
 *
	m∂
;

375 
	smu…i_Æloˇt‹
{

376 
•ölock_t
 
	mlock
[
MAX_CACHE_DEVS
];

377 
s32
 
	mcurs‹
[
MAX_CACHE_DEVS
];

378 
©omic_t
 
	mcou¡
[
MAX_CACHE_DEVS
];

379 
©omic_t
 
	mtŸÆ_cou¡
;

380 
©omic_t
 *
	mrow_cou¡
;

381 
©omic_t
 
	mcur_dev
;

382 
	m£g_em±y_chunk_m≠
[
NBUF
][
MAX_CACHE_DEVS
];

383 
	mgroup_em±y_chunk_m≠
[
NBUF
][
MAX_CACHE_DEVS
];

387 
	#MAX_ARRIVAL_TIME
 16384

	)

388 
	#DEFAULT_ARRIVAL_US
 100

	)

391 
	s≥ndög_m™agî
{

392 
•ölock_t
 
	mlock
;

393 
bio_li°
 
	mbios
;

394 
w‹kqueue_°ru˘
 *
	mwq
;

395 
w‹k_°ru˘
 
	mw‹k
;

396 
©omic64_t
 
	mio_cou¡
;

399 
time•ec
 
	m¨rivÆ_times
[
MAX_ARRIVAL_TIME
];

400 
©omic_t
 
	m¨rivÆ_°¨t
;

401 
©omic_t
 
	m¨rivÆ_cou¡
;

402 
©omic_t
 
	m¨rivÆ_cur
;

405 
•ölock_t
 
	mb¨rõr_lock
;

406 
bio_li°
 
	mb¨rõr_ios
;

407 
©omic_t
 
	mb¨rõr_cou¡
;

409 
dm§c_su≥r
 *
	msu≥r
;

412 
mempoﬁ_t
 *
	mwb_job_poﬁ
;

413 
	möôülized
;

419 
	#RECENT_IO_BITS
 7

	)

420 
	#RECENT_IO
 (1 << 
RECENT_IO_BITS
)

	)

421 
	s£q_io_dëe˘‹
{

422 
•ölock_t
 
	m£q_lock
;

423 
io
 
	mio
[
RECENT_IO
];

424 
hli°_hód
 
	mio_hash
[
RECENT_IO
 + 1];

425 
li°_hód
 
	mio_Ãu
;

430 
	s£gbuf_m™agî
{

431 
•ölock_t
 
	mlock
;

433 
	möôülized
;

435 
ømbuf„r
 *
	mcuºít_ømbuf
[
NBUF
];

436 
ømbuf„r
 *
	mømbuf_poﬁ
;

437 
u32
 
	mnum_ømbuf_poﬁ
;

439 **
	m∑ges
;

440 **
	mbios
;

442 
li°_hód
 
	ma˘ive_li°
;;

443 
li°_hód
 
	möa˘ive_li°
;

444 
©omic_t
 
	ma˘ive_tŸÆ_cou¡
;

445 
©omic_t
 
	ma˘ive_cou¡
[
NBUF
];

446 
©omic_t
 
	möa˘ive_cou¡
;

448 
li°_hód
 
	ma˘ive_∑ge_li°
;

449 
li°_hód
 
	möa˘ive_∑ge_li°
;

450 
©omic_t
 
	ma˘ive_∑ge_cou¡
;

451 
©omic_t
 
	möa˘ive_∑ge_cou¡
;

452 
©omic_t
 
	mtŸÆ_∑ge_cou¡
;

454 
©omic_t
 
	mgc_a˘ive_∑ge_cou¡
;

456 
waô_queue_hód_t
 
	mwaô_queue
;

460 
	s£gmít_Æloˇt‹
{

461 
•ölock_t
 
	mÆloc_lock
;

463 
li°_hód
 
	mgroup_Æloc_queue
;

464 
li°_hód
 
	mgroup_u£d_queue
;

465 
li°_hód
 
	mgroup_£Æed_queue
;

466 
li°_hód
 
	mgroup_migøã_queue
;

468 
©omic_t
 
	mgroup_Æloc_cou¡
;

469 
u32
 
	mgroup_u£d_cou¡
;

470 
u32
 
	mgroup_£Æed_cou¡
;

471 
©omic_t
 
	mgroup_migøã_cou¡
;

473 
li°_hód
 
	m£g_Æloc_queue
;

474 
li°_hód
 
	m£g_u£d_queue
;

475 
li°_hód
 
	m£g_£Æed_queue
;

476 
li°_hód
 
	m£g_migøã_queue
;

478 
©omic_t
 
	m£g_Æloc_cou¡
;

479 
u32
 
	m£g_u£d_cou¡
;

480 
u32
 
	m£g_£Æed_cou¡
;

481 
©omic_t
 
	m£g_migøã_cou¡
;

482 
waô_queue_hód_t
 
	mÆloc_waô_queue
;

486 
	sdegøded_m™agî
{

487 
mempoﬁ_t
 *
	mjob_poﬁ
;

488 
mempoﬁ_t
 *
	mbuf_poﬁ
;

490 
w‹kqueue_°ru˘
 *
	mwq
;

491 
w‹k_°ru˘
 
	mw‹k
;

492 
•ölock_t
 
	mlock
;

493 
li°_hód
 
	mqueue
;

494 
dm§c_su≥r
 *
	msu≥r
;

495 
	möôülized
;

499 
	sªcovîy_m™agî
{

500 
©omic_t
 
	mbrokí_block_cou¡
;

501 
èsk_°ru˘
 *
	md´m⁄
;

503 
mempoﬁ_t
 *
	mjob_poﬁ
;

505 
w‹kqueue_°ru˘
 *
	mwq
;

506 
w‹k_°ru˘
 
	mw‹k
;

508 
•ölock_t
 
	mlock
;

509 
li°_hód
 
	mqueue
;

511 
	mÁûuª_ssd
;

513 
	m°¨t_jiffõs
;

514 
	míd_jiffõs
;

516 
dm§c_su≥r
 *
	msu≥r
;

518 
	möôülized
;

522 
	sÊush_m™agî
{

523 
èsk_°ru˘
 *
	md´m⁄
;

525 
•ölock_t
 
	mlock
;

526 
li°_hód
 
	mqueue
;

527 
©omic_t
 
	mövoke_cou¡
;

528 
©omic64_t
 
	mglobÆ_£g_£quí˚
;

529 
©omic_t
 
	mio_cou¡
;

530 
mempoﬁ_t
 *
	mövoke_poﬁ
;

533 
	möôülized
;

537 
	smigøti⁄_m™agî
{

538 
èsk_°ru˘
 *
	md´m⁄
;

540 
©omic_t
 
	mmigøã_åiggîed
;

541 
©omic_t
 
	mbackground_gc_⁄
;

542 
	mÆlow_migøã
;

544 
•ölock_t
 
	mmig_queue_lock
;

545 
•ölock_t
 
	mgroup_queue_lock
;

546 
li°_hód
 
	mmig_queue
;

547 
li°_hód
 
	mc›y_queue
;

548 
li°_hód
 
	mgroup_queue
;

550 
£gmít_hódî
 *
	mgc_cur_£g
;

551 
	mgc_cur_off£t
;

552 
	mgc_Æloc_cou¡
;

554 
mempoﬁ_t
 *
	mc›y_job_poﬁ
;

555 
mempoﬁ_t
 *
	mgroup_job_poﬁ
;

556 
©omic_t
 
	mgroup_job_cou¡
;

557 
©omic_t
 
	mc›y_job_cou¡
;

558 
©omic_t
 
	mgroup_job_£q
;

561 
w‹kqueue_°ru˘
 *
	mmig_wq
;

562 
w‹k_°ru˘
 
	mmig_w‹k
;

563 
©omic_t
 
	mmig_öÊights
;

564 
©omic_t
 
	mmig_com∂ëes
;

566 
li°_hód
 
	mmigøã_queue
;

568 
©omic_t
 
	mmigøã_queue_cou¡
;

570 
dm§c_su≥r
 *
	msu≥r
;

572 
	möôülized
;

577 
	s∂uggög_m™agî
{

578 
timî_li°
 
	mtimî
;

579 
•ölock_t
 
	mlock
[
MAX_CACHE_DEVS
];

580 
li°_hód
 
	mqueue
[
MAX_CACHE_DEVS
];

581 
©omic_t
 
	mtŸÆ_Àngth
;

582 
©omic_t
 
	mqueue_Àngth
[
MAX_CACHE_DEVS
];

583 
	mœ°_jiffõs
[
MAX_CACHE_DEVS
];

584 
	mdódlöe_us
;

587 
dm§c_su≥r
 *
	msu≥r
;

589 
	möôülized
;

593 
	s£g_wrôe_m™agî
{

594 
w‹k_°ru˘
 
	mw‹k
;

595 
w‹kqueue_°ru˘
 *
	mwq
;

597 
•ölock_t
 
	m•ölock
;

598 
©omic_t
 
	mcou¡
;

599 
li°_hód
 
	mhód
;

600 
dm§c_su≥r
 *
	msu≥r
;

601 
	möôülized
;

605 
	sªad_miss_m™agî
{

606 
w‹k_°ru˘
 
	mw‹k
;

607 
w‹kqueue_°ru˘
 *
	mwq
;

608 
mempoﬁ_t
 *
	mjob_poﬁ
;

609 
ªad_ˇchög_job_li°
 
	mqueue
;

610 
dm§c_su≥r
 *
	msu≥r
;

611 
	möôülized
;

615 
	ssync_m™agî
{

616 
hπimî
 
	mhr_timî
;

618 
ktime_t
 
	m≥riod
;

619 
w‹k_°ru˘
 
	mw‹k
;

620 
•ölock_t
 
	mlock
;

621 
	mèrgë_jiffõs
;

622 
dm§c_su≥r
 *
	msu≥r
;

623 
	möôülized
;

626 
	#REQ_CATEGORY_NORMAL
 0

	)

627 
	#REQ_CATEGORY_GC
 1

	)

628 
	#REQ_CATEGORY_TOTAL
 2

	)

629 
	#REQ_CATEGORY_NUM
 3

	)

631 
	#REQ_TYPE_READ
 0

	)

632 
	#REQ_TYPE_WRITE
 1

	)

633 
	#REQ_TYPE_TOTAL
 2

	)

634 
	#REQ_TYPE_NUM
 3

	)

636 
	sio_°©_t
{

637 
©omic64_t
 
	mi›s
[
REQ_CATEGORY_NUM
][
REQ_TYPE_NUM
];

640 
	#MAX_WINDOW_NUM
 (
MSEC_PER_SEC
*5)

	)

643 
	sw‹klﬂd_¥edi˘‹
{

644 
hπimî
 
	mhr_timî_åack
;

645 
ktime_t
 
	måack_≥riod
;

647 
hπimî
 
	mhr_timî_mëî
;

648 
ktime_t
 
	mdi•œy_≥riod
;

650 
•ölock_t
 
	mlock
;

651 
©omic_t
 
	m°¨t_wödow
;

652 
©omic_t
 
	mcur_wödow
;

653 
u32
 
	mnum_wödow
;

654 
u32
 
	mwödow_≥r_£c
;

656 
io_°©_t
 
	mio°©
[
MAX_WINDOW_NUM
];

657 
dm§c_su≥r
 *
	msu≥r
;

658 
	möôülized
;

661 
	ssˇn_mëad©a_job
{

662 
li°_hód
 
	mli°
;

663 
dm§c_su≥r
 *
	msu≥r
;

664 
	mbio_îr‹
;

665 *
	md©a
;

666 
u32
 
	m£g_id
;

667 
u32
 
	mssd_id
;

669 
	mödex
;

673 
	ssˇn_mëad©a_m™agî
{

674 
•ölock_t
 
	mlock
;

676 
li°_hód
 
	mcom∂ëe_queue
;

677 
li°_hód
 
	möa˘ive_queue
;

678 
©omic_t
 
	ma˘ive_cou¡
;

679 
©omic_t
 
	möa˘ive_cou¡
;

680 
©omic_t
 
	mcom∂ëe_cou¡
;

681 
	mqdïth
;

685 
	#MAX_BITMAP_TABLE
 4

	)

687 
	shŸ_d©a_fûãr
{

688 
•ölock_t
 
	mlock
;

689 
	mio_cou¡
;;

690 
	mdeˇy_≥riod
;

691 
	mhŸ_thªshﬁd
;

692 
	mhash_num
;

693 
	mbôm≠_èbÀ_num
;

694 
	mnum_bôs_≥r_èbÀ
;

695 
	mnum_byãs_≥r_èbÀ
;

696 
	mcur_èbÀ
;

697 
	mœ°_èbÀ
;

698 *
	mbôm≠
[
MAX_BITMAP_TABLE
];

701 
	sdevi˚_öfo
{

702 
	mnum_ˇche_devs
;

703 
	mnum_•¨e_ˇche_devs
;

704 
	mnum_d©a_ˇche_devs
;

706 
	m‹igö_«me
[128];

707 
	mˇche_«me
[
MAX_CACHE_DEVS
][128];

708 
	m•¨e_«me
[
MAX_CACHE_DEVS
][128];

710 
dm_dev
 *
	m‹igö_dev
;

711 
dm_dev
 *
	mˇche_dev
[
MAX_CACHE_DEVS
];

712 
dm_dev
 *
	m•¨e_ˇche_dev
[
MAX_CACHE_DEVS
];

714 
su≥rblock_devi˚
 
	msb_devi˚
[
MAX_CACHE_DEVS
];

716 
u32
 
	m≥r_ˇche_bw
;

717 
£˘‹_t
 
	m‹igö_£˘‹s
;

718 
£˘‹_t
 
	m≥r_ssd_£˘‹s
;

722 
	sˇche_°©
{

723 
u64
 
	muuid
;

724 
©omic64_t
 
	mÆloc_£quí˚
;

726 
©omic_t
 
	mnum_‰ì_£gmíts
;

727 
©omic_t
 
	mnum_u£d_blocks
;

728 
u32
 
	mnum_blocks_≥r_chunk
;

729 
u32
 
	mnum_blocks_≥r_ssd
;

730 
u32
 
	mnum_£gmíts
;

731 
u32
 
	mnum_groups
;

732 
u32
 
	mnum_chunks_≥r_ssd
;

733 
u32
 
	mnum_chunks_≥r_group
;

735 
©omic64_t
 
	mnum_dúty_blocks
;

737 
©omic_t
 
	möÊight_ios
;

738 
©omic_t
 
	möÊight_bios
;

740 
©omic_t
 
	mtŸÆ_ios
;

741 
©omic_t
 
	mtŸÆ_bios
;

742 
©omic_t
 
	mtŸÆ_bios2
;

745 
	sdm§c_∑øm
{

747 
u32
 
	mblock_size
;

748 
u32
 
	mchunk_size
;

749 
u32
 
	mchunk_group_size
;

750 
u32
 
	mnum_summ¨y_≥r_chunk
;

751 
u32
 
	mnum_íåy_≥r_∑ge
;

752 
u32
 
	m∑rôy_Æloˇti⁄
;

753 
u32
 
	m°rùög_pﬁicy
;

754 
u32
 
	md©a_Æloˇti⁄
;

755 
u32
 
	mÆig√d_io_dummy
;

756 
u32
 
	mîasuª_code
;

758 
u32
 
	mÊush_comm™d
;

761 
u32
 
	mømbuf_poﬁ_amou¡
;

765 
	m£quítül_cutoff
;

766 
	m£quítül_íabÀ
;

768 
u32
 
	mvi˘im_pﬁicy
;

769 
u32
 
	mª˛aim_pﬁicy
;

770 
u32
 
	mu_max
;

771 
u32
 
	mgc_wôh_dútysync
;

772 
u32
 
	mmax_migøã_öÊights
;

773 
u32
 
	mmigøã_loww©î
;

774 
u32
 
	mmigøã_highw©î
;

775 
u32
 
	mhô_bôm≠_ty≥
;

776 
u32
 
	mbio_∂uggög
;

777 
u32
 
	mhŸ_idítifiˇti⁄
;

778 
u32
 
	míabÀ_ªad_ˇche
;

780 
u32
 
	msync_öãrvÆ
;

781 
u32
 
	mcheckî_öãrvÆ
;

784 
	sdm§c_su≥r
 {

786 
©omic_t
 
	mdegøded_mode
;

787 
©omic_t
 
	mªsize_mode
;

789 
dm_èrgë
 *
	mti
;

790 
dm_io_˛õ¡
 *
	mio_˛õ¡
;

792 
•ölock_t
 
	mio_lock
;

795 
£gmít_hódî
 *
	mcuºít_£g
[
NBUF
];

797 
œrge_¨øy
 *
	m£gmít_hódî_¨øy
;

800 
group_hódî
 *
	mcuºít_group
;

802 
group_hódî
 *
	mgroup_hódî_¨øy
;

805 
œrge_¨øy
 *
	mmëablock_¨øy
[
MAX_CACHE_DEVS
];

806 
	mmëa_öôülized
;

809 
œrge_¨øy
 *
	mhèbÀ
;

810 
size_t
 
	mhtsize
;

811 
ht_hód
 *
	mnuŒ_hód
;

812 
	mht_öôülized
;

815 
mu…i_Æloˇt‹
 
	mma
[
NBUF
];

817 
ˇche_m™agî
 *
	m˛ón_døm_ˇche_m™agî
;

820 
ˇche_m™agî
 *
	mÃu_m™agî
;

823 
hŸ_d©a_fûãr
 
	mhŸ_fûãr
;

826 
devi˚_öfo
 
	mdev_öfo
;

829 
r5c⁄f
 
	møid_c⁄f
;

832 
dm§c_∑øm
 
	m∑øm
;

834 
ˇche_°©
 
	mˇche_°©
;

836 
su≥r_°©
 
	mw°©
;

839 
≥ndög_m™agî
 
	m≥ndög_mgr
;

842 
£q_io_dëe˘‹
 
	m£q_dëe˘‹
;

845 
degøded_m™agî
 
	mdegøded_mgr
;

848 
ªcovîy_m™agî
 
	mªcovîy_mgr
;

851 
£gmít_Æloˇt‹
 
	m£g_Æloˇt‹
;

854 
£gbuf_m™agî
 
	m£gbuf_mgr
;

857 
Êush_m™agî
 
	mÊush_mgr
;

860 
migøti⁄_m™agî
 
	mmigøã_mgr
;

863 
∂uggög_m™agî
 
	m∂uggî
;

866 
ªad_miss_m™agî
 
	mªad_miss_mgr
;

868 
£g_wrôe_m™agî
 
	m£g_wrôe_mgr
[
MAX_CACHE_DEVS
];

871 
sync_m™agî
 
	msync_mgr
;

874 
èsk_°ru˘
 *
	mcheckî_d´m⁄
;

877 
sˇn_mëad©a_m™agî
 *
	msˇn_m™agî
;

880 
w‹klﬂd_¥edi˘‹
 
	mwp
;

886 
	#iﬁock
(
x
, 
f
Ë
	`•ö_lock_úqßve
(&x->
io_lock
, f)

	)

887 
	#iou∆ock
(
x
, 
f
Ë
	`•ö_u∆ock_úqª°‹e
(&x->
io_lock
, f)

	)

888 
	#LOCK
(
su≥r
, 
x
Ë
	`iﬁock
(su≥r, x)

	)

889 
	#UNLOCK
(
su≥r
, 
x
Ë
	`iou∆ock
(su≥r, x)

	)

891 
	sc›y_job_group
{

892 
dm§c_su≥r
 *
	msu≥r
;

893 
li°_hód
 
	mgroup_li°
;

894 
li°_hód
 
	m˝_hód
;

895 
£gmít_hódî
 *
	md°_£g
;

896 
ømbuf„r
 *
	md°_ømbuf
;

897 
©omic_t
 
	m˝_job_cou¡
;

898 
	mˇche_ty≥
;

900 
	mrw
;

901 
	m£q
;

902 
	mîr‹
;

903 
	mgc
;

906 
	sc›y_job
{

907 
li°_hód
 
	m˝_li°
;

908 
dm_io_ªque°
 
	mio_ªq
;

909 
dm_io_ªgi⁄
 
	md°_ªgi⁄
[2];

910 
	md°_cou¡
;

911 
dm_io_ªgi⁄
 
	m§c_ªgi⁄
;

912 
mëablock
 *
	m§c_mb
;

913 
mëablock
 *
	md°_mb
;

914 
ømbuf_∑ge
 *
	m∑ge
;

920 
	sbio_˘x
 {

921 *
	m±r
;

922 
	m£q_io
;

923 
	mhŸ_io
;

924 
	möÊight
;

925 
u32
 
	m¸c32
;

932 
Êush_∑πül_mëa
(
dm§c_su≥r
 *, 
ˇche_ty≥
);

933 
öc_num_dúty_ˇches
(
dm§c_su≥r
 *);

934 
˛ónup_mb_if_dúty
(
dm§c_su≥r
 *,

935 
£gmít_hódî
 *,

936 
mëablock
 *);

937 
u8
 
©omic_ªad_mb_dútöess
(
£gmít_hódî
 *, 
mëablock
 *);

938 
u8
 
©omic_ªad_mb_vÆid√ss
(
£gmít_hódî
 *
£g
, 
mëablock
 *
mb
);

939 
övÆid©e_¥evious_ˇche
(
dm§c_su≥r
 *
su≥r
,

940 
£gmít_hódî
 *
£g
,

941 
mëablock
 *
ﬁd_mb
);

943 
mëablock
 *
Æloc_mb_d©a
(
dm§c_su≥r
 *
su≥r
,

944 
£˘‹_t
 
key
,

945 
ˇche_ty≥
,

946 
boﬁ
 
˛ón
,

947 
u32
 *
tŸÆ_cou¡
);

950 
w‹kqueue_°ru˘
 *
ß„_io_wq
;

951 
dm_io_˛õ¡
 *
su≥r_io_˛õ¡
;

952 
dm_kc›yd_˛õ¡
 *
su≥r_˝_˛õ¡
[];

955 
£˘‹_t
 
dm§c_devsize_£˘‹s
(
dm_dev
 *);

957 
ªad_ˇchög_job
 *
Æloc_gho°_node
(
dm§c_su≥r
 *
su≥r
);

958 
upd©e_d©a_ö_mb
(
dm§c_su≥r
 *
su≥r
,

959 
u32
 
upd©e_mb_idx
,

960 
£gmít_hódî
 *
£g
,

961 
ømbuf„r
 *
ømbuf
,

962 
ˇche_ty≥
,

963 *
d©a
,

964 
u32
 
¸c32
);

966 
upd©e_buf_ö_mb
(
dm§c_su≥r
 *
su≥r
,

967 
u32
 
upd©e_mb_idx
,

968 
£gmít_hódî
 *
£g
,

969 *
buf
,

970 
ˇche_ty≥
,

971 
boﬁ
 
migøã
);

973 
Êush_≥ndög_bios
(
dm§c_su≥r
 *
su≥r
);

974 
ª‰esh_£gmít
(
dm§c_su≥r
 *
su≥r
,

975 
£gmít_hódî
 *
£g
,

976 
ømbuf„r
 *
ømbuf
,

977 
ˇche_ty≥
, 
boﬁ
 
migøã
, boﬁ 
f‹˚
, 
cou¡
,

978 
bio_li°
 *);

979 
upd©e_∑rôy
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
);

980 
boﬁ
 
√ed_ª‰esh_£gmít
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
cou¡
);

981 
gíî©e_∑rôy_d©a
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
ømbuf_∑ge
 **, 
fuŒ_£g
, 
ˇche_ty≥
);

982 
ª£t_∑rôy
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
ˇche_ty≥
, 
˛ór_wrôãn
);

983 
wrôe_async_bio
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
u32
 
idx
, 
bio
 *bio,

984 
ømbuf„r
 *
ømbuf
, 
fuŒ
);

986 
£˘‹_t
 
ˇlc_ˇche_Æignmít
(
dm§c_su≥r
 *
su≥r
, se˘‹_à
bio_£˘‹
);

987 
£gmít_hódî
 *
gë_£g_by_mb
(
dm§c_su≥r
 *
su≥r
, 
mëablock
 *
mb
);

988 
≥ndög_bio_add
(
dm§c_su≥r
 *
su≥r
, 
bio
 *bio);

989 
u64
 
Æloc_√w_£gmít
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
boﬁ
 
u£_migøã
);

990 
waô_ømbuf_evít
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
);

991 
waô_Æloc_evít
(
dm§c_su≥r
 *
su≥r
, 
mö
);

992 
make_Êush_övoke_job
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

993 
ømbuf„r
 *
ømbuf
, 
£g_Àngth
, 
©omic_t
 *
bios_°¨t
,átomic_à*
bios_cou¡
,

994 
ˇche_ty≥
, 
f‹˚_£Æ
, 
summ¨y
, 
Êush_d©a
, 
u64
 
globÆ_£g_£quí˚
);

995 
åy_gë_‰ì_£gmít
(
dm§c_su≥r
 *
su≥r
, 
boﬁ
 
found
, 
rw
);

996 
buûd_mëad©a
(
dm§c_su≥r
 *
su≥r
,

997 
£gmít_hódî
 *
£g
,

998 
£g_Àngth
,

999 
ømbuf„r
 *
ømbuf
,

1000 
©omic_t
 *
bios_°¨t
,

1001 
©omic_t
 *
bios_cou¡
,

1002 
f‹˚_£Æ
,

1003 
buûd_summ¨y
,

1004 
Êush_d©a
);

1006 
curs‹_öô
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
);

1007 
curs‹_∑rôy_°¨t
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
);

1008 
curs‹_d©a_°¨t_ssd
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
);

1009 
curs‹_summ¨y_off£t
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
, 
ˇche_ty≥
);

1010 
gë_devno
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
);

1011 
block_devi˚
 *
gë_bdev
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
);

1012 
dm_dev
 *
gë_dmdev
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
);

1013 
£˘‹_t
 
gë_£˘‹
(
dm§c_su≥r
 *
su≥r
, 
u32
 
£g_id
, u32 
idx
);

1014 
do_degøded_w‹kî
(
w‹k_°ru˘
 *
w‹k
);

1015 
boﬁ
 
√ed_chunk_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
);

1016 
boﬁ
 
chunk_summ¨y_ønge
(
dm§c_su≥r
 *
su≥r
, 
u32
 
idx
);

1017 
Æloc_mb_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

1018 
ˇche_ty≥
, 
u32
 
idx
, u32 *
tŸÆ_cou¡
);

1019 
gë_∑rôy_ssd
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
);

1020 
gë_∑rôyq_ssd
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
);

1021 
run_x‹
(**
∑ges
, *
de°
, 
§c_˙t
, 
ssize_t
 
Àn
);

1022 
_wrôe_async_bio
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
u32
 
idx
, 
bio
 *bio,

1023 
ømbuf„r
 *
ømbuf
, 
u32
 
ømbuf_idx
);

1024 
_Æloc_mb_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
ˇche_ty≥
, 
u32
 
idx
, 
fuŒ
, 
dummy
);

1025 
¥ï¨e_chunk_summ¨y
(

1026 
dm§c_su≥r
 *
su≥r
,

1027 
£gmít_hódî
 *
£g
,

1028 
ømbuf_∑ge
 **
∑ges
,

1029 
ssd_id
,

1030 
ˇche_ty≥
);

1031 
curs‹_öc
(
dm§c_su≥r
 *
su≥r
,
£g_id
, 
ˇche_ty≥
);

1032 
u32
 
d©a_to_summ¨y_idx
(
dm§c_su≥r
 *
su≥r
, u32 
idx
);

1033 
gë_°¨t_ssd
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
);

1034 
öôülize_mb_summ¨y
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

1035 
ˇche_ty≥
, 
u32
 
idx
, 
fuŒ
);

1036 
öôülize_mb
(
dm§c_su≥r
 *
su≥r
, 
mëablock
 *
√w_mb
, 
ˇche_ty≥
, 
boﬁ
 
˛ón
);

1037 
dm§c_io
(
dm_io_ªque°
 *
io_ªq
, 
num_ªgi⁄s
,

1038 
dm_io_ªgi⁄
 *
whîe
, *
sync_îr‹_bôs
);

1039 
øid_c⁄f_öô
(
dm§c_su≥r
 *
su≥r
, 
r5c⁄f
 *
c⁄f
);

1040 
≥ndög_w‹kî_scheduÀ
(
dm§c_su≥r
 *
su≥r
);

1041 
£g_Æloˇt‹_öô
(
dm§c_su≥r
 *
su≥r
);

1042 
degøded_mgr_öô
(
dm§c_su≥r
 *
su≥r
);

1043 
degøded_mgr_deöô
(
dm§c_su≥r
 *
su≥r
);

1044 
ªcovîy_mgr_öô
(
dm§c_su≥r
 *
su≥r
);

1045 
ªcovîy_mgr_deöô
(
dm§c_su≥r
 *
su≥r
);

1046 
Êush_mgr_öô
(
dm§c_su≥r
 *
su≥r
);

1047 
Êush_mgr_deöô
(
dm§c_su≥r
 *
su≥r
);

1048 
migøã_mgr_öô
(
dm§c_su≥r
 *
su≥r
);

1049 
migøã_mgr_deöô
(
dm§c_su≥r
 *
su≥r
);

1050 
∂uggî_öô
(
dm§c_su≥r
 *
su≥r
);

1051 
∂uggî_deöô
(
dm§c_su≥r
 *
su≥r
);

1052 
ªad_miss_mgr_öô
(
dm§c_su≥r
 *
su≥r
);

1053 
ªad_miss_mgr_deöô
(
dm§c_su≥r
 *
su≥r
);

1054 
sync_mgr_öô
(
dm§c_su≥r
 *
su≥r
);

1055 
sync_mgr_deöô
(
dm§c_su≥r
 *
su≥r
);

1056 
¥öt_∑øm
(
dm§c_su≥r
 *
su≥r
);

1057 
u64
 
Æloc_√xt_£gmít
(
dm§c_su≥r
 *
su≥r
, 
boﬁ
 
migøã
);

1058 
öô_√w_£gmít
(
dm§c_su≥r
 *
su≥r
, 
u64
 
√xt_id
, 
ˇche_ty≥
);

1059 
£g_Àngth_öc
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
mëablock
 *
mb
, 
boﬁ
 
öÊight
);

1060 
dm§c_då
(
dm_èrgë
 *
ti
);

1061 
do_background_gc
(
dm§c_su≥r
 *
su≥r
);

1062 
wp_upd©e
(
dm§c_su≥r
 *
su≥r
, 
is_wrôe
, 
ˇãg‹y
);

1063 
u32
 
wp_gë_i›s
(
dm§c_su≥r
 *
su≥r
, u32 *
bw_mb
, 
ˇãg‹y
, 
ty≥
);

1064 
ˇlc_√ed_num_ssds
(
dm§c_su≥r
 *
su≥r
);

1065 
_buûd_summ¨y_job
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
,

1066 
ømbuf„r
 *
ømbuf
, 
fuŒ
);

1067 
¥o˚ss_wrôe_ªque°
(
dm§c_su≥r
 *
su≥r
,

1068 
bio
 *bio,

1069 
∑ge
 *page,

1070 
£˘‹_t
 
key
,

1071 
is_dúty
,

1072 
f
,

1073 
ˇche_ty≥
,

1074 
u32
 
¸c32
);

1075 
boﬁ
 
should_√ed_ª‰esh_£g
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
);

1076 
ˇn_gë_‰ì_£gmít
(
dm§c_su≥r
 *
su≥r
, 
ˇche_ty≥
, 
gc
);

1077 
wb_job
 *
wrôeback_make_job
(
dm§c_su≥r
 *
su≥r
,

1078 
£gmít_hódî
 *
£g
,

1079 
u32
 
idx
,

1080 
bio
 *bio,

1081 
ømbuf„r
 *
ømbuf
,

1082 
ømbuf_ªÀa£
);

1083 
wrôeback_issue_job
(
dm§c_su≥r
 *
su≥r
, 
wb_job
 *
job
);

1084 
u32
 
gë_summ¨y_off£t
(
dm§c_su≥r
 *
su≥r
, u32 
ssd_id
);

1085 
bio_∂uggög
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
ømbuf„r
 *
ømbuf
,

1086 
bio
 *bio, 
u32
 
upd©e_mb_idx
);

1087 
ölöe
 
gë_∑rôy_ssd
(
dm§c_su≥r
 *
su≥r
, 
u64
 
£g_id
);

1089 
åy_waô_‰ì_£g
(
dm§c_su≥r
 *
su≥r
, 
is_wrôe
);

1090 
wb_job
 *
wrôeback_make_job_exã¡
(
dm§c_su≥r
 *
su≥r
,

1091 
£gmít_hódî
 *
£g
,

1092 
ømbuf„r
 *
ømbuf
,

1093 
u32
 
°¨t_idx
,

1094 
u32
 
cou¡
);

1095 
wrôeback_issue_job_exã¡
(
dm§c_su≥r
 *
su≥r
, 
wb_job
 *
job
, 
group_£Æed
);

1096 
√ed_˛ón_£g_wrôe
(
dm§c_su≥r
 *
su≥r
);

1097 
˛ón_£g_wrôe
(
dm§c_su≥r
 *
su≥r
, 
√ed_cou¡
, 
ˇche_ty≥
);

1098 
u32
 
Æloc_√xt_mb
(
dm§c_su≥r
 *
su≥r
, 
£gmít_hódî
 *
£g
, 
£˘‹_t
 
key
, 
ˇche_ty≥
, u32 *
tŸÆ_cou¡
);

1099 
hŸ_fûãr_upd©e
(
dm§c_su≥r
 *
su≥r
, 
£˘‹
);

1100 
hŸ_fûãr_check
(
dm§c_su≥r
 *
su≥r
, 
£˘‹
);

1101 
upd©e_sync_dódlöe
(
dm§c_su≥r
 *
su≥r
);

1111 
	#wbdebug
(
f
, 
¨gs
...) \

1112 
	`DMINFO
("debug@%s(ËL.%d" 
f
, 
__func__
, 
__LINE__
, ## 
¨gs
)

	)

1114 
	#WBERR
(
f
, 
¨gs
...) \

1115 
	`DMERR
("îr@%s(Ë" 
f
, 
__func__
, ## 
¨gs
)

	)

1116 
	#WBWARN
(
f
, 
¨gs
...) \

1117 
	`DMWARN
("w¨n@%s(Ë" 
f
, 
__func__
, ## 
¨gs
)

	)

1118 
	#WBINFO
(
f
, 
¨gs
...) \

1119 
	`DMINFO
("öfo@%s(Ë" 
f
, 
__func__
, ## 
¨gs
)

	)

	@/usr/include/linux/random.h

7 #i‚de‡
_LINUX_RANDOM_H


8 
	#_LINUX_RANDOM_H


	)

10 
	~<löux/ty≥s.h
>

11 
	~<löux/io˘l.h
>

12 
	~<löux/úqƒ.h
>

17 
	#RNDGETENTCNT
 
	`_IOR
–'R', 0x00, )

	)

20 
	#RNDADDTOENTCNT
 
	`_IOW
–'R', 0x01, )

	)

23 
	#RNDGETPOOL
 
	`_IOR
–'R', 0x02, [2] )

	)

29 
	#RNDADDENTROPY
 
	`_IOW
–'R', 0x03, [2] )

	)

32 
	#RNDZAPENTCNT
 
	`_IO
–'R', 0x04 )

	)

35 
	#RNDCLEARPOOL
 
	`_IO
–'R', 0x06 )

	)

37 
	sønd_poﬁ_öfo
 {

38 
	míå›y_cou¡
;

39 
	mbuf_size
;

40 
__u32
 
	mbuf
[0];

	@/usr/include/linux/sched.h

1 #i‚de‡
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

7 
	#CSIGNAL
 0x000000f‡

	)

8 
	#CLONE_VM
 0x00000100

	)

9 
	#CLONE_FS
 0x00000200

	)

10 
	#CLONE_FILES
 0x00000400

	)

11 
	#CLONE_SIGHAND
 0x00000800

	)

12 
	#CLONE_PTRACE
 0x00002000

	)

13 
	#CLONE_VFORK
 0x00004000

	)

14 
	#CLONE_PARENT
 0x00008000

	)

15 
	#CLONE_THREAD
 0x00010000

	)

16 
	#CLONE_NEWNS
 0x00020000

	)

17 
	#CLONE_SYSVSEM
 0x00040000

	)

18 
	#CLONE_SETTLS
 0x00080000

	)

19 
	#CLONE_PARENT_SETTID
 0x00100000

	)

20 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

21 
	#CLONE_DETACHED
 0x00400000

	)

22 
	#CLONE_UNTRACED
 0x00800000

	)

23 
	#CLONE_CHILD_SETTID
 0x01000000

	)

26 
	#CLONE_NEWUTS
 0x04000000

	)

27 
	#CLONE_NEWIPC
 0x08000000

	)

28 
	#CLONE_NEWUSER
 0x10000000

	)

29 
	#CLONE_NEWPID
 0x20000000

	)

30 
	#CLONE_NEWNET
 0x40000000

	)

31 
	#CLONE_IO
 0x80000000

	)

36 
	#SCHED_NORMAL
 0

	)

37 
	#SCHED_FIFO
 1

	)

38 
	#SCHED_RR
 2

	)

39 
	#SCHED_BATCH
 3

	)

41 
	#SCHED_IDLE
 5

	)

43 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

	@/usr/include/linux/string.h

1 #i‚de‡
_LINUX_STRING_H_


2 
	#_LINUX_STRING_H_


	)

6 
	~<°rög.h
>

	@/usr/include/linux/types.h

1 #i‚de‡
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty≥s.h
>

6 #i‚de‡
__ASSEMBLY__


8 
	~<löux/posix_ty≥s.h
>

16 #ifde‡
__CHECKER__


17 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

19 
	#__bôwi£__


	)

21 #ifde‡
__CHECK_ENDIAN__


22 
	#__bôwi£
 
__bôwi£__


	)

24 
	#__bôwi£


	)

27 
__u16
 
	t__bôwi£
 
	t__À16
;

28 
__u16
 
	t__bôwi£
 
	t__be16
;

29 
__u32
 
	t__bôwi£
 
	t__À32
;

30 
__u32
 
	t__bôwi£
 
	t__be32
;

31 
__u64
 
	t__bôwi£
 
	t__À64
;

32 
__u64
 
	t__bôwi£
 
	t__be64
;

34 
__u16
 
	t__bôwi£
 
	t__sum16
;

35 
__u32
 
	t__bôwi£
 
	t__wsum
;

46 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

48 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 199168

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
Ë((◊Ë<< 16Ë+ ((bË<< 8Ë+ (c))

	)

3 
	#RHEL_MAJOR
 7

	)

4 
	#RHEL_MINOR
 2

	)

5 
	#RHEL_RELEASE_VERSION
(
a
,
b
Ë((◊Ë<< 8Ë+ (b))

	)

6 
	#RHEL_RELEASE_CODE
 1794

	)

7 
	#RHEL_RELEASE
 "327.36.3"

	)

	@/usr/include/asm/types.h

1 #i‚de‡
_ASM_X86_TYPES_H


2 
	#_ASM_X86_TYPES_H


	)

4 
	~<asm-gíîic/ty≥s.h
>

	@/usr/include/linux/ioctl.h

1 #i‚de‡
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/io˘l.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/posix_types.h

1 #i‚de‡
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<löux/°ddef.h
>

21 #unde‡
__FD_SETSIZE


22 
	#__FD_SETSIZE
 1024

	)

25 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

26 } 
	t__kî√l_fd_£t
;

29 (*
	t__kî√l_sigh™dÀr_t
)();

32 
	t__kî√l_key_t
;

33 
	t__kî√l_mqd_t
;

35 
	~<asm/posix_ty≥s.h
>

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<„©uªs.h
>

27 
	g__BEGIN_DECLS


30 
	#__√ed_size_t


	)

31 
	#__√ed_NULL


	)

32 
	~<°ddef.h
>

35 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

36 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

40 
__BEGIN_NAMESPACE_STD


42 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

43 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

46 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

47 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

48 
__END_NAMESPACE_STD


53 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_BSD
 || deföed 
__USE_XOPEN


54 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

60 
__BEGIN_NAMESPACE_STD


62 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

65 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

66 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

69 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


72 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

74 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

75 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

77 #ifde‡
__OPTIMIZE__


78 
__exã∫_Æways_ölöe
 *

79 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


81  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

84 
__exã∫_Æways_ölöe
 const *

85 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


87  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

90 
	}
}

92 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

93 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

95 
__END_NAMESPACE_STD


97 #ifde‡
__USE_GNU


100 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


101 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

103 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

104 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

106 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

107 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

111 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


112 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

114 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

117 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

123 
__BEGIN_NAMESPACE_STD


125 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

126 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

128 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

129 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

130 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

133 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

134 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

136 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

137 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

140 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

141 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

143 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

144 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

147 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

148 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

150 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

151 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

152 
__THROW
 
	`__n⁄nuŒ
 ((2));

153 
__END_NAMESPACE_STD


155 #ifde‡
__USE_XOPEN2K8


159 
	~<xloˇÀ.h
>

162 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
__loˇÀ_t
 
__l
)

163 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

165 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

166 
__loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

169 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_BSD
 || deföed 
__USE_XOPEN_EXTENDED
 \

170 || 
deföed
 
__USE_XOPEN2K8


172 *
	$°rdup
 (c⁄° *
__s
)

173 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

179 #i‡
deföed
 
__USE_XOPEN2K8


180 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

181 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

184 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


186 
	#°rdu∑
(
s
) \

187 (
__exãnsi⁄__
 \

189 c⁄° *
__ﬁd
 = (
s
); \

190 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

191 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

192 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

193 
	}
}))

	)

196 
	#°∫du∑
(
s
, 
n
) \

197 (
__exãnsi⁄__
 \

199 c⁄° *
__ﬁd
 = (
s
); \

200 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

201 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

202 
__√w
[
__Àn
] = '\0'; \

203 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

204 }))

	)

207 
	g__BEGIN_NAMESPACE_STD


209 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


212 *
°rchr
 (*
__s
, 
__c
)

213 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

214 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

215 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

217 #ifde‡
__OPTIMIZE__


218 
__exã∫_Æways_ölöe
 *

219 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


221  
__buûtö_°rchr
 (
__s
, 
__c
);

224 
__exã∫_Æways_ölöe
 const *

225 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


227  
__buûtö_°rchr
 (
__s
, 
__c
);

232 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

233 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

236 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


239 *
	`°ºchr
 (*
__s
, 
__c
)

240 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

241 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

242 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

244 #ifde‡
__OPTIMIZE__


245 
__exã∫_Æways_ölöe
 *

246 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


248  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

251 
__exã∫_Æways_ölöe
 const *

252 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


254  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

257 
	}
}

259 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

260 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

262 
__END_NAMESPACE_STD


264 #ifde‡
__USE_GNU


267 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


268 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

269 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

270 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

271 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

273 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

274 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

278 
__BEGIN_NAMESPACE_STD


281 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

282 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

285 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

286 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

288 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


291 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

292 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

293 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

294 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

296 #ifde‡
__OPTIMIZE__


297 
__exã∫_Æways_ölöe
 *

298 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


300  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

303 
__exã∫_Æways_ölöe
 const *

304 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


306  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

309 
	}
}

311 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

312 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

315 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


318 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

319 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

320 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

321 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

323 #ifde‡
__OPTIMIZE__


324 
__exã∫_Æways_ölöe
 *

325 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


327  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

330 
__exã∫_Æways_ölöe
 const *

331 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


333  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

336 
	}
}

338 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

339 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

344 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

345 
__THROW
 
	`__n⁄nuŒ
 ((2));

346 
__END_NAMESPACE_STD


350 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

351 c⁄° *
__ª°ri˘
 
__dñim
,

352 **
__ª°ri˘
 
__ßve_±r
)

353 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

354 #i‡
deföed
 
__USE_POSIX
 || deföed 
__USE_MISC


355 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

356 **
__ª°ri˘
 
__ßve_±r
)

357 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

360 #ifde‡
__USE_GNU


362 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


363 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

364 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

365 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

366 c⁄° *
__√edÀ
)

367 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

369 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

370 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

374 #ifde‡
__USE_GNU


378 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

379 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

380 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

384 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

385 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

386 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

387 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

388 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

389 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

393 
__BEGIN_NAMESPACE_STD


395 
size_t
 
	$°æí
 (c⁄° *
__s
)

396 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

397 
__END_NAMESPACE_STD


399 #ifdef 
__USE_XOPEN2K8


402 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

403 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

407 
__BEGIN_NAMESPACE_STD


409 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

410 
__END_NAMESPACE_STD


411 #i‡
deföed
 
__USE_XOPEN2K
 || deföed 
__USE_MISC


419 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


422 #ifde‡
__REDIRECT_NTH


423 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

424 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

425 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

427 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

428 
__THROW
 
	`__n⁄nuŒ
 ((2));

429 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

434 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

435 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

439 #ifde‡
__USE_XOPEN2K8


441 *
	$°ªº‹_l
 (
__î∫um
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

447 
	$__bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

449 #ifde‡
__USE_BSD


451 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

452 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

455 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

458 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

459 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

462 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


465 *
	`ödex
 (*
__s
, 
__c
)

466 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

467 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

468 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

470 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


471 
__exã∫_Æways_ölöe
 *

472 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


474  
	`__buûtö_ödex
 (
__s
, 
__c
);

477 
__exã∫_Æways_ölöe
 const *

478 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


480  
	`__buûtö_ödex
 (
__s
, 
__c
);

483 
	}
}

485 *
	$ödex
 (c⁄° *
__s
, 
__c
)

486 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

490 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


493 *
	`rödex
 (*
__s
, 
__c
)

494 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

495 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

496 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

498 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


499 
__exã∫_Æways_ölöe
 *

500 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


502  
	`__buûtö_rödex
 (
__s
, 
__c
);

505 
__exã∫_Æways_ölöe
 const *

506 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


508  
	`__buûtö_rödex
 (
__s
, 
__c
);

511 
	}
}

513 *
	$rödex
 (c⁄° *
__s
, 
__c
)

514 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

519 
	$ffs
 (
__i
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

523 #ifdef 
__USE_GNU


524 
	$ff¶
 (
__l
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

525 #ifde‡
__GNUC__


526 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

527 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

532 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

533 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

536 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

537 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

540 #ifdef 
__USE_GNU


543 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

544 
__loˇÀ_t
 
__loc
)

545 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

547 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

548 
size_t
 
__n
, 
__loˇÀ_t
 
__loc
)

549 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

552 #ifdef 
__USE_BSD


555 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

556 c⁄° *
__ª°ri˘
 
__dñim
)

557 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

560 #ifdef 
__USE_XOPEN2K8


562 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

565 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

566 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

567 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

568 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

572 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

573 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

574 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

575 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

576 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

577 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

580 #ifdef 
__USE_GNU


582 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

583 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

586 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

589 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

591 #i‚de‡
ba£«me


596 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


597 "C++" *
	$ba£«me
 (*
__fûíame
)

598 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

599 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

600 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

602 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

608 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

609 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__OPTIMIZE_SIZE__
 \

610 && !
deföed
 
__NO_INLINE__
 && !deföed 
__˝lu•lus


630 
	~<bôs/°rög.h
>

633 
	~<bôs/°rög2.h
>

636 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


638 
	~<bôs/°rög3.h
>

642 
__END_DECLS


	@/usr/include/asm-generic/types.h

1 #i‚de‡
_ASM_GENERIC_TYPES_H


2 
	#_ASM_GENERIC_TYPES_H


	)

7 
	~<asm-gíîic/öt-Œ64.h
>

	@/usr/include/asm/ioctl.h

1 
	~<asm-gíîic/io˘l.h
>

	@/usr/include/asm/posix_types.h

1 #ifde‡
__i386__


2 
	~<asm/posix_ty≥s_32.h
>

3 #ñi‡
deföed
(
__ILP32__
)

4 
	~<asm/posix_ty≥s_x32.h
>

6 
	~<asm/posix_ty≥s_64.h
>

	@/usr/include/bits/string.h

19 #i‚de‡
_STRING_H


24 
	#_STRING_ARCH_u«lig√d
 1

	)

28 #i‡!
deföed
 
__x86_64__
 && (deföed 
__i486__
 || deföed 
__≥¡ium__
 \

29 || 
deföed
 
	g__≥¡ium¥o__
 || deföed 
	g__≥¡ium4__
 \

30 || 
deföed
 
	g__noc⁄a__
 || deföed 
	g__©om__
 \

31 || 
deföed
 
	g__c‹e2__
 || deföed 
	g__c‹ei7__
 \

32 || 
deföed
 
	g__k6__
 || deföed 
	g__geode__
 \

33 || 
deföed
 
	g__k8__
 || deföed 
	g__©hl⁄__
 \

34 || 
deföed
 
	g__amdÁm10__
)

38 #i‡!
deföed
 
__NO_STRING_INLINES
 && deföed 
__USE_STRING_INLINES
 \

39 && 
deföed
 
	g__GNUC__
 && __GNUC__ >2 && !
__BOUNDED_POINTERS__


41 #i‚de‡
__STRING_INLINE


42 #i‚de‡
__exã∫_ölöe


43 
	#__STRING_INLINE
 
ölöe


	)

45 
	#__STRING_INLINE
 
__exã∫_ölöe


	)

50 
	#__STRING_SMALL_GET16
(
§c
, 
idx
) \

51 ((((c⁄° *Ë(
§c
))[
idx
 + 1] << 8) \

52 | ((c⁄° *Ë(
§c
))[
idx
])

	)

53 
	#__STRING_SMALL_GET32
(
§c
, 
idx
) \

54 (((((c⁄° *Ë(
§c
))[
idx
 + 3] << 8 \

55 | ((c⁄° *Ë(
§c
))[
idx
 + 2]) << 8 \

56 | ((c⁄° *Ë(
§c
))[
idx
 + 1]) << 8 \

57 | ((c⁄° *Ë(
§c
))[
idx
])

	)

61 
	#_HAVE_STRING_ARCH_mem˝y
 1

	)

62 
	#mem˝y
(
de°
, 
§c
, 
n
) \

63 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
n
) \

64 ? 
	`__mem˝y_c
 ((
de°
), (
§c
), (
n
)) \

65 : 
	`__mem˝y_g
 ((
de°
), (
§c
), (
n
))))

	)

66 
	#__mem˝y_c
(
de°
, 
§c
, 
n
) \

67 ((
n
) == 0 \

68 ? (
de°
) \

69 : (((
n
) % 4 == 0) \

70 ? 
	`__mem˝y_by4
 (
de°
, 
§c
, 
n
) \

71 : (((
n
) % 2 == 0) \

72 ? 
	`__mem˝y_by2
 (
de°
, 
§c
, 
n
) \

73 : 
	`__mem˝y_g
 (
de°
, 
§c
, 
n
))))

	)

75 
__STRING_INLINE
 *
__mem˝y_by4
 (*
__de°
, c⁄° *
__§c
,

76 
size_t
 
__n
);

78 
__STRING_INLINE
 *

79 
	$__mem˝y_by4
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

81 
__d0
, 
__d1
;

82 *
__tmp
 = 
__de°
;

83 
__asm__
 
__vﬁ©ûe__


91 : "=&r" (
__d0
), "=&r" (
__tmp
), "=&r" (
__§c
), "=&r" (
__d1
)

92 : "1" (
__tmp
), "2" (
__§c
), "3" (
__n
 / 4)

94  
__de°
;

95 
	}
}

97 
__STRING_INLINE
 *
__mem˝y_by2
 (*
__de°
, c⁄° *
__§c
,

98 
size_t
 
__n
);

100 
__STRING_INLINE
 *

101 
	$__mem˝y_by2
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

103 
__d0
, 
__d1
;

104 *
__tmp
 = 
__de°
;

105 
__asm__
 
__vﬁ©ûe__


118 : "=&q" (
__d0
), "=&r" (
__tmp
), "=&r" (
__§c
), "=&r" (
__d1
)

119 : "1" (
__tmp
), "2" (
__§c
), "3" (
__n
 / 2)

121  
__de°
;

122 
	}
}

124 
__STRING_INLINE
 *
__mem˝y_g
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
);

126 
__STRING_INLINE
 *

127 
	$__mem˝y_g
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

129 
__d0
, 
__d1
, 
__d2
;

130 *
__tmp
 = 
__de°
;

131 
__asm__
 
__vﬁ©ûe__


142 : "=&c" (
__d0
), "=&D" (
__d1
), "=&S" (
__d2
),

143 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__de°
)

144 : "0" (
__n
), "1" (
__tmp
), "2" (
__§c
),

145 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__§c
)

147  
__de°
;

148 
	}
}

150 
	#_HAVE_STRING_ARCH_memmove
 1

	)

151 #i‚de‡
_FORCE_INLINES


154 
	#memmove
(
de°
, 
§c
, 
n
Ë
	`__memmove_g
 (de°, src,Ç)

	)

156 
__STRING_INLINE
 *
	$__memmove_g
 (*, c⁄° *, 
size_t
)

157 
	`__asm__
 ("memmove");

159 
__STRING_INLINE
 *

160 
	$__memmove_g
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

162 
__d0
, 
__d1
, 
__d2
;

163 *
__tmp
 = 
__de°
;

164 i‡(
__de°
 < 
__§c
)

165 
__asm__
 
__vﬁ©ûe__


168 : "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
),

169 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__de°
)

170 : "0" (
__n
), "1" (
__§c
), "2" (
__tmp
),

171 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__§c
));

173 
__asm__
 
__vﬁ©ûe__


177 : "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
),

178 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__de°
)

179 : "0" (
__n
), "1" (__¿- 1 + (c⁄° *Ë
__§c
),

180 "2" (
__n
 - 1 + (*Ë
__tmp
),

181 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__§c
));

182  
__de°
;

183 
	}
}

187 
	#_HAVE_STRING_ARCH_memcmp
 1

	)

188 #i‚de‡
_FORCE_INLINES


189 #i‚de‡
__PIC__


191 
__STRING_INLINE
 

192 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

194 
__d0
, 
__d1
, 
__d2
;

195 
__ªs
;

196 
__asm__
 
__vﬁ©ûe__


204 : "=&a" (
__ªs
), "=&S" (
__d0
), "=&D" (
__d1
), "=&c" (
__d2
)

205 : "0" (0), "1" (
__s1
), "2" (
__s2
), "3" (
__n
),

206 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s1
),

207 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s2
)

209  
__ªs
;

210 
	}
}

215 
	#_HAVE_STRING_ARCH_mem£t
 1

	)

216 
	#_USE_STRING_ARCH_mem£t
 1

	)

217 
	#mem£t
(
s
, 
c
, 
n
) \

218 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
n
) && (n) <= 16 \

219 ? ((
n
) == 1 \

220 ? 
	`__mem£t_c1
 ((
s
), (
c
)) \

221 : 
	`__mem£t_gc
 ((
s
), (
c
), (
n
))) \

222 : (
	`__buûtö_c⁄°™t_p
 (
c
) \

223 ? (
	`__buûtö_c⁄°™t_p
 (
n
) \

224 ? 
	`__mem£t_c˙
 ((
s
), (
c
), (
n
)) \

225 : 
	`mem£t
 ((
s
), (
c
), (
n
))) \

226 : (
	`__buûtö_c⁄°™t_p
 (
n
) \

227 ? 
	`__mem£t_g˙
 ((
s
), (
c
), (
n
)) \

228 : 
	`mem£t
 ((
s
), (
c
), (
n
))))))

	)

230 
	#__mem£t_c1
(
s
, 
c
Ë({ *
__s
 = (s); \

231 *((*Ë
__s
Ë(Ë(
c
); \

232 
__s
; })

	)

234 
	#__mem£t_gc
(
s
, 
c
, 
n
) \

235 ({ *
__s
 = (
s
); \

237 
__ui
; \

238 
__usi
; \

239 
__uc
; \

240 } *
__u
 = 
__s
; \

241 
__c
 = ((Ë((Ë(
c
))) * 0x01010101; \

247 i‡((
n
) == 3 || (n) >= 5) \

248 
__asm__
 
	`__vﬁ©ûe__
 ("" : "Ù" (
__c
) : "0" (__c)); \

251 
n
) \

254 
__u
->
__ui
 = 
__c
; \

255 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

257 
__u
->
__ui
 = 
__c
; \

258 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

260 
__u
->
__ui
 = 
__c
; \

261 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

263 
__u
->
__usi
 = (Ë
__c
; \

264 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2); \

265 
__u
->
__uc
 = (Ë
__c
; \

269 
__u
->
__ui
 = 
__c
; \

270 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

272 
__u
->
__ui
 = 
__c
; \

273 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

275 
__u
->
__ui
 = 
__c
; \

276 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

278 
__u
->
__usi
 = (Ë
__c
; \

282 
__u
->
__ui
 = 
__c
; \

283 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

285 
__u
->
__ui
 = 
__c
; \

286 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

288 
__u
->
__ui
 = 
__c
; \

289 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

291 
__u
->
__uc
 = (Ë
__c
; \

295 
__u
->
__ui
 = 
__c
; \

296 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

298 
__u
->
__ui
 = 
__c
; \

299 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

301 
__u
->
__ui
 = 
__c
; \

302 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

304 
__u
->
__ui
 = 
__c
; \

309 
__s
; })

	)

311 
	#__mem£t_c˙
(
s
, 
c
, 
n
) \

312 (((
n
) % 4 == 0) \

313 ? 
	`__mem£t_c˙_by4
 (
s
, ((Ë((Ë(
c
))) * 0x01010101,\

314 
n
) \

315 : (((
n
) % 2 == 0) \

316 ? 
	`__mem£t_c˙_by2
 (
s
, \

317 ((Ë((Ë(
c
))) * 0x01010101,\

318 
n
) \

319 : 
	`mem£t
 (
s
, 
c
, 
n
)))

	)

321 
__STRING_INLINE
 *
__mem£t_c˙_by4
 (*
__s
, 
__c
,

322 
size_t
 
__n
);

324 
__STRING_INLINE
 *

325 
	$__mem£t_c˙_by4
 (*
__s
, 
__c
, 
size_t
 
__n
)

327 *
__tmp
 = 
__s
;

328 
__d0
;

329 #ifde‡
__i686__


330 
__asm__
 
__vﬁ©ûe__


333 : "=&a" (
__c
), "=&D" (
__tmp
), "=&c" (
__d0
),

334 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

335 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

338 
__asm__
 
__vﬁ©ûe__


344 : "=&r" (
__c
), "=&r" (
__tmp
), "=&r" (
__d0
),

345 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

346 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

349  
__s
;

350 
	}
}

352 
__STRING_INLINE
 *
__mem£t_c˙_by2
 (*
__s
, 
__c
,

353 
size_t
 
__n
);

355 
__STRING_INLINE
 *

356 
	$__mem£t_c˙_by2
 (*
__s
, 
__c
, 
size_t
 
__n
)

358 
__d0
, 
__d1
;

359 *
__tmp
 = 
__s
;

360 #ifde‡
__i686__


361 
__asm__
 
__vﬁ©ûe__


365 : "=&a" (
__d0
), "=&D" (
__tmp
), "=&c" (
__d1
),

366 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

367 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

370 
__asm__
 
__vﬁ©ûe__


376 : "=&q" (
__d0
), "=&r" (
__tmp
), "=&r" (
__d1
),

377 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

378 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

381  
__s
;

382 
	}
}

384 
	#__mem£t_g˙
(
s
, 
c
, 
n
) \

385 (((
n
) % 4 == 0) \

386 ? 
	`__mem£t_g˙_by4
 (
s
, 
c
, 
n
) \

387 : (((
n
) % 2 == 0) \

388 ? 
	`__mem£t_g˙_by2
 (
s
, 
c
, 
n
) \

389 : 
	`mem£t
 (
s
, 
c
, 
n
)))

	)

391 
__STRING_INLINE
 *
__mem£t_g˙_by4
 (*
__s
, 
__c
, 
size_t
 
__n
);

393 
__STRING_INLINE
 *

394 
	$__mem£t_g˙_by4
 (*
__s
, 
__c
, 
size_t
 
__n
)

396 *
__tmp
 = 
__s
;

397 
__d0
;

398 
__asm__
 
__vﬁ©ûe__


408 : "=&q" (
__c
), "=&r" (
__tmp
), "=&r" (
__d0
),

409 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

410 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

412  
__s
;

413 
	}
}

415 
__STRING_INLINE
 *
__mem£t_g˙_by2
 (*
__s
, 
__c
, 
size_t
 
__n
);

417 
__STRING_INLINE
 *

418 
	$__mem£t_g˙_by2
 (*
__s
, 
__c
, 
size_t
 
__n
)

420 
__d0
, 
__d1
;

421 *
__tmp
 = 
__s
;

422 
__asm__
 
__vﬁ©ûe__


433 : "=&q" (
__d0
), "=&r" (
__tmp
), "=&r" (
__d1
),

434 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

435 : "0" ((Ë
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

437  
__s
;

438 
	}
}

442 
	#_HAVE_STRING_ARCH_memchr
 1

	)

443 #i‚de‡
_FORCE_INLINES


444 
__STRING_INLINE
 *

445 
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

447 
__d0
;

448 #ifde‡
__i686__


449 
__d1
;

451 *
__ªs
;

452 i‡(
__n
 == 0)

453  
NULL
;

454 #ifde‡
__i686__


455 
__asm__
 
__vﬁ©ûe__


459 : "=D" (
__ªs
), "=&c" (
__d0
), "=&r" (
__d1
)

460 : "a" (
__c
), "0" (
__s
), "1" (
__n
), "2" (1),

461 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

464 
__asm__
 
__vﬁ©ûe__


470 : "=D" (
__ªs
), "=&c" (
__d0
)

471 : "a" (
__c
), "0" (
__s
), "1" (
__n
),

472 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

475  
__ªs
 - 1;

476 
	}
}

479 
	#_HAVE_STRING_ARCH_memrchr
 1

	)

480 #i‚de‡
_FORCE_INLINES


481 
__STRING_INLINE
 *
__memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
);

483 
__STRING_INLINE
 *

484 
	$__memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

486 
__d0
;

487 #ifde‡
__i686__


488 
__d1
;

490 *
__ªs
;

491 i‡(
__n
 == 0)

492  
NULL
;

493 #ifde‡
__i686__


494 
__asm__
 
__vﬁ©ûe__


500 : "=D" (
__ªs
), "=&c" (
__d0
), "=&r" (
__d1
)

501 : "a" (
__c
), "0" (
__s
 + 
__n
 - 1), "1" (__n), "2" (-1),

502 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

505 
__asm__
 
__vﬁ©ûe__


512 : "=D" (
__ªs
), "=&c" (
__d0
)

513 : "a" (
__c
), "0" (
__s
 + 
__n
 - 1), "1" (__n),

514 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s
)

517  
__ªs
;

518 
	}
}

519 #ifde‡
__USE_GNU


520 
	#memrchr
(
s
, 
c
, 
n
Ë
	`__memrchr
 ((s), (c), (n))

	)

525 
	#_HAVE_STRING_ARCH_øwmemchr
 1

	)

526 
__STRING_INLINE
 *
__øwmemchr
 (c⁄° *
__s
, 
__c
);

528 #i‚de‡
_FORCE_INLINES


529 
__STRING_INLINE
 *

530 
	$__øwmemchr
 (c⁄° *
__s
, 
__c
)

532 
__d0
;

533 *
__ªs
;

534 
__asm__
 
__vﬁ©ûe__


537 : "=D" (
__ªs
), "=&c" (
__d0
)

538 : "a" (
__c
), "0" (
__s
), "1" (0xffffffff),

539 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

541  
__ªs
 - 1;

542 
	}
}

543 #ifde‡
__USE_GNU


544 
__STRING_INLINE
 *

545 
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

547  
	`__øwmemchr
 (
__s
, 
__c
);

548 
	}
}

554 
	#_HAVE_STRING_ARCH_°æí
 1

	)

555 
	#°æí
(
°r
) \

556 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
°r
) \

557 ? 
	`__buûtö_°æí
 (
°r
) \

558 : 
	`__°æí_g
 (
°r
)))

	)

559 
__STRING_INLINE
 
size_t
 
__°æí_g
 (c⁄° *
__°r
);

561 
__STRING_INLINE
 
size_t


562 
	$__°æí_g
 (c⁄° *
__°r
)

564 
__dummy
;

565 c⁄° *
__tmp
 = 
__°r
;

566 
__asm__
 
__vﬁ©ûe__


572 : "Ù" (
__tmp
), "=&q" (
__dummy
)

573 : "0" (
__°r
),

574 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__°r
)

576  
__tmp
 - 
__°r
 - 1;

577 
	}
}

581 
	#_HAVE_STRING_ARCH_°r˝y
 1

	)

582 
	#°r˝y
(
de°
, 
§c
) \

583 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
) \

584 ? ( ((
§c
)[0]Ë=1 && 
	`°æí
 (src) + 1 <= 8 \

585 ? 
	`__°r˝y_a_smÆl
 ((
de°
), (
§c
), 
	`°æí
 (src) + 1) \

586 : (*Ë
	`mem˝y
 ((*Ë(
de°
), \

587 (c⁄° *Ë(
§c
), \

588 
	`°æí
 (
§c
) + 1)) \

589 : 
	`__°r˝y_g
 ((
de°
), (
§c
))))

	)

591 
	#__°r˝y_a_smÆl
(
de°
, 
§c
, 
§˛í
) \

592 (
	`__exãnsi⁄__
 ({ *
__de°
 = (
de°
); \

594 
__ui
; \

595 
__usi
; \

596 
__uc
; \

597 
__c
; \

598 } *
__u
 = (*Ë
__de°
; \

599 
§˛í
) \

602 
__u
->
__uc
 = '\0'; \

605 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 0); \

608 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 0); \

609 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2); \

610 
__u
->
__uc
 = '\0'; \

613 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

616 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

617 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

618 
__u
->
__uc
 = '\0'; \

621 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

622 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

623 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 4); \

626 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

627 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

628 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 4); \

629 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2); \

630 
__u
->
__uc
 = '\0'; \

633 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

634 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

635 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 4); \

638 (*Ë
__de°
; }))

	)

640 
__STRING_INLINE
 *
__°r˝y_g
 (*
__de°
, c⁄° *
__§c
);

642 
__STRING_INLINE
 *

643 
	$__°r˝y_g
 (*
__de°
, c⁄° *
__§c
)

645 *
__tmp
 = 
__de°
;

646 
__dummy
;

647 
__asm__
 
__vﬁ©ûe__


656 : "=&r" (
__§c
), "=&r" (
__tmp
), "=&q" (
__dummy
),

657 "=m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__de°
)

658 : "0" (
__§c
), "1" (
__tmp
),

659 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__§c
)

661  
__de°
;

662 
	}
}

665 #ifde‡
__USE_GNU


666 
	#_HAVE_STRING_ARCH_°p˝y
 1

	)

668 
	#__°p˝y
(
de°
, 
§c
) \

669 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
) \

670 ? (
	`°æí
 (
§c
) + 1 <= 8 \

671 ? 
	`__°p˝y_a_smÆl
 ((
de°
), (
§c
), 
	`°æí
 (src) + 1) \

672 : 
	`__°p˝y_c
 ((
de°
), (
§c
), 
	`°æí
 (src) + 1)) \

673 : 
	`__°p˝y_g
 ((
de°
), (
§c
))))

	)

674 
	#__°p˝y_c
(
de°
, 
§c
, 
§˛í
) \

675 ((
§˛í
) % 4 == 0 \

676 ? 
	`__memp˝y_by4
 (
de°
, 
§c
, 
§˛í
) - 1 \

677 : ((
§˛í
) % 2 == 0 \

678 ? 
	`__memp˝y_by2
 (
de°
, 
§c
, 
§˛í
) - 1 \

679 : 
	`__memp˝y_byn
 (
de°
, 
§c
, 
§˛í
Ë- 1))

	)

682 
	#°p˝y
(
de°
, 
§c
Ë
	`__°p˝y
 ((de°), (§c))

	)

684 
	#__°p˝y_a_smÆl
(
de°
, 
§c
, 
§˛í
) \

685 (
	`__exãnsi⁄__
 ({ union { \

686 
__ui
; \

687 
__usi
; \

688 
__uc
; \

689 
__c
; \

690 } *
__u
 = (*Ë(
de°
); \

691 
§˛í
) \

694 
__u
->
__uc
 = '\0'; \

697 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 0); \

698 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 1); \

701 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 0); \

702 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2); \

703 
__u
->
__uc
 = '\0'; \

706 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

707 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 3); \

710 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

711 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

712 
__u
->
__uc
 = '\0'; \

715 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

716 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

717 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 4); \

718 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 1); \

721 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

722 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

723 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
§c
, 4); \

724 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2); \

725 
__u
->
__uc
 = '\0'; \

728 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 0); \

729 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

730 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
§c
, 4); \

731 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 3); \

734 (*Ë
__u
; }))

	)

736 
__STRING_INLINE
 *
__memp˝y_by4
 (*
__de°
, c⁄° *
__§c
,

737 
size_t
 
__§˛í
);

739 
__STRING_INLINE
 *

740 
	$__memp˝y_by4
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__§˛í
)

742 *
__tmp
 = 
__de°
;

743 
__d0
, 
__d1
;

744 
__asm__
 
__vﬁ©ûe__


752 : "=&r" (
__d0
), "Ù" (
__tmp
), "=&r" (
__§c
), "=&r" (
__d1
)

753 : "1" (
__tmp
), "2" (
__§c
), "3" (
__§˛í
 / 4)

755  
__tmp
;

756 
	}
}

758 
__STRING_INLINE
 *
__memp˝y_by2
 (*
__de°
, c⁄° *
__§c
,

759 
size_t
 
__§˛í
);

761 
__STRING_INLINE
 *

762 
	$__memp˝y_by2
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__§˛í
)

764 *
__tmp
 = 
__de°
;

765 
__d0
, 
__d1
;

766 
__asm__
 
__vﬁ©ûe__


779 : "=&q" (
__d0
), "Ù" (
__tmp
), "=&r" (
__§c
), "=&r" (
__d1
),

780 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__de°
)

781 : "1" (
__tmp
), "2" (
__§c
), "3" (
__§˛í
 / 2),

782 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

784  
__tmp
 + 2;

785 
	}
}

787 
__STRING_INLINE
 *
__memp˝y_byn
 (*
__de°
, c⁄° *
__§c
,

788 
size_t
 
__§˛í
);

790 
__STRING_INLINE
 *

791 
	$__memp˝y_byn
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__§˛í
)

793 
__d0
, 
__d1
;

794 *
__tmp
 = 
__de°
;

795 
__asm__
 
__vﬁ©ûe__


806 : "=D" (
__tmp
), "=&c" (
__d0
), "=&S" (
__d1
),

807 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__de°
)

808 : "0" (
__tmp
), "1" (
__§˛í
), "2" (
__§c
),

809 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

811  
__tmp
;

812 
	}
}

814 
__STRING_INLINE
 *
__°p˝y_g
 (*
__de°
, c⁄° *
__§c
);

816 
__STRING_INLINE
 *

817 
	$__°p˝y_g
 (*
__de°
, c⁄° *
__§c
)

819 *
__tmp
 = 
__de°
;

820 
__dummy
;

821 
__asm__
 
__vﬁ©ûe__


830 : "=&r" (
__§c
), "Ù" (
__tmp
), "=&q" (
__dummy
),

831 "=m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__de°
)

832 : "0" (
__§c
), "1" (
__tmp
),

833 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__§c
)

835  
__tmp
 - 1;

836 
	}
}

841 
	#_HAVE_STRING_ARCH_°∫˝y
 1

	)

842 
	#°∫˝y
(
de°
, 
§c
, 
n
) \

843 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
) \

844 ? ((
	`°æí
 (
§c
Ë+ 1 >((
size_t
Ë(
n
)) \

845 ? (*Ë
	`mem˝y
 ((*Ë(
de°
), \

846 (c⁄° *Ë(
§c
), 
n
) \

847 : 
	`__°∫˝y_cg
 ((
de°
), (
§c
), 
	`°æí
 (§cË+ 1, 
n
))) \

848 : 
	`__°∫˝y_gg
 ((
de°
), (
§c
), 
n
)))

	)

849 
	#__°∫˝y_cg
(
de°
, 
§c
, 
§˛í
, 
n
) \

850 (((
§˛í
) % 4 == 0) \

851 ? 
	`__°∫˝y_by4
 (
de°
, 
§c
, 
§˛í
, 
n
) \

852 : (((
§˛í
) % 2 == 0) \

853 ? 
	`__°∫˝y_by2
 (
de°
, 
§c
, 
§˛í
, 
n
) \

854 : 
	`__°∫˝y_byn
 (
de°
, 
§c
, 
§˛í
, 
n
)))

	)

856 
__STRING_INLINE
 *
__°∫˝y_by4
 (*
__de°
, c⁄° 
__§c
[],

857 
size_t
 
__§˛í
, size_à
__n
);

859 
__STRING_INLINE
 *

860 
	$__°∫˝y_by4
 (*
__de°
, c⁄° 
__§c
[], 
size_t
 
__§˛í
, size_à
__n
)

862 *
__tmp
 = 
__de°
;

863 
__dummy1
, 
__dummy2
;

864 
__asm__
 
__vﬁ©ûe__


872 : "=&r" (
__dummy1
), "Ù" (
__tmp
), "=&r" (
__§c
), "=&r" (
__dummy2
),

873 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__de°
)

874 : "1" (
__tmp
), "2" (
__§c
), "3" (
__§˛í
 / 4),

875 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

877 (Ë
	`mem£t
 (
__tmp
, '\0', 
__n
 - 
__§˛í
);

878  
__de°
;

879 
	}
}

881 
__STRING_INLINE
 *
__°∫˝y_by2
 (*
__de°
, c⁄° 
__§c
[],

882 
size_t
 
__§˛í
, size_à
__n
);

884 
__STRING_INLINE
 *

885 
	$__°∫˝y_by2
 (*
__de°
, c⁄° 
__§c
[], 
size_t
 
__§˛í
, size_à
__n
)

887 *
__tmp
 = 
__de°
;

888 
__dummy1
, 
__dummy2
;

889 
__asm__
 
__vﬁ©ûe__


902 : "=&q" (
__dummy1
), "Ù" (
__tmp
), "=&r" (
__§c
), "=&r" (
__dummy2
),

903 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__de°
)

904 : "1" (
__tmp
), "2" (
__§c
), "3" (
__§˛í
 / 2),

905 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

907 (Ë
	`mem£t
 (
__tmp
 + 2, '\0', 
__n
 - 
__§˛í
);

908  
__de°
;

909 
	}
}

911 
__STRING_INLINE
 *
__°∫˝y_byn
 (*
__de°
, c⁄° 
__§c
[],

912 
size_t
 
__§˛í
, size_à
__n
);

914 
__STRING_INLINE
 *

915 
	$__°∫˝y_byn
 (*
__de°
, c⁄° 
__§c
[], 
size_t
 
__§˛í
, size_à
__n
)

917 
__d0
, 
__d1
;

918 *
__tmp
 = 
__de°
;

919 
__asm__
 
__vﬁ©ûe__


930 : "=D" (
__tmp
), "=&c" (
__d0
), "=&S" (
__d1
),

931 "=m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__de°
)

932 : "1" (
__§˛í
), "0" (
__tmp
),"2" (
__§c
),

933 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

935 (Ë
	`mem£t
 (
__tmp
, '\0', 
__n
 - 
__§˛í
);

936  
__de°
;

937 
	}
}

939 
__STRING_INLINE
 *
__°∫˝y_gg
 (*
__de°
, c⁄° *
__§c
,

940 
size_t
 
__n
);

942 
__STRING_INLINE
 *

943 
	$__°∫˝y_gg
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

945 *
__tmp
 = 
__de°
;

946 
__dummy
;

947 i‡(
__n
 > 0)

948 
__asm__
 
__vﬁ©ûe__


964 : "=&r" (
__§c
), "=&r" (
__tmp
), "=&q" (
__dummy
), "=&r" (
__n
)

965 : "0" (
__§c
), "1" (
__tmp
), "3" (
__n
)

968  
__de°
;

969 
	}
}

973 
	#_HAVE_STRING_ARCH_°rˇt
 1

	)

974 
	#°rˇt
(
de°
, 
§c
) \

975 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
) \

976 ? 
	`__°rˇt_c
 ((
de°
), (
§c
), 
	`°æí
 (src) + 1) \

977 : 
	`__°rˇt_g
 ((
de°
), (
§c
))))

	)

979 
__STRING_INLINE
 *
__°rˇt_c
 (*
__de°
, c⁄° 
__§c
[],

980 
size_t
 
__§˛í
);

982 
__STRING_INLINE
 *

983 
	$__°rˇt_c
 (*
__de°
, c⁄° 
__§c
[], 
size_t
 
__§˛í
)

985 #ifde‡
__i686__


986 
__d0
;

987 *
__tmp
;

988 
__asm__
 
__vﬁ©ûe__


990 : "=D" (
__tmp
), "=&c" (
__d0
),

991 "=m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__de°
)

992 : "0" (
__de°
), "1" (0xffffffff), "a" (0),

993 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

995 --
__tmp
;

997 *
__tmp
 = 
__de°
 - 1;

998 
__asm__
 
__vﬁ©ûe__


1003 : "Ù" (
__tmp
),

1004 "=m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__de°
)

1005 : "0" (
__tmp
),

1006 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__§˛í
]; } *)
__§c
)

1009 (Ë
	`mem˝y
 (
__tmp
, 
__§c
, 
__§˛í
);

1010  
__de°
;

1011 
	}
}

1013 
__STRING_INLINE
 *
__°rˇt_g
 (*
__de°
, c⁄° *
__§c
);

1015 
__STRING_INLINE
 *

1016 
	$__°rˇt_g
 (*
__de°
, c⁄° *
__§c
)

1018 *
__tmp
 = 
__de°
 - 1;

1019 
__dummy
;

1020 
__asm__
 
__vﬁ©ûe__


1032 : "=&q" (
__dummy
), "=&r" (
__tmp
), "=&r" (
__§c
),

1033 "=m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__de°
)

1034 : "1" (
__tmp
), "2" (
__§c
),

1035 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__§c
)

1037  
__de°
;

1038 
	}
}

1042 
	#_HAVE_STRING_ARCH_°∫ˇt
 1

	)

1043 
	#°∫ˇt
(
de°
, 
§c
, 
n
) \

1044 (
	`__exãnsi⁄__
 ({ *
__de°
 = (
de°
); \

1045 
	`__buûtö_c⁄°™t_p
 (
§c
Ë&& __buûtö_c⁄°™t_∞(
n
) \

1046 ? (
	`°æí
 (
§c
Ë< ((
size_t
Ë(
n
)) \

1047 ? 
	`°rˇt
 (
__de°
, (
§c
)) \

1048 : (*(*)
	`__memp˝y
 (
	`°rchr
 (
__de°
, '\0'), \

1049 (c⁄° *Ë(
§c
), \

1050 (
n
)Ë0, 
__de°
)) \

1051 : 
	`__°∫ˇt_g
 (
__de°
, (
§c
), (
n
)); }))

	)

1053 
__STRING_INLINE
 *
__°∫ˇt_g
 (*
__de°
, c⁄° 
__§c
[],

1054 
size_t
 
__n
);

1056 
__STRING_INLINE
 *

1057 
	$__°∫ˇt_g
 (*
__de°
, c⁄° 
__§c
[], 
size_t
 
__n
)

1059 *
__tmp
 = 
__de°
;

1060 
__dummy
;

1061 #ifde‡
__i686__


1062 
__asm__
 
__vﬁ©ûe__


1076 : "=&a" (
__dummy
), "=&D" (
__tmp
), "=&S" (
__§c
), "=&c" (
__n
)

1077 : "g" (
__n
), "0" (0), "1" (
__tmp
), "2" (
__§c
), "3" (0xffffffff)

1080 --
__tmp
;

1081 
__asm__
 
__vﬁ©ûe__


1098 : "=&q" (
__dummy
), "=&r" (
__tmp
), "=&r" (
__§c
), "=&r" (
__n
)

1099 : "1" (
__tmp
), "2" (
__§c
), "3" (
__n
)

1102  
__de°
;

1103 
	}
}

1107 
	#_HAVE_STRING_ARCH_°rcmp
 1

	)

1108 
	#°rcmp
(
s1
, 
s2
) \

1109 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& __buûtö_c⁄°™t_∞(
s2
) \

1110 && ( ((
s1
)[0]Ë!1 || 
	`°æí
 (s1) >= 4) \

1111 && ( ((
s2
)[0]Ë!1 || 
	`°æí
 (s2) >= 4) \

1112 ? 
	`memcmp
 ((c⁄° *Ë(
s1
), (c⁄° *Ë(
s2
), \

1113 (
	`°æí
 (
s1
Ë< såÀ¿(
s2
) \

1114 ? 
	`°æí
 (
s1
Ë: såÀ¿(
s2
)) + 1) \

1115 : (
	`__buûtö_c⁄°™t_p
 (
s1
) &&  ((s1)[0]) == 1 \

1116 &&  ((
s2
)[0]Ë=1 && 
	`°æí
 (
s1
) < 4 \

1117 ? (
	`__buûtö_c⁄°™t_p
 (
s2
) &&  ((s2)[0]) == 1 \

1118 ? 
	`__°rcmp_cc
 ((c⁄° *Ë(
s1
), \

1119 (c⁄° *Ë(
s2
), \

1120 
	`°æí
 (
s1
)) \

1121 : 
	`__°rcmp_cg
 ((c⁄° *Ë(
s1
), \

1122 (c⁄° *Ë(
s2
), \

1123 
	`°æí
 (
s1
))) \

1124 : (
	`__buûtö_c⁄°™t_p
 (
s2
Ë&&  ((
s1
)[0]) == 1 \

1125 &&  ((
s2
)[0]Ë=1 && 
	`°æí
 (s2) < 4 \

1126 ? (
	`__buûtö_c⁄°™t_p
 (
s1
) \

1127 ? 
	`__°rcmp_cc
 ((c⁄° *Ë(
s1
), \

1128 (c⁄° *Ë(
s2
), \

1129 
	`°æí
 (
s2
)) \

1130 : 
	`__°rcmp_gc
 ((c⁄° *Ë(
s1
), \

1131 (c⁄° *Ë(
s2
), \

1132 
	`°æí
 (
s2
))) \

1133 : 
	`__°rcmp_gg
 ((
s1
), (
s2
))))))

	)

1135 
	#__°rcmp_cc
(
s1
, 
s2
, 
l
) \

1136 (
	`__exãnsi⁄__
 ({ 
__ªsu…
 = (
s1
)[0] - (
s2
)[0]; \

1137 i‡(
l
 > 0 && 
__ªsu…
 == 0) \

1139 
__ªsu…
 = (
s1
)[1] - (
s2
)[1]; \

1140 i‡(
l
 > 1 && 
__ªsu…
 == 0) \

1142 
__ªsu…
 = (
s1
)[2] - (
s2
)[2]; \

1143 i‡(
l
 > 2 && 
__ªsu…
 == 0) \

1144 
__ªsu…
 = (
s1
)[3] - (
s2
)[3]; \

1147 
__ªsu…
; }))

	)

1149 
	#__°rcmp_cg
(
s1
, 
s2
, 
l1
) \

1150 (
	`__exãnsi⁄__
 ({ c⁄° *
__s2
 = (
s2
); \

1151 
__ªsu…
 = (
s1
)[0] - 
__s2
[0]; \

1152 i‡(
l1
 > 0 && 
__ªsu…
 == 0) \

1154 
__ªsu…
 = (
s1
)[1] - 
__s2
[1]; \

1155 i‡(
l1
 > 1 && 
__ªsu…
 == 0) \

1157 
__ªsu…
 = (
s1
)[2] - 
__s2
[2]; \

1158 i‡(
l1
 > 2 && 
__ªsu…
 == 0) \

1159 
__ªsu…
 = (
s1
)[3] - 
__s2
[3]; \

1162 
__ªsu…
; }))

	)

1164 
	#__°rcmp_gc
(
s1
, 
s2
, 
l2
) \

1165 (
	`__exãnsi⁄__
 ({ c⁄° *
__s1
 = (
s1
); \

1166 
__ªsu…
 = 
__s1
[0] - (
s2
)[0]; \

1167 i‡(
l2
 > 0 && 
__ªsu…
 == 0) \

1169 
__ªsu…
 = 
__s1
[1] - (
s2
)[1]; \

1170 i‡(
l2
 > 1 && 
__ªsu…
 == 0) \

1172 
__ªsu…
 = 
__s1
[2] - (
s2
)[2]; \

1173 i‡(
l2
 > 2 && 
__ªsu…
 == 0) \

1174 
__ªsu…
 = 
__s1
[3] - (
s2
)[3]; \

1177 
__ªsu…
; }))

	)

1179 
__STRING_INLINE
 
__°rcmp_gg
 (c⁄° *
__s1
, c⁄° *
__s2
);

1181 
__STRING_INLINE
 

1182 
	$__°rcmp_gg
 (c⁄° *
__s1
, c⁄° *
__s2
)

1184 
__ªs
;

1185 
__asm__
 
__vﬁ©ûe__


1201 : "=q" (
__ªs
), "=&r" (
__s1
), "=&r" (
__s2
)

1202 : "1" (
__s1
), "2" (
__s2
),

1203 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s1
),

1204 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s2
)

1206  
__ªs
;

1207 
	}
}

1211 
	#_HAVE_STRING_ARCH_°∫cmp
 1

	)

1212 
	#°∫cmp
(
s1
, 
s2
, 
n
) \

1213 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& 
	`°æí
 (s1Ë< ((
size_t
Ë(
n
)) \

1214 ? 
	`°rcmp
 ((
s1
), (
s2
)) \

1215 : (
	`__buûtö_c⁄°™t_p
 (
s2
Ë&& 
	`°æí
 (s2Ë< ((
size_t
Ë(
n
))\

1216 ? 
	`°rcmp
 ((
s1
), (
s2
)) \

1217 : 
	`__°∫cmp_g
 ((
s1
), (
s2
), (
n
)))))

	)

1219 
__STRING_INLINE
 
__°∫cmp_g
 (c⁄° *
__s1
, c⁄° *
__s2
,

1220 
size_t
 
__n
);

1222 
__STRING_INLINE
 

1223 
	$__°∫cmp_g
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

1225 
__ªs
;

1226 
__asm__
 
__vﬁ©ûe__


1245 : "=q" (
__ªs
), "=&r" (
__s1
), "=&r" (
__s2
), "=&r" (
__n
)

1246 : "1" (
__s1
), "2" (
__s2
), "3" (
__n
),

1247 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s1
),

1248 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__n
]; } *)
__s2
)

1250  
__ªs
;

1251 
	}
}

1255 
	#_HAVE_STRING_ARCH_°rchr
 1

	)

1256 
	#_USE_STRING_ARCH_°rchr
 1

	)

1257 
	#°rchr
(
s
, 
c
) \

1258 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) \

1259 ? ((
c
) == '\0' \

1260 ? (*Ë
	`__øwmemchr
 ((
s
), (
c
)) \

1261 : 
	`__°rchr_c
 ((
s
), ((
c
) & 0xff) << 8)) \

1262 : 
	`__°rchr_g
 ((
s
), (
c
))))

	)

1264 
__STRING_INLINE
 *
__°rchr_c
 (c⁄° *
__s
, 
__c
);

1266 
__STRING_INLINE
 *

1267 
	$__°rchr_c
 (c⁄° *
__s
, 
__c
)

1269 
__d0
;

1270 *
__ªs
;

1271 
__asm__
 
__vﬁ©ûe__


1281 : "Ù" (
__ªs
), "=&a" (
__d0
)

1282 : "0" (
__s
), "1" (
__c
),

1283 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1285  
__ªs
;

1286 
	}
}

1288 
__STRING_INLINE
 *
__°rchr_g
 (c⁄° *
__s
, 
__c
);

1290 
__STRING_INLINE
 *

1291 
	$__°rchr_g
 (c⁄° *
__s
, 
__c
)

1293 
__d0
;

1294 *
__ªs
;

1295 
__asm__
 
__vﬁ©ûe__


1306 : "Ù" (
__ªs
), "=&a" (
__d0
)

1307 : "0" (
__s
), "1" (
__c
),

1308 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1310  
__ªs
;

1311 
	}
}

1315 
	#_HAVE_STRING_ARCH_°rch∫ul
 1

	)

1316 
	#__°rch∫ul
(
s
, 
c
) \

1317 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) \

1318 ? ((
c
) == '\0' \

1319 ? (*Ë
	`__øwmemchr
 ((
s
), 
c
) \

1320 : 
	`__°rch∫ul_c
 ((
s
), ((
c
) & 0xff) << 8)) \

1321 : 
	`__°rch∫ul_g
 ((
s
), 
c
)))

	)

1323 
__STRING_INLINE
 *
__°rch∫ul_c
 (c⁄° *
__s
, 
__c
);

1325 
__STRING_INLINE
 *

1326 
	$__°rch∫ul_c
 (c⁄° *
__s
, 
__c
)

1328 
__d0
;

1329 *
__ªs
;

1330 
__asm__
 
__vﬁ©ûe__


1340 : "Ù" (
__ªs
), "=&a" (
__d0
)

1341 : "0" (
__s
), "1" (
__c
),

1342 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1344  
__ªs
;

1345 
	}
}

1347 
__STRING_INLINE
 *
__°rch∫ul_g
 (c⁄° *
__s
, 
__c
);

1349 
__STRING_INLINE
 *

1350 
	$__°rch∫ul_g
 (c⁄° *
__s
, 
__c
)

1352 
__d0
;

1353 *
__ªs
;

1354 
__asm__
 
__vﬁ©ûe__


1365 : "Ù" (
__ªs
), "=&a" (
__d0
)

1366 : "0" (
__s
), "1" (
__c
),

1367 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1369  
__ªs
;

1370 
	}
}

1371 #ifde‡
__USE_GNU


1372 
	#°rch∫ul
(
s
, 
c
Ë
	`__°rch∫ul
 ((s), (c))

	)

1376 #i‡
deföed
 
__USE_BSD
 || deföed 
__USE_XOPEN_EXTENDED


1378 
	#_HAVE_STRING_ARCH_ödex
 1

	)

1379 
	#ödex
(
s
, 
c
) \

1380 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) \

1381 ? 
	`__°rchr_c
 ((
s
), ((
c
) & 0xff) << 8) \

1382 : 
	`__°rchr_g
 ((
s
), (
c
))))

	)

1387 
	#_HAVE_STRING_ARCH_°ºchr
 1

	)

1388 
	#°ºchr
(
s
, 
c
) \

1389 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) \

1390 ? 
	`__°ºchr_c
 ((
s
), ((
c
) & 0xff) << 8) \

1391 : 
	`__°ºchr_g
 ((
s
), (
c
))))

	)

1393 #ifde‡
__i686__


1394 
__STRING_INLINE
 *
__°ºchr_c
 (c⁄° *
__s
, 
__c
);

1396 
__STRING_INLINE
 *

1397 
	$__°ºchr_c
 (c⁄° *
__s
, 
__c
)

1399 
__d0
, 
__d1
;

1400 *
__ªs
;

1401 
__asm__
 
__vﬁ©ûe__


1409 : "=d" (
__ªs
), "=&S" (
__d0
), "=&a" (
__d1
)

1410 : "0" (1), "1" (
__s
), "2" (
__c
),

1411 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1413  
__ªs
 - 1;

1414 
	}
}

1416 
__STRING_INLINE
 *
__°ºchr_g
 (c⁄° *
__s
, 
__c
);

1418 
__STRING_INLINE
 *

1419 
	$__°ºchr_g
 (c⁄° *
__s
, 
__c
)

1421 
__d0
, 
__d1
;

1422 *
__ªs
;

1423 
__asm__
 
__vﬁ©ûe__


1432 : "=d" (
__ªs
), "=&S" (
__d0
), "=&a" (
__d1
)

1433 : "0" (1), "1" (
__s
), "2" (
__c
),

1434 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1436  
__ªs
 - 1;

1437 
	}
}

1439 
__STRING_INLINE
 *
__°ºchr_c
 (c⁄° *
__s
, 
__c
);

1441 
__STRING_INLINE
 *

1442 
	$__°ºchr_c
 (c⁄° *
__s
, 
__c
)

1444 
__d0
, 
__d1
;

1445 *
__ªs
;

1446 
__asm__
 
__vﬁ©ûe__


1456 : "=d" (
__ªs
), "=&S" (
__d0
), "=&a" (
__d1
)

1457 : "0" (0), "1" (
__s
), "2" (
__c
),

1458 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1460  
__ªs
;

1461 
	}
}

1463 
__STRING_INLINE
 *
__°ºchr_g
 (c⁄° *
__s
, 
__c
);

1465 
__STRING_INLINE
 *

1466 
	$__°ºchr_g
 (c⁄° *
__s
, 
__c
)

1468 
__d0
, 
__d1
;

1469 *
__ªs
;

1470 
__asm__
 
__vﬁ©ûe__


1481 : "Ù" (
__ªs
), "=&S" (
__d0
), "=&a" (
__d1
)

1482 : "0" (0), "1" (
__s
), "2" (
__c
),

1483 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1485  
__ªs
;

1486 
	}
}

1490 #i‡
deföed
 
__USE_BSD
 || deföed 
__USE_XOPEN_EXTENDED


1492 
	#_HAVE_STRING_ARCH_rödex
 1

	)

1493 
	#rödex
(
s
, 
c
) \

1494 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) \

1495 ? 
	`__°ºchr_c
 ((
s
), ((
c
) & 0xff) << 8) \

1496 : 
	`__°ºchr_g
 ((
s
), (
c
))))

	)

1502 
	#_HAVE_STRING_ARCH_°rc•n
 1

	)

1503 
	#°rc•n
(
s
, 
ªje˘
) \

1504 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
ªje˘
) &&  ((reject)[0]) == 1 \

1505 ? ((
ªje˘
)[0] == '\0' \

1506 ? 
	`°æí
 (
s
) \

1507 : ((
ªje˘
)[1] == '\0' \

1508 ? 
	`__°rc•n_c1
 ((
s
), (((
ªje˘
)[0] << 8) & 0xff00)) \

1509 : 
	`__°rc•n_cg
 ((
s
), (
ªje˘
), 
	`°æí
 (reject)))) \

1510 : 
	`__°rc•n_g
 ((
s
), (
ªje˘
))))

	)

1512 
__STRING_INLINE
 
size_t
 
__°rc•n_c1
 (c⁄° *
__s
, 
__ªje˘
);

1514 #i‚de‡
_FORCE_INLINES


1515 
__STRING_INLINE
 
size_t


1516 
	$__°rc•n_c1
 (c⁄° *
__s
, 
__ªje˘
)

1518 
__d0
;

1519 *
__ªs
;

1520 
__asm__
 
__vﬁ©ûe__


1529 : "Ù" (
__ªs
), "=&a" (
__d0
)

1530 : "0" (
__s
), "1" (
__ªje˘
),

1531 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1533  (
__ªs
 - 1Ë- 
__s
;

1534 
	}
}

1537 
__STRING_INLINE
 
size_t
 
__°rc•n_cg
 (c⁄° *
__s
, c⁄° 
__ªje˘
[],

1538 
size_t
 
__ªje˘_Àn
);

1540 
__STRING_INLINE
 
size_t


1541 
	$__°rc•n_cg
 (c⁄° *
__s
, c⁄° 
__ªje˘
[], 
size_t
 
__ªje˘_Àn
)

1543 
__d0
, 
__d1
, 
__d2
;

1544 c⁄° *
__ªs
;

1545 
__asm__
 
__vﬁ©ûe__


1556 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1557 : "0" (
__s
), "d" (
__ªje˘
), "g" (
__ªje˘_Àn
)

1559  (
__ªs
 - 1Ë- 
__s
;

1560 
	}
}

1562 
__STRING_INLINE
 
size_t
 
__°rc•n_g
 (c⁄° *
__s
, c⁄° *
__ªje˘
);

1563 #ifde‡
__PIC__


1565 
__STRING_INLINE
 
size_t


1566 
	$__°rc•n_g
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

1568 
__d0
, 
__d1
, 
__d2
;

1569 c⁄° *
__ªs
;

1570 
__asm__
 
__vﬁ©ûe__


1587 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1588 : "r" (
__ªje˘
), "0" (
__s
), "1" (0), "2" (0xffffffff)

1590  (
__ªs
 - 1Ë- 
__s
;

1591 
	}
}

1593 
__STRING_INLINE
 
size_t


1594 
	$__°rc•n_g
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

1596 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1597 c⁄° *
__ªs
;

1598 
__asm__
 
__vﬁ©ûe__


1612 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
), "=&d" (
__d3
)

1613 : "0" (
__s
), "1" (0), "2" (0xffffffff), "3" (
__ªje˘
), "b" (__reject)

1616  (
__ªs
 - 1Ë- 
__s
;

1617 
	}
}

1623 
	#_HAVE_STRING_ARCH_°r•n
 1

	)

1624 
	#°r•n
(
s
, 
ac˚±
) \

1625 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
ac˚±
) &&  ((accept)[0]) == 1 \

1626 ? ((
ac˚±
)[0] == '\0' \

1627 ? ((Ë(
s
), 0) \

1628 : ((
ac˚±
)[1] == '\0' \

1629 ? 
	`__°r•n_c1
 ((
s
), (((
ac˚±
)[0] << 8 ) & 0xff00)) \

1630 : 
	`__°r•n_cg
 ((
s
), (
ac˚±
), 
	`°æí
 (accept)))) \

1631 : 
	`__°r•n_g
 ((
s
), (
ac˚±
))))

	)

1633 #i‚de‡
_FORCE_INLINES


1634 
__STRING_INLINE
 
size_t
 
__°r•n_c1
 (c⁄° *
__s
, 
__ac˚±
);

1636 
__STRING_INLINE
 
size_t


1637 
	$__°r•n_c1
 (c⁄° *
__s
, 
__ac˚±
)

1639 
__d0
;

1640 *
__ªs
;

1642 
__asm__
 
__vﬁ©ûe__


1648 : "Ù" (
__ªs
), "=&q" (
__d0
)

1649 : "0" (
__s
), "1" (
__ac˚±
),

1650 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
)

1652  (
__ªs
 - 1Ë- 
__s
;

1653 
	}
}

1656 
__STRING_INLINE
 
size_t
 
__°r•n_cg
 (c⁄° *
__s
, c⁄° 
__ac˚±
[],

1657 
size_t
 
__ac˚±_Àn
);

1659 
__STRING_INLINE
 
size_t


1660 
	$__°r•n_cg
 (c⁄° *
__s
, c⁄° 
__ac˚±
[], 
size_t
 
__ac˚±_Àn
)

1662 
__d0
, 
__d1
, 
__d2
;

1663 c⁄° *
__ªs
;

1664 
__asm__
 
__vﬁ©ûe__


1675 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1676 : "0" (
__s
), "g" (
__ac˚±
), "g" (
__ac˚±_Àn
),

1679 "m" ( *(°ru˘ { 
__x
[0xfffffff]; } *)
__s
),

1680 "m" ( *(°ru˘ { 
__exãnsi⁄__
 
__x
[
__ac˚±_Àn
]; } *)
__ac˚±
)

1682  (
__ªs
 - 1Ë- 
__s
;

1683 
	}
}

1685 
__STRING_INLINE
 
size_t
 
__°r•n_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
);

1686 #ifde‡
__PIC__


1688 
__STRING_INLINE
 
size_t


1689 
	$__°r•n_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

1691 
__d0
, 
__d1
, 
__d2
;

1692 c⁄° *
__ªs
;

1693 
__asm__
 
__vﬁ©ûe__


1709 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1710 : "d" (
__ac˚±
), "0" (
__s
), "1" (0), "2" (0xffffffff), "3" (__accept)

1712  (
__ªs
 - 1Ë- 
__s
;

1713 
	}
}

1715 
__STRING_INLINE
 
size_t


1716 
	$__°r•n_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

1718 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1719 c⁄° *
__ªs
;

1720 
__asm__
 
__vﬁ©ûe__


1734 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
), "=&d" (
__d3
)

1735 : "0" (
__s
), "1" (0), "2" (0xffffffff), "3" (
__ac˚±
), "b" (__accept)

1737  (
__ªs
 - 1Ë- 
__s
;

1738 
	}
}

1743 
	#_HAVE_STRING_ARCH_°Ωbrk
 1

	)

1744 
	#°Ωbrk
(
s
, 
ac˚±
) \

1745 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
ac˚±
) &&  ((accept)[0]) == 1 \

1746 ? ((
ac˚±
)[0] == '\0' \

1747 ? ((Ë(
s
), (*) 0) \

1748 : ((
ac˚±
)[1] == '\0' \

1749 ? 
	`°rchr
 ((
s
), (
ac˚±
)[0]) \

1750 : 
	`__°Ωbrk_cg
 ((
s
), (
ac˚±
), 
	`°æí
 (accept)))) \

1751 : 
	`__°Ωbrk_g
 ((
s
), (
ac˚±
))))

	)

1753 
__STRING_INLINE
 *
__°Ωbrk_cg
 (c⁄° *
__s
, c⁄° 
__ac˚±
[],

1754 
size_t
 
__ac˚±_Àn
);

1756 
__STRING_INLINE
 *

1757 
	$__°Ωbrk_cg
 (c⁄° *
__s
, c⁄° 
__ac˚±
[], 
size_t
 
__ac˚±_Àn
)

1759 
__d0
, 
__d1
, 
__d2
;

1760 *
__ªs
;

1761 
__asm__
 
__vﬁ©ûe__


1776 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1777 : "0" (
__s
), "d" (
__ac˚±
), "g" (
__ac˚±_Àn
)

1779  
__ªs
;

1780 
	}
}

1782 
__STRING_INLINE
 *
__°Ωbrk_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
);

1783 #ifde‡
__PIC__


1785 
__STRING_INLINE
 *

1786 
	$__°Ωbrk_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

1788 
__d0
, 
__d1
, 
__d2
;

1789 *
__ªs
;

1790 
__asm__
 
__vﬁ©ûe__


1811 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1812 : "d" (
__ac˚±
), "0" (
__s
), "1" (0), "2" (0xffffffff)

1814  
__ªs
;

1815 
	}
}

1817 
__STRING_INLINE
 *

1818 
	$__°Ωbrk_g
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

1820 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1821 *
__ªs
;

1822 
__asm__
 
__vﬁ©ûe__


1841 : "=S" (
__ªs
), "=&a" (
__d0
), "=&c" (
__d1
), "=&d" (
__d2
), "=&D" (
__d3
)

1842 : "0" (
__s
), "1" (0), "2" (0xffffffff), "b" (
__ac˚±
)

1844  
__ªs
;

1845 
	}
}

1850 
	#_HAVE_STRING_ARCH_°r°r
 1

	)

1851 
	#°r°r
(
hay°ack
, 
√edÀ
) \

1852 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
√edÀ
) &&  ((needle)[0]) == 1 \

1853 ? ((
√edÀ
)[0] == '\0' \

1854 ? (
hay°ack
) \

1855 : ((
√edÀ
)[1] == '\0' \

1856 ? 
	`°rchr
 ((
hay°ack
), (
√edÀ
)[0]) \

1857 : 
	`__°r°r_cg
 ((
hay°ack
), (
√edÀ
), \

1858 
	`°æí
 (
√edÀ
)))) \

1859 : 
	`__°r°r_g
 ((
hay°ack
), (
√edÀ
))))

	)

1863 
__STRING_INLINE
 *
__°r°r_cg
 (c⁄° *
__hay°ack
,

1864 c⁄° 
__√edÀ
[],

1865 
size_t
 
__√edÀ_Àn
);

1867 
__STRING_INLINE
 *

1868 
	$__°r°r_cg
 (c⁄° *
__hay°ack
, c⁄° 
__√edÀ
[],

1869 
size_t
 
__√edÀ_Àn
)

1871 
__d0
, 
__d1
, 
__d2
;

1872 *
__ªs
;

1873 
__asm__
 
__vﬁ©ûe__


1886 : "=&a" (
__ªs
), "=&S" (
__d0
), "=&D" (
__d1
), "=&c" (
__d2
)

1887 : "g" (
__√edÀ_Àn
), "1" (
__hay°ack
), "d" (
__√edÀ
)

1889  
__ªs
;

1890 
	}
}

1892 
__STRING_INLINE
 *
__°r°r_g
 (c⁄° *
__hay°ack
,

1893 c⁄° *
__√edÀ
);

1894 #ifde‡
__PIC__


1896 
__STRING_INLINE
 *

1897 
	$__°r°r_g
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

1899 
__d0
, 
__d1
, 
__d2
;

1900 *
__ªs
;

1901 
__asm__
 
__vﬁ©ûe__


1920 : "=&a" (
__ªs
), "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
)

1921 : "0" (0), "1" (0xffffffff), "2" (
__hay°ack
), "3" (
__√edÀ
),

1922 "d" (
__√edÀ
)

1924  
__ªs
;

1925 
	}
}

1927 
__STRING_INLINE
 *

1928 
	$__°r°r_g
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

1930 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1931 *
__ªs
;

1932 
__asm__
 
__vﬁ©ûe__


1949 : "=&a" (
__ªs
), "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
), "=&d" (
__d3
)

1950 : "0" (0), "1" (0xffffffff), "2" (
__hay°ack
), "3" (
__√edÀ
),

1951 "b" (
__√edÀ
)

1953  
__ªs
;

1954 
	}
}

1960 #i‡
deföed
 
__USE_BSD
 || deföed 
__USE_XOPEN_EXTENDED


1961 #ifde‡
__i686__


1962 
	#_HAVE_STRING_ARCH_ffs
 1

	)

1963 
	#ffs
(
w‹d
Ë(
	`__buûtö_c⁄°™t_p
 (word) \

1964 ? 
	`__buûtö_ffs
 (
w‹d
) \

1965 : ({ 
__˙t
, 
__tmp
; \

1966 
__asm__
 
__vﬁ©ûe__
 \

1969 : "=&r" (
__˙t
), "Ù" (
__tmp
) \

1970 : "rm" (
w‹d
), "1" (-1)); \

1971 
__˙t
 + 1; }))

	)

1973 #i‚de‡
ff¶


1974 
	#ff¶
(
w‹d
Ë
	`ffs
(w‹d)

	)

1979 #i‚de‡
_FORCE_INLINES


1980 #unde‡
__STRING_INLINE


	@/usr/include/bits/string2.h

20 #i‚de‡
_STRING_H


24 #i‡!
deföed
 
__NO_STRING_INLINES
 && !deföed 
__BOUNDED_POINTERS__


41 #i‚de‡
__STRING_INLINE


42 #ifde‡
__˝lu•lus


43 
	#__STRING_INLINE
 
ölöe


	)

45 
	#__STRING_INLINE
 
__exã∫_ölöe


	)

49 #i‡
_STRING_ARCH_u«lig√d


51 
	~<ídün.h
>

52 
	~<bôs/ty≥s.h
>

54 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


55 
	#__STRING2_SMALL_GET16
(
§c
, 
idx
) \

56 (((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
 + 1] << 8 \

57 | ((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
])

	)

58 
	#__STRING2_SMALL_GET32
(
§c
, 
idx
) \

59 (((((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
 + 3] << 8 \

60 | ((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
 + 2]) << 8 \

61 | ((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
 + 1]) << 8 \

62 | ((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
])

	)

64 
	#__STRING2_SMALL_GET16
(
§c
, 
idx
) \

65 (((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
] << 8 \

66 | ((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
 + 1])

	)

67 
	#__STRING2_SMALL_GET32
(
§c
, 
idx
) \

68 (((((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
] << 8 \

69 | ((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
 + 1]) << 8 \

70 | ((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
 + 2]) << 8 \

71 | ((c⁄° *Ë(c⁄° *Ë(
§c
))[
idx
 + 3])

	)

76 
	#__STRING2_COPY_TYPE
(
N
) \

77 °ru˘ { 
__¨r
[
N
]; } \

78 
	t__©åibuã__
 ((
	t__∑cked__
)Ë
	t__STRING2_COPY_ARR
##
	tN


	)

79 
	t__STRING2_COPY_TYPE
 (2);

80 
__STRING2_COPY_TYPE
 (3);

81 
__STRING2_COPY_TYPE
 (4);

82 
__STRING2_COPY_TYPE
 (5);

83 
__STRING2_COPY_TYPE
 (6);

84 
__STRING2_COPY_TYPE
 (7);

85 
__STRING2_COPY_TYPE
 (8);

86 #unde‡
__STRING2_COPY_TYPE


92 
	#__°rög2_1b±r_p
(
__x
) \

93 ((
size_t
)(c⁄° *)((
__x
Ë+ 1Ë- (size_t)(c⁄° *)(__xË=1)

	)

96 #i‡!
deföed
 
_HAVE_STRING_ARCH_mem£t


97 #i‡!
__GNUC_PREREQ
 (3, 0)

98 #i‡
_STRING_ARCH_u«lig√d


99 
	#mem£t
(
s
, 
c
, 
n
) \

100 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
n
) && (n) <= 16 \

101 ? ((
n
) == 1 \

102 ? 
	`__mem£t_1
 (
s
, 
c
) \

103 : 
	`__mem£t_gc
 (
s
, 
c
, 
n
)) \

104 : (
	`__buûtö_c⁄°™t_p
 (
c
) && (c) == '\0' \

105 ? ({ *
__s
 = (
s
); 
	`__bzîo
 (__s, 
n
); __s; }) \

106 : 
	`mem£t
 (
s
, 
c
, 
n
))))

	)

108 
	#__mem£t_1
(
s
, 
c
Ë({ *
__s
 = (s); \

109 *((
__uöt8_t
 *Ë
__s
Ë(__uöt8_tË
c
; __s; })

	)

111 
	#__mem£t_gc
(
s
, 
c
, 
n
) \

112 ({ *
__s
 = (
s
); \

114 
__ui
; \

115 
__usi
; \

116 
__uc
; \

117 } *
__u
 = 
__s
; \

118 
__uöt8_t
 
__c
 = (__uöt8_tË(
c
); \

121 (Ë(
n
)) \

124 
__u
->
__ui
 = 
__c
 * 0x01010101; \

125 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

127 
__u
->
__ui
 = 
__c
 * 0x01010101; \

128 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

130 
__u
->
__ui
 = 
__c
 * 0x01010101; \

131 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

133 
__u
->
__usi
 = (Ë
__c
 * 0x0101; \

134 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2); \

135 
__u
->
__uc
 = (Ë
__c
; \

139 
__u
->
__ui
 = 
__c
 * 0x01010101; \

140 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

142 
__u
->
__ui
 = 
__c
 * 0x01010101; \

143 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

145 
__u
->
__ui
 = 
__c
 * 0x01010101; \

146 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

148 
__u
->
__usi
 = (Ë
__c
 * 0x0101; \

152 
__u
->
__ui
 = 
__c
 * 0x01010101; \

153 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

155 
__u
->
__ui
 = 
__c
 * 0x01010101; \

156 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

158 
__u
->
__ui
 = 
__c
 * 0x01010101; \

159 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

161 
__u
->
__uc
 = (Ë
__c
; \

165 
__u
->
__ui
 = 
__c
 * 0x01010101; \

166 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

168 
__u
->
__ui
 = 
__c
 * 0x01010101; \

169 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

171 
__u
->
__ui
 = 
__c
 * 0x01010101; \

172 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4); \

174 
__u
->
__ui
 = 
__c
 * 0x01010101; \

179 
__s
; })

	)

181 
	#mem£t
(
s
, 
c
, 
n
) \

182 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) && (c) == '\0' \

183 ? ({ *
__s
 = (
s
); 
	`__bzîo
 (__s, 
n
); __s; }) \

184 : 
	`mem£t
 (
s
, 
c
, 
n
)))

	)

193 #i‡
__GNUC_PREREQ
 (2, 91)

194 
	#__bzîo
(
s
, 
n
Ë
	`__buûtö_mem£t
 (s, '\0',Ç)

	)

202 #ifde‡
__USE_GNU


203 #i‡!
deföed
 
_HAVE_STRING_ARCH_memp˝y
 || deföed 
_FORCE_INLINES


204 #i‚de‡
_HAVE_STRING_ARCH_memp˝y


205 #i‡
__GNUC_PREREQ
 (3, 4)

206 
	#__memp˝y
(
de°
, 
§c
, 
n
Ë
	`__buûtö_memp˝y
 (de°, src,Ç)

	)

207 #ñi‡
__GNUC_PREREQ
 (3, 0)

208 
	#__memp˝y
(
de°
, 
§c
, 
n
) \

209 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
Ë&& __buûtö_c⁄°™t_∞(
n
) \

210 && 
	`__°rög2_1b±r_p
 (
§c
Ë&& 
n
 <= 8 \

211 ? 
	`__buûtö_mem˝y
 (
de°
, 
§c
, 
n
) + (n) \

212 : 
	`__memp˝y
 (
de°
, 
§c
, 
n
)))

	)

214 
	#__memp˝y
(
de°
, 
§c
, 
n
) \

215 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
Ë&& __buûtö_c⁄°™t_∞(
n
) \

216 && 
	`__°rög2_1b±r_p
 (
§c
Ë&& 
n
 <= 8 \

217 ? 
	`__memp˝y_smÆl
 (
de°
, 
	`__memp˝y_¨gs
 (
§c
), 
n
) \

218 : 
	`__memp˝y
 (
de°
, 
§c
, 
n
)))

	)

222 
	#memp˝y
(
de°
, 
§c
, 
n
Ë
	`__memp˝y
 (de°, src,Ç)

	)

225 #i‡!
__GNUC_PREREQ
 (3, 0Ë|| 
deföed
 
_FORCE_INLINES


226 #i‡
_STRING_ARCH_u«lig√d


227 #i‚de‡
_FORCE_INLINES


228 
	#__memp˝y_¨gs
(
§c
) \

229 ((c⁄° *Ë(
§c
))[0], ((const *) (src))[2], \

230 ((c⁄° *Ë(
§c
))[4], ((const *) (src))[6], \

231 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET16
 (
§c
, 0), \

232 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET16
 (
§c
, 4), \

233 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET32
 (
§c
, 0), \

234 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET32
 (
§c
, 4)

	)

236 
__STRING_INLINE
 *
__memp˝y_smÆl
 (*, , , , ,

237 
__uöt16_t
, __uöt16_t, 
__uöt32_t
,

238 
__uöt32_t
, 
size_t
);

239 
__STRING_INLINE
 *

240 
	$__memp˝y_smÆl
 (*
__de°1
,

241 
__§c0_1
, 
__§c2_1
, 
__§c4_1
, 
__§c6_1
,

242 
__uöt16_t
 
__§c0_2
, __uöt16_à
__§c4_2
,

243 
__uöt32_t
 
__§c0_4
, __uöt32_à
__§c4_4
,

244 
size_t
 
__§˛í
)

247 
__uöt32_t
 
__ui
;

248 
__uöt16_t
 
__usi
;

249 
__uc
;

250 
__c
;

251 } *
__u
 = 
__de°1
;

252 (Ë
__§˛í
)

255 
__u
->
__c
 = 
__§c0_1
;

256 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 1);

259 
__u
->
__usi
 = 
__§c0_2
;

260 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2);

263 
__u
->
__usi
 = 
__§c0_2
;

264 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2);

265 
__u
->
__c
 = 
__§c2_1
;

266 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 1);

269 
__u
->
__ui
 = 
__§c0_4
;

270 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

273 
__u
->
__ui
 = 
__§c0_4
;

274 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

275 
__u
->
__c
 = 
__§c4_1
;

276 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 1);

279 
__u
->
__ui
 = 
__§c0_4
;

280 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

281 
__u
->
__usi
 = 
__§c4_2
;

282 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2);

285 
__u
->
__ui
 = 
__§c0_4
;

286 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

287 
__u
->
__usi
 = 
__§c4_2
;

288 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2);

289 
__u
->
__c
 = 
__§c6_1
;

290 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 1);

293 
__u
->
__ui
 = 
__§c0_4
;

294 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

295 
__u
->
__ui
 = 
__§c4_4
;

296 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

299  (*Ë
__u
;

300 
	}
}

302 #i‚de‡
_FORCE_INLINES


303 
	#__memp˝y_¨gs
(
§c
) \

304 ((c⁄° *Ë(
§c
))[0], \

305 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR2
) \

306 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1] } }), \

307 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR3
) \

308 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

309 ((c⁄° *Ë(
§c
))[2] } }), \

310 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR4
) \

311 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

312 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3] } }), \

313 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR5
) \

314 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

315 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

316 ((c⁄° *Ë(
§c
))[4] } }), \

317 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR6
) \

318 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

319 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

320 ((c⁄° *Ë(
§c
))[4], ((const *) (src))[5] } }), \

321 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR7
) \

322 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

323 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

324 ((c⁄° *Ë(
§c
))[4], ((const *) (src))[5], \

325 ((c⁄° *Ë(
§c
))[6] } }), \

326 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR8
) \

327 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

328 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

329 ((c⁄° *Ë(
§c
))[4], ((const *) (src))[5], \

330 ((c⁄° *Ë(
§c
))[6], ((c⁄° *Ë(§c))[7] } })

	)

332 
__STRING_INLINE
 *
__memp˝y_smÆl
 (*, , 
__STRING2_COPY_ARR2
,

333 
__STRING2_COPY_ARR3
,

334 
__STRING2_COPY_ARR4
,

335 
__STRING2_COPY_ARR5
,

336 
__STRING2_COPY_ARR6
,

337 
__STRING2_COPY_ARR7
,

338 
__STRING2_COPY_ARR8
, 
size_t
);

339 
__STRING_INLINE
 *

340 
	$__memp˝y_smÆl
 (*
__de°
, 
__§c1
,

341 
__STRING2_COPY_ARR2
 
__§c2
, 
__STRING2_COPY_ARR3
 
__§c3
,

342 
__STRING2_COPY_ARR4
 
__§c4
, 
__STRING2_COPY_ARR5
 
__§c5
,

343 
__STRING2_COPY_ARR6
 
__§c6
, 
__STRING2_COPY_ARR7
 
__§c7
,

344 
__STRING2_COPY_ARR8
 
__§c8
, 
size_t
 
__§˛í
)

347 
__c
;

348 
__STRING2_COPY_ARR2
 
__sˇ2
;

349 
__STRING2_COPY_ARR3
 
__sˇ3
;

350 
__STRING2_COPY_ARR4
 
__sˇ4
;

351 
__STRING2_COPY_ARR5
 
__sˇ5
;

352 
__STRING2_COPY_ARR6
 
__sˇ6
;

353 
__STRING2_COPY_ARR7
 
__sˇ7
;

354 
__STRING2_COPY_ARR8
 
__sˇ8
;

355 } *
__u
 = 
__de°
;

356 (Ë
__§˛í
)

359 
__u
->
__c
 = 
__§c1
;

362 
__exãnsi⁄__
 
__u
->
__sˇ2
 = 
__§c2
;

365 
__exãnsi⁄__
 
__u
->
__sˇ3
 = 
__§c3
;

368 
__exãnsi⁄__
 
__u
->
__sˇ4
 = 
__§c4
;

371 
__exãnsi⁄__
 
__u
->
__sˇ5
 = 
__§c5
;

374 
__exãnsi⁄__
 
__u
->
__sˇ6
 = 
__§c6
;

377 
__exãnsi⁄__
 
__u
->
__sˇ7
 = 
__§c7
;

380 
__exãnsi⁄__
 
__u
->
__sˇ8
 = 
__§c8
;

383  
	`__exãnsi⁄__
 ((*Ë
__u
 + 
__§˛í
);

384 
	}
}

392 #i‚de‡
_HAVE_STRING_ARCH_°rchr


393 *
__øwmemchr
 (c⁄° *
__s
, 
__c
);

394 #i‡
__GNUC_PREREQ
 (3, 2)

395 
	#°rchr
(
s
, 
c
) \

396 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
Ë&& !__buûtö_c⁄°™t_∞(
s
) \

397 && (
c
) == '\0' \

398 ? (*Ë
	`__øwmemchr
 (
s
, 
c
) \

399 : 
	`__buûtö_°rchr
 (
s
, 
c
)))

	)

401 
	#°rchr
(
s
, 
c
) \

402 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
c
) && (c) == '\0' \

403 ? (*Ë
	`__øwmemchr
 (
s
, 
c
) \

404 : 
	`°rchr
 (
s
, 
c
)))

	)

410 #i‡(!
deföed
 
_HAVE_STRING_ARCH_°r˝y
 && !
__GNUC_PREREQ
 (3, 0)) \

411 || 
deföed
 
	g_FORCE_INLINES


412 #i‡!
deföed
 
_HAVE_STRING_ARCH_°r˝y
 && !
__GNUC_PREREQ
 (3, 0)

413 
	#°r˝y
(
de°
, 
§c
) \

414 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
) \

415 ? (
	`__°rög2_1b±r_p
 (
§c
Ë&& 
	`°æí
 (src) + 1 <= 8 \

416 ? 
	`__°r˝y_smÆl
 (
de°
, 
	`__°r˝y_¨gs
 (
§c
), \

417 
	`°æí
 (
§c
) + 1) \

418 : (*Ë
	`mem˝y
 (
de°
, 
§c
, 
	`°æí
 (src) + 1)) \

419 : 
	`°r˝y
 (
de°
, 
§c
)))

	)

422 #i‡
_STRING_ARCH_u«lig√d


423 #i‚de‡
_FORCE_INLINES


424 
	#__°r˝y_¨gs
(
§c
) \

425 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET16
 (
§c
, 0), \

426 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET16
 (
§c
, 4), \

427 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET32
 (
§c
, 0), \

428 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET32
 (
§c
, 4)

	)

430 
__STRING_INLINE
 *
__°r˝y_smÆl
 (*, 
__uöt16_t
, __uint16_t,

431 
__uöt32_t
, __uöt32_t, 
size_t
);

432 
__STRING_INLINE
 *

433 
	$__°r˝y_smÆl
 (*
__de°
,

434 
__uöt16_t
 
__§c0_2
, __uöt16_à
__§c4_2
,

435 
__uöt32_t
 
__§c0_4
, __uöt32_à
__§c4_4
,

436 
size_t
 
__§˛í
)

439 
__uöt32_t
 
__ui
;

440 
__uöt16_t
 
__usi
;

441 
__uc
;

442 } *
__u
 = (*Ë
__de°
;

443 (Ë
__§˛í
)

446 
__u
->
__uc
 = '\0';

449 
__u
->
__usi
 = 
__§c0_2
;

452 
__u
->
__usi
 = 
__§c0_2
;

453 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2);

454 
__u
->
__uc
 = '\0';

457 
__u
->
__ui
 = 
__§c0_4
;

460 
__u
->
__ui
 = 
__§c0_4
;

461 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

462 
__u
->
__uc
 = '\0';

465 
__u
->
__ui
 = 
__§c0_4
;

466 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

467 
__u
->
__usi
 = 
__§c4_2
;

470 
__u
->
__ui
 = 
__§c0_4
;

471 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

472 
__u
->
__usi
 = 
__§c4_2
;

473 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2);

474 
__u
->
__uc
 = '\0';

477 
__u
->
__ui
 = 
__§c0_4
;

478 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

479 
__u
->
__ui
 = 
__§c4_4
;

482  
__de°
;

483 
	}
}

485 #i‚de‡
_FORCE_INLINES


486 
	#__°r˝y_¨gs
(
§c
) \

487 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR2
) \

488 { { ((c⁄° *Ë(
§c
))[0], '\0' } }), \

489 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR3
) \

490 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

492 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR4
) \

493 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

494 ((c⁄° *Ë(
§c
))[2], '\0' } }), \

495 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR5
) \

496 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

497 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

499 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR6
) \

500 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

501 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

502 ((c⁄° *Ë(
§c
))[4], '\0' } }), \

503 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR7
) \

504 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

505 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

506 ((c⁄° *Ë(
§c
))[4], ((const *) (src))[5], \

508 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR8
) \

509 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

510 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

511 ((c⁄° *Ë(
§c
))[4], ((const *) (src))[5], \

512 ((c⁄° *Ë(
§c
))[6], '\0' } })

	)

514 
__STRING_INLINE
 *
__°r˝y_smÆl
 (*, 
__STRING2_COPY_ARR2
,

515 
__STRING2_COPY_ARR3
,

516 
__STRING2_COPY_ARR4
,

517 
__STRING2_COPY_ARR5
,

518 
__STRING2_COPY_ARR6
,

519 
__STRING2_COPY_ARR7
,

520 
__STRING2_COPY_ARR8
, 
size_t
);

521 
__STRING_INLINE
 *

522 
	$__°r˝y_smÆl
 (*
__de°
,

523 
__STRING2_COPY_ARR2
 
__§c2
, 
__STRING2_COPY_ARR3
 
__§c3
,

524 
__STRING2_COPY_ARR4
 
__§c4
, 
__STRING2_COPY_ARR5
 
__§c5
,

525 
__STRING2_COPY_ARR6
 
__§c6
, 
__STRING2_COPY_ARR7
 
__§c7
,

526 
__STRING2_COPY_ARR8
 
__§c8
, 
size_t
 
__§˛í
)

529 
__c
;

530 
__STRING2_COPY_ARR2
 
__sˇ2
;

531 
__STRING2_COPY_ARR3
 
__sˇ3
;

532 
__STRING2_COPY_ARR4
 
__sˇ4
;

533 
__STRING2_COPY_ARR5
 
__sˇ5
;

534 
__STRING2_COPY_ARR6
 
__sˇ6
;

535 
__STRING2_COPY_ARR7
 
__sˇ7
;

536 
__STRING2_COPY_ARR8
 
__sˇ8
;

537 } *
__u
 = (*Ë
__de°
;

538 (Ë
__§˛í
)

541 
__u
->
__c
 = '\0';

544 
__exãnsi⁄__
 
__u
->
__sˇ2
 = 
__§c2
;

547 
__exãnsi⁄__
 
__u
->
__sˇ3
 = 
__§c3
;

550 
__exãnsi⁄__
 
__u
->
__sˇ4
 = 
__§c4
;

553 
__exãnsi⁄__
 
__u
->
__sˇ5
 = 
__§c5
;

556 
__exãnsi⁄__
 
__u
->
__sˇ6
 = 
__§c6
;

559 
__exãnsi⁄__
 
__u
->
__sˇ7
 = 
__§c7
;

562 
__exãnsi⁄__
 
__u
->
__sˇ8
 = 
__§c8
;

565  
__de°
;

566 
	}
}

572 #ifde‡
__USE_GNU


573 #i‡!
deföed
 
_HAVE_STRING_ARCH_°p˝y
 || deföed 
_FORCE_INLINES


574 #i‚de‡
_HAVE_STRING_ARCH_°p˝y


575 #i‡
__GNUC_PREREQ
 (3, 4)

576 
	#__°p˝y
(
de°
, 
§c
Ë
	`__buûtö_°p˝y
 (de°, src)

	)

577 #ñi‡
__GNUC_PREREQ
 (3, 0)

578 
	#__°p˝y
(
de°
, 
§c
) \

579 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
) \

580 ? (
	`__°rög2_1b±r_p
 (
§c
Ë&& 
	`°æí
 (src) + 1 <= 8 \

581 ? 
	`__buûtö_°r˝y
 (
de°
, 
§c
Ë+ 
	`°æí
 (src) \

582 : ((*Ë(
__memp˝y
Ë(
de°
, 
§c
, 
	`°æí
 (src) + 1) \

584 : 
	`__°p˝y
 (
de°
, 
§c
)))

	)

586 
	#__°p˝y
(
de°
, 
§c
) \

587 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
) \

588 ? (
	`__°rög2_1b±r_p
 (
§c
Ë&& 
	`°æí
 (src) + 1 <= 8 \

589 ? 
	`__°p˝y_smÆl
 (
de°
, 
	`__°p˝y_¨gs
 (
§c
), \

590 
	`°æí
 (
§c
) + 1) \

591 : ((*Ë(
__memp˝y
Ë(
de°
, 
§c
, 
	`°æí
 (src) + 1) \

593 : 
	`__°p˝y
 (
de°
, 
§c
)))

	)

597 
	#°p˝y
(
de°
, 
§c
Ë
	`__°p˝y
 (de°, src)

	)

600 #i‡!
__GNUC_PREREQ
 (3, 0Ë|| 
deföed
 
_FORCE_INLINES


601 #i‡
_STRING_ARCH_u«lig√d


602 #i‚de‡
_FORCE_INLINES


603 
	#__°p˝y_¨gs
(
§c
) \

604 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET16
 (
§c
, 0), \

605 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET16
 (
§c
, 4), \

606 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET32
 (
§c
, 0), \

607 
__exãnsi⁄__
 
	`__STRING2_SMALL_GET32
 (
§c
, 4)

	)

609 
__STRING_INLINE
 *
__°p˝y_smÆl
 (*, 
__uöt16_t
, __uint16_t,

610 
__uöt32_t
, __uöt32_t, 
size_t
);

611 
__STRING_INLINE
 *

612 
	$__°p˝y_smÆl
 (*
__de°
,

613 
__uöt16_t
 
__§c0_2
, __uöt16_à
__§c4_2
,

614 
__uöt32_t
 
__§c0_4
, __uöt32_à
__§c4_4
,

615 
size_t
 
__§˛í
)

618 
__ui
;

619 
__usi
;

620 
__uc
;

621 
__c
;

622 } *
__u
 = (*Ë
__de°
;

623 (Ë
__§˛í
)

626 
__u
->
__uc
 = '\0';

629 
__u
->
__usi
 = 
__§c0_2
;

630 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 1);

633 
__u
->
__usi
 = 
__§c0_2
;

634 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2);

635 
__u
->
__uc
 = '\0';

638 
__u
->
__ui
 = 
__§c0_4
;

639 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 3);

642 
__u
->
__ui
 = 
__§c0_4
;

643 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

644 
__u
->
__uc
 = '\0';

647 
__u
->
__ui
 = 
__§c0_4
;

648 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

649 
__u
->
__usi
 = 
__§c4_2
;

650 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 1);

653 
__u
->
__ui
 = 
__§c0_4
;

654 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

655 
__u
->
__usi
 = 
__§c4_2
;

656 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 2);

657 
__u
->
__uc
 = '\0';

660 
__u
->
__ui
 = 
__§c0_4
;

661 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 4);

662 
__u
->
__ui
 = 
__§c4_4
;

663 
__u
 = 
	`__exãnsi⁄__
 ((*) __u + 3);

666  &
__u
->
__c
;

667 
	}
}

669 #i‚de‡
_FORCE_INLINES


670 
	#__°p˝y_¨gs
(
§c
) \

671 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR2
) \

672 { { ((c⁄° *Ë(
§c
))[0], '\0' } }), \

673 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR3
) \

674 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

676 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR4
) \

677 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

678 ((c⁄° *Ë(
§c
))[2], '\0' } }), \

679 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR5
) \

680 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

681 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

683 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR6
) \

684 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

685 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

686 ((c⁄° *Ë(
§c
))[4], '\0' } }), \

687 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR7
) \

688 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

689 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

690 ((c⁄° *Ë(
§c
))[4], ((const *) (src))[5], \

692 
	`__exãnsi⁄__
 ((
__STRING2_COPY_ARR8
) \

693 { { ((c⁄° *Ë(
§c
))[0], ((const *) (src))[1], \

694 ((c⁄° *Ë(
§c
))[2], ((const *) (src))[3], \

695 ((c⁄° *Ë(
§c
))[4], ((const *) (src))[5], \

696 ((c⁄° *Ë(
§c
))[6], '\0' } })

	)

698 
__STRING_INLINE
 *
__°p˝y_smÆl
 (*, 
__STRING2_COPY_ARR2
,

699 
__STRING2_COPY_ARR3
,

700 
__STRING2_COPY_ARR4
,

701 
__STRING2_COPY_ARR5
,

702 
__STRING2_COPY_ARR6
,

703 
__STRING2_COPY_ARR7
,

704 
__STRING2_COPY_ARR8
, 
size_t
);

705 
__STRING_INLINE
 *

706 
	$__°p˝y_smÆl
 (*
__de°
,

707 
__STRING2_COPY_ARR2
 
__§c2
, 
__STRING2_COPY_ARR3
 
__§c3
,

708 
__STRING2_COPY_ARR4
 
__§c4
, 
__STRING2_COPY_ARR5
 
__§c5
,

709 
__STRING2_COPY_ARR6
 
__§c6
, 
__STRING2_COPY_ARR7
 
__§c7
,

710 
__STRING2_COPY_ARR8
 
__§c8
, 
size_t
 
__§˛í
)

713 
__c
;

714 
__STRING2_COPY_ARR2
 
__sˇ2
;

715 
__STRING2_COPY_ARR3
 
__sˇ3
;

716 
__STRING2_COPY_ARR4
 
__sˇ4
;

717 
__STRING2_COPY_ARR5
 
__sˇ5
;

718 
__STRING2_COPY_ARR6
 
__sˇ6
;

719 
__STRING2_COPY_ARR7
 
__sˇ7
;

720 
__STRING2_COPY_ARR8
 
__sˇ8
;

721 } *
__u
 = (*Ë
__de°
;

722 (Ë
__§˛í
)

725 
__u
->
__c
 = '\0';

728 
__exãnsi⁄__
 
__u
->
__sˇ2
 = 
__§c2
;

731 
__exãnsi⁄__
 
__u
->
__sˇ3
 = 
__§c3
;

734 
__exãnsi⁄__
 
__u
->
__sˇ4
 = 
__§c4
;

737 
__exãnsi⁄__
 
__u
->
__sˇ5
 = 
__§c5
;

740 
__exãnsi⁄__
 
__u
->
__sˇ6
 = 
__§c6
;

743 
__exãnsi⁄__
 
__u
->
__sˇ7
 = 
__§c7
;

746 
__exãnsi⁄__
 
__u
->
__sˇ8
 = 
__§c8
;

749  
__de°
 + 
__§˛í
 - 1;

750 
	}
}

758 #i‚de‡
_HAVE_STRING_ARCH_°∫˝y


759 #i‡
__GNUC_PREREQ
 (3, 2)

760 
	#°∫˝y
(
de°
, 
§c
, 
n
Ë
	`__buûtö_°∫˝y
 (de°, src,Ç)

	)

762 
	#°∫˝y
(
de°
, 
§c
, 
n
) \

763 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
Ë&& __buûtö_c⁄°™t_∞(
n
) \

764 ? (
	`°æí
 (
§c
Ë+ 1 >((
size_t
Ë(
n
)) \

765 ? (*Ë
	`mem˝y
 (
de°
, 
§c
, 
n
) \

766 : 
	`°∫˝y
 (
de°
, 
§c
, 
n
)) \

767 : 
	`°∫˝y
 (
de°
, 
§c
, 
n
)))

	)

773 #i‚de‡
_HAVE_STRING_ARCH_°∫ˇt


774 #ifde‡
_USE_STRING_ARCH_°rchr


775 
	#°∫ˇt
(
de°
, 
§c
, 
n
) \

776 (
	`__exãnsi⁄__
 ({ *
__de°
 = (
de°
); \

777 
	`__buûtö_c⁄°™t_p
 (
§c
Ë&& __buûtö_c⁄°™t_∞(
n
) \

778 ? (
	`°æí
 (
§c
Ë< ((
size_t
Ë(
n
)) \

779 ? 
	`°rˇt
 (
__de°
, 
§c
) \

780 : (*((*Ë
	`__memp˝y
 (
	`°rchr
 (
__de°
, '\0'), \

781 
§c
, 
n
)Ë'\0', 
__de°
)) \

782 : 
	`°∫ˇt
 (
de°
, 
§c
, 
n
); }))

	)

783 #ñi‡
__GNUC_PREREQ
 (3, 2)

784 
	#°∫ˇt
(
de°
, 
§c
, 
n
Ë
	`__buûtö_°∫ˇt
 (de°, src,Ç)

	)

786 
	#°∫ˇt
(
de°
, 
§c
, 
n
) \

787 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
§c
Ë&& __buûtö_c⁄°™t_∞(
n
) \

788 ? (
	`°æí
 (
§c
Ë< ((
size_t
Ë(
n
)) \

789 ? 
	`°rˇt
 (
de°
, 
§c
) \

790 : 
	`°∫ˇt
 (
de°
, 
§c
, 
n
)) \

791 : 
	`°∫ˇt
 (
de°
, 
§c
, 
n
)))

	)

797 #i‚de‡
_HAVE_STRING_ARCH_°rcmp


798 #i‡
__GNUC_PREREQ
 (3, 2)

799 
	#°rcmp
(
s1
, 
s2
) \

800 
__exãnsi⁄__
 \

801 ({ 
size_t
 
__s1_Àn
, 
__s2_Àn
; \

802 (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& __buûtö_c⁄°™t_∞(
s2
) \

803 && (
__s1_Àn
 = 
	`°æí
 (
s1
), 
__s2_Àn
 = såÀ¿(
s2
), \

804 (!
	`__°rög2_1b±r_p
 (
s1
Ë|| 
__s1_Àn
 >= 4) \

805 && (!
	`__°rög2_1b±r_p
 (
s2
Ë|| 
__s2_Àn
 >= 4)) \

806 ? 
	`__buûtö_°rcmp
 (
s1
, 
s2
) \

807 : (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& 
	`__°rög2_1b±r_p
 (s1) \

808 && (
__s1_Àn
 = 
	`°æí
 (
s1
), __s1_len < 4) \

809 ? (
	`__buûtö_c⁄°™t_p
 (
s2
Ë&& 
	`__°rög2_1b±r_p
 (s2) \

810 ? 
	`__buûtö_°rcmp
 (
s1
, 
s2
) \

811 : 
	`__°rcmp_cg
 (
s1
, 
s2
, 
__s1_Àn
)) \

812 : (
	`__buûtö_c⁄°™t_p
 (
s2
Ë&& 
	`__°rög2_1b±r_p
 (s2) \

813 && (
__s2_Àn
 = 
	`°æí
 (
s2
), __s2_len < 4) \

814 ? (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& 
	`__°rög2_1b±r_p
 (s1) \

815 ? 
	`__buûtö_°rcmp
 (
s1
, 
s2
) \

816 : 
	`__°rcmp_gc
 (
s1
, 
s2
, 
__s2_Àn
)) \

817 : 
	`__buûtö_°rcmp
 (
s1
, 
s2
)))); })

	)

819 
	#°rcmp
(
s1
, 
s2
) \

820 
__exãnsi⁄__
 \

821 ({ 
size_t
 
__s1_Àn
, 
__s2_Àn
; \

822 (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& __buûtö_c⁄°™t_∞(
s2
) \

823 && (
__s1_Àn
 = 
	`°æí
 (
s1
), 
__s2_Àn
 = såÀ¿(
s2
), \

824 (!
	`__°rög2_1b±r_p
 (
s1
Ë|| 
__s1_Àn
 >= 4) \

825 && (!
	`__°rög2_1b±r_p
 (
s2
Ë|| 
__s2_Àn
 >= 4)) \

826 ? 
	`memcmp
 ((c⁄° *Ë(
s1
), (c⁄° *Ë(
s2
), \

827 (
__s1_Àn
 < 
__s2_Àn
 ? __s1_len : __s2_len) + 1) \

828 : (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& 
	`__°rög2_1b±r_p
 (s1) \

829 && (
__s1_Àn
 = 
	`°æí
 (
s1
), __s1_len < 4) \

830 ? (
	`__buûtö_c⁄°™t_p
 (
s2
Ë&& 
	`__°rög2_1b±r_p
 (s2) \

831 ? 
	`__°rcmp_cc
 (
s1
, 
s2
, 
__s1_Àn
) \

832 : 
	`__°rcmp_cg
 (
s1
, 
s2
, 
__s1_Àn
)) \

833 : (
	`__buûtö_c⁄°™t_p
 (
s2
Ë&& 
	`__°rög2_1b±r_p
 (s2) \

834 && (
__s2_Àn
 = 
	`°æí
 (
s2
), __s2_len < 4) \

835 ? (
	`__buûtö_c⁄°™t_p
 (
s1
Ë&& 
	`__°rög2_1b±r_p
 (s1) \

836 ? 
	`__°rcmp_cc
 (
s1
, 
s2
, 
__s2_Àn
) \

837 : 
	`__°rcmp_gc
 (
s1
, 
s2
, 
__s2_Àn
)) \

838 : 
	`°rcmp
 (
s1
, 
s2
)))); })

	)

841 
	#__°rcmp_cc
(
s1
, 
s2
, 
l
) \

842 (
	`__exãnsi⁄__
 ({ 
__ªsu…
 = \

843 (((c⁄° *Ë(c⁄° *Ë(
s1
))[0] \

844 - ((c⁄° *Ë(c⁄° *)(
s2
))[0]); \

845 i‡(
l
 > 0 && 
__ªsu…
 == 0) \

847 
__ªsu…
 = (((const *) \

848 (c⁄° *Ë(
s1
))[1] \

850 (c⁄° *Ë(
s2
))[1]); \

851 i‡(
l
 > 1 && 
__ªsu…
 == 0) \

853 
__ªsu…
 = \

855 (c⁄° *Ë(
s1
))[2] \

857 (c⁄° *Ë(
s2
))[2]); \

858 i‡(
l
 > 2 && 
__ªsu…
 == 0) \

859 
__ªsu…
 = \

861 (c⁄° *Ë(
s1
))[3] \

863 (c⁄° *Ë(
s2
))[3]); \

866 
__ªsu…
; }))

	)

868 
	#__°rcmp_cg
(
s1
, 
s2
, 
l1
) \

869 (
	`__exãnsi⁄__
 ({ c⁄° *
__s2
 = \

870 (c⁄° *Ë(c⁄° *Ë(
s2
); \

871 
__ªsu…
 = \

872 (((c⁄° *Ë(c⁄° *Ë(
s1
))[0] \

873 - 
__s2
[0]); \

874 i‡(
l1
 > 0 && 
__ªsu…
 == 0) \

876 
__ªsu…
 = (((const *) \

877 (c⁄° *Ë(
s1
))[1] - 
__s2
[1]); \

878 i‡(
l1
 > 1 && 
__ªsu…
 == 0) \

880 
__ªsu…
 = (((const *) \

881 (c⁄° *Ë(
s1
))[2] - 
__s2
[2]); \

882 i‡(
l1
 > 2 && 
__ªsu…
 == 0) \

883 
__ªsu…
 = (((const *) \

884 (c⁄° *Ë(
s1
))[3] \

885 - 
__s2
[3]); \

888 
__ªsu…
; }))

	)

890 
	#__°rcmp_gc
(
s1
, 
s2
, 
l2
) \

891 (
	`__exãnsi⁄__
 ({ c⁄° *
__s1
 = \

892 (c⁄° *Ë(c⁄° *Ë(
s1
); \

893 
__ªsu…
 = \

894 
__s1
[0] - ((const *) \

895 (c⁄° *Ë(
s2
))[0]; \

896 i‡(
l2
 > 0 && 
__ªsu…
 == 0) \

898 
__ªsu…
 = (
__s1
[1] \

900 (c⁄° *Ë(
s2
))[1]); \

901 i‡(
l2
 > 1 && 
__ªsu…
 == 0) \

903 
__ªsu…
 = \

904 (
__s1
[2] - ((const *) \

905 (c⁄° *Ë(
s2
))[2]); \

906 i‡(
l2
 > 2 && 
__ªsu…
 == 0) \

907 
__ªsu…
 = \

908 (
__s1
[3] \

910 (c⁄° *Ë(
s2
))[3]); \

913 
__ªsu…
; }))

	)

918 #i‚de‡
_HAVE_STRING_ARCH_°∫cmp


919 
	#°∫cmp
(
s1
, 
s2
, 
n
) \

920 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
n
) \

921 && ((
	`__buûtö_c⁄°™t_p
 (
s1
) \

922 && 
	`°æí
 (
s1
Ë< ((
size_t
Ë(
n
))) \

923 || (
	`__buûtö_c⁄°™t_p
 (
s2
) \

924 && 
	`°æí
 (
s2
Ë< ((
size_t
Ë(
n
)))) \

925 ? 
	`°rcmp
 (
s1
, 
s2
Ë: 
	`°∫cmp
 (s1, s2, 
n
)))

	)

931 #i‡!
deföed
 
_HAVE_STRING_ARCH_°rc•n
 || deföed 
_FORCE_INLINES


932 #i‚de‡
_HAVE_STRING_ARCH_°rc•n


933 #i‡
__GNUC_PREREQ
 (3, 2)

934 
	#°rc•n
(
s
, 
ªje˘
) \

935 
__exãnsi⁄__
 \

936 ({ 
__r0
, 
__r1
, 
__r2
; \

937 (
	`__buûtö_c⁄°™t_p
 (
ªje˘
Ë&& 
	`__°rög2_1b±r_p
 (reject) \

938 ? ((
	`__buûtö_c⁄°™t_p
 (
s
Ë&& 
	`__°rög2_1b±r_p
 (s)) \

939 ? 
	`__buûtö_°rc•n
 (
s
, 
ªje˘
) \

940 : ((
__r0
 = ((c⁄° *Ë(
ªje˘
))[0], __r0 == '\0') \

941 ? 
	`°æí
 (
s
) \

942 : ((
__r1
 = ((c⁄° *Ë(
ªje˘
))[1], __r1 == '\0') \

943 ? 
	`__°rc•n_c1
 (
s
, 
__r0
) \

944 : ((
__r2
 = ((c⁄° *Ë(
ªje˘
))[2], __r2 == '\0') \

945 ? 
	`__°rc•n_c2
 (
s
, 
__r0
, 
__r1
) \

946 : (((c⁄° *Ë(
ªje˘
))[3] == '\0' \

947 ? 
	`__°rc•n_c3
 (
s
, 
__r0
, 
__r1
, 
__r2
) \

948 : 
	`__buûtö_°rc•n
 (
s
, 
ªje˘
)))))) \

949 : 
	`__buûtö_°rc•n
 (
s
, 
ªje˘
)); })

	)

951 
	#°rc•n
(
s
, 
ªje˘
) \

952 
__exãnsi⁄__
 \

953 ({ 
__r0
, 
__r1
, 
__r2
; \

954 (
	`__buûtö_c⁄°™t_p
 (
ªje˘
Ë&& 
	`__°rög2_1b±r_p
 (reject) \

955 ? ((
__r0
 = ((c⁄° *Ë(
ªje˘
))[0], __r0 == '\0') \

956 ? 
	`°æí
 (
s
) \

957 : ((
__r1
 = ((c⁄° *Ë(
ªje˘
))[1], __r1 == '\0') \

958 ? 
	`__°rc•n_c1
 (
s
, 
__r0
) \

959 : ((
__r2
 = ((c⁄° *Ë(
ªje˘
))[2], __r2 == '\0') \

960 ? 
	`__°rc•n_c2
 (
s
, 
__r0
, 
__r1
) \

961 : (((c⁄° *Ë(
ªje˘
))[3] == '\0' \

962 ? 
	`__°rc•n_c3
 (
s
, 
__r0
, 
__r1
, 
__r2
) \

963 : 
	`°rc•n
 (
s
, 
ªje˘
))))) \

964 : 
	`°rc•n
 (
s
, 
ªje˘
)); })

	)

968 
__STRING_INLINE
 
size_t
 
__°rc•n_c1
 (c⁄° *
__s
, 
__ªje˘
);

969 
__STRING_INLINE
 
size_t


970 
	$__°rc•n_c1
 (c⁄° *
__s
, 
__ªje˘
)

972 
size_t
 
__ªsu…
 = 0;

973 
__s
[
__ªsu…
] !'\0' && __s[__ªsu…] !
__ªje˘
)

974 ++
__ªsu…
;

975  
__ªsu…
;

976 
	}
}

978 
__STRING_INLINE
 
size_t
 
__°rc•n_c2
 (c⁄° *
__s
, 
__ªje˘1
,

979 
__ªje˘2
);

980 
__STRING_INLINE
 
size_t


981 
	$__°rc•n_c2
 (c⁄° *
__s
, 
__ªje˘1
, 
__ªje˘2
)

983 
size_t
 
__ªsu…
 = 0;

984 
__s
[
__ªsu…
] !'\0' && __s[__ªsu…] !
__ªje˘1


985 && 
__s
[
__ªsu…
] !
__ªje˘2
)

986 ++
__ªsu…
;

987  
__ªsu…
;

988 
	}
}

990 
__STRING_INLINE
 
size_t
 
__°rc•n_c3
 (c⁄° *
__s
, 
__ªje˘1
,

991 
__ªje˘2
, 
__ªje˘3
);

992 
__STRING_INLINE
 
size_t


993 
	$__°rc•n_c3
 (c⁄° *
__s
, 
__ªje˘1
, 
__ªje˘2
,

994 
__ªje˘3
)

996 
size_t
 
__ªsu…
 = 0;

997 
__s
[
__ªsu…
] !'\0' && __s[__ªsu…] !
__ªje˘1


998 && 
__s
[
__ªsu…
] !
__ªje˘2
 && __s[__ªsu…] !
__ªje˘3
)

999 ++
__ªsu…
;

1000  
__ªsu…
;

1001 
	}
}

1007 #i‡!
deföed
 
_HAVE_STRING_ARCH_°r•n
 || deföed 
_FORCE_INLINES


1008 #i‚de‡
_HAVE_STRING_ARCH_°r•n


1009 #i‡
__GNUC_PREREQ
 (3, 2)

1010 
	#°r•n
(
s
, 
ac˚±
) \

1011 
__exãnsi⁄__
 \

1012 ({ 
__a0
, 
__a1
, 
__a2
; \

1013 (
	`__buûtö_c⁄°™t_p
 (
ac˚±
Ë&& 
	`__°rög2_1b±r_p
 (accept) \

1014 ? ((
	`__buûtö_c⁄°™t_p
 (
s
Ë&& 
	`__°rög2_1b±r_p
 (s)) \

1015 ? 
	`__buûtö_°r•n
 (
s
, 
ac˚±
) \

1016 : ((
__a0
 = ((c⁄° *Ë(
ac˚±
))[0], __a0 == '\0') \

1017 ? ((Ë(
s
), (
size_t
) 0) \

1018 : ((
__a1
 = ((c⁄° *Ë(
ac˚±
))[1], __a1 == '\0') \

1019 ? 
	`__°r•n_c1
 (
s
, 
__a0
) \

1020 : ((
__a2
 = ((c⁄° *Ë(
ac˚±
))[2], __a2 == '\0') \

1021 ? 
	`__°r•n_c2
 (
s
, 
__a0
, 
__a1
) \

1022 : (((c⁄° *Ë(
ac˚±
))[3] == '\0' \

1023 ? 
	`__°r•n_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1024 : 
	`__buûtö_°r•n
 (
s
, 
ac˚±
)))))) \

1025 : 
	`__buûtö_°r•n
 (
s
, 
ac˚±
)); })

	)

1027 
	#°r•n
(
s
, 
ac˚±
) \

1028 
__exãnsi⁄__
 \

1029 ({ 
__a0
, 
__a1
, 
__a2
; \

1030 (
	`__buûtö_c⁄°™t_p
 (
ac˚±
Ë&& 
	`__°rög2_1b±r_p
 (accept) \

1031 ? ((
__a0
 = ((c⁄° *Ë(
ac˚±
))[0], __a0 == '\0') \

1032 ? ((Ë(
s
), (
size_t
) 0) \

1033 : ((
__a1
 = ((c⁄° *Ë(
ac˚±
))[1], __a1 == '\0') \

1034 ? 
	`__°r•n_c1
 (
s
, 
__a0
) \

1035 : ((
__a2
 = ((c⁄° *Ë(
ac˚±
))[2], __a2 == '\0') \

1036 ? 
	`__°r•n_c2
 (
s
, 
__a0
, 
__a1
) \

1037 : (((c⁄° *Ë(
ac˚±
))[3] == '\0' \

1038 ? 
	`__°r•n_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1039 : 
	`°r•n
 (
s
, 
ac˚±
))))) \

1040 : 
	`°r•n
 (
s
, 
ac˚±
)); })

	)

1044 
__STRING_INLINE
 
size_t
 
__°r•n_c1
 (c⁄° *
__s
, 
__ac˚±
);

1045 
__STRING_INLINE
 
size_t


1046 
	$__°r•n_c1
 (c⁄° *
__s
, 
__ac˚±
)

1048 
size_t
 
__ªsu…
 = 0;

1050 
__s
[
__ªsu…
] =
__ac˚±
)

1051 ++
__ªsu…
;

1052  
__ªsu…
;

1053 
	}
}

1055 
__STRING_INLINE
 
size_t
 
__°r•n_c2
 (c⁄° *
__s
, 
__ac˚±1
,

1056 
__ac˚±2
);

1057 
__STRING_INLINE
 
size_t


1058 
	$__°r•n_c2
 (c⁄° *
__s
, 
__ac˚±1
, 
__ac˚±2
)

1060 
size_t
 
__ªsu…
 = 0;

1062 
__s
[
__ªsu…
] =
__ac˚±1
 || __s[__ªsu…] =
__ac˚±2
)

1063 ++
__ªsu…
;

1064  
__ªsu…
;

1065 
	}
}

1067 
__STRING_INLINE
 
size_t
 
__°r•n_c3
 (c⁄° *
__s
, 
__ac˚±1
,

1068 
__ac˚±2
, 
__ac˚±3
);

1069 
__STRING_INLINE
 
size_t


1070 
	$__°r•n_c3
 (c⁄° *
__s
, 
__ac˚±1
, 
__ac˚±2
, 
__ac˚±3
)

1072 
size_t
 
__ªsu…
 = 0;

1074 
__s
[
__ªsu…
] =
__ac˚±1
 || __s[__ªsu…] =
__ac˚±2


1075 || 
__s
[
__ªsu…
] =
__ac˚±3
)

1076 ++
__ªsu…
;

1077  
__ªsu…
;

1078 
	}
}

1083 #i‡!
deföed
 
_HAVE_STRING_ARCH_°Ωbrk
 || deföed 
_FORCE_INLINES


1084 #i‚de‡
_HAVE_STRING_ARCH_°Ωbrk


1085 #i‡
__GNUC_PREREQ
 (3, 2)

1086 
	#°Ωbrk
(
s
, 
ac˚±
) \

1087 
__exãnsi⁄__
 \

1088 ({ 
__a0
, 
__a1
, 
__a2
; \

1089 (
	`__buûtö_c⁄°™t_p
 (
ac˚±
Ë&& 
	`__°rög2_1b±r_p
 (accept) \

1090 ? ((
	`__buûtö_c⁄°™t_p
 (
s
Ë&& 
	`__°rög2_1b±r_p
 (s)) \

1091 ? 
	`__buûtö_°Ωbrk
 (
s
, 
ac˚±
) \

1092 : ((
__a0
 = ((c⁄° *Ë(
ac˚±
))[0], __a0 == '\0') \

1093 ? ((Ë(
s
), (*Ë
NULL
) \

1094 : ((
__a1
 = ((c⁄° *Ë(
ac˚±
))[1], __a1 == '\0') \

1095 ? 
	`__buûtö_°rchr
 (
s
, 
__a0
) \

1096 : ((
__a2
 = ((c⁄° *Ë(
ac˚±
))[2], __a2 == '\0') \

1097 ? 
	`__°Ωbrk_c2
 (
s
, 
__a0
, 
__a1
) \

1098 : (((c⁄° *Ë(
ac˚±
))[3] == '\0' \

1099 ? 
	`__°Ωbrk_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1100 : 
	`__buûtö_°Ωbrk
 (
s
, 
ac˚±
)))))) \

1101 : 
	`__buûtö_°Ωbrk
 (
s
, 
ac˚±
)); })

	)

1103 
	#°Ωbrk
(
s
, 
ac˚±
) \

1104 
__exãnsi⁄__
 \

1105 ({ 
__a0
, 
__a1
, 
__a2
; \

1106 (
	`__buûtö_c⁄°™t_p
 (
ac˚±
Ë&& 
	`__°rög2_1b±r_p
 (accept) \

1107 ? ((
__a0
 = ((c⁄° *Ë(
ac˚±
))[0], __a0 == '\0') \

1108 ? ((Ë(
s
), (*Ë
NULL
) \

1109 : ((
__a1
 = ((c⁄° *Ë(
ac˚±
))[1], __a1 == '\0') \

1110 ? 
	`°rchr
 (
s
, 
__a0
) \

1111 : ((
__a2
 = ((c⁄° *Ë(
ac˚±
))[2], __a2 == '\0') \

1112 ? 
	`__°Ωbrk_c2
 (
s
, 
__a0
, 
__a1
) \

1113 : (((c⁄° *Ë(
ac˚±
))[3] == '\0' \

1114 ? 
	`__°Ωbrk_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1115 : 
	`°Ωbrk
 (
s
, 
ac˚±
))))) \

1116 : 
	`°Ωbrk
 (
s
, 
ac˚±
)); })

	)

1120 
__STRING_INLINE
 *
__°Ωbrk_c2
 (c⁄° *
__s
, 
__ac˚±1
,

1121 
__ac˚±2
);

1122 
__STRING_INLINE
 *

1123 
	$__°Ωbrk_c2
 (c⁄° *
__s
, 
__ac˚±1
, 
__ac˚±2
)

1126 *
__s
 !'\0' && *__†!
__ac˚±1
 && *__†!
__ac˚±2
)

1127 ++
__s
;

1128  *
__s
 ='\0' ? 
NULL
 : (*Ë(
size_t
) __s;

1129 
	}
}

1131 
__STRING_INLINE
 *
__°Ωbrk_c3
 (c⁄° *
__s
, 
__ac˚±1
,

1132 
__ac˚±2
, 
__ac˚±3
);

1133 
__STRING_INLINE
 *

1134 
	$__°Ωbrk_c3
 (c⁄° *
__s
, 
__ac˚±1
, 
__ac˚±2
, 
__ac˚±3
)

1137 *
__s
 !'\0' && *__†!
__ac˚±1
 && *__†!
__ac˚±2


1138 && *
__s
 !
__ac˚±3
)

1139 ++
__s
;

1140  *
__s
 ='\0' ? 
NULL
 : (*Ë(
size_t
) __s;

1141 
	}
}

1147 #i‡!
deföed
 
_HAVE_STRING_ARCH_°r°r
 && !
__GNUC_PREREQ
 (2, 97)

1148 
	#°r°r
(
hay°ack
, 
√edÀ
) \

1149 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
√edÀ
Ë&& 
	`__°rög2_1b±r_p
 (needle) \

1150 ? (((c⁄° *Ë(
√edÀ
))[0] == '\0' \

1151 ? (*Ë(
size_t
Ë(
hay°ack
) \

1152 : (((c⁄° *Ë(
√edÀ
))[1] == '\0' \

1153 ? 
	`°rchr
 (
hay°ack
, \

1154 ((c⁄° *Ë(
√edÀ
))[0]) \

1155 : 
	`°r°r
 (
hay°ack
, 
√edÀ
))) \

1156 : 
	`°r°r
 (
hay°ack
, 
√edÀ
)))

	)

1160 #i‡!
deföed
 
_HAVE_STRING_ARCH_°πok_r
 || deföed 
_FORCE_INLINES


1161 #i‚de‡
_HAVE_STRING_ARCH_°πok_r


1162 
	#__°πok_r
(
s
, 
£p
, 
√xç
) \

1163 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
£p
Ë&& 
	`__°rög2_1b±r_p
 (sep) \

1164 && ((c⁄° *Ë(
£p
))[0] != '\0' \

1165 && ((c⁄° *Ë(
£p
))[1] == '\0' \

1166 ? 
	`__°πok_r_1c
 (
s
, ((c⁄° *Ë(
£p
))[0], 
√xç
) \

1167 : 
	`__°πok_r
 (
s
, 
£p
, 
√xç
)))

	)

1170 
__STRING_INLINE
 *
__°πok_r_1c
 (*
__s
, 
__£p
, **
__√xç
);

1171 
__STRING_INLINE
 *

1172 
	$__°πok_r_1c
 (*
__s
, 
__£p
, **
__√xç
)

1174 *
__ªsu…
;

1175 i‡(
__s
 =
NULL
)

1176 
__s
 = *
__√xç
;

1177 *
__s
 =
__£p
)

1178 ++
__s
;

1179 
__ªsu…
 = 
NULL
;

1180 i‡(*
__s
 != '\0')

1182 
__ªsu…
 = 
__s
++;

1183 *
__s
 != '\0')

1184 i‡(*
__s
++ =
__£p
)

1186 
__s
[-1] = '\0';

1190 *
__√xç
 = 
__s
;

1191  
__ªsu…
;

1192 
	}
}

1193 #i‡
deföed
 
__USE_POSIX
 || deföed 
__USE_MISC


1194 
	#°πok_r
(
s
, 
£p
, 
√xç
Ë
	`__°πok_r
 (s, sï,Çexç)

	)

1199 #i‡!
deföed
 
_HAVE_STRING_ARCH_°r£p
 || deföed 
_FORCE_INLINES


1200 #i‚de‡
_HAVE_STRING_ARCH_°r£p


1202 *
__°r£p_g
 (**
__°rögp
, c⁄° *
__dñim
);

1203 
	#__°r£p
(
s
, 
ªje˘
) \

1204 
__exãnsi⁄__
 \

1205 ({ 
__r0
, 
__r1
, 
__r2
; \

1206 (
	`__buûtö_c⁄°™t_p
 (
ªje˘
Ë&& 
	`__°rög2_1b±r_p
 (reject) \

1207 && (
__r0
 = ((c⁄° *Ë(
ªje˘
))[0], \

1208 ((c⁄° *Ë(
ªje˘
))[0] != '\0') \

1209 ? ((
__r1
 = ((c⁄° *Ë(
ªje˘
))[1], \

1210 ((c⁄° *Ë(
ªje˘
))[1] == '\0') \

1211 ? 
	`__°r£p_1c
 (
s
, 
__r0
) \

1212 : ((
__r2
 = ((c⁄° *Ë(
ªje˘
))[2], __r2 == '\0') \

1213 ? 
	`__°r£p_2c
 (
s
, 
__r0
, 
__r1
) \

1214 : (((c⁄° *Ë(
ªje˘
))[3] == '\0' \

1215 ? 
	`__°r£p_3c
 (
s
, 
__r0
, 
__r1
, 
__r2
) \

1216 : 
	`__°r£p_g
 (
s
, 
ªje˘
)))) \

1217 : 
	`__°r£p_g
 (
s
, 
ªje˘
)); })

	)

1220 
__STRING_INLINE
 *
__°r£p_1c
 (**
__s
, 
__ªje˘
);

1221 
__STRING_INLINE
 *

1222 
	$__°r£p_1c
 (**
__s
, 
__ªje˘
)

1224 *
__ªtvÆ
 = *
__s
;

1225 i‡(
__ªtvÆ
 !
NULL
 && (*
__s
 = 
	`°rchr
 (__ªtvÆ, 
__ªje˘
)) != NULL)

1226 *(*
__s
)++ = '\0';

1227  
__ªtvÆ
;

1228 
	}
}

1230 
__STRING_INLINE
 *
__°r£p_2c
 (**
__s
, 
__ªje˘1
, 
__ªje˘2
);

1231 
__STRING_INLINE
 *

1232 
	$__°r£p_2c
 (**
__s
, 
__ªje˘1
, 
__ªje˘2
)

1234 *
__ªtvÆ
 = *
__s
;

1235 i‡(
__ªtvÆ
 !
NULL
)

1237 *
__˝
 = 
__ªtvÆ
;

1240 i‡(*
__˝
 == '\0')

1242 
__˝
 = 
NULL
;

1245 i‡(*
__˝
 =
__ªje˘1
 || *__˝ =
__ªje˘2
)

1247 *
__˝
++ = '\0';

1250 ++
__˝
;

1252 *
__s
 = 
__˝
;

1254  
__ªtvÆ
;

1255 
	}
}

1257 
__STRING_INLINE
 *
__°r£p_3c
 (**
__s
, 
__ªje˘1
, 
__ªje˘2
,

1258 
__ªje˘3
);

1259 
__STRING_INLINE
 *

1260 
	$__°r£p_3c
 (**
__s
, 
__ªje˘1
, 
__ªje˘2
, 
__ªje˘3
)

1262 *
__ªtvÆ
 = *
__s
;

1263 i‡(
__ªtvÆ
 !
NULL
)

1265 *
__˝
 = 
__ªtvÆ
;

1268 i‡(*
__˝
 == '\0')

1270 
__˝
 = 
NULL
;

1273 i‡(*
__˝
 =
__ªje˘1
 || *__˝ =
__ªje˘2
 || *__˝ =
__ªje˘3
)

1275 *
__˝
++ = '\0';

1278 ++
__˝
;

1280 *
__s
 = 
__˝
;

1282  
__ªtvÆ
;

1283 
	}
}

1284 #ifde‡
__USE_BSD


1285 
	#°r£p
(
s
, 
ªje˘
Ë
	`__°r£p
 (s,Ñeje˘)

	)

1292 #ifde‡
__USE_MISC


1294 #i‡!
deföed
 
_HAVE_STRING_ARCH_°rdup
 || !deföed 
_HAVE_STRING_ARCH_°∫dup


1295 
	#__√ed_mÆloc_™d_ˇŒoc


	)

1296 
	~<°dlib.h
>

1299 #i‚de‡
_HAVE_STRING_ARCH_°rdup


1301 *
	$__°rdup
 (c⁄° *
__°rög
Ë
__THROW
 
__©åibuã_mÆloc__
;

1302 
	#__°rdup
(
s
) \

1303 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
s
Ë&& 
	`__°rög2_1b±r_p
 (s) \

1304 ? (((c⁄° *Ë(
s
))[0] == '\0' \

1305 ? (*Ë
	`ˇŒoc
 ((
size_t
) 1, (size_t) 1) \

1306 : ({ 
size_t
 
__Àn
 = 
	`°æí
 (
s
) + 1; \

1307 *
__ªtvÆ
 = (*Ë
	`mÆloc
 (
__Àn
); \

1308 i‡(
__ªtvÆ
 !
NULL
) \

1309 
__ªtvÆ
 = (*Ë
	`mem˝y
 (__ªtvÆ, 
s
, 
__Àn
); \

1310 
__ªtvÆ
; 
	}
})) \

1311 : 
	`__°rdup
 (
s
)))

	)

1313 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_BSD
 || deföed 
__USE_XOPEN_EXTENDED


1314 
	#°rdup
(
s
Ë
	`__°rdup
 (s)

	)

1318 #i‚de‡
_HAVE_STRING_ARCH_°∫dup


1320 *
	$__°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

1321 
__THROW
 
__©åibuã_mÆloc__
;

1322 
	#__°∫dup
(
s
, 
n
) \

1323 (
	`__exãnsi⁄__
 (
	`__buûtö_c⁄°™t_p
 (
s
Ë&& 
	`__°rög2_1b±r_p
 (s) \

1324 ? (((c⁄° *Ë(
s
))[0] == '\0' \

1325 ? (*Ë
	`ˇŒoc
 ((
size_t
) 1, (size_t) 1) \

1326 : ({ 
size_t
 
__Àn
 = 
	`°æí
 (
s
) + 1; \

1327 
size_t
 
__n
 = (
n
); \

1328 *
__ªtvÆ
; \

1329 i‡(
__n
 < 
__Àn
) \

1330 
__Àn
 = 
__n
 + 1; \

1331 
__ªtvÆ
 = (*Ë
	`mÆloc
 (
__Àn
); \

1332 i‡(
__ªtvÆ
 !
NULL
) \

1334 
__ªtvÆ
[
__Àn
 - 1] = '\0'; \

1335 
__ªtvÆ
 = (*Ë
	`mem˝y
 (__ªtvÆ, 
s
, \

1336 
__Àn
 - 1); \

1338 
__ªtvÆ
; 
	}
})) \

1339 : 
	`__°∫dup
 (
s
, 
n
)))

	)

1341 #ifde‡
__USE_GNU


1342 
	#°∫dup
(
s
, 
n
Ë
	`__°∫dup
 (s,Ç)

	)

1348 #i‚de‡
_FORCE_INLINES


1349 #unde‡
__STRING_INLINE


	@/usr/include/bits/string3.h

18 #i‚de‡
_STRING_H


22 
__w¨nde˛
 (
__w¨n_mem£t_zîo_Àn
,

25 #i‚de‡
__˝lu•lus


29 #unde‡
mem˝y


30 #unde‡
memmove


31 #unde‡
mem£t


32 #unde‡
°rˇt


33 #unde‡
°r˝y


34 #unde‡
°∫ˇt


35 #unde‡
°∫˝y


36 #ifde‡
__USE_GNU


37 #unde‡
memp˝y


38 #unde‡
°p˝y


40 #ifde‡
__USE_BSD


41 #unde‡
bc›y


42 #unde‡
bzîo


47 
__f‹tify_fun˘i⁄
 *

48 
__NTH
 (
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

49 
size_t
 
__Àn
))

51  
	`__buûtö___mem˝y_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos0
 (__dest));

52 
	}
}

54 
__f‹tify_fun˘i⁄
 *

55 
__NTH
 (
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__Àn
))

57  
	`__buûtö___memmove_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos0
 (__dest));

58 
	}
}

60 #ifde‡
__USE_GNU


61 
__f‹tify_fun˘i⁄
 *

62 
__NTH
 (
	$memp˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

63 
size_t
 
__Àn
))

65  
	`__buûtö___memp˝y_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos0
 (__dest));

66 
	}
}

75 
__f‹tify_fun˘i⁄
 *

76 
__NTH
 (
	$mem£t
 (*
__de°
, 
__ch
, 
size_t
 
__Àn
))

78 i‡(
	`__buûtö_c⁄°™t_p
 (
__Àn
) && __len == 0

79 && (!
	`__buûtö_c⁄°™t_p
 (
__ch
) || __ch != 0))

81 
	`__w¨n_mem£t_zîo_Àn
 ();

82  
__de°
;

84  
	`__buûtö___mem£t_chk
 (
__de°
, 
__ch
, 
__Àn
, 
	`__bos0
 (__dest));

85 
	}
}

87 #ifde‡
__USE_BSD


88 
__f‹tify_fun˘i⁄
 

89 
__NTH
 (
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__Àn
))

91 (Ë
	`__buûtö___memmove_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos0
 (__dest));

92 
	}
}

94 
__f‹tify_fun˘i⁄
 

95 
__NTH
 (
	$bzîo
 (*
__de°
, 
size_t
 
__Àn
))

97 (Ë
	`__buûtö___mem£t_chk
 (
__de°
, '\0', 
__Àn
, 
	`__bos0
 (__dest));

98 
	}
}

101 
__f‹tify_fun˘i⁄
 *

102 
__NTH
 (
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
))

104  
	`__buûtö___°r˝y_chk
 (
__de°
, 
__§c
, 
	`__bos
 (__dest));

105 
	}
}

107 #ifde‡
__USE_GNU


108 
__f‹tify_fun˘i⁄
 *

109 
__NTH
 (
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
))

111  
	`__buûtö___°p˝y_chk
 (
__de°
, 
__§c
, 
	`__bos
 (__dest));

112 
	}
}

116 
__f‹tify_fun˘i⁄
 *

117 
__NTH
 (
	$°∫˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

118 
size_t
 
__Àn
))

120  
	`__buûtö___°∫˝y_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos
 (__dest));

121 
	}
}

124 *
	$__°≤˝y_chk
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

125 
size_t
 
__de°Àn
Ë
__THROW
;

126 *
	`__REDIRECT_NTH
 (
__°≤˝y_Æüs
, (*
__de°
, c⁄° *
__§c
,

127 
size_t
 
__n
), 
°≤˝y
);

129 
__f‹tify_fun˘i⁄
 *

130 
	`__NTH
 (
	$°≤˝y
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
))

132 i‡(
	`__bos
 (
__de°
Ë!(
size_t
) -1

133 && (!
	`__buûtö_c⁄°™t_p
 (
__n
Ë|| __¿<
	`__bos
 (
__de°
)))

134  
	`__°≤˝y_chk
 (
__de°
, 
__§c
, 
__n
, 
	`__bos
 (__dest));

135  
	`__°≤˝y_Æüs
 (
__de°
, 
__§c
, 
__n
);

136 
	}
}

139 
__f‹tify_fun˘i⁄
 *

140 
__NTH
 (
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
))

142  
	`__buûtö___°rˇt_chk
 (
__de°
, 
__§c
, 
	`__bos
 (__dest));

143 
	}
}

146 
__f‹tify_fun˘i⁄
 *

147 
__NTH
 (
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

148 
size_t
 
__Àn
))

150  
	`__buûtö___°∫ˇt_chk
 (
__de°
, 
__§c
, 
__Àn
, 
	`__bos
 (__dest));

151 
	}
}

	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

98 #unde‡
__USE_ISOC11


99 #unde‡
__USE_ISOC99


100 #unde‡
__USE_ISOC95


101 #unde‡
__USE_ISOCXX11


102 #unde‡
__USE_POSIX


103 #unde‡
__USE_POSIX2


104 #unde‡
__USE_POSIX199309


105 #unde‡
__USE_POSIX199506


106 #unde‡
__USE_XOPEN


107 #unde‡
__USE_XOPEN_EXTENDED


108 #unde‡
__USE_UNIX98


109 #unde‡
__USE_XOPEN2K


110 #unde‡
__USE_XOPEN2KXSI


111 #unde‡
__USE_XOPEN2K8


112 #unde‡
__USE_XOPEN2K8XSI


113 #unde‡
__USE_LARGEFILE


114 #unde‡
__USE_LARGEFILE64


115 #unde‡
__USE_FILE_OFFSET64


116 #unde‡
__USE_BSD


117 #unde‡
__USE_SVID


118 #unde‡
__USE_MISC


119 #unde‡
__USE_ATFILE


120 #unde‡
__USE_GNU


121 #unde‡
__USE_REENTRANT


122 #unde‡
__USE_FORTIFY_LEVEL


123 #unde‡
__FAVOR_BSD


124 #unde‡
__KERNEL_STRICT_NAMES


128 #i‚de‡
_LOOSE_KERNEL_NAMES


129 
	#__KERNEL_STRICT_NAMES


	)

133 
	#__USE_ANSI
 1

	)

142 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


143 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

144 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

146 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

151 #i‡
deföed
 
_BSD_SOURCE
 && \

152 !(
deföed
 
	g_POSIX_SOURCE
 || deföed 
	g_POSIX_C_SOURCE
 || \

153 
deföed
 
	g_XOPEN_SOURCE
 || deföed 
	g_GNU_SOURCE
 || deföed 
	g_SVID_SOURCE
)

154 
	#__FAVOR_BSD
 1

	)

158 #ifde‡
_GNU_SOURCE


159 #unde‡
_ISOC95_SOURCE


160 
	#_ISOC95_SOURCE
 1

	)

161 #unde‡
_ISOC99_SOURCE


162 
	#_ISOC99_SOURCE
 1

	)

163 #unde‡
_ISOC11_SOURCE


164 
	#_ISOC11_SOURCE
 1

	)

165 #unde‡
_POSIX_SOURCE


166 
	#_POSIX_SOURCE
 1

	)

167 #unde‡
_POSIX_C_SOURCE


168 
	#_POSIX_C_SOURCE
 200809L

	)

169 #unde‡
_XOPEN_SOURCE


170 
	#_XOPEN_SOURCE
 700

	)

171 #unde‡
_XOPEN_SOURCE_EXTENDED


172 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

173 #unde‡
_LARGEFILE64_SOURCE


174 
	#_LARGEFILE64_SOURCE
 1

	)

175 #unde‡
_BSD_SOURCE


176 
	#_BSD_SOURCE
 1

	)

177 #unde‡
_SVID_SOURCE


178 
	#_SVID_SOURCE
 1

	)

179 #unde‡
_ATFILE_SOURCE


180 
	#_ATFILE_SOURCE
 1

	)

185 #i‡(!
deföed
 
__STRICT_ANSI__
 && !deföed 
_ISOC99_SOURCE
 && \

186 !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 && \

187 !
deföed
 
	g_XOPEN_SOURCE
 && !deföed 
	g_BSD_SOURCE
 && !deföed 
	g_SVID_SOURCE
)

188 
	#_BSD_SOURCE
 1

	)

189 
	#_SVID_SOURCE
 1

	)

193 #i‡(
deföed
 
_ISOC11_SOURCE
 \

194 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

195 
	#__USE_ISOC11
 1

	)

199 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

200 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

201 
	#__USE_ISOC99
 1

	)

205 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

206 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

207 
	#__USE_ISOC95
 1

	)

214 #i‡((
deföed
 
__˝lu•lus
 && __cplusplus >= 201103L) \

215 || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__
)

216 
	#__USE_ISOCXX11
 1

	)

221 #i‡((!
deföed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

222 !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

223 
	#_POSIX_SOURCE
 1

	)

224 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

225 
	#_POSIX_C_SOURCE
 2

	)

226 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

227 
	#_POSIX_C_SOURCE
 199506L

	)

228 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

229 
	#_POSIX_C_SOURCE
 200112L

	)

231 
	#_POSIX_C_SOURCE
 200809L

	)

233 
	#__USE_POSIX_IMPLICITLY
 1

	)

236 #i‡
deföed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >1 || deföed 
_XOPEN_SOURCE


237 
	#__USE_POSIX
 1

	)

240 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


241 
	#__USE_POSIX2
 1

	)

244 #i‡(
_POSIX_C_SOURCE
 - 0) >= 199309L

245 
	#__USE_POSIX199309
 1

	)

248 #i‡(
_POSIX_C_SOURCE
 - 0) >= 199506L

249 
	#__USE_POSIX199506
 1

	)

252 #i‡(
_POSIX_C_SOURCE
 - 0) >= 200112L

253 
	#__USE_XOPEN2K
 1

	)

254 #unde‡
__USE_ISOC95


255 
	#__USE_ISOC95
 1

	)

256 #unde‡
__USE_ISOC99


257 
	#__USE_ISOC99
 1

	)

260 #i‡(
_POSIX_C_SOURCE
 - 0) >= 200809L

261 
	#__USE_XOPEN2K8
 1

	)

262 #unde‡
_ATFILE_SOURCE


263 
	#_ATFILE_SOURCE
 1

	)

266 #ifdef 
_XOPEN_SOURCE


267 
	#__USE_XOPEN
 1

	)

268 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

269 
	#__USE_XOPEN_EXTENDED
 1

	)

270 
	#__USE_UNIX98
 1

	)

271 #unde‡
_LARGEFILE_SOURCE


272 
	#_LARGEFILE_SOURCE
 1

	)

273 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

274 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

275 
	#__USE_XOPEN2K8
 1

	)

276 
	#__USE_XOPEN2K8XSI
 1

	)

278 
	#__USE_XOPEN2K
 1

	)

279 
	#__USE_XOPEN2KXSI
 1

	)

280 #unde‡
__USE_ISOC95


281 
	#__USE_ISOC95
 1

	)

282 #unde‡
__USE_ISOC99


283 
	#__USE_ISOC99
 1

	)

286 #ifde‡
_XOPEN_SOURCE_EXTENDED


287 
	#__USE_XOPEN_EXTENDED
 1

	)

292 #ifde‡
_LARGEFILE_SOURCE


293 
	#__USE_LARGEFILE
 1

	)

296 #ifde‡
_LARGEFILE64_SOURCE


297 
	#__USE_LARGEFILE64
 1

	)

300 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

301 
	#__USE_FILE_OFFSET64
 1

	)

304 #i‡
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE


305 
	#__USE_MISC
 1

	)

308 #ifdef 
_BSD_SOURCE


309 
	#__USE_BSD
 1

	)

312 #ifdef 
_SVID_SOURCE


313 
	#__USE_SVID
 1

	)

316 #ifdef 
_ATFILE_SOURCE


317 
	#__USE_ATFILE
 1

	)

320 #ifdef 
_GNU_SOURCE


321 
	#__USE_GNU
 1

	)

324 #i‡
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE


325 
	#__USE_REENTRANT
 1

	)

328 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0

329 #i‡!
deföed
 
__OPTIMIZE__
 || __OPTIMIZE__ <= 0

330 #w¨nög 
_FORTIFY_SOURCE
 
ªquúes
 
compûög
 
wôh
 
›timiz©i⁄
 (-
O
)

331 #ñi‡!
__GNUC_PREREQ
 (4, 1)

332 #w¨nög 
_FORTIFY_SOURCE
 
ªquúes
 
GCC
 4.1 
‹
 
œãr


333 #ñi‡
_FORTIFY_SOURCE
 > 1

334 
	#__USE_FORTIFY_LEVEL
 2

	)

336 
	#__USE_FORTIFY_LEVEL
 1

	)

339 #i‚de‡
__USE_FORTIFY_LEVEL


340 
	#__USE_FORTIFY_LEVEL
 0

	)

345 
	~<°dc-¥edef.h
>

353 #unde‡
__GNU_LIBRARY__


354 
	#__GNU_LIBRARY__
 6

	)

358 
	#__GLIBC__
 2

	)

359 
	#__GLIBC_MINOR__
 17

	)

361 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

362 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

365 #i‡
deföed
 
__GNUC__
 \

366 || (
deföed
 
	g__PGI
 && deföed 
	g__i386__
 ) \

367 || (
deföed
 
	g__INTEL_COMPILER
 && (deföed 
	g__i386__
 || deföed 
	g__ü64__
)) \

368 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L)

369 
	#__GLIBC_HAVE_LONG_LONG
 1

	)

373 #i‚de‡
__ASSEMBLER__


374 #i‚de‡
_SYS_CDEFS_H


375 
	~<sys/cdefs.h
>

380 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


381 
	#__USE_LARGEFILE
 1

	)

382 
	#__USE_LARGEFILE64
 1

	)

388 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

389 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

390 && 
deföed
 
	g__exã∫_ölöe


391 
	#__USE_EXTERN_INLINES
 1

	)

399 
	~<gnu/°ubs.h
>

	@/usr/include/linux/stddef.h

	@/usr/include/xlocale.h

20 #i‚de‡
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loˇÀ_°ru˘


30 
__loˇÀ_d©a
 *
	m__loˇÀs
[13];

33 c⁄° *
	m__˘y≥_b
;

34 c⁄° *
	m__˘y≥_tﬁowî
;

35 c⁄° *
	m__˘y≥_touµî
;

38 c⁄° *
	m__«mes
[13];

39 } *
	t__loˇÀ_t
;

42 
__loˇÀ_t
 
	tloˇÀ_t
;

	@/usr/include/asm-generic/int-ll64.h

8 #i‚de‡
_ASM_GENERIC_INT_LL64_H


9 
	#_ASM_GENERIC_INT_LL64_H


	)

11 
	~<asm/bô•îl⁄g.h
>

13 #i‚de‡
__ASSEMBLY__


19 
__sig√d__
 
	t__s8
;

20 
	t__u8
;

22 
__sig√d__
 
	t__s16
;

23 
	t__u16
;

25 
__sig√d__
 
	t__s32
;

26 
	t__u32
;

28 #ifde‡
__GNUC__


29 
__exãnsi⁄__
 
__sig√d__
 
	t__s64
;

30 
__exãnsi⁄__
 
	t__u64
;

32 
__sig√d__
 
	t__s64
;

33 
	t__u64
;

	@/usr/include/asm-generic/ioctl.h

1 #i‚de‡
_ASM_GENERIC_IOCTL_H


2 
	#_ASM_GENERIC_IOCTL_H


	)

22 
	#_IOC_NRBITS
 8

	)

23 
	#_IOC_TYPEBITS
 8

	)

30 #i‚de‡
_IOC_SIZEBITS


31 
	#_IOC_SIZEBITS
 14

	)

34 #i‚de‡
_IOC_DIRBITS


35 
	#_IOC_DIRBITS
 2

	)

38 
	#_IOC_NRMASK
 ((1 << 
_IOC_NRBITS
)-1)

	)

39 
	#_IOC_TYPEMASK
 ((1 << 
_IOC_TYPEBITS
)-1)

	)

40 
	#_IOC_SIZEMASK
 ((1 << 
_IOC_SIZEBITS
)-1)

	)

41 
	#_IOC_DIRMASK
 ((1 << 
_IOC_DIRBITS
)-1)

	)

43 
	#_IOC_NRSHIFT
 0

	)

44 
	#_IOC_TYPESHIFT
 (
_IOC_NRSHIFT
+
_IOC_NRBITS
)

	)

45 
	#_IOC_SIZESHIFT
 (
_IOC_TYPESHIFT
+
_IOC_TYPEBITS
)

	)

46 
	#_IOC_DIRSHIFT
 (
_IOC_SIZESHIFT
+
_IOC_SIZEBITS
)

	)

53 #i‚de‡
_IOC_NONE


54 
	#_IOC_NONE
 0U

	)

57 #i‚de‡
_IOC_WRITE


58 
	#_IOC_WRITE
 1U

	)

61 #i‚de‡
_IOC_READ


62 
	#_IOC_READ
 2U

	)

65 
	#_IOC
(
dú
,
ty≥
,
ƒ
,
size
) \

66 (((
dú
Ë<< 
_IOC_DIRSHIFT
) | \

67 ((
ty≥
Ë<< 
_IOC_TYPESHIFT
) | \

68 ((
ƒ
Ë<< 
_IOC_NRSHIFT
) | \

69 ((
size
Ë<< 
_IOC_SIZESHIFT
))

	)

71 
	#_IOC_TYPECHECK
(
t
Ë(—))

	)

74 
	#_IO
(
ty≥
,
ƒ
Ë
	`_IOC
(
_IOC_NONE
,—y≥),“r),0)

	)

75 
	#_IOR
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_READ
,—y≥),“r),(
	`_IOC_TYPECHECK
(size)))

	)

76 
	#_IOW
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_WRITE
,—y≥),“r),(
	`_IOC_TYPECHECK
(size)))

	)

77 
	#_IOWR
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,—y≥),“r),(
	`_IOC_TYPECHECK
(size)))

	)

78 
	#_IOR_BAD
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_READ
,—y≥),“r),(size))

	)

79 
	#_IOW_BAD
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_WRITE
,—y≥),“r),(size))

	)

80 
	#_IOWR_BAD
(
ty≥
,
ƒ
,
size
Ë
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,—y≥),“r),(size))

	)

83 
	#_IOC_DIR
(
ƒ
Ë((“rË>> 
_IOC_DIRSHIFT
Ë& 
_IOC_DIRMASK
)

	)

84 
	#_IOC_TYPE
(
ƒ
Ë((“rË>> 
_IOC_TYPESHIFT
Ë& 
_IOC_TYPEMASK
)

	)

85 
	#_IOC_NR
(
ƒ
Ë((“rË>> 
_IOC_NRSHIFT
Ë& 
_IOC_NRMASK
)

	)

86 
	#_IOC_SIZE
(
ƒ
Ë((“rË>> 
_IOC_SIZESHIFT
Ë& 
_IOC_SIZEMASK
)

	)

90 
	#IOC_IN
 (
_IOC_WRITE
 << 
_IOC_DIRSHIFT
)

	)

91 
	#IOC_OUT
 (
_IOC_READ
 << 
_IOC_DIRSHIFT
)

	)

92 
	#IOC_INOUT
 ((
_IOC_WRITE
|
_IOC_READ
Ë<< 
_IOC_DIRSHIFT
)

	)

93 
	#IOCSIZE_MASK
 (
_IOC_SIZEMASK
 << 
_IOC_SIZESHIFT
)

	)

94 
	#IOCSIZE_SHIFT
 (
_IOC_SIZESHIFT
)

	)

	@/usr/include/asm/posix_types_32.h

1 #i‚de‡
_ASM_X86_POSIX_TYPES_32_H


2 
	#_ASM_X86_POSIX_TYPES_32_H


	)

10 
	t__kî√l_mode_t
;

11 
	#__kî√l_mode_t
 
__kî√l_mode_t


	)

13 
	t__kî√l_ùc_pid_t
;

14 
	#__kî√l_ùc_pid_t
 
__kî√l_ùc_pid_t


	)

16 
	t__kî√l_uid_t
;

17 
	t__kî√l_gid_t
;

18 
	#__kî√l_uid_t
 
__kî√l_uid_t


	)

20 
	t__kî√l_ﬁd_dev_t
;

21 
	#__kî√l_ﬁd_dev_t
 
__kî√l_ﬁd_dev_t


	)

23 
	~<asm-gíîic/posix_ty≥s.h
>

	@/usr/include/asm/posix_types_64.h

1 #i‚de‡
_ASM_X86_POSIX_TYPES_64_H


2 
	#_ASM_X86_POSIX_TYPES_64_H


	)

10 
	t__kî√l_ﬁd_uid_t
;

11 
	t__kî√l_ﬁd_gid_t
;

12 
	#__kî√l_ﬁd_uid_t
 
__kî√l_ﬁd_uid_t


	)

14 
	t__kî√l_ﬁd_dev_t
;

15 
	#__kî√l_ﬁd_dev_t
 
__kî√l_ﬁd_dev_t


	)

17 
	~<asm-gíîic/posix_ty≥s.h
>

	@/usr/include/asm/posix_types_x32.h

1 #i‚de‡
_ASM_X86_POSIX_TYPES_X32_H


2 
	#_ASM_X86_POSIX_TYPES_X32_H


	)

13 
	t__kî√l_l⁄g_t
;

14 
	t__kî√l_ul⁄g_t
;

15 
	#__kî√l_l⁄g_t
 
__kî√l_l⁄g_t


	)

17 
	~<asm/posix_ty≥s_64.h
>

	@/usr/include/bits/types.h

23 #i‚def 
_BITS_TYPES_H


24 
	#_BITS_TYPES_H
 1

	)

26 
	~<„©uªs.h
>

27 
	~<bôs/w‹dsize.h
>

30 
	t__u_ch¨
;

31 
	t__u_sh‹t
;

32 
	t__u_öt
;

33 
	t__u_l⁄g
;

36 sig√d 
	t__öt8_t
;

37 
	t__uöt8_t
;

38 sig√d 
	t__öt16_t
;

39 
	t__uöt16_t
;

40 sig√d 
	t__öt32_t
;

41 
	t__uöt32_t
;

42 #i‡
__WORDSIZE
 == 64

43 sig√d 
	t__öt64_t
;

44 
	t__uöt64_t
;

45 #ñi‡
deföed
 
__GLIBC_HAVE_LONG_LONG


46 
__exãnsi⁄__
 sig√d 
	t__öt64_t
;

47 
__exãnsi⁄__
 
	t__uöt64_t
;

51 #i‡
__WORDSIZE
 == 64

52 
	t__quad_t
;

53 
	t__u_quad_t
;

54 #ñi‡
deföed
 
__GLIBC_HAVE_LONG_LONG


55 
__exãnsi⁄__
 
	t__quad_t
;

56 
__exãnsi⁄__
 
	t__u_quad_t
;

60 
	m__vÆ
[2];

61 } 
	t__quad_t
;

64 
__u_l⁄g
 
	m__vÆ
[2];

65 } 
	t__u_quad_t
;

98 
	#__S16_TYPE
 

	)

99 
	#__U16_TYPE
 

	)

100 
	#__S32_TYPE
 

	)

101 
	#__U32_TYPE
 

	)

102 
	#__SLONGWORD_TYPE
 

	)

103 
	#__ULONGWORD_TYPE
 

	)

104 #i‡
__WORDSIZE
 == 32

105 
	#__SQUAD_TYPE
 
__quad_t


	)

106 
	#__UQUAD_TYPE
 
__u_quad_t


	)

107 
	#__SWORD_TYPE
 

	)

108 
	#__UWORD_TYPE
 

	)

109 
	#__SLONG32_TYPE
 

	)

110 
	#__ULONG32_TYPE
 

	)

111 
	#__S64_TYPE
 
__quad_t


	)

112 
	#__U64_TYPE
 
__u_quad_t


	)

115 
	#__STD_TYPE
 
__exãnsi⁄__
 

	)

116 #ñi‡
__WORDSIZE
 == 64

117 
	t__SQUAD_TYPE
 

	)

118 
	t__UQUAD_TYPE
 

	)

119 
	t__SWORD_TYPE
 

	)

120 
	t__UWORD_TYPE
 

	)

121 
	t__SLONG32_TYPE
 

	)

122 
	t__ULONG32_TYPE
 

	)

123 
	t__S64_TYPE
 

	)

124 
	t__U64_TYPE
 

	)

126 
	t__STD_TYPE
 

	)

130 
	~<bôs/ty≥sizes.h
>

133 
__STD_TYPE
 
	t__DEV_T_TYPE
 
	t__dev_t
;

134 
__STD_TYPE
 
__UID_T_TYPE
 
	g__uid_t
;

135 
__STD_TYPE
 
__GID_T_TYPE
 
	g__gid_t
;

136 
__STD_TYPE
 
__INO_T_TYPE
 
	g__öo_t
;

137 
__STD_TYPE
 
__INO64_T_TYPE
 
	g__öo64_t
;

138 
__STD_TYPE
 
__MODE_T_TYPE
 
	g__mode_t
;

139 
__STD_TYPE
 
__NLINK_T_TYPE
 
	g__∆ök_t
;

140 
__STD_TYPE
 
__OFF_T_TYPE
 
	g__off_t
;

141 
__STD_TYPE
 
__OFF64_T_TYPE
 
	g__off64_t
;

142 
__STD_TYPE
 
__PID_T_TYPE
 
	g__pid_t
;

143 
__STD_TYPE
 
__FSID_T_TYPE
 
	g__fsid_t
;

144 
__STD_TYPE
 
__CLOCK_T_TYPE
 
	g__˛ock_t
;

145 
__STD_TYPE
 
__RLIM_T_TYPE
 
	g__æim_t
;

146 
__STD_TYPE
 
__RLIM64_T_TYPE
 
	g__æim64_t
;

147 
__STD_TYPE
 
__ID_T_TYPE
 
	g__id_t
;

148 
__STD_TYPE
 
__TIME_T_TYPE
 
	g__time_t
;

149 
__STD_TYPE
 
__USECONDS_T_TYPE
 
	g__u£c⁄ds_t
;

150 
__STD_TYPE
 
__SUSECONDS_T_TYPE
 
	g__su£c⁄ds_t
;

152 
__STD_TYPE
 
__DADDR_T_TYPE
 
	g__daddr_t
;

153 
__STD_TYPE
 
__KEY_T_TYPE
 
	g__key_t
;

156 
__STD_TYPE
 
__CLOCKID_T_TYPE
 
	g__˛ockid_t
;

159 
__STD_TYPE
 
__TIMER_T_TYPE
 
	g__timî_t
;

162 
__STD_TYPE
 
__BLKSIZE_T_TYPE
 
	g__blksize_t
;

167 
__STD_TYPE
 
__BLKCNT_T_TYPE
 
	g__blk˙t_t
;

168 
__STD_TYPE
 
__BLKCNT64_T_TYPE
 
	g__blk˙t64_t
;

171 
__STD_TYPE
 
__FSBLKCNT_T_TYPE
 
	g__fsblk˙t_t
;

172 
__STD_TYPE
 
__FSBLKCNT64_T_TYPE
 
	g__fsblk˙t64_t
;

175 
__STD_TYPE
 
__FSFILCNT_T_TYPE
 
	g__fsfû˙t_t
;

176 
__STD_TYPE
 
__FSFILCNT64_T_TYPE
 
	g__fsfû˙t64_t
;

179 
__STD_TYPE
 
__FSWORD_T_TYPE
 
	g__fsw‹d_t
;

181 
__STD_TYPE
 
__SSIZE_T_TYPE
 
	g__ssize_t
;

184 
__STD_TYPE
 
__SYSCALL_SLONG_TYPE
 
	g__sysˇŒ_¶⁄g_t
;

186 
__STD_TYPE
 
__SYSCALL_ULONG_TYPE
 
	g__sysˇŒ_ul⁄g_t
;

190 
__off64_t
 
	t__loff_t
;

191 
__quad_t
 *
	t__qaddr_t
;

192 *
	t__ˇddr_t
;

195 
__STD_TYPE
 
__SWORD_TYPE
 
	g__öçå_t
;

198 
__STD_TYPE
 
__U32_TYPE
 
	g__sockÀn_t
;

201 #unde‡
__STD_TYPE


	@/usr/include/endian.h

18 #i‚def 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<„©uªs.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<bôs/ídün.h
>

40 #i‚de‡
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_BSD


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
ËLO, 
	)
HI

53 #ñi‡
__BYTE_ORDER
 =
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
ËHI, 
	)
LO

58 #i‡
deföed
 
__USE_BSD
 && !deföed 
__ASSEMBLER__


60 
	~<bôs/byãsw≠.h
>

62 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


63 
	#htobe16
(
x
Ë
	`__bsw≠_16
 (x)

	)

64 
	#htﬁe16
(
x
Ë(x)

	)

65 
	#be16toh
(
x
Ë
	`__bsw≠_16
 (x)

	)

66 
	#À16toh
(
x
Ë(x)

	)

68 
	#htobe32
(
x
Ë
	`__bsw≠_32
 (x)

	)

69 
	#htﬁe32
(
x
Ë(x)

	)

70 
	#be32toh
(
x
Ë
	`__bsw≠_32
 (x)

	)

71 
	#À32toh
(
x
Ë(x)

	)

73 #i‡
__GLIBC_HAVE_LONG_LONG


74 
	#htobe64
(
x
Ë
	`__bsw≠_64
 (x)

	)

75 
	#htﬁe64
(
x
Ë(x)

	)

76 
	#be64toh
(
x
Ë
	`__bsw≠_64
 (x)

	)

77 
	#À64toh
(
x
Ë(x)

	)

81 
	#htobe16
(
x
Ë(x)

	)

82 
	#htﬁe16
(
x
Ë
	`__bsw≠_16
 (x)

	)

83 
	#be16toh
(
x
Ë(x)

	)

84 
	#À16toh
(
x
Ë
	`__bsw≠_16
 (x)

	)

86 
	#htobe32
(
x
Ë(x)

	)

87 
	#htﬁe32
(
x
Ë
	`__bsw≠_32
 (x)

	)

88 
	#be32toh
(
x
Ë(x)

	)

89 
	#À32toh
(
x
Ë
	`__bsw≠_32
 (x)

	)

91 #i‡
__GLIBC_HAVE_LONG_LONG


92 
	#htobe64
(
x
Ë(x)

	)

93 
	#htﬁe64
(
x
Ë
	`__bsw≠_64
 (x)

	)

94 
	#be64toh
(
x
Ë(x)

	)

95 
	#À64toh
(
x
Ë
	`__bsw≠_64
 (x)

	)

	@/usr/include/gnu/stubs.h

6 #i‡!
deföed
 
__x86_64__


7 
	~<gnu/°ubs-32.h
>

9 #i‡
deföed
 
__x86_64__
 && deföed 
__LP64__


10 
	~<gnu/°ubs-64.h
>

12 #i‡
deföed
 
__x86_64__
 && deföed 
__ILP32__


13 
	~<gnu/°ubs-x32.h
>

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

30 
	#__STDC_IEC_559__
 1

	)

31 
	#__STDC_IEC_559_COMPLEX__
 1

	)

35 
	#__STDC_ISO_10646__
 201103L

	)

38 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/stdlib.h

22 #i‚def 
_STDLIB_H


24 
	~<„©uªs.h
>

27 
	#__√ed_size_t


	)

28 #i‚de‡
__√ed_mÆloc_™d_ˇŒoc


29 
	#__√ed_wch¨_t


	)

30 
	#__√ed_NULL


	)

32 
	~<°ddef.h
>

34 
	g__BEGIN_DECLS


36 #i‚de‡
__√ed_mÆloc_™d_ˇŒoc


37 
	#_STDLIB_H
 1

	)

39 #i‡(
deföed
 
__USE_XOPEN
 || deföed 
__USE_XOPEN2K8
Ë&& !deföed 
_SYS_WAIT_H


41 
	~<bôs/waôÊags.h
>

42 
	~<bôs/waô°©us.h
>

44 #ifde‡
__USE_BSD


49 #i‡
deföed
 
__GNUC__
 && !deföed 
__˝lu•lus


50 
	#__WAIT_INT
(
°©us
) \

51 (
	`__exãnsi⁄__
 (((uni⁄ { 
	`__ty≥of
(
°©us
Ë
__ö
; 
__i
; }) \

52 { .
__ö
 = (
°©us
Ë}).
__i
))

	)

54 
	#__WAIT_INT
(
°©us
Ë(*(*Ë&(°©us))

	)

62 #i‡!
deföed
 
__GNUC__
 || __GNUC__ < 2 || deföed 
__˝lu•lus


63 
	#__WAIT_STATUS
 *

	)

64 
	#__WAIT_STATUS_DEFN
 *

	)

69 
waô
 *
	m__u±r
;

70 *
	m__ùå
;

71 } 
	t__WAIT_STATUS
 
	t__©åibuã__
 ((
	t__å™•¨ít_uni⁄__
));

72 
	#__WAIT_STATUS_DEFN
 *

	)

77 
	#__WAIT_INT
(
°©us
Ë(°©us)

	)

78 
	#__WAIT_STATUS
 *

	)

79 
	#__WAIT_STATUS_DEFN
 *

	)

84 
	#WEXITSTATUS
(
°©us
Ë
	`__WEXITSTATUS
 (
	`__WAIT_INT
 (°©us))

	)

85 
	#WTERMSIG
(
°©us
Ë
	`__WTERMSIG
 (
	`__WAIT_INT
 (°©us))

	)

86 
	#WSTOPSIG
(
°©us
Ë
	`__WSTOPSIG
 (
	`__WAIT_INT
 (°©us))

	)

87 
	#WIFEXITED
(
°©us
Ë
	`__WIFEXITED
 (
	`__WAIT_INT
 (°©us))

	)

88 
	#WIFSIGNALED
(
°©us
Ë
	`__WIFSIGNALED
 (
	`__WAIT_INT
 (°©us))

	)

89 
	#WIFSTOPPED
(
°©us
Ë
	`__WIFSTOPPED
 (
	`__WAIT_INT
 (°©us))

	)

90 #ifde‡
__WIFCONTINUED


91 
	#WIFCONTINUED
(
°©us
Ë
	`__WIFCONTINUED
 (
	`__WAIT_INT
 (°©us))

	)

95 
__BEGIN_NAMESPACE_STD


99 
	mquŸ
;

100 
	mªm
;

101 } 
	tdiv_t
;

104 #i‚de‡
__ldiv_t_deföed


107 
	mquŸ
;

108 
	mªm
;

109 } 
	tldiv_t
;

110 
	#__ldiv_t_deföed
 1

	)

112 
	g__END_NAMESPACE_STD


114 #i‡
deföed
 
__USE_ISOC99
 && !deföed 
__Œdiv_t_deföed


115 
__BEGIN_NAMESPACE_C99


117 
__exãnsi⁄__
 struct

119 
	mquŸ
;

120 
	mªm
;

121 } 
	tŒdiv_t
;

122 
	#__Œdiv_t_deföed
 1

	)

123 
	g__END_NAMESPACE_C99


128 
	#RAND_MAX
 2147483647

	)

133 
	#EXIT_FAILURE
 1

	)

134 
	#EXIT_SUCCESS
 0

	)

138 
	#MB_CUR_MAX
 (
	`__˘y≥_gë_mb_cur_max
 ())

	)

139 
size_t
 
	$__˘y≥_gë_mb_cur_max
 (Ë
__THROW
 
__wur
;

142 
__BEGIN_NAMESPACE_STD


144 
	$©of
 (c⁄° *
__≈å
)

145 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

147 
	$©oi
 (c⁄° *
__≈å
)

148 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

150 
	$©ﬁ
 (c⁄° *
__≈å
)

151 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

152 
__END_NAMESPACE_STD


154 #i‡
deföed
 
__USE_ISOC99
 || (deföed 
__GLIBC_HAVE_LONG_LONG
 && deföed 
__USE_MISC
)

155 
__BEGIN_NAMESPACE_C99


157 
__exãnsi⁄__
 
	$©ﬁl
 (c⁄° *
__≈å
)

158 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

159 
__END_NAMESPACE_C99


162 
__BEGIN_NAMESPACE_STD


164 
	$°πod
 (c⁄° *
__ª°ri˘
 
__≈å
,

165 **
__ª°ri˘
 
__íd±r
)

166 
__THROW
 
	`__n⁄nuŒ
 ((1));

167 
__END_NAMESPACE_STD


169 #ifdef 
__USE_ISOC99


170 
__BEGIN_NAMESPACE_C99


172 
	$°πof
 (c⁄° *
__ª°ri˘
 
__≈å
,

173 **
__ª°ri˘
 
__íd±r
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

175 
	$°πﬁd
 (c⁄° *
__ª°ri˘
 
__≈å
,

176 **
__ª°ri˘
 
__íd±r
)

177 
__THROW
 
	`__n⁄nuŒ
 ((1));

178 
__END_NAMESPACE_C99


181 
__BEGIN_NAMESPACE_STD


183 
	$°πﬁ
 (c⁄° *
__ª°ri˘
 
__≈å
,

184 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

185 
__THROW
 
	`__n⁄nuŒ
 ((1));

187 
	$°πoul
 (c⁄° *
__ª°ri˘
 
__≈å
,

188 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

189 
__THROW
 
	`__n⁄nuŒ
 ((1));

190 
__END_NAMESPACE_STD


192 #i‡
deföed
 
__GLIBC_HAVE_LONG_LONG
 && deföed 
__USE_BSD


194 
__exãnsi⁄__


195 
	$°πoq
 (c⁄° *
__ª°ri˘
 
__≈å
,

196 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

197 
__THROW
 
	`__n⁄nuŒ
 ((1));

199 
__exãnsi⁄__


200 
	$°πouq
 (c⁄° *
__ª°ri˘
 
__≈å
,

201 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

202 
__THROW
 
	`__n⁄nuŒ
 ((1));

205 #i‡
deföed
 
__USE_ISOC99
 || (deföed 
__GLIBC_HAVE_LONG_LONG
 && deföed 
__USE_MISC
)

206 
__BEGIN_NAMESPACE_C99


208 
__exãnsi⁄__


209 
	$°πﬁl
 (c⁄° *
__ª°ri˘
 
__≈å
,

210 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

211 
__THROW
 
	`__n⁄nuŒ
 ((1));

213 
__exãnsi⁄__


214 
	$°πouŒ
 (c⁄° *
__ª°ri˘
 
__≈å
,

215 **
__ª°ri˘
 
__íd±r
, 
__ba£
)

216 
__THROW
 
	`__n⁄nuŒ
 ((1));

217 
__END_NAMESPACE_C99


221 #ifde‡
__USE_GNU


235 
	~<xloˇÀ.h
>

239 
	$°πﬁ_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

240 **
__ª°ri˘
 
__íd±r
, 
__ba£
,

241 
__loˇÀ_t
 
__loc
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 4));

243 
	$°πoul_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

244 **
__ª°ri˘
 
__íd±r
,

245 
__ba£
, 
__loˇÀ_t
 
__loc
)

246 
__THROW
 
	`__n⁄nuŒ
 ((1, 4));

248 
__exãnsi⁄__


249 
	$°πﬁl_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

250 **
__ª°ri˘
 
__íd±r
, 
__ba£
,

251 
__loˇÀ_t
 
__loc
)

252 
__THROW
 
	`__n⁄nuŒ
 ((1, 4));

254 
__exãnsi⁄__


255 
	$°πouŒ_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

256 **
__ª°ri˘
 
__íd±r
,

257 
__ba£
, 
__loˇÀ_t
 
__loc
)

258 
__THROW
 
	`__n⁄nuŒ
 ((1, 4));

260 
	$°πod_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

261 **
__ª°ri˘
 
__íd±r
, 
__loˇÀ_t
 
__loc
)

262 
__THROW
 
	`__n⁄nuŒ
 ((1, 3));

264 
	$°πof_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

265 **
__ª°ri˘
 
__íd±r
, 
__loˇÀ_t
 
__loc
)

266 
__THROW
 
	`__n⁄nuŒ
 ((1, 3));

268 
	$°πﬁd_l
 (c⁄° *
__ª°ri˘
 
__≈å
,

269 **
__ª°ri˘
 
__íd±r
,

270 
__loˇÀ_t
 
__loc
)

271 
__THROW
 
	`__n⁄nuŒ
 ((1, 3));

275 #ifde‡
__USE_EXTERN_INLINES


276 
__BEGIN_NAMESPACE_STD


277 
__exã∫_ölöe
 

278 
	`__NTH
 (
	$©oi
 (c⁄° *
__≈å
))

280  (Ë
	`°πﬁ
 (
__≈å
, (**Ë
NULL
, 10);

281 
	}
}

282 
__exã∫_ölöe
 

283 
__NTH
 (
	$©ﬁ
 (c⁄° *
__≈å
))

285  
	`°πﬁ
 (
__≈å
, (**Ë
NULL
, 10);

286 
	}
}

287 
	g__END_NAMESPACE_STD


289 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_ISOC99


290 
__BEGIN_NAMESPACE_C99


291 
__exãnsi⁄__
 
__exã∫_ölöe
 

292 
__NTH
 (
	$©ﬁl
 (c⁄° *
__≈å
))

294  
	`°πﬁl
 (
__≈å
, (**Ë
NULL
, 10);

295 
	}
}

296 
	g__END_NAMESPACE_C99


301 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_XOPEN_EXTENDED


305 *
	$l64a
 (
__n
Ë
__THROW
 
__wur
;

308 
	$a64l
 (c⁄° *
__s
)

309 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

313 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_BSD


314 
	~<sys/ty≥s.h
>

321 
	$øndom
 (Ë
__THROW
;

324 
	$§™dom
 (
__£ed
Ë
__THROW
;

330 *
	$öô°©e
 (
__£ed
, *
__°©ebuf
,

331 
size_t
 
__°©ñí
Ë
__THROW
 
	`__n⁄nuŒ
 ((2));

335 *
	$£t°©e
 (*
__°©ebuf
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

338 #ifde‡
__USE_MISC


343 
	søndom_d©a


345 
öt32_t
 *
Âå
;

346 
öt32_t
 *
Ωå
;

347 
öt32_t
 *
°©e
;

348 
ønd_ty≥
;

349 
ønd_deg
;

350 
ønd_£p
;

351 
öt32_t
 *
íd_±r
;

354 
	$øndom_r
 (
øndom_d©a
 *
__ª°ri˘
 
__buf
,

355 
öt32_t
 *
__ª°ri˘
 
__ªsu…
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

357 
	$§™dom_r
 (
__£ed
, 
øndom_d©a
 *
__buf
)

358 
__THROW
 
	`__n⁄nuŒ
 ((2));

360 
	$öô°©e_r
 (
__£ed
, *
__ª°ri˘
 
__°©ebuf
,

361 
size_t
 
__°©ñí
,

362 
øndom_d©a
 *
__ª°ri˘
 
__buf
)

363 
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

365 
	$£t°©e_r
 (*
__ª°ri˘
 
__°©ebuf
,

366 
øndom_d©a
 *
__ª°ri˘
 
__buf
)

367 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

372 
__BEGIN_NAMESPACE_STD


374 
	$ønd
 (Ë
__THROW
;

376 
	$§™d
 (
__£ed
Ë
__THROW
;

377 
__END_NAMESPACE_STD


379 #ifde‡
__USE_POSIX


381 
	$ønd_r
 (*
__£ed
Ë
__THROW
;

385 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_XOPEN


389 
	$dønd48
 (Ë
__THROW
;

390 
	$î™d48
 (
__xsubi
[3]Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

393 
	$Ã™d48
 (Ë
__THROW
;

394 
	$ƒ™d48
 (
__xsubi
[3])

395 
__THROW
 
	`__n⁄nuŒ
 ((1));

398 
	$mønd48
 (Ë
__THROW
;

399 
	$jønd48
 (
__xsubi
[3])

400 
__THROW
 
	`__n⁄nuŒ
 ((1));

403 
	$§™d48
 (
__£edvÆ
Ë
__THROW
;

404 *
	$£ed48
 (
__£ed16v
[3])

405 
__THROW
 
	`__n⁄nuŒ
 ((1));

406 
	$lc⁄g48
 (
__∑øm
[7]Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

408 #ifde‡
__USE_MISC


412 
	sdønd48_d©a


414 
__x
[3];

415 
__ﬁd_x
[3];

416 
__c
;

417 
__öô
;

418 
__a
;

422 
	$dønd48_r
 (
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

423 *
__ª°ri˘
 
__ªsu…
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

424 
	$î™d48_r
 (
__xsubi
[3],

425 
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

426 *
__ª°ri˘
 
__ªsu…
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

429 
	$Ã™d48_r
 (
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

430 *
__ª°ri˘
 
__ªsu…
)

431 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

432 
	$ƒ™d48_r
 (
__xsubi
[3],

433 
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

434 *
__ª°ri˘
 
__ªsu…
)

435 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

438 
	$mønd48_r
 (
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

439 *
__ª°ri˘
 
__ªsu…
)

440 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

441 
	$jønd48_r
 (
__xsubi
[3],

442 
dønd48_d©a
 *
__ª°ri˘
 
__buf„r
,

443 *
__ª°ri˘
 
__ªsu…
)

444 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

447 
	$§™d48_r
 (
__£edvÆ
, 
dønd48_d©a
 *
__buf„r
)

448 
__THROW
 
	`__n⁄nuŒ
 ((2));

450 
	$£ed48_r
 (
__£ed16v
[3],

451 
dønd48_d©a
 *
__buf„r
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

453 
	$lc⁄g48_r
 (
__∑øm
[7],

454 
dønd48_d©a
 *
__buf„r
)

455 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

461 #i‚de‡
__mÆloc_™d_ˇŒoc_deföed


462 
	#__mÆloc_™d_ˇŒoc_deföed


	)

463 
__BEGIN_NAMESPACE_STD


465 *
	$mÆloc
 (
size_t
 
__size
Ë
__THROW
 
__©åibuã_mÆloc__
 
__wur
;

467 *
	$ˇŒoc
 (
size_t
 
__nmemb
, size_à
__size
)

468 
__THROW
 
__©åibuã_mÆloc__
 
__wur
;

469 
__END_NAMESPACE_STD


472 #i‚de‡
__√ed_mÆloc_™d_ˇŒoc


473 
__BEGIN_NAMESPACE_STD


479 *
	$ªÆloc
 (*
__±r
, 
size_t
 
__size
)

480 
__THROW
 
__©åibuã_w¨n_unu£d_ªsu…__
;

482 
	$‰ì
 (*
__±r
Ë
__THROW
;

483 
__END_NAMESPACE_STD


485 #ifdef 
__USE_MISC


487 
	$c‰ì
 (*
__±r
Ë
__THROW
;

490 #i‡
deföed
 
__USE_GNU
 || deföed 
__USE_BSD
 || deföed 
__USE_MISC


491 
	~<Æloˇ.h
>

494 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 && !deföed 
__USE_XOPEN2K
) \

495 || 
deföed
 
__USE_BSD


497 *
	$vÆloc
 (
size_t
 
__size
Ë
__THROW
 
__©åibuã_mÆloc__
 
__wur
;

500 #ifde‡
__USE_XOPEN2K


502 
	$posix_memÆign
 (**
__mem±r
, 
size_t
 
__Æignmít
, size_à
__size
)

503 
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

506 #ifde‡
__USE_ISOC11


508 *
	$Æig√d_Æloc
 (
size_t
 
__Æignmít
, size_à
__size
)

509 
__THROW
 
__wur
 
	`__©åibuã__
 ((
__mÆloc__
, 
	`__Æloc_size__
 (2)));

512 
__BEGIN_NAMESPACE_STD


514 
	$ab‹t
 (Ë
__THROW
 
	`__©åibuã__
 ((
__n‹ëu∫__
));

518 
	`©exô
 ((*
__func
Ë()Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

520 #i‡
deföed
 
__USE_ISOC11
 || deföed 
__USE_ISOCXX11


522 #ifde‡
__˝lu•lus


523 "C++" 
	`©_quick_exô
 ((*
__func
) ())

524 
__THROW
 
	`__asm
 ("©_quick_exô"Ë
	`__n⁄nuŒ
 ((1));

526 
	`©_quick_exô
 ((*
__func
Ë()Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

529 
__END_NAMESPACE_STD


531 #ifdef 
__USE_MISC


534 
	`⁄_exô
 ((*
__func
Ë(
__°©us
, *
__¨g
), *__arg)

535 
__THROW
 
	`__n⁄nuŒ
 ((1));

538 
__BEGIN_NAMESPACE_STD


542 
	$exô
 (
__°©us
Ë
__THROW
 
	`__©åibuã__
 ((
__n‹ëu∫__
));

544 #i‡
deföed
 
__USE_ISOC11
 || deföed 
__USE_ISOCXX11


548 
	$quick_exô
 (
__°©us
Ë
__THROW
 
	`__©åibuã__
 ((
__n‹ëu∫__
));

550 
__END_NAMESPACE_STD


552 #ifde‡
__USE_ISOC99


553 
__BEGIN_NAMESPACE_C99


556 
	$_Exô
 (
__°©us
Ë
__THROW
 
	`__©åibuã__
 ((
__n‹ëu∫__
));

557 
__END_NAMESPACE_C99


561 
__BEGIN_NAMESPACE_STD


563 *
	$gëív
 (c⁄° *
__«me
Ë
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

564 
__END_NAMESPACE_STD


566 #ifde‡
__USE_GNU


569 *
	$£cuª_gëív
 (c⁄° *
__«me
)

570 
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

573 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_XOPEN


577 
	$puãnv
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

580 #i‡
deföed
 
__USE_BSD
 || deföed 
__USE_XOPEN2K


583 
	$£ãnv
 (c⁄° *
__«me
, c⁄° *
__vÆue
, 
__ª∂a˚
)

584 
__THROW
 
	`__n⁄nuŒ
 ((2));

587 
	$un£ãnv
 (c⁄° *
__«me
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

590 #ifdef 
__USE_MISC


594 
	$˛óªnv
 (Ë
__THROW
;

598 #i‡
deföed
 
__USE_MISC
 \

599 || (
deföed
 
__USE_XOPEN_EXTENDED
 && !deföed 
__USE_XOPEN2K8
)

605 *
	$mkãmp
 (*
__ãm∂©e
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

608 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN_EXTENDED
 \

609 || 
deföed
 
__USE_XOPEN2K8


618 #i‚de‡
__USE_FILE_OFFSET64


619 
	$mk°emp
 (*
__ãm∂©e
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

621 #ifde‡
__REDIRECT


622 
	`__REDIRECT
 (
mk°emp
, (*
__ãm∂©e
), 
mk°emp64
)

623 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

625 
	#mk°emp
 
mk°emp64


	)

628 #ifde‡
__USE_LARGEFILE64


629 
	$mk°emp64
 (*
__ãm∂©e
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

633 #ifde‡
__USE_MISC


640 #i‚de‡
__USE_FILE_OFFSET64


641 
	$mk°emps
 (*
__ãm∂©e
, 
__suffixÀn
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

643 #ifde‡
__REDIRECT


644 
	`__REDIRECT
 (
mk°emps
, (*
__ãm∂©e
, 
__suffixÀn
),

645 
mk°emps64
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

647 
	#mk°emps
 
mk°emps64


	)

650 #ifde‡
__USE_LARGEFILE64


651 
	$mk°emps64
 (*
__ãm∂©e
, 
__suffixÀn
)

652 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

656 #i‡
deföed
 
__USE_BSD
 || deföed 
__USE_XOPEN2K8


662 *
	$mkdãmp
 (*
__ãm∂©e
Ë
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

665 #ifde‡
__USE_GNU


672 #i‚de‡
__USE_FILE_OFFSET64


673 
	$mko°emp
 (*
__ãm∂©e
, 
__Êags
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

675 #ifde‡
__REDIRECT


676 
	`__REDIRECT
 (
mko°emp
, (*
__ãm∂©e
, 
__Êags
), 
mko°emp64
)

677 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

679 
	#mko°emp
 
mko°emp64


	)

682 #ifde‡
__USE_LARGEFILE64


683 
	$mko°emp64
 (*
__ãm∂©e
, 
__Êags
Ë
	`__n⁄nuŒ
 ((1)Ë
__wur
;

692 #i‚de‡
__USE_FILE_OFFSET64


693 
	$mko°emps
 (*
__ãm∂©e
, 
__suffixÀn
, 
__Êags
)

694 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

696 #ifde‡
__REDIRECT


697 
	`__REDIRECT
 (
mko°emps
, (*
__ãm∂©e
, 
__suffixÀn
,

698 
__Êags
), 
mko°emps64
)

699 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

701 
	#mko°emps
 
mko°emps64


	)

704 #ifde‡
__USE_LARGEFILE64


705 
	$mko°emps64
 (*
__ãm∂©e
, 
__suffixÀn
, 
__Êags
)

706 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

711 
__BEGIN_NAMESPACE_STD


716 
	$sy°em
 (c⁄° *
__comm™d
Ë
__wur
;

717 
__END_NAMESPACE_STD


720 #ifdef 
__USE_GNU


723 *
	$ˇn⁄iˇlize_fûe_«me
 (c⁄° *
__«me
)

724 
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

727 #i‡
deföed
 
__USE_BSD
 || deföed 
__USE_XOPEN_EXTENDED


733 *
	$ªÆ∑th
 (c⁄° *
__ª°ri˘
 
__«me
,

734 *
__ª°ri˘
 
__ªsﬁved
Ë
__THROW
 
__wur
;

739 #i‚de‡
__COMPAR_FN_T


740 
	#__COMPAR_FN_T


	)

741 (*
	t__com∑r_‚_t
) (const *, const *);

743 #ifdef 
__USE_GNU


744 
__com∑r_‚_t
 
	tcom∑ris⁄_‚_t
;

747 #ifde‡
__USE_GNU


748 (*
	t__com∑r_d_‚_t
) (const *, const *, *);

751 
__BEGIN_NAMESPACE_STD


754 *
	$b£¨ch
 (c⁄° *
__key
, c⁄° *
__ba£
,

755 
size_t
 
__nmemb
, size_à
__size
, 
__com∑r_‚_t
 
__com∑r
)

756 
	`__n⁄nuŒ
 ((1, 2, 5)Ë
__wur
;

760 
	$qs‹t
 (*
__ba£
, 
size_t
 
__nmemb
, size_à
__size
,

761 
__com∑r_‚_t
 
__com∑r
Ë
	`__n⁄nuŒ
 ((1, 4));

762 #ifde‡
__USE_GNU


763 
	$qs‹t_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_à
__size
,

764 
__com∑r_d_‚_t
 
__com∑r
, *
__¨g
)

765 
	`__n⁄nuŒ
 ((1, 4));

770 
	$abs
 (
__x
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

771 
	$œbs
 (
__x
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

772 
__END_NAMESPACE_STD


774 #ifde‡
__USE_ISOC99


775 
__exãnsi⁄__
 
	$Œabs
 (
__x
)

776 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

780 
__BEGIN_NAMESPACE_STD


784 
div_t
 
	$div
 (
__numî
, 
__díom
)

785 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

786 
ldiv_t
 
	$ldiv
 (
__numî
, 
__díom
)

787 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

788 
__END_NAMESPACE_STD


790 #ifde‡
__USE_ISOC99


791 
__BEGIN_NAMESPACE_C99


792 
__exãnsi⁄__
 
Œdiv_t
 
	$Œdiv
 (
__numî
,

793 
__díom
)

794 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
)Ë
__wur
;

795 
__END_NAMESPACE_C99


799 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 && !deföed 
__USE_XOPEN2K8
) \

800 || 
deföed
 
__USE_SVID


807 *
	$ecvt
 (
__vÆue
, 
__ndigô
, *
__ª°ri˘
 
__de˝t
,

808 *
__ª°ri˘
 
__sign
Ë
__THROW
 
	`__n⁄nuŒ
 ((3, 4)Ë
__wur
;

813 *
	$fcvt
 (
__vÆue
, 
__ndigô
, *
__ª°ri˘
 
__de˝t
,

814 *
__ª°ri˘
 
__sign
Ë
__THROW
 
	`__n⁄nuŒ
 ((3, 4)Ë
__wur
;

819 *
	$gcvt
 (
__vÆue
, 
__ndigô
, *
__buf
)

820 
__THROW
 
	`__n⁄nuŒ
 ((3)Ë
__wur
;

823 #ifde‡
__USE_MISC


825 *
	$qecvt
 (
__vÆue
, 
__ndigô
,

826 *
__ª°ri˘
 
__de˝t
, *__ª°ri˘ 
__sign
)

827 
__THROW
 
	`__n⁄nuŒ
 ((3, 4)Ë
__wur
;

828 *
	$qfcvt
 (
__vÆue
, 
__ndigô
,

829 *
__ª°ri˘
 
__de˝t
, *__ª°ri˘ 
__sign
)

830 
__THROW
 
	`__n⁄nuŒ
 ((3, 4)Ë
__wur
;

831 *
	$qgcvt
 (
__vÆue
, 
__ndigô
, *
__buf
)

832 
__THROW
 
	`__n⁄nuŒ
 ((3)Ë
__wur
;

837 
	$ecvt_r
 (
__vÆue
, 
__ndigô
, *
__ª°ri˘
 
__de˝t
,

838 *
__ª°ri˘
 
__sign
, *__ª°ri˘ 
__buf
,

839 
size_t
 
__Àn
Ë
__THROW
 
	`__n⁄nuŒ
 ((3, 4, 5));

840 
	$fcvt_r
 (
__vÆue
, 
__ndigô
, *
__ª°ri˘
 
__de˝t
,

841 *
__ª°ri˘
 
__sign
, *__ª°ri˘ 
__buf
,

842 
size_t
 
__Àn
Ë
__THROW
 
	`__n⁄nuŒ
 ((3, 4, 5));

844 
	$qecvt_r
 (
__vÆue
, 
__ndigô
,

845 *
__ª°ri˘
 
__de˝t
, *__ª°ri˘ 
__sign
,

846 *
__ª°ri˘
 
__buf
, 
size_t
 
__Àn
)

847 
__THROW
 
	`__n⁄nuŒ
 ((3, 4, 5));

848 
	$qfcvt_r
 (
__vÆue
, 
__ndigô
,

849 *
__ª°ri˘
 
__de˝t
, *__ª°ri˘ 
__sign
,

850 *
__ª°ri˘
 
__buf
, 
size_t
 
__Àn
)

851 
__THROW
 
	`__n⁄nuŒ
 ((3, 4, 5));

856 
__BEGIN_NAMESPACE_STD


859 
	$mbÀn
 (c⁄° *
__s
, 
size_t
 
__n
Ë
__THROW
 
__wur
;

862 
	$mbtowc
 (
wch¨_t
 *
__ª°ri˘
 
__pwc
,

863 c⁄° *
__ª°ri˘
 
__s
, 
size_t
 
__n
Ë
__THROW
 
__wur
;

866 
	$w˘omb
 (*
__s
, 
wch¨_t
 
__wch¨
Ë
__THROW
 
__wur
;

870 
size_t
 
	$mb°owcs
 (
wch¨_t
 *
__ª°ri˘
 
__pwcs
,

871 c⁄° *
__ª°ri˘
 
__s
, 
size_t
 
__n
Ë
__THROW
;

873 
size_t
 
	$wc°ombs
 (*
__ª°ri˘
 
__s
,

874 c⁄° 
wch¨_t
 *
__ª°ri˘
 
__pwcs
, 
size_t
 
__n
)

875 
__THROW
;

876 
__END_NAMESPACE_STD


879 #ifde‡
__USE_SVID


884 
	$Ωm©ch
 (c⁄° *
__ª•⁄£
Ë
__THROW
 
	`__n⁄nuŒ
 ((1)Ë
__wur
;

888 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8


895 
	$gësub›t
 (**
__ª°ri˘
 
__›ti⁄p
,

896 *c⁄° *
__ª°ri˘
 
__tokís
,

897 **
__ª°ri˘
 
__vÆuï
)

898 
__THROW
 
	`__n⁄nuŒ
 ((1, 2, 3)Ë
__wur
;

902 #ifde‡
__USE_XOPEN


904 
	$£tkey
 (c⁄° *
__key
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

910 #ifde‡
__USE_XOPEN2KXSI


912 
	$posix_›í±
 (
__oÊag
Ë
__wur
;

915 #ifde‡
__USE_XOPEN


920 
	$gø¡±
 (
__fd
Ë
__THROW
;

924 
	$u∆ock±
 (
__fd
Ë
__THROW
;

929 *
	$±¢ame
 (
__fd
Ë
__THROW
 
__wur
;

932 #ifde‡
__USE_GNU


936 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buÊí
)

937 
__THROW
 
	`__n⁄nuŒ
 ((2));

940 
	`gë±
 ();

943 #ifde‡
__USE_BSD


947 
	$gëlﬂdavg
 (
__lﬂdavg
[], 
__√Àm
)

948 
__THROW
 
	`__n⁄nuŒ
 ((1));

951 
	~<bôs/°dlib-Êﬂt.h
>

954 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


955 
	~<bôs/°dlib.h
>

957 #ifde‡
__LDBL_COMPAT


958 
	~<bôs/°dlib-ldbl.h
>

962 #unde‡
__√ed_mÆloc_™d_ˇŒoc


964 
__END_DECLS


	@/usr/include/sys/cdefs.h

19 #i‚def 
_SYS_CDEFS_H


20 
	#_SYS_CDEFS_H
 1

	)

23 #i‚de‡
_FEATURES_H


24 
	~<„©uªs.h
>

30 #i‡
deföed
 
__GNUC__
 && !deföed 
__STDC__


35 #unde‡
__P


36 #unde‡
__PMT


38 #ifde‡
__GNUC__


42 #i‡
__GNUC_PREREQ
 (4, 6Ë&& !
deföed
 
_LIBC


43 
	#__LEAF
 , 
__Àaf__


	)

44 
	#__LEAF_ATTR
 
	`__©åibuã__
 ((
__Àaf__
))

	)

46 
	#__LEAF


	)

47 
	#__LEAF_ATTR


	)

55 #i‡!
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (3, 3)

56 
	#__THROW
 
	`__©åibuã__
 ((
__nŸhrow__
 
__LEAF
))

	)

57 
	#__THROWNL
 
	`__©åibuã__
 ((
__nŸhrow__
))

	)

58 
	#__NTH
(
f˘
Ë
	`__©åibuã__
 ((
__nŸhrow__
 
__LEAF
)Ë
	)
fct

60 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (2,8)

61 
	#__THROW
 
	`throw
 ()

	)

62 
	#__THROWNL
 
	`throw
 ()

	)

63 
	#__NTH
(
f˘
Ë
__LEAF_ATTR
 f˘ 
	`throw
 ()

	)

65 
	#__THROW


	)

66 
	#__THROWNL


	)

67 
	#__NTH
(
f˘
Ë
	)
fct

73 
	#__ölöe


	)

75 
	#__THROW


	)

76 
	#__THROWNL


	)

77 
	#__NTH
(
f˘
Ë
	)
fct

83 
	#__P
(
¨gs
Ë
	)
args

84 
	#__PMT
(
¨gs
Ë
	)
args

89 
	#__CONCAT
(
x
,
y
Ëx ## 
	)
y

90 
	#__STRING
(
x
Ë#x

	)

93 
	#__±r_t
 *

	)

94 
	#__l⁄g_doubÀ_t
 

	)

98 #ifdef 
__˝lu•lus


99 
	#__BEGIN_DECLS
 "C" {

	)

100 
	#__END_DECLS
 }

	)

102 
	#__BEGIN_DECLS


	)

103 
	#__END_DECLS


	)

112 #i‡
deföed
 
__˝lu•lus
 && deföed 
_GLIBCPP_USE_NAMESPACES


113 
	#__BEGIN_NAMESPACE_STD
 
«me•a˚
 
°d
 {

	)

114 
	#__END_NAMESPACE_STD
 }

	)

115 
	#__USING_NAMESPACE_STD
(
«me
Ë
usög
 
°d
::«me;

	)

116 
	#__BEGIN_NAMESPACE_C99
 
«me•a˚
 
__c99
 {

	)

117 
	#__END_NAMESPACE_C99
 }

	)

118 
	#__USING_NAMESPACE_C99
(
«me
Ë
usög
 
__c99
::«me;

	)

123 
	#__BEGIN_NAMESPACE_STD


	)

124 
	#__END_NAMESPACE_STD


	)

125 
	#__USING_NAMESPACE_STD
(
«me
)

	)

126 
	#__BEGIN_NAMESPACE_C99


	)

127 
	#__END_NAMESPACE_C99


	)

128 
	#__USING_NAMESPACE_C99
(
«me
)

	)

133 #i‚de‡
__BOUNDED_POINTERS__


134 
	#__bounded


	)

135 
	#__unbounded


	)

136 
	#__±rvÆue


	)

141 
	#__bos
(
±r
Ë
	`__buûtö_obje˘_size
 (±r, 
__USE_FORTIFY_LEVEL
 > 1)

	)

142 
	#__bos0
(
±r
Ë
	`__buûtö_obje˘_size
 (±r, 0)

	)

144 #i‡
__GNUC_PREREQ
 (4,3)

145 
	#__w¨nde˛
(
«me
, 
msg
) \

146 
	`«me
 (Ë
	`__©åibuã__
((
	`__w¨nög__
 (
msg
)))

	)

147 
	#__w¨«âr
(
msg
Ë
	`__©åibuã__
((
	`__w¨nög__
 (msg)))

	)

148 
	#__îr‹de˛
(
«me
, 
msg
) \

149 
	`«me
 (Ë
	`__©åibuã__
((
	`__îr‹__
 (
msg
)))

	)

151 
	#__w¨nde˛
(
«me
, 
msg
Ë
	`«me
 ()

	)

152 
	#__w¨«âr
(
msg
)

	)

153 
	#__îr‹de˛
(
«me
, 
msg
Ë
	`«me
 ()

	)

157 #i‡
__GNUC_PREREQ
 (2,97)

159 
	#__Êex¨r
 []

	)

161 #ifde‡
__GNUC__


162 
	#__Êex¨r
 [0]

	)

164 #i‡
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

165 
	#__Êex¨r
 []

	)

168 
	#__Êex¨r
 [1]

	)

184 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

186 
	#__REDIRECT
(
«me
, 
¥Ÿo
, 
Æüs
Ë«mê¥Ÿÿ
	`__asm__
 (
	`__ASMNAME
 (#Æüs))

	)

187 #ifde‡
__˝lu•lus


188 
	#__REDIRECT_NTH
(
«me
, 
¥Ÿo
, 
Æüs
) \

189 
«me
 
¥Ÿo
 
__THROW
 
	`__asm__
 (
	`__ASMNAME
 (#Æüs))

	)

190 
	#__REDIRECT_NTHNL
(
«me
, 
¥Ÿo
, 
Æüs
) \

191 
«me
 
¥Ÿo
 
__THROWNL
 
	`__asm__
 (
	`__ASMNAME
 (#Æüs))

	)

193 
	#__REDIRECT_NTH
(
«me
, 
¥Ÿo
, 
Æüs
) \

194 
«me
 
¥Ÿo
 
	`__asm__
 (
	`__ASMNAME
 (#Æüs)Ë
__THROW


	)

195 
	#__REDIRECT_NTHNL
(
«me
, 
¥Ÿo
, 
Æüs
) \

196 
«me
 
¥Ÿo
 
	`__asm__
 (
	`__ASMNAME
 (#Æüs)Ë
__THROWNL


	)

198 
	#__ASMNAME
(
˙ame
Ë
	`__ASMNAME2
 (
__USER_LABEL_PREFIX__
, c«me)

	)

199 
	#__ASMNAME2
(
¥efix
, 
˙ame
Ë
	`__STRING
 (¥efixË
	)
cname

212 #i‡!
deföed
 
__GNUC__
 || __GNUC__ < 2

213 
	#__©åibuã__
(
xyz
Ë

	)

219 #i‡
__GNUC_PREREQ
 (2,96)

220 
	#__©åibuã_mÆloc__
 
	`__©åibuã__
 ((
__mÆloc__
))

	)

222 
	#__©åibuã_mÆloc__


	)

228 #i‡
__GNUC_PREREQ
 (2,96)

229 
	#__©åibuã_puª__
 
	`__©åibuã__
 ((
__puª__
))

	)

231 
	#__©åibuã_puª__


	)

235 #i‡
__GNUC_PREREQ
 (2,5)

236 
	#__©åibuã_c⁄°__
 
	`__©åibuã__
 ((
__c⁄°__
))

	)

238 
	#__©åibuã_c⁄°__


	)

244 #i‡
__GNUC_PREREQ
 (3,1)

245 
	#__©åibuã_u£d__
 
	`__©åibuã__
 ((
__u£d__
))

	)

246 
	#__©åibuã_noölöe__
 
	`__©åibuã__
 ((
__noölöe__
))

	)

248 
	#__©åibuã_u£d__
 
	`__©åibuã__
 ((
__unu£d__
))

	)

249 
	#__©åibuã_noölöe__


	)

253 #i‡
__GNUC_PREREQ
 (3,2)

254 
	#__©åibuã_dïªˇãd__
 
	`__©åibuã__
 ((
__dïªˇãd__
))

	)

256 
	#__©åibuã_dïªˇãd__


	)

265 #i‡
__GNUC_PREREQ
 (2,8)

266 
	#__©åibuã_f‹m©_¨g__
(
x
Ë
	`__©åibuã__
 ((
	`__f‹m©_¨g__
 (x)))

	)

268 
	#__©åibuã_f‹m©_¨g__
(
x
Ë

	)

275 #i‡
__GNUC_PREREQ
 (2,97)

276 
	#__©åibuã_f‹m©_°rfm⁄__
(
a
,
b
) \

277 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__°rfm⁄__
, 
a
, 
b
)))

	)

279 
	#__©åibuã_f‹m©_°rfm⁄__
(
a
,
b
Ë

	)

284 #i‡
__GNUC_PREREQ
 (3,3)

285 
	#__n⁄nuŒ
(
∑øms
Ë
	`__©åibuã__
 ((
__n⁄nuŒ__
Ö¨ams))

	)

287 
	#__n⁄nuŒ
(
∑øms
)

	)

292 #i‡
__GNUC_PREREQ
 (3,4)

293 
	#__©åibuã_w¨n_unu£d_ªsu…__
 \

294 
	`__©åibuã__
 ((
__w¨n_unu£d_ªsu…__
))

	)

295 #i‡
__USE_FORTIFY_LEVEL
 > 0

296 
	#__wur
 
__©åibuã_w¨n_unu£d_ªsu…__


	)

299 
	#__©åibuã_w¨n_unu£d_ªsu…__


	)

301 #i‚de‡
__wur


302 
	#__wur


	)

306 #i‡
__GNUC_PREREQ
 (3,2)

307 
	#__Æways_ölöe
 
__ölöe
 
	`__©åibuã__
 ((
__Æways_ölöe__
))

	)

309 
	#__Æways_ölöe
 
__ölöe


	)

314 #i‡
__GNUC_PREREQ
 (4,3)

315 
	#__©åibuã_¨tificül__
 
	`__©åibuã__
 ((
__¨tificül__
))

	)

317 
	#__©åibuã_¨tificül__


	)

329 #i‡(!
deföed
 
__˝lu•lus
 || 
__GNUC_PREREQ
 (4,3) \

330 || (
deföed
 
__˛™g__
 && (deföed 
__GNUC_STDC_INLINE__
 \

331 || 
deföed
 
__GNUC_GNU_INLINE__
)))

332 #i‡
deföed
 
__GNUC_STDC_INLINE__
 || deföed 
__˝lu•lus


333 
	#__exã∫_ölöe
 
__ölöe
 
	`__©åibuã__
 ((
__gnu_ölöe__
))

	)

334 
	#__exã∫_Æways_ölöe
 \

335 
__Æways_ölöe
 
	`__©åibuã__
 ((
__gnu_ölöe__
))

	)

337 
	#__exã∫_ölöe
 
__ölöe


	)

338 
	#__exã∫_Æways_ölöe
 
__Æways_ölöe


	)

342 #ifde‡
__exã∫_Æways_ölöe


343 
	#__f‹tify_fun˘i⁄
 
__exã∫_Æways_ölöe
 
__©åibuã_¨tificül__


	)

348 #i‡
__GNUC_PREREQ
 (4,3)

349 
	#__va_¨g_∑ck
(Ë
	`__buûtö_va_¨g_∑ck
 ()

	)

350 
	#__va_¨g_∑ck_Àn
(Ë
	`__buûtö_va_¨g_∑ck_Àn
 ()

	)

357 #i‡!
__GNUC_PREREQ
 (2,8)

358 
	#__exãnsi⁄__


	)

362 #i‡!
__GNUC_PREREQ
 (2,92)

363 
	#__ª°ri˘


	)

369 #i‡
__GNUC_PREREQ
 (3,1Ë&& !
deföed
 
__GNUG__


370 
	#__ª°ri˘_¨r
 
__ª°ri˘


	)

372 #ifde‡
__GNUC__


373 
	#__ª°ri˘_¨r


	)

375 #i‡
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

376 
	#__ª°ri˘_¨r
 
ª°ri˘


	)

379 
	#__ª°ri˘_¨r


	)

384 #i‡
__GNUC__
 >= 3

385 
	#__glibc_u∆ikñy
(
c⁄d
Ë
	`__buûtö_ex≥˘
((c⁄d), 0)

	)

386 
	#__glibc_likñy
(
c⁄d
Ë
	`__buûtö_ex≥˘
((c⁄d), 1)

	)

388 
	#__glibc_u∆ikñy
(
c⁄d
Ë(c⁄d)

	)

389 
	#__glibc_likñy
(
c⁄d
Ë(c⁄d)

	)

392 
	~<bôs/w‹dsize.h
>

394 #i‡
deföed
 
__LONG_DOUBLE_MATH_OPTIONAL
 && deföed 
__NO_LONG_DOUBLE_MATH


395 
	#__LDBL_COMPAT
 1

	)

396 #ifde‡
__REDIRECT


397 
	#__LDBL_REDIR1
(
«me
, 
¥Ÿo
, 
Æüs
Ë
	`__REDIRECT
 («me,ÖrŸo,álüs)

	)

398 
	#__LDBL_REDIR
(
«me
, 
¥Ÿo
) \

399 
	`__LDBL_REDIR1
 (
«me
, 
¥Ÿo
, 
__∆dbl_
##«me)

	)

400 
	#__LDBL_REDIR1_NTH
(
«me
, 
¥Ÿo
, 
Æüs
Ë
	`__REDIRECT_NTH
 («me,ÖrŸo,álüs)

	)

401 
	#__LDBL_REDIR_NTH
(
«me
, 
¥Ÿo
) \

402 
	`__LDBL_REDIR1_NTH
 (
«me
, 
¥Ÿo
, 
__∆dbl_
##«me)

	)

403 
	#__LDBL_REDIR1_DECL
(
«me
, 
Æüs
) \

404 
	`__ty≥of
 (
«me
Ë«mê
	`__asm
 (
	`__ASMNAME
 (#Æüs));

	)

405 
	#__LDBL_REDIR_DECL
(
«me
) \

406 
	`__ty≥of
 (
«me
Ë«mê
	`__asm
 (
	`__ASMNAME
 ("__∆dbl_" #«me));

	)

407 
	#__REDIRECT_LDBL
(
«me
, 
¥Ÿo
, 
Æüs
) \

408 
	`__LDBL_REDIR1
 (
«me
, 
¥Ÿo
, 
__∆dbl_
##
Æüs
)

	)

409 
	#__REDIRECT_NTH_LDBL
(
«me
, 
¥Ÿo
, 
Æüs
) \

410 
	`__LDBL_REDIR1_NTH
 (
«me
, 
¥Ÿo
, 
__∆dbl_
##
Æüs
)

	)

413 #i‡!
deföed
 
__LDBL_COMPAT
 || !deföed 
__REDIRECT


414 
	#__LDBL_REDIR1
(
«me
, 
¥Ÿo
, 
Æüs
Ë«mê
	)
proto

415 
	#__LDBL_REDIR
(
«me
, 
¥Ÿo
Ë«mê
	)
proto

416 
	#__LDBL_REDIR1_NTH
(
«me
, 
¥Ÿo
, 
Æüs
Ë«mê¥Ÿÿ
__THROW


	)

417 
	#__LDBL_REDIR_NTH
(
«me
, 
¥Ÿo
Ë«mê¥Ÿÿ
__THROW


	)

418 
	#__LDBL_REDIR_DECL
(
«me
)

	)

419 #ifde‡
__REDIRECT


420 
	#__REDIRECT_LDBL
(
«me
, 
¥Ÿo
, 
Æüs
Ë
	`__REDIRECT
 («me,ÖrŸo,álüs)

	)

421 
	#__REDIRECT_NTH_LDBL
(
«me
, 
¥Ÿo
, 
Æüs
) \

422 
	`__REDIRECT_NTH
 (
«me
, 
¥Ÿo
, 
Æüs
)

	)

	@/usr/include/alloca.h

18 #i‚def 
_ALLOCA_H


19 
	#_ALLOCA_H
 1

	)

21 
	~<„©uªs.h
>

23 
	#__√ed_size_t


	)

24 
	~<°ddef.h
>

26 
	g__BEGIN_DECLS


29 #unde‡
Æloˇ


32 *
	$Æloˇ
 (
size_t
 
__size
Ë
__THROW
;

34 #ifdef 
__GNUC__


35 
	#Æloˇ
(
size
Ë
	`__buûtö_Æloˇ
 (size)

	)

38 
__END_DECLS


	@/usr/include/asm-generic/posix_types.h

1 #i‚de‡
__ASM_GENERIC_POSIX_TYPES_H


2 
	#__ASM_GENERIC_POSIX_TYPES_H


	)

4 
	~<asm/bô•îl⁄g.h
>

13 #i‚de‡
__kî√l_l⁄g_t


14 
	t__kî√l_l⁄g_t
;

15 
	t__kî√l_ul⁄g_t
;

18 #i‚de‡
__kî√l_öo_t


19 
__kî√l_ul⁄g_t
 
	t__kî√l_öo_t
;

22 #i‚de‡
__kî√l_mode_t


23 
	t__kî√l_mode_t
;

26 #i‚de‡
__kî√l_pid_t


27 
	t__kî√l_pid_t
;

30 #i‚de‡
__kî√l_ùc_pid_t


31 
	t__kî√l_ùc_pid_t
;

34 #i‚de‡
__kî√l_uid_t


35 
	t__kî√l_uid_t
;

36 
	t__kî√l_gid_t
;

39 #i‚de‡
__kî√l_su£c⁄ds_t


40 
__kî√l_l⁄g_t
 
	t__kî√l_su£c⁄ds_t
;

43 #i‚de‡
__kî√l_daddr_t


44 
	t__kî√l_daddr_t
;

47 #i‚de‡
__kî√l_uid32_t


48 
	t__kî√l_uid32_t
;

49 
	t__kî√l_gid32_t
;

52 #i‚de‡
__kî√l_ﬁd_uid_t


53 
__kî√l_uid_t
 
	t__kî√l_ﬁd_uid_t
;

54 
__kî√l_gid_t
 
	t__kî√l_ﬁd_gid_t
;

57 #i‚de‡
__kî√l_ﬁd_dev_t


58 
	t__kî√l_ﬁd_dev_t
;

65 #i‚de‡
__kî√l_size_t


66 #i‡
__BITS_PER_LONG
 != 64

67 
	t__kî√l_size_t
;

68 
	t__kî√l_ssize_t
;

69 
	t__kî√l_±rdiff_t
;

71 
__kî√l_ul⁄g_t
 
	t__kî√l_size_t
;

72 
__kî√l_l⁄g_t
 
	t__kî√l_ssize_t
;

73 
__kî√l_l⁄g_t
 
	t__kî√l_±rdiff_t
;

77 #i‚de‡
__kî√l_fsid_t


79 
	mvÆ
[2];

80 } 
	t__kî√l_fsid_t
;

86 
__kî√l_l⁄g_t
 
	t__kî√l_off_t
;

87 
	t__kî√l_loff_t
;

88 
__kî√l_l⁄g_t
 
	t__kî√l_time_t
;

89 
__kî√l_l⁄g_t
 
	t__kî√l_˛ock_t
;

90 
	t__kî√l_timî_t
;

91 
	t__kî√l_˛ockid_t
;

92 * 
	t__kî√l_ˇddr_t
;

93 
	t__kî√l_uid16_t
;

94 
	t__kî√l_gid16_t
;

	@/usr/include/asm/bitsperlong.h

1 #i‚de‡
__ASM_X86_BITSPERLONG_H


2 
	#__ASM_X86_BITSPERLONG_H


	)

4 #ifde‡
__x86_64__


5 
	#__BITS_PER_LONG
 64

	)

7 
	#__BITS_PER_LONG
 32

	)

10 
	~<asm-gíîic/bô•îl⁄g.h
>

	@/usr/include/bits/byteswap.h

19 #i‡!
deföed
 
_BYTESWAP_H
 && !deföed 
_NETINET_IN_H
 && !deföed 
_ENDIAN_H


23 #i‚de‡
_BITS_BYTESWAP_H


24 
	#_BITS_BYTESWAP_H
 1

	)

26 
	~<„©uªs.h
>

27 
	~<bôs/ty≥s.h
>

28 
	~<bôs/w‹dsize.h
>

31 
	#__bsw≠_c⁄°™t_16
(
x
) \

32 ((Ë((((
x
Ë>> 8Ë& 0xffË| (((xË& 0xffË<< 8)))

	)

35 
	~<bôs/byãsw≠-16.h
>

38 
	#__bsw≠_c⁄°™t_32
(
x
) \

39 ((((
x
) & 0xff000000) >> 24) | (((x) & 0x00ff0000) >> 8) | \

40 (((
x
Ë& 0x0000ff00Ë<< 8Ë| (((xË& 0x000000ffË<< 24))

	)

42 #ifde‡
__GNUC__


43 #i‡
__GNUC_PREREQ
 (4, 3)

44 
__ölöe
 

45 
	$__bsw≠_32
 (
__bsx
)

47  
	`__buûtö_bsw≠32
 (
__bsx
);

48 
	}
}

49 #ñi‡
__GNUC__
 >= 2

50 #i‡
__WORDSIZE
 =64 || (
deföed
 
__i486__
 || deföed 
__≥¡ium__
 \

51 || 
deföed
 
	g__≥¡ium¥o__
 || deföed 
	g__≥¡ium4__
 \

52 || 
deföed
 
	g__k8__
 || deföed 
	g__©hl⁄__
 \

53 || 
deföed
 
	g__k6__
 || deföed 
	g__noc⁄a__
 \

54 || 
deföed
 
	g__c‹e2__
 || deföed 
	g__geode__
 \

55 || 
deföed
 
	g__amdÁm10__
)

58 
	#__bsw≠_32
(
x
) \

59 (
__exãnsi⁄__
 \

60 ({ 
__v
, 
__x
 = (
x
); \

61 i‡(
	`__buûtö_c⁄°™t_p
 (
__x
)) \

62 
__v
 = 
	`__bsw≠_c⁄°™t_32
 (
__x
); \

64 
	`__asm__
 ("bsw≠ %0" : "Ù" (
__v
Ë: "0" (
__x
)); \

65 
__v
; }))

	)

67 
	#__bsw≠_32
(
x
) \

68 (
__exãnsi⁄__
 \

69 ({ 
__v
, 
__x
 = (
x
); \

70 i‡(
	`__buûtö_c⁄°™t_p
 (
__x
)) \

71 
__v
 = 
	`__bsw≠_c⁄°™t_32
 (
__x
); \

73 
	`__asm__
 ("rorw $8, %w0;" \

76 : "Ù" (
__v
) \

77 : "0" (
__x
) \

79 
__v
; }))

	)

82 
	#__bsw≠_32
(
x
) \

83 (
__exãnsi⁄__
 \

84 ({ 
__x
 = (
x
); 
	`__bsw≠_c⁄°™t_32
 (__x); }))

	)

87 
__ölöe
 

88 
	$__bsw≠_32
 (
__bsx
)

90  
	`__bsw≠_c⁄°™t_32
 (
__bsx
);

91 
	}
}

95 #i‡
__GNUC_PREREQ
 (2, 0)

97 
	#__bsw≠_c⁄°™t_64
(
x
) \

98 (
	`__exãnsi⁄__
 ((((
x
) & 0xff00000000000000ull) >> 56) \

99 | (((
x
) & 0x00ff000000000000ull) >> 40) \

100 | (((
x
) & 0x0000ff0000000000ull) >> 24) \

101 | (((
x
) & 0x000000ff00000000ull) >> 8) \

102 | (((
x
) & 0x00000000ff000000ull) << 8) \

103 | (((
x
) & 0x0000000000ff0000ull) << 24) \

104 | (((
x
) & 0x000000000000ff00ull) << 40) \

105 | (((
x
Ë& 0x00000000000000ffuŒË<< 56)))

	)

107 #i‡
__GNUC_PREREQ
 (4, 3)

108 
__ölöe
 
__uöt64_t


109 
	$__bsw≠_64
 (
__uöt64_t
 
__bsx
)

111  
	`__buûtö_bsw≠64
 (
__bsx
);

112 
	}
}

113 #ñi‡
__WORDSIZE
 == 64

114 
	#__bsw≠_64
(
x
) \

115 (
__exãnsi⁄__
 \

116 ({ 
__uöt64_t
 
__v
, 
__x
 = (
x
); \

117 i‡(
	`__buûtö_c⁄°™t_p
 (
__x
)) \

118 
__v
 = 
	`__bsw≠_c⁄°™t_64
 (
__x
); \

120 
	`__asm__
 ("bsw≠ %q0" : "Ù" (
__v
Ë: "0" (
__x
)); \

121 
__v
; }))

	)

123 
	#__bsw≠_64
(
x
) \

124 (
__exãnsi⁄__
 \

125 ({ uni⁄ { 
__exãnsi⁄__
 
__uöt64_t
 
__Œ
; \

126 
__l
[2]; } 
__w
, 
__r
; \

127 i‡(
	`__buûtö_c⁄°™t_p
 (
x
)) \

128 
__r
.
__Œ
 = 
	`__bsw≠_c⁄°™t_64
 (
x
); \

131 
__w
.
__Œ
 = (
x
); \

132 
__r
.
__l
[0] = 
	`__bsw≠_32
 (
__w
.__l[1]); \

133 
__r
.
__l
[1] = 
	`__bsw≠_32
 (
__w
.__l[0]); \

135 
__r
.
__Œ
; }))

	)

137 #ñi‡
__GLIBC_HAVE_LONG_LONG


138 
	#__bsw≠_c⁄°™t_64
(
x
) \

139 ((((
x
) & 0xff00000000000000ull) >> 56) \

140 | (((
x
) & 0x00ff000000000000ull) >> 40) \

141 | (((
x
) & 0x0000ff0000000000ull) >> 24) \

142 | (((
x
) & 0x000000ff00000000ull) >> 8) \

143 | (((
x
) & 0x00000000ff000000ull) << 8) \

144 | (((
x
) & 0x0000000000ff0000ull) << 24) \

145 | (((
x
) & 0x000000000000ff00ull) << 40) \

146 | (((
x
Ë& 0x00000000000000ffuŒË<< 56))

	)

148 
__ölöe
 
__uöt64_t


149 
	$__bsw≠_64
 (
__uöt64_t
 
__bsx
)

151  
	`__bsw≠_c⁄°™t_64
 (
__bsx
);

152 
	}
}

	@/usr/include/bits/endian.h

3 #i‚de‡
_ENDIAN_H


7 
	#__BYTE_ORDER
 
__LITTLE_ENDIAN


	)

	@/usr/include/bits/stdlib-float.h

19 #i‚de‡
_STDLIB_H


23 #ifde‡
__USE_EXTERN_INLINES


24 
__BEGIN_NAMESPACE_STD


25 
__exã∫_ölöe
 

26 
__NTH
 (
	$©of
 (c⁄° *
__≈å
))

28  
	`°πod
 (
__≈å
, (**Ë
NULL
);

29 
	}
}

30 
	g__END_NAMESPACE_STD


	@/usr/include/bits/stdlib-ldbl.h

19 #i‚de‡
_STDLIB_H


23 #ifdef 
__USE_ISOC99


24 
__BEGIN_NAMESPACE_C99


25 
	$__LDBL_REDIR1_DECL
 (
°πﬁd
, 
°πod
)

26 
__END_NAMESPACE_C99


29 #ifde‡
__USE_GNU


30 
	$__LDBL_REDIR1_DECL
 (
°πﬁd_l
, 
°πod_l
)

33 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_XOPEN_EXTENDED


34 #ifde‡
__USE_MISC


35 
	$__LDBL_REDIR1_DECL
 (
qecvt
, 
ecvt
)

36 
	$__LDBL_REDIR1_DECL
 (
qfcvt
, 
fcvt
)

37 
	$__LDBL_REDIR1_DECL
 (
qgcvt
, 
gcvt
)

38 
	$__LDBL_REDIR1_DECL
 (
qecvt_r
, 
ecvt_r
)

39 
	$__LDBL_REDIR1_DECL
 (
qfcvt_r
, 
fcvt_r
)

	@/usr/include/bits/stdlib.h

19 #i‚de‡
_STDLIB_H


23 *
	$__ªÆ∑th_chk
 (c⁄° *
__ª°ri˘
 
__«me
,

24 *
__ª°ri˘
 
__ªsﬁved
,

25 
size_t
 
__ªsﬁvedÀn
Ë
__THROW
 
__wur
;

26 *
	`__REDIRECT_NTH
 (
__ªÆ∑th_Æüs
,

27 (c⁄° *
__ª°ri˘
 
__«me
,

28 *
__ª°ri˘
 
__ªsﬁved
), 
ªÆ∑th
Ë
__wur
;

29 *
	`__REDIRECT_NTH
 (
__ªÆ∑th_chk_w¨n
,

30 (c⁄° *
__ª°ri˘
 
__«me
,

31 *
__ª°ri˘
 
__ªsﬁved
,

32 
size_t
 
__ªsﬁvedÀn
), 
__ªÆ∑th_chk
Ë
__wur


33 
	`__w¨«âr
 ("secondárgument ofÑealpath must beÉither NULL orát "

36 
__f‹tify_fun˘i⁄
 
__wur
 *

37 
	`__NTH
 (
	$ªÆ∑th
 (c⁄° *
__ª°ri˘
 
__«me
, *__ª°ri˘ 
__ªsﬁved
))

39 i‡(
	`__bos
 (
__ªsﬁved
Ë!(
size_t
) -1)

41 #i‡
deföed
 
_LIBC_LIMITS_H_
 && deföed 
PATH_MAX


42 i‡(
	`__bos
 (
__ªsﬁved
Ë< 
PATH_MAX
)

43  
	`__ªÆ∑th_chk_w¨n
 (
__«me
, 
__ªsﬁved
, 
	`__bos
 (__resolved));

45  
	`__ªÆ∑th_chk
 (
__«me
, 
__ªsﬁved
, 
	`__bos
 (__resolved));

48  
	`__ªÆ∑th_Æüs
 (
__«me
, 
__ªsﬁved
);

49 
	}
}

52 
	$__±¢ame_r_chk
 (
__fd
, *
__buf
, 
size_t
 
__buÊí
,

53 
size_t
 
__ƒól
Ë
__THROW
 
	`__n⁄nuŒ
 ((2));

54 
	`__REDIRECT_NTH
 (
__±¢ame_r_Æüs
, (
__fd
, *
__buf
,

55 
size_t
 
__buÊí
), 
±¢ame_r
)

56 
	`__n⁄nuŒ
 ((2));

57 
	`__REDIRECT_NTH
 (
__±¢ame_r_chk_w¨n
,

58 (
__fd
, *
__buf
, 
size_t
 
__buÊí
,

59 
size_t
 
__ƒól
), 
__±¢ame_r_chk
)

60 
	`__n⁄nuŒ
 ((2)Ë
	`__w¨«âr
 ("ptsname_r called with buflen biggerÅhan "

63 
__f‹tify_fun˘i⁄
 

64 
	`__NTH
 (
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buÊí
))

66 i‡(
	`__bos
 (
__buf
Ë!(
size_t
) -1)

68 i‡(!
	`__buûtö_c⁄°™t_p
 (
__buÊí
))

69  
	`__±¢ame_r_chk
 (
__fd
, 
__buf
, 
__buÊí
, 
	`__bos
 (__buf));

70 i‡(
__buÊí
 > 
	`__bos
 (
__buf
))

71  
	`__±¢ame_r_chk_w¨n
 (
__fd
, 
__buf
, 
__buÊí
, 
	`__bos
 (__buf));

73  
	`__±¢ame_r_Æüs
 (
__fd
, 
__buf
, 
__buÊí
);

74 
	}
}

77 
	$__w˘omb_chk
 (*
__s
, 
wch¨_t
 
__wch¨
, 
size_t
 
__buÊí
)

78 
__THROW
 
__wur
;

79 
	`__REDIRECT_NTH
 (
__w˘omb_Æüs
, (*
__s
, 
wch¨_t
 
__wch¨
),

80 
w˘omb
Ë
__wur
;

82 
__f‹tify_fun˘i⁄
 
__wur
 

83 
	`__NTH
 (
	$w˘omb
 (*
__s
, 
wch¨_t
 
__wch¨
))

88 
	#__STDLIB_MB_LEN_MAX
 16

	)

89 #i‡
deföed
 
MB_LEN_MAX
 && MB_LEN_MAX !
__STDLIB_MB_LEN_MAX


92 i‡(
	`__bos
 (
__s
Ë!(
size_t
Ë-1 && 
__STDLIB_MB_LEN_MAX
 > __bos (__s))

93  
	`__w˘omb_chk
 (
__s
, 
__wch¨
, 
	`__bos
 (__s));

94  
	`__w˘omb_Æüs
 (
__s
, 
__wch¨
);

95 
	}
}

98 
size_t
 
	$__mb°owcs_chk
 (
wch¨_t
 *
__ª°ri˘
 
__d°
,

99 c⁄° *
__ª°ri˘
 
__§c
,

100 
size_t
 
__Àn
, size_à
__d°Àn
Ë
__THROW
;

101 
size_t
 
	`__REDIRECT_NTH
 (
__mb°owcs_Æüs
,

102 (
wch¨_t
 *
__ª°ri˘
 
__d°
,

103 c⁄° *
__ª°ri˘
 
__§c
,

104 
size_t
 
__Àn
), 
mb°owcs
);

105 
size_t
 
	`__REDIRECT_NTH
 (
__mb°owcs_chk_w¨n
,

106 (
wch¨_t
 *
__ª°ri˘
 
__d°
,

107 c⁄° *
__ª°ri˘
 
__§c
,

108 
size_t
 
__Àn
, size_à
__d°Àn
), 
__mb°owcs_chk
)

109 
	`__w¨«âr
 ("mbstowcs called with dst buffer smallerÅhanÜen "

112 
__f‹tify_fun˘i⁄
 
size_t


113 
	`__NTH
 (
	$mb°owcs
 (
wch¨_t
 *
__ª°ri˘
 
__d°
, c⁄° *__ª°ri˘ 
__§c
,

114 
size_t
 
__Àn
))

116 i‡(
	`__bos
 (
__d°
Ë!(
size_t
) -1)

118 i‡(!
	`__buûtö_c⁄°™t_p
 (
__Àn
))

119  
	`__mb°owcs_chk
 (
__d°
, 
__§c
, 
__Àn
,

120 
	`__bos
 (
__d°
Ë/  (
wch¨_t
));

122 i‡(
__Àn
 > 
	`__bos
 (
__d°
Ë/  (
wch¨_t
))

123  
	`__mb°owcs_chk_w¨n
 (
__d°
, 
__§c
, 
__Àn
,

124 
	`__bos
 (
__d°
Ë/  (
wch¨_t
));

126  
	`__mb°owcs_Æüs
 (
__d°
, 
__§c
, 
__Àn
);

127 
	}
}

130 
size_t
 
	$__wc°ombs_chk
 (*
__ª°ri˘
 
__d°
,

131 c⁄° 
wch¨_t
 *
__ª°ri˘
 
__§c
,

132 
size_t
 
__Àn
, size_à
__d°Àn
Ë
__THROW
;

133 
size_t
 
	`__REDIRECT_NTH
 (
__wc°ombs_Æüs
,

134 (*
__ª°ri˘
 
__d°
,

135 c⁄° 
wch¨_t
 *
__ª°ri˘
 
__§c
,

136 
size_t
 
__Àn
), 
wc°ombs
);

137 
size_t
 
	`__REDIRECT_NTH
 (
__wc°ombs_chk_w¨n
,

138 (*
__ª°ri˘
 
__d°
,

139 c⁄° 
wch¨_t
 *
__ª°ri˘
 
__§c
,

140 
size_t
 
__Àn
, size_à
__d°Àn
), 
__wc°ombs_chk
)

141 
	`__w¨«âr
 ("wcstombs called with dst buffer smallerÅhanÜen");

143 
__f‹tify_fun˘i⁄
 
size_t


144 
	`__NTH
 (
	$wc°ombs
 (*
__ª°ri˘
 
__d°
, c⁄° 
wch¨_t
 *__ª°ri˘ 
__§c
,

145 
size_t
 
__Àn
))

147 i‡(
	`__bos
 (
__d°
Ë!(
size_t
) -1)

149 i‡(!
	`__buûtö_c⁄°™t_p
 (
__Àn
))

150  
	`__wc°ombs_chk
 (
__d°
, 
__§c
, 
__Àn
, 
	`__bos
 (__dst));

151 i‡(
__Àn
 > 
	`__bos
 (
__d°
))

152  
	`__wc°ombs_chk_w¨n
 (
__d°
, 
__§c
, 
__Àn
, 
	`__bos
 (__dst));

154  
	`__wc°ombs_Æüs
 (
__d°
, 
__§c
, 
__Àn
);

155 
	}
}

	@/usr/include/bits/typesizes.h

19 #i‚de‡
_BITS_TYPES_H


23 #i‚def 
_BITS_TYPESIZES_H


24 
	#_BITS_TYPESIZES_H
 1

	)

30 #i‡
deföed
 
__x86_64__
 && deföed 
__ILP32__


31 
	#__SYSCALL_SLONG_TYPE
 
__SQUAD_TYPE


	)

32 
	#__SYSCALL_ULONG_TYPE
 
__UQUAD_TYPE


	)

34 
	#__SYSCALL_SLONG_TYPE
 
__SLONGWORD_TYPE


	)

35 
	#__SYSCALL_ULONG_TYPE
 
__ULONGWORD_TYPE


	)

38 
	#__DEV_T_TYPE
 
__UQUAD_TYPE


	)

39 
	#__UID_T_TYPE
 
__U32_TYPE


	)

40 
	#__GID_T_TYPE
 
__U32_TYPE


	)

41 
	#__INO_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

42 
	#__INO64_T_TYPE
 
__UQUAD_TYPE


	)

43 
	#__MODE_T_TYPE
 
__U32_TYPE


	)

44 #ifde‡
__x86_64__


45 
	#__NLINK_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

46 
	#__FSWORD_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

48 
	#__NLINK_T_TYPE
 
__UWORD_TYPE


	)

49 
	#__FSWORD_T_TYPE
 
__SWORD_TYPE


	)

51 
	#__OFF_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

52 
	#__OFF64_T_TYPE
 
__SQUAD_TYPE


	)

53 
	#__PID_T_TYPE
 
__S32_TYPE


	)

54 
	#__RLIM_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

55 
	#__RLIM64_T_TYPE
 
__UQUAD_TYPE


	)

56 
	#__BLKCNT_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

57 
	#__BLKCNT64_T_TYPE
 
__SQUAD_TYPE


	)

58 
	#__FSBLKCNT_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

59 
	#__FSBLKCNT64_T_TYPE
 
__UQUAD_TYPE


	)

60 
	#__FSFILCNT_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

61 
	#__FSFILCNT64_T_TYPE
 
__UQUAD_TYPE


	)

62 
	#__ID_T_TYPE
 
__U32_TYPE


	)

63 
	#__CLOCK_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

64 
	#__TIME_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

65 
	#__USECONDS_T_TYPE
 
__U32_TYPE


	)

66 
	#__SUSECONDS_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

67 
	#__DADDR_T_TYPE
 
__S32_TYPE


	)

68 
	#__KEY_T_TYPE
 
__S32_TYPE


	)

69 
	#__CLOCKID_T_TYPE
 
__S32_TYPE


	)

70 
	#__TIMER_T_TYPE
 *

	)

71 
	#__BLKSIZE_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

72 
	#__FSID_T_TYPE
 såu˘ { 
__vÆ
[2]; }

	)

73 
	#__SSIZE_T_TYPE
 
__SWORD_TYPE


	)

75 #ifde‡
__x86_64__


79 
	#__OFF_T_MATCHES_OFF64_T
 1

	)

82 
	#__INO_T_MATCHES_INO64_T
 1

	)

86 
	#__FD_SETSIZE
 1024

	)

	@/usr/include/bits/waitflags.h

19 #i‡!
deföed
 
_SYS_WAIT_H
 && !deföed 
_STDLIB_H


25 
	#WNOHANG
 1

	)

26 
	#WUNTRACED
 2

	)

29 
	#WSTOPPED
 2

	)

30 
	#WEXITED
 4

	)

31 
	#WCONTINUED
 8

	)

32 
	#WNOWAIT
 0x01000000

	)

34 
	#__WNOTHREAD
 0x20000000

	)

36 
	#__WALL
 0x40000000

	)

37 
	#__WCLONE
 0x80000000

	)

	@/usr/include/bits/waitstatus.h

19 #i‡!
deföed
 
_SYS_WAIT_H
 && !deföed 
_STDLIB_H


28 
	#__WEXITSTATUS
(
°©us
Ë(((°©usË& 0xff00Ë>> 8)

	)

31 
	#__WTERMSIG
(
°©us
Ë((°©usË& 0x7f)

	)

34 
	#__WSTOPSIG
(
°©us
Ë
	`__WEXITSTATUS
(°©us)

	)

37 
	#__WIFEXITED
(
°©us
Ë(
	`__WTERMSIG
(°©usË=0)

	)

40 
	#__WIFSIGNALED
(
°©us
) \

41 (((sig√d Ë(((
°©us
Ë& 0x7fË+ 1Ë>> 1Ë> 0)

	)

44 
	#__WIFSTOPPED
(
°©us
Ë(((°©usË& 0xffË=0x7f)

	)

48 #ifde‡
WCONTINUED


49 
	#__WIFCONTINUED
(
°©us
Ë((°©usË=
__W_CONTINUED
)

	)

53 
	#__WCOREDUMP
(
°©us
Ë((°©usË& 
__WCOREFLAG
)

	)

56 
	#__W_EXITCODE
(
ªt
, 
sig
Ë(‘ëË<< 8 | (sig))

	)

57 
	#__W_STOPCODE
(
sig
Ë((sigË<< 8 | 0x7f)

	)

58 
	#__W_CONTINUED
 0xffff

	)

59 
	#__WCOREFLAG
 0x80

	)

62 #ifdef 
__USE_BSD


64 
	~<ídün.h
>

66 
	uwaô


68 
	mw_°©us
;

71 #if 
__BYTE_ORDER
 =
__LITTLE_ENDIAN


72 
	m__w_ãrmsig
:7;

73 
	m__w_c‹edump
:1;

74 
	m__w_ªtcode
:8;

77 #if 
__BYTE_ORDER
 =
__BIG_ENDIAN


79 
	m__w_ªtcode
:8;

80 
	m__w_c‹edump
:1;

81 
	m__w_ãrmsig
:7;

83 } 
	m__waô_ãrmö©ed
;

86 #if 
__BYTE_ORDER
 =
__LITTLE_ENDIAN


87 
	m__w_°›vÆ
:8;

88 
	m__w_°›sig
:8;

91 #if 
__BYTE_ORDER
 =
__BIG_ENDIAN


93 
	m__w_°›sig
:8;

94 
	m__w_°›vÆ
:8;

96 } 
	m__waô_°›≥d
;

99 
	#w_ãrmsig
 
__waô_ãrmö©ed
.
__w_ãrmsig


	)

100 
	#w_c‹edump
 
__waô_ãrmö©ed
.
__w_c‹edump


	)

101 
	#w_ªtcode
 
__waô_ãrmö©ed
.
__w_ªtcode


	)

102 
	#w_°›sig
 
__waô_°›≥d
.
__w_°›sig


	)

103 
	#w_°›vÆ
 
__waô_°›≥d
.
__w_°›vÆ


	)

	@/usr/include/bits/wordsize.h

3 #i‡
deföed
 
__x86_64__
 && !deföed 
__ILP32__


4 
	#__WORDSIZE
 64

	)

6 
	#__WORDSIZE
 32

	)

9 #ifde‡
__x86_64__


10 
	#__WORDSIZE_TIME64_COMPAT32
 1

	)

12 
	#__SYSCALL_WORDSIZE
 64

	)

	@/usr/include/gnu/stubs-64.h

6 #ifde‡
_LIBC


7 #îr‹ 
Aµliˇti⁄s
 
may
 
nŸ
 
deföe
 
the
 
ma¸o
 
_LIBC


10 
	#__°ub_bdÊush


	)

11 
	#__°ub_chÊags


	)

12 
	#__°ub_Áâach


	)

13 
	#__°ub_fchÊags


	)

14 
	#__°ub_fdëach


	)

15 
	#__°ub_gëmsg


	)

16 
	#__°ub_gây


	)

17 
	#__°ub_lchmod


	)

18 
	#__°ub_putmsg


	)

19 
	#__°ub_ªvoke


	)

20 
	#__°ub_£éogö


	)

21 
	#__°ub_sigªtu∫


	)

22 
	#__°ub_s°k


	)

23 
	#__°ub_°ty


	)

	@/usr/include/sys/types.h

22 #i‚def 
_SYS_TYPES_H


23 
	#_SYS_TYPES_H
 1

	)

25 
	~<„©uªs.h
>

27 
	g__BEGIN_DECLS


29 
	~<bôs/ty≥s.h
>

31 #ifdef 
__USE_BSD


32 #i‚de‡
__u_ch¨_deföed


33 
__u_ch¨
 
	tu_ch¨
;

34 
__u_sh‹t
 
	tu_sh‹t
;

35 
__u_öt
 
	tu_öt
;

36 
__u_l⁄g
 
	tu_l⁄g
;

37 
__quad_t
 
	tquad_t
;

38 
__u_quad_t
 
	tu_quad_t
;

39 
__fsid_t
 
	tfsid_t
;

40 
	#__u_ch¨_deföed


	)

44 
__loff_t
 
	tloff_t
;

46 #i‚de‡
__öo_t_deföed


47 #i‚de‡
__USE_FILE_OFFSET64


48 
__öo_t
 
	töo_t
;

50 
__öo64_t
 
	töo_t
;

52 
	#__öo_t_deföed


	)

54 #i‡
deföed
 
__USE_LARGEFILE64
 && !deföed 
__öo64_t_deföed


55 
__öo64_t
 
	töo64_t
;

56 
	#__öo64_t_deföed


	)

59 #i‚de‡
__dev_t_deföed


60 
__dev_t
 
	tdev_t
;

61 
	#__dev_t_deföed


	)

64 #i‚de‡
__gid_t_deföed


65 
__gid_t
 
	tgid_t
;

66 
	#__gid_t_deföed


	)

69 #i‚de‡
__mode_t_deföed


70 
__mode_t
 
	tmode_t
;

71 
	#__mode_t_deföed


	)

74 #i‚de‡
__∆ök_t_deföed


75 
__∆ök_t
 
	t∆ök_t
;

76 
	#__∆ök_t_deföed


	)

79 #i‚de‡
__uid_t_deföed


80 
__uid_t
 
	tuid_t
;

81 
	#__uid_t_deföed


	)

84 #i‚de‡
__off_t_deföed


85 #i‚de‡
__USE_FILE_OFFSET64


86 
__off_t
 
	toff_t
;

88 
__off64_t
 
	toff_t
;

90 
	#__off_t_deföed


	)

92 #i‡
deföed
 
__USE_LARGEFILE64
 && !deföed 
__off64_t_deföed


93 
__off64_t
 
	toff64_t
;

94 
	#__off64_t_deföed


	)

97 #i‚de‡
__pid_t_deföed


98 
__pid_t
 
	tpid_t
;

99 
	#__pid_t_deföed


	)

102 #i‡(
deföed
 
__USE_SVID
 || deföed 
__USE_XOPEN
 || deföed 
__USE_XOPEN2K8
) \

103 && !
deföed
 
__id_t_deföed


104 
__id_t
 
	tid_t
;

105 
	#__id_t_deföed


	)

108 #i‚de‡
__ssize_t_deföed


109 
__ssize_t
 
	tssize_t
;

110 
	#__ssize_t_deföed


	)

113 #ifdef 
__USE_BSD


114 #i‚de‡
__daddr_t_deföed


115 
__daddr_t
 
	tdaddr_t
;

116 
__ˇddr_t
 
	tˇddr_t
;

117 
	#__daddr_t_deföed


	)

121 #i‡(
deföed
 
__USE_SVID
 || deföed 
__USE_XOPEN
Ë&& !deföed 
__key_t_deföed


122 
__key_t
 
	tkey_t
;

123 
	#__key_t_deföed


	)

126 #i‡
deföed
 
__USE_XOPEN
 || deföed 
__USE_XOPEN2K8


127 
	#__√ed_˛ock_t


	)

129 
	#__√ed_time_t


	)

130 
	#__√ed_timî_t


	)

131 
	#__√ed_˛ockid_t


	)

132 
	~<time.h
>

134 #ifde‡
__USE_XOPEN


135 #i‚de‡
__u£c⁄ds_t_deföed


136 
__u£c⁄ds_t
 
	tu£c⁄ds_t
;

137 
	#__u£c⁄ds_t_deföed


	)

139 #i‚de‡
__su£c⁄ds_t_deföed


140 
__su£c⁄ds_t
 
	tsu£c⁄ds_t
;

141 
	#__su£c⁄ds_t_deföed


	)

145 
	#__√ed_size_t


	)

146 
	~<°ddef.h
>

148 #ifde‡
__USE_MISC


150 
	tul⁄g
;

151 
	tush‹t
;

152 
	tuöt
;

157 #i‡!
__GNUC_PREREQ
 (2, 7)

160 #i‚de‡
__öt8_t_deföed


161 
	#__öt8_t_deföed


	)

162 
	töt8_t
;

163 
	töt16_t
;

164 
	töt32_t
;

165 #i‡
__WORDSIZE
 == 64

166 
	töt64_t
;

167 #ñi‡
__GLIBC_HAVE_LONG_LONG


168 
__exãnsi⁄__
 
	töt64_t
;

173 
	tu_öt8_t
;

174 
	tu_öt16_t
;

175 
	tu_öt32_t
;

176 #i‡
__WORDSIZE
 == 64

177 
	tu_öt64_t
;

178 #ñi‡
__GLIBC_HAVE_LONG_LONG


179 
__exãnsi⁄__
 
	tu_öt64_t
;

182 
	tªgi°î_t
;

187 
	#__ötN_t
(
N
, 
MODE
) \

188 ##
	tN
##
	t_t
 
	t__©åibuã__
 ((
	t__mode__
 (
	tMODE
)))

	)

189 
	t__u_ötN_t
(
	tN
, 
	tMODE
) \

190 
	tu_öt
##
	tN
##
	t_t
 
	t__©åibuã__
 ((
	t__mode__
 (
	tMODE
)))

	)

192 #i‚de‡
	t__öt8_t_deföed


193 
	t__öt8_t_deföed


	)

194 
	t__ötN_t
 (8, 
	t__QI__
);

195 
__ötN_t
 (16, 
__HI__
);

196 
__ötN_t
 (32, 
__SI__
);

197 
__ötN_t
 (64, 
__DI__
);

200 
__u_ötN_t
 (8, 
__QI__
);

201 
__u_ötN_t
 (16, 
__HI__
);

202 
__u_ötN_t
 (32, 
__SI__
);

203 
__u_ötN_t
 (64, 
__DI__
);

205 
	tªgi°î_t
 
	t__©åibuã__
 ((
	t__mode__
 (
	t__w‹d__
)));

211 
	#__BIT_TYPES_DEFINED__
 1

	)

214 #ifdef 
__USE_BSD


216 
	~<ídün.h
>

219 
	~<sys/£À˘.h
>

222 
	~<sys/sysma¸os.h
>

226 #i‡(
deföed
 
__USE_UNIX98
 || deföed 
__USE_XOPEN2K8
) \

227 && !
deföed
 
__blksize_t_deföed


228 
__blksize_t
 
	tblksize_t
;

229 
	#__blksize_t_deföed


	)

233 #i‚de‡
__USE_FILE_OFFSET64


234 #i‚de‡
__blk˙t_t_deföed


235 
__blk˙t_t
 
	tblk˙t_t
;

236 
	#__blk˙t_t_deföed


	)

238 #i‚de‡
__fsblk˙t_t_deföed


239 
__fsblk˙t_t
 
	tfsblk˙t_t
;

240 
	#__fsblk˙t_t_deföed


	)

242 #i‚de‡
__fsfû˙t_t_deföed


243 
__fsfû˙t_t
 
	tfsfû˙t_t
;

244 
	#__fsfû˙t_t_deföed


	)

247 #i‚de‡
__blk˙t_t_deföed


248 
__blk˙t64_t
 
	tblk˙t_t
;

249 
	#__blk˙t_t_deföed


	)

251 #i‚de‡
__fsblk˙t_t_deföed


252 
__fsblk˙t64_t
 
	tfsblk˙t_t
;

253 
	#__fsblk˙t_t_deföed


	)

255 #i‚de‡
__fsfû˙t_t_deföed


256 
__fsfû˙t64_t
 
	tfsfû˙t_t
;

257 
	#__fsfû˙t_t_deföed


	)

261 #ifde‡
__USE_LARGEFILE64


262 
__blk˙t64_t
 
	tblk˙t64_t
;

263 
__fsblk˙t64_t
 
	tfsblk˙t64_t
;

264 
__fsfû˙t64_t
 
	tfsfû˙t64_t
;

269 #i‡
deföed
 
__USE_POSIX199506
 || deföed 
__USE_UNIX98


270 
	~<bôs/±hªadty≥s.h
>

273 
	g__END_DECLS


	@/usr/include/asm-generic/bitsperlong.h

1 #i‚de‡
__ASM_GENERIC_BITS_PER_LONG


2 
	#__ASM_GENERIC_BITS_PER_LONG


	)

11 #i‚de‡
__BITS_PER_LONG


12 
	#__BITS_PER_LONG
 32

	)

	@/usr/include/bits/byteswap-16.h

19 #i‚de‡
_BITS_BYTESWAP_H


23 #ifde‡
__GNUC__


24 #i‡
__GNUC__
 >= 2

25 
	#__bsw≠_16
(
x
) \

26 (
__exãnsi⁄__
 \

27 ({ 
__v
, 
__x
 = (Ë(
x
); \

28 i‡(
	`__buûtö_c⁄°™t_p
 (
__x
)) \

29 
__v
 = 
	`__bsw≠_c⁄°™t_16
 (
__x
); \

31 
	`__asm__
 ("rorw $8, %w0" \

32 : "Ù" (
__v
) \

33 : "0" (
__x
) \

35 
__v
; }))

	)

38 
	#__bsw≠_16
(
x
) \

39 (
__exãnsi⁄__
 \

40 ({ 
__x
 = (Ë(
x
); \

41 
	`__bsw≠_c⁄°™t_16
 (
__x
); }))

	)

44 
__ölöe
 

45 
	$__bsw≠_16
 (
__bsx
)

47  
	`__bsw≠_c⁄°™t_16
 (
__bsx
);

48 
	}
}

	@/usr/include/bits/pthreadtypes.h

18 #i‚de‡
_BITS_PTHREADTYPES_H


19 
	#_BITS_PTHREADTYPES_H
 1

	)

21 
	~<bôs/w‹dsize.h
>

23 #ifde‡
__x86_64__


24 #i‡
__WORDSIZE
 == 64

25 
	#__SIZEOF_PTHREAD_ATTR_T
 56

	)

26 
	#__SIZEOF_PTHREAD_MUTEX_T
 40

	)

27 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

28 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

29 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

30 
	#__SIZEOF_PTHREAD_RWLOCK_T
 56

	)

31 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

32 
	#__SIZEOF_PTHREAD_BARRIER_T
 32

	)

33 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

35 
	#__SIZEOF_PTHREAD_ATTR_T
 32

	)

36 
	#__SIZEOF_PTHREAD_MUTEX_T
 32

	)

37 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

38 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

39 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

40 
	#__SIZEOF_PTHREAD_RWLOCK_T
 44

	)

41 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

42 
	#__SIZEOF_PTHREAD_BARRIER_T
 20

	)

43 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

46 
	#__SIZEOF_PTHREAD_ATTR_T
 36

	)

47 
	#__SIZEOF_PTHREAD_MUTEX_T
 24

	)

48 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

49 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

50 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

51 
	#__SIZEOF_PTHREAD_RWLOCK_T
 32

	)

52 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

53 
	#__SIZEOF_PTHREAD_BARRIER_T
 20

	)

54 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

60 
	t±hªad_t
;

63 
	u±hªad_©å_t


65 
	m__size
[
__SIZEOF_PTHREAD_ATTR_T
];

66 
	m__Æign
;

68 #i‚de‡
__have_±hªad_©å_t


69 
±hªad_©å_t
 
	t±hªad_©å_t
;

70 
	#__have_±hªad_©å_t
 1

	)

74 #ifde‡
__x86_64__


75 
	s__±hªad_öã∫Æ_li°


77 
__±hªad_öã∫Æ_li°
 *
	m__¥ev
;

78 
__±hªad_öã∫Æ_li°
 *
	m__√xt
;

79 } 
	t__±hªad_li°_t
;

81 
	s__±hªad_öã∫Æ_¶i°


83 
__±hªad_öã∫Æ_¶i°
 *
	m__√xt
;

84 } 
	t__±hªad_¶i°_t
;

92 
	s__±hªad_muãx_s


94 
	m__lock
;

95 
	m__cou¡
;

96 
	m__ow√r
;

97 #ifde‡
__x86_64__


98 
	m__nu£rs
;

102 
	m__köd
;

103 #ifde‡
__x86_64__


104 
	m__•ös
;

105 
__±hªad_li°_t
 
	m__li°
;

106 
	#__PTHREAD_MUTEX_HAVE_PREV
 1

	)

108 
	m__nu£rs
;

109 
__exãnsi⁄__
 union

111 
	m__•ös
;

112 
__±hªad_¶i°_t
 
	m__li°
;

115 } 
	m__d©a
;

116 
	m__size
[
__SIZEOF_PTHREAD_MUTEX_T
];

117 
	m__Æign
;

118 } 
	t±hªad_muãx_t
;

122 
	m__size
[
__SIZEOF_PTHREAD_MUTEXATTR_T
];

123 
	m__Æign
;

124 } 
	t±hªad_muãx©å_t
;

133 
	m__lock
;

134 
	m__fuãx
;

135 
__exãnsi⁄__
 
	m__tŸÆ_£q
;

136 
__exãnsi⁄__
 
	m__wakeup_£q
;

137 
__exãnsi⁄__
 
	m__wokí_£q
;

138 *
	m__muãx
;

139 
	m__nwaôîs
;

140 
	m__brﬂdˇ°_£q
;

141 } 
	m__d©a
;

142 
	m__size
[
__SIZEOF_PTHREAD_COND_T
];

143 
__exãnsi⁄__
 
	m__Æign
;

144 } 
	t±hªad_c⁄d_t
;

148 
	m__size
[
__SIZEOF_PTHREAD_CONDATTR_T
];

149 
	m__Æign
;

150 } 
	t±hªad_c⁄d©å_t
;

154 
	t±hªad_key_t
;

158 
	t±hªad_⁄˚_t
;

161 #i‡
deföed
 
__USE_UNIX98
 || deföed 
__USE_XOPEN2K


166 #ifde‡
__x86_64__


169 
	m__lock
;

170 
	m__ƒ_ªadîs
;

171 
	m__ªadîs_wakeup
;

172 
	m__wrôî_wakeup
;

173 
	m__ƒ_ªadîs_queued
;

174 
	m__ƒ_wrôîs_queued
;

175 
	m__wrôî
;

176 
	m__sh¨ed
;

177 
	m__∑d1
;

178 
	m__∑d2
;

181 
	m__Êags
;

182 
	#__PTHREAD_RWLOCK_INT_FLAGS_SHARED
 1

	)

183 } 
	m__d©a
;

187 
	m__lock
;

188 
	m__ƒ_ªadîs
;

189 
	m__ªadîs_wakeup
;

190 
	m__wrôî_wakeup
;

191 
	m__ƒ_ªadîs_queued
;

192 
	m__ƒ_wrôîs_queued
;

195 
	m__Êags
;

196 
	m__sh¨ed
;

197 
	m__∑d1
;

198 
	m__∑d2
;

199 
	m__wrôî
;

200 } 
	m__d©a
;

202 
	m__size
[
__SIZEOF_PTHREAD_RWLOCK_T
];

203 
	m__Æign
;

204 } 
	t±hªad_rwlock_t
;

208 
	m__size
[
__SIZEOF_PTHREAD_RWLOCKATTR_T
];

209 
	m__Æign
;

210 } 
	t±hªad_rwlock©å_t
;

214 #ifde‡
__USE_XOPEN2K


216 vﬁ©ûê
	t±hªad_•ölock_t
;

223 
	m__size
[
__SIZEOF_PTHREAD_BARRIER_T
];

224 
	m__Æign
;

225 } 
	t±hªad_b¨rõr_t
;

229 
	m__size
[
__SIZEOF_PTHREAD_BARRIERATTR_T
];

230 
	m__Æign
;

231 } 
	t±hªad_b¨rõøâr_t
;

235 #i‚de‡
__x86_64__


237 
	#__˛ónup_f˘_©åibuã
 
	`__©åibuã__
 ((
	`__ªg∑rm__
 (1)))

	)

	@/usr/include/sys/select.h

21 #i‚de‡
_SYS_SELECT_H


22 
	#_SYS_SELECT_H
 1

	)

24 
	~<„©uªs.h
>

27 
	~<bôs/ty≥s.h
>

30 
	~<bôs/£À˘.h
>

33 
	~<bôs/sig£t.h
>

35 #i‚de‡
__sig£t_t_deföed


36 
	#__sig£t_t_deföed


	)

37 
__sig£t_t
 
	tsig£t_t
;

41 
	#__√ed_time_t


	)

42 
	#__√ed_time•ec


	)

43 
	~<time.h
>

44 
	#__√ed_timevÆ


	)

45 
	~<bôs/time.h
>

47 #i‚de‡
__su£c⁄ds_t_deföed


48 
__su£c⁄ds_t
 
	tsu£c⁄ds_t
;

49 
	#__su£c⁄ds_t_deföed


	)

54 
	t__fd_mask
;

57 #unde‡
__NFDBITS


59 
	#__NFDBITS
 (8 * (Ë (
__fd_mask
))

	)

60 
	#__FD_ELT
(
d
Ë((dË/ 
__NFDBITS
)

	)

61 
	#__FD_MASK
(
d
Ë((
__fd_mask
Ë1 << ((dË% 
__NFDBITS
))

	)

68 #ifde‡
__USE_XOPEN


69 
__fd_mask
 
	mfds_bôs
[
__FD_SETSIZE
 / 
__NFDBITS
];

70 
	#__FDS_BITS
(
£t
Ë((£t)->
fds_bôs
)

	)

72 
__fd_mask
 
	m__fds_bôs
[
__FD_SETSIZE
 / 
__NFDBITS
];

73 
	#__FDS_BITS
(
£t
Ë((£t)->
__fds_bôs
)

	)

75 } 
	tfd_£t
;

78 
	#FD_SETSIZE
 
__FD_SETSIZE


	)

80 #ifde‡
__USE_MISC


82 
__fd_mask
 
	tfd_mask
;

85 
	#NFDBITS
 
__NFDBITS


	)

90 
	#FD_SET
(
fd
, 
fd£ç
Ë
	`__FD_SET
 (fd, fd£ç)

	)

91 
	#FD_CLR
(
fd
, 
fd£ç
Ë
	`__FD_CLR
 (fd, fd£ç)

	)

92 
	#FD_ISSET
(
fd
, 
fd£ç
Ë
	`__FD_ISSET
 (fd, fd£ç)

	)

93 
	#FD_ZERO
(
fd£ç
Ë
	`__FD_ZERO
 (fd£ç)

	)

96 
__BEGIN_DECLS


106 
£À˘
 (
__nfds
, 
fd_£t
 *
__ª°ri˘
 
__ªadfds
,

107 
fd_£t
 *
__ª°ri˘
 
__wrôefds
,

108 
fd_£t
 *
__ª°ri˘
 
__ex˚±fds
,

109 
timevÆ
 *
__ª°ri˘
 
__timeout
);

111 #ifde‡
__USE_XOPEN2K


118 
p£À˘
 (
__nfds
, 
fd_£t
 *
__ª°ri˘
 
__ªadfds
,

119 
fd_£t
 *
__ª°ri˘
 
__wrôefds
,

120 
fd_£t
 *
__ª°ri˘
 
__ex˚±fds
,

121 c⁄° 
time•ec
 *
__ª°ri˘
 
__timeout
,

122 c⁄° 
__sig£t_t
 *
__ª°ri˘
 
__sigmask
);

127 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__GNUC__


128 
	~<bôs/£À˘2.h
>

131 
	g__END_DECLS


	@/usr/include/sys/sysmacros.h

20 #i‚de‡
_SYS_SYSMACROS_H


21 
	#_SYS_SYSMACROS_H
 1

	)

23 
	~<„©uªs.h
>

28 #ifde‡
__GLIBC_HAVE_LONG_LONG


29 
__BEGIN_DECLS


31 
__exãnsi⁄__


32 
	$gnu_dev_maj‹
 (
__dev
)

33 
__THROW
 
__©åibuã_c⁄°__
;

34 
__exãnsi⁄__


35 
	$gnu_dev_mö‹
 (
__dev
)

36 
__THROW
 
__©åibuã_c⁄°__
;

37 
__exãnsi⁄__


38 
	$gnu_dev_makedev
 (
__maj‹
,

39 
__mö‹
)

40 
__THROW
 
__©åibuã_c⁄°__
;

42 #i‡
deföed
 
__GNUC__
 && __GNUC__ >2 && deföed 
__USE_EXTERN_INLINES


43 
__exãnsi⁄__
 
__exã∫_ölöe
 
__©åibuã_c⁄°__
 

44 
	`__NTH
 (
	$gnu_dev_maj‹
 (
__dev
))

46  ((
__dev
 >> 8) & 0xfff) | (() (__dev >> 32) & ~0xfff);

47 
	}
}

49 
__exãnsi⁄__
 
__exã∫_ölöe
 
__©åibuã_c⁄°__
 

50 
__NTH
 (
	$gnu_dev_mö‹
 (
__dev
))

52  (
__dev
 & 0xff) | (() (__dev >> 12) & ~0xff);

53 
	}
}

55 
__exãnsi⁄__
 
__exã∫_ölöe
 
__©åibuã_c⁄°__
 

56 
__NTH
 (
	$gnu_dev_makedev
 (
__maj‹
, 
__mö‹
))

58  ((
__mö‹
 & 0xffË| ((
__maj‹
 & 0xfff) << 8)

59 | (((Ë(
__mö‹
 & ~0xff)) << 12)

60 | (((Ë(
__maj‹
 & ~0xfff)) << 32));

61 
	}
}

63 
	g__END_DECLS


66 
	#maj‹
(
dev
Ë
	`gnu_dev_maj‹
 (dev)

	)

67 
	#mö‹
(
dev
Ë
	`gnu_dev_mö‹
 (dev)

	)

68 
	#makedev
(
maj
, 
mö
Ë
	`gnu_dev_makedev
 (maj, mö)

	)

	@/usr/include/time.h

22 #i‚def 
_TIME_H


24 #i‡(! 
deföed
 
__√ed_time_t
 && !deföed 
__√ed_˛ock_t
 && \

25 ! 
deföed
 
	g__√ed_time•ec
)

26 
	#_TIME_H
 1

	)

27 
	~<„©uªs.h
>

29 
	g__BEGIN_DECLS


33 #ifdef 
_TIME_H


35 
	#__√ed_size_t


	)

36 
	#__√ed_NULL


	)

37 
	~<°ddef.h
>

41 
	~<bôs/time.h
>

44 #i‡!
deföed
 
__STRICT_ANSI__
 && !deföed 
__USE_XOPEN2K


45 #i‚de‡
CLK_TCK


46 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

52 #i‡!
deföed
 
__˛ock_t_deföed
 && (deföed 
_TIME_H
 || deföed 
__√ed_˛ock_t
)

53 
	#__˛ock_t_deföed
 1

	)

55 
	~<bôs/ty≥s.h
>

57 
__BEGIN_NAMESPACE_STD


59 
__˛ock_t
 
	t˛ock_t
;

60 
	g__END_NAMESPACE_STD


61 #i‡
deföed
 
__USE_XOPEN
 || deföed 
__USE_POSIX
 || deföed 
__USE_MISC


62 
	$__USING_NAMESPACE_STD
(
˛ock_t
)

66 #unde‡
__√ed_˛ock_t


68 #i‡!
deföed
 
__time_t_deföed
 && (deföed 
_TIME_H
 || deföed 
__√ed_time_t
)

69 
	#__time_t_deföed
 1

	)

71 
	~<bôs/ty≥s.h
>

73 
__BEGIN_NAMESPACE_STD


75 
__time_t
 
	ttime_t
;

76 
__END_NAMESPACE_STD


77 #i‡
deföed
 
__USE_POSIX
 || deföed 
__USE_MISC
 || deföed 
__USE_SVID


78 
	$__USING_NAMESPACE_STD
(
time_t
)

82 #unde‡
__√ed_time_t


84 #i‡!
deföed
 
__˛ockid_t_deföed
 && \

85 ((
deföed
 
_TIME_H
 && deföed 
__USE_POSIX199309
Ë|| deföed 
__√ed_˛ockid_t
)

86 
	#__˛ockid_t_deföed
 1

	)

88 
	~<bôs/ty≥s.h
>

91 
__˛ockid_t
 
	t˛ockid_t
;

94 #unde‡
__˛ockid_time_t


96 #i‡!
deföed
 
__timî_t_deföed
 && \

97 ((
deföed
 
_TIME_H
 && deföed 
__USE_POSIX199309
Ë|| deföed 
__√ed_timî_t
)

98 
	#__timî_t_deföed
 1

	)

100 
	~<bôs/ty≥s.h
>

103 
__timî_t
 
	ttimî_t
;

106 #unde‡
__√ed_timî_t


109 #i‡(!
deföed
 
__time•ec_deföed
 \

110 && ((
deföed
 
_TIME_H
 \

111 && (
deföed
 
__USE_POSIX199309
 || deföed 
__USE_MISC
 \

112 || 
deföed
 
__USE_ISOC11
)) \

113 || 
deföed
 
__√ed_time•ec
))

114 
	#__time•ec_deföed
 1

	)

116 
	~<bôs/ty≥s.h
>

120 
	stime•ec


122 
__time_t
 
tv_£c
;

123 
__sysˇŒ_¶⁄g_t
 
tv_n£c
;

127 #unde‡
__√ed_time•ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mö
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_m⁄
;

140 
tm_yór
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd°
;

145 #ifdef 
__USE_BSD


146 
tm_gmtoff
;

147 c⁄° *
tm_z⁄e
;

149 
__tm_gmtoff
;

150 c⁄° *
__tm_z⁄e
;

153 
__END_NAMESPACE_STD


154 #i‡
deföed
 
__USE_XOPEN
 || deföed 
__USE_POSIX
 || deföed 
__USE_MISC


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifde‡
__USE_POSIX199309


161 
	sôimî•ec


163 
time•ec
 
ô_öãrvÆ
;

164 
time•ec
 
ô_vÆue
;

168 
sigevít
;

172 #ifde‡
__USE_XOPEN2K


173 #i‚de‡
__pid_t_deföed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_deföed


	)

180 #ifde‡
__USE_ISOC11


182 
	#TIME_UTC
 1

	)

186 
__BEGIN_NAMESPACE_STD


189 
˛ock_t
 
	$˛ock
 (Ë
__THROW
;

192 
time_t
 
	$time
 (
time_t
 *
__timî
Ë
__THROW
;

195 
	$dif·ime
 (
time_t
 
__time1
,Åime_à
__time0
)

196 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

199 
time_t
 
	$mktime
 (
tm
 *
__ç
Ë
__THROW
;

205 
size_t
 
	$°r·ime
 (*
__ª°ri˘
 
__s
, 
size_t
 
__maxsize
,

206 c⁄° *
__ª°ri˘
 
__f‹m©
,

207 c⁄° 
tm
 *
__ª°ri˘
 
__ç
Ë
__THROW
;

208 
__END_NAMESPACE_STD


210 #ifde‡
__USE_XOPEN


213 *
	$°Ωtime
 (c⁄° *
__ª°ri˘
 
__s
,

214 c⁄° *
__ª°ri˘
 
__fmt
, 
tm
 *
__ç
)

215 
__THROW
;

218 #ifde‡
__USE_XOPEN2K8


221 
	~<xloˇÀ.h
>

223 
size_t
 
	$°r·ime_l
 (*
__ª°ri˘
 
__s
, 
size_t
 
__maxsize
,

224 c⁄° *
__ª°ri˘
 
__f‹m©
,

225 c⁄° 
tm
 *
__ª°ri˘
 
__ç
,

226 
__loˇÀ_t
 
__loc
Ë
__THROW
;

229 #ifde‡
__USE_GNU


230 *
	$°Ωtime_l
 (c⁄° *
__ª°ri˘
 
__s
,

231 c⁄° *
__ª°ri˘
 
__fmt
, 
tm
 *
__ç
,

232 
__loˇÀ_t
 
__loc
Ë
__THROW
;

236 
__BEGIN_NAMESPACE_STD


239 
tm
 *
	$gmtime
 (c⁄° 
time_t
 *
__timî
Ë
__THROW
;

243 
tm
 *
	$loˇ…ime
 (c⁄° 
time_t
 *
__timî
Ë
__THROW
;

244 
__END_NAMESPACE_STD


246 #i‡
deföed
 
__USE_POSIX
 || deföed 
__USE_MISC


249 
tm
 *
	$gmtime_r
 (c⁄° 
time_t
 *
__ª°ri˘
 
__timî
,

250 
tm
 *
__ª°ri˘
 
__ç
Ë
__THROW
;

254 
tm
 *
	$loˇ…ime_r
 (c⁄° 
time_t
 *
__ª°ri˘
 
__timî
,

255 
tm
 *
__ª°ri˘
 
__ç
Ë
__THROW
;

258 
__BEGIN_NAMESPACE_STD


261 *
	$as˘ime
 (c⁄° 
tm
 *
__ç
Ë
__THROW
;

264 *
	$˘ime
 (c⁄° 
time_t
 *
__timî
Ë
__THROW
;

265 
__END_NAMESPACE_STD


267 #i‡
deföed
 
__USE_POSIX
 || deföed 
__USE_MISC


272 *
	$as˘ime_r
 (c⁄° 
tm
 *
__ª°ri˘
 
__ç
,

273 *
__ª°ri˘
 
__buf
Ë
__THROW
;

276 *
	$˘ime_r
 (c⁄° 
time_t
 *
__ª°ri˘
 
__timî
,

277 *
__ª°ri˘
 
__buf
Ë
__THROW
;

282 *
__tz«me
[2];

283 
__daylight
;

284 
__timez⁄e
;

287 #ifdef 
__USE_POSIX


289 *
tz«me
[2];

293 
	$tz£t
 (Ë
__THROW
;

296 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_XOPEN


297 
daylight
;

298 
timez⁄e
;

301 #ifde‡
__USE_SVID


304 
	$°ime
 (c⁄° 
time_t
 *
__whí
Ë
__THROW
;

310 
	#__i¶óp
(
yór
) \

311 ((
yór
Ë% 4 =0 && ((yórË% 100 !0 || (yórË% 400 =0))

	)

314 #ifde‡
__USE_MISC


319 
time_t
 
	$timegm
 (
tm
 *
__ç
Ë
__THROW
;

322 
time_t
 
	$timñoˇl
 (
tm
 *
__ç
Ë
__THROW
;

325 
	$dysize
 (
__yór
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

329 #ifde‡
__USE_POSIX199309


334 
	`«no¶ìp
 (c⁄° 
time•ec
 *
__ªque°ed_time
,

335 
time•ec
 *
__ªmaöög
);

339 
	$˛ock_gëªs
 (
˛ockid_t
 
__˛ock_id
, 
time•ec
 *
__ªs
Ë
__THROW
;

342 
	$˛ock_gëtime
 (
˛ockid_t
 
__˛ock_id
, 
time•ec
 *
__ç
Ë
__THROW
;

345 
	$˛ock_£âime
 (
˛ockid_t
 
__˛ock_id
, c⁄° 
time•ec
 *
__ç
)

346 
__THROW
;

348 #ifde‡
__USE_XOPEN2K


353 
	`˛ock_«no¶ìp
 (
˛ockid_t
 
__˛ock_id
, 
__Êags
,

354 c⁄° 
time•ec
 *
__ªq
,

355 
time•ec
 *
__ªm
);

358 
	$˛ock_gë˝u˛ockid
 (
pid_t
 
__pid
, 
˛ockid_t
 *
__˛ock_id
Ë
__THROW
;

363 
	$timî_¸óã
 (
˛ockid_t
 
__˛ock_id
,

364 
sigevít
 *
__ª°ri˘
 
__evp
,

365 
timî_t
 *
__ª°ri˘
 
__timîid
Ë
__THROW
;

368 
	$timî_dñëe
 (
timî_t
 
__timîid
Ë
__THROW
;

371 
	$timî_£âime
 (
timî_t
 
__timîid
, 
__Êags
,

372 c⁄° 
ôimî•ec
 *
__ª°ri˘
 
__vÆue
,

373 
ôimî•ec
 *
__ª°ri˘
 
__ovÆue
Ë
__THROW
;

376 
	$timî_gëtime
 (
timî_t
 
__timîid
, 
ôimî•ec
 *
__vÆue
)

377 
__THROW
;

380 
	$timî_gëovîrun
 (
timî_t
 
__timîid
Ë
__THROW
;

384 #ifde‡
__USE_ISOC11


386 
	$time•ec_gë
 (
time•ec
 *
__ts
, 
__ba£
)

387 
__THROW
 
	`__n⁄nuŒ
 ((1));

391 #ifde‡
__USE_XOPEN_EXTENDED


403 
gëd©e_îr
;

412 
tm
 *
	`gëd©e
 (c⁄° *
__°rög
);

415 #ifde‡
__USE_GNU


426 
	`gëd©e_r
 (c⁄° *
__ª°ri˘
 
__°rög
,

427 
tm
 *
__ª°ri˘
 
__ªsbuÂ
);

430 
__END_DECLS


	@/usr/include/bits/select.h

18 #i‚de‡
_SYS_SELECT_H


22 
	~<bôs/w‹dsize.h
>

25 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

27 #i‡
__WORDSIZE
 == 64

28 
	#__FD_ZERO_STOS
 "°osq"

	)

30 
	#__FD_ZERO_STOS
 "°o¶"

	)

33 
	#__FD_ZERO
(
fd•
) \

35 
__d0
, 
__d1
; \

36 
__asm__
 
	`__vﬁ©ûe__
 ("˛d;Ñï; " 
__FD_ZERO_STOS
 \

37 : "=c" (
__d0
), "=D" (
__d1
) \

38 : "a" (0), "0" ( (
fd_£t
) \

39 /  (
__fd_mask
)), \

40 "1" (&
	`__FDS_BITS
 (
fd•
)[0]) \

42 } 0)

	)

48 
	#__FD_ZERO
(
£t
) \

50 
__i
; \

51 
fd_£t
 *
__¨r
 = (
£t
); \

52 
__i
 = 0; __ò<  (
fd_£t
Ë/  (
__fd_mask
); ++__i) \

53 
	`__FDS_BITS
 (
__¨r
)[
__i
] = 0; \

54 } 0)

	)

58 
	#__FD_SET
(
d
, 
£t
) \

59 ((Ë(
	`__FDS_BITS
 (
£t
)[
	`__FD_ELT
 (
d
)] |
	`__FD_MASK
 (d)))

	)

60 
	#__FD_CLR
(
d
, 
£t
) \

61 ((Ë(
	`__FDS_BITS
 (
£t
)[
	`__FD_ELT
 (
d
)] &~
	`__FD_MASK
 (d)))

	)

62 
	#__FD_ISSET
(
d
, 
£t
) \

63 ((
	`__FDS_BITS
 (
£t
)[
	`__FD_ELT
 (
d
)] & 
	`__FD_MASK
 (d)Ë!0)

	)

	@/usr/include/bits/select2.h

19 #i‚de‡
_SYS_SELECT_H


24 
__fdñt_chk
 (
__d
);

25 
	$__fdñt_w¨n
 (
__d
)

26 
	`__w¨«âr
 ("bit outside of fd_set selected");

27 #unde‡
__FD_ELT


28 
	#__FD_ELT
(
d
) \

29 
__exãnsi⁄__
 \

30 ({ 
__d
 = (
d
); \

31 (
	`__buûtö_c⁄°™t_p
 (
__d
) \

32 ? (0 <
__d
 && __d < 
__FD_SETSIZE
 \

33 ? (
__d
 / 
__NFDBITS
) \

34 : 
	`__fdñt_w¨n
 (
__d
)) \

35 : 
	`__fdñt_chk
 (
__d
)); 
	}
})

	)

	@/usr/include/bits/sigset.h

20 #i‚def 
_SIGSET_H_ty≥s


21 
	#_SIGSET_H_ty≥s
 1

	)

23 
	t__sig_©omic_t
;

27 
	#_SIGSET_NWORDS
 (1024 / (8 *  ()))

	)

30 
	m__vÆ
[
_SIGSET_NWORDS
];

31 } 
	t__sig£t_t
;

42 #i‡!
deföed
 
_SIGSET_H_‚s
 && deföed 
_SIGNAL_H


43 
	#_SIGSET_H_‚s
 1

	)

45 #i‚de‡
_EXTERN_INLINE


46 
	#_EXTERN_INLINE
 
__exã∫_ölöe


	)

50 
	#__sigmask
(
sig
) \

51 (((Ë1Ë<< (((
sig
Ë- 1Ë% (8 *  ())))

	)

54 
	#__sigw‹d
(
sig
Ë(((sigË- 1Ë/ (8 *  ()))

	)

56 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

57 
	#__sigem±y£t
(
£t
) \

58 (
	`__exãnsi⁄__
 ({ 
__˙t
 = 
_SIGSET_NWORDS
; \

59 
sig£t_t
 *
__£t
 = (
£t
); \

60 --
__˙t
 >0Ë
__£t
->
__vÆ
[__cnt] = 0; \

61 0; }))

	)

62 
	#__sigfûl£t
(
£t
) \

63 (
	`__exãnsi⁄__
 ({ 
__˙t
 = 
_SIGSET_NWORDS
; \

64 
sig£t_t
 *
__£t
 = (
£t
); \

65 --
__˙t
 >0Ë
__£t
->
__vÆ
[__cnt] = ~0UL; \

66 0; }))

	)

68 #ifde‡
__USE_GNU


72 
	#__sigi£m±y£t
(
£t
) \

73 (
	`__exãnsi⁄__
 ({ 
__˙t
 = 
_SIGSET_NWORDS
; \

74 c⁄° 
sig£t_t
 *
__£t
 = (
£t
); \

75 
__ªt
 = 
__£t
->
__vÆ
[--
__˙t
]; \

76 !
__ªt
 && --
__˙t
 >= 0) \

77 
__ªt
 = 
__£t
->
__vÆ
[
__˙t
]; \

78 
__ªt
 =0; }))

	)

79 
	#__sig™d£t
(
de°
, 
À·
, 
right
) \

80 (
	`__exãnsi⁄__
 ({ 
__˙t
 = 
_SIGSET_NWORDS
; \

81 
sig£t_t
 *
__de°
 = (
de°
); \

82 c⁄° 
sig£t_t
 *
__À·
 = (
À·
); \

83 c⁄° 
sig£t_t
 *
__right
 = (
right
); \

84 --
__˙t
 >= 0) \

85 
__de°
->
__vÆ
[
__˙t
] = (
__À·
->__val[__cnt] \

86 & 
__right
->
__vÆ
[
__˙t
]); \

87 0; }))

	)

88 
	#__sig‹£t
(
de°
, 
À·
, 
right
) \

89 (
	`__exãnsi⁄__
 ({ 
__˙t
 = 
_SIGSET_NWORDS
; \

90 
sig£t_t
 *
__de°
 = (
de°
); \

91 c⁄° 
sig£t_t
 *
__À·
 = (
À·
); \

92 c⁄° 
sig£t_t
 *
__right
 = (
right
); \

93 --
__˙t
 >= 0) \

94 
__de°
->
__vÆ
[
__˙t
] = (
__À·
->__val[__cnt] \

95 | 
__right
->
__vÆ
[
__˙t
]); \

96 0; }))

	)

103 
__sigismembî
 (c⁄° 
__sig£t_t
 *, );

104 
__sigadd£t
 (
__sig£t_t
 *, );

105 
__sigdñ£t
 (
__sig£t_t
 *, );

107 #ifde‡
__USE_EXTERN_INLINES


108 
	#__SIGSETFN
(
NAME
, 
BODY
, 
CONST
) \

109 
_EXTERN_INLINE
 \

110 
	`NAME
 (
CONST
 
__sig£t_t
 *
__£t
, 
__sig
) \

112 
__mask
 = 
	`__sigmask
 (
__sig
); \

113 
__w‹d
 = 
	`__sigw‹d
 (
__sig
); \

114  
BODY
; \

115 }

	)

117 
__SIGSETFN
 (
__sigismembî
, (
__£t
->
__vÆ
[
__w‹d
] & 
__mask
) ? 1 : 0, const)

118 
__SIGSETFN
 (
__sigadd£t
, ((
__£t
->
__vÆ
[
__w‹d
] |
__mask
), 0), )

119 
__SIGSETFN
 (
__sigdñ£t
, ((
__£t
->
__vÆ
[
__w‹d
] &~
__mask
), 0), )

121 #unde‡
__SIGSETFN


	@/usr/include/bits/time.h

23 #i‡
deföed
 
__√ed_timevÆ
 || deföed 
__USE_GNU


24 #i‚de‡
_STRUCT_TIMEVAL


25 
	#_STRUCT_TIMEVAL
 1

	)

26 
	~<bôs/ty≥s.h
>

30 
	stimevÆ


32 
__time_t
 
	mtv_£c
;

33 
__su£c⁄ds_t
 
	mtv_u£c
;

38 #i‚de‡
__√ed_timevÆ


39 #i‚de‡
_BITS_TIME_H


40 
	#_BITS_TIME_H
 1

	)

48 
	#CLOCKS_PER_SEC
 1000000l

	)

50 #i‡(!
deföed
 
__STRICT_ANSI__
 || deföed 
__USE_POSIX
) \

51 && !
deföed
 
	g__USE_XOPEN2K


54 
	~<bôs/ty≥s.h
>

55 
__sysc⁄f
 ();

56 
	#CLK_TCK
 ((
__˛ock_t
Ë
	`__sysc⁄f
 (2)Ë

	)

59 #ifde‡
__USE_POSIX199309


61 
	#CLOCK_REALTIME
 0

	)

63 
	#CLOCK_MONOTONIC
 1

	)

65 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

67 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

69 
	#CLOCK_MONOTONIC_RAW
 4

	)

71 
	#CLOCK_REALTIME_COARSE
 5

	)

73 
	#CLOCK_MONOTONIC_COARSE
 6

	)

75 
	#CLOCK_BOOTTIME
 7

	)

77 
	#CLOCK_REALTIME_ALARM
 8

	)

79 
	#CLOCK_BOOTTIME_ALARM
 9

	)

82 
	#TIMER_ABSTIME
 1

	)

85 #ifde‡
__USE_GNU


86 
	~<bôs/timex.h
>

88 
__BEGIN_DECLS


91 
	$˛ock_adjtime
 (
__˛ockid_t
 
__˛ock_id
, 
timex
 *
__utx
Ë
__THROW
;

93 
__END_DECLS


99 #unde‡
__√ed_timevÆ


	@/usr/include/bits/timex.h

18 #i‚def 
_BITS_TIMEX_H


19 
	#_BITS_TIMEX_H
 1

	)

21 
	~<bôs/ty≥s.h
>

25 
	stimex


27 
	mmodes
;

28 
__sysˇŒ_¶⁄g_t
 
	moff£t
;

29 
__sysˇŒ_¶⁄g_t
 
	m‰eq
;

30 
__sysˇŒ_¶⁄g_t
 
	mmaxîr‹
;

31 
__sysˇŒ_¶⁄g_t
 
	me°îr‹
;

32 
	m°©us
;

33 
__sysˇŒ_¶⁄g_t
 
	mc⁄°™t
;

34 
__sysˇŒ_¶⁄g_t
 
	m¥ecisi⁄
;

35 
__sysˇŒ_¶⁄g_t
 
	mtﬁî™˚
;

36 
timevÆ
 
	mtime
;

37 
__sysˇŒ_¶⁄g_t
 
	mtick
;

38 
__sysˇŒ_¶⁄g_t
 
	mµs‰eq
;

39 
__sysˇŒ_¶⁄g_t
 
	mjôãr
;

40 
	mshi·
;

41 
__sysˇŒ_¶⁄g_t
 
	m°abû
;

42 
__sysˇŒ_¶⁄g_t
 
	mjô˙t
;

43 
__sysˇŒ_¶⁄g_t
 
	mˇl˙t
;

44 
__sysˇŒ_¶⁄g_t
 
	mîr˙t
;

45 
__sysˇŒ_¶⁄g_t
 
	m°b˙t
;

47 
	mèi
;

56 
	#ADJ_OFFSET
 0x0001

	)

57 
	#ADJ_FREQUENCY
 0x0002

	)

58 
	#ADJ_MAXERROR
 0x0004

	)

59 
	#ADJ_ESTERROR
 0x0008

	)

60 
	#ADJ_STATUS
 0x0010

	)

61 
	#ADJ_TIMECONST
 0x0020

	)

62 
	#ADJ_TAI
 0x0080

	)

63 
	#ADJ_MICRO
 0x1000

	)

64 
	#ADJ_NANO
 0x2000

	)

65 
	#ADJ_TICK
 0x4000

	)

66 
	#ADJ_OFFSET_SINGLESHOT
 0x8001

	)

67 
	#ADJ_OFFSET_SS_READ
 0xa001

	)

70 
	#MOD_OFFSET
 
ADJ_OFFSET


	)

71 
	#MOD_FREQUENCY
 
ADJ_FREQUENCY


	)

72 
	#MOD_MAXERROR
 
ADJ_MAXERROR


	)

73 
	#MOD_ESTERROR
 
ADJ_ESTERROR


	)

74 
	#MOD_STATUS
 
ADJ_STATUS


	)

75 
	#MOD_TIMECONST
 
ADJ_TIMECONST


	)

76 
	#MOD_CLKB
 
ADJ_TICK


	)

77 
	#MOD_CLKA
 
ADJ_OFFSET_SINGLESHOT


	)

78 
	#MOD_TAI
 
ADJ_TAI


	)

79 
	#MOD_MICRO
 
ADJ_MICRO


	)

80 
	#MOD_NANO
 
ADJ_NANO


	)

84 
	#STA_PLL
 0x0001

	)

85 
	#STA_PPSFREQ
 0x0002

	)

86 
	#STA_PPSTIME
 0x0004

	)

87 
	#STA_FLL
 0x0008

	)

89 
	#STA_INS
 0x0010

	)

90 
	#STA_DEL
 0x0020

	)

91 
	#STA_UNSYNC
 0x0040

	)

92 
	#STA_FREQHOLD
 0x0080

	)

94 
	#STA_PPSSIGNAL
 0x0100

	)

95 
	#STA_PPSJITTER
 0x0200

	)

96 
	#STA_PPSWANDER
 0x0400

	)

97 
	#STA_PPSERROR
 0x0800

	)

99 
	#STA_CLOCKERR
 0x1000

	)

100 
	#STA_NANO
 0x2000

	)

101 
	#STA_MODE
 0x4000

	)

102 
	#STA_CLK
 0x8000

	)

105 
	#STA_RONLY
 (
STA_PPSSIGNAL
 | 
STA_PPSJITTER
 | 
STA_PPSWANDER
 | \

106 
STA_PPSERROR
 | 
STA_CLOCKERR
 | 
STA_NANO
 | 
STA_MODE
 | 
STA_CLK
)

	)

	@
1
.
1
/usr/include
68
1679
alloc.c
alloc.h
daemon.c
daemon.h
dm-src.mod.c
header.h
lru.c
lru.h
metadata.c
metadata.h
raid.h
target.c
target.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/string.h
/usr/include/linux/types.h
/usr/include/linux/version.h
/usr/include/asm/types.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/posix_types.h
/usr/include/string.h
/usr/include/asm-generic/types.h
/usr/include/asm/ioctl.h
/usr/include/asm/posix_types.h
/usr/include/bits/string.h
/usr/include/bits/string2.h
/usr/include/bits/string3.h
/usr/include/features.h
/usr/include/linux/stddef.h
/usr/include/xlocale.h
/usr/include/asm-generic/int-ll64.h
/usr/include/asm-generic/ioctl.h
/usr/include/asm/posix_types_32.h
/usr/include/asm/posix_types_64.h
/usr/include/asm/posix_types_x32.h
/usr/include/bits/types.h
/usr/include/endian.h
/usr/include/gnu/stubs.h
/usr/include/stdc-predef.h
/usr/include/stdlib.h
/usr/include/sys/cdefs.h
/usr/include/alloca.h
/usr/include/asm-generic/posix_types.h
/usr/include/asm/bitsperlong.h
/usr/include/bits/byteswap.h
/usr/include/bits/endian.h
/usr/include/bits/stdlib-float.h
/usr/include/bits/stdlib-ldbl.h
/usr/include/bits/stdlib.h
/usr/include/bits/typesizes.h
/usr/include/bits/waitflags.h
/usr/include/bits/waitstatus.h
/usr/include/bits/wordsize.h
/usr/include/gnu/stubs-64.h
/usr/include/sys/types.h
/usr/include/asm-generic/bitsperlong.h
/usr/include/bits/byteswap-16.h
/usr/include/bits/pthreadtypes.h
/usr/include/sys/select.h
/usr/include/sys/sysmacros.h
/usr/include/time.h
/usr/include/bits/select.h
/usr/include/bits/select2.h
/usr/include/bits/sigset.h
/usr/include/bits/time.h
/usr/include/bits/timex.h
